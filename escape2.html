<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë¨é„ÅÆÊ¥ãÈ§®„Åã„Çâ„ÅÆËÑ±Âá∫„Ç≤„Éº„É†</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;  /* ‚Üê„Åì„ÇåÈáçË¶Å */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .room-view {
            aspect-ratio: 1/1;           /* ‚ÜêÊ≠£ÊñπÂΩ¢ */
            width: 90vw;                 /* ÁîªÈù¢ÂπÖ„ÅÆ90% */
            max-width: 640px;            /* PCÊôÇÊúÄÂ§ß„Çµ„Ç§„Ç∫ */
            max-height: 90vw;       
            background-size: cover;      
            background-repeat: no-repeat;
            background-position: center center;
            position: relative;
            margin: 0 auto;
            cursor: crosshair;
            transition: background-image 0.5s ease-in-out;
        }

        #roomImage {
            width: 100%;
            height: 100%;
            object-fit: contain;    /* ÁîªÂÉèÂÖ®‰Ωì„ÇíË°®Á§∫ */
            position: absolute;
            left: 0;
            top: 0;
            z-index: 0;
            pointer-events: none;   /* ÁîªÂÉè‰∏ä„Åß„ÇÇ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÅåÈÄö„Çã„Çà„ÅÜ„Å´ */
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
            }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }



        .clickable-area {
            position: absolute;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            z-index: 2;
            pointer-events: auto;

        }

        .clickable-area:hover {
            border-color: #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 20px;
            width:100%;
        }

        .inventory-slot {
            width: 14vw; 
            height: 14vw; 
            max-width: 80px; 
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;   /* ÈáëËâ≤„ÉªÂ§™„ÇÅÊé®Â•® */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .info-panel {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            height:80px;
            min-height: 40px;
            border: 1px solid #d4af37;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        /* ÁîªÂÉè„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }
        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            width: 40%;
        }

        @media (max-width: 600px) {
            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }
            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width:100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }
        #roomEffectOverlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }
        .title-wrapper {
            display: flex;
            width:100%;
        }
    </style>
</head>
<body>
    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <div class="title">Ë¨é„ÅÆÊ¥ãÈ§®„Åã„ÇâËÑ±Âá∫„Åõ„Çà</div>
            <div style="margin:12px 0; text-align:center;">
                <a href="escape2_hint.html" target="_blank" style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    üîç „Éí„É≥„Éà„ÇíË¶ã„Çã
                </a>
            </div>
        </div>
        <div class="room-view" id="roomView">
            <!-- „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Ç®„É™„Ç¢„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
              <img id="roomImage" src="">
              
        </div> 
        <div id="endingShareArea" style="display:none;">
            <div style="font-size:1.4em; font-weight:bold; margin-bottom:8px;color:#2c1810;">üéâ„ÇØ„É™„Ç¢„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅüéâ</div>
            <button onclick="shareOnTwitter()">X„Åß„Ç∑„Çß„Ç¢</button>
            <button onclick="copyShareText()">„ÇØ„É™„Ç¢Â†±Âëä„Çí„Ç≥„Éî„Éº</button>
            <div style="font-size:0.9em; margin-top:6px; color:#555;">#ËÑ±Âá∫„Ç≤„Éº„É† #Ëá™‰Ωú„Ç≤„Éº„É†</div>
        </div>
        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÂè§„ÅÑÊ¥ãÈ§®„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇÁéÑÈñ¢„Éâ„Ç¢„ÅØ„Ç´„ÇÆ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Å¶Âá∫„Çâ„Çå„Åæ„Åõ„Çì
                </div>
                <div class="navigation">
                    
                </div> 
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
            üîä BGM
            </button> 
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">„Çª„Éº„Éñ</button>
                <button class="nav-btn" onclick="loadGame()">„É≠„Éº„Éâ</button>
            </div>
        </div>
        <div class="notice">ÂΩì„Çµ„Ç§„Éà„ÅØOtoLogic„ÅÆÁ¥†Êùê„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô ‰ΩúËÄÖ:<a href="index.html">„Çπ„É©„Çª„Éñ„É≥</a></div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>
    <audio id="bgm" src="sounds/sinpi no kyuuden.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-tv" src="sounds/TV-Hardware02-01(Button).mp3"></audio>
    <audio id="se-skeleton" src="sounds/Motion-Tremble02-1(Short).mp3"></audio>
    <audio id="se-metal" src="sounds/Horror_Accent13-1(Short).mp3"></audio>
    <audio id="se-subclear" src="sounds/Quiz-Ding_Dong01-1(Short).mp3"></audio>
    <audio id="se-clear" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-parin" src="sounds/Onoma-Impact04-1(High).mp3"></audio>
    <audio id="se-box" src="sounds/Retro_Anime-Switch02-1(Mid).mp3"></audio>
    <audio id="se-person" src="sounds/Short_Accent04-1(Single).mp3"></audio>
    <script>
        window._nextModal = null;
        // „Ç≤„Éº„É†Ë®≠ÂÆö - ÁîªÂÉè„Éë„Çπ„Çí„Åì„Åì„ÅßÁÆ°ÁêÜ
        let IMAGES = {
            rooms: {
                genkan: 'images/genkan.jpg',        
                corridor: 'images/corridor.jpg',       
                dining: 'images/dining.jpg',      
                living: 'images/living.jpg',
                end: 'images/end.jpg',
                dreamEnd: 'images/dreamEnd.jpg',
                trueEnd: 'images/trueEnd.jpg',
                extraEnd: 'images/extraEnd.jpg'     
            },
            items: {
                drawerKey: 'images/drawerKey.jpg',
                coin: 'images/coin.jpg',
                pin: 'images/pin.jpg',
                oil: 'images/oil.jpg',
                jam: 'images/jam.jpg',
                picture: 'images/picture.jpg',
            }
        };

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            currentRoom: 'genkan',
            openRooms: ['genkan'], 
            inventory: [],
            genkan: {
                flags: {
                    talkTo: {
                        skeleton:0
                    },
                    watchedPaper: false,
                    foundPin: false,
                    chairSitCount: 0
                }
            },
            corridor: {
                flags: {
                    foundDrawerKey: false,
                    foundPicture: false,
                    talkTo: {
                        skeleton:0,
                        pic_left:0,
                        pic_center:0,
                        pic_right:0
                    },
                    talkToLeft:false,
                    talkToCenter:false,
                    talkToRight: false,
                }
            },
            dining: {
                flags: {
                    foundOil: false,
                    foundJam: false,
                    useOilToSkeleton: false,
                }
            },
            living: {
                flags: {
                    readMemo: false,
                }
            },
            flags: {
                skeletonFavor :0,
                foundKey: false,
                foundMirror: false,
                genkanPuzzleSolved: false,
                corridorPuzzleSolved: false,
                diningPuzzleSolved: false,
                readScroll: false,
                solvedPuzzle: false,
                foundTreasure: false,
                foundSmallKey: false,
                foundFutonbo: false,
                foundBear: false,
                happyBear: false,
                foundBook:false,
                
            },
            selectedItem: null
        };

        // ÈÉ®Â±ã„Éá„Éº„Çø
        let rooms = {
            genkan: {
                name: 'ÁéÑÈñ¢',
                description: 'Ë±™ËèØ„Å™Ê¥ãÈ§®„ÅÆÁéÑÈñ¢„Éõ„Éº„É´„Å†',
                clickableAreas: [
                    {
                        x: 68, y: 37, width: 6, height: 9,
                        action: 'examine_genkan_paper',
                        description: '„Éâ„Ç¢„Å´„ÅØÂºµ„ÇäÁ¥ô',
                        zIndex:5
                    },
                    {
                        x: 77, y: 54, width: 3, height: 6,
                        action: 'examine_genkan_key',
                        description: 'Èçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã',
                        zIndex:5
                    },
                    {
                        x: 58, y: 28, width: 23, height: 45,
                        action: 'examine_genkan_door',
                        description: 'ÁéÑÈñ¢„Éâ„Ç¢'
                    },
                    {
                        x: 31, y: 54, width: 16, height: 19,
                        action: 'examine_genkan_chair',
                        description: 'Ë±™ËèØ„Å™Ê§ÖÂ≠ê'
                    },
                    {
                        x: 12, y: 26, width: 12, height: 48,
                        action: 'examine_genkan_left_door',
                        description: 'Á´ãÊ¥æ„Å™Êú®Ë£Ω„ÅÆ„Éâ„Ç¢'
                    },
                    {
                        x: 39, y: 33, width: 10, height: 13,
                        action: 'examine_genkan_picture',
                        description: 'Â•≥ÊÄß„ÅÆËÇñÂÉèÁîª'
                    },
                    {
                        x: 90, y: 43, width: 8, height: 8,
                        action: 'examine_genkan_spidernet',
                        description: '„ÇØ„É¢„ÅÆÂ∑£'
                    },
                    {
                        x: 90, y: 88, width: 9, height: 4,
                        action: 'examine_genkan_memo',
                        description: '„É°„É¢'
                    },
                    {
                        x: 96.7, y: 74, width: 2.7, height: 2.6,
                        action: 'examine_genkan_pin',
                        description: '?'
                    },
                    {
                        x: 83, y: 54, width: 12, height: 22,
                        action: 'examine_genkan_skeleton',
                        description: 'È™∏È™®'
                    }
                ]
            },
            living: {
                name: 'Â±ÖÈñì',
                description: 'ËçíÂªÉ„Åó„Åü„É™„Éì„É≥„Ç∞„Å†„ÄÇÂ£Å„Å´ÂÜôÁúü„Åå„Åü„Åè„Åï„ÇìÈ£æ„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇ„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ä„Å´Èçµ„Åå„Åã„Åã„Å£„ÅüÂ∞èÁÆ±„Åå„ÅÇ„Çã',
                clickableAreas: [
                    {
                        x: 9, y: 25, width: 5, height: 8,
                        action: 'examine_living_pic1',
                        description: 'Âè§„ÅÑÂÜôÁúü'
                    },
                    {
                        x: 17, y: 31, width: 4, height: 10.6,
                        action: 'examine_living_pic2',
                        description: 'Âè§„ÅÑÂÜôÁúü'
                    },
                    {
                        x: 3.7, y: 40.8, width: 4.7, height: 8,
                        action: 'examine_living_pic3',
                        description: 'Âè§„ÅÑÂÜôÁúü'
                    },
                    {
                        x: 10.5, y: 43.5, width: 4.7, height: 5,
                        action: 'examine_living_pic4',
                        description: 'Âè§„ÅÑÂÜôÁúü'
                    },
                    {
                        x: 15.5, y: 49.4, width: 5.2, height: 4.2,
                        action: 'examine_living_pic5',
                        description: 'Âè§„ÅÑÂÜôÁúü'
                    },
                    {
                        x: 37, y: 69, width: 7.5, height: 5.4,
                        action: 'examine_living_box',
                        description: 'Èçµ„Åå„Åã„Åã„Å£„ÅüÂ∞èÁÆ±'
                    },
                    {
                        x: 26.3, y: 40.7, width: 17.2, height: 5.3,
                        action: 'examine_living_books1',
                        description: 'Êú¨Ê£ö'
                    },
                    {
                        x: 26.4, y: 49, width: 16.6, height: 5.3,
                        action: 'examine_living_books2',
                        description: 'Êú¨Ê£ö'
                    },
                    {
                        x: 45.4, y: 72, width: 8, height: 2.4,
                        action: 'examine_living_books3',
                        description: '„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ä„ÅÆÊú¨'
                    },
                    {
                        x: 81.4, y: 43.5, width: 13.2, height: 39,
                        action: 'examine_living_skeleton',
                        description: 'È™∏È™®'
                    },
                    {
                        x: 3.6, y: 56.6, width: 21.7, height: 23.3,
                        action: 'examine_living_sofa',
                        description: '„ÇΩ„Éï„Ç°'
                    },
                    {
                        x: 29, y: 75, width: 26, height: 12,
                        action: 'examine_living_table',
                        description: '„ÉÜ„Éº„Éñ„É´'
                    },
                    {
                        x: 90.2, y: 61.4, width: 1.7, height: 1.4,
                        action: 'examine_living_lapel',
                        description: 'Ôºü',
                        zIndex:5
                    }
                ]
            },
            corridor: {
                name: 'Âªä‰∏ã',
                description: 'Ë±™ËèØ„Å†„ÅåËçíÂªÉ„Åó„ÅüÂªä‰∏ã„Å†„ÄÇËÇñÂÉèÁîª„Åå„ÅÑ„Åè„Å§„Åã„Åã„Åã„Å£„Å¶„ÅÑ„Çã',
                clickableAreas: [
                    {
                        x: 43, y: 37, width: 18, height: 40,
                        action: 'examine_corridor_door',
                        description: 'Â••„ÅÆ„Éâ„Ç¢'
                    },
                    {
                        x: 73, y: 38, width: 12, height: 34,
                        action: 'examine_corridor_skeleton',
                        description: 'È™∏È™®'
                    },
                    {
                        x: 91, y: 10, width: 8, height: 36,
                        action: 'examine_corridor_picture_right',
                        description: 'Â•≥ÊÄß„ÅÆËÇñÂÉèÁîª'
                    },
                    {
                        x: 28, y: 41.5, width: 9, height: 14,
                        action: 'examine_corridor_picture_center',
                        description: 'Ëã•„ÅÑÁî∑ÊÄß„ÅÆËÇñÂÉèÁîª'
                    },
                    {
                        x: 4.3, y: 14.6, width: 6.4, height: 33.6,
                        action: 'examine_corridor_picture_left',
                        description: '‰∏≠Âπ¥Â•≥ÊÄß„ÅÆËÇñÂÉèÁîª'
                    },
                    {
                        x: 45, y: 10, width: 17, height: 13,
                        action: 'examine_corridor_light',
                        description: '„Ç∑„É£„É≥„Éá„É™„Ç¢'
                    },
                    {
                        x: 2, y: 52, width: 17, height: 36,
                        action: 'examine_corridor_chair',
                        description: 'Âè§„Å≥„ÅüË±™ËèØ„Å™Ê§ÖÂ≠ê'
                    },
                    {
                        x: 18.6, y: 62, width: 4.6, height: 3,
                        action: 'examine_corridor_drawer1',
                        description: 'Âºï„ÅçÂá∫„Åó',
                        zIndex:5
                    },
                    {
                        x: 18.2, y: 69, width: 5, height: 3,
                        action: 'examine_corridor_drawer2',
                        description: 'Âºï„ÅçÂá∫„Åó',
                        zIndex:5
                    }
                ]
            },
            dining: {
                name: 'È£üÂ†Ç',
                description: '„ÉÄ„Ç§„Éã„É≥„Ç∞„Çª„ÉÉ„Éà„ÅåÁΩÆ„ÅÑ„Å¶„ÅÇ„Çã„ÄÇ„ÇØ„É¢„ÅÆÂ∑£„ÅåÁõÆÁ´ã„Å§‚Ä¶',
                clickableAreas: [
                    {
                        x: 10, y: 27, width: 14.5, height: 42,
                        action: 'examine_dining_skeleton',
                        description: 'È™∏È™®'
                    },
                    {
                        x: 52.5, y: 42, width: 8.5, height: 7,
                        action: 'examine_kannuki',
                        description: '„Åï„Å≥‰ªò„ÅÑ„Åü„Åã„Çì„Å¨„Åç',
                        zIndex:5
                    },
                    {
                        x: 85.4, y: 20, width: 11, height: 10,
                        action: 'examine_dining_right_dish1',
                        description: 'È£æ„ÇäÁöø'
                    },
                    {
                        x: 87, y: 36, width: 8.7, height: 7,
                        action: 'examine_dining_right_dish2',
                        description: 'È£æ„ÇäÁöø'
                    },
                    {
                        x: 47, y: 57, width: 9, height: 3,
                        action: 'examine_dining_center_dish',
                        description: '„ÅäÁöø'
                    },
                    {
                        x: 60, y: 70, width: 13, height: 8,
                        action: 'examine_dining_under_table',
                        description: '„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ã'
                    },
                    {
                        x: 56, y: 51, width: 4, height: 9,
                        action: 'examine_pot',
                        description: '„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ä„ÅÆ„Éù„ÉÉ„Éà'
                    }
                ]
            },
            end: {
                name: 'Â§ñ„ÅÆ‰∏ñÁïå„Å∏„É´„Éº„Éà',
                description: '„ÅÇ„Å™„Åü„ÅØÁÑ°‰∫ãËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ„ÄêÂá∫„ÄëÂè£„Åã„Çâ„ÅÆËÑ±Âá∫',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_end',
                        description: 'Â§ñ„ÅÆ‰∏ñÁïå'
                    },
                ]
            },
            dreamEnd: {
                name: 'Â§¢„ÅÆ‰∏ñÁïå„Å∏„É´„Éº„Éà',
                description: '„ÅÇ„Å™„Åü„ÅØÈ™∏È™®Âü∑‰∫ã„Å®„Å®„ÇÇ„Å´„ÄÅÂ§¢„ÅÆ‰∏ñÁïå„Å∏ÊóÖÁ´ã„Å£„Åü„ÄÇ„Äê„ÅÑ„Äë„Å£„Åó„Çá„Å´Â§©ÂõΩ„Å∏',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_dream_end',
                        description: 'Â§¢„ÅÆ‰∏ñÁïå'
                    },
                ]
            },
            trueEnd: {
                name: 'Ëß£Êîæ„É´„Éº„Éà',
                description: '„ÅÇ„Å™„Åü„ÅØÈ™∏È™®Âü∑‰∫ã„Å®„Åù„ÅÆÂÆ∂Êóè„ÇíËß£Êîæ„Åó„Åü„ÄÇ„Åô„Åπ„Å¶„ÅÆ„Äê„Åä„Äë„ÇÇ„ÅÑ„ÅåÊòáËèØ„Åô„Çã',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_true_end',
                        description: 'Ëß£Êîæ'
                    },
                ]
            },
            extraEnd: {
                name: 'EXTRA„É´„Éº„Éà',
                description: '„ÅÇ„Å™„Åü„ÅØ„Åì„ÅÆ„Ç≤„Éº„É†„Çí„ÇÑ„Çä„Åì„Åø„Åæ„Åó„Åü',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_extra_end',
                        description: '„ÇÑ„Çä„Åì„ÅøÂã¢„Å´ÊãçÊâãÔºÅ'
                    },
                ]
            }
        };

        const hintMessages = {
            genkan: {
                skeleton: [
                "‚Ä¶‚Ä¶„Åì„Åì„Å´Êù•„ÇãËÄÖ„Åå„ÅÑ„Çã„Å®„ÅØ„ÄÅ‰πÖ„Åó„Å∂„Çä„Åß„Åô„ÄÇ",
                "ÁßÅ„ÇÇ„Åì„ÅÆÂ±ãÊï∑„Å´„ÄÅÈï∑„ÅÑ„Åì„Å®‚ÄúÁ∏õ„Çâ„Çå„Å¶‚Äù„Åä„Çä„Åæ„Åó„Å¶„ÄÇ",
                "„ÇÇ„Åó„ÅäÂõ∞„Çä„Åß„Åó„Åü„Çâ„ÄÅÂºµ„ÇäÁ¥ô„Çí„ÅîË¶ß„Åè„Å†„Åï„ÅÑ„ÄÇ„ÇÇ„Å£„Å®„ÅäÊâã‰ºù„ÅÑ„Åó„Åü„ÅÑ„ÅÆ„Åß„Åô„Åå‚Ä¶‚Ä¶„Åì„Çå‰ª•‰∏ä„ÅØ„ÄÅÈ™®Ë∫´„Å´„Åì„Åü„Åà„Åæ„Åô„ÅÆ„Åß„ÄÇ"
                ],
                spidernet: [
                    "„ÇØ„É¢„ÅÆÂ∑£„ÅåÂºµ„Å£„Å¶„ÅÑ„Çã‚Ä¶",
                    "Â∞è„Åï„Å™ÁæΩËô´„ÅåÂºï„Å£„Åã„Åã„Å£„Å¶„ÅÑ„Çã",
                    "„ÇØ„É¢„ÅÆÂßø„ÅØ„Å™„ÅÑ",
                    "„Åù„Çì„Å™„Å´„ÇØ„É¢„ÅÆÂ∑£„ÅåÊ∞ó„Å´„Å™„Çä„Åæ„Åô„ÅãÔºü",
                ]
            },
            corridor: {
                skeleton: [
                "‰ª£„ÄÖ„ÅÆ„ÅîÂÆ∂Êóè„ÅÆËÇñÂÉèÁîª„Åß„Åô„Åû",
                "„ÅäÂõ∞„Çä„Å™„ÇâË™ø„Åπ„Å¶„Åø„Çã„ÅÆ„ÇÇËâØ„ÅÑ„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„Å™",
                "„ÅàÔºüÂ§ß„Åç„Åè„Å™„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åã„Åß„Åô„Å®ÔºüÊ∞ó„ÅÆ„Åõ„ÅÑ„Åß„Åî„Åñ„ÅÑ„Åæ„Åó„Çá„ÅÜ"
                ],
                pic_center: [
                    "„ÇÑ„ÅÇ„ÄÅÂÉï„ÅØ„Éç„É´„ÇΩ„É≥„ÄÇ„Åì„ÅÆÂÆ∂„ÅÆ‰∏â‰ª£ÁõÆ„Åï„ÄÇ",
                    "Â≠ê„Å©„ÇÇ„ÅÆÈ†É„ÅØ„ÄÅ„Éâ„É≠„Ç∑„Éº„Åä„Å∞„Åï„Çì„Å´„Çà„ÅèÈÅä„Çì„Åß„ÇÇ„Çâ„Å£„Åü„Å™„ÅÇ„ÄÇ",
                    "„Ç≠„É£„É≠„ÉÉ„Éà„Ç±„Éº„Ç≠„ÄÅÁæéÂë≥„Åó„Åã„Å£„Åü„Å™„ÅÇ„ÄÇ„ÅÑ„Å§„ÇÇÊÆã„Åï„Åö„Éö„É≠„É™„Å†„Å£„Åü„ÄÇ",
                    "ÊÄù„ÅÑÂá∫„Å†„Åë„Åå„ÄÅ‰ªä„ÇÇ„Åì„ÅÆÂÆ∂„Å´ÊÆã„Å£„Å¶„ÇãÊ∞ó„Åå„Åô„Çã„Çà„ÄÇ"
                ],
                pic_left: [
                    "„Åæ„ÅÇ„ÄÅ„Åî„Åç„Åí„Çì„Çà„ÅÜ„ÄÇ„Çè„Åü„Åè„Åó„ÅØ„Ç¢„É°„É™„Ç¢„Çà„ÄÇ",
                    "ÊúÄËøë„ÅØ„ÄÅ„ÅäÂ±ãÊï∑„ÇÇÂØÇ„Çå„Å¶„Åç„Å¶„Åó„Åæ„Å£„Åü„Çè„Å≠„ÄÇ",
                    "ÁßÅ„ÅÆÂ§ßÂ•Ω„Åç„Å™„Éê„É©Âúí„ÇÇ„ÄÅÊâãÂÖ•„Çå„Çí„Åô„ÇãÂ∫≠Â∏´„ÅåÈõá„Åà„Å™„ÅÑ„Çè‚Ä¶",
                ],
                pic_right: [
                    "„Éè„Ç§„ÄÅÁßÅ„ÅØ„Éâ„É≠„Ç∑„Éº„Çà„ÄÇ",
                    "ÁßÅ„ÅÆÊôÇ‰ª£„ÅØ„ÄÅËàûË∏è‰ºö„ÇÇÈñã„Åã„Çå„Å¶„ÅÑ„Åü„ÅÆ„Çà„ÄÇ",
                    "„Åù„ÅÜ„ÅÑ„Åà„Å∞Ë´ãÊ±ÇÊõ∏„ÅåÂºï„ÅçÂá∫„Åó„Å´ÊÆã„Å£„Å¶„ÅÑ„Çã„Åã„ÇÇ„ÄÇ",
                ]
            },
            dining: {
                skeleton: [
                "‰ΩôË®à„Å™„Åä‰∏ñË©±„Åß„Åô„Åå„ÄÅ„Åì„Åì„Åß„Çª„Éº„Éñ„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„Åû",
                "„ÅäÁöø„Çí„Çà„ÅèË¶ã„Çã„ÅÆ„Åå„ÄÅ„Åì„ÅÆÂÆ∂„ÅÆ„É´„Éº„É´„Åß„Åô„ÄÇ",
                "„Ç∏„É£„É†Ê¥æ„Åã„Ç™„Ç§„É´Ê¥æ„Åã„ÄÅ„Åì„Åì„ÅØÂàÜ„Åã„ÇåÈÅì„Åß„Åô„Å≠‚Ä¶"
                ]
            },
            living: {
                skeleton : [
                    "„ÉÄ„Éº„ÉÑ„Åå„ÅäÂ•Ω„Åç„Å†„Å£„Åü„ÅÆ„ÅØ„ÄÅ„ÅØ„Å¶„ÄÅ„Å©„Å™„Åü„Å†„Å£„Åü„Åã‚Ä¶",
                    "„Å™„Åú„Åã„ÄÅ„ÄåÂÖà‰ª£„Åü„Å°„ÅÆÂêç„Çí‰∏¶„Åπ„Çà„Äç„Å®„ÅÑ„ÅÜË®ÄËëâ„ÅåÈ†≠„Å´„Åì„Å≥„Çä„Å§„ÅÑ„Åü„Çà„ÅÜ„Å´ÊÆã„Å£„Å¶„ÅÑ„Çã„ÅÆ„Åß„Åô„ÄÇ",
                    "ÁßÅ„ÅØ‰Ωï„ÅåÂ•Ω„Åç„Å†„Å£„Åü„ÅÆ„Åß„Åó„Çá„ÅÜ‚Ä¶ÊÄù„ÅÑÂá∫„Åõ„Åæ„Åõ„Çì",
                    "ÁéÑÈñ¢„ÅÆ„Ç´„ÇÆ„ÅØ„ÄÅ„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ä„ÅÆÂ∞èÁÆ±„ÅÆ‰∏≠„Å´„ÅÇ„Çä„Åæ„Åô„Åû",
                ],
                books1: [
                    'Âè§„ÅÑÊó•Ë®ò„ÇíË¶ã„Å§„Åë„Åü„ÄÇ„Äå2001Âπ¥7Êúà3Êó•„ÄÄ„ÉÄ„Éº„ÉÑ„ÅÆÂ§ß‰ºö„ÅßÊ∫ñÂÑ™Âãù„ÄÇÁ∑¥Áøí„Åó„Åü„Åã„ÅÑ„Åå„ÅÇ„Å£„ÅüÔºÅ„Äç',
                    'Âè§„ÅÑÊó•Ë®ò„ÇíË¶ã„Å§„Åë„Åü„ÄÇ„Äå1988Âπ¥8Êúà3Êó•„ÄÄÂèåÂ≠ê„ÅÆÂ®ò„ÅåÁîü„Åæ„Çå„Åü„ÄÇÂêçÂâç„ÅØ„Ç§„É≥„Ç∞„É™„ÉÉ„Éâ„Å®„Ç®„É¨„É≥„Å†„Äç',
                    'Âè§„ÅÑÊó•Ë®ò„ÇíË¶ã„Å§„Åë„Åü„ÄÇ„Äå1989Âπ¥3Êúà11Êó•„ÄÄ„Å™„Çì„Å®„ÅÑ„ÅÜ„Åì„Å®„Å†‚Ä¶ÁßÅ„Åå„ÅÇ„ÅÆ„Å®„Åç„ÇÇ„Å£„Å®„Åç„Å°„Çì„Å®Ë¶ã„Å¶„Åä„Åë„Å∞„ÄÇ„Ç®„É¨„É≥„Å´„ÅØ‰∫åÂ∫¶„Å®‰ºö„Åà„Å™„ÅÑ„ÄÇÊÆã„Çã„ÅÆ„ÅØË®òÊÜ∂„Å†„Åë„Äç',

                ]
            }
        };

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            changeRoom('genkan');
            updateMessage('Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÂè§„ÅÑÊ¥ãÈ§®„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇÁéÑÈñ¢„Éâ„Ç¢„ÅØ„Ç´„ÇÆ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Å¶Âá∫„Çâ„Çå„Åæ„Åõ„Çì');
        }

        // ÈÉ®Â±ã„ÇíÂ§âÊõ¥
        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${IMAGES.rooms[roomId]})`;
            
            // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Ç®„É™„Ç¢„ÇíÁîüÊàê
            generateClickableAreas(room);
            updateMessage(`${room.name}„Å´ÂÖ•„Çä„Åæ„Åó„Åü„ÄÇ${room.description}`);

//            const shareArea = document.getElementById('endingShareArea');
//            if (shareArea) { 
//                if (roomId === "end" || roomId === "dreamEnd" || roomId === "trueEnd" || roomId === "extraEnd") {
//                    shareArea.style.display = "block";
//                    console.log("„Ç∑„Çß„Ç¢UI„ÇíË°®Á§∫ÔºÅroomId:", roomId);
//                } else {
//                    shareArea.style.display = "none";
//                }
//            }
            // BGMÂàáÊõø
            if (roomId === "end" || roomId === "dreamEnd" || roomId === "trueEnd") {
                changeBGM("sounds/egao to namida.mp3");
            } else if (roomId === "extraEnd") {
                changeBGM("sounds/hokkori tea time.mp3");
            } else {
                changeBGM("sounds/sinpi no kyuuden.mp3");
            }
        }

        // ËÉåÊôØÁîªÂÉè„ÇíÂ∑Æ„ÅóÊõø„Åà
        function changeRoomImage(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            // ËÉåÊôØÁîªÂÉè„ÇíË®≠ÂÆöÔºàÁîªÂÉè„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÔºâ
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${IMAGES.rooms[roomId]})`;
            generateClickableAreas(room);
        }

        function unlockRoom(roomId) {
            if (!gameState.openRooms.includes(roomId)) gameState.openRooms.push(roomId);
            renderNavigation();
        }

        // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Ç®„É™„Ç¢„ÇíÁîüÊàê
        // 
        function generateClickableAreas(room) {
            const roomView = document.getElementById('roomView');

            roomView.innerHTML = '<img id="roomImage" src="'+IMAGES.rooms[gameState.currentRoom]+'" style="width:100%;height:100%;object-fit:contain;position:absolute;left:0;top:0;">';

            // ÁîªÂÉè„ÅÆ„É≠„Éº„ÉâÂæå„Å´ÈÖçÁΩÆ
            const img = roomView.querySelector('#roomImage');
            img.onload = function() {

                room.clickableAreas.forEach(area => {
                    const clickableDiv = document.createElement('div');
                    clickableDiv.className = 'clickable-area';
                    clickableDiv.style.left   = (area.x) + '%';
                    clickableDiv.style.top    = (area.y) + '%';
                    clickableDiv.style.width  = (area.width) + '%';
                    clickableDiv.style.height = (area.height) + '%';
                    clickableDiv.style.position = 'absolute';
                    clickableDiv.style.zIndex = area.zIndex || 1;
                    clickableDiv.onclick = () => handleAreaClick(area.action);
                    clickableDiv.title = area.description;

                    roomView.appendChild(clickableDiv);
                });
            };
            img.src = IMAGES.rooms[gameState.currentRoom]; // ÂøÖ„ÅöÁîªÂÉè„Çª„ÉÉ„Éà
        }

        // „Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleAreaClick(action) {
            switch(action) {
                case 'examine_genkan_door':
                    if (gameState.flags.foundGenkanKey) {
                        updateMessage('„Ç≤„Éº„É†„ÇØ„É™„Ç¢');
                    } else {
                         updateMessage('ÁéÑÈñ¢„Éâ„Ç¢„Å´„ÅØÈçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                    }
                     break;
                case 'examine_genkan_key':
                    updateMessage('Èñã„Åë„Çâ„Çå„Åù„ÅÜ„Å´„Å™„ÅÑ');
                    break;
                case 'examine_genkan_paper':
                    updateMessage('Â®ò„ÅÆË™ïÁîüÊó•„ÄÅ„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                    gameState.genkan.flags.watchedPaper = true;
                    break;
                case 'examine_genkan_chair':
                    if (gameState.genkan.flags.chairSitCount<7) {
                        updateMessage('Ê§ÖÂ≠ê„Å´Â∫ß„Å£„Å¶„Åø„Åü„ÄÇ‰Ωï„Åã„Åå„Åç„Åó„ÇÄ„Çà„ÅÜ„Å™Èü≥„Åå„Åô„Çã‚Ä¶');
                        playSE('se-metal');
                        gameState.genkan.flags.chairSitCount++;
                    } else {
                        playSE('se-metal');
                        showExtraPuzzle();
                    }
                    
                    break;
                case 'examine_genkan_left_door':
                    updateMessage('Áï™Âè∑Âºè„ÅÆ„Ç´„ÇÆ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                    if (!gameState.flags.genkanPuzzleSolved) {
                        showGenkanPuzzle();
                    } else {
                        changeRoom('corridor');
                    }
                    break;
                case 'examine_genkan_picture':
                    if (gameState.genkan.flags.watchedPaper && (!gameState.selectedItem=='picture'||gameState.selectedItem==null)) {
                        updateMessage('„Åì„Çå„ÅåÂ®ò„Å†„Çç„ÅÜ„ÅãÔºü18Ê≠≥Ë®òÂøµ„ÅÆËÇñÂÉèÁîª„ÅÆ„Çà„ÅÜ„Å†„ÄÇË£Ω‰ΩúÂπ¥„ÅØ2006„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                        
                    } else if(gameState.selectedItem=='picture') {
                        updateMessage('ËÇñÂÉèÁîª„ÅåÂ∞ë„ÅóÂæÆÁ¨ë„Çì„Å†ÔºÅ‚Ä¶„Çà„ÅÜ„Å™Ê∞ó„Åå„Åó„Åü');
                    } else {
                        updateMessage('Ëã•„ÅÑÂ•≥ÊÄß„ÅÆËÇñÂÉèÁîª„Å†');
                    }
                    
                    break;  
                case 'examine_genkan_memo':
                    updateMessage('‰Ωï„Åã„ÅÆ„É°„É¢„ÅÆ„Çà„ÅÜ„Å†„ÄÇ„Äå8/1„ÄÄÊòéÂæåÊó•„ÅØÂ®ò„ÅÆË™ïÁîüÊó•„Å†„ÄÇÊÆã„Çø„Çπ„ÇØÔºöË°ó„ÅÆÊ¥ãËèìÂ≠êÂ∫ó„ÅßÁâπË£Ω„ÉÅ„Éº„Ç∫„Ç±„Éº„Ç≠„Çí‰∫àÁ¥Ñ„Äç');
                    break; 
                case 'examine_genkan_spidernet':
                    // updateMessage('„ÇØ„É¢„ÅÆÂ∑£„ÅåÂºµ„Å£„Å¶„ÅÑ„Çã‚Ä¶');
                    talkToHintCharacter('genkan','spidernet');
                    break; 
                case 'examine_genkan_pin':
                    if (!gameState.genkan.flags.foundPin) {
                        updateMessage('Âè§„Å≥„Åü„Éî„É≥„Éñ„É≠„Éº„ÉÅ„Å†');
                        showModal(
                            'ÂÆ∂ÂÖ∑„ÅÆ‰∏ã„Å´‰Ωï„ÅãËêΩ„Å°„Å¶„ÅÑ„Çã‚Ä¶<br>Â∞è„Åï„Å™„Éî„É≥„Éñ„É≠„Éº„ÉÅ„Å†',
                            '<img src="images/pin.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );  
                        addItem('pin'); 
                        gameState.genkan.flags.foundPin = true;
                    } else {
                        updateMessage('‰Ωï„ÇÇ„Å™„ÅÑ');
                    }
                    
                    break;  
                case 'examine_genkan_skeleton':
                    talkToHintCharacter('genkan','skeleton');
                    playSE('se-skeleton');
                    break; 
                // living
                case 'examine_living_skeleton':
                    talkToHintCharacter('living','skeleton');
                    playSE('se-skeleton');
                    break; 
                
                case 'examine_living_pic1':
                    updateMessage('Áî∑ÊÄß„ÅÆÂÜôÁúü„Å†„ÄÇ„ÉÄ„Éº„ÉÑ„ÅÆÁü¢„ÇíÊßã„Åà„Å¶„ÅÑ„Çã„ÄÇ„ÄåMartin„ÄÄ„Éû„Éº„ÉÜ„Ç£„É≥„Äç');
                    break;
                case 'examine_living_pic2':
                    updateMessage('‰∏≠Âπ¥„ÅÆÂ•≥ÊÄß„ÅÆÂÜôÁúü„Å†„ÄÇ„ÄåDOROTHY„ÄÄ„Éâ„É≠„Ç∑„Éº„Äç');
                    break;
                case 'examine_living_pic3':
                    updateMessage('Ëã•„ÅÑÂ•≥ÊÄß„ÅÆÂÜôÁúü„Å†„ÄÇ„ÄåAmelia„ÄÄ„Ç¢„É°„É™„Ç¢„Äç');
                    break;
                case 'examine_living_pic4':
                    updateMessage('Â£ÆÂπ¥Áî∑ÊÄß„ÅÆÂÜôÁúü„Å†„ÄÇ„ÄåEdward„ÄÄ„Ç®„Éâ„ÉØ„Éº„Éâ„Äç');
                    break;
                case 'examine_living_pic5':
                    updateMessage('Ëã•„ÅÑÂ•≥ÊÄß„ÅÆÂÜôÁúü„Å†„ÄÇÂ∏ΩÂ≠ê„Çí„Åã„Å∂„Å£„Å¶„ÅÑ„Çã„ÄÇ„ÄåRachel„ÄÄ„É¨„Ç§„ÉÅ„Çß„É´„Äç');
                    break;
                case 'examine_living_books1':
                    talkToHintCharacter('living','books1');
                    break;  
                case 'examine_living_books2':
                    showModal(
                        '„É°„É¢„ÅåÊåü„Åæ„Å£„Å¶„ÅÑ„Çã„ÄÇ',
                        '<img src="images/living_memo1.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );
                    break;   
                case 'examine_living_books3':
                    updateMessage('„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ä„Å´„ÅØ1ÂÜä„ÅÆÊú¨„Åå„ÅÇ„Çã„ÄÇ„ÄåË©≥Ë™¨Ôºö„Éõ„Éº„É†„É°„Éº„Éâ„Çπ„Ç§„Éº„ÉÑ„ÅÆ‰Ωú„ÇäÊñπ„Äç„Éâ„É≠„Ç∑„Éº„Å®„Çµ„Ç§„É≥„ÅåÊÆã„Åï„Çå„Å¶„ÅÑ„Çã');
                    break;  
                case 'examine_living_table':
                    showModal(
                        'Á´ãÊ¥æ„Å™„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ã„Å´„É°„É¢„ÅåËêΩ„Å°„Å¶„ÅÑ„Åü„ÄÇ',
                        '„Éû„Éº„ÉÜ„Ç£„É≥„ÅÆ„Éñ„É≠„Éº„ÉÅ„ÄÅÂãùÊâã„Å´ÂÄü„Çä„Åü‰∏ä„Å´ÁÑ°„Åè„Åó„Å°„ÇÉ„Å£„Åü‚Ä¶<br>ÁßÅ„Å´ÊÆã„Åï„Çå„ÅüÈÅ∏ÊäûËÇ¢„ÅØÔºü„ÄÄ„Ç§„É≥„Ç∞„É™„ÉÉ„Éâ',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );
                    break; 
                case 'examine_living_sofa':
                    updateMessage('„Äå„Å©„ÅÜ„Åû„Å©„ÅÜ„Åû„ÄÅ„Åä„Åã„Åë„Åè„Å†„Åï„ÅÑ„ÄÇÂ§¢„ÅÆ„Çà„ÅÜ„Å™Â∫ß„ÇäÂøÉÂú∞„Åß„Åô„Çà„Äç');
                    playSE('se-skeleton');
                    break; 
                case 'examine_living_lapel':
                    if (gameState.selectedItem=='pin') {
                        updateMessage('„Äå„Å™„Çì„Å®„ÄÅÁßÅ„Å´‰∏ã„Åï„Çã„ÅÆ„Åß„Åô„ÅãÔºü„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ„Äç');
                        playSE('se-skeleton');
                        showModal(
                            '„Äå„Å™„Çì„Å®„ÄÅÁßÅ„Å´‰∏ã„Åï„Çã„ÅÆ„Åß„Åô„ÅãÔºü„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„Äç',
                            '<img src="images/skeleton-favor.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );
                        removeItem('pin');
                        gameState.flags.skeletonFavor++;
                    } else {
                        updateMessage('„Äå„Å©„ÅÜ„Åã„Åó„Åæ„Åó„Åü„Åã„Å™Ôºü„Äç');
                    }
                    break; 
                // corridor
                case 'examine_corridor_door':
                    if (gameState.corridor.flags.talkToLeft && gameState.corridor.flags.talkToCenter && gameState.corridor.flags.talkToRight && !gameState.flags.corridorPuzzleSolved) {
                        showCorridorPuzzle();
                    }
                    else if(!gameState.flags.corridorPuzzleSolved){
                        updateMessage('„Éâ„Ç¢„Å´„ÅØÈçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                    } else {
                        changeRoom('dining');
                    }
                    break;
                case 'examine_corridor_skeleton':
                    talkToHintCharacter('corridor','skeleton');
                    playSE('se-skeleton');
                    break; 
                case 'examine_corridor_picture_left':
                    talkToHintCharacter('corridor','pic_left');
                    playSE('se-person');
                    gameState.corridor.flags.talkToLeft = true;
                    break;  
                case 'examine_corridor_picture_center':
                    talkToHintCharacter('corridor','pic_center');
                    gameState.corridor.flags.talkToCenter = true;
                    playSE('se-person');
                    break;  
                case 'examine_corridor_picture_right':
                    talkToHintCharacter('corridor','pic_right');
                    gameState.corridor.flags.talkToRight = true;
                    playSE('se-person');
                    break;    
                case 'examine_corridor_light':
                    updateMessage('Âè§„Å≥„ÅüÁÖßÊòé„Å†„ÄÇÈ´ò‰æ°„Åù„ÅÜ„Å™Èõ∞Âõ≤Ê∞ó„Å†');
                    break;
                case 'examine_corridor_drawer1':
                    updateMessage('Ë´ãÊ±ÇÊõ∏„Åå„ÅÇ„Çã„ÄÇ„Äå1967/3/4„ÄÄ„Éõ„É≠„É≥ÂÆ∂„ÅÆ„Éâ„É≠„Ç∑„ÉºÊßò„ÄÇÊúçÈ£æ‰ª£„Å®„Åó„Å¶5900„Ç¥„Éº„É´„Éâ„ÇíË´ãÊ±Ç„ÅÑ„Åü„Åó„Åæ„Åô„Äç');
                    break;  
                case 'examine_corridor_drawer2':
                    if (gameState.selectedItem=='drawerKey' && !hasItem('coin')) {
                        updateMessage('„Ç≥„Ç§„É≥„Çí„Åø„Å§„Åë„Åü');
                        showModal(
                            'Âè§„Å≥„Åü„Ç≥„Ç§„É≥„ÇíË¶ã„Å§„Åë„Åü„ÄÇ<br>‰Ωï„Åã„Å´‰Ωø„Åà„Åù„ÅÜ„Å†',
                            '<img src="images/coin.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );  
                        addItem('coin');
                        removeItem('drawerKey');
                        gameState.corridor.flags.useDrawerKey = true;
                    } else if(gameState.corridor.flags.useDrawerKey && !gameState.corridor.foundPicture) {
                        updateMessage('ÂÜôÁúü„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        showModal(
                            'Âºï„ÅçÂá∫„Åó„ÅÆÂ••„Å´Âè§„Å≥„ÅüÂÜôÁúü„Åå„ÅÇ„Çã„ÄÇ<br>Ë£è„Å´„Äå„Ç§„É≥„Ç∞„É™„ÉÉ„Éâ„ÅÆË™ïÁîüÊó•„ÄÅ<br>„ÅîÈ¶≥Ëµ∞„Åå„Åü„Åè„Åï„ÇìÊÆã„Å£„Å¶„Åó„Åæ„Å£„Åü„Çè„Å≠„Äç„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã',
                            '<img src="images/picture.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );  
                        addItem('picture');
                        gameState.corridor.foundPicture = true;

                    } else if (gameState.corridor.flags.useDrawerKey && gameState.corridor.foundPicture) {
                        updateMessage('Âºï„ÅçÂá∫„Åó„ÅØÁ©∫„Å£„ÅΩ„Å†');
                    }
                    else {
                        updateMessage('Èçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Å¶Èñã„Åã„Å™„ÅÑ');
                    }
                    break;  
                case 'examine_corridor_chair': 
                    if(!gameState.corridor.flags.foundDrawerKey) {
                        updateMessage('„Åµ„Åã„Åµ„Åã„Å®„Åó„ÅüÊ§ÖÂ≠ê„Å†');  
                        showModal(
                            'Â∫ß„Å£„Å¶„Åø„Çã„Å®„ÅäÂ∞ª„Å´Âõ∫„ÅÑ„ÇÇ„ÅÆ„ÅåÂΩì„Åü„Çã‚Ä¶<br>Âºµ„ÇäÂú∞„ÅÆÁ†¥„ÇåÁõÆ„Åã„ÇâÊåá„ÇíÂÖ•„Çå„Çã„Å®‰Ωï„Åã„Åå„ÅÇ„Çã„ÄÇ<br>Â∞è„Åï„Å™Èçµ„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇ',
                            '<img src="images/drawerKey.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );  
                        addItem('drawerKey');
                        gameState.corridor.flags.foundDrawerKey = true;
                    } else {
                        updateMessage('„Åµ„Åã„Åµ„Åã„Å®„Åó„ÅüÊ§ÖÂ≠ê„Å†');   
                    }
                    
                    break;  
                // dining
                case 'examine_dining_skeleton':
                    if (gameState.selectedItem=='oil' && !gameState.dining.useOilToSkeleton) {
                        updateMessage('„Äå„Åì„Çå„ÅØ„Åì„Çå„ÅØÔºÅÈ™®„Å´ËâØ„Åï„Åù„ÅÜ„Å™„Ç™„Ç§„É´„Åß„Åô„Å™„ÄÇ„ÅÇ„Çä„Åå„Åü„Åè„ÅÑ„Åü„Å†„Åç„Åæ„Åô„Äç'); 
                        playSE('se-skeleton');
                        removeItem('oil');
                        gameState.flags.skeletonFavor++;
                        gameState.dining.useOilToSkeleton = true;
                    } else if (gameState.selectedItem=='oil' && gameState.dining.useOilToSkeleton) {
                        updateMessage('„Äå‰ªä„ÅÆÁßÅ„ÅØ„Ç™„Ç§„É´„ÅßËâ∂„ÄÖ„Çπ„Ç±„É´„Éà„É≥„Åß„Åô„ÅÆ„Åß„ÄÅÁµêÊßã„Åß„Åô„Çà„Äç'); 
                        playSE('se-skeleton');
                    } else {
                        talkToHintCharacter('dining','skeleton');
                        playSE('se-skeleton');
                    }
                    
                    break; 
                case 'examine_dining_under_table': 
                    if(!gameState.dining.flags.foundJam) {
                        updateMessage('„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ã„Å´„Ç∏„É£„É†„ÅÆÁì∂„ÅåËêΩ„Å°„Å¶„ÅÑ„Åü„ÄÇÊú™ÈñãÂ∞Å„Å†„ÄÇÊûúÂÆü„ÅÆÈ¶ô„Çä„Åå„Åª„ÅÆ„Åã„Å´„Åô„Çã„ÄÇ‰Ωø„ÅÑÈÅì„ÅØ‚Ä¶„Éë„É≥‰ª•Â§ñ„Å´„ÇÇÔºü');    
                        showModal(
                            '„Ç∏„É£„É†„ÅÆÁì∂Ôºà‰∏≠Ë∫´ÂÖ•„ÇäÔºâ„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇ',
                            '<img src="images/jam.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );  
                        addItem('jam');
                        gameState.dining.flags.foundJam = true;
                    } else {
                        updateMessage('‰Ωï„ÇÇ„Å™„ÅÑ');   
                    }
                    
                    break;  
                case 'examine_pot': 
                    if(!hasItem('oil')) {
                        updateMessage('„Éù„ÉÉ„Éà„ÅÆ‰∏≠Ë∫´„ÅØ„Å™„Å´„Åã„ÅÆ„Ç™„Ç§„É´„ÅÆ„Çà„ÅÜ„Å†„ÄÇ„Å™„Çì„Å†„ÅãÈ™®„Å´„ÉÑ„É§„ÅåÂá∫„Åù„ÅÜ„Å™„Ç™„Ç§„É´„Å†');   
                        showModal(
                            '„Éù„ÉÉ„Éà„ÅÆ‰∏≠„Å´„ÅØÊ≤π„ÅÆ„Çà„ÅÜ„Å™Ê∂≤‰Ωì„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã<br>„Åæ„Çã„Åß„Éó„É¨„Ç§„É§„Éº„ÅÆ„Åü„ÇÅ„Å´Áî®ÊÑè„Åï„Çå„Åü„Çà„ÅÜ„Å™„Ç∞„É©„Çπ„ÇíË¶ã„Å§„Åë„ÄÅ„Ç™„Ç§„É´„ÇíÂÖ•„Çå„Åü',
                            '<img src="images/oil.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );   
                        addItem('oil');
                        gameState.corridor.flags.foundOil = true;
                    } else {
                        updateMessage('„Éù„ÉÉ„Éà„ÅÆ‰∏≠„Å´„ÅØÊ≤π„ÅÆ„Çà„ÅÜ„Å™Ê∂≤‰Ωì„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã');   
                    }
                    
                    break;  
                case 'examine_dining_right_dish1':
                    if (gameState.selectedItem=='coin' || gameState.selectedItem=='jam') {
                        // „Éê„ÉÉ„Éâ„Ç®„É≥„ÉâÊºîÂá∫
                        showModal(
                            '„Éê„ÉÉ„Éâ„Ç®„É≥„Éâ',
                            '<img src="images/badend.jpg" style="width:300px;display:block;margin:0 auto 20px;">' +
                            '<br>„ÅÇ„Å™„Åü„ÅØ„ÇØ„Éû„ÅÆÂ¶ñÁ≤æ„ÅÆ„ÅäÁöø„ÇíÂâ≤„Å£„Å¶„Åó„Åæ„Å£„Åü‚Ä¶<br><b>Â§ß‰∫ã„Å™„ÇÇ„ÅÆ„Å†„Å£„Åü„Çà„ÅÜ„Å†„ÄÇ</b><br>„ÅÇ„Å™„Åü„ÅØÊÄí„Å£„ÅüÈ™∏È™®„Å´„Çà„ÇäÂ∞èÈÉ®Â±ã„Å´Áõ£Á¶Å„Åï„Çå„Åü„ÄÇ<span style="color:#f00;">„Äê„Éê„ÉÉ„Éâ„Ç®„É≥„Éâ„Äë</span><br><span style="font-weight:bold;color:#5ef4dc;">„ÇÇ</span>„ÅÜ„ÅÑ„ÇÑ„Å†',
                            [{text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart'}]
                        );
                        playSE('se-parin');
                        break;
                    } else {
                        updateMessage('Âè§„Åù„ÅÜ„Å™„ÅäÁöø„ÅåÈ£æ„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇ„ÇØ„Éû„ÅÆÂ¶ñÁ≤æ„ÅÆÁµµ„ÅåÊõ∏„Åã„Çå„Å¶„Åä„Çä„ÄÅÂ∞ë„Åó„Å≤„Å≥„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã');
                    }
                    break; 
                case 'examine_dining_right_dish2':
                    updateMessage('Âè§„Åù„ÅÜ„Å™„ÅäÁöø„ÅåÈ£æ„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇÊ§ÖÂ≠ê„Åå7ËÑöÊèè„ÅÑ„Å¶„ÅÇ„Çä„ÄÅÊéõ„ÅëÈáë„Åå„ÇÜ„Çã„Çì„Åß„Åç„Åó„ÇÄÈü≥„Åå„Åô„Çã');
                    break; 
                case 'examine_dining_center_dish':
                    updateMessage('„ÅäÁöø„ÅÆ‰∏ã„Å´„É°„É¢„Åå„ÅÇ„Çã');
                    showModal(
                            '„ÅäÁöø„ÅÆ‰∏ã„Å´„É°„É¢„Åå„ÅÇ„Çã',
                            '<img src="images/living_memo2.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );
                    break; 
                case 'examine_kannuki':
                    if (gameState.selectedItem=='oil' && !gameState.flags.diningPuzzleSolved) {
                        updateMessage('„Ç™„Ç§„É´„Åß„Åã„Çì„Å¨„Åç„ÅåÂãï„Åè„Çà„ÅÜ„Å´„Å™„Å£„ÅüÔºÅ');
                        playSE('se-subclear');
                        showModal(
                            '„Ç™„Ç§„É´„Åß„Åã„Çì„Å¨„Åç„ÅåÂãï„Åè„Çà„ÅÜ„Å´„Å™„Å£„ÅüÔºÅ',
                            '<img src="images/sub_clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );
                        removeItem('oil');
                        unlockRoom('living');
                        renderNavigation();
                        gameState.flags.diningPuzzleSolved = true;
                        changeRoom('living');
                    } else if (gameState.selectedItem=='jam' && !gameState.flags.diningPuzzleSolved) {
                        updateMessage('„Ç∏„É£„É†„ÇíÂ°ó„Å£„Å¶„Åø„Çã„Å®„ÄÅ„Åã„Çì„Å¨„Åç„ÅåÂãï„Åè„Çà„ÅÜ„Å´„Å™„Å£„ÅüÔºÅ');
                        playSE('se-subclear');
                        showModal(
                            '„Ç∏„É£„É†„ÇíÂ°ó„Å£„Å¶„Åø„Çã„Å®„ÄÅ„Åã„Çì„Å¨„Åç„ÅåÂãï„Åè„Çà„ÅÜ„Å´„Å™„Å£„ÅüÔºÅ',
                            '<img src="images/sub_clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );
                        removeItem('jam');
                        unlockRoom('living');
                        renderNavigation();
                        gameState.flags.diningPuzzleSolved = true;
                        changeRoom('living');
                    } else if(!gameState.flags.diningPuzzleSolved) {
                        updateMessage('„Åã„Çì„Å¨„Åç„Åå„Åï„Å≥‰ªò„ÅÑ„Å¶Âãï„Åã„Å™„ÅÑ');
                    } else {
                        changeRoom('living');
                    }
                    break;
                case 'examine_insect':
                    updateMessage('„Ç¥„Ç≠„Éñ„É™„ÅÆÊ≠ªÈ™∏„ÅåËêΩ„Å°„Å¶„ÅÑ„Çã„ÄÇ');
                    break;    
                case 'examine_living_box':
                    showFinalPuzzle();
                    break;
                
                case 'examine_end':
                    updateMessage('„ÅÇ„Å™„Åü„ÅØÂ§ñ„Å∏„Å®Ë∂≥„ÇíË∏è„ÅøÂá∫„Åó„Åæ„Åó„Åü„ÄÇÔºà„Éé„Éº„Éû„É´„Ç®„É≥„ÉâÔºâ');
                    break; 
                case 'examine_dream_end':
                    updateMessage('„ÅÇ„Å™„Åü„ÅØÂ§¢„ÅÆ‰∏ñÁïå„ÅßÂπ∏„Åõ„Å´ÊöÆ„Çâ„Åó„Åæ„Åó„Åü„ÄÇÔºà„Éé„Éº„Éû„É´„Ç®„É≥„Éâ2Ôºâ');
                    break; 
                case 'examine_true_end':
                    updateMessage('„ÅÇ„Å™„Åü„ÅØÂ±ãÊï∑„Å´ÊÆã„Åï„Çå„ÅüË¨é„ÇíÈñãÊîæ„Åó„Åæ„Åó„Åü„ÄÇÔºà„Éà„Ç•„É´„Éº„Ç®„É≥„ÉâÔºâ');
                    break; 
            }
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;

            playSE('se-click');
            updateInventoryDisplay();
        }

        function talkToHintCharacter(roomId, charId) {
            // flagsÂèñÂæó
            let flags = gameState[roomId].flags;
            // „Åæ„Å†„Ç´„Ç¶„É≥„ÉàÁÑ°„Åë„Çå„Å∞ÂàùÊúüÂåñ
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            flags.talkTo[charId]++;

            // „Çª„É™„Éï„É™„Çπ„ÉàÂèñÂæó
            const messages = hintMessages[roomId][charId];
            // ÁØÑÂõ≤Â§ñ„Å™„ÇâÊúÄÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const idx = (flags.talkTo[charId] - 1) % messages.length;

            // Ë°®Á§∫
            updateMessage(messages[idx]);
        }

        // ÁéÑÈñ¢„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showGenkanPuzzle() {
            const modalContent = `
                <h3>ÂÖ•Âäõ„Éë„Éç„É´</h3>
                <p>Â®ò„ÅÆË™ïÁîüÊó•„ÅØÔºü</p>
                <input type="text" class="puzzle-input" id="genkanInput" placeholder="Êï∞Â≠ó„ÇíÂÖ•ÂäõÔºà‰æã:19990101Ôºâ">
                <br>
                <button onclick="checkGenkanPuzzle()">Á¢∫Ë™ç</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ÁéÑÈñ¢„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkGenkanPuzzle() {
            const input = document.getElementById('genkanInput').value;
            if (input === 'ÔºëÔºôÔºòÔºòÔºêÔºòÔºêÔºì' || input === '19880803') {
                closeModal();
                updateMessage('Ê≠£Ëß£„Åß„ÅôÔºÅ„Éâ„Ç¢„ÅåÈñã„Åç„Åæ„Åó„ÅüÔºÅ');
                playSE('se-subclear');
                showModal(
                    'Ê¨°„ÅÆÈÉ®Â±ã„Å∏„ÅÆ„Éâ„Ç¢„ÅåÈñã„ÅÑ„ÅüÔºÅ',
                    '<img src="images/sub_clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                );
                unlockRoom('corridor');
                renderNavigation();
                gameState.flags.genkanPuzzleSolved = true;
                changeRoom('corridor');

            } else {
                playSE('se-error');
                updateMessage('ÈÅï„ÅÑ„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„Åà„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // Âªä‰∏ã„ÇØ„Ç§„Ç∫„ÇíË°®Á§∫
        function showCorridorPuzzle() {
            const modalContent = `
                <h3>Ë¨é„ÅÆÂ£∞„ÅåÈüø„Åè‚Ä¶</h3>
                <p>‰∏ÄÁï™„ÅÆÂè§Ê†™„ÅÆÂêç„ÅØÔºü</p>
                <input type="text" class="puzzle-input" id="corridorInput" placeholder="„Ç¢„É°„É™„Ç¢or„Éç„É´„ÇΩ„É≥or„Éâ„É≠„Ç∑„Éº">
                <br>
                <button onclick="checkCorridorPuzzle()">Á¢∫Ë™ç</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // Âªä‰∏ã„ÇØ„Ç§„Ç∫„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkCorridorPuzzle() {
            const input = document.getElementById('corridorInput').value;
            if (input === '„Éâ„É≠„Ç∑„Éº') {
                closeModal();
                updateMessage('Ê≠£Ëß£„Åß„ÅôÔºÅ‰∏çÊÄùË≠∞„Å™Âäõ„ÅßÈçµ„ÅåÈñã„Åç„Åæ„Åó„ÅüÔºÅ');
                playSE('se-subclear');
                showModal(
                    'Ê¨°„ÅÆÈÉ®Â±ã„Å∏„ÅÆ„Éâ„Ç¢„ÅåÈñã„ÅÑ„ÅüÔºÅ',
                    '<img src="images/sub_clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                );
                unlockRoom('dining');
                renderNavigation();
                gameState.flags.corridorPuzzleSolved = true;
                changeRoom('dining');
                updateMessage('„ÉÄ„Ç§„Éã„É≥„Ç∞„ÅÆ„Çà„ÅÜ„Å†');

            } else {
                playSE('se-error');
                updateMessage('ÈÅï„ÅÑ„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„Åà„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // ÊúÄÁµÇ„ÇØ„Ç§„Ç∫„ÇíË°®Á§∫
        function showFinalPuzzle() {
            const modalContent = `
                <h3>Á≠î„Åà„ÇíÂÖ•Âäõ</h3>
                <p>ÂÖàÁ•ñ„ÅÆÂêç„Çí‰∏¶„Åπ„Çà</p>
                <input type="text" class="puzzle-input" id="finalInput" placeholder="„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„Åß">
                <br>
                <button onclick="checkFinalPuzzle()">Á¢∫Ë™ç</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ÊúÄÁµÇ„ÇØ„Ç§„Ç∫„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkFinalPuzzle() {
            const input = document.getElementById('finalInput').value;
            if (input === 'dream' || input === 'DREAM') {
                closeModal();
                
                
                if (gameState.flags.skeletonFavor>1) {
                    playSE('se-box');
                    showModal(
                        'ÁÆ±„ÅåÈñã„ÅÑ„ÅüÔºÅ',
                        '<img src="images/openBox.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );
                    playSE('se-clear');
                    window._nextModal = {
                        before: function() { playSE('se-clear'); },
                        title: '‚Ä¶‚Ä¶„ÅÇ„ÅÇ„ÄÅÊÄù„ÅÑÂá∫„Åó„Åæ„Åó„Åü„ÄÇÁßÅ„ÅÆÂêç„ÅØ„Éû„Éº„ÉÜ„Ç£„É≥„ÄÇ<br>„ÅÇ„Å™„Åü„ÅÆ„Åä„Åã„Åí„Åß„ÄÅÁßÅ„ÇÇ„ÇÑ„Å£„Å®ÂøÉÊÆã„Çä„Åã„ÇâËß£Êîæ„Åï„Çå„Åæ„Åô„ÄÇ<br>„Åï„ÅÇ„ÄÅ„Å®„ÇÇ„Å´Â§¢„ÅÆ‰∏ñÁïå„Å∏‚Ä¶',
                        content: '<img src="images/dream_clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        buttons: [{text: 'Èñâ„Åò„Çã', action: 'close'}],
                        after: function() { changeRoom('dreamEnd'); }
                    };

                } else {
                    playSE('se-box');
                    showModal(
                        'ÁÆ±„ÅåÈñã„ÅÑ„ÅüÔºÅ',
                        '<img src="images/openBox.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );
                    playSE('se-clear');
                    window._nextModal = {
                        before: function() { playSE('se-clear'); },
                        title: '‚Ä¶‚Ä¶„ÅÇ„ÅÇ„ÄÅÊÄù„ÅÑÂá∫„Åó„Åæ„Åó„Åü„ÄÇÁßÅ„ÅÆÂêç„ÅØ„Éû„Éº„ÉÜ„Ç£„É≥„ÄÇ<br>„Åì„ÅÆÂ±ãÊï∑„Å´‚ÄúÂ§¢ÔºàDREAMÔºâ‚Äù„ÇíË®ó„Åó„Å¶„Åè„Å†„Åï„Å£„Å¶„ÄÅ<br>ÂøÉ„Çà„ÇäÊÑüË¨ùÁî≥„Åó‰∏ä„Åí„Åæ„Åô',
                        content: '<img src="images/clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        buttons: [{text: 'Èñâ„Åò„Çã', action: 'close'}],
                        after: function() { changeRoom('end'); }
                    };
                }
                

            } else if (input === 'remained' || input === 'REMAINED') {
                playSE('se-box');
                showModal(
                        'ÁÆ±„ÅåÈñã„ÅÑ„ÅüÔºÅ',
                        '<img src="images/openBox.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );
                playSE('se-clear');
                // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´ÊÉÖÂ†±„Çí„Çª„ÉÉ„Éà
                window._nextModal = {
                    before: function() { playSE('se-clear'); },
                    title: '‚Ä¶‚Ä¶„ÅÇ„ÅÇ„ÄÅ„Åô„Åπ„Å¶ÊÄù„ÅÑÂá∫„Åó„Åæ„Åó„Åü„ÄÇÁßÅ„ÅÆÂêç„ÅØ„Éû„Éº„ÉÜ„Ç£„É≥„ÄÇ<br>„Åì„ÅÆÂ±ãÊï∑„Å´ÊÆã„Åï„Çå„ÅüÂ§¢„Çí„Åô„Åπ„Å¶Ë¶ã„Å§„Åë„Å¶„Åè„Å†„Åï„Å£„Å¶<br>ÂÆ∂Êóè‰∏ÄÂêåÂøÉ„Çà„ÇäÊÑüË¨ùÁî≥„Åó‰∏ä„Åí„Åæ„Åô',
                    content: '<img src="images/true_clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    buttons: [{text: 'Èñâ„Åò„Çã', action: 'close'}],
                    after: function() { changeRoom('trueEnd'); }
                };
                
            } else {
                playSE('se-error');
                updateMessage('ÈÅï„ÅÑ„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„Åà„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // extra„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showExtraPuzzle() {
            const modalContent = `
                <h3>Ë¨é„ÅÆÂ£∞„ÅåÈüø„Åè‚Ä¶</h3>
                <p>ÂêàË®ÄËëâÔºü</p>
                <input type="text" class="puzzle-input" id="extraInput" placeholder="">
                <br>
                <button onclick="checkExtraPuzzle()">Á¢∫Ë™ç</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // extra„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkExtraPuzzle() {
            const input = document.getElementById('extraInput').value;
            if (input === '„Åä„ÇÇ„ÅÑÂá∫') {
                closeModal();
                updateMessage('Ê≠£Ëß£„Åß„ÅôÔºÅ„ÇÑ„Çä„Åì„Åø„Åå„ÅäË¶ã‰∫ãÔºÅ');
                playSE('se-clear');
                showModal(
                    '„ÅäË¶ã‰∫ãÔºÅ',
                    '<img src="images/extra_end.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                );
                renderNavigation();
                changeRoom('extraEnd');

            } else {
                playSE('se-error');
                updateMessage('ÈÅï„ÅÑ„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„Åà„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // „Ç¢„Ç§„ÉÜ„É†ÁÆ°ÁêÜ
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 5) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }
            
        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ‰ΩøÁî®„Åó„Åü„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay(); 
            }
        }

        function getItemName(itemId) {
            const names = {
                key: 'Èçµ',
                drawerKey: '„Å°„ÅÑ„Åï„Å™Èçµ',
                oil: '„Ç≥„ÉÉ„Éó„Å´ÂÖ•„Å£„Åü„Ç™„Ç§„É´',
                jam: '„Ç∏„É£„É†„ÅåÂÖ•„Å£„ÅüÁì∂',
                coin: 'Âè§„ÅÑ„Ç≥„Ç§„É≥',
                book: '„Ç≥„Ç∞„Éû„ÅÆÂ§ßÂÜíÈô∫„ÅÆÁµµÊú¨',
                pin: 'Âè§„Å≥„Åü„Éî„É≥„Éñ„É≠„Éº„ÉÅ„ÄåM„ÅÆ„Ç§„Éã„Ç∑„É£„É´‰ªò„Åç„Äç',
                picture: 'Âè§„Å≥„ÅüÂÜôÁúü„Äå„Ç§„É≥„Ç∞„É™„ÉÉ„Éâ„ÅÆË™ïÁîüÊó•„Äç'
            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;
                btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        // „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫Êõ¥Êñ∞
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function() {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                }
                // ‚òÖÈÅ∏Êäû‰∏≠„Å™„Çâselected„ÇØ„É©„ÇπËøΩÂä†
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        function updateMessage(message) {
            document.getElementById('messageArea').innerHTML = message;
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content, buttons) {
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            buttons.forEach(button => {
                modalHtml += `<button onclick="${button.action === 'close' ? 'closeModal' : button.action === 'restart' ? 'restartGame()' : button.action}()">${button.text}</button>`;
            });
            
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        // function closeModal() {
        //     document.getElementById('modal').style.display = 'none';
        // }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
            if (window._nextModal) {
                // ÁôªÈå≤ÂÜÖÂÆπ„ÅØ {title, content, buttons, after} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                let modal = window._nextModal;
                window._nextModal = null; // „ÇØ„É™„Ç¢
                if (modal.before) modal.before(); // „ÇÇ„ÅóplaySE„Å™„Å©‰∫ãÂâçÂá¶ÁêÜ„Åó„Åü„Åë„Çå„Å∞
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after(); // „ÇÇ„ÅóshowModalÁõ¥Âæå„Å´„ÇÑ„Çä„Åü„ÅÑ„Åì„Å®„ÅÇ„Çå„Å∞
            }
        }

        // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„Éà
        function restartGame() {
            gameState = {
                currentRoom: 'genkan',
                openRooms:  ['genkan'], 
                inventory: [],
                genkan: {
                    flags: {
                        talkTo: {
                            skeleton:0
                        },
                        watchedPaper: false,
                        foundPin: false,
                        chairSitCount: 0
                    }
                },
                corridor: {
                    flags: {
                        foundDrawerKey: false,
                        foundPicture: false,
                        talkTo: {
                            skeleton:0,
                            pic_left:0,
                            pic_center:0,
                            pic_right:0
                        },
                        talkToLeft:false,
                        talkToCenter:false,
                        talkToRight: false,
                    }
                },
                dining: {
                    flags: {
                        foundOil: false,
                        foundJam: false,
                        useOilToSkeleton: false,
                    }
                },
                living: {
                    flags: {
                        readMemo: false,
                    }
                },
                flags: {
                    skeletonFavor :0,
                    foundFutonbo: false,
                    foundBear: false,
                    happyBear: false,
                    foundBook:false,
                    genkanPuzzleSolved: false,
                    corridorPuzzleSolved: false,
                    diningPuzzleSolved: false,
                },
                selectedItem: null,
                selectedItemSlot: null,
            };
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;   // ‚Üê„Éá„Éï„Ç©„É´„Éà„ÅØÂÜçÁîü„Åó„Å¶„Å™„ÅÑ
        let isBGMInitialized = false; // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®

        // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Å†„ÅëBGM„ÇíÂÜçÁîü
        function initBGMOnce() {
        if (!isBGMInitialized) {
            const bgm = document.getElementById('bgm');
            bgm.volume = 0.3;
            bgm.play();
            isBGMPlaying = true;
            isBGMInitialized = true;
            document.getElementById('bgm-toggle').textContent = "üîä BGM";
        }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "üîä BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "üîá BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            if (bgm.src.endsWith(newSrc)) return; // „Åô„Åß„Å´„Åù„ÅÆBGM„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // „Å©„Åì„Åã„ÅßÊúÄÂàù„Å´‰∏ÄÂ∫¶„Å†„ÅëÂëº„Å∂
        function preloadImages() {
            Object.values(IMAGES.rooms).forEach(src => {
                const img = new Image();
                img.src = src;
            });
            Object.values(IMAGES.items).forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        function shareOnTwitter(resultType) {
            // ‰æãÔºöresultType = "true_end" or "normal_end"
            let url = encodeURIComponent(location.href);
            let text;
            if (resultType === "true_end") {
                text = encodeURIComponent("ËÑ±Âá∫„Ç≤„Éº„É†„ÄéÂ±ãÊï∑„Å´ÊÆã„Åï„Çå„ÅüÂ§¢„Äè„ÅßÁúü„Ç®„É≥„ÉâÈÅîÊàêÔºÅ #ËÑ±Âá∫„Ç≤„Éº„É†");
            } else {
                text = encodeURIComponent("ËÑ±Âá∫„Ç≤„Éº„É†„ÄéÂ±ãÊï∑„Å´ÊÆã„Åï„Çå„ÅüÂ§¢„Äè„Çí„ÇØ„É™„Ç¢ÔºÅ #ËÑ±Âá∫„Ç≤„Éº„É†");
            }
            window.open(`https://x.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }
        function copyShareText() {
            let text = "ËÑ±Âá∫„Ç≤„Éº„É†„ÄéÂ±ãÊï∑„Å´ÊÆã„Åï„Çå„ÅüÂ§¢„Äè„Çí„ÇØ„É™„Ç¢ÔºÅ #ËÑ±Âá∫„Ç≤„Éº„É† " + location.href;
            navigator.clipboard.writeText(text).then(() => alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'));
        }

        function saveGame() {
            localStorage.setItem('escapeGameState', JSON.stringify(gameState));
            const oldMsg = document.getElementById('messageArea').innerHTML;
            updateMessage('„Çª„Éº„Éñ„Åó„Åæ„Åó„ÅüÔºÅ');
            setTimeout(() => {
                updateMessage(oldMsg);
            }, 1500);
        }

        function loadGame() {
            const saved = localStorage.getItem('escapeGameState');
            if (saved) {
                gameState = JSON.parse(saved);
                // UI„ÇÑÁîªÈù¢„Çístate„Å´Âêà„Çè„Åõ„Å¶Âæ©ÂÖÉ„Åô„Çã
                changeRoom(gameState.currentRoom);
                updateInventoryDisplay();
                renderNavigation();
                updateMessage('„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ');
            } else {
                updateMessage('„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        preloadImages();
        initGame();
    </script>
</body>
</html>