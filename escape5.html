<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¬ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰ã®è„±å‡ºã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;  /* â†ã“ã‚Œé‡è¦ */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .room-view {
            aspect-ratio: 1/1;           /* â†æ­£æ–¹å½¢ */
            width: 90vw;                 /* ç”»é¢å¹…ã®90% */
            max-width: 640px;            /* PCæ™‚æœ€å¤§ã‚µã‚¤ã‚º */
            max-height: 90vw;       
            background-size: cover;      
            background-repeat: no-repeat;
            background-position: center center;
            position: relative;
            margin: 0 auto;
            cursor: crosshair;
            transition: background-image 0.5s ease-in-out;
        }

        #roomImage {
            width: 100%;
            height: 100%;
            object-fit: contain;    /* ç”»åƒå…¨ä½“ã‚’è¡¨ç¤º */
            position: absolute;
            left: 0;
            top: 0;
            z-index: 0;
            pointer-events: none;   /* ç”»åƒä¸Šã§ã‚‚ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒé€šã‚‹ã‚ˆã†ã« */
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
            }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }



        .clickable-area {
            position: absolute;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            z-index: 2;
            pointer-events: auto;

        }

        .clickable-area:hover {
            border-color: #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 20px;
            width:100%;
        }

        .inventory-slot {
            width: 14vw; 
            height: 14vw; 
            max-width: 80px; 
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;   /* é‡‘è‰²ãƒ»å¤ªã‚æ¨å¥¨ */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .info-panel {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            height:80px;
            min-height: 40px;
            border: 1px solid #d4af37;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        /* ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }
        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            width: 40%;
        }

        @media (max-width: 600px) {
            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }
            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width:100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }
        #roomEffectOverlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }
        .title-wrapper {
            display: flex;
            width:100%;
        }
        @keyframes sparkle-pop {
            0%   { opacity: 0; transform: scale(0.3) rotate(0deg);}
            10%  { opacity: 1; transform: scale(1.1) rotate(8deg);}
            70%  { opacity: 1; transform: scale(1.0) rotate(-8deg);}
            100% { opacity: 0; transform: scale(2.0) rotate(30deg);}
        }
        .sparkle-effect {
            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            width: 180px; height: 180px;
            pointer-events: none;
            z-index: 30;
            background: url('https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/kira.png') center/contain no-repeat;
            opacity: 0;
            animation: sparkle-pop 0.9s ease-out;
        }
    </style>
</head>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F2G9BX4FBF');
</script>
<body>
    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <div class="title">è¬ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰è„±å‡ºã›ã‚ˆ</div>
            <div style="margin:12px 0; text-align:center;">
                <a href="escape5_hint.html" target="_blank" style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    ğŸ” ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
                </a>
            </div>
        </div>
        <div class="room-view" id="roomView">
            <!-- ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã¯å‹•çš„ã«ç”Ÿæˆ -->
              <img id="roomImage" src="">
              
        </div> 
        <div id="endingShareArea" style="display:none;">
            <div style="font-size:1.4em; font-weight:bold; margin-bottom:8px;color:#2c1810;">ğŸ‰ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼ğŸ‰</div>
            <button onclick="shareOnTwitter()">Xã§ã‚·ã‚§ã‚¢</button>
            <button onclick="copyShareText()">ã‚¯ãƒªã‚¢å ±å‘Šã‚’ã‚³ãƒ”ãƒ¼</button>
            <div style="font-size:0.9em; margin-top:6px; color:#555;">#è„±å‡ºã‚²ãƒ¼ãƒ  #è‡ªä½œã‚²ãƒ¼ãƒ </div>
        </div>
        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    æ°—ãŒä»˜ãã¨ã‚ãªãŸã¯å¤ã„ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã«ç«‹ã£ã¦ã„ã¾ã—ãŸã€‚ç„é–¢ãƒ‰ã‚¢ã¯ã‚«ã‚®ãŒã‹ã‹ã£ã¦ã„ã¦å‡ºã‚‰ã‚Œã¾ã›ã‚“
                </div>
                <div class="navigation">
                    
                </div> 
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
            ğŸ”Š BGM
            </button> 
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">ã‚»ãƒ¼ãƒ–</button>
                <button class="nav-btn" onclick="loadGame()">ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
        <div class="notice">å½“ã‚µã‚¤ãƒˆã¯OtoLogicã®ç´ æã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ ä½œè€…:<a href="index.html">ã‚¹ãƒ©ã‚»ãƒ–ãƒ³</a></div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã¯å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>
    <audio id="bgm" src="sounds/sinpi no kyuuden.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-subclear" src="sounds/5/Onoma-Syakiin02-1(Dry).mp3"></audio>
    <audio id="se-clear" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-gasha" src="sounds/5/Motion-Grab07-1(Dry).mp3"></audio>
    <audio id="se-box" src="sounds/Retro_Anime-Switch02-1(Mid).mp3"></audio>
    <audio id="se-person" src="sounds/Short_Accent04-1(Single).mp3"></audio>
    <audio id="se-ban" src="sounds/5/Retro_Anime-Robot10-1(High).mp3"></audio>
    <audio id="se-register" src="sounds/5/Cash_Register-Drawer02-1(Low).mp3"></audio>
    <script>
        window._nextModal = null;
        // ã‚²ãƒ¼ãƒ è¨­å®š - ç”»åƒãƒ‘ã‚¹ã‚’ã“ã“ã§ç®¡ç†
        let IMAGES = {
            rooms: {
                entrance: [
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/entrance.png',          // backgroundState = 0
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/entrance2.png',         // backgroundState = 1
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/entrance3.png',         // backgroundState = 2
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/entrance4.png',         // backgroundState = 3
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/entrance5.png',         // backgroundState = 4
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/entrance6.png',         // backgroundState = 5
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/entrance7.png',         // backgroundState = 6
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/entrance8.png',         // backgroundState = 7
                ],
                dining: [
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/dining.png',             // backgroundState = 0
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/dining2.png',            // backgroundState = 1
                ],
                kitchen: [
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/kitchen.jpg',           // backgroundState = 0
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/kitchen2.png',          // backgroundState = 1
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/kitchen3.png',          // backgroundState = 2
                ],
                restroom: [
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/restroom.png',           // backgroundState = 0
                    'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/restroom2.png',          // backgroundState = 1
                ],
                
                end: ['https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/end.jpg'],
                bearEnd: ['https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/bearEnd.jpg'],
            },
            items: {
                wine: 'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/wine.png',
                wine2: 'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/wine2.png',
                bluebear: 'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/bluebear.png',
                raspberry: 'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/raspberry.png',
                takeout: 'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/takeout.jpg',
                takeout2: 'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/takeout2.jpg',
            }
        };

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        const SAVE_KEY = 'escapeGameState5';

        let gameState = {
            currentRoom: 'entrance',
            openRooms:  ['entrance', 'dining', 'kitchen', 'restroom'], 
            inventory: [],
            entrance: {
                flags: {
                    backgroundState:0,
                    entrancePuzzleSolved: false,
                }
            },
            dining: {
                flags: {
                    foundWine: false,
                    watchNewspaper: false,  
                    backgroundState:0,
                }
            },
            kitchen: {
                flags: {
                    backgroundState: 0,
                    getRaspberry: false,
                }
            },
            restroom: {
                flags: {
                    backgroundState:0,
                }
            },
            flags: {
                
            },
            selectedItem: null
        };

        // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿
        let rooms = {
            entrance: {
                name: 'ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹',
                description: 'å¤ã³ãŸãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ã ',
                clickableAreas: [
                    {
                        x: 5.2, y: 23.5, width: 23.1, height: 56.6,
                        action: 'examine_entrance_door',
                        description: 'ãƒ‰ã‚¢',
                        zIndex:1
                    },
                    {
                        x: 54.7, y: 33.1, width: 4.5, height: 3.8,
                        action: 'examine_entrance_yellow',
                        description: 'é»„è‰²ã„ãƒ©ã‚¤ãƒˆ',
                        zIndex:5
                    },
                    {
                        x: 62.5, y: 31.3, width: 4.9, height: 3.8,
                        action: 'examine_entrance_black',
                        description: 'é»’ã„ãƒ©ã‚¤ãƒˆ'
                    },
                    {
                        x: 71, y: 29.4, width: 4.5, height: 4.5,
                        action: 'examine_entrance_green',
                        description: 'ç·‘ã®ãƒ©ã‚¤ãƒˆ'
                    },
                    {
                        x: 55, y: 59, width: 18, height: 5,
                        action: 'examine_entrance_sign',
                        description: 'å—ä»˜'
                    },
                    {
                        x: 88.2, y: 33, width: 10.5, height: 14.8,
                        action: 'examine_entrance_picture',
                        description: 'çµµç”»'
                    },
                    {
                        x: 47, y: 39.4, width: 11.4, height: 13.5,
                        action: 'examine_entrance_greenpot',
                        description: 'è¦³è‘‰æ¤ç‰©'
                    },
                    {
                        x: 59.3, y: 50, width: 10.5, height: 3.3,
                        action: 'examine_entrance_pc',
                        description: 'ç«¯æœ«'
                    }
                ]
            },
            dining: {
                name: 'å®¢å¸­',
                description: 'ã‹ã¤ã¦ã¯ã«ãã‚ã£ã¦ã„ãŸã®ã ã‚ã†ã‹',
                clickableAreas: [
                    {
                        x: 12.7, y: 29.7, width: 12.1, height: 23,
                        action: 'examine_dining_pic',
                        description: 'å¤ã„è‚–åƒç”»'
                    },
                    {
                        x: 15.6, y: 54.5, width: 7.9, height: 4.2,
                        action: 'examine_dining_pic_detail',
                        description: 'èª¬æ˜æ›¸ã'
                    },
                    {
                        x: 87.9, y: 63.3, width: 8.6, height: 7.9,
                        action: 'examine_dining_right_wine',
                        description: 'ãƒ¯ã‚¤ãƒ³'
                    },
                    {
                        x: 44.9, y: 80.8, width: 8.5, height: 6.5,
                        action: 'examine_dining_newspaper',
                        description: 'å¤ã„æ–°è'
                    }
                ]
            },
            kitchen: {
                name: 'å¨æˆ¿',
                description: 'ãƒ­ãƒœãƒƒãƒˆãŒã„ã‚‹ã€‚èª¿ç†ãƒ­ãƒœã‹ãªï¼Ÿ',
                clickableAreas: [
                    {
                        x: 42.9, y: 32.6, width: 13.6, height: 13.2,
                        action: 'examine_kitchen_robo',
                        description: 'ãƒ­ãƒœãƒƒãƒˆ'
                    },
                    {
                        x: 81.8, y: 45.8, width: 11, height: 10.1,
                        action: 'examine_kitchen_flypan',
                        description: 'ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³'
                    },
                    {
                        x: 53.7, y: 54.0, width: 6, height: 2.3,
                        action: 'examine_kitchen_robo_ingicator',
                        description: 'ãƒ­ãƒœãƒƒãƒˆã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼'
                    }
                ]
            },
            restroom: {
                name: 'åŒ–ç²§å®¤',
                description: 'æ¸…æ½”æ„ŸãŒã‚ã‚‹',
                clickableAreas: [
                    {
                        x: 30.9, y: 44.5, width: 9.2, height: 10.6,
                        action: 'examine_restroom_paper',
                        description: 'ãŠæ‰‹æ‹­ãã®ç´™'
                    },
                    {
                        x: 58, y: 57, width: 9.9, height: 20.7,
                        action: 'examine_restroom_bear',
                        description: 'ã‚¯ãƒã®å¦–ç²¾',
                        zIndex:5,
                        usable: () => !!gameState.restroom.flags.backgroundState>0,
                    },
                    {
                        x: 23.1, y: 23.4, width: 8.0, height: 7.7,
                        action: 'examine_restroom_light',
                        description: 'ç…§æ˜',
                    }
                ]
            },
            end: {
                name: 'å¤–ã®ä¸–ç•Œã¸ãƒ«ãƒ¼ãƒˆ',
                description: 'ã‚ãªãŸã¯ç„¡äº‹è„±å‡ºã§ãã¾ã—ãŸã€‚ãŠã†ã¡ã«å¸°ã£ã¦ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã‚’é£Ÿã¹ã‚ˆã†',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_end',
                        description: 'å¤–ã®ä¸–ç•Œ'
                    },
                ]
            },
            bearEnd: {
                name: 'è¦–ç·šã‚’æ„Ÿã˜ã‚‹ã¸ãƒ«ãƒ¼ãƒˆ',
                description: 'ã‚ãªãŸã¯ã‚¯ãƒã®å¦–ç²¾ã‚’çŠ ç‰²ã«ã—ã¦ã€å¤–ã«å‡ºãŸã€‚ãã‚Œä»¥é™ã€ã‚ãªãŸã¯ä½•ã‹ã®è¦–ç·šã‚’æ„Ÿã˜ã‚‹ã‚ˆã†ã«ãªã£ãŸâ€¦',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_bear_end',
                        description: 'ã‚¯ãƒå¦–ç²¾ã®è¦–ç·š'
                    },
                ]
            }
        };

        const hintMessages = {
            restroom: {
                bear: [
                "å‘¼ã‚“ã ï¼Ÿ",
                "æ˜”ã¯ã“ã“ã®ãŠæ–™ç†ã€ãƒ™ãƒªãƒ¼ã‚°ãƒƒãƒ‰ã ã£ãŸã‚“ã ã£ã¦",
                "ãƒœã‚¯ã‚‚é£Ÿã¹ã¦ã¿ãŸã‹ã£ãŸãª",
                "ãƒ‰ãƒ¼ãƒ”ãƒ³ã‚°é¨’ããŒã‚ã£ã¦ã€å¯‚ã‚Œã¡ã‚ƒã£ãŸã‚“ã ã£ã¦"
                ]
            },
        };

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            renderNavigation();
            changeRoom('entrance', gameState.entrance.flags.backgroundState);
            updateMessage('æ°—ãŒä»˜ãã¨ã‚ãªãŸã¯å¤ã„ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã«ç«‹ã£ã¦ã„ã¾ã—ãŸã€‚ç„é–¢ãƒ‰ã‚¢ã¯ã‚«ã‚®ãŒã‹ã‹ã£ã¦ã„ã¦å‡ºã‚‰ã‚Œã¾ã›ã‚“');
        }

        // éƒ¨å±‹ã‚’å¤‰æ›´
        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${getRoomBackgroundImage(roomId, gameState)})`;
            
            // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã‚’ç”Ÿæˆ
            generateClickableAreas(room);
            updateMessage(`${room.name}ã«å…¥ã‚Šã¾ã—ãŸã€‚${room.description}`);

            // BGMåˆ‡æ›¿
            if (roomId === "end") {
                changeBGM("sounds/5/Someday in the Rain.mp3");
            } else if (roomId === "bearEnd") {
                changeBGM("sounds/3/heisarenai.mp3");
            } else {
                changeBGM("sounds/5/PiecesofaDream.mp3");
            }
        }

        function getRoomBackgroundImage(roomId, gameState) {
            let state = gameState[roomId]?.flags?.backgroundState || 0;
            let imgList = IMAGES.rooms[roomId];
            if (Array.isArray(imgList)) {
                return imgList[state] || imgList[0];
            } else {
                return imgList;
            }
        }

        // èƒŒæ™¯ç”»åƒã‚’å·®ã—æ›¿ãˆ
        function changeRoomImage(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            // èƒŒæ™¯ç”»åƒã‚’è¨­å®šï¼ˆç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${getRoomBackgroundImage(roomId, gameState)})`;
            generateClickableAreas(room);
        }

        // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã‚’ç”Ÿæˆ
        // 
        function generateClickableAreas(room) {
            const roomView = document.getElementById('roomView');
            roomView.innerHTML = ''
            room.clickableAreas.forEach(area => {
                const clickableDiv = document.createElement('div');
                clickableDiv.className = 'clickable-area';
                clickableDiv.style.left   = (area.x) + '%';
                clickableDiv.style.top    = (area.y) + '%';
                clickableDiv.style.width  = (area.width) + '%';
                clickableDiv.style.height = (area.height) + '%';
                clickableDiv.style.position = 'absolute';
                clickableDiv.style.zIndex = area.zIndex || 1;
                const usable = (typeof area.usable === 'function') ? area.usable() :
                         (typeof area.usable === 'boolean') ? area.usable : true;
                clickableDiv.style.display = usable ? 'block' : 'none';
                clickableDiv.onclick = (event) => handleAreaClick(area.action,event);
                clickableDiv.title = area.description;

                roomView.appendChild(clickableDiv);
            });
        }

        // ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleAreaClick(action, event) {
            switch(action) {
                case 'examine_entrance_door':
                    console.log(gameState.entrance.flags.backgroundState);
                    console.log(gameState.entrance.flags.entrancePuzzleSolved);
                    if (gameState.entrance.flags.entrancePuzzleSolved && gameState.entrance.flags.backgroundState==6) {
                        updateMessage('ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢');
                        changeRoom('end');
                    } else if (gameState.entrance.flags.entrancePuzzleSolved && gameState.entrance.flags.backgroundState==7) {
                        updateMessage('ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢');
                        changeRoom('bearEnd');
                    } else {
                        updateMessage('ç„é–¢ãƒ‰ã‚¢ã«ã¯ãƒ­ãƒƒã‚¯ãŒã‹ã‹ã£ã¦ã„ã‚‹');
                    }
                     break;
                case 'examine_entrance_yellow':
                    updateMessage('é»„è‰²ã„ãƒ©ã‚¤ãƒˆã ');
                    break;
                case 'examine_entrance_black':
                    updateMessage('é»’ã„ãƒ©ã‚¤ãƒˆã ');
                    break;
                case 'examine_entrance_green':
                    updateMessage('ç·‘ã®ãƒ©ã‚¤ãƒˆã ');
                    break;
                case 'examine_entrance_sign':
                    if (gameState.entrance.flags.backgroundState==0) {
                        updateMessage('å—ä»˜â€¦ï¼Ÿãªã‚“ã‹é•å’Œæ„ŸãŒã‚ã‚‹ãª');
                    } else {
                        updateMessage('å—ä»˜ã ');
                    }
                    break;
                case 'examine_entrance_picture':
                    if (gameState.entrance.flags.backgroundState<2) {
                        if (gameState.selectedItem=='raspberry') {
                            gameState.entrance.flags.backgroundState = 2;
                            removeItem('raspberry');
                            changeRoomImage('entrance');
                            updateMessage('ãƒ©ã‚ºãƒ™ãƒªãƒ¼ã‚’ãƒã‚¹ã‚¿ãƒ¼ã«è¿½åŠ ã—ãŸã€‚åç‰©æ–™ç†ã‚’è¡¨ç¾ã—ã¦ã„ãŸã‚“ã ã­');
                            showSparkleEffectAt(event.clientX, event.clientY);
                        } else {
                            updateMessage('è±šãŒæã‹ã‚ŒãŸãƒã‚¹ã‚¿ãƒ¼ã ');
                        }
                        
                    } else if (gameState.entrance.flags.backgroundState==2 && gameState.selectedItem=='wine'){
                        gameState.entrance.flags.backgroundState = 3;
                        changeRoomImage('entrance');
                        updateMessage('ãƒ©ã‚ºãƒ™ãƒªãƒ¼ã«èµ¤è‰²æˆåˆ†ãŒç§»å‹•ã—ã¦å®Œç†Ÿãƒ©ã‚ºãƒ™ãƒªãƒ¼ã«ãªã£ãŸã€‚é’ã„ãƒ¯ã‚¤ãƒ³ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');
                        removeItem('wine');
                        addItem('wine2');
                        showSparkleEffectAt(event.clientX, event.clientY);
                    }else {
                        updateMessage('ã“ã®åº—ã®åç‰©æ–™ç†ã‚’è¡¨ç¾ã—ãŸãƒã‚¹ã‚¿ãƒ¼ã ');
                    }
                    break;
                case 'examine_entrance_greenpot':
                    if (gameState.entrance.flags.backgroundState==3 && gameState.selectedItem=='wine2') {
                        gameState.entrance.flags.backgroundState = 4;
                        changeRoomImage('entrance');
                        removeItem('wine2');
                        playSE('se-gasha');
                        updateMessage('è¦³è‘‰æ¤ç‰©ãŒçœŸã£é’ã«ãªã£ãŸï¼äº”è¼ªã‚«ãƒ©ãƒ¼ãŒå®Œæˆã—ãŸãã€‚ã©ã“ã‹ã§ç‰©éŸ³ãŒã—ãŸã‚ˆã†ã ');
                        showSparkleEffectAt(event.clientX, event.clientY);
                        gameState.dining.flags.backgroundState = 1;
                    } else if (gameState.entrance.flags.backgroundState==3 && gameState.selectedItem=='bluebear') {
                        gameState.entrance.flags.backgroundState = 5;
                        changeRoomImage('entrance');
                        removeItem('bluebear');
                        playSE('se-gasha');
                        updateMessage('ã¨ã‚Šã‚ãˆãšäº”è¼ªã‚«ãƒ©ãƒ¼ãŒå®Œæˆã—ãŸãã€‚ã©ã“ã‹ã§ç‰©éŸ³ãŒã—ãŸã‚ˆã†ã ');
                        gameState.dining.flags.backgroundState = 1;
                    } else if (gameState.entrance.flags.backgroundState==4 || gameState.entrance.flags.backgroundState==6) {
                        updateMessage('é’ã€…ã¨ã—ãŸæ¤ç‰©ã ');
                    } else if (gameState.entrance.flags.backgroundState==5 || gameState.entrance.flags.backgroundState==7) {
                        updateMessage('é’ã„ã‚¯ãƒå¦–ç²¾ã¯æ‚²ã—ã’ãªæ§˜å­ã®ã¾ã¾å‹•ã‹ãªã„');
                    } else {
                        updateMessage('è¦³è‘‰æ¤ç‰©ã¯è‰²ã¤ã‚„ãŒæ‚ªã„â€¦');
                    }
                    break;
                case 'examine_entrance_pc':
                    if (gameState.entrance.flags.backgroundState>3 && !gameState.entrance.flags.entrancePuzzleSolved) {
                        updateMessage('ä½¿ãˆã‚‹ã‚ˆã†ã ');
                        showEntrancePuzzle();
                    } else if (gameState.entrance.flags.backgroundState>3 && gameState.entrance.flags.entrancePuzzleSolved) {
                        updateMessage('ã‚‚ã†ç”¨ã¯ãªã„ãª');
                    } else if (gameState.kitchen.flags.backgroundState>1 && !gameState.entrance.flags.entrancePuzzleSolved) {
                        updateMessage('ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹');
                    } else {
                        updateMessage('å—ä»˜ç«¯æœ«ã ã€‚é›»æºãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚åå¿œãŒãªã„');
                    }
                    break;
                // living
                case 'examine_dining_pic':
                    if (gameState.entrance.flags.backgroundState==4 || gameState.entrance.flags.backgroundState==6) {
                        showModal(
                            'åˆä»£ã‚ªãƒ¼ãƒŠãƒ¼ã®è‚–åƒç”»ã®ã‚ˆã†ã ã€‚ã•ã£ãã¾ã§ã¨å°è±¡ãŒå¤‰ã‚ã£ãŸï¼Ÿ',
                            '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/picture2.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );
                    } else if (gameState.entrance.flags.backgroundState==5 || gameState.entrance.flags.backgroundState==7) {
                        showModal(
                            'åˆä»£ã‚ªãƒ¼ãƒŠãƒ¼ã®è‚–åƒç”»ã®ã‚ˆã†ã ã€‚ã•ã£ãã¾ã§ã¨å°è±¡ãŒå¤‰ã‚ã£ãŸï¼Ÿ',
                            '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/picture3.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );
                    } else {
                        showModal(
                            'åˆä»£ã‚ªãƒ¼ãƒŠãƒ¼ã®è‚–åƒç”»ã®ã‚ˆã†ã ã€‚',
                            '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/picture.png" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );
                    } 
                    break;
                case 'examine_dining_pic_detail':
                    showModal(
                        'èª¬æ˜æ›¸ãã ã€‚',
                        '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/pic_detail.png" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                    );
                    break;   
                case 'examine_dining_right_wine':
                    if (gameState.dining.flags.foundWine && (hasItem('wine') || hasItem('wine2'))) {
                        updateMessage('ãƒ¯ã‚¤ãƒ³ã®ç“¶ã¨ã‚°ãƒ©ã‚¹ãŒã‚ã‚‹');
                    } else {
                        gameState.dining.flags.foundWine = true;
                        updateMessage('ãƒ¯ã‚¤ãƒ³ã‚’ã¿ã¤ã‘ãŸ');
                        showModal(
                            'ãƒ¯ã‚¤ãƒ³ã‚’è¦‹ã¤ã‘ãŸã€‚',
                            '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/wine.png" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );  
                        addItem('wine');
                    }
                    break;
                case 'examine_dining_newspaper':
                    showModal(
                        'å¤ã„æ–°èè¨˜äº‹ã ã€‚ã“ã®åº—ã¯äº”è¼ªé¸æ‰‹ã«äººæ°—ã ã£ãŸã‚‰ã—ã„<br>åç‰©æ–™ç†ã®éƒ¨åˆ†ã¯èª­ã‚ãªã„',
                         '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/newspaper.png" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                    );
                    break; 
                
                
                // kitchen
                case 'examine_kitchen_robo':
                    if (gameState.kitchen.flags.backgroundState==0) {
                        showRoboPuzzle1();
                    }
                    else if(gameState.kitchen.flags.backgroundState==1){
                        showRoboPuzzle2();
                    } else {
                        if (gameState.kitchen.getRaspberry) {
                            updateMessage('ãƒ”â€¦ãƒ”ã€‚æœ¬ä½“ã®ã‚¨ãƒŠã‚¸ãƒ¼90%å……å¡«æ¸ˆã€‚ç¾åœ¨ã€æœ¬ãƒœãƒ‡ã‚£ã‹ã‚‰å„ç«¯æœ«ã¸ã®çµ¦é›»ã‚’è¡Œã£ã¦ã„ã¾ã™');
                        } else {
                            updateMessage('ãƒ”â€¦ãƒ”ã€‚ã‚¨ãƒŠã‚¸ãƒ¼å……å¡«ãƒ¬ãƒ™ãƒ«3ã€‚ã“ã‚Œã‚’å·®ã—ä¸Šã’ã¾ã™');
                            showModal(
                                'ãƒ­ãƒœãƒƒãƒˆã‹ã‚‰ãƒ©ã‚ºãƒ™ãƒªãƒ¼ã‚’ã‚‚ã‚‰ã£ãŸã€‚',
                                '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/raspberry.png" style="width:300px;display:block;margin:0 auto 20px;">',
                                [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                            );  
                            addItem('raspberry');
                            gameState.kitchen.getRaspberry = true;
                        }
                    }
                    break;
                case 'examine_kitchen_flypan':
                    updateMessage('ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³ãŒã‚ã‚‹');
                    break; 
                case 'examine_kitchen_robo_ingicator':
                    updateMessage('ä½•ã‹ã®é‡ã‚’ç¤ºã—ã¦ã„ã‚‹ã‚ˆã†ã ');
                    break; 
                // restroom
                case 'examine_restroom_paper':
                    updateMessage('ç´™åˆ‡ã‚ŒãŒæŒŸã¾ã£ã¦ã„ã‚‹');    
                        showModal(
                            'ç´™åˆ‡ã‚ŒãŒæŒŸã¾ã£ã¦ã„ã‚‹',
                            '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/olympic.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );  
                    break; 
                case 'examine_restroom_bear': 
                    if (gameState.selectedItem=='wine') {
                        updateMessage('ã‚ãªãŸã¯é…”ã£æ‰•ã£ãŸã‚¯ãƒã®å¦–ç²¾ã«ã‚¯ãƒãƒ“ãƒ¼ãƒ ã‚’æ‰“ãŸã‚Œã¦æ­»ã‚“ã§ã—ã¾ã£ãŸ'); 
                        playSE('se-ban');   
                        showModal(
                            'ã€ãƒãƒƒãƒ‰ã‚¨ãƒ³ãƒ‰ã€‘<br>ã‚ãªãŸã¯é…”ã£æ‰•ã£ãŸã‚¯ãƒã®å¦–ç²¾ã«ã‚¯ãƒãƒ“ãƒ¼ãƒ ã‚’æ‰“ãŸã‚Œã¦æ­»ã‚“ã§ã—ã¾ã£ãŸ',
                            '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/badend.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'restart'}]
                        );  

                    } else if (gameState.selectedItem=='raspberry') {
                        updateMessage('ãƒœã‚¯ãŠè…¹ã™ã„ã¦ãªã„ã‚‚ã‚“'); 
                    } else if (gameState.selectedItem=='wine2') {
                        addItem('bluebear'); 
                        removeItem('wine2');
                        gameState.restroom.flags.backgroundState=0;
                        changeRoom('restroom');
                        updateMessage('é’ã„ã‚¯ãƒå¦–ç²¾ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');  
                    } else if (gameState.selectedItem=='takeout') {
                        updateMessage('â€¦å¤‰ãªã‚¯ãƒã«ã‚„ã‚‹ã®ã¯æƒœã—ã„ã€‚å®¶ã«å¸°ã£ã¦é£Ÿã¹ã‚ˆã†'); 
                    } else {
                        talkToHintCharacter('restroom','bear');
                    }
                    break;  
                case 'examine_restroom_light':
                    updateMessage('ã¼ã‚“ã‚„ã‚Šã¨å¯‚ã—æ°—ãªç¯ã‚Šã ');
                    break; 
                case 'examine_end':
                    updateMessage('ã‚ãªãŸã¯å¤–ã¸ã¨è¶³ã‚’è¸ã¿å‡ºã—ã¾ã—ãŸã€‚ï¼ˆãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰ï¼‰');
                    break; 
                case 'examine_bear_end':
                    updateMessage('ã‚ãªãŸã¯ä½•ã‹ã®è¦–ç·šã‚’æ„Ÿã˜ã¤ã¤ã‚‚å¹¸ã›ã«æš®ã‚‰ã—ã¾ã—ãŸã€‚ï¼ˆãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰2ï¼‰');
                    break; 
            }
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;

            playSE('se-click');
            updateInventoryDisplay();
        }

        function talkToHintCharacter(roomId, charId) {
            // flagså–å¾—
            let flags = gameState[roomId].flags;
            // ã¾ã ã‚«ã‚¦ãƒ³ãƒˆç„¡ã‘ã‚Œã°åˆæœŸåŒ–
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
            flags.talkTo[charId]++;

            // ã‚»ãƒªãƒ•ãƒªã‚¹ãƒˆå–å¾—
            const messages = hintMessages[roomId][charId];
            // ç¯„å›²å¤–ãªã‚‰æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const idx = (flags.talkTo[charId] - 1) % messages.length;

            // è¡¨ç¤º
            updateMessage(messages[idx]);
        }

        // ç„é–¢ãƒ‘ã‚ºãƒ«ã‚’è¡¨ç¤º
        function showEntrancePuzzle() {
            const modalContent = `
                <h3>å…¥åŠ›ãƒ‘ãƒãƒ«</h3>
                <p>ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
                <input type="text" class="puzzle-input" id="entranceInput" placeholder="ã‚«ãƒƒã‚³ã¯ä¸è¦">
                <br>
                <button onclick="checkEntrancePuzzle()">ç¢ºèª</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ç„é–¢ãƒ‘ã‚ºãƒ«ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkEntrancePuzzle() {
            const input = document.getElementById('entranceInput').value;
            if (gameState.entrance.flags.backgroundState==4 && (input === 'TOGO' || input === 'togo')) {
                closeModal();
                updateMessage('ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆå¼å½“ã‚’æ‰‹ã«å…¥ã‚ŒãŸã€‚ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸã‚ˆã†ãªéŸ³ãŒã—ãŸ');
                addItem('takeout');
                playSE('se-register');
                showModal(
                    'ã€ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€<br>ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆå¼å½“ã‚’æ‰‹ã«å…¥ã‚ŒãŸ',
                    '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/takeout.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                );
                gameState.entrance.flags.entrancePuzzleSolved = true;
                gameState.entrance.flags.backgroundState = 6;
                changeRoomImage('entrance');

            } else if (gameState.entrance.flags.backgroundState==5 && (input === 'DONUTS'|| input === 'donuts')) {
                closeModal();
                updateMessage('ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã‚’æ‰‹ã«å…¥ã‚ŒãŸã€‚ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸã‚ˆã†ãªéŸ³ãŒã—ãŸ');
                addItem('takeout2');
                playSE('se-register');
                showModal(
                    'ã€ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€<br>ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆBOXã‚’æ‰‹ã«å…¥ã‚ŒãŸ',
                    '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/takeout2.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                );
                gameState.entrance.flags.entrancePuzzleSolved = true;
                gameState.entrance.flags.backgroundState = 7;
                changeRoomImage('entrance');

            } else {
                playSE('se-error');
                updateMessage('ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            }
        }

        // ãƒ­ãƒœã‚¯ã‚¤ã‚º1ã‚’è¡¨ç¤º
        function showRoboPuzzle1() {
            const modalContent = `
                <h3>ãƒ”ãƒ”â€¦ãƒ”ã€‚è¶³ã‚Šãªã„â€¦è¶³ã‚Šãªã„â€¦</h3>
                <p>ä½•ãŒè¶³ã‚Šãªã„ï¼Ÿ</p>
                <input type="text" class="puzzle-input" id="roboInput1" placeholder="1æ–‡å­—ã§å›ç­”">
                <br>
                <button onclick="checkRoboPuzzle1()">ç¢ºèª</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex'; 
        }

        // ãƒ­ãƒœã‚¯ã‚¤ã‚º1ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkRoboPuzzle1() {
            const input = document.getElementById('roboInput1').value;
            if (input === 'T' || input === 't'|| input === 'ï½”'|| input === 'ï¼´') {
                closeModal();
                updateMessage('ãƒ”â€¦ï¼ãã†ã§ã™ã€‚ã‚¨ãƒŠã‚¸ãƒ¼å……å¡«â€¦');
                playSE('se-subclear');
                showModal(
                    'ãƒ”â€¦ï¼ãã†ã§ã™ã€‚ã‚¨ãƒŠã‚¸ãƒ¼å……å¡«â€¦',
                    '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/roboenergy.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                );
                gameState.restroom.flags.backgroundState = 1;
                gameState.kitchen.flags.backgroundState = 1;
                gameState.entrance.flags.backgroundState = 1;
                changeRoomImage('restroom');
                changeRoomImage('entrance');
                changeRoomImage('kitchen');

            } else {
                playSE('se-error');
                updateMessage('é•ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã¦ãã ã•ã„ã€‚');
            }
        }

        // ãƒ­ãƒœã‚¯ã‚¤ã‚º2ã‚’è¡¨ç¤º
        function showRoboPuzzle2() {
            const modalContent = `
                <h3>ãƒ”ãƒ”â€¦ãƒ”ã€‚ã§ãƒ¼ãŸãƒ­ã‚¹ãƒˆâ€¦å½“åº—åç‰©â€¦ãƒãƒ¼â€¦</h3>
                <p>åç‰©ã«ã¯ä½•ã®ã‚½ãƒ¼ã‚¹ãŒæ·»ãˆã‚‰ã‚Œã¦ã„ãŸï¼Ÿ</p>
                <input type="text" class="puzzle-input" id="roboInput2" placeholder="æ—¥æœ¬èªã§å›ç­”">
                <br>
                <button onclick="checkRoboPuzzle2()">ç¢ºèª</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ãƒ­ãƒœã‚¯ã‚¤ã‚º2ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkRoboPuzzle2() {
            const input = document.getElementById('roboInput2').value;
            if (input === 'ãƒ©ã‚ºãƒ™ãƒªãƒ¼' || input === 'ã‚‰ãšã¹ã‚Šãƒ¼') {
                closeModal();
                updateMessage('ãƒ”ãƒ”ãƒ”â€¦ï¼ãã†ã§ã™ã€‚ã‚¨ãƒŠã‚¸ãƒ¼å……å¡«â€¦');
                playSE('se-subclear');
                showModal(
                    'ãƒ”ãƒ”ãƒ”â€¦ï¼ãã†ã§ã™ã€‚ã‚¨ãƒŠã‚¸ãƒ¼å……å¡«â€¦',
                    '<img src="https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/roboenergy.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                );
                gameState.kitchen.flags.backgroundState = 2;
                changeRoomImage('kitchen');

            } else {
                playSE('se-error');
                updateMessage('é•ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã¦ãã ã•ã„ã€‚');
            }
        }
 
        // ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 5) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }
            
        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}ã‚’é¸æŠã—ã¾ã—ãŸã€‚ä½¿ç”¨ã—ãŸã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay(); 
            }
        }

        function getItemName(itemId) {
            const names = {
                raspberry: 'ãƒ©ã‚ºãƒ™ãƒªãƒ¼',
                wine: 'ãƒ¯ã‚¤ãƒ³',
                wine2: 'é’ã„ãƒ¯ã‚¤ãƒ³',
                bluebear: 'é’ã„ã‚¯ãƒå¦–ç²¾',
                takeout: 'åç‰©æ–™ç†ã®ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ',
                takeout2: 'ã‚¯ãƒãƒ‰ãƒ¼ãƒŠãƒ„ã®ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ',
            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;
                btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªè¡¨ç¤ºæ›´æ–°
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function() {
                        // ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                }
                // â˜…é¸æŠä¸­ãªã‚‰selectedã‚¯ãƒ©ã‚¹è¿½åŠ 
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
        function updateMessage(message) {
            document.getElementById('messageArea').innerHTML = message;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(title, content, buttons) {
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            buttons.forEach(button => {
                modalHtml += `<button onclick="${button.action === 'close' ? 'closeModal' : button.action === 'restart' ? 'restartGame()' : button.action}()">${button.text}</button>`;
            });
            
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        // function closeModal() {
        //     document.getElementById('modal').style.display = 'none';
        // }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // æ¬¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
            if (window._nextModal) {
                // ç™»éŒ²å†…å®¹ã¯ {title, content, buttons, after} ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                let modal = window._nextModal;
                window._nextModal = null; // ã‚¯ãƒªã‚¢
                if (modal.before) modal.before(); // ã‚‚ã—playSEãªã©äº‹å‰å‡¦ç†ã—ãŸã‘ã‚Œã°
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after(); // ã‚‚ã—showModalç›´å¾Œã«ã‚„ã‚ŠãŸã„ã“ã¨ã‚ã‚Œã°
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
        function restartGame() {
            gameState = {
                currentRoom: 'entrance',
                openRooms:  ['entrance', 'dining', 'kitchen', 'restroom'], 
                inventory: [],
                entrance: {
                    flags: {
                        backgroundState:0,
                        entrancePuzzleSolved: false,
                    }
                },
                dining: {
                    flags: {
                        foundWine: false,
                        watchNewspaper: false,  
                        backgroundState:0,
                    }
                },
                kitchen: {
                    flags: {
                        backgroundState: 0,
                        getRaspberry: false,
                    }
                },
                restroom: {
                    flags: {
                        backgroundState:0,
                    }
                },
                flags: {
                    
                },
                selectedItem: null
            };
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;   // â†ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å†ç”Ÿã—ã¦ãªã„
        let isBGMInitialized = false; // åˆå›ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç”¨

        // åˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã ã‘BGMã‚’å†ç”Ÿ
        function initBGMOnce() {
        if (!isBGMInitialized) {
            const bgm = document.getElementById('bgm');
            bgm.volume = 0.3;
            bgm.play();
            isBGMPlaying = true;
            isBGMInitialized = true;
            document.getElementById('bgm-toggle').textContent = "ğŸ”Š BGM";
        }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "ğŸ”Š BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "ğŸ”‡ BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ã§æ¯”è¼ƒ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            console.log(current + ":" + next);
            if (current === next) return; // ã™ã§ã«ãã®BGMãªã‚‰ä½•ã‚‚ã—ãªã„

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // ã©ã“ã‹ã§æœ€åˆã«ä¸€åº¦ã ã‘å‘¼ã¶
        function preloadImages() {
            // éƒ¨å±‹ç”»åƒå…¨éƒ¨
            Object.values(IMAGES.rooms).forEach(val => {
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        const img = new Image();
                        img.src = src;
                    });
                } else if (typeof val === "string") {
                    const img = new Image();
                    img.src = val;
                }
            });
            // ã‚¢ã‚¤ãƒ†ãƒ ç”»åƒ
            Object.values(IMAGES.items).forEach(src => {
                const img = new Image();
                img.src = src;
            });
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒ â† è¿½åŠ 
            [
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/picture2.jpg',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/picture3.jpg',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/pic_detail.png',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/wine.png',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/newspaper.png',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/olympic.jpg',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/badend.jpg',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/bearEnd.jpg',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/end.jpg',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/takeout.jpg',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/takeout2.jpg',
                'https://pub-40dbb77d211c4285aa9d00400f68651b.r2.dev/images/5/roboenergy.jpg',
                // ...å¿…è¦ãªã ã‘è¿½åŠ 
            ].forEach(src => {
                const img = new Image(); img.src = src;
            });
        }

        function showSparkleEffectAt(x, y) {
            const roomView = document.getElementById('roomView');
            const rect = roomView.getBoundingClientRect();

            // çµ¶å¯¾ä½ç½® â†’ roomViewå†…ã®ç›¸å¯¾åº§æ¨™ï¼ˆ%ã§ã‚‚pxã§ã‚‚OKï¼‰
            const sparkleSize = 180; // .sparkle-effect ã®width/heightã¨åˆã‚ã›ã‚‹
            const left = x - rect.left - sparkleSize / 2;
            const top = y - rect.top - sparkleSize / 2;
            // const left = x - rect.left;
            // const top = y - rect.top;

            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle-effect';
            sparkle.style.left = left + "px";
            sparkle.style.top = top + "px";
            roomView.appendChild(sparkle);

            setTimeout(() => {
                sparkle.remove();
            }, 900);
        }

        function showSparkleEffectAtPercent(xPercent, yPercent) {
            const roomView = document.getElementById('roomView');
            const rect = roomView.getBoundingClientRect();
            const sparkleSize = 180; // CSSã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦
            // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã«æ›ç®—
            const left = rect.width * xPercent / 100 - sparkleSize / 2;
            const top  = rect.height * yPercent / 100 - sparkleSize / 2;

            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle-effect';
            sparkle.style.left = left + "px";
            sparkle.style.top = top + "px";
            roomView.appendChild(sparkle);

            setTimeout(() => {
                sparkle.remove();
            }, 900);
        }

        function shareOnTwitter(resultType) {
            // ä¾‹ï¼šresultType = "true_end" or "normal_end"
            let url = encodeURIComponent(location.href);
            let text;
            if (resultType === "true_end") {
                text = encodeURIComponent("è„±å‡ºã‚²ãƒ¼ãƒ ã€å±‹æ•·ã«æ®‹ã•ã‚ŒãŸå¤¢ã€ã§çœŸã‚¨ãƒ³ãƒ‰é”æˆï¼ #è„±å‡ºã‚²ãƒ¼ãƒ ");
            } else {
                text = encodeURIComponent("è„±å‡ºã‚²ãƒ¼ãƒ ã€å±‹æ•·ã«æ®‹ã•ã‚ŒãŸå¤¢ã€ã‚’ã‚¯ãƒªã‚¢ï¼ #è„±å‡ºã‚²ãƒ¼ãƒ ");
            }
            window.open(`https://x.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }
        function copyShareText() {
            let text = "è„±å‡ºã‚²ãƒ¼ãƒ ã€å±‹æ•·ã«æ®‹ã•ã‚ŒãŸå¤¢ã€ã‚’ã‚¯ãƒªã‚¢ï¼ #è„±å‡ºã‚²ãƒ¼ãƒ  " + location.href;
            navigator.clipboard.writeText(text).then(() => alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'));
        }

        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
            const oldMsg = document.getElementById('messageArea').innerHTML;
            updateMessage('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼');
            setTimeout(() => {
                updateMessage(oldMsg);
            }, 1500);
        }

        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY) || localStorage.getItem('escapeGameState');
            if (saved) {
                gameState = JSON.parse(saved);
                // UIã‚„ç”»é¢ã‚’stateã«åˆã‚ã›ã¦å¾©å…ƒã™ã‚‹
                changeRoom(gameState.currentRoom);
                updateInventoryDisplay();
                renderNavigation();
                updateMessage('ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
            } else {
                updateMessage('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        preloadImages();
        initGame();
    </script>
</body>
</html>
