<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="‰øùËÇ≤ÂÆ§„ÇíËàûÂè∞„Å´„Åó„ÅüÁÑ°Êñô„Ç≤„Éº„É†„ÄÇ„Çπ„Éû„ÉõÔºÜPCÂØæÂøú„ÄÇ">
    <link rel="icon" href="favicon.ico">
    <title>Â∑•Êàø„Åã„Çâ„ÅÆËÑ±Âá∫</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;
            /* ‚Üê„Åì„ÇåÈáçË¶Å */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #gameCanvas {
            position: relative;
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
        }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
            align-items: flex-start;
        }

        .inventory {
            /* flex: 1; */
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 12px;
            /* width:100%; */
            flex-wrap: wrap;
            max-width: 520px;
            margin: 0 auto;
            margin-top: 6px;
        }

        .inventory-slot {
            width: 80px;
            height: 80px;
            max-width: 80px;
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;
            /* ÈáëËâ≤„ÉªÂ§™„ÇÅÊé®Â•® */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .magnifier-btn {
            position: absolute;
            right: 4px;
            bottom: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0002;
            cursor: pointer;
            z-index: 10;
            transition: box-shadow .15s;
        }

        .magnifier-btn:hover {
            box-shadow: 0 0 10px #ffd70099;
        }

        .magnifier-btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .info-panel {
            width: 100%;
            padding: 2px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 8px;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 2px;
            height: 65px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        #msgText {}

        #statusIconArea {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px #0005;
            font-size: 1.4em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            /*  max-width: calc(100vw - 60px); */
            text-align: center;
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            /* ÁîªÈù¢„Å´Âèé„ÇÅ„Çã */
            overflow: auto;
            /* „ÅØ„ÅøÂá∫„Åó„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´ */
            padding: 20px;
            /* „Å°„Çá„ÅÑÂúßÁ∏Æ */
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        #modalButtons button {
            border: none;
            background: none;
            padding: 0;
            margin: 0 10px 10px 0;
            cursor: pointer;
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
            border-radius: 10px;
        }

        #modalButtons button img {
            width: 80px;
            height: 80px;
            vertical-align: middle;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
        }

        #modalButtons button:hover img {
            filter: brightness(1.08) drop-shadow(0 2px 6px #ffd70050);
            box-shadow: 0 0 10px #ffd70080;
            transform: scale(1.05);
        }

        #modalButtons button:active img,
        #modalButtons button.pressed img {
            filter: brightness(0.95) grayscale(20%);
            box-shadow: 0 0 8px #3332;
            transform: scale(0.97);
        }

        #modalButtons button:disabled img {
            filter: grayscale(90%) opacity(0.5);
            box-shadow: none;
        }

        /* „ÉÜ„Ç≠„Çπ„ÉàÂûã„Éú„Çø„É≥„ÇÇÁîªÂÉè„Éú„Çø„É≥È¢®„Å´ */
        #modalButtons button.text-btn {
            min-width: 120px;
            font-size: 1.15em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            margin: 0 10px 10px 0;
            box-shadow: 0 4px 14px #ffc90022;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s, transform 0.08s;
            vertical-align: middle;
            display: inline-block;
        }

        #modalButtons button.text-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
            transform: scale(1.05);
        }

        #modalButtons button.text-btn:active {
            filter: brightness(0.96);
            transform: scale(0.97);
        }

        #modalButtons button.text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Èñâ„Åò„Çã„Éú„Çø„É≥ */
        #modalClose .modal-close-btn {
            display: inline-block;
            min-width: 160px;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            box-shadow: 0 4px 14px #ffc90022;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s;
        }

        #modalClose .modal-close-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
        }

        .modal button.ok-btn {
            margin-top: 8px;
            font-size: 1.4rem;
            background-color: #1d9fff;
            color: #fff;
        }

        .modal button.ok-btn:hover {
            background-color: #1789da;
        }


        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        .login-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            width: 280px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'Segoe UI', sans-serif;
        }

        .login-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .login-form label {
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .login-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .login-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ÁîªÂÉè„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }

        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            /* width: 40%; */
            align-self: flex-start;
        }

        @media (max-width: 600px) {
            #msgText {
                font-size: .8rem;
            }

            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }

            .inventory {
                gap: 12px;
                align-items: center;
                padding: 0 6px;
                width: 100%;
                max-width: 100%;
                flex-wrap: nowrap;
                overflow-x: auto;
                justify-content: flex-start;
            }

            .inventory-slot {
                width: 14vw;
                height: 14vw;
            }
        }

        @media (min-width: 601px) {
            .inventory {
                display: grid;
                grid-template-columns: repeat(7, 80px);
                grid-auto-rows: 80px;
                gap: 16px;
                justify-content: center;
                align-content: flex-start;
                max-width: 800px;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }

        #roomEffectOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }

        .title-wrapper {
            display: flex;
            width: 100%;
        }

        @keyframes warpFlash {
            0% {
                opacity: 0
            }

            15% {
                opacity: .95
            }

            50% {
                opacity: .4
            }

            100% {
                opacity: 0
            }
        }

        @keyframes chroma {
            0% {
                filter: none
            }

            100% {
                filter: contrast(1.2) saturate(1.2) hue-rotate(20deg)
            }
        }

        .warp-active {
            background: radial-gradient(circle at 50% 50%, #fff, #000 70%);
            animation: warpFlash 900ms ease-out both, chroma 900ms ease-out both;
        }

        #hintModal {
            color: #000;
        }

        @keyframes glowPulse {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            60% {
                opacity: 0.9;
            }

            100% {
                opacity: 0;
            }

            /* Ëá™Âãï„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà */
        }


        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, .45);
            }

            50% {
                box-shadow: 0 0 18px 6px rgba(255, 255, 255, .35);
            }
        }



        /* ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Áî®„ÅÆÂÖ®ÁîªÈù¢„É¨„Ç§„É§ */
        #fxFlash {
            position: fixed;
            inset: 0;
            background: transparent;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
        }

        /* ÁôΩ„Éï„É©„ÉÉ„Ç∑„É• */
        @keyframes flashWhite {
            0% {
                opacity: 0;
                background: #fff;
            }

            12% {
                opacity: .95;
                background: #fff;
            }

            100% {
                opacity: 0;
                background: #fff;
            }
        }

        /* Ëµ§„Éï„É©„ÉÉ„Ç∑„É•Ôºà„Éü„ÇπÔºâ */
        @keyframes flashRed {
            0% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }

            18% {
                opacity: .85;
                background: rgba(255, 0, 0, 0.85);
            }

            100% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }
        }

        /* „Åª„Çì„ÅÆÂ∞ë„Åó„Ç´„É°„É©„Ç∑„Çß„Ç§„ÇØÔºàÂ•Ω„Åø„ÅßÔºâ */
        @keyframes camShake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, -1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, 1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .fx-shake {
            animation: camShake 120ms ease;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .casefile-modal {
            background-color: #f6f2e8;
            color: #2c2c2c;
            width: 80%;
            max-width: 720px;
            max-height: 85vh;
            border: 2px solid #bba;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .casefile-scroll {
            padding: 24px;
            overflow-y: auto;
            max-height: 80vh;
            font-family: "Noto Serif JP", "Times New Roman", serif;
            line-height: 1.6;
        }

        .casefile-modal h1,
        .casefile-modal h2 {
            text-align: center;
            margin-bottom: 8px;
        }

        .casefile-modal h3 {
            margin-top: 20px;
            border-bottom: 1px solid #999;
        }

        .person {
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-left: 3px solid #b44;
        }

        .initial-f {
            font-weight: 900;
            color: #c9a43d;
            /* gold */
            font-size: 1.55em;
            /* margin-left: 6px; */
        }

        .initial-l {
            font-weight: 900;
            color: #8c8fa1;
            /* silver/steel */
            font-size: 1.55em;
            /* margin-left: 4px; */
        }


        .evidence {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .evidence th,
        .evidence td {
            border: 1px solid #bbb;
            padding: 6px 8px;
        }

        /* ÈõªË©±Âõ≥ÈëëÁî®„ÅÆË°å„Éè„Ç§„É©„Ç§„Éà */
        .evidence tr.phone-discovered td {
            background: rgba(255, 248, 210, 0.9);
            /* „ÅÜ„Åô„ÅÑ„ÇØ„É™„Éº„É†Ëâ≤ */
            font-weight: 600;
        }

        .evidence tr.phone-undiscovered td {
            background: rgba(245, 245, 245, 0.7);
            /* „ÅÜ„Åô„Ç∞„É¨„Éº */
            color: #777;
        }

        blockquote {
            font-style: italic;
            color: #444;
            border-left: 4px solid #888;
            padding-left: 10px;
            margin: 10px 0;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.4rem;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }

        .group {
            width: 90%;
            justify-content: center;
            display: flex;
            gap: 8px;
            align-items: center
        }


        @keyframes breathe {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(2px);
            }

            100% {
                transform: translateY(0);
            }
        }



        /* „É¢„Éº„ÉÄ„É´„ÅÆÁîªÂÉè„Éú„Çø„É≥„ÅØÂõ∫ÂÆö80px‚ÜíÂèØÂ§â„Å´ */
        #modalButtons button img {
            width: clamp(56px, 18vw, 96px);
            height: clamp(56px, 18vw, 96px);
        }

        /* „Ç¢„Éã„É°„É¢„Éº„ÉÄ„É´Áî® */
        .modal-anim {
            position: relative;
            width: min(400px, 80vw);
            margin: 0 auto 16px;
        }

        .modal-anim img {
            display: block;
            width: 100%;
            pointer-events: none;
        }

        /* 1ÊûöÁõÆ„ÅØ„Å†„Çì„Å†„ÇìÊ∂à„Åà„Çã */
        .modal-anim img:nth-child(1) {
            position: absolute;
            inset: 0;
            opacity: 1;
            animation: blockmanHatFadeOut 2.8s ease forwards 0.1s;
        }

        /* 2ÊûöÁõÆ„ÅØÂæå„Åã„Çâ„Åµ„Çè„Å£„Å®Âá∫„Å¶„Åè„Çã */
        .modal-anim img:nth-child(2) {
            opacity: 0;
            animation: blockmanHatFadeIn 3.0s ease forwards 0.4s;
        }

        /* 1Êûö„ÅÇ„Åü„Çä1ÁßíË°®Á§∫„ÅÆ‰æã */
        .modal-anim.frames img:nth-child(1) {
            animation-delay: 0s;
        }

        .modal-anim.frames img:nth-child(2) {
            animation-delay: 1s;
        }

        .modal-anim.frames img:nth-child(3) {
            animation-delay: 2s;
        }

        .modal-anim.frames img:nth-child(4) {
            animation-delay: 3s;
        }

        .modal-anim.frames img:nth-child(5) {
            animation-delay: 4s;
        }

        .modal-anim.frames img:nth-child(6) {
            animation-delay: 5s;
        }

        .modal-anim.frames img:nth-child(7) {
            animation-delay: 6s;
        }

        .modal-anim.frames img:nth-child(8) {
            animation-delay: 7s;
        }

        .modal-anim.frames img {
            position: absolute;
            inset: 0;
            width: 100%;
            opacity: 0;
            pointer-events: none;
            animation: animFrame 8s linear forwards;
        }


        @keyframes animFrame {
            0% {
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }


        /* 1ÊûöÁõÆ„ÅØ„Å†„Çì„Å†„ÇìÊ∂à„Åà„Çã */
        .fast img:nth-child(1) {
            animation: blockmanHatFadeOut 1.2s ease forwards 0.1s;
        }

        /* 2ÊûöÁõÆ„ÅØÂæå„Åã„Çâ„Åµ„Çè„Å£„Å®Âá∫„Å¶„Åè„Çã */
        .fast img:nth-child(2) {
            animation: blockmanHatFadeIn 1.4s ease forwards 0.4s;
        }

        @keyframes blockmanHatFadeOut {
            to {
                opacity: 0;
            }
        }

        @keyframes blockmanHatFadeIn {
            to {
                opacity: 1;
            }
        }

        /* ‚ñº „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´Áî® */

        .notebook-modal-content {
            background: #f4f7fb;
            color: #2c1810;
            border: 3px solid #d4af37;
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            overflow: auto;
            padding: 18px 18px 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            position: relative;
        }

        .notebook-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .notebook-title {
            font-weight: bold;
            font-size: 1.1rem;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .notebook-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid #c9a43d;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #eaf3ff, #d6e4ff);
        }

        .notebook-close-btn {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: #555;
        }

        .notebook-close-btn:hover {
            color: #000;
        }

        .notebook-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .notebook-tab {
            flex: 1;
            border: 1px solid #c9a43d;
            background: #fdfaf0;
            padding: 6px 4px;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 999px;
            color: #6b4b10;
            font-weight: bold;
        }

        .notebook-tab.active {
            background: linear-gradient(135deg, #ffe9a8, #ffd36b);
            box-shadow: 0 0 6px rgba(217, 165, 33, 0.6);
        }

        .notebook-body {
            background: #fffef8;
            border-radius: 8px;
            padding: 10px 12px 12px;
            border: 1px solid #e0d6b5;
        }

        .notebook-tab-content {
            display: none;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .notebook-tab-content.active {
            display: block;
        }

        .notebook-cap {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .notebook-note {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #6b6b6b;
        }

        .notebook-list {
            margin: 0 0 4px 1.1em;
            padding: 0;
        }

        .notebook-list li {
            margin-bottom: 3px;
        }

        .notebook-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            text-align: left;
        }

        .notebook-table th,
        .notebook-table td {
            border: 1px solid #d5c9a5;
            padding: 4px 6px;
        }

        .notebook-table th {
            background: #faf1d7;
        }

        /* ‚ñ≤ „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´Áî® */
        .distress-btn {
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #ff5555, #ff9900);
            color: #fff;
            box-shadow: 0 0 12px rgba(255, 64, 64, 0.7);
        }

        .distress-btn.distress-holding {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 0 18px rgba(255, 0, 0, 0.9);
        }

        .distress-hint {
            margin-top: 6px;
            font-size: 0.9em;
            color: #b00;
        }

        .notebook-image {
            max-width: 100%;
            display: block;
            margin: 8px auto;
            border-radius: 4px;
        }

        .red {
            color: red;
        }

        .bold {
            font-weight: bold;
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F2G9BX4FBF"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-F2G9BX4FBF');
</script>

<body>
    <!-- ‚ñº „É¢„Éº„ÉÄ„É´ÂÖ®‰Ωì -->
    <!-- ‚ñº „É¢„Éº„ÉÄ„É´ÂÖ®‰Ωì -->
    <div class="modal-overlay" style="display:none;">
        <div class="casefile-modal">
            <button class="close-btn">√ó</button>
            <div class="casefile-scroll">


            </div>
        </div>
    </div>
    <!-- ‚ñº ÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="notebookModal" style="display:none;">
        <div class="modal-content notebook-modal-content">
            <div class="notebook-header">
                <div class="notebook-title">
                    <span class="notebook-logo">üèòÔ∏è</span>
                    ÊâãÂ∏≥
                </div>
                <button class="notebook-close-btn" onclick="closeNotebook()">‚úï</button>
            </div>

            <div class="notebook-tabs">
                <!-- <button class="notebook-tab active" data-tab="memo" onclick="switchNotebookTab('memo')">
                    MEMO
                </button> -->
                <button class="notebook-tab" data-tab="notes" onclick="switchNotebookTab('notes')">
                    NOTES
                </button>
            </div>

            <div class="notebook-body">
                <!-- MEMO„Çø„Éñ -->
                <div class="notebook-tab-content active" id="notebook-tab-memo">
                    <p class="notebook-cap">
                        ‰ΩïÊïÖ„ÅãÊåÅ„Å£„Å¶„ÅÑ„ÅüÊâãÂ∏≥„Å†„ÄÇ
                    </p>
                    <ul class="notebook-list">
                        <li></li>
                        <li></li>
                    </ul>
                    <p class="notebook-note">
                        Êõ∏„ÅçËæº„Åø„ÅØ„ÄÅÊÄ•„ÅÑ„ÅßËµ∞„ÇäÊõ∏„Åç„Åó„Åü„Çà„ÅÜ„Å™‰π±„Çå„ÅüÂ≠ó„Åß‰∏¶„Çì„Åß„ÅÑ„Çã„ÄÇ
                    </p>
                </div>

                <!-- NOTES„Çø„ÉñÔºöÂæå„Åã„ÇâÂ¢ó„Åà„Çã„É°„É¢Áî® -->
                <div class="notebook-tab-content" id="notebook-tab-notes">
                    <p class="notebook-cap">
                        Á©∫ÁôΩ„ÅÆ„Éö„Éº„Ç∏„ÄÇ
                    </p>
                    <div id="notebook-notes-body">
                        <!-- ÂæåÂçä„ÅÆ„Ç§„Éô„É≥„Éà„ÅßËøΩË®ò„Åó„Å¶„ÅÑ„ÅèÊÉ≥ÂÆö -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤ ÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ -->


    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <!-- <div class="title">‰øùËÇ≤ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫</div> -->
            <div style="margin:0 0; text-align:center;">
                <a href="escape29_hint.html" target="_blank"
                    style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    üîç „Éí„É≥„Éà„ÇíË¶ã„Çã
                </a>

            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="640" style="width: 90vw; max-width: 640px;"></canvas>


        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="msgText">Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÂøò„Çå„Çâ„Çå„Åü‰øùËÇ≤ÂÆ§„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ</span>
                    <div id="statusIconArea" style="position:absolute; bottom:6px; right:12px; display:flex; gap:8px;">
                    </div>
                </div>
                <div class="navigation">

                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
                <div class="inventory-slot" onclick="useItem(5)"></div>
                <div class="inventory-slot" onclick="useItem(6)"></div>
                <div class="inventory-slot" onclick="useItem(7)"></div>
                <div class="inventory-slot" onclick="useItem(8)"></div>
                <div class="inventory-slot" onclick="useItem(9)"></div>
                <div class="inventory-slot" onclick="useItem(10)"></div>
                <div class="inventory-slot" onclick="useItem(11)"></div>
                <div class="inventory-slot" onclick="useItem(12)"></div>
                <div class="inventory-slot" onclick="useItem(13)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
                üîä BGM
            </button>
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">„Çª„Éº„Éñ</button>
                <button class="nav-btn" onclick="loadGame()">„É≠„Éº„Éâ</button>
                <!-- <button class="nav-btn" onclick="openNotebook()">
                    <img src="images/28/notebook.png"
                        style="width:40px;max-width:100%;display:block;margin:0 auto 0px;">
                </button> -->
            </div>
        </div>
        <div class="notice">ÂΩì„Çµ„Ç§„Éà„ÅÆÈü≥Ê∫ê„ÅØ<a href="https://otologic.jp/" target="blank">OtoLogic</a>,<a
                href="https://dova-s.jp/" target="blank">DOVA-SYNDROME</a>„ÅÆÁ¥†Êùê„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô ‰ΩúËÄÖ:<a href="index.html">„Çπ„É©„Çª„Éñ„É≥</a>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>

    <audio id="bgm" src="sounds/23/Paper_craft.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-clear" src="sounds/common/Cyber03-1.mp3"></audio>
    <audio id="se-change" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-open" src="sounds/common/Short_Accent09-1(Dry).mp3"></audio>
    <audio id="se-fanta" src="sounds/common/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <audio id="se-coin" src="sounds/common/Onoma-Ding01-1(Dry).mp3"></audio>
    <audio id="se-scene-change" src="sounds/common/Scene_Change08-1(Delay-Fast).mp3"></audio>
    <audio id="se-gril" src="sounds/common/gril.mp3"></audio>
    <audio id="se-gacha" src="sounds/common/Retro_Anime-Switch02-3(Low).mp3"></audio>

    <audio id="se-gogogo" src="sounds/common/gogogo.mp3"></audio>

    <audio id="se-bukimi_piano" src="sounds/common/bukimi_piano.mp3"></audio>
    <audio id="se-idea" src="sounds/common/Inspiration11-1(Low).mp3"></audio>
    <audio id="se-grab" src="sounds/common/Motion-Grab07-1(Dry).mp3"></audio>
    <audio id="se-switch" src="sounds/common/switch.mp3"></audio>
    <audio id="se-glich" src="sounds/common/glich.mp3"></audio>
    <audio id="se-bear-eat" src="sounds/common/Motion-Eating02-1.mp3"></audio>
    <audio id="se-bear-flying" src="sounds/common/Motion-Blow_Away02-1(Long).mp3"></audio>
    <audio id="se-mouse" src="sounds/common/PC-Mouse06-1.mp3"></audio>

    <audio id="se-angel" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-up" src="sounds/common/Inspiration10-1(High).mp3"></audio>
    <audio id="se-ashioto" src="sounds/common/NES-RPG02-01(Enter).mp3"></audio>
    <audio id="se-hasami" src="sounds/common/hasami.mp3"></audio>
    <audio id="se-shutter" src="sounds/common/shutter.mp3"></audio>
    <audio id="se-falling" src="sounds/common/Motion-Falling_Whistle04-2(Short).mp3"></audio>

    <audio id="se-song" src="sounds/24/song.wav"></audio>
    <audio id="se-song-forget" src="sounds/24/song_forget.wav"></audio>
    <audio id="se-cyber" src="sounds/common/Cyber20-1.mp3"></audio>
    <audio id="se-cloth" src="sounds/common/cloth.mp3"></audio>
    <audio id="se-paper" src="sounds/common/Flyer02-3(Rustle).mp3"></audio>
    <audio id="se-zukkoke" src="sounds/common/zukkoke.mp3"></audio>
    <audio id="se-hanabi" src="sounds/common/hanabi.mp3"></audio>
    <audio id="se-nami" src="sounds/common/nami.mp3"></audio>
    <audio id="se-drill" src="sounds/common/drill.mp3"></audio>
    <audio id="se-nabe" src="sounds/common/nabe.mp3"></audio>
    <audio id="se-can" src="sounds/common/can.mp3"></audio>
    <audio id="se-kira" src="sounds/common/kira.mp3"></audio>
    <audio id="se-bar" src="sounds/common/bar.mp3"></audio>
    <audio id="se-sword" src="sounds/common/sword.mp3"></audio>
    <audio id="se-attack" src="sounds/common/Motion-Fall01-2(Short).mp3"></audio>
    <audio id="se-tea" src="sounds/common/tea.mp3"></audio>
    <audio id="se-pop" src="sounds/common/Onoma-Pop01-3(Dry).mp3"></audio>
    <audio id="se-power" src="sounds/common/powerup.mp3"></audio>
    <audio id="se-fire" src="sounds/common/fire.mp3"></audio>


    <script>
        // --- Analytics helper ---
        window.ANA = {
            start: Date.now(),
            hintCount: 0,
            send(ev, params = {}) { try { gtag('event', ev, params); } catch (e) { } }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const a = document.querySelector('a[href*="_hint.html"]');
            if (a) {
                a.addEventListener('click', () => {
                    ANA.hintCount++;
                    ANA.send('open_hint', { count: ANA.hintCount });
                });
            }
        });

        window.ANA = Object.assign(window.ANA || {}, {
            sid: Math.random().toString(36).slice(2),
            sent: new Set(),
            baseParams() {
                return {
                    elapsed_sec: Math.round((Date.now() - this.start) / 1000),
                    hints: this.hintCount || 0,
                    save_version: (typeof SAVE_VERSION === 'number' ? SAVE_VERSION : null),
                    room: (window.gameState && gameState.currentRoom) || null,
                    sid: this.sid,
                };
            },
            once(ev, key = '', params = {}) {
                const k = `${ev}:${key}`;
                if (this.sent.has(k)) return;
                this.sent.add(k);
                this.send(ev, { ...this.baseParams(), ...params });
            }
        });

        // Ê±éÁî®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÄÅ‰ø°Áî®„Éò„É´„Éë
        function markProgress(step, extra = {}) {
            ANA.once('progress', step, { step, ...extra });
        }


        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.querySelector(".modal-overlay");

            const closeBtn = document.querySelector(".close-btn");

            // ÂàùÊúüÁä∂ÊÖã„ÅßÈùûË°®Á§∫
            modal.style.display = "none";

            // Èñâ„Åò„Çã
            closeBtn?.addEventListener("click", () => {
                modal.style.display = "none";
            });

            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modal.addEventListener("click", (e) => {
                if (e.target === modal) modal.style.display = "none";
            });

        });

        document.querySelectorAll('#modal button').forEach(btn => {
            if (btn.textContent === 'OK') {
                btn.classList.add('ok-btn');
            }
        });



        window._nextModal = null;
        const canvas = document.getElementById('gameCanvas');
        let DEV_MODE = false;
        let uiLang = 'jp'; // 'jp' | 'en'
        // „Ç≤„Éº„É†Ë®≠ÂÆö - ÁîªÂÉè„Éë„Çπ„Çí„Åì„Åì„ÅßÁÆ°ÁêÜ
        let IMAGES = {
            rooms: {

                main: ['images/29/main.png'],
                mainDoor: ['images/29/main_door.png'],
                stringBoard: ['images/29/string_board.png'],
                alchemyRoom: ['images/29/alchemy_room.png'],
                book1: {
                    jp: ['images/29/book_1.png'],
                    en: ['images/29/book_1en.png'],
                },
                book2: {
                    jp: ['images/29/book_2.png'],
                    en: ['images/29/book_2en.png'],
                },


                drawerInner: ['images/29/drawer_inner.png'],
                drawerTopInner: ['images/29/drawer_inner.png'],
                drawerMiddleInner: ['images/29/drawer_inner.png'],
                drawerBottomInner: ['images/29/drawer_inner.png'],
                nabeInner: ['images/29/nabe_inner.png'],

                end: ['images/29/end.png'],
                endWorse: ['images/29/end_worse.png'],
                trueEnd: ['images/29/true_end.png'],

            },
            items: {
                coin: 'images/bear_coin.png',
                bear: 'images/bear.png',
                back: 'images/common/back.png',
                arrowRight: 'images/common/arrow_right.png',
                arrowLeft: 'images/common/arrow_left.png',
                arrowAbove: 'images/common/arrow_above.png',
                redBack: 'images/common/red_back.png',
                greenBack: 'images/common/green_back.png',
                blueBack: 'images/common/blue_back.png',
                blackBack: 'images/common/black_back.png',
                lang_en: 'images/common/en2.png',
                lang_jp: 'images/common/jp.png',
                l: 'images/29/l.png',
                o: 'images/29/o.png',
                c: 'images/29/c.png',
                c2: 'images/29/c2.png',
                c3: 'images/29/c3.png',
                k: 'images/29/k2.png',
                button: 'images/common/button.png',
                machineWindow: 'images/29/machine_window.png',
                memoEn: 'images/29/memo_en.png',
                memo: 'images/29/memo.png',
                memoAdvanceEn: 'images/29/memo_advance_en.png',
                memoAdvance: 'images/29/memo_advance.png',
                plugOff: 'images/29/plug_off.png',
                plugOn: 'images/29/plug_on.png',
                driver: 'images/29/driver.png',
                miracleDriver: 'images/29/miracle_driver.png',
                hammer: 'images/29/hammer.png',
                opener: 'images/29/opener.png',
                hutaOpen: 'images/29/huta_open.png',
                nabeDamage: 'images/29/nabe_damage.png',
                core: 'images/29/core.png',
                gemBlue: 'images/29/gem_blue.png',
                gemRed: 'images/29/gem_red.png',
                gemGreen: 'images/29/gem_green.png',
                gemViolet: 'images/29/gem_violet.png',
                gemOnigiri: 'images/29/gem_onigiri.png',
                spellTable: 'images/29/spell_table.png',
                recipe1: 'images/29/recipe1.png',
                recipe2: 'images/29/recipe2.png',
                recipeFixed: 'images/29/recipe_fixed.png',
                windowAfter: 'images/29/window_after.png',
                redSphere: 'images/29/red_sphere.png',
                onigiriSphere: 'images/29/onigiri_sphere.png',
                shine: 'images/29/shine.png',
                key: 'images/29/key.png',
                luckyHammer: 'images/29/lucky_hammer.png',
                onigiri: 'images/29/onigiri.jpeg',
                bearHope: 'images/29/bear_hope.png',
                bearOnigiri: 'images/29/bear_onigiri.png',
                book: 'images/29/book.png',




            },

            modals: {
                order: 'images/29/order.png',
                orderEn: 'images/29/order_en.png',
                posterSozai: 'images/29/poster_sozai.png',
                posterSozaiEn: 'images/29/poster_sozai_en.png',
                nabeHammer: 'images/29/modal_nabe_hammer.png',
                nabeDriver: 'images/29/modal_nabe_driver.png',
                spellTable: 'images/29/modal_spell_table.png',
                outside: 'images/29/modal_outside.png',
                tri: 'images/29/modal_tri.png',
                rensei1: 'images/29/modal_rensei1.png',
                rensei2: 'images/29/modal_rensei2.png',
                openBottle: 'images/29/modal_bottle_open.jpeg',
                bottleRed: 'images/29/modal_bottle_red.png',
                bottleBlue: 'images/29/modal_bottle_blue.png',
                driverToWindow: 'images/29/modal_driver_to_window.png',
                setKey: 'images/29/modal_set_key.png',
                recipeBack: 'images/29/modal_recipe_back.png',
                driverBottom: 'images/29/modal_driver_bottom.png',
                hammerSide: 'images/29/modal_hammer_side.png',
                onigiriHammer: 'images/29/modal_onigiri_hammer.png',
                bearHappy: 'images/29/bear_happy.jpeg',




            },
        };


        // „Ç≤„Éº„É†Áä∂ÊÖã
        const SAVE_KEY = 'escapeGameState29';
        const SAVE_VERSION = 1;
        const SAVE_KEYS = [
            SAVE_KEY + '_1',
            SAVE_KEY + '_2'
        ];

        // Êóß1„Çπ„É≠„ÉÉ„Éà„Çª„Éº„Éñ„Åå„ÅÇ„Çå„Å∞„ÄÅËá™Âãï„Åß„Çπ„É≠„ÉÉ„Éà1„Å´ÁßªË°å
        (function migrateOldSave() {
            try {
                const old = localStorage.getItem(SAVE_KEY);
                const slot1 = localStorage.getItem(SAVE_KEYS[0]);
                if (old && !slot1) {
                    localStorage.setItem(SAVE_KEYS[0], old);
                    // ÂøÖË¶Å„Å™„ÇâÂè§„ÅÑ„Ç≠„Éº„ÅØÊ∂à„Åó„Å¶„ÇÇOK
                    // localStorage.removeItem(SAVE_KEY);
                    console.log('Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„Çí„Çπ„É≠„ÉÉ„Éà1„Å´ÁßªË°å„Åó„Åæ„Åó„Åü');
                }
            } catch (e) {
                console.warn('„Çª„Éº„Éñ„Éá„Éº„ÇøÁßªË°å„Å´Â§±Êïó', e);
            }
        })();

        function getDefaultGameState() {
            return {
                currentRoom: 'main',
                openRooms: ['main'],
                openRoomsTmp: [],
                inventory: [],
                codex: { discovered: {} },
                main: {
                    flags: {

                        plugOn: false, openNabe: false, useHammerToNabe: false,
                        cookedOnigiri: false,
                        unlockDrawerTop: false, unlockDrawerMiddle: false, unlockDrawerBottom: false,
                        unlockDrawerMain: false,
                        foundRecipe1: false, foundRecipe2: false,
                        unlockBlueBottle: false,
                        unlockMachine: false,
                        removeWindowFrame: false,
                        foundkey: false,
                        unlockBox: false, foundGemGreen: false,


                        bearAppear: false,



                        talkTo: { bear: 0, }, backgroundState: 0,
                    }
                },

                end: {
                    flags: { backgroundState: 0 }
                },
                trueEnd: {
                    flags: { backgroundState: 0 }
                },


                flags: { trueEndUnlocked: false },
                selectedItem: null,
                usingItem: null,
                endings: { true: false, normal2: false, normal: false },

            };
        }

        let gameState = getDefaultGameState();


        // ÈÉ®Â±ã„Éá„Éº„Çø
        let rooms = {
            main: {
                name: 'Â∑•Êàø',
                description: '',
                clickableAreas: [
                    {
                        x: 49.4, y: 23.7, width: 21.7, height: 25.9,
                        onClick: clickWrap(function () {
                            changeRoom('stringBoard');

                        }),
                        description: 'ÊñáÂ≠ó„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÊùø',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 23.5, y: 52.1, width: 45.2, height: 27.3,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.plugOn) {
                                updateMessage('ÈõªÊ∫ê„ÅåÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑ„Çà„ÅÜ„Å†');
                                return;
                            }
                            if (!gameState.main.flags.unlockMachine) {
                                updateMessage('Èå¨Êàê„Éû„Ç∑„É≥„Å†„ÄÇ‰Ωø„ÅÑÊñπ„ÇíÂøò„Çå„Å¶„Åó„Åæ„Å£„Åü„ÄÇ');
                                return;
                            }
                            changeRoom('alchemyRoom');
                        }),
                        description: 'Èå¨Êàê„Éû„Ç∑„É≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 28, y: 57.3, width: 22.3, height: 16.3,
                        onClick: clickWrap(function () {


                        }),
                        description: '„Éû„Ç∑„É≥Á™ì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'machineWindow', visible: () => !gameState.main.flags.plugOn }
                    },
                    {
                        x: 78.0, y: 65.6, width: 19.7, height: 15.1,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'hammer'&& !gameState.main.flags.openNabe) {
                                showObj('useHammerToNabe', '„Éè„É≥„Éû„Éº„ÅßÈçã„Çí„Åü„Åü„ÅÑ„Åü', IMAGES.modals.nabeHammer, 'Èçã„ÅØÂ∞ë„Åó„Å∏„Åì„Çì„Åß„Åó„Åæ„Å£„Åü');
                                playSE('se-sword');
                                renderCanvasRoom();
                                return;
                            }
                            if (gameState.selectedItem == 'luckyHammer'&& !gameState.main.flags.openNabe) {
                                updateMessage('‰Ωï„ÇÇËµ∑„Åì„Çâ„Å™„Åã„Å£„Åü„ÄÇ');
                                playSE('se-sword');
                                renderCanvasRoom();
                                return;
                            }
                            if (gameState.selectedItem == 'driver' && !gameState.main.flags.openNabe) {
                                showObj(null, '„Éâ„É©„Ç§„Éê„Éº„ÅßËìã„Çí„Åì„Åò„ÅÇ„Åë„Åü', IMAGES.modals.nabeDriver, 'Èçã„ÅÆËìã„ÅåÈñã„ÅÑ„Åü');
                                playSE('se-can');
                                gameState.main.flags.openNabe = true;
                                renderCanvasRoom();
                                return;
                            }
                            if (gameState.selectedItem == 'miracleDriver' && !gameState.main.flags.openNabe) {
                                showObj(null, '„Éü„É©„ÇØ„É´„Éâ„É©„Ç§„Éê„Éº„ÅßËìã„Çí„Åì„Åò„ÅÇ„Åë„Åü', IMAGES.modals.nabeDriver, 'Èçã„ÅÆËìã„ÅåÈñã„ÅÑ„Åü');
                                playSE('se-can');
                                gameState.main.flags.openNabe = true;
                                renderCanvasRoom();
                                return;
                            }
                            if (gameState.main.flags.openNabe) {
                                changeRoom('nabeInner');
                                return;
                            }
                            updateMessage('„Éï„Çø„Åå„ÇÜ„Åå„Çì„Åß„ÅÑ„Å¶„ÄÅÈñã„Åã„Å™„ÅÑ„ÄÇ‰Ωï„ÅãÂ∑•ÂÖ∑„ÅåÂøÖË¶Å„Åù„ÅÜ„Å†');

                        }),
                        description: '„Åä„Å™„Åπ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 78.2, y: 64.8, width: 19.2, height: 5.4,
                        onClick: clickWrap(function () {

                        }),
                        description: '„ÅäÈçã„Ç™„Éº„Éó„É≥',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'hutaOpen', visible: () => gameState.main.flags.openNabe }
                    },
                    {
                        x: 79.2, y: 67.0, width: 18.2, height: 3.2,
                        onClick: clickWrap(function () {

                        }),

                        description: '„ÅäÈçã„ÉÄ„É°„Éº„Ç∏',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'nabeDamage', visible: () => !gameState.main.flags.openNabe && gameState.main.flags.useHammerToNabe }
                    },
                    {
                        x: 33.4, y: 87.8, width: 41.6, height: 10.1,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDrawerMain) {
                                changeRoom('drawerInner');
                            } else {
                                showDrawerMainPuzzle();
                            }

                        }),
                        description: 'Âºï„ÅçÂá∫„Åó',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 5.5, y: 24.1, width: 22.6, height: 11.8,
                        onClick: clickWrap(function () {
                            // „Åô„Åß„Å´ÊåÅ„Å£„Å¶„Åü„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„É°„ÉÉ„Çª„Éº„Ç∏„Å†„ÅëÔºâ
                            if (hasItem('gemRed')) {
                                updateMessage('Ëµ§„ÅÑÂÆùÁü≥„ÅØ„ÇÇ„ÅÜÊåÅ„Å£„Å¶„ÅÑ„Çã„ÄÇ');
                                return;
                            }

                            showModal(
                                'Ëµ§„ÅÑÂÆùÁü≥„Åå„ÅÇ„Çã',
                                `<img src="${IMAGES.modals.bottleRed}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                            );
                            addItem('gemRed');
                            updateMessage('Ëµ§„ÅÑÂÆùÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                        }),
                        description: 'Ëµ§„ÅÑÁ¥†Êùê„ÅÆÁì∂',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 8.7, y: 6.2, width: 18.3, height: 12.7,
                        onClick: clickWrap(function () {
                            updateMessage('Á©∫„ÅÆÁì∂„Å†');
                        }),
                        description: '„Ç´„É©„ÅÆÁ¥†Êùê„ÅÆÁì∂',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 27.5, y: 8.1, width: 9.2, height: 10.8,
                        onClick: clickWrap(function () {
                            const f = gameState.main.flags || (gameState.main.flags = {});

                            // „Åæ„Åö„Ç¢„É≥„É≠„ÉÉ„ÇØ„ÅåÂøÖË¶Å
                            if (!f.unlockBlueBottle) {
                                if (gameState.selectedItem === 'opener') {
                                    f.unlockBlueBottle = true;
                                    playSE('se-open'); // „Å™„Åë„Çå„Å∞ 'se-click' „Åß„ÇÇOK
                                    showObj(null, '„Ç™„Éº„Éó„Éä„Éº„ÅßËìã„ÇíÈñã„Åë„Åü', IMAGES.modals.openBottle, '„Ç™„Éº„Éó„Éä„Éº„ÅßËìã„ÇíÈñã„Åë„Åü');
                                    renderCanvasRoom();
                                } else {
                                    updateMessage('Ëìã„ÅåÂõ∫„Åè„Å¶Èñã„Åã„Å™„ÅÑ„ÄÇ');
                                }
                                return;
                            }

                            // „Ç¢„É≥„É≠„ÉÉ„ÇØÂæåÔºöÊú™ÊâÄÊåÅ„ÅÆ„Å®„Åç„Å†„ÅëÂÖ•Êâã
                            if (hasItem('gemBlue')) {
                                updateMessage('Èùí„ÅÑÂÆùÁü≥„ÅØ„ÇÇ„ÅÜÊåÅ„Å£„Å¶„ÅÑ„Çã„ÄÇ');
                                return;
                            }

                            showModal(
                                'Èùí„ÅÑÂÆùÁü≥„Åå„ÅÇ„Çã',
                                `<img src="${IMAGES.modals.bottleBlue}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                            );
                            addItem('gemBlue');
                            updateMessage('Èùí„ÅÑÂÆùÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü');


                        }),
                        description: 'Èùí„ÅÑÁ¥†Êùê„ÅÆÁì∂',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 75.9, y: 23.7, width: 24.1, height: 40.3,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'driver') {
                                updateMessage('„Å≠„Åò„ÅåÂõ∫„Åè„Å¶Èñã„Åã„Å™„ÅÑ');
                                return;
                            }
                            if (gameState.selectedItem == 'miracleDriver') {
                                playSE('se-drill');
                                showObj(null, 'Á™ìÊû†„ÅÆ„Å≠„Åò„ÇíÂ§ñ„Åó„Åü', IMAGES.modals.driverToWindow, '„Å≠„Åò„ÇíÂ§ñ„Åó„Å¶Á™ìÊû†„ÇíÂ§ñ„Åó„Åü');
                                gameState.main.flags.removeWindowFrame = true;
                                renderCanvasRoom();
                                return;
                            }
                            if (gameState.main.flags.removeWindowFrame) {
                                travelWithSteps('endWorse');
                            }
                            updateMessage('Â§ñ„ÅåË¶ã„Åà„Çã');
                        }),
                        description: 'Á™ì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'windowAfter', visible: () => gameState.main.flags.removeWindowFrame }
                    },
                    {
                        x: 1.1, y: 62.1, width: 10.5, height: 18.5,
                        onClick: clickWrap(function () {

                        }),
                        description: '„Éù„ÉÉ„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 16.7, y: 78.4, width: 8.2, height: 3.4,
                        onClick: clickWrap(function () {

                        }),
                        description: 'Êäú„Åë„Åü„Ç≥„É≥„Çª„É≥„Éà',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'plugOff', visible: () => !gameState.main.flags.plugOn }
                    },
                    {
                        x: 17.6, y: 72.8, width: 7.8, height: 7.2,
                        onClick: clickWrap(function () {

                        }),
                        description: 'Âà∫„Åï„Å£„Åü„Ç≥„É≥„Çª„É≥„Éà',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'plugOn', visible: () => gameState.main.flags.plugOn }
                    },
                    {
                        x: 15.6, y: 68.8, width: 8.1, height: 11.7,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.plugOn) {
                                updateMessage('„Ç≥„É≥„Çª„É≥„Éà„ÅØÂ∑Æ„ÅóËæº„Åæ„Çå„Å¶„ÅÑ„Çã');
                            } else {
                                showModal(
                                    `<div style="text-align:center;">„Ç≥„Éº„Éâ„ÅåÊäú„Åë„Å¶„ÅÑ„Çã„ÄÇ<br>
            „Ç≥„Éº„Éâ„ÇíÂ∑Æ„ÅóËæº„Åø„Åæ„Åô„ÅãÔºü
        </div>`,
                                    '',
                                    [
                                        {
                                            text: '„ÅØ„ÅÑ',
                                            action: () => {
                                                gameState.main.flags.plugOn = true;
                                                playSE('se-switch');
                                                updateMessage(
                                                    '„Ç≥„Éº„Éâ„ÇíÂ∑Æ„ÅóËæº„Çì„Å†„ÄÇ'
                                                );
                                                renderCanvasRoom();
                                                closeModal();
                                            }
                                        },
                                        {
                                            text: '„ÅÑ„ÅÑ„Åà',
                                            action: () => {
                                                closeModal();
                                            }
                                        }
                                    ]
                                );
                            }
                        }),
                        description: '„Ç≥„É≥„Çª„É≥„ÉàÊìç‰ΩúÈÉ®',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },



                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('mainDoor');
                        }, { allowAtNight: true }),
                        description: '„É°„Ç§„É≥Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },



                ]
            },
            mainDoor: {
                name: 'Â∑•Êàø„ÅÆ„Éâ„Ç¢„Åå„ÅÇ„ÇãÈù¢',
                description: '',
                clickableAreas: [
                    {
                        x: 42.6, y: 36.4, width: 16.2, height: 19.6,
                        onClick: clickWrap(function () {
                            showObj(null, 'Á•≠„Çä„ÅØ‰ªäÊó•„Å†„ÄÇ‰Ωï„Å®„Åã‰ªï‰∏ä„Åí„Å™„ÅÑ„Å®‚Ä¶', IMAGES.modals.order, 'Ê≥®ÊñáÊõ∏„ÅåË≤º„Çâ„Çå„Å¶„ÅÑ„Çã', IMAGES.modals.orderEn,);
                        }),
                        description: 'Ê≥®ÊñáÊõ∏',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 38.1, y: 5.8, width: 26.1, height: 12.9,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.posterSozai, 'Á¥†Êùê„ÅåË®ò„Åï„Çå„Å¶„ÅÑ„Çã', IMAGES.modals.posterSozaiEn)
                        }),
                        description: '„Éâ„Ç¢‰∏äÁ¥†ÊùêË°®',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 33.2, y: 26.5, width: 35.9, height: 66.6,
                        onClick: clickWrap(function () {
                            if (hasItem('redSphere') || hasItem('onigiriSphere')) {
                                showModal(
                                    '‰æùÈ†ºÂìÅ„ÅØÂÆåÊàê„Åï„Åõ„Åü„ÄÇÂ§ñ„Å´Âá∫„Åæ„Åô„ÅãÔºü',
                                    '',
                                    [
                                        {
                                            text: '„ÅØ„ÅÑ',
                                            action: () => {
                                                closeModal();
                                                const f = gameState.main.flags || (gameState.main.flags = {});
                                                f.playHanabiOnEnd = true;
                                                handleDoor();
                                            }
                                        },
                                        { text: '„ÅÑ„ÅÑ„Åà', action: 'close' }
                                    ]
                                );
                                return;
                            }
                            updateMessage('„Åì„Åì„Åã„ÇâÂá∫„Çã„Å™„Çâ„Å∞Ê≥®Êñá„Åï„Çå„ÅüÂìÅ„ÇíÊåÅ„Å£„Å¶Ë°å„Åã„Å™„ÅÑ„Å®‚Ä¶');
                        }),
                        description: '„Éâ„Ç¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 85.0, y: 40.3, width: 7.0, height: 6.1,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.spellTable, 'Ë¨é„ÅÆË°®„Å†');
                        }),
                        description: 'Âë™ÊñáË°®',
                        zIndex: 5,
                        usable: () => hasItem('hammer') || hasItem('luckyHammer'),
                        item: { img: 'spellTable', visible: () => true }
                    },
                    {
                        x: 83.4, y: 27.4, width: 10.3, height: 10.8,
                        onClick: clickWrap(function () {

                        }),
                        description: '„Ç™„Éº„Éó„Éä„Éº',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'opener', visible: () => !hasItem('opener') }
                    },
                    {
                        x: 78.4, y: 35.5, width: 11.0, height: 11.4,
                        onClick: clickWrap(function () {

                        }, { allowAtNight: true }),
                        description: '„Éâ„É©„Ç§„Éê„Éº',
                        zIndex: 5,
                        usable: () => false,
                        item: {
                            img: () => (gameState.main?.flags?.hasMiracleDriver ? 'miracleDriver' : 'driver'),
                            visible: () => {
                                const hasMiracle = !!gameState.main?.flags?.hasMiracleDriver;
                                return hasMiracle ? !hasItem('miracleDriver') : !hasItem('driver');
                            }
                        }
                    },
                    {
                        x: 85.0, y: 31.9, width: 7.8, height: 15.3,
                        onClick: clickWrap(function () {

                        }, { allowAtNight: true }),
                        description: '„Éè„É≥„Éû„Éº',
                        zIndex: 5,
                        usable: () => false,
                        item: {
                            img: () => (gameState.main?.flags?.hasLuckyHammer ? 'luckyHammer' : 'hammer'),
                            visible: () => {
                                const hasLucky = !!gameState.main?.flags?.hasLuckyHammer;
                                return hasLucky ? !hasItem('luckyHammer') : !hasItem('hammer');
                            }
                        }
                    },
                    {
                        x: 77.5, y: 24.6, width: 22.3, height: 22.6,
                        onClick: clickWrap(function () {
                            showToolShelfModal();
                        }, { allowAtNight: true }),
                        description: 'Â∑•ÂÖ∑Ê£ö',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 8.0, y: 22.8, width: 18.0, height: 13.3,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.outside, '„ÅäÁ•≠„Çä„ÅÆÊóó„Å†');
                        }),
                        description: '„Éâ„Ç¢ÂÅ¥Á™ì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0.9, y: 69.6, width: 22.4, height: 6.7,
                        onClick: clickWrap(function () {
                            const f = gameState.main.flags || (gameState.main.flags = {});
                            if (f.unlockDrawerTop) {
                                changeRoom('drawerTopInner');
                                return;
                            }
                            showDrawerTopPuzzle();
                        }),
                        description: 'Âºï„ÅçÂá∫„Åó‰∏äÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0.9, y: 78.5, width: 22.1, height: 6.1,
                        onClick: clickWrap(function () {

                            const f = gameState.main.flags || (gameState.main.flags = {});
                            if (f.unlockDrawerMiddle) {
                                changeRoom('drawerMiddleInner');
                                return;
                            }
                            showDrawerMiddlePuzzle();
                        }),
                        description: 'Âºï„ÅçÂá∫„Åó‰∏≠ÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 1.0, y: 86.9, width: 22.3, height: 6.0,
                        onClick: clickWrap(function () {
                            const f = gameState.main.flags || (gameState.main.flags = {});
                            if (f.unlockDrawerBottom) {
                                changeRoom('drawerBottomInner');
                                return;
                            }
                            showDrawerBottomPuzzle();
                        }),
                        description: 'Âºï„ÅçÂá∫„Åó‰∏ãÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 12.5, y: 59.8, width: 14.8, height: 5.4,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'key') {
                                updateMessage('Èçµ„ÇíÈñã„Åë„Åü');
                                playSE('se-gacha');
                                gameState.main.flags.unlockBox = true;
                                return;
                            }
                            if (gameState.main.flags.unlockBox) {
                                acquireItemOnce('foundGemGreen', 'gemGreen', 'Á∑ëËâ≤„ÅÆÂÆùÁü≥„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.gemGreen, 'Á∑ëËâ≤„ÅÆÂÆùÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                                return;
                            }
                            updateMessage('ÁÆ±„Å´„ÅØÈçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                        }),
                        description: '„Çø„É≥„Çπ‰∏ä„ÅÆÁÆ±',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('main');
                        }, { allowAtNight: true }),
                        description: '„Éâ„Ç¢Èù¢Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },




                ]
            },
            stringBoard: {
                name: 'ÊñáÂ≠óÊùø',
                description: '',
                clickableAreas: [
                    // l
                    {
                        x: 12, y: 18, width: 16, height: 22,
                        description: 'SB:l',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'l', visible: () => true, rotateDeg: () => ensureLetterRot().l }
                    },
                    // oÔºà„Éú„Çø„É≥„Å™„ÅóÔºâ
                    {
                        x: 32, y: 18, width: 16, height: 22,
                        description: 'SB:o',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'o', visible: () => true, rotateDeg: () => ensureLetterRot().o }
                    },
                    // c
                    {
                        x: 52, y: 18, width: 16, height: 22,
                        description: 'SB:c',
                        zIndex: 5,
                        usable: () => true,
                        item: {
                            img: () => (gameState.main.flags.setKey ? 'c3' : (gameState.main.flags.unlockDrawerTop ? 'c2' : 'c')),
                            visible: () => true,
                            rotateDeg: () => ensureLetterRot().c
                        },
                        onClick: clickWrap(function () {
                            const f = gameState.main.flags || (gameState.main.flags = {});
                            if (!f.unlockDrawerTop || f.setKey || !f.unlockBox) return;
                            if (gameState.selectedItem === 'key') {
                                removeItem('key');
                                f.setKey = true;
                                showModal(
                                    'Èçµ„ÇíÂµå„ÇÅËæº„Çì„Å†',
                                    `<img src="${IMAGES.modals.setKey}" style="width:360px;max-width:100%;display:block;margin:0 auto 16px;">`,
                                    [{
                                        text: 'Èñâ„Åò„Çã',
                                        action: () => {
                                            closeModal();
                                            f.stringBoardFlashUntil = Date.now() + 450;
                                            f.setKeyRevealed = true;
                                            renderCanvasRoom();
                                        }
                                    }]
                                );
                            }
                        })
                    },
                    // k
                    {
                        x: 72, y: 18, width: 16, height: 22,
                        description: 'SB:k',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'k', visible: () => true, rotateDeg: () => ensureLetterRot().k }
                    },

                    // ÂõûËª¢„Éú„Çø„É≥Ôºöl
                    {
                        x: 12, y: 43, width: 16, height: 8,
                        description: 'SB:rot-l',
                        zIndex: 10,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDrawerTop) return;
                            const rot = ensureLetterRot();
                            rot.l = ((rot.l || 0) + 90) % 360;
                            playSE('se-click');
                            renderCanvasRoom();
                        }, { allowAtNight: true }),
                        description: 'ÂõûËª¢„Éú„Çø„É≥Ôºöl', zIndex: 5,
                        item: { img: 'button', visible: () => true }
                    },

                    // ÂõûËª¢„Éú„Çø„É≥Ôºöc
                    {
                        x: 52, y: 43, width: 16, height: 8,
                        description: 'SB:rot-c',
                        zIndex: 10,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDrawerTop) return;
                            const rot = ensureLetterRot();
                            rot.c = ((rot.c || 0) + 90) % 360;
                            playSE('se-click');
                            renderCanvasRoom();
                        }, { allowAtNight: true }),
                        description: 'ÂõûËª¢„Éú„Çø„É≥Ôºöc', zIndex: 5,
                        item: { img: 'button', visible: () => true }
                    },

                    // ÂõûËª¢„Éú„Çø„É≥Ôºök
                    {
                        x: 72, y: 43, width: 16, height: 8,
                        description: 'SB:rot-k',
                        zIndex: 10,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDrawerTop) return;
                            const rot = ensureLetterRot();
                            rot.k = ((rot.k || 0) + 90) % 360;
                            playSE('se-click');
                            renderCanvasRoom();
                        }, { allowAtNight: true }),
                        description: 'ÂõûËª¢„Éú„Çø„É≥Ôºök', zIndex: 5,
                        item: { img: 'button', visible: () => true }
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('main');
                        }, { allowAtNight: true }),
                        description: 'ÊñáÂ≠óÁõ§Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            nabeInner: {
                name: 'ÈçãÂÜÖÈÉ®',
                description: '',
                clickableAreas: [

                    {
                        x: 56.0, y: 47.2, width: 17.1, height: 16.0,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundCore', 'core', 'Áô∫ÂÖâ„Ç≥„Ç¢„Åå„ÅÇ„Çã', IMAGES.items.core, 'Áô∫ÂÖâ„Ç≥„Ç¢„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇ„Å©„ÅÜ„ÇÑ„Çâ„ÄÅ„Åì„ÅÆÂ∑•Êàø„Å´ÊÆã„Å£„Å¶„ÅÑ„ÇãÁô∫ÂÖâ„Ç≥„Ç¢„ÅØ„Åì„Çå„Å†„Åë„ÅÆ„Çà„ÅÜ„Å†‚Ä¶');
                        }),
                        description: 'Áô∫ÂÖâ„Ç≥„Ç¢',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundCore,
                        item: { img: 'core', visible: () => !gameState.main.flags.foundCore }
                    },
                    {
                        x: 26.4, y: 26.3, width: 15.8, height: 14.3,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundRecipe1', 'recipe1', '‰Ωï„Åã„ÅÆ„É¨„Ç∑„Éî„Å†', IMAGES.items.recipe1, 'Á†¥„Çå„Åü„É¨„Ç∑„Éî„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        }),
                        description: '„É¨„Ç∑„Éî',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundRecipe1,
                        item: { img: 'recipe1', visible: () => !gameState.main.flags.foundRecipe1 }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('main');
                        }, { allowAtNight: true }),
                        description: 'ÈçãÂÜÖÈÉ®Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },

                ]
            },

            drawerInner: {
                name: '„Éû„Ç∑„É≥‰∏ãÂºï„ÅçÂá∫„ÅóÂÜÖÈÉ®',
                description: '',
                clickableAreas: [
                    {
                        x: 58.7, y: 49.5, width: 21.2, height: 20.7,
                        onClick: clickWrap(function () {
                            showObj('unlockMachine', '', IMAGES.items.memo, 'Èå¨Êàê„É°„É¢„Å†', IMAGES.items.memoEn);
                        }),
                        description: 'Èå¨Êàê„É°„É¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'memo', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('main');
                        }, { allowAtNight: true }),
                        description: '„Éû„Ç∑„É≥‰∏ãÂºï„ÅçÂá∫„ÅóÂÜÖÈÉ®Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },

                ]
            },
            drawerTopInner: {
                name: '„Éâ„Ç¢Èù¢Âºï„ÅçÂá∫„Åó‰∏äÊÆµÂÜÖÈÉ®',
                description: '',
                clickableAreas: [
                    {
                        x: 56.9, y: 30.8, width: 23.5, height: 17.6,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundKey', 'key', 'Èçµ„Çí„Åø„Å§„Åë„Åü', IMAGES.items.key, 'Èçµ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        }),
                        description: 'Èçµ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundKey,
                        item: { img: 'key', visible: () => !gameState.main.flags.foundKey }
                    },
                    {
                        x: 39.8, y: 53.2, width: 22.7, height: 20.9,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.memoAdvance, '„É°„É¢„Åå„ÅÇ„Çã', IMAGES.items.memoAdvanceEn);
                        }),
                        description: 'ËøΩÂä†„É°„É¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'memoAdvance', visible: () => true }
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('mainDoor');
                        }, { allowAtNight: true }),
                        description: '„Éâ„Ç¢Èù¢Âºï„ÅçÂá∫„ÅóÂÜÖÈÉ®Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },

                ]
            },
            drawerMiddleInner: {
                name: '„Éâ„Ç¢Èù¢Âºï„ÅçÂá∫„Åó‰∏≠ÊÆµÂÜÖÈÉ®',
                description: '',
                clickableAreas: [
                    {
                        x: 26.4, y: 26.3, width: 15.8, height: 14.3,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundRecipe2', 'recipe2', '‰Ωï„Åã„ÅÆÁ¥ôÂàá„Çå„Å†', IMAGES.items.recipe2, 'Á†¥„Çå„ÅüÁ¥ôÁâá„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        }),
                        description: '„É¨„Ç∑„Éî',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundRecipe2,
                        item: { img: 'recipe2', visible: () => !gameState.main.flags.foundRecipe2 }
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('mainDoor');
                        }, { allowAtNight: true }),
                        description: '„Éâ„Ç¢Èù¢Âºï„ÅçÂá∫„ÅóÂÜÖÈÉ®Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },

                ]
            },
            drawerBottomInner: {
                name: '„Éâ„Ç¢Èù¢Âºï„ÅçÂá∫„Åó‰∏ãÊÆµÂÜÖÈÉ®',
                description: '',
                clickableAreas: [
                    {
                        x: 39.2, y: 21.2, width: 34.0, height: 31.7,
                        onClick: clickWrap(function () {
                            showModal(
                                '<div style="text-align:center;">Êú¨„Åå„ÅÇ„Çã„ÄÇË™≠„Åø„Åæ„Åô„ÅãÔºü</div>',
                                '',
                                [
                                    {
                                        text: '„ÅØ„ÅÑ',
                                        action: () => {
                                            changeRoom('book1');
                                            closeModal();
                                        }
                                    },
                                    {
                                        text: '„ÅÑ„ÅÑ„Åà', action: () => {
                                            closeModal();
                                            updateMessage('');
                                            return false;
                                        }
                                    }]
                            );
                        }),
                        description: 'Êú¨',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'book', visible: () => true }
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('mainDoor');
                        }, { allowAtNight: true }),
                        description: '„Éâ„Ç¢Èù¢Âºï„ÅçÂá∫„ÅóÂÜÖÈÉ®Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },

                ]
            },
            alchemyRoom: {
                name: 'Èå¨Êàê„Éû„Ç∑„É≥',
                description: '',
                clickableAreas: [
                    {
                        x: 18.6, y: 13.2, width: 19.8, height: 18.9,
                        onClick: clickWrap(function () {
                            alchemyHandleSlotClick(1);
                        }),
                        description: 'Á¥†Êùê1„Çπ„É≠„ÉÉ„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: () => ensureAlchemyState().slot1, visible: () => !!ensureAlchemyState().slot1 }
                    },
                    {
                        x: 54.9, y: 13.0, width: 19.9, height: 19.3,
                        onClick: clickWrap(function () {
                            alchemyHandleSlotClick(2);
                        }),
                        description: 'Á¥†Êùê2„Çπ„É≠„ÉÉ„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: () => ensureAlchemyState().slot2, visible: () => !!ensureAlchemyState().slot2 }
                    },
                    {
                        x: 77.0, y: 37.8, width: 18.8, height: 11.1,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem === 'recipeFixed') {
                                const f = ensureAlchemyState();
                                f.spellText = 'unit';
                                const inp = document.getElementById('alchemySpellInput');
                                if (inp) inp.value = 'unit';
                                renderCanvasRoom?.();
                                playSE('se-cyber');
                                showModal('QR„Ç≥„Éº„Éâ„ÇíË™≠„ÅøÂèñ„Å£„Åü', '', [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                                return;
                            }
                            updateMessage('‰Ωï„Åã„ÇíË™≠„ÅøÂèñ„Çå„Åù„ÅÜ„Å†');
                        }),
                        description: 'QRË™≠„ÅøÂèñ„ÇäÈÉ®',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 76.7, y: 52.0, width: 19.2, height: 16.2,
                        onClick: clickWrap(function () {
                            openAlchemySpellInputModal();
                        }),
                        description: 'Âë™ÊñáÂÖ•Âäõ„Éë„Éç„É´',
                        zIndex: 1,
                        usable: () => true
                    },
                    {
                        x: 77.6, y: 61.9, width: 17.9, height: 5.6,
                        onClick: clickWrap(function () {
                            openAlchemySpellInputModal();
                        }),
                        description: 'Âë™ÊñáË°®Á§∫Ê¨Ñ',
                        zIndex: 5,
                        usable: () => false
                    },
                    {
                        x: 77.0, y: 76.4, width: 18.8, height: 9.7,
                        onClick: clickWrap(function () {
                            alchemyStartSynthesis();
                        }),
                        description: 'Èå¨ÊàêGO„Éú„Çø„É≥',
                        zIndex: 5,
                        usable: () => true
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {

                            changeRoom('main');
                        }, { allowAtNight: true }),
                        description: 'Èå¨Êàê„É´„Éº„É†Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            book1: {
                name: 'ÁµµÊú¨1„Éö„Éº„Ç∏ÁõÆ',
                description: '',
                clickableAreas: [
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('book2');
                        }, { allowAtNight: true }),
                        description: 'Êú¨ÔºëÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('main');
                        }, { allowAtNight: true }),
                        description: 'Êú¨Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                    {
                        x: 45,      // ‰∏≠Â§ÆÂØÑ„ÅõÔºà50Âü∫Ê∫ñ„ÅßÂ∞ë„ÅóÂ∑¶Ôºâ
                        y: 90,      // ‰∏ÄÁï™‰∏ã
                        width: 10,
                        height: 10,
                        onClick: clickWrap(function () {
                            uiLang = (uiLang === 'jp') ? 'en' : 'jp';
                            // playSE('se-change');
                            renderCanvasRoom();
                        }),
                        description: 'Language Toggle',
                        zIndex: 10,
                        item: {
                            img: () => uiLang === 'jp' ? 'lang_en' : 'lang_jp',
                            visible: () => true
                        }
                    }
                ]
            },
            book2: {
                name: 'ÁµµÊú¨2„Éö„Éº„Ç∏ÁõÆ',
                description: '',
                clickableAreas: [

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('book1');
                        }, { allowAtNight: true }),
                        description: 'Êú¨ÔºíÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('main');
                        }, { allowAtNight: true }),
                        description: 'Êú¨Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                    {
                        x: 45,      // ‰∏≠Â§ÆÂØÑ„ÅõÔºà50Âü∫Ê∫ñ„ÅßÂ∞ë„ÅóÂ∑¶Ôºâ
                        y: 90,      // ‰∏ÄÁï™‰∏ã
                        width: 10,
                        height: 10,
                        onClick: clickWrap(function () {
                            uiLang = (uiLang === 'jp') ? 'en' : 'jp';
                            // playSE('se-change');
                            renderCanvasRoom();
                        }),
                        description: 'Language Toggle',
                        zIndex: 10,
                        item: {
                            img: () => uiLang === 'jp' ? 'lang_en' : 'lang_jp',
                            visible: () => true
                        }
                    }
                ]
            },

            endWorse: {
                name: 'ÈÄÉ‰∫°„Ç®„É≥„Éâ',
                description: '‰æùÈ†º„Åã„ÇâÈÄÉ‰∫°„Åó„Å¶ËÑ±Âá∫„Åó„Åæ„Åó„Åü„ÄÇ',
                clickableAreas: [

                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            showEndingReport('endWorse');
                        }),
                        description: 'ÈÄÉ‰∫°„Ç®„É≥„Éâ'
                    },


                ]
            },
            end: {
                name: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ',
                description: '‰æùÈ†ºÂìÅ„Çí„Åç„Å°„Çì„Å®‰ΩúÊàê„Åó„Å¶ËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
                clickableAreas: [
                    {
                        x: 31.1, y: 4.2, width: 36.7, height: 33.0,
                        onClick: clickWrap(function () {
                            updateMessage('„Åç„Çå„ÅÑ„Å™„Éè„Éº„Éà„ÅÆËä±ÁÅ´„Å†');
                        }),
                        description: '„Åç„Çå„ÅÑ„Å™„Éè„Éº„Éà„ÅÆËä±ÁÅ´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 68.4, y: 22.9, width: 14.8, height: 15.0,
                        onClick: clickWrap(function () {
                            updateMessage('„ÇØ„ÉûÂ¶ñÁ≤æ„Å†');
                        }),
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            showEndingReport('end');
                        }),
                        description: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ'
                    },


                ]
            },


            trueEnd: {
                name: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                description: '„Éü„É©„ÇØ„É´Ëä±ÁÅ´„ÇíÊâì„Å°‰∏ä„Åí„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
                clickableAreas: [
                    {
                        x: 35.2, y: 6.8, width: 30.7, height: 24.1,
                        onClick: clickWrap(function () {
                            const f = gameState.main.flags || (gameState.main.flags = {});
                            if (gameState.selectedItem === 'luckyHammer') {
                                if (hasItem('onigiri') || f.giveOnigiri) {
                                    updateMessage('„ÇÇ„ÅÜ„Åä„Å´„Åé„Çä„ÅØ„ÅÇ„Çã„ÄÇ');
                                    return;
                                }
                                showModal(
                                    '„É©„ÉÉ„Ç≠„Éº„Éè„É≥„Éû„Éº„Çí‰Ωø„Å£„Åü',
                                    `<img src="${IMAGES.modals.onigiriHammer}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [
                                        {
                                            text: '„Å§„Å•„Åë„Çã',
                                            action: () => {
                                                window._nextModal = {
                                                    title: '„Åä„Å´„Åé„Çä„Åå„Åß„Åç„Åü',
                                                    content: `<img src="${IMAGES.items.onigiri}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                                    buttons: [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                                };
                                                addItem('onigiri');
                                                closeModal();
                                                updateMessage('„Åä„Å´„Åé„Çä„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇ');
                                            }
                                        }
                                    ]
                                );
                                return;
                            }
                            updateMessage('„Åä„Å´„Åé„ÇäËä±ÁÅ´„Å†„ÄÇ');
                        }),
                        description: '„Åä„Å´„Åé„ÇäËä±ÁÅ´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 77.2, y: 62.8, width: 19.8, height: 20.3,
                        onClick: clickWrap(function () {
                            const f = gameState.main.flags || (gameState.main.flags = {});
                            if (gameState.selectedItem === 'onigiri') {
                                removeItem('onigiri');
                                f.giveOnigiri = true;
                                renderCanvasRoom();
                                updateMessage('„ÇØ„ÉûÂ¶ñÁ≤æ„Å´„Åä„Å´„Åé„Çä„ÇíÊ∏°„Åó„Åü„ÄÇ');
                                return;
                            }
                            updateMessage('„ÇØ„ÉûÂ¶ñÁ≤æ„Åå„Åä„Å´„Åé„Çä„ÇíÊ¨≤„Åó„Åù„ÅÜ„Å´Ë¶ã„Å¶„ÅÑ„Çã„ÄÇ');
                        }),
                        description: '„ÇØ„ÉûÂ∏åÊúõ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.giveOnigiri,
                        item: { img: 'bearHope', visible: () => !gameState.main.flags.giveOnigiri }
                    },
                    {
                        x: 74.6, y: 60.8, width: 24.8, height: 22.1,
                        onClick: clickWrap(function () {
                            showObj(null, '„Åà„Å∏„Å∏', IMAGES.modals.bearHappy, '„ÇØ„ÉûÂ¶ñÁ≤æ„Åå„Åä„Å´„Åé„Çä„ÇíÈ£ü„Åπ„Å¶„ÅÑ„Çã„ÄÇ');
                        }),
                        description: '„ÇØ„Éû„Åä„Å´„Åé„Çä',
                        zIndex: 5,
                        usable: () => gameState.main.flags.giveOnigiri,
                        item: { img: 'bearOnigiri', visible: () => gameState.main.flags.giveOnigiri }
                    },

                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            updateMessage('„Éü„É©„ÇØ„É´Ëä±ÁÅ´„ÇíÊâì„Å°‰∏ä„Åí„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ');
                            showEndingReport('trueEnd');
                        }),
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                        usable: () => true,
                    },

                ]
            },

        };

        const hintMessages = {

            main: {
                bear: [

                ],

            },
        };

        // Ë∂≥Èü≥„ÅßÊï∞Ê≠©‚Üí„ÉØ„Éº„ÉóÊºîÂá∫‚ÜíÁõÆÁöÑ„ÅÆÈÉ®Â±ã„Å∏
        function travelWithSteps(destRoom = 'end', color = '#000') {
            const canvasEl = document.getElementById('gameCanvas');
            const overlay = document.getElementById('roomEffectOverlay');

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-ashioto');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = color;  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;

                if (step >= 3) {
                    clearInterval(stepTimer);

                    if (overlay) {
                        changeRoom(destRoom);
                    }

                    setTimeout(() => {

                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            // overlay.style.background = '';
                            overlay.style.opacity = 0;

                        }

                    }, 100);
                }
            }, 160);
        }

        function travelWithStepsTrueEnd() {
            const overlay = document.getElementById('roomEffectOverlay');
            let destRoom = 'trueEnd';
            if (gameState.main.flags.watchOutside) {
                gameState.trueEnd.flags.backgroundState++;
            }

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-ashioto');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#fff';
                overlay.style.opacity = 1;
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;


                if (step >= 3) {
                    clearInterval(stepTimer);

                    // Èªí‚Üí„ÉØ„Éº„ÉóÂÖâ„Å∏ÂàáÊõø
                    if (overlay) {
                        overlay.classList.add('warp-active');
                        changeRoom(destRoom);
                        overlay.style.background = '';   // warp „ÅÆÁôΩÁô∫ÂÖâ„Å´Êàª„Åô
                    }

                    setTimeout(() => {


                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            overlay.classList.remove('warp-active');
                            overlay.style.opacity = 0;
                        }

                    }, 900);
                }
            }, 260);
        }



        function quickBlackFade(duration = 300) {
            const fade = document.getElementById('roomEffectOverlay');
            if (!fade) return;

            // „Åæ„Åö‰∏ÄÁû¨„ÅßÈªí„Åè„Åô„Çã
            fade.style.background = '#000';
            fade.style.opacity = '1';

            // duration ms Âæå„Å´ÈÄèÊòé„Å∏Êàª„Åô
            setTimeout(() => {
                fade.style.opacity = '0';
            }, duration);
        }

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            renderNavigation();
            changeRoom('mainDoor');
            updateMessage('Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØ„Å®„ÅÇ„ÇãÂ∑•Êàø„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü');
            try { renderStatusIcons(); } catch (e) { }
        }

        function findHitArea(x, y, clickableAreas, canvas) {
            // zIndexÈôçÈ†Ü„Åß
            const sorted = clickableAreas.slice().sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            for (const area of sorted) {
                // ÂøÖË¶Å„Å™„ÇâusableÂà§ÂÆö„ÇÇ„Åì„Åì„Åß
                const usable = area.usable === undefined ? true :
                    (typeof area.usable === "function" ? area.usable() : area.usable);

                if (!usable) continue; // ‰Ωø„Åà„Å™„ÅÑ„Ç®„É™„Ç¢„ÅØÂà§ÂÆö„Åó„Å™„ÅÑ
                const ax = area.x / 100 * canvas.width;
                const ay = area.y / 100 * canvas.height;
                const aw = area.width / 100 * canvas.width;
                const ah = area.height / 100 * canvas.height;
                if (x >= ax && x <= ax + aw && y >= ay && y <= ay + ah) {
                    return area; // ÊúÄÂàù„Å´„Éí„ÉÉ„Éà„Åó„Åü„ÇÇ„ÅÆ„Å†„ÅëËøî„ÅôÔºÅ
                }
            }
            return null;
        }

        let hoveredAreaIndex = null;  // ‰ªähover„Åó„Å¶„Çã„Ç®„É™„Ç¢Ôºà„Å™„Åë„Çå„Å∞nullÔºâ
        canvas.addEventListener('mousemove', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);
            const idx = area ? room.clickableAreas.indexOf(area) : null;
            if (hoveredAreaIndex !== idx) {
                hoveredAreaIndex = idx;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('mouseout', function () {
            if (hoveredAreaIndex !== null) {
                hoveredAreaIndex = null;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('click', function (e) {

            // ÂÖ•Âäõ„É≠„ÉÉ„ÇØ‰∏≠„ÅØ„ÇØ„É™„ÉÉ„ÇØÁÑ°ÂäπÔºàÊºîÂá∫‰∏≠„Å™„Å©Ôºâ
            if (gameState.fx && gameState.fx.lockInput) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // ‚òÖ‰ªä„ÅÑ„ÇãÈÉ®Â±ã„ÅÆ„Ç®„É™„Ç¢„Å†„ÅëÂà§ÂÆöÔºÅ
            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);

            // if (area) {
            //     handleAreaClick(area.action, e);
            // }
            if (area) {
                if (typeof area.onClick === 'function') {
                    area.onClick(e);
                    playSE('se-click');
                } else if (area.action) {
                    handleAreaClick(area.action, e); // ‰∫íÊèõ„ÅÆ„Åü„ÇÅ„Å´ÊÆã„Åó„Å¶„ÇÇOK
                }
            }
        });

        function changeRoom(roomId) {
            const prevRoom = gameState.currentRoom;
            // alchemyRoom „Åã„ÇâÂá∫„Çã„Å®„Åç„ÅØ„ÄÅ„Çπ„É≠„ÉÉ„Éà„Å´ÁΩÆ„ÅÑ„ÅüÁ¥†Êùê„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Å∏Êàª„Åô
            if (prevRoom === 'alchemyRoom' && roomId !== 'alchemyRoom') {
                try { alchemyReturnItemsToInventory(); } catch (e) { }
            }
            if (roomId === 'stringBoard') ensureLetterRot(true); // ‚òÖÂÖ•ÂÆ§ÊôÇ„Å†„ÅëÂàùÊúüÂåñ
            gameState.currentRoom = roomId;
            const room = rooms[roomId];

            // ËÉåÊôØÔºã„Ç¢„Ç§„ÉÜ„É†Ôºã„ÇØ„É™„ÉÉ„ÇØ„Ç®„É™„Ç¢„Çícanvas„ÅßÂÖ®ÈÉ®ÂÜçÊèèÁîª
            renderCanvasRoom();
            const msg = (room.name && room.name.trim() !== "")
                ? `${room.name}„Åß„Åô„ÄÇ${room.description}`
                : room.description;
            if (roomId === 'trueEnd') {
                updateMessageHTML(msg);
            } else {
                updateMessage(msg);
            }

            // BGMÂàáÊõø„ÅØ„Åù„ÅÆ„Åæ„Åæ
            if (roomId === "trueEnd" || roomId === "trueEnd2") {
                changeBGM("sounds/29/Prosit!.mp3");

            } else if (roomId === "endWorse") {
                changeBGM("sounds/29/Egoist.mp3");

            } else if (roomId === "end") {
                changeBGM("sounds/29/Toy_Carnival.mp3");

            } else if (gameState.main.flags.kaniDead) {
                changeBGM("sounds/28/Ayamachi_No_Daisho-1(Slow).mp3");

            } else {
                changeBGM("sounds/29/maho_hakoniwa.mp3");

            }

            // nav
            // if (roomId === "corridor") {
            //     addNaviItem(roomId);
            //     renderNavigation();
            // }
            if (roomId === "trueEnd" || roomId === "end" || roomId === "endWorse") {
                gameState.openRooms = [];
                // renderNavigation();
            }
            renderNavigation();
        }

        const END_IDS = new Set(['end', 'endWorse', 'trueEnd']);

        // ===== changeRoom „Éï„ÉÉ„ÇØÔºö=====
        const _changeRoom_custom = changeRoom;
        changeRoom = function (roomId) {
            _changeRoom_custom.apply(this, arguments);

            if (roomId === 'end') {
                const f = gameState.main.flags || (gameState.main.flags = {});
                if (f.playHanabiOnEnd) {
                    f.playHanabiOnEnd = false;
                    playSE?.('se-hanabi');
                }
            }

            if (END_IDS.has(roomId)) {
                const elapsed = Math.round((Date.now() - ANA.start) / 1000);
                ANA.endTimes = ANA.endTimes || {};
                if (!ANA.endTimes[roomId]) ANA.endTimes[roomId] = elapsed;

                const isTrue = (roomId === 'trueEnd');
                ANA.send('ending_reached', {
                    ending_id: roomId,
                    is_true: isTrue,
                    elapsed_sec: elapsed,
                    hints: ANA.hintCount,

                });
                // setTimeout(() => showFeedbackModal(roomId), 1500);
            }
        };// =========================
        // Alchemy Room (Èå¨Êàê„Éû„Ç∑„É≥) „É≠„Ç∏„ÉÉ„ÇØ
        // =========================
        const ALCHEMY_RECIPES = [
            { materials: ['gemRed', 'core'], spell: 'unit', result: 'redSphere' },
            { materials: ['gemBlue', 'driver'], spell: 'power', result: 'miracleDriver' },
            { materials: ['gemBlue', 'gemRed'], spell: 'nori', result: 'gemViolet' },
            { materials: ['gemViolet', 'gemGreen'], spell: 'ume', result: 'gemOnigiri' },
            { materials: ['gemOnigiri', 'redSphere'], spell: 'sake', result: 'onigiriSphere' },
            { materials: ['gemViolet', 'hammer'], spell: 'sachi', result: 'luckyHammer' },
        ];

        function ensureAlchemyState() {
            if (!gameState.alchemyRoom) gameState.alchemyRoom = { flags: {} };
            const f = gameState.alchemyRoom.flags || (gameState.alchemyRoom.flags = {});
            if (!('slot1' in f)) f.slot1 = null;
            if (!('slot2' in f)) f.slot2 = null;
            if (!('spellText' in f)) f.spellText = '';
            if (!('isSynthesizing' in f)) f.isSynthesizing = false;
            return f;
        }

        function normalizeSpell(s) {
            return String(s ?? '').trim().replace(/\s+/g, ' ').toUpperCase();
        }

        function alchemyGetSlotsSorted(f) {
            const a = f.slot1;
            const b = f.slot2;
            if (!a || !b) return null;
            return [a, b].slice().sort();
        }

        function alchemyClearSlots(f) {
            f.slot1 = null;
            f.slot2 = null;
            renderCanvasRoom();
        }

        function alchemyReturnItemsToInventory() {
            const f = ensureAlchemyState();
            if (f.isSynthesizing) return; // Èå¨Êàê‰∏≠„ÅØËß¶„Çâ„Å™„ÅÑ
            const toReturn = [f.slot1, f.slot2].filter(Boolean);
            if (toReturn.length === 0) return;
            toReturn.forEach(it => addItem(it));
            alchemyClearSlots(f);
            updateInventoryDisplay();
        }

        function alchemySetSlot(slotNo, itemId) {
            const f = ensureAlchemyState();
            const key = slotNo === 1 ? 'slot1' : 'slot2';

            // Êó¢„Å´ÂÖ•„Å£„Å¶„Åü„Çâ„Ç§„É≥„Éô„É≥„Éà„É™„Å∏Êàª„ÅôÔºàswap or pickÔºâ
            if (f[key]) addItem(f[key]);

            f[key] = itemId || null;
            renderCanvasRoom();
            updateInventoryDisplay();
        }

        function alchemyHandleSlotClick(slotNo) {
            const f = ensureAlchemyState();
            if (f.isSynthesizing) return;

            const selected = gameState.selectedItem; // „Ç§„É≥„Éô„É≥„Éà„É™„ÅßÈÅ∏Êäû‰∏≠„ÅÆ„Ç¢„Ç§„ÉÜ„É†ID
            const key = slotNo === 1 ? 'slot1' : 'slot2';

            // ‰Ωï„ÇÇÈÅ∏Êäû„Åó„Å¶„ÅÑ„Å™„ÅÑ ‚Üí „Çπ„É≠„ÉÉ„Éà„Åã„ÇâÂõûÂèé
            if (!selected) {
                if (!f[key]) {
                    updateMessage('ÔºàÁ¥†Êùê„ÇíÈÅ∏„Çì„Åß„Åã„Çâ„Åì„Åì„Å´ÁΩÆ„Åë„ÇãÔºâ');
                    return;
                }
                addItem(f[key]);
                f[key] = null;
                renderCanvasRoom();
                updateInventoryDisplay();
                updateMessage('Á¥†Êùê„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Å´Êàª„Åó„Åü„ÄÇ');
                return;
            }

            // ÈÅ∏Êäû‰∏≠ ‚Üí ÁΩÆ„ÅèÔºà„Ç§„É≥„Éô„É≥„Éà„É™„Åã„Çâ„ÅØ‰∏ÄÊó¶Ê∂à„Åà„ÇãÔºâ
            removeItem(selected);
            // ÈÅ∏ÊäûËß£Èô§ÔºàremoveItem „Åå„ÇÑ„Å£„Å¶„Åè„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„Å´ÂÇô„Åà„Å¶‰øùÈô∫Ôºâ
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;

            // Êó¢„Å´ÂÖ•„Å£„Å¶„Åü„ÇâÊàª„Åó„Å¶„Åã„Çâ„Çª„ÉÉ„ÉàÔºàswapÔºâ
            if (f[key]) addItem(f[key]);
            f[key] = selected;

            renderCanvasRoom();
            updateInventoryDisplay();
            updateMessage('Á¥†Êùê„Çí„Çª„ÉÉ„Éà„Åó„Åü„ÄÇ');
        }

        function openAlchemySpellInputModal() {
            const f = ensureAlchemyState();
            if (f.isSynthesizing) return;

            const content = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:8px;">
            <div style="font-size:0.95em;opacity:0.9;">Âë™Êñá„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠ÔºàÂ§ßÊñáÂ≠ó„ÉªÂ∞èÊñáÂ≠ó„ÅØÊ∞ó„Å´„Åó„Å™„ÅÑÔºâ</div>
            <input id="alchemySpellInput" class="puzzle-input" type="text" maxlength="32" value="${(f.spellText || '').replace(/"/g, '&quot;')}" />
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <button id="alchemySpellOk" class="ok-btn">OK</button>
                <button id="alchemySpellClear" class="nav-btn" style="background:#666;color:#fff;">Ê∂à„Åô</button>
            </div>
        </div>
    `;
            showModal('Âë™ÊñáÂÖ•Âäõ', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);

            setTimeout(() => {
                const inp = document.getElementById('alchemySpellInput');
                const ok = document.getElementById('alchemySpellOk');
                const clear = document.getElementById('alchemySpellClear');
                if (!inp || !ok || !clear) return;

                inp.focus();

                const apply = () => {
                    const t = String(inp.value ?? '').trim();
                    f.spellText = t;
                    renderCanvasRoom();
                    updateMessage(t ? `Âë™Êñá„Çí„Çª„ÉÉ„Éà„Åó„ÅüÔºö${t}` : 'Âë™Êñá„ÇíÊ∂à„Åó„Åü„ÄÇ');
                    closeModal();
                };

                ok.addEventListener('click', apply);
                inp.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') apply();
                });
                clear.addEventListener('click', () => {
                    inp.value = '';
                    apply();
                });
            }, 0);
        }

        function alchemyFindRecipe() {
            const f = ensureAlchemyState();
            const mats = alchemyGetSlotsSorted(f);
            if (!mats) return null;
            const spell = normalizeSpell(f.spellText);
            if (!spell) return null;

            for (const r of ALCHEMY_RECIPES) {
                const rm = (r.materials || []).slice().sort();
                if (rm.length !== 2) continue;
                if (rm[0] !== mats[0] || rm[1] !== mats[1]) continue;
                if (normalizeSpell(r.spell) !== spell) continue;
                return r;
            }
            return null;
        }

        function alchemyStartSynthesis() {
            const f = ensureAlchemyState();
            if (f.isSynthesizing) return;

            if (!f.slot1 || !f.slot2) {
                updateMessage('Á¥†Êùê„Åå2„Å§ÂøÖË¶Å„ÄÇ');
                screenFlash('red', 160);
                return;
            }
            if (!String(f.spellText || '').trim()) {
                updateMessage('Âë™Êñá„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÄÇ');
                screenFlash('red', 160);
                return;
            }

            f.isSynthesizing = true;

            // ‚òÖ „Åì„ÅìÔºöÈå¨Êàê‰∏≠„Ç¢„Éã„É°Áî®„ÅÆ2ÊûöÁîªÂÉè
            const animImgs = [
                IMAGES.modals.rensei1,
                IMAGES.modals.rensei2
            ].filter(Boolean);

            // Èå¨Êàê‰∏≠„É¢„Éº„ÉÄ„É´Ôºà2Êûö‰∫§‰∫í„Ç¢„Éã„É°Ôºâ
            const content = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:6px;">
            <div style="font-size:1.1em;font-weight:bold;">Èå¨Êàê‰∏≠‚Ä¶</div>
            <div style="width:360px;height:360px;display:flex;align-items:center;justify-content:center;">
                <img id="alchemyAnimImg"
                     src="${(animImgs[0] || IMAGES.items.core || '')}"
                     style="width:300px;height:300px;image-rendering:pixelated;" />
            </div>
            <div style="font-size:0.95em;opacity:0.85;">Ôºà„Ç¥„Ç¥„Ç¥‚Ä¶Ôºâ</div>
        </div>
    `;
            showModal('Èå¨Êàê', content, []); // „Éú„Çø„É≥ÁÑ°„Åó
            playSE('se-scene-change');

            // ‚òÖ ÁµêÊûúÂá¶ÁêÜ„ÇíÈñ¢Êï∞ÂåñÔºà„Ç¢„Éã„É°Âæå„Å´Âëº„Å∂Ôºâ
            const finish = () => {
                closeModal();

                const recipe = alchemyFindRecipe();

                if (!recipe) {
                    // Â§±ÊïóÔºöÁÖôÔºã‰Ωï„ÇÇËµ∑„Åç„Å™„ÅÑ„ÄÇÁ¥†Êùê„ÅØÊàª„Åô„ÄÇ
                    screenFlash('red', 220);
                    try { playSE?.('se-boko'); } catch (e) { }
                    showModal('‚Ä¶‚Ä¶', `
                <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:6px;">
                    <div style="font-size:64px;line-height:1;">üí®</div>
                    <div style="font-size:1.05em;">‰Ωï„ÇÇËµ∑„Åç„Å™„Åã„Å£„Åü</div>
                </div>
            `, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                    updateMessage('‰Ωï„ÇÇËµ∑„Åç„Å™„Åã„Å£„Åü');

                    alchemyReturnItemsToInventory();
                    f.isSynthesizing = false;
                    return;
                }

                // ÊàêÂäüÔºöÁîªÈù¢„Ç∑„Çß„Ç§„ÇØÔºãÂÆåÊàê„Ç¢„Ç§„ÉÜ„É†
                screenFlash('white', 260);
                try { playSE?.('se-clear'); } catch (e) { }
                recipeCodexUnlock(recipe);
                const resultId = recipe.result;
                const img = IMAGES.items[resultId];

                if (resultId === 'gemViolet' && hasItem('gemViolet')) {
                    showModal('„Åô„Åß„Å´ÊâÄÊåÅ„Åó„Å¶„ÅÑ„ÇãÁµÑ„ÅøÂêà„Çè„Åõ„Å†', '', [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                    alchemyReturnItemsToInventory();
                    f.isSynthesizing = false;
                    return;
                }

                f.slot1 = null;
                f.slot2 = null;
                renderCanvasRoom();

                if (resultId === 'miracleDriver') {
                    const mf = gameState.main.flags || (gameState.main.flags = {});
                    mf.hasMiracleDriver = true;
                }
                if (resultId === 'luckyHammer') {
                    const mf = gameState.main.flags || (gameState.main.flags = {});
                    mf.hasLuckyHammer = true;
                }
                if (resultId === 'onigiriSphere') {
                    const gf = gameState.flags || (gameState.flags = {});
                    gf.trueEndUnlocked = true;
                }

                if (resultId) addItem(resultId);
                updateInventoryDisplay();
                if (resultId === 'redSphere') {
                    showToast('Ê≥®Êñá„ÅÆÂìÅ„Åå„Åß„Åç„Åü„ÄÇÂ§ñ„Å´Âá∫„Çâ„Çå„Åù„ÅÜ„Å†');
                }

                const itemHtml = img
                    ? `<img src="${img}" style="width:160px;height:160px;image-rendering:pixelated;"/>`
                    : `<div style="font-size:1.1em;font-weight:bold;">${resultId}</div>`;

                showModal('ÊàêÂäüÔºÅ', `
            <div id="alchemySuccessBox" style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:6px;">
                ${getItemName(itemHtml)}
                <div style="font-size:1.05em;">ÂÆåÊàê„Åó„ÅüÔºÅ</div>
            </div>
        `, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                updateMessage('ÂÆåÊàê„Åó„ÅüÔºÅ');

                setTimeout(() => {
                    const box = document.getElementById('alchemySuccessBox');
                    if (!box) return;
                    document.documentElement.classList.add('fx-shake');
                    setTimeout(() => document.documentElement.classList.remove('fx-shake'), 180);
                }, 0);

                f.isSynthesizing = false;
            };

            // ‚òÖ 2Êûö„Çí‰∫§‰∫í„Å´„Äå8Âõû„ÄçÂàá„ÇäÊõø„ÅàÔºàÔºù4ÂæÄÂæ©Ôºâ
            // ÁîªÂÉè„Åå2Êûö„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÂÖÉ„ÅÆ900msÂæÖ„Å°Áõ∏ÂΩì„Åßfinish„Å´ÈÄ≤„ÇÅ„Çã
            if (animImgs.length < 2) {
                setTimeout(finish, 900);
                return;
            }

            const imgEl = document.getElementById('alchemyAnimImg');
            let count = 0;     // ÂàáÊõøÂõûÊï∞
            let idx = 0;       // 0/1
            const intervalMs = 100; // Â•Ω„Åø„Åß 200„Äú300ms

            const timer = setInterval(() => {
                // „É¢„Éº„ÉÄ„É´„ÅåÈñâ„Åò„Çâ„Çå„Å¶„Åü„ÇäDOM„ÅåÊ∂à„Åà„Å¶„Åü„ÇâÂÆâÂÖ®ÁµÇ‰∫Ü
                if (!imgEl) {
                    clearInterval(timer);
                    f.isSynthesizing = false;
                    return;
                }

                idx = 1 - idx;
                imgEl.src = animImgs[idx];
                count++;

                if (count >= 8) {
                    clearInterval(timer);
                    finish();
                }
            }, intervalMs);
        }


        function renderCanvasRoom() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const roomId = gameState.currentRoom;
            const room = rooms[roomId];
            const bgImgSrc = getRoomBackgroundImage(roomId, gameState);

            ctx.clearRect(0, 0, canvas.width, canvas.height);


            // ËÉåÊôØÊèèÁîª
            const bgImg = loadedImages[bgImgSrc];
            if (bgImg && bgImg.complete) {
                ctx.save();
                const phase = gameState.main?.flags?.timePhase ?? 0;
                const isNight = (phase === 2);
                if (isNight) {
                    ctx.filter = 'saturate(0.3) brightness(0.6)'; // ËÉåÊôØ„ÅØ„Å°„Çá„ÅÑÊöó„ÇÅ
                } else {
                    ctx.filter = 'none';
                }
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
                ctx.restore();
            }


            // „Ç¢„Ç§„ÉÜ„É†ÊèèÁîªÔºàÊú™ÂèñÂæó„ÅÆ„ÅøÔºâ
            drawRoomItems(ctx, canvas, roomId);

            // alchemyRoom: Âë™ÊñáË°®Á§∫Ê¨Ñ„Å´„ÉÜ„Ç≠„Çπ„Éà„ÇíÊèèÁîª
            if (roomId === 'alchemyRoom') {
                const f = ensureAlchemyState();
                const spell = String(f.spellText || '').trim();
                if (spell) {
                    // Âë™ÊñáË°®Á§∫Ê¨Ñ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç®„É™„Ç¢Ôºàx:77.6,y:61.9,w:17.9,h:5.6Ôºâ„Å´Âêà„Çè„Åõ„Å¶Êèè„ÅèÔºà% ‚Üí pxÔºâ
                    const px = canvas.width * (77.6 / 100);
                    const py = canvas.height * (61.9 / 100);
                    const w = canvas.width * (17.9 / 100);
                    const h = canvas.height * (5.6 / 100);

                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    // Ë™≠„Åø„ÇÑ„Åô„ÅïÂÑ™ÂÖà„ÅßÁ∏ÅÂèñ„Çä
                    const fontSize = Math.max(12, Math.min(22, Math.floor(h * 2.2)));
                    ctx.font = `bold ${fontSize}px Arial`;
                    const cx = px + w / 2;
                    const cy = py + h / 2;
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = 'rgba(0,0,0,0.65)';
                    ctx.fillStyle = '#fff';
                    // Èï∑„Åô„Åé„ÇãÂ†¥Âêà„ÅØÊú´Â∞æ„Çí‚Ä¶
                    const maxChars = 10;
                    const disp = spell.length > maxChars ? spell.slice(0, maxChars - 1) + '‚Ä¶' : spell;
                    ctx.strokeText(disp, cx, cy);
                    ctx.fillText(disp, cx, cy);
                    ctx.restore();
                }
            }

            // stringBoard: Èçµ„Çª„ÉÉ„ÉàÂæå„ÅÆÊºîÂá∫ÔºÜ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
            if (roomId === 'stringBoard') {
                const f = gameState.main.flags || (gameState.main.flags = {});
                const until = f.stringBoardFlashUntil || 0;
                const now = Date.now();
                if (now < until) {
                    const glow = Math.min(1, (until - now) / 450);
                    const areas = [
                        { x: 12, y: 18, w: 16, h: 22 },
                        { x: 32, y: 18, w: 16, h: 22 },
                        { x: 52, y: 18, w: 16, h: 22 },
                        { x: 72, y: 18, w: 16, h: 22 },
                    ];
                    ctx.save();
                    ctx.globalAlpha = glow;
                    ctx.strokeStyle = 'rgba(80,170,255,0.95)';
                    ctx.lineWidth = 4;
                    ctx.shadowColor = 'rgba(80,170,255,0.95)';
                    ctx.shadowBlur = 18;
                    areas.forEach(a => {
                        const px = canvas.width * (a.x / 100);
                        const py = canvas.height * (a.y / 100);
                        const pw = canvas.width * (a.w / 100);
                        const ph = canvas.height * (a.h / 100);
                        ctx.strokeRect(px, py, pw, ph);
                    });
                    ctx.restore();
                }

                if (f.setKeyRevealed) {
                    const cx = canvas.width * 0.5;
                    const cy = canvas.height * 0.72;
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = 'rgba(0,0,0,0.75)';
                    ctx.fillStyle = '#fff4c4';
                    const fontSize = Math.max(16, Math.min(28, Math.floor(canvas.height * 0.045)));
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.strokeText('‚Üë‚Üì‚Üì‚Üê‚Üì', cx, cy);
                    ctx.fillText('‚Üë‚Üì‚Üì‚Üê‚Üì', cx, cy);
                    // ctx.font = `bold ${Math.max(12, Math.floor(fontSize * 0.7))}px Arial`;
                    // ctx.strokeText('The secret spell is ume', cx, cy + fontSize * 0.9);
                    // ctx.fillText('The secret spell is ume', cx, cy + fontSize * 0.9);
                    ctx.restore();
                }
            }

            // ‚òÖ „Åì„Åì„Åã„ÇâÈáç„Å™„ÇäÂÑ™ÂÖà„ÅÆhoverÊû†Á∑ö„ÇíÊèèÁîª
            if (hoveredAreaIndex !== null && hoveredAreaIndex !== undefined) {
                // zIndexÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
                const sortedAreas = room.clickableAreas
                    .map((area, i) => ({ ...area, __idx: i }))
                    .filter(area => area.usable === undefined ? true :
                        (typeof area.usable === "function" ? area.usable() : area.usable)
                    )
                    .sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
                // hoveredAreaIndex„Å®‰∏ÄËá¥„Åô„Çã„Ç®„É™„Ç¢„ÇízIndexÈ†Ü„Åß1„Å§„Å†„ÅëÊû†ÊèèÁîª
                const hoverArea = sortedAreas.find(area => area.__idx === hoveredAreaIndex);
                if (hoverArea) {
                    const ax = hoverArea.x / 100 * canvas.width;
                    const ay = hoverArea.y / 100 * canvas.height;
                    const aw = hoverArea.width / 100 * canvas.width;
                    const ah = hoverArea.height / 100 * canvas.height;
                    ctx.save();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(ax, ay, aw, ah);
                    ctx.restore();
                }
            }


            if (DEV_MODE) {
                ctx.save();
                ctx.lineWidth = 2;


                room.clickableAreas.forEach(a => {

                    ctx.strokeStyle = 'rgba(255,0,0,0.8)';
                    ctx.fillStyle = 'rgba(255,0,0,0.35)';
                    ctx.font = '14px sans-serif';
                    const px = a.x / 100 * canvas.width;
                    const py = a.y / 100 * canvas.height;
                    const pw = a.width / 100 * canvas.width;
                    const ph = a.height / 100 * canvas.height;

                    // ÂçäÈÄèÊòé„ÅÆÊû†
                    ctx.fillRect(px, py, pw, ph);
                    ctx.strokeRect(px, py, pw, ph);

                    // description Ë°®Á§∫
                    if (a.description) {
                        ctx.fillStyle = 'rgba(0,0,0,0.7)';
                        ctx.fillRect(px, py - 18, ctx.measureText(a.description).width + 8, 18);

                        ctx.fillStyle = 'white';
                        ctx.fillText(a.description, px + 4, py - 4);
                    }
                });

                ctx.restore();
            }

        }

        function drawRoomItems(ctx, canvas, roomId) {
            const room = rooms[roomId];
            const fx = gameState.fx || {};
            const km = fx.kaniMove;
            const isKaniMoving = !!(km && km.active && km.roomId === roomId);

            // ÈÄöÂ∏∏„ÅÆ„Ç¢„Ç§„ÉÜ„É†ÔºàÊºîÂá∫‰∏≠„ÅÆ„Ç´„Éã„Å†„Åë„Çπ„Ç≠„ÉÉ„ÉóÔºâ
            room.clickableAreas.forEach(area => {
                if (area.item && area.item.visible && area.item.visible()) {
                    const key = (typeof area.item.img === 'function') ? area.item.img() : area.item.img;



                    const img = loadedImages[IMAGES.items[key]];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const alpha = area.alpha ? area.alpha : 1;
                        const px = area.x / 100 * canvas.width;
                        const py = area.y / 100 * canvas.height;
                        const w = area.width / 100 * canvas.width;
                        const h = area.height / 100 * canvas.height;
                        ctx.save();
                        ctx.globalAlpha = alpha;

                        // ‚òÖ Â§ú„É¢„Éº„Éâ„Å™„ÇâÂΩ©Â∫¶ÔºãÊòé„Çã„Åï„ÇíËêΩ„Å®„Åô
                        const phase = gameState.main?.flags?.timePhase ?? 0;
                        const isNight = (phase === 2);
                        if (isNight) {
                            // ÂÄ§„ÅØÂ•Ω„Åø„ÅßË™øÊï¥
                            ctx.filter = 'saturate(0.4) brightness(0.8)';
                        } else {
                            ctx.filter = 'none';
                        }

                        // ‚òÖ drawRoomItems ÂÜÖÔºöctx.drawImage(img, px, py, w, h); „ÇíÁΩÆ„ÅçÊèõ„Åà
                        const rotDeg =
                            (area.item && typeof area.item.rotateDeg === 'function')
                                ? area.item.rotateDeg()
                                : (area.item ? area.item.rotateDeg : 0);

                        if (rotDeg) {
                            const rad = rotDeg * Math.PI / 180;
                            const cx = px + w / 2;
                            const cy = py + h / 2;

                            ctx.translate(cx, cy);
                            ctx.rotate(rad);
                            ctx.drawImage(img, -w / 2, -h / 2, w, h);
                        } else {
                            ctx.drawImage(img, px, py, w, h);
                        }


                        // ctx.drawImage(img, px, py, w, h);
                        ctx.restore();
                    }
                }
            });

            // ===== „Ç´„ÉãÁßªÂãïÊºîÂá∫Ôºàcanvas‰∏ä„ÅßÂÆüÈöõ„Å´Âãï„Åã„ÅôÔºâ =====
            if (isKaniMoving) {
                const now = (typeof performance !== 'undefined' ? performance.now() : Date.now());
                const p = Math.max(0, Math.min(1, (now - km.start) / km.duration));
                const e = easeOutCubic(p);

                const x = km.from.x + (km.to.x - km.from.x) * e;
                const y = km.from.y + (km.to.y - km.from.y) * e;
                const w = km.from.w + (km.to.w - km.from.w) * e;
                const h = km.from.h + (km.to.h - km.from.h) * e;

                // const img = loadedImages[IMAGES.items['kani']];
                const spriteKey = km.spriteKey || 'kani';
                const img = loadedImages[IMAGES.items[spriteKey]];
                if (img && img.complete && img.naturalWidth > 0) {
                    ctx.save();

                    const phase = gameState.main?.flags?.timePhase ?? 0;
                    const isNight = (phase === 2);
                    if (isNight) {
                        ctx.filter = 'saturate(0.4) brightness(0.8)';
                    } else {
                        ctx.filter = 'none';
                    }

                    ctx.drawImage(img, x, y, w, h);
                    ctx.restore();
                }

                if (p < 1) {
                    // Ê¨°„Éï„É¨„Éº„É†
                    requestAnimationFrame(() => {
                        try { renderCanvasRoom(); } catch (e) { }
                    });
                } else if (!km.done) {
                    km.done = true;
                    const cb = km.onDone;

                    // ÊºîÂá∫ÁµÇ‰∫ÜÔºö„É≠„ÉÉ„ÇØËß£Èô§ÔºÜÂæåÂá¶ÁêÜ
                    fx.kaniMove = null;
                    fx.lockInput = false;

                    if (typeof cb === 'function') {
                        try { cb(); } catch (e) { }
                    }
                    try { renderCanvasRoom(); } catch (e) { }
                }
            }
        }

        // ===== ÊºîÂá∫„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ =====
        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }

        function getAreaRectPx(roomId, areaDescription, canvas) {
            const room = rooms[roomId];
            const area = room?.clickableAreas?.find(a => a.description === areaDescription);
            if (!area) return null;
            return {
                x: area.x / 100 * canvas.width,
                y: area.y / 100 * canvas.height,
                w: area.width / 100 * canvas.width,
                h: area.height / 100 * canvas.height,
            };
        }

        function startKaniMoveAnimation(opts = {}) {
            const canvas = document.getElementById('gameCanvas');
            if (!canvas) return;

            const roomId = opts.roomId || gameState.currentRoom;
            const from = getAreaRectPx(roomId, opts.fromDesc || '„Ç´„ÉãÂàùÊúü‰ΩçÁΩÆ', canvas);
            const to = getAreaRectPx(roomId, opts.toDesc || '„Ç´„ÉãÁßªÂãïÂæå', canvas);
            if (!from || !to) return;

            gameState.fx = gameState.fx || {};
            if (gameState.fx.kaniMove && gameState.fx.kaniMove.active) return;

            gameState.fx.lockInput = true;
            gameState.fx.kaniMove = {
                active: true,
                roomId,
                from,
                to,
                start: (typeof performance !== 'undefined' ? performance.now() : Date.now()),
                duration: opts.duration ?? 650,
                done: false,
                onDone: opts.onDone || null,
                spriteKey: opts.spriteKey || 'kani',     // ‚òÖËøΩÂä†
                startSE: ('startSE' in opts) ? opts.startSE : 'se-kani', // ‚òÖËøΩÂä†ÔºànullÂèØÔºâ
            };

            requestAnimationFrame(() => {
                try {
                    renderCanvasRoom();
                    const se = gameState.fx?.kaniMove?.startSE;
                    if (se) playSE(se);
                } catch (e) { }
            });
        }


        function getRoomBackgroundImage(roomId, gameState) {
            let imgList = IMAGES.rooms[roomId]; // ‚òÖ const ‚Üí let

            if (roomId === 'boxInner') {
                return gameState.main.flags.powerOn
                    ? IMAGES.rooms.boxInner[0]
                    : IMAGES.rooms.boxInner[1];
            }

            // ‚òÖ book1„Äú3„Åø„Åü„ÅÑ„Å´ {jp:[], en:[]} ÂΩ¢Âºè„Å™„ÇâË®ÄË™û„ÅßÈÅ∏„Å∂
            if (imgList && !Array.isArray(imgList) && (imgList.jp || imgList.en)) {
                imgList = imgList[uiLang] || imgList.jp || imgList.en;
            }

            // Âçò‰∏ÄÁîªÂÉè„Å™„Çâ„Åù„ÅÆ„Åæ„Åæ
            if (!Array.isArray(imgList)) {
                return imgList;
            }

            const state = gameState[roomId]?.flags?.backgroundState ?? 0;
            return imgList[state] || imgList[0];
        }


        // Â∞èÁâ©„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function pointInRect(x, y, r) {
            return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;
        }

        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
            ctx.beginPath();
            ctx.moveTo(x + r.tl, y);
            ctx.lineTo(x + w - r.tr, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
            ctx.lineTo(x + w, y + h - r.br);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
            ctx.lineTo(x + r.bl, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
            ctx.lineTo(x, y + r.tl);
            ctx.quadraticCurveTo(x, y, x + r.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        // „Éï„É©„ÉÉ„Ç∑„É•„É¨„Ç§„É§„ÇíÁî®ÊÑè
        (function ensureFlashLayer() {
            if (!document.getElementById('fxFlash')) {
                const d = document.createElement('div');
                d.id = 'fxFlash';
                document.body.appendChild(d);
            }
        })();

        // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Ôºàtype: 'white' | 'red'Ôºâ
        function screenFlash(type = 'white', durMs = 180) {
            const f = document.getElementById('fxFlash'); if (!f) return;
            f.style.animation = 'none'; // ÈÄ£ÊâìÂØæÁ≠ñ
            // Âº∑Âà∂reflow„Åß„Ç¢„Éã„É°ÂÜçÈÅ©Áî®
            // eslint-disable-next-line no-unused-expressions
            f.offsetHeight;
            const key = type === 'red' ? 'flashRed' : 'flashWhite';
            f.style.animation = `${key} ${durMs}ms ease`;
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„ÇíÊ•µÂ∞è„Ç∑„Çß„Ç§„ÇØ
            document.documentElement.classList.add('fx-shake');
            setTimeout(() => document.documentElement.classList.remove('fx-shake'), 120);
        }

        // ÁîªÈù¢Êè∫„Çå
        function screenShake(el = document.documentElement, ms = 120, cls = 'fx-shake') {
            if (!el) return;
            // ÈÄ£Êâì„Åß„ÇÇÂøÖ„ÅöÁô∫ÁÅ´„Åï„Åõ„Çã
            el.classList.remove(cls);
            void el.offsetHeight; // reflow
            el.classList.add(cls);
            setTimeout(() => el.classList.remove(cls), ms);
        }



        function toggleNight() {

            quickBlackFade();
            setTimeout(() => {

                renderCanvasRoom();
            }, 300);

        }

        function acquireItemOnce(flagKey, itemId, title, imgSrc, msg) {
            const f = gameState.main.flags;
            if (f[flagKey]) {
                if (itemId == 'glass') {
                    updateMessage('„Ç∞„É©„Çπ„ÅåÊ≤¢Â±±„ÅÇ„Çã');
                } else {
                    updateMessage('„ÇÇ„ÅÜ‰Ωï„ÇÇ„Å™„ÅÑ');
                }

                return;
            }
            f[flagKey] = true;
            addItem(itemId);
            renderCanvasRoom();

            showModal(
                title,
                `<img src="${imgSrc}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );
            updateMessage(msg);
        }

        function clickWrap(fn, { allowAtNight = false } = {}) {
            return function (...args) {
                if (gameState.main.flags.isNight && !allowAtNight) {
                    updateMessage('Êöó„Åè„Å¶„Çà„ÅèË¶ã„Åà„Å™„ÅÑ');
                    return;
                }
                fn.apply(this, args);


                // „Ç¢„Ç§„ÉÜ„É†ÈÅ∏ÊäûËß£Èô§„ÅØ‰ªä„Åæ„ÅßÈÄö„Çä
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            };
        }


        // „Ç¢„ÇØ„Ç∑„Éß„É≥Âêç ‚Üí ÂÆüË°åÈñ¢Êï∞
        const ACTION_HANDLERS = {
            // --- ÁßªÂãïÁ≥ª ---
            examine_start_door_left() {
                // changeRoom('startRight');
            },

        };

        // „Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleAreaClick(action, event) {
            const handler = ACTION_HANDLERS[action];
            playSE('se-click');

            // area.onClick ÊñπÂºèÔºàÂ∞ÜÊù•„ÅÆ„Åü„ÇÅÔºâ
            if (typeof action === 'function') {
                action(event);
                return;
            }

            // actionÂêçÔºàÂæìÊù•„ÅÆÊñπÂºèÔºâ„Å´„ÇÇÂØæÂøú
            const fn = ACTION_HANDLERS[action];
            if (fn) {
                fn(event);
                return;
            }
            console.warn('Êú™ÂÆöÁæ©„ÅÆaction:', action);
        }


        // „ÇØ„É™„Ç¢„É¨„Éù„Éº„ÉàË°®Á§∫
        function showEndingReport(endingId = 'end') {
            const elapsedSec = Math.round((Date.now() - (ANA.start || Date.now())) / 1000);
            const m = Math.floor(elapsedSec / 60);
            const s = elapsedSec % 60;
            const timeStr = `${m}ÂàÜ${s.toString().padStart(2, '0')}Áßí`;

            // ‰ªä‰ΩúÁî®„Ç®„É≥„ÉâÊÉÖÂ†±
            const ENDING_INFO = {
                trueEnd: {
                    title: "üçô TRUE END",
                    label: "TRUE END",
                    desc: "ÂÄãÊÄßÁöÑ„Å™Ëä±ÁÅ´"
                },
                endWorse: {
                    title: "üèÉ‚Äç‚ôÄÔ∏è‚Äç‚û°Ô∏è END",
                    label: "END",
                    desc: "Êöó„ÅÑÊ£Æ„ÅÆ‰∏≠„Å∏"
                },
                end: {
                    title: "üéÜ NORMAL END ",
                    label: "NORMAL END ",
                    desc: "ÁÑ°‰∫ã‰æùÈ†º„Çí„Åì„Å™„Åó„Å¶ËÑ±Âá∫„Åß„Åç„Åæ„Åó„ÅüÔºÅ"
                },



            };

            const info = ENDING_INFO[endingId] || ENDING_INFO.end;

            // „Ç®„É≥„ÉâÂà•„Å≤„Å®„Åì„Å®
            let secretText = "";
            switch (endingId) {
                case "trueEnd":
                    secretText = "ü¶Ä „Ç´„Éã„ÅÆÂπ≥Âíå„ÇíÂÆà„Çä„Åæ„Åó„Åü";
                    break;
                case "trueEnd2":
                    secretText = "ü¶Äüêª „Ç´„Éã„ÅÆÂπ≥Âíå„ÇíÂÆà„Çä„ÄÅ„ÇØ„Éû„ÅÆÁ©∫ËÖπ„ÇíÊ∫Ä„Åü„Åó„Åæ„Åó„Åü";
                    break;
                case "end":
                    secretText = "‚ù§ „Éè„Éº„Éà„ÅÆËä±ÁÅ´„Åå‰∏ä„Åå„Çä„Åæ„Åó„Åü";
                    break;

                default:
                    secretText = "";
            }

            // GAÈÄÅ‰ø°
            ANA.once('ending', endingId, {
                ending: endingId,
                time_sec: elapsedSec,
            });

            const html = `
        <div style="max-width:520px; text-align:center;">
            <h2 style="margin-top:0;">${info.title}</h2>
            <p style="margin:6px 0 12px 0; font-weight:bold;">${info.desc}</p>
            <p style="margin:4px 0;">„Éó„É¨„Ç§ÊôÇÈñìÔºö<b>${timeStr}</b></p>
            <p style="margin:4px 0;">„Éí„É≥„ÉàÂà©Áî®Ôºö<b>${ANA.hintCount || 0} Âõû</b></p>
            ${secretText ? `<p style="margin:12px 0; font-size:.9em; opacity:.85;">${secretText}</p>` : ""}
            
            
        </div>
    `;

            showModal("„Ç®„É≥„Éá„Ç£„É≥„Ç∞", html, [
                {
                    text: "Ë©ï‰æ°„ÅØ„Åì„Å°„Çâ",
                    action: () => openFeedbackForm(endingId),
                },
                {
                    text: "Èñâ„Åò„Çã",
                    action: () => {
                        closeModal();
                    },
                },
            ]);
        }

        // „ÇØ„É™„Ç¢„É≠„Ç∞ÁîüÊàêÔºàÊó¢Â≠ò„ÅÆ„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆ„Åæ„ÅæÊµÅÁî®„ÅßOKÔºâ
        function copyClearLog(label, timeStr) {
            const text =
                `„Äé‰øùËÇ≤ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫„Äè${label} „ÇØ„É™„Ç¢\n` +
                `„Éó„É¨„Ç§ÊôÇÈñìÔºö${timeStr}\n` +
                `„Éí„É≥„ÉàÂà©Áî®Ôºö${ANA.hintCount || 0}Âõû\n` +
                `#ËÑ±Âá∫„Ç≤„Éº„É† #‰øùËÇ≤ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫`;
            navigator.clipboard.writeText(text).then(() => {
                alert("„ÇØ„É™„Ç¢„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
            }).catch(() => {
                alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü‚Ä¶");
            });
        }

        // „Ç¢„É≥„Ç±„Éº„Éà
        function openFeedbackForm(endingId) {
            const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdmfie5hVPAzk91PETEQd36jqratyiIXlfhMcWqVEaifgDF1w/viewform";

            const endingLabel = ({
                trueEnd: "„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ",
                end: "„Éé„Éº„Éû„É´„Ç®„É≥„Éâ",
            })[endingId] || "„Ç®„É≥„Éâ";

            const params = new URLSearchParams({
                "entry.666725843": endingLabel,
            });

            window.open(`${FEEDBACK_URL}?${params.toString()}`, "_blank");
        }



        function talkToHintCharacter(roomId, charId) {
            // flagsÂèñÂæó
            let flags = gameState[roomId].flags;
            // „Åæ„Å†„Ç´„Ç¶„É≥„ÉàÁÑ°„Åë„Çå„Å∞ÂàùÊúüÂåñ
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            flags.talkTo[charId]++;

            // „Çª„É™„Éï„É™„Çπ„ÉàÂèñÂæó
            const messages = hintMessages[roomId][charId];

            // ÁØÑÂõ≤Â§ñ„Å™„ÇâÊúÄÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const idx = (flags.talkTo[charId] - 1) % messages.length;
            console.log(flags.talkTo[charId]);

            // Ë°®Á§∫
            updateMessage(messages[idx]);
        }


        // ‚ñº ÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ Êìç‰ΩúÁî®

        function openNotebook() {
            const m = document.getElementById('notebookModal');
            if (!m) return;
            m.style.display = 'flex';
            switchNotebookTab('notes'); // ÊØéÂõûnote„Åã„ÇâÈñã„Åè

            // ‚òÖ ÈÄ≤Êçó„Çø„Çπ„ÇØÔºàNOTESÔºâ„ÇÇÊõ¥Êñ∞„Åó„Å¶„Åä„Åè
            renderNotebookTasks();

            if (gameState.main?.flags?.notebookDeckHintAdded) {
                addDeckDoorHintNote();
            }

        }

        function switchNotebookTab(tabId) {
            const tabs = document.querySelectorAll('.notebook-tab');
            const contents = document.querySelectorAll('.notebook-tab-content');

            tabs.forEach(btn => {
                const t = btn.getAttribute('data-tab');
                btn.classList.toggle('active', t === tabId);
            });

            contents.forEach(c => c.classList.remove('active'));

            const active = document.getElementById('notebook-tab-' + tabId);
            if (active) active.classList.add('active');

            // ‚òÖ „Çø„Éñ„ÇíÈñã„ÅÑ„ÅüÁû¨Èñì„Å´‰∏≠Ë∫´„ÇíÊúÄÊñ∞Âåñ
            if (tabId === 'notes') renderNotebookTasks();
        }

        function closeNotebook() {
            const m = document.getElementById('notebookModal');
            if (!m) return;
            m.style.display = 'none';
        }

        function renderNotebookTasks() {
            const notesBody = document.getElementById('notebook-notes-body');
            if (!notesBody) return;

            const flags = (gameState && gameState.main && gameState.main.flags) ? gameState.main.flags : {};

            // Êó¢Â≠ò„ÅÆ„Äå„Çø„Çπ„ÇØÊû†„Äç„Å†„ÅëÂ∑Æ„ÅóÊõø„Åà„ÇãÔºà‰ªñ„ÅÆËøΩË®ò„É°„É¢„ÅåÂ∞ÜÊù•Â¢ó„Åà„Å¶„ÇÇÊ∂à„Åï„Å™„ÅÑÔºâ
            const old = document.getElementById('notebook-tasks');
            if (old) old.remove();

            const tasks = [];

            const allSolved = true;
            if (allSolved) {
                tasks.push({ text: 'test', done: false });


            }

            // „Ç≠„É£„Éó„Ç∑„Éß„É≥„ÇÇÈÄ≤ÊçóÁî®„Å´ÂØÑ„Åõ„ÇãÔºà„Çø„Çπ„ÇØ„Å™„Åó„Å™„ÇâÂÖÉ„ÅÆ„Éã„É•„Ç¢„É≥„Çπ„Å´Êàª„ÅôÔºâ
            const cap = document.querySelector('#notebook-tab-notes .notebook-cap');
            if (cap) {
                cap.textContent = (tasks.length > 0)
                    ? 'ÈÄ≤Êçó„É°„É¢„ÅåÊõ∏„ÅçË∂≥„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ'
                    : 'Á©∫ÁôΩ„ÅÆ„Éö„Éº„Ç∏„ÄÇ';
            }

            const wrap = document.createElement('div');
            wrap.id = 'notebook-tasks';
            wrap.className = 'notebook-note';

            if (tasks.length === 0) {
                wrap.innerHTML = `<p style="margin:0;">„Åæ„Å†„Çø„Çπ„ÇØ„ÅØ„Å™„ÅÑ„ÄÇ</p>`;
                notesBody.prepend(wrap);
                return;
            }

            const rows = tasks.map(t => {
                const mark = t.done ? '‚úÖ' : '‚¨ú';
                const style = t.done ? 'text-decoration:line-through;opacity:0.75;' : '';
                return `
      <li style="display:flex;gap:8px;align-items:flex-start;">
        <span style="width:1.2em;display:inline-block;">${mark}</span>
        <span style="${style}">${t.text}</span>
      </li>
    `;
            }).join('');

            wrap.innerHTML = `
    <div style="font-weight:700;margin:0 0 8px 0;">ÈÄ≤Êçó</div>
    <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;">
      ${rows}
    </ul>
  `;

            notesBody.prepend(wrap);
        }

        // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Åü„ÅÑÂ†¥ÂêàÔºà‰ªªÊÑèÔºâ
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('notebookModal');
            if (!modal) return;
            if (modal.style.display === 'flex' && e.target === modal) {
                closeNotebook();
            }
        });

        function showWallCabRightPuzzle() {
            const f = gameState.main.flags;

            // „ÇÇ„ÅÜËß£„ÅÑ„Å¶„Åü„Çâ„ÄÅÊôÆÈÄö„Å´„É°„ÉÉ„Çª„Éº„Ç∏„Å†„Åë„Åß„ÇÇOK
            if (f.unlockWallCabRight) {
                updateMessage('Âè≥„ÅÆ„Ç¶„Ç©„Éº„É´„Ç∑„Çß„É´„Éï„ÅØ„ÄÅ„ÇÇ„ÅÜ„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            const ROT = ['A', 'E', 'H', 'I', 'N', 'S', 'T', 'U'];

            const content = `
    <div style="margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:12px;">
      <div id="wallCabRightPickers" style="display:flex; gap:12px; justify-content:center; align-items:center;">
        <button class="nav-btn" id="wallCabRightSq0"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:900; border-radius:10px;background-color:#fff;">
          A
        </button>
        <button class="nav-btn" id="wallCabRightSq1"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:900; border-radius:10px;background-color:#fff;">
          A
        </button>
        <button class="nav-btn" id="wallCabRightSq2"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:900; border-radius:10px;background-color:#fff;">
          A
        </button>
      </div>

      <div>
        <button id="wallCabRightOk" class="ok-btn" style="">OK</button>
      </div>

      <div id="wallCabRightHint" style="margin-top:2px; font-size:0.95em; min-height:1.2em;"></div>
    </div>
  `;

            showModal('„Ç¶„Ç©„Éº„É´„Ç∑„Çß„É´„ÉïÂè≥„ÅÆ„É≠„ÉÉ„ÇØ', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);

            // showModal„ÅåDOM„ÇíÊõ∏„ÅçÊèõ„Åà„ÅüÂæå„Å´„Éï„ÉÉ„ÇØ
            setTimeout(() => {
                const sq = [
                    document.getElementById('wallCabRightSq0'),
                    document.getElementById('wallCabRightSq1'),
                    document.getElementById('wallCabRightSq2'),
                ];
                const okBtn = document.getElementById('wallCabRightOk');
                const hint = document.getElementById('wallCabRightHint');

                if (!sq[0] || !sq[1] || !sq[2] || !okBtn) return;

                // ÁèæÂú®‰ΩçÁΩÆÔºàA„Åã„Çâ„Çπ„Çø„Éº„ÉàÔºâ
                const idx = [0, 0, 0];

                const paint = (i) => {
                    sq[i].textContent = ROT[idx[i]];
                };

                const rotate = (i) => {
                    idx[i] = (idx[i] + 1) % ROT.length;
                    paint(i);
                    try { playSE?.('se-gacha'); } catch (e) { }
                };

                // ÂàùÊúüÊèèÁîª
                paint(0); paint(1); paint(2);

                sq.forEach((btn, i) => {
                    btn.addEventListener('click', () => rotate(i));
                });

                const judge = () => {
                    const word = ROT[idx[0]] + ROT[idx[1]] + ROT[idx[2]];
                    const isOk = (word === 'USE');

                    if (isOk) {
                        f.unlockWallCabRight = true;
                        playSE?.('se-clear');
                        closeModal();
                        updateMessage('„Ç´„ÉÅ„ÉÉ‚Ä¶Âè≥„ÅÆ„Ç¶„Ç©„Éº„É´„Ç∑„Çß„É´„Éï„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„ÄÇ');
                        renderCanvasRoom?.();
                        markProgress?.('unlock_wallcab_right_28');
                    } else {
                        playSE?.('se-error');
                        if (hint) hint.textContent = '„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                        screenShake?.(document.getElementById('modalContent'), 120, 'fx-shake');
                    }
                };

                okBtn.addEventListener('click', judge);

                // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰ΩúÔºàEnter=OK, 1/2/3=Âõû„ÅôÔºâ
                const onKey = (e) => {
                    if (e.key === 'Enter') judge();
                    if (e.key === '1') rotate(0);
                    if (e.key === '2') rotate(1);
                    if (e.key === '3') rotate(2);
                };
                document.addEventListener('keydown', onKey);

                // Èñâ„Åò„Åü„Çâ„Ç§„Éô„É≥„Éà„ÇíÊéÉÈô§ÔºàcloseModal„Çí„Éï„ÉÉ„ÇØÔºâ
                const _origCloseModal = window.closeModal;
                if (typeof _origCloseModal === 'function') {
                    window.closeModal = function () {
                        try { document.removeEventListener('keydown', onKey); } catch (e) { }
                        window.closeModal = _origCloseModal;
                        return _origCloseModal.apply(this, arguments);
                    }
                }

                sq[0].focus();
            }, 0);
        }

        function showWallCabLeftPuzzle() {
            const f = gameState.main.flags;

            // „ÇÇ„ÅÜËß£„ÅÑ„Å¶„Åü„Çâ„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏„Å†„Åë„Åß„ÇÇOK
            if (f.unlockWallCabLeft) {
                updateMessage('Â∑¶„ÅÆ„Ç¶„Ç©„Éº„É´„Ç∑„Çß„É´„Éï„ÅØ„ÄÅ„ÇÇ„ÅÜ„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            // Ê≠£Ëß£Ôºö‰∏ã ‚Üí Âè≥ ‚Üí ‰∏ã ‚Üí Â∑¶ ‚Üí ‰∏ä
            const ANSWER = ['D', 'R', 'D', 'L', 'U'];
            let input = [];

            const content = `
    <div style="margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:12px;">
      <div id="wallCabLeftPad"
           style="display:grid; grid-template-columns:72px 72px 72px; grid-template-rows:72px 72px 72px; gap:10px; place-items:center;">
        <div></div>
        <button class="nav-btn" id="wallCabLeftU"
          style="width:72px; height:72px; padding:0; font-size:28px; font-weight:900; border-radius:10px;background-color:#fff;">‚Üë</button>
        <div></div>

        <button class="nav-btn" id="wallCabLeftL"
          style="width:72px; height:72px; padding:0; font-size:28px; font-weight:900; border-radius:10px;background-color:#fff;">‚Üê</button>
        <div style="width:72px; height:72px; display:flex; align-items:center; justify-content:center; opacity:.65;">
          <span style="font-size:14px;">PAD</span>
        </div>
        <button class="nav-btn" id="wallCabLeftR"
          style="width:72px; height:72px; padding:0; font-size:28px; font-weight:900; border-radius:10px;background-color:#fff;">‚Üí</button>

        <div></div>
        <button class="nav-btn" id="wallCabLeftD"
          style="width:72px; height:72px; padding:0; font-size:28px; font-weight:900; border-radius:10px;background-color:#fff;">‚Üì</button>
        <div></div>
      </div>

      <div>
        <button id="wallCabLeftOk" class="" style="margin-top:8px;font-size:1.4rem;background-color:#1d9fff;color:#fff;">OK</button>
      </div>

      <div id="wallCabLeftHint" style="margin-top:2px; font-size:0.95em; min-height:1.2em;"></div>
    </div>
  `;

            showModal('„Ç¶„Ç©„Éº„É´„Ç∑„Çß„É´„ÉïÂ∑¶„ÅÆ„É≠„ÉÉ„ÇØ', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);

            setTimeout(() => {
                const btnU = document.getElementById('wallCabLeftU');
                const btnD = document.getElementById('wallCabLeftD');
                const btnL = document.getElementById('wallCabLeftL');
                const btnR = document.getElementById('wallCabLeftR');
                const okBtn = document.getElementById('wallCabLeftOk');
                const hint = document.getElementById('wallCabLeftHint');
                if (!btnU || !btnD || !btnL || !btnR || !okBtn) return;

                const push = (d) => {
                    input.push(d);
                    // Èï∑„Åè„Å™„Çä„Åô„Åé„Åü„ÇâÊú´Â∞æ5„Å§„Å†„Åë‰øùÊåÅÔºà‰∫ãÊïÖÈò≤Ê≠¢Ôºâ
                    if (input.length > ANSWER.length) input = input.slice(-ANSWER.length);
                    try { playSE?.('se-gacha'); } catch (e) { }
                    if (hint) hint.textContent = `ÂÖ•ÂäõÔºö${input.map(x => ({ U: '‚Üë', D: '‚Üì', L: '‚Üê', R: '‚Üí' }[x])).join(' ')}`;
                };

                btnU.addEventListener('click', () => push('U'));
                btnD.addEventListener('click', () => push('D'));
                btnL.addEventListener('click', () => push('L'));
                btnR.addEventListener('click', () => push('R'));

                const judge = () => {
                    const ok = (input.length === ANSWER.length && input.every((v, i) => v === ANSWER[i]) && gameState.main.flags.powerOn);
                    if (ok) {
                        f.unlockWallCabLeft = true;
                        playSE?.('se-clear');
                        closeModal();
                        updateMessage('„Ç´„ÉÅ„ÉÉ‚Ä¶Â∑¶„ÅÆ„Ç¶„Ç©„Éº„É´„Ç∑„Çß„É´„Éï„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„ÄÇ');
                        markProgress('28_left_wall_unlock');
                        renderCanvasRoom?.();
                    } else {
                        playSE?.('se-error');
                        if (hint) hint.textContent = '„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                        screenShake?.(document.getElementById('modalContent'), 120, 'fx-shake');
                    }
                };

                okBtn.addEventListener('click', judge);

                // „Ç≠„Éº„Éú„Éº„Éâ„Åß„ÇÇÊìç‰Ωú„Åß„Åç„Çã„Å®Âú∞Âë≥„Å´‰æøÂà©ÔºàÁü¢Âç∞„Ç≠„Éº/EnterÔºâ
                const onKey = (e) => {
                    if (e.key === 'Enter') judge();
                    if (e.key === 'ArrowUp') push('U');
                    if (e.key === 'ArrowDown') push('D');
                    if (e.key === 'ArrowLeft') push('L');
                    if (e.key === 'ArrowRight') push('R');
                };
                document.addEventListener('keydown', onKey);

                // closeModal„Éï„ÉÉ„ÇØ„ÅßÊéÉÈô§ÔºàÂè≥„Éë„Ç∫„É´„Å®Âêå„Åò‰ΩúÊ≥ïÔºâ:contentReference[oaicite:2]{index=2}
                const _origCloseModal = window.closeModal;
                if (typeof _origCloseModal === 'function') {
                    window.closeModal = function () {
                        try { document.removeEventListener('keydown', onKey); } catch (e) { }
                        window.closeModal = _origCloseModal;
                        return _origCloseModal.apply(this, arguments);
                    }
                }

                btnD.focus(); // ÂàùÊúü„Éï„Ç©„Éº„Ç´„Çπ„ÅØ„Äå‰∏ã„Äç„Å´„Åó„Å¶„Åä„ÅèÔºà„Å™„Çì„Å®„Å™„ÅèÔºâ
            }, 0);
        }

        function showDrawerMainPuzzle() {
            const f = gameState.main.flags || (gameState.main.flags = {});

            if (f.unlockDrawerMain) {
                updateMessage('Âºï„ÅçÂá∫„Åó„ÅØ„ÄÅ„ÇÇ„ÅÜ„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            const COLORS = [
                { name: 'black', bg: '#111', fg: '#fff' },
                { name: 'red', bg: '#ff3b30', fg: '#fff' },
                { name: 'yellow', bg: '#ffcc00', fg: '#111' },
                { name: 'green', bg: '#34c759', fg: '#111' },
                { name: 'pink', bg: '#ffa9de', fg: '#fff' },
                { name: 'blue', bg: '#007aff', fg: '#fff' },
            ];

            // 3„Å§„ÅÆÁôΩ„ÅÑÊ≠£ÊñπÂΩ¢Ôºà‰∏≠„ÅÆË®òÂè∑„ÅØÈªíÔºâ„Åã„Çâ„Çπ„Çø„Éº„Éà
            const content = `
    <div style="margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:12px;">
      <div style="display:flex; gap:12px; justify-content:center; align-items:center;">
        <button class="nav-btn" id="drawerMainSq0"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:30px; font-weight:900; border-radius:10px; background:#fff; color:#111;">‚ô•</button>
        <button class="nav-btn" id="drawerMainSq1"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:30px; font-weight:900; border-radius:10px; background:#fff; color:#111;">‚ñº</button>
        <button class="nav-btn" id="drawerMainSq2"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:30px; font-weight:900; border-radius:10px; background:#fff; color:#111;">‚ñ†</button>
      </div>

      <div>
        <button id="drawerMainOk" class="ok-btn" style="">OK</button>
      </div>

      <div id="drawerMainHint" style="margin-top:2px; font-size:0.95em; min-height:1.2em;"></div>
    </div>
  `;

            showModal('Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);

            setTimeout(() => {
                const sq = [
                    document.getElementById('drawerMainSq0'),
                    document.getElementById('drawerMainSq1'),
                    document.getElementById('drawerMainSq2'),
                ];
                const okBtn = document.getElementById('drawerMainOk');
                const hint = document.getElementById('drawerMainHint');
                if (!sq[0] || !sq[1] || !sq[2] || !okBtn) return;

                // -1 = ÁôΩÔºàÊú™ÈÅ∏ÊäûÔºâ
                const idx = [-1, -1, -1];

                const paint = (i) => {
                    if (idx[i] < 0) {
                        sq[i].style.backgroundColor = '#fff';
                        sq[i].style.color = '#111';
                        return;
                    }
                    const c = COLORS[idx[i]];
                    sq[i].style.backgroundColor = c.bg;
                    sq[i].style.color = c.fg;
                };

                const cycle = (i) => {
                    if (idx[i] < 0) idx[i] = 0;
                    else idx[i] = (idx[i] + 1) % COLORS.length;
                    paint(i);
                    try { playSE?.('se-gacha'); } catch (e) { }
                };

                // ÂàùÊúüÊèèÁîªÔºàÁôΩÔºâ
                paint(0); paint(1); paint(2);

                sq.forEach((btn, i) => {
                    btn.addEventListener('click', () => cycle(i));
                });

                const isColor = (i, name) => (idx[i] >= 0 && COLORS[idx[i]].name === name);

                const judge = () => {
                    const ok = isColor(0, 'red') && isColor(1, 'green') && isColor(2, 'blue');
                    if (ok) {
                        f.unlockDrawerMain = true;
                        playSE?.('se-clear');
                        closeModal();
                        updateMessage('„Ç´„ÉÅ„ÉÉ‚Ä¶Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„ÄÇ');
                        renderCanvasRoom?.();
                        markProgress?.('unlock_drawer_main');
                    } else {
                        playSE?.('se-error');
                        if (hint) hint.textContent = '„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                        screenShake?.(document.getElementById('modalContent'), 120, 'fx-shake');
                    }
                };

                okBtn.addEventListener('click', judge);

                // „Ç≠„Éº„Éú„Éº„ÉâÔºöEnter=OK, 1/2/3=Ëâ≤„ÇíÈÄ≤„ÇÅ„Çã
                const onKey = (e) => {
                    if (e.key === 'Enter') judge();
                    if (e.key === '1') cycle(0);
                    if (e.key === '2') cycle(1);
                    if (e.key === '3') cycle(2);
                };
                document.addEventListener('keydown', onKey);

                // closeModal„Éï„ÉÉ„ÇØ„ÅßÊéÉÈô§
                const _origCloseModal = window.closeModal;
                if (typeof _origCloseModal === 'function') {
                    window.closeModal = function () {
                        try { document.removeEventListener('keydown', onKey); } catch (e) { }
                        window.closeModal = _origCloseModal;
                        return _origCloseModal.apply(this, arguments);
                    }
                }

                sq[0].focus();
            }, 0);
        }

        // mainDoorÔºöÂºï„ÅçÂá∫„Åó‰∏äÊÆµÔºàÊï∞Â≠ó„É≠„ÉÉ„ÇØ 4Ê°ÅÔºâ
        function showDrawerTopPuzzle() {
            const f = gameState.main.flags || (gameState.main.flags = {});

            if (f.unlockDrawerTop) {
                updateMessage('Âºï„ÅçÂá∫„Åó„ÅØ„ÄÅ„ÇÇ„ÅÜ„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            const content = `
    <div style="margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:12px;">
      <div style="display:flex; gap:10px; justify-content:center; align-items:center;">
        <button class="nav-btn" id="drawerTopSq0"
          style="width:64px; height:64px; padding:0; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:900; border-radius:10px; background:#fff; color:#111;">0</button>
        <button class="nav-btn" id="drawerTopSq1"
          style="width:64px; height:64px; padding:0; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:900; border-radius:10px; background:#fff; color:#111;">0</button>
        <button class="nav-btn" id="drawerTopSq2"
          style="width:64px; height:64px; padding:0; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:900; border-radius:10px; background:#fff; color:#111;">0</button>
        <button class="nav-btn" id="drawerTopSq3"
          style="width:64px; height:64px; padding:0; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:900; border-radius:10px; background:#fff; color:#111;">0</button>
      </div>

      <div>
        <button id="drawerTopOk" class="ok-btn">OK</button>
      </div>

      <div id="drawerTopHint" style="margin-top:2px; font-size:0.95em; min-height:1.2em;"></div>
    </div>
  `;

            showModal('Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);

            setTimeout(() => {
                const sq = [
                    document.getElementById('drawerTopSq0'),
                    document.getElementById('drawerTopSq1'),
                    document.getElementById('drawerTopSq2'),
                    document.getElementById('drawerTopSq3'),
                ];
                const okBtn = document.getElementById('drawerTopOk');
                const hint = document.getElementById('drawerTopHint');
                if (!sq[0] || !sq[1] || !sq[2] || !sq[3] || !okBtn) return;

                // ÂàùÊúü„ÅØ„Åô„Åπ„Å¶0
                const num = [0, 0, 0, 0];

                const paint = (i) => { sq[i].textContent = String(num[i]); };

                const cycle = (i) => {
                    num[i] = (num[i] + 1) % 10;
                    paint(i);
                    try { playSE?.('se-gacha'); } catch (e) { }
                };

                paint(0); paint(1); paint(2); paint(3);

                sq.forEach((btn, i) => {
                    btn.addEventListener('click', () => cycle(i));
                });

                const judge = () => {
                    const ok = (num[0] === 1 && num[1] === 0 && num[2] === 3 && num[3] === 2);
                    if (ok) {
                        f.unlockDrawerTop = true;
                        playSE?.('se-clear');
                        closeModal();
                        updateMessage('„Ç´„ÉÅ„ÉÉ‚Ä¶Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„ÄÇ');
                        renderCanvasRoom?.();
                        markProgress?.('unlock_drawer_top');
                    } else {
                        playSE?.('se-error');
                        if (hint) hint.textContent = '„Å°„Åå„ÅÜ„Åø„Åü„ÅÑ„Å†„ÄÇ';
                        screenShake?.(document.getElementById('modalContent'), 120, 'fx-shake');
                    }
                };

                okBtn.addEventListener('click', judge);

                // Enter=OK, 1/2/3/4=ÂØæÂøúÊû†„ÇíÈÄ≤„ÇÅ„Çã
                const onKey = (e) => {
                    if (e.key === 'Enter') judge();
                    if (e.key === '1') cycle(0);
                    if (e.key === '2') cycle(1);
                    if (e.key === '3') cycle(2);
                    if (e.key === '4') cycle(3);
                };
                document.addEventListener('keydown', onKey);

                // closeModal„Éï„ÉÉ„ÇØ„ÅßËß£Èô§
                const _origCloseModal = window.closeModal;
                if (typeof _origCloseModal === 'function') {
                    window.closeModal = function () {
                        try { document.removeEventListener('keydown', onKey); } catch (e) { }
                        window.closeModal = _origCloseModal;
                        return _origCloseModal.apply(this, arguments);
                    }
                }

                sq[0].focus();
            }, 0);
        }


        // mainDoorÔºöÂºï„ÅçÂá∫„Åó‰∏≠ÊÆµÔºàÊï∞Â≠ó„É≠„ÉÉ„ÇØ 3Ê°ÅÔºâ
        function showDrawerMiddlePuzzle() {
            const f = gameState.main.flags || (gameState.main.flags = {});

            if (f.unlockDrawerMiddle) {
                updateMessage('Âºï„ÅçÂá∫„Åó„ÅØ„ÄÅ„ÇÇ„ÅÜ„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            const content = `
    <div style="margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:12px;">
        <img src="${IMAGES.modals.tri}" style="width:100%;max-width:360px;">
      <div style="display:flex; gap:12px; justify-content:center; align-items:center;">
        <button class="nav-btn" id="drawerMidSq0"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:34px; font-weight:900; border-radius:10px; background:#fff; color:#111;">0</button>
        <button class="nav-btn" id="drawerMidSq1"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:34px; font-weight:900; border-radius:10px; background:#fff; color:#111;">0</button>
        <button class="nav-btn" id="drawerMidSq2"
          style="width:72px; height:72px; padding:0; display:flex; align-items:center; justify-content:center; font-size:34px; font-weight:900; border-radius:10px; background:#fff; color:#111;">0</button>
      </div>

      <div>
        <button id="drawerMidOk" class="ok-btn">OK</button>
      </div>

      <div id="drawerMidHint" style="margin-top:2px; font-size:0.95em; min-height:1.2em;"></div>
    </div>
  `;

            showModal('Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);

            setTimeout(() => {
                const sq = [
                    document.getElementById('drawerMidSq0'),
                    document.getElementById('drawerMidSq1'),
                    document.getElementById('drawerMidSq2'),
                ];
                const okBtn = document.getElementById('drawerMidOk');
                const hint = document.getElementById('drawerMidHint');
                if (!sq[0] || !sq[1] || !sq[2] || !okBtn) return;

                // ÂàùÊúüÂÄ§„ÅØÂÖ®ÈÉ®0
                const num = [0, 0, 0];

                const paint = (i) => { sq[i].textContent = String(num[i]); };

                const cycle = (i) => {
                    num[i] = (num[i] + 1) % 10;
                    paint(i);
                    try { playSE?.('se-gacha'); } catch (e) { }
                };

                paint(0); paint(1); paint(2);

                sq.forEach((btn, i) => {
                    btn.addEventListener('click', () => cycle(i));
                });

                const judge = () => {
                    const ok = (num[0] === 6 && num[1] === 1 && num[2] === 2);
                    if (ok) {
                        f.unlockDrawerMiddle = true;
                        playSE?.('se-clear');
                        closeModal();
                        updateMessage('„Ç´„ÉÅ„ÉÉ‚Ä¶Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„ÄÇ');
                        renderCanvasRoom?.();
                        markProgress?.('unlock_drawer_middle');
                    } else {
                        playSE?.('se-error');
                        if (hint) hint.textContent = '„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                        screenShake?.(document.getElementById('modalContent'), 120, 'fx-shake');
                    }
                };

                okBtn.addEventListener('click', judge);

                // „Ç≠„Éº„Éú„Éº„ÉâÔºöEnter=OK, 1/2/3=„Åù„Çå„Åû„ÇåÊï∞Â≠ó„ÇíÈÄ≤„ÇÅ„Çã
                const onKey = (e) => {
                    if (e.key === 'Enter') judge();
                    if (e.key === '1') cycle(0);
                    if (e.key === '2') cycle(1);
                    if (e.key === '3') cycle(2);
                };
                document.addEventListener('keydown', onKey);

                // closeModal„Éï„ÉÉ„ÇØ„ÅßÊéÉÈô§ÔºàÊó¢Â≠ò„Éë„Ç∫„É´„Å®Âêå„Åò‰ΩúÊ≥ïÔºâ
                const _origCloseModal = window.closeModal;
                if (typeof _origCloseModal === 'function') {
                    window.closeModal = function () {
                        try { document.removeEventListener('keydown', onKey); } catch (e) { }
                        window.closeModal = _origCloseModal;
                        return _origCloseModal.apply(this, arguments);
                    }
                }

                sq[0].focus();
            }, 0);
        }

        // mainDoorÔºöÂºï„ÅçÂá∫„Åó‰∏ãÊÆµÔºàÊñπÂêëÂÖ•ÂäõÔºâ
        function showDrawerBottomPuzzle() {
            const f = gameState.main.flags || (gameState.main.flags = {});

            if (f.unlockDrawerBottom) {
                updateMessage('Âºï„ÅçÂá∫„Åó‰∏ãÊÆµ„ÅØ„ÄÅ„ÇÇ„ÅÜ„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            const content = `
    <div style="margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:12px;">
      <div id="drawerBottomPad" style="display:grid; grid-template-columns:72px 72px 72px; grid-template-rows:72px 72px 72px; gap:10px;">
        <div></div>
        <button id="drawerBottomUp" class="nav-btn" style="width:72px;height:72px;padding:0;border-radius:10px;background:#fff;color:#111;font-size:32px;font-weight:900;">‚Üë</button>
        <div></div>
        <button id="drawerBottomLeft" class="nav-btn" style="width:72px;height:72px;padding:0;border-radius:10px;background:#fff;color:#111;font-size:32px;font-weight:900;">‚Üê</button>
        <div></div>
        <button id="drawerBottomRight" class="nav-btn" style="width:72px;height:72px;padding:0;border-radius:10px;background:#fff;color:#111;font-size:32px;font-weight:900;">‚Üí</button>
        <div></div>
        <button id="drawerBottomDown" class="nav-btn" style="width:72px;height:72px;padding:0;border-radius:10px;background:#fff;color:#111;font-size:32px;font-weight:900;">‚Üì</button>
        <div></div>
      </div>

      <div id="drawerBottomSeq" style="font-size:1.05em;min-height:1.4em;">ÂÖ•Âäõ: </div>
      <div style="display:flex;gap:10px;">
        <button id="drawerBottomOk" class="ok-btn">OK</button>
        <button id="drawerBottomClear" class="nav-btn">„ÇØ„É™„Ç¢</button>
      </div>
      <div id="drawerBottomHint" style="margin-top:2px; font-size:0.95em; min-height:1.2em;"></div>
    </div>
  `;

            showModal('Âºï„ÅçÂá∫„Åó‰∏ãÊÆµ„É≠„ÉÉ„ÇØ', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);

            setTimeout(() => {
                const upBtn = document.getElementById('drawerBottomUp');
                const downBtn = document.getElementById('drawerBottomDown');
                const leftBtn = document.getElementById('drawerBottomLeft');
                const rightBtn = document.getElementById('drawerBottomRight');
                const okBtn = document.getElementById('drawerBottomOk');
                const clearBtn = document.getElementById('drawerBottomClear');
                const seqEl = document.getElementById('drawerBottomSeq');
                const hint = document.getElementById('drawerBottomHint');
                if (!upBtn || !downBtn || !leftBtn || !rightBtn || !okBtn || !clearBtn || !seqEl) return;

                const ANSWER = ['‚Üë', '‚Üì', '‚Üì', '‚Üê', '‚Üì'];
                const input = [];

                const repaint = () => {
                    seqEl.textContent = `ÂÖ•Âäõ: ${input.join('')}`;
                };

                const pushDir = (dir) => {
                    input.push(dir);
                    repaint();
                    try { playSE?.('se-gacha'); } catch (e) { }
                };

                const clearInput = () => {
                    input.length = 0;
                    repaint();
                };

                const judge = () => {
                    const ok = (input.length === ANSWER.length) && ANSWER.every((v, i) => input[i] === v);
                    if (ok) {
                        f.unlockDrawerBottom = true;
                        playSE?.('se-clear');
                        closeModal();
                        updateMessage('„Ç´„ÉÅ„ÉÉ‚Ä¶Âºï„ÅçÂá∫„Åó‰∏ãÊÆµ„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„ÄÇ');
                        renderCanvasRoom?.();
                    } else {
                        playSE?.('se-error');
                        if (hint) hint.textContent = 'ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                        screenShake?.(document.getElementById('modalContent'), 120, 'fx-shake');
                    }
                };

                upBtn.addEventListener('click', () => pushDir('‚Üë'));
                downBtn.addEventListener('click', () => pushDir('‚Üì'));
                leftBtn.addEventListener('click', () => pushDir('‚Üê'));
                rightBtn.addEventListener('click', () => pushDir('‚Üí'));
                clearBtn.addEventListener('click', clearInput);
                okBtn.addEventListener('click', judge);

                const onKey = (e) => {
                    if (e.key === 'ArrowUp') pushDir('‚Üë');
                    if (e.key === 'ArrowDown') pushDir('‚Üì');
                    if (e.key === 'ArrowLeft') pushDir('‚Üê');
                    if (e.key === 'ArrowRight') pushDir('‚Üí');
                    if (e.key === 'Enter') judge();
                };
                document.addEventListener('keydown', onKey);

                const _origCloseModal = window.closeModal;
                if (typeof _origCloseModal === 'function') {
                    window.closeModal = function () {
                        try { document.removeEventListener('keydown', onKey); } catch (e) { }
                        window.closeModal = _origCloseModal;
                        return _origCloseModal.apply(this, arguments);
                    }
                }

                upBtn.focus();
                repaint();
            }, 0);
        }




        function showPowerPuzzle() {
            const f = gameState.main.flags;

            if (f.powerOn) {
                updateMessage('ÈõªÊ∫ê„ÅØ„Åô„Åß„Å´ÂÖ•„Å£„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            const content = `
      <div style="margin-top:10px;">
        <input id="powerInput" class="puzzle-input" type="text"
               placeholder="„Å≤„Çâ„Åå„Å™ / English" autocomplete="off" />
        <div>
          <button id="powerOk" class="nav-btn" style="margin-top:8px;font-size:1.4rem;background-color:#1d9fff;color:#fff;">OK</button>
        </div>
        <div id="powerHint" style="margin-top:10px; font-size:0.95em; min-height:1.2em;"></div>
      </div>
    `;

            showModal('ÈõªÊ∫ê„ÅÆ„É≠„ÉÉ„ÇØ', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);

            setTimeout(() => {
                const input = document.getElementById('powerInput');
                const okBtn = document.getElementById('powerOk');
                const hint = document.getElementById('powerHint');
                if (!input || !okBtn) return;

                const normalize = (s) => (s ?? '').toString().trim().normalize('NFKC');

                const judge = () => {
                    const vRaw = normalize(input.value);
                    const vLower = vRaw.toLowerCase();

                    const isOk = (vRaw === '„Åï„Åé„Åó' || vLower === 'lie');

                    if (isOk) {
                        f.powerOn = true;

                        playSE?.('se-power');
                        closeModal();
                        updateMessage('„Ç´„ÉÅ„ÉÉ‚Ä¶ÈõªÊ∫ê„ÅåÂÖ•„Å£„Åü„ÄÇ');
                        markProgress('28_power_on');
                        renderCanvasRoom?.();
                    } else {
                        playSE?.('se-error');
                        if (hint) hint.textContent = '„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                        screenShake?.(document.getElementById('modalContent'), 120, 'fx-shake');
                    }
                };

                okBtn.addEventListener('click', judge);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') judge();
                });

                input.focus();
            }, 0);
        }





        // Â∑•ÂÖ∑Ôºà„Éâ„É©„Ç§„Éê„Éº/„Éè„É≥„Éû„Éº/„Ç≠„É£„ÉÉ„Éó„Ç™„Éº„Éó„Éä„ÉºÔºâ„ÅØ„Äå„Å©„Çå„Åã1„Å§„Å†„ÅëÊâÄÊåÅ„Äç‰ªïÊßò
        function getCurrentToolId() {
            if (hasItem('miracleDriver')) return 'miracleDriver';
            if (hasItem('luckyHammer')) return 'luckyHammer';
            const tools = ['driver', 'hammer', 'opener'];
            return tools.find(t => hasItem(t)) || null;
        }

        function swapTool(nextToolId) {
            const hasMiracle = !!(gameState.main?.flags?.hasMiracleDriver) || hasItem('miracleDriver');
            const primaryTool = hasMiracle ? 'miracleDriver' : 'driver';
            const hasLuckyHammer = !!(gameState.main?.flags?.hasLuckyHammer) || hasItem('luckyHammer');
            const primaryHammer = hasLuckyHammer ? 'luckyHammer' : 'hammer';
            const tools = [primaryTool, primaryHammer, 'opener'];
            const cur = getCurrentToolId();
            // Âêå„Åò„ÇÇ„ÅÆ„ÇíÈÅ∏„Çì„Å†„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (cur === nextToolId) {
                closeModal();
                return;
            }
            // Êó¢Â≠ò„ÅÆÂ∑•ÂÖ∑„ÅØÂÖ®ÈÉ®Êç®„Å¶„Å¶„ÄÅÈÅ∏„Çì„Å†„ÇÇ„ÅÆ„Å†„ÅëÊåÅ„Å§
            tools.forEach(t => {
                if (t !== nextToolId) removeItem(t);
            });
            addItem(nextToolId);

            closeModal();
            renderCanvasRoom();
            updateMessage(`${getItemName(nextToolId)}„ÇíÊåÅ„Å£„Åü„ÄÇ`);
        }

        function showToolShelfModal() {
            const cur = getCurrentToolId();
            const title = cur
                ? `ÁèæÂú®„ÅØ${getItemName(cur)}„ÇíÊåÅ„Å£„Å¶„ÅÑ„Çã„ÄÇ‰Ωø„ÅÑ„Åü„ÅÑ„ÇÇ„ÅÆ„ÇíÈÅ∏„Çì„Åß‰∏ã„Åï„ÅÑ`
                : '‰Ωø„ÅÑ„Åü„ÅÑÂ∑•ÂÖ∑„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ';

            const hasMiracle = !!(gameState.main?.flags?.hasMiracleDriver) || hasItem('miracleDriver');
            const primaryTool = hasMiracle ? 'miracleDriver' : 'driver';
            const hasLuckyHammer = !!(gameState.main?.flags?.hasLuckyHammer) || hasItem('luckyHammer');
            const primaryHammer = hasLuckyHammer ? 'luckyHammer' : 'hammer';
            const tools = [primaryTool, primaryHammer, 'opener'];

            const buttons = tools
                // ÊâÄÊåÅ‰∏≠„ÅØ„ÄåÈùûË°®Á§∫„ÄçÔºàÔºùÈÅ∏ÊäûËÇ¢„Åã„ÇâÂ§ñ„ÅôÔºâ
                .filter(t => t !== cur)
                .map(t => ({
                    img: IMAGES.items[t],
                    text: getItemName(t),
                    action: () => swapTool(t)
                }));

            buttons.push({ text: 'Èñâ„Åò„Çã', action: 'close' });

            showModal(
                title,
                `<div style="margin-top:8px; font-size:0.95em; opacity:0.9;">Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊåÅ„Å°Êõø„ÅàÔºâ</div>`,
                buttons
            );
        }

        function ensureLetterRot(reset = false) {
            const f = gameState.main.flags || (gameState.main.flags = {});
            if (f.unlockDrawerTop) {
                f.letterRot = { l: 0, o: 0, c: 0, k: 0 };
                f.letterRotSolved = true;
                return f.letterRot;
            }
            if (reset || !f.letterRot) {
                f.letterRot = { l: 270, o: 0, c: 90, k: 180 };
                f.letterRotSolved = false;
                return f.letterRot;
            }

            const rot = f.letterRot;
            const ok = ['l', 'o', 'c', 'k'].every(k => ((rot[k] || 0) % 360) === 0);
            if (ok && !f.letterRotSolved) {
                playSE?.('se-clear');
            }
            f.letterRotSolved = ok;
            return rot;
        }


        // ‚ñº ÊñáÂ≠óÊìç‰Ωú„É¢„Éº„ÉÄ„É´Ôºàroom:main „ÅÆÊùøÔºâ
        function showLetterControlModal() {
            const f = gameState.main.flags || (gameState.main.flags = {});

            // ÂõûËª¢Áä∂ÊÖã„Çí‰øùÊåÅÔºàÂàùÊúüÁä∂ÊÖãÔºöl=270, c=90, k=180, o=0Ôºâ
            // if (!f.letterRot) {
            f.letterRot = { l: 270, o: 0, c: 90, k: 180 };
            // }
            const rot = f.letterRot;

            const tile = (key, withBtn) => {
                const spacer = `<div style="height:26px;"></div>`;
                const btn = `
            <button id="letterBtn_${key}" class="letter-rot-btn" aria-label="${key} rotate"></button>
        `;
                return `
            <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
                <div class="letter-tile">
                    <img id="letterImg_${key}" src="${IMAGES.items[key]}" class="letter-img" style="transform:rotate(${rot[key] || 0}deg);">
                </div>
                ${withBtn ? btn : spacer}
            </div>
        `;
            };

            const content = `
        <div style="display:flex;justify-content:center;gap:14px;margin-top:10px;">
            ${tile('l', true)}
            ${tile('o', false)}
            ${tile('c', true)}
            ${tile('k', true)}
        </div>

        <style>
            .letter-tile{
    width:90px;
    height:90px;   /* ‚Üê Á∏¶„Çí‰º∏„Å∞„Åô */
    background:#fff;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}

.letter-img{
    width:48px;
    height:80px;   /* ‚Üê Á∏¶Èï∑ */
    object-fit: contain;
    image-rendering: pixelated;
}
            .letter-rot-btn{
                width:72px;height:26px;
                border-radius:10px;
                border: 2px solid #d4af37;
                background: rgba(244,241,232,0.75);
                cursor:pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            }
            .letter-rot-btn:hover{
                filter: brightness(1.03);
            }
            .letter-rot-btn:active{
                transform: translateY(1px);
                filter: brightness(0.98);
            }
        </style>
    `;

            showModal(
                'üîí',
                content,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );

            const update = () => {
                ['l', 'o', 'c', 'k'].forEach(k => {
                    const img = document.getElementById('letterImg_' + k);
                    if (img) img.style.transform = `rotate(${(rot[k] || 0)}deg)`;
                });
            };

            const rotateCW = (k) => {
                rot[k] = ((rot[k] || 0) + 90) % 360;
                playSE('se-click');
                update();
            };

            const btnL = document.getElementById('letterBtn_l');
            const btnC = document.getElementById('letterBtn_c');
            const btnK = document.getElementById('letterBtn_k');

            if (btnL) btnL.onclick = () => rotateCW('l');
            if (btnC) btnC.onclick = () => rotateCW('c');
            if (btnK) btnK.onclick = () => rotateCW('k');
        }

        function showBearFairyEvent() {
            showModal(
                '„Å©„Åì„Åã„Çâ„Å®„ÇÇ„Å™„Åè„ÇØ„ÉûÂ¶ñÁ≤æ„Åå„ÅÇ„Çâ„Çè„Çå„Åü„ÄÇ<br>„ÄåËâØ„ÅÑÂåÇ„ÅÑ‚Ä¶„Äç',
                `<img src="${IMAGES.modals.bearAppear}" style="width:100%;max-width:360px;">`,
                [
                    {
                        text: 'ÁÑº„Åç„Åä„Å´„Åé„Çä„Çí„ÅÇ„Åí„Çã',
                        action: () => {
                            // ÁÑº„Åç„Åä„Å´„Åé„ÇäÊ∂àË≤ª
                            removeItem('yakiOnigiri');
                            updateInventoryDisplay?.();

                            gameState.main.flags.bearAppear = true;
                            closeModal();

                            // ‚òÖÂàÜÂ≤êÔºö„Ç´„ÉãÂêõ„ÅåÊ≠ª‰∫°„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈÄÄÂ†¥„Åó„Å™„ÅÑ
                            if (gameState.main.flags.kaniDead) {
                                // ÂÖà„Å´„ÄåÈ£ü„Åπ„Çã„Äç„É¢„Éº„ÉÄ„É´
                                showModal(
                                    '„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÁÑº„Åç„Åä„Å´„Åé„Çä„ÇíÈ£ü„Åπ„Å¶„ÅÑ„Çã',
                                    `<img src="${IMAGES.modals.bearEat}" style="width:100%;max-width:360px;">`,
                                    [{ text: '„Å§„Å•„Åë„Çã', action: 'close' }]
                                );
                                playSE('se-bear-eat');

                                // Ê¨°„É¢„Éº„ÉÄ„É´ÔºöÊ∞ó„Å•„ÅèÔºàÁæéÂë≥„Åó„ÅÑ‚Ä¶„ÇìÔºüÔºâ
                                window._nextModal = () => {
                                    showModal(
                                        'ÁæéÂë≥„Åó„ÅÑ‚Ä¶„ÇìÔºü',
                                        `<img src="${IMAGES.modals.bearNotice}" style="width:100%;max-width:360px;">`,
                                        [
                                            {
                                                text: 'Èñâ„Åò„Çã',
                                                action: () => {
                                                    // ‚òÖÂæÖÊ©üÁä∂ÊÖã„Å∏
                                                    gameState.main.flags.bearStandsby = true;
                                                    renderCanvasRoom();
                                                    closeModal();
                                                }
                                            }
                                        ]
                                    );
                                };
                                updateMessage('„ÇØ„ÉûÂ¶ñÁ≤æ„ÅåÁèæ„Çå„Åü„ÄÇ');

                                return;
                            }

                            // ‚òÖÈÄöÂ∏∏„É´„Éº„ÉàÔºöÈÄÄÂ†¥Ôºà‰ªä„Åæ„ÅßÈÄö„ÇäÔºâ
                            // setTimeout(() => {
                            showModal(
                                '„Äå„Çè„Éº„ÅÑ„Äç<br>„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÂ¨â„Åó„Åù„ÅÜ„Å´Âéª„Å£„Å¶Ë°å„Å£„Åü',
                                `<img src="${IMAGES.modals.bearLeave}" style="width:100%;max-width:360px;">`,
                                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                            );
                            playSE('se-bear-flying');
                            updateMessage('„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÂéª„Å£„Å¶Ë°å„Å£„Åü„ÄÇ');
                            // }, 200);
                        }
                    }
                ]
            );
        }

        function handleDoor() {
            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÈÅ∑ÁßªÂÖ±ÈÄö„Éè„É≥„Éâ„É©
            const trueEndFlg = gameState.flags.trueEndUnlocked
            const goEnding = () => {
                // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÈÅ∑ÁßªÊôÇ„Å´‰æùÈ†ºÂìÅ„ÇíÊ∂àË≤ª
                removeItem('redSphere');
                removeItem('onigiriSphere');

                if (trueEndFlg) {

                    gameState.endings.true = true;
                    travelWithStepsTrueEnd();


                } else {
                    travelWithSteps('end');
                }
            };

            goEnding();
        }

        function showObj(flagKey, title, imgSrc, msg, altImgSrc, msgEn) {
            const f = gameState.main.flags;
            if (flagKey) f[flagKey] = true;

            const imgId = 'objImg_' + Date.now();

            // ‚òÖ uiLang„Å´ÈÄ£ÂãïÔºöen„Å™„Çâ alt „ÇíÂàùÊúüË°®Á§∫Ôºà„ÅÇ„Çå„Å∞Ôºâ
            const hasEn = !!altImgSrc;
            let isEn = (uiLang === 'en') && hasEn;

            const content =
                `<img id="${imgId}" src="${isEn ? altImgSrc : imgSrc}"
      style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`;

            const buttons = [];

            // ‚òÖ „ÄåË®ÄË™ûÂàáÊõø„Äç„Éú„Çø„É≥ÔºöuiLang„ÇÇ‰∏ÄÁ∑í„Å´„Éà„Ç∞„É´„Åó„Å¶ÂÖ®‰Ωì„Å®ÂêåÊúü
            if (hasEn) {
                buttons.push({
                    text: 'üåê EN/JP',
                    action: () => {
                        const el = document.getElementById(imgId);
                        if (!el) return;

                        uiLang = (uiLang === 'en') ? 'jp' : 'en';
                        isEn = (uiLang === 'en');

                        el.src = isEn ? altImgSrc : imgSrc;

                        // „É°„ÉÉ„Çª„Éº„Ç∏„ÇÇÂàáÊõøÔºàËã±Ë™ûÊñá„ÅåÁÑ°„ÅÑ„Å™„ÇâÊó¢Â≠òmsg„Çí‰Ωø„ÅÜÔºâ
                        // updateMessage(isEn ? (msgEn || 'Showing English version') : msg);
                    }
                });
            }

            buttons.push({ text: 'Èñâ„Åò„Çã', action: 'close' });

            showModal(title, content, buttons);
            updateMessage(isEn ? (msgEn || msg) : msg);
        }

        function escapeHtml(str) {
            if (typeof str !== "string") return str;

            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }


        // =========================
        // „É¨„Ç∑„ÉîÂõ≥ÈëëÔºà„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Ôºâ„Ç∑„Çπ„ÉÜ„É†
        // =========================

        // „É¨„Ç∑„ÉîËß£Êîæ„ÅÆ„Ç≠„Éº„ÅØ„ÄåÂÆåÊàêÂìÅ + Á¥†Êùê2„Å§(‰∏¶„Å≥Êõø„Åà) + Âë™Êñá(Ê≠£Ë¶èÂåñ)„Äç
        function ensureRecipeCodex() {
            if (!gameState.recipeCodex) gameState.recipeCodex = { discovered: {} };
            if (!gameState.recipeCodex.discovered) gameState.recipeCodex.discovered = {};
            return gameState.recipeCodex;
        }

        function recipeCodexKey(materials2, spellText, resultId) {
            const mats = (materials2 || []).slice().sort();
            const spell = normalizeSpell(spellText);
            return [String(resultId || ''), mats.join('+'), spell].join('|');
        }

        function recipeCodexUnlock(recipe) {
            if (!recipe) return false;
            const codex = ensureRecipeCodex();
            const key = recipeCodexKey(recipe.materials, recipe.spell, recipe.result);
            if (codex.discovered[key]) return false;

            codex.discovered[key] = {
                result: recipe.result,
                materials: (recipe.materials || []).slice(),
                spell: recipe.spell || ''
            };
            return true;
        }

        function recipeCodexIsUnlocked(recipe) {
            const codex = ensureRecipeCodex();
            const key = recipeCodexKey(recipe.materials, recipe.spell, recipe.result);
            return !!codex.discovered[key];
        }

        function openRecipeCodex() {
            ensureRecipeCodex();

            // ALCHEMY_RECIPES „ÅÆÈ†ÜÁï™„Åå„Åù„ÅÆ„Åæ„ÅæÂõ≥Èëë„ÅÆ No. „Å´„Å™„ÇãÔºàÂ¢ó„ÇÑ„Åô„Åª„Å©Â¨â„Åó„ÅÑ„ÇÑ„Å§Ôºâ
            // ‰ªïÊßòÔºöÊúÄÂàù„Åã„Çâ 8 Ë°å„ÇíÂõ∫ÂÆöË°®Á§∫„ÄÇÊú™Áô∫Ë¶ã„ÅØÂÖ®ÈÉ®„ÄåÔºüÔºüÔºü„Äç„ÅßËñÑ„ÅèË°®Á§∫„ÄÇ
            const TOTAL_RECIPES = 8;
            const list = (ALCHEMY_RECIPES || []);
            const rows = Array.from({ length: ALCHEMY_RECIPES.length }, (_, i) => {
                const r = list[i]; // Êú™ÂÆöÁæ©„Å™„Çâ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄÊâ±„ÅÑ
                const unlocked = !!(r && recipeCodexIsUnlocked(r));

                const resultName = (unlocked && r) ? getItemName(r.result) : 'ÔºüÔºüÔºü';
                const resultImg = (unlocked && r && IMAGES.items && IMAGES.items[r.result]) ? IMAGES.items[r.result] : '';
                const resultCell = unlocked
                    ? `<div style="display:flex;align-items:center;gap:8px;">
               ${resultImg ? `<img src="${resultImg}" style="width:40px;height:40px;image-rendering:pixelated;object-fit:contain;" />` : ''}
               <span style="font-weight:800;">${escapeHtml(resultName)}</span>
           </div>`
                    : `<span>ÔºüÔºüÔºü</span>`;

                const matNames = (unlocked && r)
                    ? (r.materials || []).map(id => getItemName(id)).join(' + ')
                    : 'ÔºüÔºüÔºü';

                const spell = (unlocked && r) ? (r.spell || '') : 'ÔºüÔºüÔºü';

                return `
        <tr class="${unlocked ? 'recipe-discovered' : 'recipe-undiscovered'}">
            <td style="width:48px;text-align:right;">${i + 1}</td>
            <td>${resultCell}</td>
            <td>${escapeHtml(matNames)}</td>
            <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">${escapeHtml(spell)}</td>
        </tr>
    `;
            }).join('');

            const content = `
        <div style="opacity:.92;margin:6px 0 10px 0;font-size:.95em;">
            ‰ªä„Åæ„Åß„Å´ÊàêÂäü„Åó„Åü„É¨„Ç∑„Éî
        </div>

        <table class="evidence">
            <thead>
                <tr>
                    <th style="width:56px;">No.</th>
                    <th>ÂÆåÊàêÂìÅ</th>
                    <th>Á¥†Êùê</th>
                    <th>Âë™Êñá</th>
                </tr>
            </thead>
            <tbody>
                ${rows || '<tr><td colspan="4" style="text-align:center;opacity:.8;">Ôºà„É¨„Ç∑„Éî„Åå„Åæ„Å†ÁÑ°„ÅÑ‚Ä¶Èå¨Êàê„Åó„Çà„ÅÜÔºâ</td></tr>'}
            </tbody>
        </table>

        <style>
            .evidence {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.92em;
            }
            .evidence th, .evidence td {
                border: 1px solid #bbb;
                padding: 8px 8px;
                vertical-align: middle;
            }
            .evidence thead th{
                background: rgba(255, 248, 210, 0.95);
                color:#2c2c2c;
                position: sticky;
                top: 0;
                z-index: 1;
            }
            .evidence tbody{
                background: rgba(255,255,255,0.92);
                color:#222;
            }
            .evidence tr.recipe-discovered td {
                background: rgba(255, 248, 210, 0.92);
                font-weight: 600;
            }
            .evidence tr.recipe-undiscovered td {
                background: rgba(245, 245, 245, 0.75);
                color: #777;
                opacity: .45;
            }
        </style>
    `;

            // casefile È¢®„ÅÆË¶ã„ÅüÁõÆ„Çí„Åù„ÅÆ„Åæ„Åæ‰Ωø„ÅÜ
            showModal('üìñ „É¨„Ç∑„ÉîÂõ≥Èëë', content, [{ text: 'Èñâ„Åò„Çã', action: 'close' }], null, { columnButtons: false });
        }


        function renderStatusIcons() {
            const area = document.getElementById('statusIconArea');
            if (!area) return;

            // „Åô„Åß„Å´„ÅÇ„Çå„Å∞ÂÜçÊèèÁîª„Å†„ÅëÔºàËøΩÂä†‰∫àÂÆö„ÅåÂ¢ó„Åà„Å¶„ÇÇ„Åì„Åì„ÅßÁÆ°ÁêÜÔºâ
            area.innerHTML = '';

            const book = document.createElement('div');
            book.className = 'status-icon';
            book.textContent = 'üìñ';
            book.title = '„É¨„Ç∑„ÉîÂõ≥Èëë';
            book.style.cursor = 'pointer';
            book.onclick = () => openRecipeCodex();
            area.appendChild(book);
        }

        // „Ç¢„Ç§„ÉÜ„É†ÁÆ°ÁêÜ
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 14) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            } else {
                updateMessage('„Ç¢„Ç§„ÉÜ„É†Ê¨Ñ„Åå„ÅÑ„Å£„Å±„ÅÑ„Å†„ÄÇ„Å©„Åì„Åã„ÅßÊ∏õ„Çâ„Åó„Å¶„Åì„Çà„ÅÜ');
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }
        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            const clickedItem = gameState.inventory[slotIndex];
            if (!clickedItem) return;

            // -------------------------
            // 1) „Äå‰ΩøÁî®ÂØæË±°„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„Äç‰∏≠„Å™„Çâ„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Ç¢„Ç§„ÉÜ„É†„ÇíÂØæË±°„Å®„Åó„Å¶Âà§ÂÆö
            //    „ÉªÂà•„Ç¢„Ç§„ÉÜ„É†„ÇØ„É™„ÉÉ„ÇØ„Åß„Éï„É©„Ç∞Ëß£Èô§ÔºàÊàêÂäü/Â§±Êïó„Å©„Å£„Å°„Åß„ÇÇÔºâ
            //    „ÉªÂ§±ÊïóÊôÇ„ÅØÁÑ°Èü≥Ôºà„É°„ÉÉ„Çª„Éº„Ç∏„ÇÇÂá∫„Åï„Å™„ÅÑÔºâ
            // -------------------------
            if (gameState.usingItem) {
                // Âêå„Åò„Çπ„É≠„ÉÉ„Éà„ÇíÊäº„Åó„Åü„Çâ„Ç≠„É£„É≥„Çª„É´Ôºà„É°„ÉÉ„Çª„Éº„Ç∏„ÅØÂá∫„Åó„Å¶„ÇÇÂá∫„Åï„Å™„Åè„Å¶„ÇÇOKÔºâ
                if (gameState.usingItem.slotIndex === slotIndex) {
                    clearUsingItem(true);
                    return;
                }

                const success = tryPutSaltOnYakisoba(clickedItem);

                // ÊàêÂäü„Åß„ÇÇÂ§±Êïó„Åß„ÇÇËß£Èô§Ôºà‰ªïÊßò„Å©„Åä„ÇäÔºâ
                clearUsingItem(true);

                if (success) {
                    updateMessage('ÁÑº„Åç„Åù„Å∞„Å´Â°©„ÇíÊåØ„Å£„Åü„ÄÇ');
                    gameState.main.flags.useSaltToYakisoba = true;
                    updateInventoryDisplay();
                }
                return;
            }

            // -------------------------
            // 2) Â°©„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Çâ„Äå‰ΩøÁî®ÂØæË±°ÈÅ∏Êäû„É¢„Éº„Éâ„Äç„Å∏
            // -------------------------
            if (clickedItem === 'salt') {
                gameState.usingItem = { itemId: clickedItem, slotIndex };
                gameState.selectedItem = clickedItem;
                gameState.selectedItemSlot = slotIndex;
                updateMessage('‰ΩøÁî®ÂØæË±°„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ');
                updateInventoryDisplay();
                return;
            }

            // -------------------------
            // 3) „Åù„Çå‰ª•Â§ñ„ÅØ‰ªä„Åæ„ÅßÈÄö„Çä„ÅÆÊåôÂãïÔºàÊó¢Â≠ò„É≠„Ç∏„ÉÉ„ÇØÔºâ
            // -------------------------

            // ‚òÖ„Åô„Åß„Å´ÈÅ∏Êäû‰∏≠„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÇíÂÜç„ÇØ„É™„ÉÉ„ÇØ ‚Üí Ëß£Èô§
            if (gameState.selectedItem && gameState.selectedItemSlot !== slotIndex) {
                const a = gameState.selectedItem;
                const b = clickedItem;
                const isRecipePair = (a === 'recipe1' && b === 'recipe2') || (a === 'recipe2' && b === 'recipe1');
                if (isRecipePair) {
                    clearUsingItem(true);
                    showModal(
                        '„É¨„Ç∑„Éî„ÅÆÂàá„ÇåÁ´Ø„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Åæ„Åô„ÅãÔºü',
                        '',
                        [
                            {
                                text: '„ÅØ„ÅÑ',
                                action: () => {
                                    closeModal();
                                    removeItem('recipe1');
                                    removeItem('recipe2');
                                    addItem('recipeFixed');
                                    updateMessage('„É¨„Ç∑„Éî„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Åü');
                                }
                            },
                            { text: '„ÅÑ„ÅÑ„Åà', action: 'close' }
                        ]
                    );
                    return;
                }
            }

            if (gameState.selectedItemSlot === slotIndex) {
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateMessage('„Ç¢„Ç§„ÉÜ„É†ÈÅ∏Êäû„ÇíËß£Èô§„Åó„Åæ„Åó„Åü„ÄÇ');
                updateInventoryDisplay();
                return;
            }

            // ‚òÖÈÄöÂ∏∏„ÅÆÈÅ∏Êäû
            gameState.selectedItem = clickedItem;
            gameState.selectedItemSlot = slotIndex;
            updateMessage('„Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏Êäû„Åó„Åü„ÄÇ');
            updateInventoryDisplay();
        }



        function clearUsingItem(silent = true) {
            gameState.usingItem = null;
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;
            updateInventoryDisplay();
            // silent=true „Å™„Çâ„É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞„ÇÇ„Åó„Å™„ÅÑÔºàÂ§±ÊïóÊôÇ„ÅØÁÑ°Èü≥Ôºâ
            if (!silent) updateMessage('„Ç¢„Ç§„ÉÜ„É†ÈÅ∏Êäû„ÇíËß£Èô§„Åó„Åæ„Åó„Åü„ÄÇ');
        }

        function tryPutSaltOnYakisoba(targetItemId) {
            if (targetItemId != 'yakisoba') {
                return false;
            }
            gameState.main.flags.saltToYakisobaCnt++;
            showModal(
                'ÁÑº„Åç„Åù„Å∞„Å´Â°©„ÇíÊåØ„Å£„Åü',
                `<img src="${IMAGES.modals.yakisobaSalt}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [
                    {
                        text: 'Èñâ„Åò„Çã',
                        action: () => {
                            closeModal();

                        }
                    }
                ]
            );
            return true;
        }


        function getItemName(itemId) {
            const names = {
                coin: '„ÇØ„Éû„Ç≥„Ç§„É≥',
                bear: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                driver: '„Éâ„É©„Ç§„Éê„Éº',
                miracleDriver: '„Éü„É©„ÇØ„É´„Éâ„É©„Ç§„Éê„Éº',
                hammer: '„Éè„É≥„Éû„Éº',
                luckyHammer: '„É©„ÉÉ„Ç≠„Éº„Éè„É≥„Éû„Éº',
                opener: '„Ç≠„É£„ÉÉ„Éó„Ç™„Éº„Éó„Éä„Éº',
                key: 'Èçµ',
                core: '„Ç≥„Ç¢',
                gemBlue: 'Èùí„ÅÑÂÆùÁü≥',
                gemRed: 'Ëµ§„ÅÑÂÆùÁü≥',
                gemGreen: 'Á∑ë„ÅÆÂÆùÁü≥',
                gemViolet: 'Á¥´„ÅÆÂÆùÁü≥',
                gemOnigiri: 'Á©∂Ê•µ„ÅÆÂÆùÁü≥',
                onigiri: '„Åä„Å´„Åé„Çä',
                recipe1: '„É¨„Ç∑„Éî„ÅÆÂàá„ÇåÁ´Ø',
                recipe2: 'Á¥ô„ÅÆÂàá„ÇåÁ´Ø',
                recipeFixed: 'Âæ©ÂÖÉ„Åó„Åü„É¨„Ç∑„Éî',
                redSphere: 'Ëµ§Ëâ≤Áô∫ÂÖâÁéâ',
                onigiriSphere: '„Éü„É©„ÇØ„É´Áô∫ÂÖâÁéâ'



            };
            return names[itemId] || itemId;
        }


        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';

            const isMobile = window.matchMedia('(max-width: 600px)').matches;

            if (isMobile) {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = '„Éä„Éì';
                btn.onclick = () => openNavModal();
                navDiv.appendChild(btn);
                return;
            }

            // PC„ÅØÂæìÊù•ÈÄö„ÇäÔºà„É´„Éº„É†„Éú„Çø„É≥‰∏¶„Åπ„ÇãÔºâ
            gameState.openRooms.forEach(roomId => {
                const b = document.createElement('button');
                b.className = 'nav-btn';
                b.textContent = rooms[roomId].name;
                b.onclick = () => changeRoom(roomId);
                navDiv.appendChild(b);
            });
        }

        function openNavModal() {
            const cur = gameState.currentRoom;
            const listHtml = `
    <div style="display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto;">
      ${gameState.openRooms.map(roomId => {
                const isHere = roomId === cur;
                return `
          <button class="nav-btn" style="width:100%; opacity:${isHere ? 0.5 : 1};"
            ${isHere ? 'disabled' : ''}
            onclick="(function(){ closeModal(); changeRoom('${roomId}'); })()">
            ${rooms[roomId].name}${isHere ? 'Ôºà„Åì„ÅìÔºâ' : ''}
          </button>
        `;
            }).join('')}
    </div>
  `;
            showModal('ÁßªÂãïÂÖà', listHtml, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
        }

        function addNaviItem(room) {
            if (!gameState.openRooms.includes(room)) {
                gameState.openRooms.push(room);
                return true;
            }
            return false;
        }

        // „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫Êõ¥Êñ∞
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function () {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                    const magBtn = document.createElement('div');
                    magBtn.className = 'magnifier-btn';
                    magBtn.title = 'Êã°Â§ßË°®Á§∫';
                    magBtn.innerHTML = '<img src="images/magnifier.png" alt="Êã°Â§ß">';
                    magBtn.onclick = (e) => {
                        e.stopPropagation();

                        const itemId = gameState.inventory[index];


                        // „Éá„Éï„Ç©„ÅÆ‰∏≠Ë∫´
                        let content = `<img src="${img.src}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`;
                        let buttons = [{ text: 'Èñâ„Åò„Çã', action: 'close' }];


                        if (itemId === 'recipeFixed') {
                            buttons = [
                                {
                                    text: 'Ë£è„ÇíË¶ã„Çã',
                                    action: () => {


                                        window._nextModal = {
                                            title: '„É¨„Ç∑„Éî„ÇíË£èËøî„Åó„Åü',
                                            content: `<img src="${IMAGES.modals.recipeBack}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`,
                                            buttons: [
                                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                                            ],
                                        };
                                        closeModal();
                                        updateMessage('„É¨„Ç∑„Éî„ÇíË£èËøî„Åó„Åü');

                                    }
                                },
                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                            ];
                        }
                        if (itemId === 'driver') {
                            buttons = [
                                {
                                    text: 'Ë™ø„Åπ„Çã',
                                    action: () => {


                                        window._nextModal = {
                                            title: 'ÊåÅ„Å°Êâã„Çí„Çà„ÅèË¶ã„Åü',
                                            content: `<img src="${IMAGES.modals.driverBottom}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`,
                                            buttons: [
                                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                                            ],
                                        };
                                        closeModal();
                                        updateMessage('„Éâ„É©„Ç§„Éê„Éº„ÅÆÊåÅ„Å°Êâã„Çí„Çà„ÅèË¶ã„Åü');

                                    }
                                },
                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                            ];
                        }
                        if (itemId === 'hammer' && gameState.main?.flags?.useHammerToNabe) {
                            buttons = [
                                {
                                    text: 'Ë™ø„Åπ„Çã',
                                    action: () => {
                                        window._nextModal = {
                                            title: 'ÂÅ¥Èù¢„Çí„Çà„ÅèË¶ã„Åü',
                                            content: `<img src="${IMAGES.modals.hammerSide}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`,
                                            buttons: [
                                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                                            ],
                                        };
                                        closeModal();
                                        updateMessage('„Éè„É≥„Éû„Éº„ÅÆÂÅ¥Èù¢„Çí„Çà„ÅèË¶ã„Åü');
                                    }
                                },
                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                            ];
                        }


                        showModal(
                            getItemName(itemId),
                            content,
                            buttons
                        );
                    };
                    slot.appendChild(magBtn);
                }
                // ‚òÖÈÅ∏Êäû‰∏≠„Å™„Çâselected„ÇØ„É©„ÇπËøΩÂä†
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }


        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        function updateMessage(message) {
            //document.getElementById('messageArea').innerHTML = message;
            document.getElementById('msgText').textContent = message;
            try { renderStatusIcons(); } catch (e) { }
        }

        function updateMessageHTML(html) {
            const el = document.getElementById('msgText');
            el.innerHTML = html;
            try { renderStatusIcons(); } catch (e) { }
            el.querySelectorAll('a').forEach(a => {
                a.target = '_blank';
                a.rel = 'noopener';
                a.style.color = '#d4af37';
                a.style.textDecoration = 'underline';
            });
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content, buttons, onSequenceSuccess, options) {
            options = options || {};
            let modalHtml = `<h3>${title}</h3><div>${content}</div>`;
            if (buttons && buttons.length > 0) {
                const columnStyle = options.columnButtons
                    ? 'display:flex; flex-direction:column; gap:12px; align-items:stretch;'
                    : 'text-align:center; display:flex; gap:10px; justify-content:center;';

                modalHtml += `<div id="modalButtons" style="${columnStyle}"></div>`;
                modalHtml += `<div id="modalClose" style="margin-top:25px;text-align:center;"></div>`;
            }
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';

            if (!buttons || buttons.length === 0) return;

            let pressed = [];
            let heartCnt = 0;
            let checkCnt = 0;
            let houseCnt = 0;

            // ÁîªÂÉè/ÈÄöÂ∏∏„Éú„Çø„É≥„Å®close„Éú„Çø„É≥„ÅßÂàÜ„Åë„Çã
            const modalButtons = document.getElementById('modalButtons');
            const modalClose = document.getElementById('modalClose');

            buttons.forEach((button, idx) => {
                // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅØ‰∏ã„Å∏
                if (button.action === 'close') {
                    const btn = document.createElement('button');
                    btn.textContent = button.text || 'Èñâ„Åò„Çã';
                    btn.className = 'modal-close-btn';
                    btn.onclick = function () {
                        closeModal();
                        if (typeof onSequenceSuccess === "function") {
                            onSequenceSuccess();
                        }
                    };
                    modalClose.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.style.margin = "0 10px 10px 0";
                    if (button.img) {
                        btn.innerHTML = `<img src="${button.img}" alt="${button.text || ''}" style="width:80px;height:80px;vertical-align:middle;">`;
                    } else {
                        btn.textContent = button.text;
                        btn.className = 'text-btn';
                    }
                    btn.onclick = function () {
                        if (button.action === 'restart') {
                            restartGame();
                        } else if (typeof button.action === "function") {
                            button.action();
                        } else if (typeof button.action === 'string') {
                            closeModal();
                            handleAreaClick(button.action);
                        }
                    };
                    modalButtons.appendChild(btn);
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
            if (window._nextModal) {
                // ÁôªÈå≤ÂÜÖÂÆπ„ÅØ {title, content, buttons, after} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                let modal = window._nextModal;
                window._nextModal = null; // „ÇØ„É™„Ç¢

                if (typeof modal === 'function') {
                    try { modal(); } catch (e) { }
                    window.dispatchEvent(new Event('modal:closed'));
                    return;
                }

                if (modal.before) modal.before();
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after();
            }
            window.dispatchEvent(new Event('modal:closed'));
        }

        // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„Éà
        function restartGame() {
            gameState = getDefaultGameState();
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;
        let isBGMInitialized = false; // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®

        // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Å†„ÅëBGM„ÇíÂÜçÁîü
        function initBGMOnce() {
            if (!isBGMInitialized) {
                const bgm = document.getElementById('bgm');
                bgm.volume = 0.3;
                bgm.play();
                isBGMPlaying = true;
                isBGMInitialized = true;
                document.getElementById('bgm-toggle').textContent = "üîä BGM";
            }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "üîä BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "üîá BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // „Éï„Ç°„Ç§„É´Âêç„ÅÆ„Åø„ÅßÊØîËºÉ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            if (current === next) return; // „Åô„Åß„Å´„Åù„ÅÆBGM„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function pauseBGM() {
            const bgm = document.getElementById('bgm');
            bgm.src = "";
            bgm.pause();
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }
        function stopSE(id) {
            const se = document.getElementById(id);
            se.pause();
        }

        // „Å©„Åì„Åã„ÅßÊúÄÂàù„Å´‰∏ÄÂ∫¶„Å†„ÅëÂëº„Å∂
        let loadedImages = {};
        function preloadImages() {
            // ÈÉ®Â±ãÁîªÂÉè
            Object.values(IMAGES.rooms).forEach(val => {
                // ‚òÖËøΩÂä†Ôºö{jp:[...], en:[...]} ÂΩ¢Âºè
                if (val && typeof val === 'object' && !Array.isArray(val)) {
                    ['jp', 'en'].forEach(lang => {
                        const list = val[lang];
                        if (Array.isArray(list)) {
                            list.forEach(src => {
                                if (!loadedImages[src]) {
                                    const img = new Image();
                                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                                    img.src = src;
                                    loadedImages[src] = img;
                                }
                            });
                        } else if (typeof list === 'string') {
                            if (!loadedImages[list]) {
                                const img = new Image();
                                img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                                img.src = list;
                                loadedImages[list] = img;
                            }
                        }
                    });
                    return; // ‚òÖ„Åì„ÅÆval„ÅÆÂá¶ÁêÜ„ÅØÁµÇ„Çè„Çä
                }
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        if (!loadedImages[src]) {
                            const img = new Image();
                            img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                            img.src = src;
                            loadedImages[src] = img;



                        }
                    });
                } else if (typeof val === "string") {
                    if (!loadedImages[val]) {
                        const img = new Image();
                        img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                        img.src = val;
                        loadedImages[val] = img;
                    }
                }
            });
            // „Ç¢„Ç§„ÉÜ„É†ÁîªÂÉè
            Object.values(IMAGES.items).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
            // „É¢„Éº„ÉÄ„É´ÁîªÂÉè
            Object.values(IMAGES.modals).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
        }

        // save&load
        function saveGameToSlot(slotIndex) {
            const toSave = { ...gameState, __version: SAVE_VERSION };

            const payload = {
                data: toSave,
                savedAt: Date.now()
            };

            localStorage.setItem(SAVE_KEYS[slotIndex], JSON.stringify(payload));
            updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function loadGameFromSlot(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`);
                return;
            }

            let saved;
            try {
                const parsed = JSON.parse(raw);
                // Êñ∞ÂΩ¢ÂºèÔºö{ data: {...}, savedAt: ... }
                if (parsed && parsed.data) {
                    saved = parsed.data;
                } else {
                    // ÊóßÂΩ¢ÂºèÔºö„Åù„ÅÆ„Åæ„Åæ gameState „ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã
                    saved = parsed;
                }
            } catch (e) {
                console.error(e);
                updateMessage('„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return;
            }

            const def = getDefaultGameState();
            const merged = deepMerge(def, saved);

            if (!Array.isArray(merged.openRooms)) merged.openRooms = def.openRooms.slice();
            if (!merged.currentRoom || !rooms[merged.currentRoom]) merged.currentRoom = def.currentRoom;

            gameState = merged;

            changeRoom(gameState.currentRoom);
            updateInventoryDisplay?.();
            renderNavigation?.();
            updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function getSaveSlotLabel(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàÁ©∫Ôºâ`;
            }
            try {
                const parsed = JSON.parse(raw);
                const savedAt = parsed.savedAt;
                if (!savedAt) {
                    return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàÊó•ÊôÇ‰∏çÊòéÔºâ`;
                }
                const d = new Date(savedAt);
                const jp = d.toLocaleString('ja-JP');
                return `„Çª„Éº„Éñ${slotIndex + 1}Ôºà${jp}Ôºâ`;
            } catch {
                return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàË™≠„ÅøËæº„Åø„Ç®„É©„ÉºÔºâ`;
            }
        }

        function openLoadMenu() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0),
                    action: () => {
                        loadGameFromSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1),
                    action: () => {
                        loadGameFromSlot(1);
                        closeModal();
                    }
                },
                { text: '„ÇÑ„ÇÅ„Çã', action: 'close' }
            ];

            showModal('„É≠„Éº„Éâ„Åô„Çã„Éá„Éº„Çø„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ', '', buttons, null, { columnButtons: true });
        }

        function saveGame() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0) + ' „Å´‰∏äÊõ∏„Åç‰øùÂ≠ò',
                    action: () => {
                        saveGameToSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1) + ' „Å´‰∏äÊõ∏„Åç‰øùÂ≠ò',
                    action: () => {
                        saveGameToSlot(1);
                        closeModal();
                    }
                },
                { text: '„ÇÑ„ÇÅ„Çã', action: 'close' }
            ];

            showModal('„Çª„Éº„ÉñÂÖà„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ', '', buttons, null, { columnButtons: true });
        }

        function loadGame() {
            openLoadMenu();
        }

        function deepMerge(target, source) {
            if (source === undefined || source === null) return target;
            if (Array.isArray(source)) return source.slice();
            if (typeof source === 'object') {
                const out = (target && typeof target === 'object') ? { ...target } : {};
                for (const k of Object.keys(source)) {
                    out[k] = deepMerge(target ? target[k] : undefined, source[k]);
                }
                return out;
            }
            return source;
        }

        function showToast(text, ms = 2600) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = text;
            el.style.opacity = '1';
            el.style.transform = 'translateX(-50%) translateY(0)';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(-50%) translateY(-8px)';
            }, ms);
        }


        window.addEventListener('resize', () => renderNavigation());

        window.addEventListener('keydown', e => {
            if (e.key === 'F2') {
                DEV_MODE = !DEV_MODE;
                renderCanvasRoom();
            }
        });

        // „Ç≤„Éº„É†ÈñãÂßã
        preloadImages();
        initGame();
    </script>
    <div id="toast"
        style="position:fixed;left:50%;top:14px;transform:translateX(-50%);
padding:10px 14px;border-radius:8px;background:#1f6feb;color:#fff;font-weight:700;
box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s; z-index:9999;">
    </div>

</body>

</html>