<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ë¨é„ÅÆÊùë„ÇíËàûÂè∞„Å´„Åó„ÅüÁÑ°Êñô„Ç≤„Éº„É†„ÄÇ„Çπ„Éû„ÉõÔºÜPCÂØæÂøú„ÄÇ">
    <title>„Å™„Åû„Å™„ÅûÊùë„ÅÆËÑ±Âá∫</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;
            /* ‚Üê„Åì„ÇåÈáçË¶Å */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #gameCanvas {
            position: relative;
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
        }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            /* flex: 1; */
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 12px;
            /* width:100%; */
        }

        .inventory-slot {
            width: 14vw;
            height: 14vw;
            max-width: 80px;
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;
            /* ÈáëËâ≤„ÉªÂ§™„ÇÅÊé®Â•® */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .magnifier-btn {
            position: absolute;
            right: 4px;
            bottom: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0002;
            cursor: pointer;
            z-index: 10;
            transition: box-shadow .15s;
        }

        .magnifier-btn:hover {
            box-shadow: 0 0 10px #ffd70099;
        }

        .magnifier-btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .info-panel {
            width: 100%;
            padding: 2px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 2px;
            height: 65px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        #msgText {}

        #statusIconArea {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px #0005;
            font-size: 1.4em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        #modalButtons button {
            border: none;
            background: none;
            padding: 0;
            margin: 0 10px 10px 0;
            cursor: pointer;
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
            border-radius: 10px;
        }

        #modalButtons button img {
            width: 80px;
            height: 80px;
            vertical-align: middle;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
        }

        #modalButtons button:hover img {
            filter: brightness(1.08) drop-shadow(0 2px 6px #ffd70050);
            box-shadow: 0 0 10px #ffd70080;
            transform: scale(1.05);
        }

        #modalButtons button:active img,
        #modalButtons button.pressed img {
            filter: brightness(0.95) grayscale(20%);
            box-shadow: 0 0 8px #3332;
            transform: scale(0.97);
        }

        #modalButtons button:disabled img {
            filter: grayscale(90%) opacity(0.5);
            box-shadow: none;
        }

        /* „ÉÜ„Ç≠„Çπ„ÉàÂûã„Éú„Çø„É≥„ÇÇÁîªÂÉè„Éú„Çø„É≥È¢®„Å´ */
        #modalButtons button.text-btn {
            min-width: 120px;
            font-size: 1.15em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            margin: 0 10px 10px 0;
            box-shadow: 0 4px 14px #ffc90022;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s, transform 0.08s;
            vertical-align: middle;
            display: inline-block;
        }

        #modalButtons button.text-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
            transform: scale(1.05);
        }

        #modalButtons button.text-btn:active {
            filter: brightness(0.96);
            transform: scale(0.97);
        }

        #modalButtons button.text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Èñâ„Åò„Çã„Éú„Çø„É≥ */
        #modalClose .modal-close-btn {
            display: inline-block;
            min-width: 160px;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            box-shadow: 0 4px 14px #ffc90022;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s;
        }

        #modalClose .modal-close-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        .login-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            width: 280px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'Segoe UI', sans-serif;
        }

        .login-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .login-form label {
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .login-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .login-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ÁîªÂÉè„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }

        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            /* width: 40%; */
        }

        @media (max-width: 600px) {
            #msgText {
                font-size: .8rem;
            }

            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }

            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width: 100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }

        #roomEffectOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }

        .title-wrapper {
            display: flex;
            width: 100%;
        }

        @keyframes warpFlash {
            0% {
                opacity: 0
            }

            15% {
                opacity: .95
            }

            50% {
                opacity: .4
            }

            100% {
                opacity: 0
            }
        }

        @keyframes chroma {
            0% {
                filter: none
            }

            100% {
                filter: contrast(1.2) saturate(1.2) hue-rotate(20deg)
            }
        }

        .warp-active {
            background: radial-gradient(circle at 50% 50%, #fff, #000 70%);
            animation: warpFlash 900ms ease-out both, chroma 900ms ease-out both;
        }

        #hintModal {
            color: #000;
        }

        @keyframes glowPulse {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            60% {
                opacity: 0.9;
            }

            100% {
                opacity: 0;
            }

            /* Ëá™Âãï„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà */
        }


        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, .45);
            }

            50% {
                box-shadow: 0 0 18px 6px rgba(255, 255, 255, .35);
            }
        }



        /* ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Áî®„ÅÆÂÖ®ÁîªÈù¢„É¨„Ç§„É§ */
        #fxFlash {
            position: fixed;
            inset: 0;
            background: transparent;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
        }

        /* ÁôΩ„Éï„É©„ÉÉ„Ç∑„É• */
        @keyframes flashWhite {
            0% {
                opacity: 0;
                background: #fff;
            }

            12% {
                opacity: .95;
                background: #fff;
            }

            100% {
                opacity: 0;
                background: #fff;
            }
        }

        /* Ëµ§„Éï„É©„ÉÉ„Ç∑„É•Ôºà„Éü„ÇπÔºâ */
        @keyframes flashRed {
            0% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }

            18% {
                opacity: .85;
                background: rgba(255, 0, 0, 0.85);
            }

            100% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }
        }

        /* „Åª„Çì„ÅÆÂ∞ë„Åó„Ç´„É°„É©„Ç∑„Çß„Ç§„ÇØÔºàÂ•Ω„Åø„ÅßÔºâ */
        @keyframes camShake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, -1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, 1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .fx-shake {
            animation: camShake 120ms ease;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .casefile-modal {
            background-color: #f6f2e8;
            color: #2c2c2c;
            width: 80%;
            max-width: 720px;
            max-height: 85vh;
            border: 2px solid #bba;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .casefile-scroll {
            padding: 24px;
            overflow-y: auto;
            max-height: 80vh;
            font-family: "Noto Serif JP", "Times New Roman", serif;
            line-height: 1.6;
        }

        .casefile-modal h1,
        .casefile-modal h2 {
            text-align: center;
            margin-bottom: 8px;
        }

        .casefile-modal h3 {
            margin-top: 20px;
            border-bottom: 1px solid #999;
        }

        .person {
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-left: 3px solid #b44;
        }

        .initial-f {
            font-weight: 900;
            color: #c9a43d;
            /* gold */
            font-size: 1.55em;
            /* margin-left: 6px; */
        }

        .initial-l {
            font-weight: 900;
            color: #8c8fa1;
            /* silver/steel */
            font-size: 1.55em;
            /* margin-left: 4px; */
        }


        .evidence {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .evidence th,
        .evidence td {
            border: 1px solid #bbb;
            padding: 6px 8px;
        }

        /* ÈõªË©±Âõ≥ÈëëÁî®„ÅÆË°å„Éè„Ç§„É©„Ç§„Éà */
        .evidence tr.phone-discovered td {
            background: rgba(255, 248, 210, 0.9);
            /* „ÅÜ„Åô„ÅÑ„ÇØ„É™„Éº„É†Ëâ≤ */
            font-weight: 600;
        }

        .evidence tr.phone-undiscovered td {
            background: rgba(245, 245, 245, 0.7);
            /* „ÅÜ„Åô„Ç∞„É¨„Éº */
            color: #777;
        }

        blockquote {
            font-style: italic;
            color: #444;
            border-left: 4px solid #888;
            padding-left: 10px;
            margin: 10px 0;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.4rem;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }

        .group {
            width: 90%;
            justify-content: center;
            display: flex;
            gap: 8px;
            align-items: center
        }


        @keyframes breathe {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(2px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .modal-content {
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            /* ÁîªÈù¢„Å´Âèé„ÇÅ„Çã */
            overflow: auto;
            /* „ÅØ„ÅøÂá∫„Åó„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´ */
            padding: 20px;
            /* „Å°„Çá„ÅÑÂúßÁ∏Æ */
        }

        /* „É¢„Éº„ÉÄ„É´„ÅÆÁîªÂÉè„Éú„Çø„É≥„ÅØÂõ∫ÂÆö80px‚ÜíÂèØÂ§â„Å´ */
        #modalButtons button img {
            width: clamp(56px, 18vw, 96px);
            height: clamp(56px, 18vw, 96px);
        }

        /* „Ç¢„Éã„É°„É¢„Éº„ÉÄ„É´Áî® */
        .modal-anim {
            position: relative;
            width: min(400px, 80vw);
            margin: 0 auto 16px;
        }

        .modal-anim img {
            display: block;
            width: 100%;
        }

        /* 1ÊûöÁõÆ„ÅØ„Å†„Çì„Å†„ÇìÊ∂à„Åà„Çã */
        .modal-anim img:nth-child(1) {
            position: absolute;
            inset: 0;
            opacity: 1;
            animation: blockmanHatFadeOut 2.8s ease forwards 0.1s;
        }

        /* 2ÊûöÁõÆ„ÅØÂæå„Åã„Çâ„Åµ„Çè„Å£„Å®Âá∫„Å¶„Åè„Çã */
        .modal-anim img:nth-child(2) {
            opacity: 0;
            animation: blockmanHatFadeIn 3.0s ease forwards 0.4s;
        }

        /* 1ÊûöÁõÆ„ÅØ„Å†„Çì„Å†„ÇìÊ∂à„Åà„Çã */
        .fast img:nth-child(1) {
            animation: blockmanHatFadeOut 1.2s ease forwards 0.1s;
        }

        /* 2ÊûöÁõÆ„ÅØÂæå„Åã„Çâ„Åµ„Çè„Å£„Å®Âá∫„Å¶„Åè„Çã */
        .fast img:nth-child(2) {
            animation: blockmanHatFadeIn 1.4s ease forwards 0.4s;
        }

        @keyframes blockmanHatFadeOut {
            to {
                opacity: 0;
            }
        }

        @keyframes blockmanHatFadeIn {
            to {
                opacity: 1;
            }
        }

        /* ‚ñº „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´Áî® */

        .notebook-modal-content {
            background: #f4f7fb;
            color: #2c1810;
            border: 3px solid #d4af37;
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            overflow: auto;
            padding: 18px 18px 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            position: relative;
        }

        .notebook-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .notebook-title {
            font-weight: bold;
            font-size: 1.1rem;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .notebook-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid #c9a43d;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #eaf3ff, #d6e4ff);
        }

        .notebook-close-btn {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: #555;
        }

        .notebook-close-btn:hover {
            color: #000;
        }

        .notebook-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .notebook-tab {
            flex: 1;
            border: 1px solid #c9a43d;
            background: #fdfaf0;
            padding: 6px 4px;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 999px;
            color: #6b4b10;
            font-weight: bold;
        }

        .notebook-tab.active {
            background: linear-gradient(135deg, #ffe9a8, #ffd36b);
            box-shadow: 0 0 6px rgba(217, 165, 33, 0.6);
        }

        .notebook-body {
            background: #fffef8;
            border-radius: 8px;
            padding: 10px 12px 12px;
            border: 1px solid #e0d6b5;
        }

        .notebook-tab-content {
            display: none;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .notebook-tab-content.active {
            display: block;
        }

        .notebook-cap {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .notebook-note {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #6b6b6b;
        }

        .notebook-list {
            margin: 0 0 4px 1.1em;
            padding: 0;
        }

        .notebook-list li {
            margin-bottom: 3px;
        }

        .notebook-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            text-align: left;
        }

        .notebook-table th,
        .notebook-table td {
            border: 1px solid #d5c9a5;
            padding: 4px 6px;
        }

        .notebook-table th {
            background: #faf1d7;
        }

        /* ‚ñ≤ „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´Áî® */
        .distress-btn {
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #ff5555, #ff9900);
            color: #fff;
            box-shadow: 0 0 12px rgba(255, 64, 64, 0.7);
        }

        .distress-btn.distress-holding {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 0 18px rgba(255, 0, 0, 0.9);
        }

        .distress-hint {
            margin-top: 6px;
            font-size: 0.9em;
            color: #b00;
        }

        .notebook-image {
            max-width: 100%;
            display: block;
            margin: 8px auto;
            border-radius: 4px;
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F2G9BX4FBF"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-F2G9BX4FBF');
</script>

<body>
    <!-- ‚ñº „É¢„Éº„ÉÄ„É´ÂÖ®‰Ωì -->
    <!-- ‚ñº „É¢„Éº„ÉÄ„É´ÂÖ®‰Ωì -->
    <div class="modal-overlay" style="display:none;">
        <div class="casefile-modal">
            <button class="close-btn">√ó</button>
            <div class="casefile-scroll">


            </div>
        </div>
    </div>
    <!-- ‚ñº ÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="notebookModal" style="display:none;">
        <div class="modal-content notebook-modal-content">
            <div class="notebook-header">
                <div class="notebook-title">
                    <span class="notebook-logo">üèòÔ∏è</span>
                    ÊâãÂ∏≥
                </div>
                <button class="notebook-close-btn" onclick="closeNotebook()">‚úï</button>
            </div>

            <div class="notebook-tabs">
                <!-- <button class="notebook-tab active" data-tab="memo" onclick="switchNotebookTab('memo')">
                    MEMO
                </button> -->
                <button class="notebook-tab" data-tab="notes" onclick="switchNotebookTab('notes')">
                    NOTES
                </button>
            </div>

            <div class="notebook-body">
                <!-- MEMO„Çø„Éñ -->
                <div class="notebook-tab-content active" id="notebook-tab-memo">
                    <p class="notebook-cap">
                        ‰ΩïÊïÖ„ÅãÊåÅ„Å£„Å¶„ÅÑ„ÅüÊâãÂ∏≥„Å†„ÄÇ
                    </p>
                    <ul class="notebook-list">
                        <li></li>
                        <li></li>
                    </ul>
                    <p class="notebook-note">
                        Êõ∏„ÅçËæº„Åø„ÅØ„ÄÅÊÄ•„ÅÑ„ÅßËµ∞„ÇäÊõ∏„Åç„Åó„Åü„Çà„ÅÜ„Å™‰π±„Çå„ÅüÂ≠ó„Åß‰∏¶„Çì„Åß„ÅÑ„Çã„ÄÇ
                    </p>
                </div>

                <!-- NOTES„Çø„ÉñÔºöÂæå„Åã„ÇâÂ¢ó„Åà„Çã„É°„É¢Áî® -->
                <div class="notebook-tab-content" id="notebook-tab-notes">
                    <p class="notebook-cap">
                        Á©∫ÁôΩ„ÅÆ„Éö„Éº„Ç∏„ÄÇ
                    </p>
                    <div id="notebook-notes-body">
                        <!-- ÂæåÂçä„ÅÆ„Ç§„Éô„É≥„Éà„ÅßËøΩË®ò„Åó„Å¶„ÅÑ„ÅèÊÉ≥ÂÆö -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤ „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ -->


    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <!-- <div class="title">ËàπÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫</div> -->
            <div style="margin:0 0; text-align:center;">
                <a href="escape24_hint.html" target="_blank"
                    style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    üîç „Éí„É≥„Éà„ÇíË¶ã„Çã
                </a>

            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="640" style="width: 90vw; max-width: 640px;"></canvas>


        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="msgText">Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÁü•„Çâ„Å™„ÅÑÊùë„Å´Ëø∑„ÅÑËæº„Çì„Åß„ÅÑ„Åæ„Åó„Åü„ÄÇ</span>
                    <div id="statusIconArea" style="position:absolute; bottom:6px; right:12px; display:flex; gap:8px;">
                    </div>
                </div>
                <div class="navigation">

                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
                <div class="inventory-slot" onclick="useItem(5)"></div>
                <div class="inventory-slot" onclick="useItem(6)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
                üîä BGM
            </button>
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">„Çª„Éº„Éñ</button>
                <button class="nav-btn" onclick="loadGame()">„É≠„Éº„Éâ</button>
                <button class="nav-btn" onclick="openNotebook()">
                    <img src="images/24/notebook.png"
                        style="width:40px;max-width:100%;display:block;margin:0 auto 0px;">
                </button>
            </div>
        </div>
        <div class="notice">ÂΩì„Çµ„Ç§„Éà„ÅÆÈü≥Ê∫ê„ÅØ<a href="https://otologic.jp/" target="blank">OtoLogic</a>,<a
                href="https://dova-s.jp/" target="blank">DOVA-SYNDROME</a>„ÅÆÁ¥†Êùê„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô ‰ΩúËÄÖ:<a href="index.html">„Çπ„É©„Çª„Éñ„É≥</a>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>

    <audio id="bgm" src="sounds/23/Paper_craft.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-clear" src="sounds/common/Cyber03-1.mp3"></audio>
    <audio id="se-change" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-open" src="sounds/common/Short_Accent09-1(Dry).mp3"></audio>
    <audio id="se-fanta" src="sounds/common/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <audio id="se-coin" src="sounds/common/Onoma-Ding01-1(Dry).mp3"></audio>
    <audio id="se-scene-change" src="sounds/common/Scene_Change08-1(Delay-Fast).mp3"></audio>
    <audio id="se-tictac" src="sounds/common/tictac.mp3"></audio>
    <audio id="se-gacha" src="sounds/common/Retro_Anime-Switch02-3(Low).mp3"></audio>

    <audio id="se-bukimi_piano" src="sounds/common/bukimi_piano.mp3"></audio>
    <audio id="se-idea" src="sounds/common/Inspiration11-1(Low).mp3"></audio>
    <audio id="se-grab" src="sounds/common/Motion-Grab07-1(Dry).mp3"></audio>
    <audio id="se-switch" src="sounds/common/switch.mp3"></audio>
    <audio id="se-glich" src="sounds/common/glich.mp3"></audio>
    <audio id="se-bear-appear" src="sounds/common/Anime_Motion19-1(Phrase).mp3"></audio>
    <audio id="se-bear-eat" src="sounds/common/Motion-Eating02-1.mp3"></audio>
    <audio id="se-bear-flying" src="sounds/common/Motion-Blow_Away02-1(Long).mp3"></audio>


    <audio id="se-angel" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-up" src="sounds/common/Inspiration10-1(High).mp3"></audio>
    <audio id="se-ashioto" src="sounds/common/NES-RPG02-01(Enter).mp3"></audio>
    <audio id="se-hasami" src="sounds/common/hasami.mp3"></audio>
    <audio id="se-shutter" src="sounds/common/shutter.mp3"></audio>
    <audio id="se-fire" src="sounds/common/fire.mp3"></audio>
    <audio id="se-joyanokane" src="sounds/24/joyanokane.mp3"></audio>

    <audio id="se-song" src="sounds/24/song.wav"></audio>
    <audio id="se-song-forget" src="sounds/24/song_forget.wav"></audio>
    <audio id="se-cyber" src="sounds/common/Cyber20-1.mp3"></audio>
    <audio id="se-cloth" src="sounds/common/cloth.mp3"></audio>
    <audio id="se-paper" src="sounds/common/Flyer02-3(Rustle).mp3"></audio>
    <audio id="se-zukkoke" src="sounds/common/zukkoke.mp3"></audio>
    <audio id="se-tirori" src="sounds/common/tirori.mp3"></audio>
    <audio id="se-ebi" src="sounds/23/ebi.wav"></audio>
    <audio id="se-nami" src="sounds/common/nami.mp3"></audio>
    <audio id="se-announcement" src="sounds/common/pinponpan.mp3"></audio>
    <audio id="se-nabe" src="sounds/common/nabe.mp3"></audio>
    <audio id="se-gril" src="sounds/23/gril.mp3"></audio>
    <audio id="se-can" src="sounds/common/can.mp3"></audio>
    <audio id="se-kira" src="sounds/common/kira.mp3"></audio>



    <script>
        // --- Analytics helper ---
        window.ANA = {
            start: Date.now(),
            hintCount: 0,
            send(ev, params = {}) { try { gtag('event', ev, params); } catch (e) { } }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const a = document.querySelector('a[href*="_hint.html"]');
            if (a) {
                a.addEventListener('click', () => {
                    ANA.hintCount++;
                    ANA.send('open_hint', { count: ANA.hintCount });
                });
            }
        });

        window.ANA = Object.assign(window.ANA || {}, {
            sid: Math.random().toString(36).slice(2),
            sent: new Set(),
            baseParams() {
                return {
                    elapsed_sec: Math.round((Date.now() - this.start) / 1000),
                    hints: this.hintCount || 0,
                    save_version: (typeof SAVE_VERSION === 'number' ? SAVE_VERSION : null),
                    room: (window.gameState && gameState.currentRoom) || null,
                    sid: this.sid,
                };
            },
            once(ev, key = '', params = {}) {
                const k = `${ev}:${key}`;
                if (this.sent.has(k)) return;
                this.sent.add(k);
                this.send(ev, { ...this.baseParams(), ...params });
            }
        });

        // Ê±éÁî®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÄÅ‰ø°Áî®„Éò„É´„Éë
        function markProgress(step, extra = {}) {
            ANA.once('progress', step, { step, ...extra });
        }


        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.querySelector(".modal-overlay");
            const openBtn = document.querySelector("#open-casefile");
            const closeBtn = document.querySelector(".close-btn");

            // ÂàùÊúüÁä∂ÊÖã„ÅßÈùûË°®Á§∫
            modal.style.display = "none";

            // Èñã„Åè
            openBtn?.addEventListener("click", () => {
                modal.style.display = "flex";
            });

            // Èñâ„Åò„Çã
            closeBtn?.addEventListener("click", () => {
                modal.style.display = "none";
            });

            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modal.addEventListener("click", (e) => {
                if (e.target === modal) modal.style.display = "none";
            });
        });



        window._nextModal = null;
        const canvas = document.getElementById('gameCanvas');
        let DEV_MODE = false;
        // „Ç≤„Éº„É†Ë®≠ÂÆö - ÁîªÂÉè„Éë„Çπ„Çí„Åì„Åì„ÅßÁÆ°ÁêÜ
        let IMAGES = {
            rooms: {

                map: ['images/24/map.png'],
                square: ['images/24/square.png'],
                roomCat: ['images/24/room_cat.png', 'images/24/room_cat2.png'],
                mail: ['images/24/mail.png'],
                roomFrog: ['images/24/room_frog.png', 'images/24/room_frog2.png'],
                roomRabit: ['images/24/room_rabit.png', 'images/24/room_rabit2.png'],
                roomDog: ['images/24/room_dog.png', 'images/24/room_dog2.png'],
                roomHorse: ['images/24/room_horse.png', 'images/24/room_horse2.png'],
                drawerHorse: ['images/24/drawer_horse.png'],
                drawerDog: ['images/24/drawer_dog.png'],
                cabinetCat: ['images/24/cabinet_cat.png'],
                cabinetCatLeft: ['images/24/cabinet_cat_left.png'],
                score: ['images/24/score.png'],
                end: ['images/24/end.png'],
                trueEnd: ['images/24/true_end.png'],

            },
            items: {
                coin: 'images/bear_coin.png',
                bear: 'images/bear.png',

                back: 'images/common/back.png',
                arrowRight: 'images/common/arrow_right.png',
                arrowLeft: 'images/common/arrow_left.png',
                arrowAbove: 'images/common/arrow_above.png',
                redBack: 'images/common/red_back.png',
                greenBack: 'images/common/green_back.png',
                blueBack: 'images/common/blue_back.png',
                blackBack: 'images/common/black_back.png',
                shade: 'images/24/shade.png',
                blueCircle: 'images/24/blue_circle.png',
                nigaoe: 'images/24/nigaoe.png',
                nigaoeEn: 'images/24/nigaoe_en.png',
                picPast: 'images/24/pic_past.png',
                mailFrog: 'images/24/mail_frog.png',
                mailRabit: 'images/24/mail_rabit.png',
                mailDog: 'images/24/mail_dog.png',
                mapDog: 'images/24/map_dog.png',
                pruners: 'images/24/pruners.png',
                prunersPart: 'images/24/pruners_part.png',
                recipe: 'images/24/recipe.png',
                boxDrink: 'images/24/box_drink.png',
                seasoning: 'images/24/seasoning.png',
                bearCitrus: 'images/24/bear_citrus.png',
                bearCitrusEaten: 'images/24/bear_citrus_eaten.png',
                posterCitrus: 'images/24/poster_citrus.png',
                kumapon: 'images/24/kumapon.png',
                posterTree: 'images/24/poster_tree.png',
                posterTreeLine: 'images/24/poster_tree_line.png',
                locked: 'images/24/locked.png',
                unlocked: 'images/24/unlocked.png',
                brush: 'images/24/brush.png',
                vegetables: 'images/24/vegetables.png',
                bearWithPruners: 'images/24/bear_with_pruners.png',
                donuts: 'images/24/donuts.png',
                honey: 'images/24/honey.png',
                omamori: 'images/24/omamori.png',


            },

            modals: {
                posterKani: 'images/24/poster_kani.png',
                posterCat: 'images/24/poster_cat.png',
                posterCatEn: 'images/24/poster_cat_en.png',
                memo: 'images/24/modal_memo.png',
                memoEn: 'images/24/modal_memo_en.png',
                catWarried: 'images/24/modal_cat_warried.jpeg',
                catSolved1: 'images/24/modal_cat_solved1.png',
                catSolved2: 'images/24/modal_cat_solved2.png',
                catSatisfied: 'images/24/modal_cat_satisfied.png',
                frogWorried: 'images/24/modal_frog_worried.png',
                frogInspiration: 'images/24/modal_frog_inspiration.png',
                frogSinging: 'images/24/modal_frog_singing.png',
                rabitWorried: 'images/24/modal_rabit_worried.png',
                rabitInspiration: 'images/24/modal_rabit_inspiration.png',
                rabitKumapon: 'images/24/modal_rabit_kumapon.png',
                rabitReceiveCitrus: 'images/24/modal_rabit_receive_citrus.png',
                dogWorried: 'images/24/modal_dog_worried.png',
                dogInspiration: 'images/24/modal_dog_inspiration.png',
                horseWorried: 'images/24/modal_horse_worried.png',
                horseInspiration: 'images/24/modal_horse_inspiration.png',
                book1: 'images/24/book1.png',
                book2: 'images/24/book2.png',
                book3: 'images/24/book3.png',
                bookRiver: 'images/24/book_river.png',
                bookRiverEn: 'images/24/book_river_en.png',
                spImage: 'images/24/sp_image.png',
                spImageEn: 'images/24/sp_image_en.png',
                spImage2: 'images/24/sp_image2.png',
                cutCitrus: 'images/24/modal_cut_citrus.png',
                score2: 'images/24/modal_score2.png',
                posterApple: 'images/24/modal_poster_apple.png',
                bearPruners: 'images/24/modal_bear_pruners.png',
                letterH: 'images/24/modal_h.png',
                // letterON: 'images/24/modal_on.png',
                letterE: 'images/24/modal_e.png',
                letterYE: 'images/24/modal_ye.png',
                letterD: 'images/24/modal_d.png',
                nengajo: 'images/24/modal_nengajo.png',
                nengajoDog: 'images/24/modal_nengajo_dog.png',
                bookE: 'images/24/modal_book_e.png',
                cup: 'images/24/modal_cup.png',
                bearReceiveDonuts: 'images/24/modal_bear_receive_donuts.jpeg',
                bearEatDonuts: 'images/24/modal_bear_eat_donuts.png',
                bearHoney: 'images/24/modal_bear_honey.png',
                endCat: 'images/24/modal_end_cat.png',
                endHorse: 'images/24/modal_end_horse.png',
                endDog: 'images/24/modal_end_dog.png',
                endRabit: 'images/24/modal_end_rabit.png',
                endFrog: 'images/24/modal_end_frog.png',
                endBear: 'images/24/modal_end_bear.png',
                bearBad: 'images/24/modal_bear_bad.png',
                mailRabitEn: 'images/24/mail_rabit_en.png',
                mailDogEn: 'images/24/mail_dog_en.png',
                mailFrogEn: 'images/24/mail_frog_en.png',
                bearFrying: 'images/24/modal_bear_frying.png',
                posterHorse: 'images/24/poster_horse.png',
                kumaFairy: 'images/24/kuma_fairy.png',




                // badEnd: 'images/22/badend.jpeg',
            },
        };


        // „Ç≤„Éº„É†Áä∂ÊÖã
        const SAVE_KEY = 'escapeGameState24';
        const SAVE_VERSION = 1;
        const SAVE_KEYS = [
            SAVE_KEY + '_1',
            SAVE_KEY + '_2'
        ];

        // Êóß1„Çπ„É≠„ÉÉ„Éà„Çª„Éº„Éñ„Åå„ÅÇ„Çå„Å∞„ÄÅËá™Âãï„Åß„Çπ„É≠„ÉÉ„Éà1„Å´ÁßªË°å
        (function migrateOldSave() {
            try {
                const old = localStorage.getItem(SAVE_KEY);
                const slot1 = localStorage.getItem(SAVE_KEYS[0]);
                if (old && !slot1) {
                    localStorage.setItem(SAVE_KEYS[0], old);
                    // ÂøÖË¶Å„Å™„ÇâÂè§„ÅÑ„Ç≠„Éº„ÅØÊ∂à„Åó„Å¶„ÇÇOK
                    // localStorage.removeItem(SAVE_KEY);
                    console.log('Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„Çí„Çπ„É≠„ÉÉ„Éà1„Å´ÁßªË°å„Åó„Åæ„Åó„Åü');
                }
            } catch (e) {
                console.warn('„Çª„Éº„Éñ„Éá„Éº„ÇøÁßªË°å„Å´Â§±Êïó', e);
            }
        })();

        function getDefaultGameState() {
            return {
                currentRoom: 'map',
                openRooms: ['map'],
                openRoomsTmp: [],
                inventory: [],
                main: {
                    flags: {
                        visitSquare: false, visitCat: false, visitFrog: false, visitRabit: false, visitDog: false, visitHorse: false,
                        taltToCat: false, unlockPc: false,
                        readDogMail: false, readFrogMail: false, readRabitMail: false, currentMail: 0, // 0:Êú™ÈÅ∏Êäû,1:frog, 2:rabit, 3:dog
                        talkToDog: false, foundPruners: false, foundRecipe: false,
                        unlockSong: false,
                        unlockVegetables: false,
                        unlockRoute: false,

                        allSolvedToastShown: false,
                        metMayorAfterAllSolved: false,
                        mayorQuestGiven: false,
                        canVisitHorse: false,
                        unlockBox: false, foundBrush: false, passBrush: false, unlockDrawerHorse: false,
                        talkToHorse: false,
                        horseSolvedToastShown: false,
                        reportedHorseToMayor: false,
                        unlockCabinet: false, unlockCabinetExtra: false,
                        foundDonuts: false, passDonuts: false,
                        foundHoney: false, passHoney: false, gotOmamori: false, gotCitrus: false,
                        omikujiOpened: false,
                        omikujiResult: null,

                        talkTo: { bear: 0, }, backgroundState: 0,
                    }
                },
                roomCat: {
                    flags: { backgroundState: 0 }
                },
                roomFrog: {
                    flags: { backgroundState: 0 }
                },
                roomRabit: {
                    flags: { backgroundState: 0 }
                },
                roomDog: {
                    flags: { backgroundState: 0 }
                },
                roomHorse: { flags: { backgroundState: 0 } },
                end: {
                    flags: { backgroundState: 0 }
                },
                trueEnd: {
                    flags: { backgroundState: 0 }
                },


                flags: { trueEndUnlocked: false },
                selectedItem: null,
                endings: { true: false, normal2: false, normal: false }

            };
        }

        let gameState = getDefaultGameState();




        // ÈÉ®Â±ã„Éá„Éº„Çø
        let rooms = {
            map: {
                name: '„Å™„Åû„Å™„ÅûÊùë',
                description: '',
                clickableAreas: [
                    {
                        x: 35.7, y: 45.0, width: 31.3, height: 31.4,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.visitSquare) gameState.main.flags.visitSquare = true;
                            changeRoom('square');

                        }),
                        description: 'Â∫ÉÂ†¥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 39.0, y: 10.2, width: 22.8, height: 22.2,
                        onClick: clickWrap(function () {
                            changeRoom('roomCat');
                        }),
                        description: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆÂÆ∂',
                        zIndex: 5,
                        usable: () => gameState.main.flags.visitSquare,
                        item: { img: 'shade', visible: () => !gameState.main.flags.visitSquare }
                    },
                    {
                        x: 7.3, y: 20.8, width: 24.2, height: 24.2,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.canVisitHorse) {
                                updateMessage('„Åæ„Å†Ë°å„Åë„Å™„ÅÑ„Åø„Åü„ÅÑ„Å†');
                                return;
                            }
                            if (!gameState.main.flags.visitHorse) gameState.main.flags.visitHorse = true;
                            changeRoom('roomHorse');
                        }),
                        description: '„Ç¶„ÉûÈáë„Åï„Çì„ÅÆÂÆ∂',
                        zIndex: 5,
                        usable: () => gameState.main.flags.canVisitHorse,
                        item: { img: 'shade', visible: () => !gameState.main.flags.canVisitHorse }
                    },
                    {
                        x: 1.8, y: 60.4, width: 31.2, height: 30.2,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.visitDog) gameState.main.flags.visitDog = true;
                            changeRoom('roomDog');
                        }),
                        description: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂÆ∂',
                        zIndex: 5,
                        usable: () => gameState.main.flags.readDogMail,
                        item: { img: 'shade', visible: () => !gameState.main.flags.readDogMail }
                    },
                    {
                        x: 71.6, y: 55.1, width: 31.3, height: 31.5,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.visitRabit) gameState.main.flags.visitRabit = true;
                            changeRoom('roomRabit');
                        }),
                        description: '„É©„ÉìÈáé„Åï„Çì„ÅÆÂÆ∂',
                        zIndex: 5,
                        usable: () => gameState.main.flags.readRabitMail,
                        item: { img: 'shade', visible: () => !gameState.main.flags.readRabitMail }
                    },
                    {
                        x: 70.5, y: 21.6, width: 26.0, height: 26.6,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.visitFrog) gameState.main.flags.visitFrog = true;
                            changeRoom('roomFrog');

                        }),
                        description: '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆÂÆ∂',
                        zIndex: 5,
                        usable: () => gameState.main.flags.readFrogMail,
                        item: { img: 'shade', visible: () => !gameState.main.flags.readFrogMail }
                    },

                ]
            },
            square: {
                name: 'Â∫ÉÂ†¥',
                description: '',
                clickableAreas: [
                    {
                        x: 12.9, y: 15.2, width: 8.1, height: 11.0,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.posterKani, 'ÂÆ¥‰ºö„ÅÆÂëäÁü•„ÅÆ„Çà„ÅÜ„Å†');

                        }),
                        description: '„Ç´„Éã„Éù„Çπ„Çø„Éº',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0.6, y: 16.1, width: 9.2, height: 8.3,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.posterCat, '‰Ωï„ÅãÂõ∞„Çä„Åî„Å®„Åå„ÅÇ„Çã„Çà„ÅÜ„Å†', IMAGES.modals.posterCatEn);
                        }),
                        description: 'ÊùëÈï∑„ÅäÁü•„Çâ„Åõ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 71.4, y: 58.8, width: 28.5, height: 23.3,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.foundSeasoning) {
                                updateMessage('È£≤„ÅøÁâ©„ÇÑË™øÂë≥Êñô„ÅåÂ±ä„ÅÑ„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†');
                            } else {
                                showModal(
                                    '„ÅäÈÜ§Ê≤π„Å®„ÅäÈÖ¢„Åå„ÅÇ„Çã‚Ä¶',
                                    '<p>Ë™øÂë≥Êñô„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åç„Åæ„Åô„ÅãÔºü</p>',
                                    [
                                        {
                                            text: '„ÅØ„ÅÑ',
                                            action: () => {

                                                gameState.main.flags.foundSeasoning = true;
                                                addItem('seasoning');
                                                updateMessage('Ë™øÂë≥Êñô„Çª„ÉÉ„Éà„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                                                closeModal();
                                            }
                                        },
                                        {
                                            text: '„ÅÑ„ÅÑ„Åà',
                                            action: 'close'
                                        }
                                    ]
                                );
                            }

                        }),
                        description: '„ÉÄ„É≥„Éú„Éº„É´',
                        zIndex: 5,
                        usable: () => gameState.main.flags.unlockRoute,
                        item: { img: 'boxDrink', visible: () => gameState.main.flags.unlockRoute }
                    },
                    {
                        x: 92.9, y: 8.1, width: 3.5, height: 3.3,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.foundCitrus) {

                            } else if (gameState.selectedItem == 'pruners') {
                                acquireItemOnce('foundCitrus', 'bearCitrus', '„Éü„Ç´„É≥„ÅÆ„Çà„ÅÜ„Å™ÂÆü„Çí„Ç´„ÉÉ„Éà„Åó„Åü', IMAGES.modals.cutCitrus, '„ÇØ„Éû„ÅÆÂÆü„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                            } else {
                                updateMessage('„Éü„Ç´„É≥„ÅÆ„Çà„ÅÜ„Å™ÂÆü„Åå„Å™„Å£„Å¶„ÅÑ„Çã„ÄÇ„Åì„ÅÆ‰ΩçÁΩÆ„Å™„Çâ„ÄÅÈÅìÂÖ∑„Åå„ÅÇ„Çå„Å∞„Å®„Çå„Çã„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ');
                            }

                        }),
                        description: '„ÇØ„Éû„ÅÆÂÆüÂè≥',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.bearAppear,
                        item: { img: 'bearCitrus', visible: () => !gameState.main.flags.bearAppear }
                    },
                    {
                        x: 92.9, y: 8.1, width: 3.5, height: 3.3,
                        onClick: clickWrap(function () {

                            updateMessage('„Éü„Ç´„É≥„ÅÆ„Çà„ÅÜ„Å™ÂÆü„ÅØ„Åã„Åò„Çâ„Çå„Å¶„Åó„Åæ„Å£„Å¶„ÅÑ„Çã‚Ä¶');


                        }),
                        description: '„ÇØ„Éû„ÅÆÂÆüÂè≥',
                        zIndex: 5,
                        usable: () => gameState.main.flags.bearAppear,
                        item: { img: 'bearCitrusEaten', visible: () => gameState.main.flags.bearAppear }
                    },
                    {
                        x: 70.3, y: 2.6, width: 3.7, height: 3.5,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'pruners') {
                                updateMessage('Êâã„ÅåÂ±ä„Åã„Å™„ÅÑ‚Ä¶');
                            } else {
                                updateMessage('„Éü„Ç´„É≥„ÅÆ„Çà„ÅÜ„Å™ÂÆü„Åå„Å™„Å£„Å¶„ÅÑ„Çã„ÄÇÊâã„ÅåÂ±ä„Åã„Å™„Åù„ÅÜ„Å†');
                            }

                        }),
                        description: '„ÇØ„Éû„ÅÆÂÆü‰∏≠Â§Æ',
                        zIndex: 5,
                        usable: () => !(gameState.main.flags.passDonuts || gameState.main.flags.passHoney),
                        item: { img: 'bearCitrus', visible: () => !(gameState.main.flags.passDonuts || gameState.main.flags.passHoney), }
                    },
                    {
                        x: 42.0, y: 0.5, width: 3.9, height: 3.8,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'pruners') {
                                updateMessage('Êâã„ÅåÂ±ä„Åã„Å™„ÅÑ‚Ä¶');
                            } else {
                                updateMessage('„Éü„Ç´„É≥„ÅÆ„Çà„ÅÜ„Å™ÂÆü„Åå„Å™„Å£„Å¶„ÅÑ„Çã„ÄÇ„Çà„ÅèË¶ã„Çã„Å®„ÇØ„Éû„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢„Çí„Åó„Å¶„ÅÑ„Çã');
                            }

                        }),
                        description: '„ÇØ„Éû„ÅÆÂÆüÂ∑¶',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'bearCitrus', visible: () => true }
                    },
                    {
                        x: 74.0, y: 0.3, width: 13.8, height: 12.7,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'pruners') {
                                showObj('passPruners', 'ÂÆü„ÇíÂèñ„Å£„Å¶„Åª„Åó„ÅÑ„ÅÆÔºü„ÅÜ„Éº„Çì‚Ä¶<br>„Åª„Åã„Å´ÁæéÂë≥„Åó„ÅÑ„ÇÇ„ÅÆ„Çí„Åè„Çå„Çã„Å™„ÇâËâØ„ÅÑ„Çà', IMAGES.modals.bearPruners, '„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÁæéÂë≥„Å™„ÇÇ„ÅÆ„ÇíË¶ÅÊ±Ç„Åó„Å¶„ÅÑ„Çã');
                                removeItem('pruners');
                            } else {
                                talkToHintCharacter('main', 'bear');
                            }

                        }),
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 5,
                        usable: () => gameState.main.flags.bearAppear && !gameState.main.flags.passPruners,
                        item: { img: 'bear', visible: () => gameState.main.flags.bearAppear && !gameState.main.flags.passPruners }
                    },
                    {
                        x: 74.0, y: 0.2, width: 16.6, height: 12.4,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem === 'donuts') {
                                removeItem('donuts');
                                gameState.main.flags.passDonuts = true;
                                renderCanvasRoom();

                                window._nextModal = {
                                    title: 'Á¥ÑÊùüÈÄö„Çä„ÄÅÂÆü„ÇíÂèñ„Å£„Å¶„ÅÇ„Åí„ÇãÔºÅ',
                                    content: `
                                        <img src="${IMAGES.modals.cutCitrus}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">,

                                        <p style="margin-top:8px;">
                                            „ÇØ„Éû„ÅÆÂÆü„ÇíÂèñ„Å£„Å¶„ÇÇ„Çâ„Å£„Åü„ÄÇ„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÂéª„Å£„Å¶Ë°å„Å£„Åü„ÄÇ
                                        </p>
                                        `,
                                    buttons: [
                                        { text: 'Èñâ„Åò„Çã', action: 'close' }
                                    ],

                                    after() {
                                        playSE('se-clear');
                                        markProgress('citrus_get_24');
                                        addItem('bearCitrus');
                                        gameState.main.flags.gotCitrus = true;
                                        updateMessage('„Éâ„Éº„Éä„ÉÑ„Å®Âºï„ÅçÊèõ„Åà„Å´„ÇØ„Éû„ÅÆÂÆü„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                                    }
                                };
                                showModal(
                                    '„Åä„Å£ÔºÅÁæéÂë≥„Åó„Åù„ÅÜÔºÅ‚Ä¶„Å±„Åè„Å±„Åè‚Ä¶',
                                    `
                    <div class="modal-anim">
                    <img src="${IMAGES.modals.bearReceiveDonuts}">
                    <img src="${IMAGES.modals.bearEatDonuts}">
                    </div>
                                
                    <p>„Äå„ÅÜ„Çì„ÄÇÊ∫ÄË∂≥„Å†„Çà„Äç</p>
                    `,
                                    [
                                        {
                                            text: 'OK',
                                            action: 'close',

                                        }
                                    ],
                                );
                                return;
                            }
                            if (gameState.selectedItem === 'honey') {
                                removeItem('honey');
                                gameState.main.flags.passHoney = true;
                                renderCanvasRoom();

                                window._nextModal = {
                                    title: 'Á¥ÑÊùüÈÄö„Çä„ÄÅÂÆü„ÇíÂèñ„Å£„Å¶„ÅÇ„Åí„ÇãÔºÅ„Å§„ÅÑ„Åß„Å´„ÅäÂÆà„Çä„ÇÇ„ÅÇ„Åí„ÇãÔºÅ',
                                    content: `
                                    <div class="modal-anim">
                                        <img src="${IMAGES.modals.cutCitrus}">
                                        <img src="${IMAGES.modals.bearFrying}">
                                    </div>
                                        
                                        <p style="margin-top:8px;">
                                            „ÇØ„Éû„ÅÆÂÆü„ÇíÂèñ„Å£„Å¶„ÇÇ„Çâ„Å£„Åü„ÄÇ„Å§„ÅÑ„Åß„Å´„ÅäÂÆà„Çä„ÇÇÈôç„Å£„Å¶„Åç„Åü„ÄÇ<br>„Åù„Åó„Å¶„ÄÅ„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÂéª„Å£„Å¶Ë°å„Å£„Åü„ÄÇ
                                        </p>
                                        `,
                                    buttons: [
                                        { text: 'Èñâ„Åò„Çã', action: 'close' }
                                    ],

                                    after() {
                                        playSE('se-clear');
                                        markProgress('citrus_get_24');
                                        markProgress('omamori_get_24');
                                        updateMessage('‰ºùË™¨„ÅÆ‰∏ÉËâ≤„Éè„ÉÅ„Éü„ÉÑ„Å®Âºï„ÅçÊèõ„Åà„Å´„ÇØ„Éû„ÅÆÂÆü„Å®„ÅäÂÆà„Çä„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                                        addItem('bearCitrus');
                                        addItem('omamori');
                                        gameState.main.flags.gotOmamori = true;
                                        gameState.main.flags.gotCitrus = true;
                                    }
                                };
                                showModal(
                                    '„Åä„Å£ÔºÅ„Åì„ÄÅ„Åì„Çå„ÅØ‚Ä¶',
                                    `<img src="${IMAGES.modals.bearHoney}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">       
                                    <p>„ÄåÂàù„ÇÅ„Å¶Ë¶ã„Åü„ÇàÔºÅ„Äç</p>
                                    `,
                                    [
                                        {
                                            text: 'OK',
                                            action: 'close',

                                        }
                                    ],
                                );

                                return;
                            }
                            updateMessage('ÁæéÂë≥„Åó„ÅÑ„ÇÇ„ÅÆ„Åè„Çå„Åü„Çâ„ÄÅÂÆü„ÇíÂèñ„Å£„Å¶„ÅÇ„Åí„Çã');
                        }),
                        description: '„ÅØ„Åï„Åø„ÇíÊåÅ„Å£„Åü„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 5,
                        usable: () => gameState.main.flags.passPruners && !(gameState.main.flags.passDonuts || gameState.main.flags.passHoney),
                        item: { img: 'bearWithPruners', visible: () => gameState.main.flags.passPruners && !(gameState.main.flags.passDonuts || gameState.main.flags.passHoney) }
                    },
                    {
                        x: 33.9, y: 40.0, width: 17.9, height: 10.4,
                        onClick: clickWrap(function () {
                            updateMessage('ÂÆ¥‰ºöÁî®„ÅÆÈáéËèú„Å†');
                        }),
                        description: 'ÈáéËèú',
                        zIndex: 5,
                        usable: () => gameState.main.flags.unlockVegetables,
                        item: { img: 'vegetables', visible: () => gameState.main.flags.unlockVegetables }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('map');
                        }, { allowAtNight: true }),
                        description: 'Â∫ÉÂ†¥Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            roomCat: {
                name: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆÂÆ∂',
                description: '',
                clickableAreas: [
                    {
                        x: 42.7, y: 43.5, width: 17.3, height: 17.6,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) gameState.main.flags.talkToCat = true;
                            const f = gameState.main.flags;
                            const allSolved = !!(f.unlockSong && f.unlockVegetables && f.unlockRoute);
                            if (allSolved && !f.metMayorAfterAllSolved) {
                                f.metMayorAfterAllSolved = true;
                                if (typeof renderNotebookTasks === 'function') renderNotebookTasks();
                            }
                            if (f.passBrush && !f.reportedHorseToMayor) {
                                f.reportedHorseToMayor = true;
                                if (typeof renderNotebookTasks === 'function') renderNotebookTasks();
                            }

                            // „Éñ„É©„Ç∑„ÇíÊ∏°„Åó„Åü„ÅÇ„Å®„ÄÅÊùëÈï∑„Å´Â†±Âëä„Åó„Åü„Çâ„Ç®„É≥„Éâ„Å∏
                            if (f.passBrush) {
                                // ÈÄ≤Êçó„Çø„Çπ„ÇØ„ÅÆÂÆå‰∫Ü„Éï„É©„Ç∞
                                if (allSolved && !f.metMayorAfterAllSolved) {
                                    f.metMayorAfterAllSolved = true;
                                }
                                if (!f.reportedHorseToMayor) {
                                    f.reportedHorseToMayor = true;
                                }
                                if (typeof renderNotebookTasks === 'function') renderNotebookTasks();

                                showModal(
                                    `<img src="${IMAGES.modals.catSatisfied}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    '„ÅîËã¶Âä¥Êßò„Åò„ÇÉ„ÄÇÂÆ¥„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åü„Çà„ÅÜ„Åò„ÇÉ„Å™Ôºü',
                                    [
                                        {
                                            text: '„ÅØ„ÅÑ',
                                            action: () => {
                                                closeModal();
                                                if (gameState.flags.trueEndUnlocked) {
                                                    travelWithSteps('trueEnd');
                                                } else {
                                                    travelWithSteps('end');
                                                }
                                            }
                                        },
                                        {
                                            text: '„ÅÑ„ÅÑ„Åà',
                                            action: 'close'
                                        }
                                    ]
                                );

                                updateMessage('„ÅîËã¶Âä¥Êßò„Åò„ÇÉ„ÄÇÂÆ¥„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åü„Çà„ÅÜ„Åò„ÇÉ„Å™');
                                return;
                            }


                            if (allSolved && !f.mayorQuestGiven) {
                                f.mayorQuestGiven = true;
                                f.canVisitHorse = true;
                                if (typeof renderNotebookTasks === 'function') renderNotebookTasks();
                                showObj(null,
                                    '„Åä„Åä„ÄÅ„Åø„Çì„Å™„ÅÆÂõ∞„Çä„Åî„Å®„ÇíËß£Ê±∫„Åó„Å¶„Åè„Çå„Åü„ÅÆ„Åò„ÇÉ„Å™ÔºÅ<br>„Åù„Çå„ÅØ„Åù„ÅÜ„Å®‰∏ªÂΩπ„ÅÆ„Ç¶„ÉûÈáëÔºà„Åã„Å≠ÔºâÂêõ„ÅØÂ§ß‰∏àÂ§´„Åò„ÇÉ„Çç„ÅÜ„ÅãÔºü<br>„Å°„Çá„Å£„Å®Ë¶ã„Å¶„Åç„Å¶„Åè„Çå„Çì„Åã„Å≠',
                                    IMAGES.modals.catSolved1,
                                    '„Ç¶„ÉûÈáë„Åï„Çì„ÅÆÊßòÂ≠ê„ÇíË¶ã„Å´Ë°å„Åì„ÅÜ'
                                );
                                return;
                            }
                            if (f.mayorQuestGiven) {
                                updateMessage('„Ç¶„ÉûÈáëÔºà„Åã„Å≠ÔºâÂêõ„ÅÆÊßòÂ≠ê„ÇíË¶ã„Å¶„Åç„Å¶„Åª„Åó„ÅÑ„Çì„Åò„ÇÉ');
                                return;
                            }

                            if (gameState.main.flags.unlockPc) {
                                updateMessage('Êùë‰∫∫„ÅåÂõ∞„Å£„Å¶„Åä„Çã‚Ä¶„Çè„Åó„ÇÇÂøô„Åó„Åè„Å¶„ÅÆ„Åä‚Ä¶');


                            } else {
                                showObj(null, '„Å≠„ÅìÂ±±ÊùëÈï∑„ÄåÂõ∞„Å£„Åü‚Ä¶„Ç´„Éã„ÇíÊ≥®Êñá„Åõ„Å≠„Å∞„ÅÑ„Åã„Çì„Å®„ÅÑ„ÅÜ„ÅÆ„Å´‚Ä¶<br>„Éë„ÇΩ„Ç≥„É≥„Å´„É≠„Ç∞„Ç§„É≥„Åß„Åç„Çì„ÅÆ„Å†„Äç', IMAGES.modals.catWarried, '„Å≠„ÅìÂ±±ÊùëÈï∑„ÄåÂõ∞„Å£„Åü‚Ä¶„Ç´„Éã„ÇíÊ≥®Êñá„Åõ„Å≠„Å∞„ÅÑ„Åã„Çì„Å®„ÅÑ„ÅÜ„ÅÆ„Å´‚Ä¶„Éë„ÇΩ„Ç≥„É≥„Å´„É≠„Ç∞„Ç§„É≥„Åß„Åç„Çì„ÅÆ„Å†„Äç')
                            }
                        }),
                        description: '„Å≠„ÅìÂ±±ÊùëÈï∑',
                        zIndex: 2,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 64.1, y: 58.1, width: 5.5, height: 5.6,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('ÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            updateMessage('ÊùëÈï∑„ÅÆ„Éû„Ç∞„Ç´„ÉÉ„Éó„Å†');
                        }),
                        description: '„Éû„Ç∞„Ç´„ÉÉ„Éó',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 64.9, y: 29.6, width: 8.5, height: 10.0,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('ÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            showObj(null, 'Â≠´„ÅåÊèè„ÅÑ„Å¶„Åè„Çå„Åü„Çì„Åò„ÇÉ„ÄÇ‰∏äÊâã„ÅÑ„Åò„ÇÉ„Çç„ÅÜÔºü', IMAGES.items.nigaoe, 'ÊùëÈï∑„ÅÆÂ≠´„ÅåÊèè„ÅÑ„Åü„Çâ„Åó„ÅÑ', IMAGES.items.nigaoeEn);

                        }),
                        description: '‰ººÈ°îÁµµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'nigaoe', visible: () => true }
                    },
                    {
                        x: 29.2, y: 29.9, width: 6.2, height: 8.7,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('ÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            showObj(null, 'ÁâπÁî£ÂìÅ„ÅÆ„Éù„Çπ„Çø„Éº„ÅÆ„Çà„ÅÜ„Å†', IMAGES.items.posterCitrus, 'ÁâπÁî£ÂìÅ„ÅÆ„Éù„Çπ„Çø„Éº„ÅÆ„Çà„ÅÜ„Å†„ÄÇ„ÇØ„Éû„ÅÆÂÆü„Å®„ÅÑ„ÅÜÊüëÊ©òÈ°û„Å†');
                        }),
                        description: '„ÇØ„Éû„ÅÆÂÆü„Éù„Çπ„Çø„Éº',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'posterCitrus', visible: () => true }
                    },
                    {
                        x: 28.0, y: 42.6, width: 8.1, height: 9.8,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('ÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            showObj(null, '‰ΩïÂπ¥„ÅãÂâç„ÅÆÂÆ¥‰ºö„ÅÆÂÜôÁúü„Åò„ÇÉ„Çà', IMAGES.items.picPast, '‰ΩïÂπ¥„ÅãÂâç„ÅÆÂÆ¥‰ºö„ÅÆÂÜôÁúü„Çâ„Åó„ÅÑ');
                        }),
                        description: 'ÈÅéÂéª„ÅÆÂÜôÁúü',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'picPast', visible: () => true }
                    },
                    {
                        x: 62.9, y: 41.2, width: 11.5, height: 14.2,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('ÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            showObj(null, '', IMAGES.items.posterTreeLine, 'ÊÑèÂë≥„ÅÇ„Çä„Åí„Å™Êú®„ÅÆÁ∑öÁîª„Å†„ÄÇ');
                        }),
                        description: 'Êú®„ÅÆÁµµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'posterTreeLine', visible: () => true }
                    },
                    {
                        x: 91.0, y: 33.1, width: 7.0, height: 10.2,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('ÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            updateMessage('„ÇØ„ÉûÂá∫Ê≤°Ê≥®ÊÑèÔºÅ„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: 'Âè≥Â£Å„ÅØ„Çä„Åå„Åø',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 85.2, y: 34.0, width: 3.4, height: 4.2,
                        onClick: clickWrap(function () {
                            updateMessage('„Äå„ÅäÂèñ„ÇäÂØÑ„Åõ„É°„É¢Ôºö„Éä„Çæ„Çπ„Çø„ÅßË¶ã„Åü„Çπ„Ç§„Éº„ÉÑ„Äç„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: 'Âè≥Â£ÅÂ∞è„Åï„ÅÑË≤º„ÇäÁ¥ô‰∏ä',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 86.3, y: 39.5, width: 4.7, height: 5.2,
                        onClick: clickWrap(function () {
                            updateMessage('„Äå„ÅäÂèñ„ÇäÂØÑ„Åõ„É°„É¢Ôºö„ÉÜ„É¨„Éì„ÅßË¶ã„Åü„Åô„Åî„Åù„ÅÜ„Å™„ÇÑ„Å§„Äç„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: 'Âè≥Â£ÅÂ∞è„Åï„ÅÑË≤º„ÇäÁ¥ôÂè≥‰∏ã',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 52.1, y: 62.5, width: 11.2, height: 3.4,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('„Åæ„ÅöÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            showObj(null, '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ„Åì„Çå„ÅÆ„ÅØ„Åö„Å™„Çì„Åò„ÇÉ„Åå‚Ä¶', IMAGES.modals.memo, '„Åì„Çå„ÅåPC„É≠„Ç∞„Ç§„É≥„Éë„Çπ„ÉØ„Éº„Éâ„Å†„Çç„ÅÜ„ÅãÔºü', IMAGES.modals.memoEn);
                        }),
                        description: 'Êú∫‰∏ä„ÅÆ„Éé„Éº„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 9.0, y: 35.4, width: 14.0, height: 10.4,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.book3, 'ÂΩπ„Å´Á´ã„Å°„Åù„ÅÜ„Å™Êú¨„Å†');
                        }),
                        description: 'Â∑¶Êú¨Ê£ö‰∏äÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 33.6, y: 56.0, width: 14.5, height: 11.7,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('„Åæ„ÅöÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            if (gameState.main.flags.unlockPc) {
                                // ÊùëÈï∑„Åã„ÇâÔºì‰ª∂„É°„Éº„É´„ÅåÊù•„Å¶„Çã„É¢„Éº„ÉÄ„É´
                                changeRoom('mail');

                            } else {
                                showPCPuzzle();
                            }

                        }),
                        description: 'PC',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 76.2, y: 56.0, width: 12.7, height: 21.5,
                        onClick: clickWrap(function () {
                            gameState.main = gameState.main || { flags: {} };
                            gameState.main.flags = gameState.main.flags || {};
                            const f = gameState.main.flags;

                            // „Åæ„ÅöÊùëÈï∑Ôºà„Å≠„ÅìÂ±±ÊùëÈï∑Ôºâ„Å´Ë©±„Åó„Åã„Åë„Å¶„Åã„Çâ
                            if (!f.talkToCat) {
                                updateMessage('„Åæ„ÅöÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            // Ëß£Èô§Ê∏à„Åø„Å™„Çâ‰∏≠„ÇíÁ¢∫Ë™ç
                            if (f.unlockCabinet || f.unlockCabibinet) {
                                changeRoom('cabinetCat');
                                return;
                            }
                            if (gameState.main.flags.horseSolvedToastShown) {
                                showCatCabinetPuzzle();
                                return;
                            } else {
                                updateMessage('„Åæ„Å†Èñã„Åã„Å™„Åù„ÅÜ„Å†');
                            }

                        }),
                        description: 'Âè≥„Ç≠„É£„Éì„Éç„ÉÉ„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 7.8, y: 57.5, width: 14.9, height: 17.8,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToCat) {
                                updateMessage('„Åæ„ÅöÊùëÈï∑„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            changeRoom('cabinetCatLeft');
                        }),
                        description: 'Â∑¶„Ç≠„É£„Éì„Éç„ÉÉ„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 11.3, y: 24.8, width: 7.8, height: 10.4,
                        onClick: clickWrap(function () {
                            updateMessage('Ë¶≥ËëâÊ§çÁâ©„Å†');
                        }),
                        description: 'Â∑¶Ê£ö‰∏äË¶≥ËëâÊ§çÁâ©',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('map');
                        }, { allowAtNight: true }),
                        description: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆÂÆ∂Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            mail: {
                name: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆ„Éë„ÇΩ„Ç≥„É≥ÁîªÈù¢',
                description: '',
                clickableAreas: [
                    {
                        x: 36.6, y: 20.4, width: 2.8, height: 2.8,
                        onClick: clickWrap(function () {

                        }),
                        description: '„Ç´„Ç®„É´Áî∞Êú™Ë™≠„Ç¢„Ç§„Ç≥„É≥',
                        zIndex: 1,
                        usable: () => false,
                        item: { img: 'blueCircle', visible: () => !gameState.main.flags.readFrogMail }
                    },
                    {
                        x: 4.9, y: 15.7, width: 34.5, height: 8.2,
                        onClick: clickWrap(function () {
                            gameState.main.flags.readFrogMail = true;
                            gameState.main.flags.currentMail = 1;
                            renderCanvasRoom();
                            renderNotebookTasks();
                        }),
                        description: '„Ç´„Ç®„É´Áî∞„É°„Éº„É´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 36.6, y: 31.8, width: 2.8, height: 2.8,
                        onClick: clickWrap(function () {

                        }),
                        description: '„É©„ÉìÈáéÊú™Ë™≠„Ç¢„Ç§„Ç≥„É≥',
                        zIndex: 1,
                        usable: () => false,
                        item: { img: 'blueCircle', visible: () => !gameState.main.flags.readRabitMail }
                    },
                    {
                        x: 4.8, y: 27.0, width: 34.5, height: 7.9,
                        onClick: clickWrap(function () {
                            gameState.main.flags.readRabitMail = true;
                            gameState.main.flags.currentMail = 2;
                            renderCanvasRoom();
                            renderNotebookTasks();
                        }),
                        description: '„É©„ÉìÈáé„É°„Éº„É´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 36.6, y: 43.2, width: 2.8, height: 2.8,
                        onClick: clickWrap(function () {

                        }),
                        description: '„ÉØ„É≥Ëä±Êú™Ë™≠„Ç¢„Ç§„Ç≥„É≥',
                        zIndex: 1,
                        usable: () => true,
                        item: { img: 'blueCircle', visible: () => !gameState.main.flags.readDogMail }
                    },
                    {
                        x: 5.0, y: 38.2, width: 34.3, height: 7.8,
                        onClick: clickWrap(function () {
                            gameState.main.flags.readDogMail = true;
                            gameState.main.flags.currentMail = 3;
                            renderCanvasRoom();
                            renderNotebookTasks();
                        }),
                        description: '„ÉØ„É≥Ëä±„É°„Éº„É´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 48.6, y: 11.4, width: 48.8, height: 70.8,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.mailFrog, '„Ç´„Ç®„É´Áî∞„Åï„Çì„Åã„Çâ„ÅÆ„É°„Éº„É´„Å†', IMAGES.modals.mailFrogEn);

                        }),
                        description: '„É°„Éº„É´Êú¨Êñá„Ç®„É™„Ç¢„Ç´„Ç®„É´Áî∞',
                        zIndex: 5,
                        usable: () => gameState.main.flags.currentMail == 1,
                        item: {
                            img: 'mailFrog',
                            visible: () => gameState.main.flags.currentMail == 1
                        }
                    },
                    {
                        x: 48.6, y: 11.4, width: 48.8, height: 70.8,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.mailRabit, '„Ç´„Ç®„É´Áî∞„Åï„Çì„Åã„Çâ„ÅÆ„É°„Éº„É´„Å†', IMAGES.modals.mailRabitEn);
                        }),
                        description: '„É°„Éº„É´Êú¨Êñá„Ç®„É™„Ç¢„É©„ÉìÈáé„Åï„Çì',
                        zIndex: 5,
                        usable: () => gameState.main.flags.currentMail == 2,
                        item: {
                            img: 'mailRabit',
                            visible: () => gameState.main.flags.currentMail == 2
                        }
                    },
                    {
                        x: 48.6, y: 11.4, width: 48.8, height: 70.8,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.mailDog, '„Ç´„Ç®„É´Áî∞„Åï„Çì„Åã„Çâ„ÅÆ„É°„Éº„É´„Å†', IMAGES.modals.mailDogEn);
                        }),
                        description: '„É°„Éº„É´Êú¨Êñá„Ç®„É™„Ç¢„ÉØ„É≥Ëä±',
                        zIndex: 5,
                        usable: () => gameState.main.flags.currentMail == 3,
                        item: {
                            img: 'mailDog',
                            visible: () => gameState.main.flags.currentMail == 3
                        }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('roomCat');
                        }, { allowAtNight: true }),
                        description: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆ„Éë„ÇΩ„Ç≥„É≥ÁîªÈù¢„ÇÇ„Å©„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            cabinetCat: {
                name: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆ„Ç≠„É£„Éì„Éç„ÉÉ„Éà',
                description: '',
                clickableAreas: [
                    {
                        x: 46.9, y: 47.9, width: 24.1, height: 31.1,
                        onClick: clickWrap(function () {
                            updateMessage('ÂèØÊÑõ„ÅÑÊãõ„ÅçÁå´„Å†');
                        }),
                        description: 'Êãõ„ÅçÁå´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 19.5, y: 56.6, width: 22.4, height: 26.9,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundDonuts', 'donuts', '„Éè„Éã„Éº„Éâ„Éº„Éä„ÉÑ„Åå„ÅÇ„Å£„Åü', IMAGES.items.donuts, '„Éè„Éã„Éº„Éâ„Éº„Éä„ÉÑ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        }),
                        description: '„Éâ„Éº„Éä„ÉÑ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.unlockCabinetExtra && !gameState.main.flags.foundDonuts,
                        item: { img: 'donuts', visible: () => !gameState.main.flags.unlockCabinetExtra && !gameState.main.flags.foundDonuts, }
                    },
                    {
                        x: 19.5, y: 56.6, width: 22.4, height: 26.9,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundHoney', 'honey', '„Åô„Åî„Åù„ÅÜ„Å™„Éè„ÉÅ„Éü„ÉÑ„Åå„ÅÇ„Å£„Åü', IMAGES.items.honey, '‰ºùË™¨„ÅÆ‰∏ÉËâ≤„Éè„ÉÅ„Éü„ÉÑ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        }),
                        description: '‰ºùË™¨„ÅÆ‰∏ÉËâ≤„Éè„ÉÅ„Éü„ÉÑ',
                        zIndex: 5,
                        usable: () => gameState.main.flags.unlockCabinetExtra && !gameState.main.flags.foundHoney,
                        item: { img: 'honey', visible: () => gameState.main.flags.unlockCabinetExtra && !gameState.main.flags.foundHoney, }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('roomCat');
                        }, { allowAtNight: true }),
                        description: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆ„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            cabinetCatLeft: {
                name: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆ„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÂ∑¶',
                description: '',
                clickableAreas: [
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('roomCat');
                        }, { allowAtNight: true }),
                        description: '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆ„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            roomFrog: {
                name: '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆÂÆ∂',
                description: '',
                clickableAreas: [
                    {
                        x: 41.8, y: 21.0, width: 15.1, height: 4.7,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.letterH, '‰Ωï„ÅãÊõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: 'ÁÖßÊòé',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: '', visible: () => true }
                    },
                    {
                        x: 1.6, y: 48.9, width: 23.2, height: 12.7,
                        onClick: clickWrap(function () {
                            updateMessage('„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆ„Éá„Çπ„ÇØ„Å†„ÄÇËâ≤„ÄÖ„Å™„ÇÇ„ÅÆ„ÅåÁΩÆ„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆÊú∫',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 78.0, y: 61.0, width: 18.5, height: 19.6,
                        onClick: clickWrap(function () {
                            updateMessage('„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆ„ÉÅ„Çß„Çπ„Éà„Å†„ÄÇ„Åï„Åô„Åå„Å´Èñã„Åë„Å•„Çâ„ÅÑ');
                        }),
                        description: '„Ç´„Ç®„É´Áî∞„Åï„ÇìËÉåÂæå„ÅÆ„ÉÅ„Çß„Çπ„Éà',
                        zIndex: 3,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 84.6, y: 60.1, width: 10.0, height: 4.9,
                        onClick: clickWrap(function () {
                            updateMessage('ÂëºÂê∏Ê≥ï„Å´„Å§„ÅÑ„Å¶„ÅÆÊú¨„ÅåÁΩÆ„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: '„ÉÅ„Çß„Çπ„Éà„ÅÆ‰∏ä„ÅÆÊú¨',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 22.0, y: 36.6, width: 19.3, height: 12.5,
                        onClick: clickWrap(function () {
                            changeRoom('score');
                        }),
                        description: 'Ê•ΩË≠ú',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 65.7, y: 49.4, width: 10.6, height: 7.0,
                        onClick: clickWrap(function () {
                            showObj(null, '„Åö„ÅÑ„Å∂„ÇìÊ±ö„Çå„ÅüÊ•ΩË≠ú„Å†‚Ä¶', IMAGES.modals.score2, 'Ê±ö„Çå„ÅüÊ•ΩË≠ú„Å†„ÄÇ');

                        }),
                        description: 'Ê•ΩË≠úÁ´ã„Å¶„ÅÆÊ•ΩË≠ú',
                        zIndex: 3,
                        usable: () => true,
                        item: { img: 'score2', visible: () => true }
                    },
                    {
                        x: 73.6, y: 39.0, width: 4.9, height: 8.3,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.posterApple, '‰Ωï„Åã„ÅÆÊ®ôË™û„Åã„Å™Ôºü');
                        }),
                        description: 'Â£Å„ÅÆÊ®ôË™û',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 54.7, y: 54.6, width: 17.0, height: 22.9,
                        onClick: clickWrap(function () {
                            // Ê≠åË©û„ÅåÊÄù„ÅÑÂá∫„Åõ„Å™„ÅÑ„ÅÆ„ÅßÊïô„Åà„Çã„É¢„Éº„ÉÄ„É´„Éë„Ç∫„É´„ÄÅIMAGES.modals.frogWarried
                            playSE('se-song-forget');
                            showSongPuzzle();

                        }),
                        description: '„Ç´„Ç®„É´Áî∞„Åï„Çì',
                        zIndex: 5,
                        usable: () => gameState.roomFrog.flags.backgroundState == 0,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 53.5, y: 49.3, width: 19.5, height: 21.4,
                        onClick: clickWrap(function () {
                            // „Ç´„Ç®„É´Áî∞„Åï„Çì„ÅØÊ≠å„Å£„Å¶„ÅÑ„Çã
                            playSE('se-song');
                            showObj('null', '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅØÊ≠å„Å£„Å¶„ÅÑ„Çã', IMAGES.modals.frogSinging, '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅØÊ≠å„Å£„Å¶„ÅÑ„Çã');
                        }),
                        description: '„Ç´„Ç®„É´Áî∞„Åï„Çì',
                        zIndex: 5,
                        usable: () => gameState.roomFrog.flags.backgroundState == 1,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('map');
                        }, { allowAtNight: true }),
                        description: '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆÂÆ∂Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            score: {
                name: '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆÊ•ΩË≠ú',
                description: '',
                clickableAreas: [
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('roomFrog');
                        }, { allowAtNight: true }),
                        description: '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆÊ•ΩË≠úÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            roomRabit: {
                name: '„É©„ÉìÈáé„Åï„Çì„ÅÆÂÆ∂',
                description: '',
                clickableAreas: [
                    {
                        x: 57.0, y: 48.1, width: 18.7, height: 35.5,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem === 'recipe') {
                                showObj(null, '„Å®„Å¶„ÇÇÁæéÂë≥„Åó„ÅÑ„É¨„Ç∑„Éî„Å™„Çì„Åß„Åô„Åë„Å©‚Ä¶<br>‰ªä„ÅØ„Åæ„ÅöÈáéËèúÁÆ±„Çí„Å™„Çì„Å®„Åã„Åó„Å™„ÅÑ„Å®', IMAGES.modals.rabitKumapon, 'ÈáéËèúÁÆ±„ÅåÂÑ™ÂÖà‰∫ãÈ†Ö„Çâ„Åó„ÅÑ');
                                return;
                            }
                            showObj(null, 'Âõ∞„Çä„Åæ„Åó„Åü‚Ä¶ÈáéËèúÁÆ±„ÅåÈñã„Åã„Å™„Åè„Å¶', IMAGES.modals.rabitWorried, 'ÈáéËèúÁÆ±„ÅåÈñã„Åã„Å™„ÅÑ„Çâ„Åó„ÅÑ');
                        }),
                        description: '„É©„ÉìÈáé„Åï„ÇìÂõ∞„Å£„Å¶„ÅÑ„Çã',
                        zIndex: 5,
                        usable: () => gameState.roomRabit.flags.backgroundState == 0,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 57.0, y: 48.1, width: 18.7, height: 35.5,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem === 'recipe') {
                                showObj(null, '„Å®„Å¶„ÇÇÁæéÂë≥„Åó„ÅÑ„É¨„Ç∑„Éî„Å™„Çì„Åß„Åô„ÄÇ<br>ÊùêÊñô„Åå„ÅÇ„Çå„Å∞‰Ωú„Çå„Çã„ÅÆ„Åß„Åô„Åå‚Ä¶', IMAGES.modals.rabitKumapon, '„ÇØ„Éû„Éù„É≥„ÅÆÊùêÊñô„ÇíË¶ã„Å§„Åë„Åü„ÇâÊ∏°„Åó„Å¶„Åø„Çà„ÅÜ');
                                return;
                            }
                            if (hasItem('bearCitrus') && hasItem('seasoning')) {
                                showObj(null, '„ÇØ„Éû„Éù„É≥„ÅÆÊùêÊñô„ÄÅÊåÅ„Å£„Å¶„Åç„Å¶‰∏ã„Åï„Å£„Åü„Çì„Åß„Åô„Å≠ÔºÅ<br>„ÇØ„Éû„Éù„É≥„ÅØÂÆ¥‰ºö„Å´ÊåÅ„Å£„Å¶„ÅÑ„Åç„Åæ„Åô„Å≠', IMAGES.modals.rabitReceiveCitrus, '„É©„ÉìÈáé„Åï„Çì„Åå„ÇØ„Éû„Éù„É≥„Çí‰Ωú„Å£„Å¶„Åè„Çå„Çã„Çâ„Åó„ÅÑ');
                                playSE('se-clear');
                                gameState.main.flags.kumaponCompleted = true;
                                gameState.flags.trueEndUnlocked = true;
                                removeItem('bearCitrus');
                                removeItem('seasoning');
                                return;

                            }
                            showObj(null, 'Âä©„Åã„Çä„Åæ„Åó„Åü', IMAGES.modals.rabitInspiration, '„Åì„Çå„ÅßÈáéËèú„ÅåÈ£ü„Åπ„Çâ„Çå„Çã„Å≠');
                        }),
                        description: '„É©„ÉìÈáé„Åï„ÇìÂÆâÂøÉ',
                        zIndex: 5,
                        usable: () => gameState.roomRabit.flags.backgroundState == 1,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 2.0, y: 34.2, width: 12.1, height: 12.0,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.book1, 'ÂΩπ„Å´Á´ã„Å°„Åù„ÅÜ„Å™Êú¨„Åå„ÅÇ„Çã');

                        }),
                        description: 'Êú¨Ê£ö‰∏äÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 1.9, y: 46.9, width: 12.2, height: 12.9,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.bookRiver, '„Åì„ÅÆÂú∞Êñπ„Å´Èñ¢„Åô„ÇãÊú¨„Å†', IMAGES.modals.bookRiverEn);
                        }),
                        description: 'Êú¨Ê£ö‰∏≠ÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 1.5, y: 61.6, width: 12.4, height: 10.8,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.book2, 'ÂΩπ„Å´Á´ã„Å°„Åù„ÅÜ„Å™Êú¨„Åå„ÅÇ„Çã„ÄÇ„É©„ÉìÈáé„Åï„Çì„ÅØ„Ç≠„É£„Éô„ÉÑ„Å®„ÅãÂ•Ω„Åç„Åù„ÅÜ„Å†„ÄÇ');

                        }),
                        description: 'Êú¨Ê£ö‰∏ãÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 1.8, y: 77.5, width: 13.1, height: 12.6,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.foundRecipe) {
                                updateMessage('Êú¨„Åå‰∏¶„Çì„Åß„ÅÑ„Çã');
                            } else {
                                acquireItemOnce('foundRecipe', 'recipe', '„É¨„Ç∑„Éî„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.recipe, '„ÇØ„Éû„Éù„É≥„É¨„Ç∑„Éî„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                            }
                        }),
                        description: 'Êú¨Ê£öÊúÄ‰∏ãÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 19.4, y: 62.7, width: 7.7, height: 4.1,
                        onClick: clickWrap(function () {
                            showObj(null, 'ÂΩπÁ´ã„Å°„Åù„ÅÜ„Å™Êú¨„Å†', IMAGES.modals.bookE, 'ÂΩπÁ´ã„Å°„Åù„ÅÜ„Å™Êú¨„Å†');
                        }),
                        description: '„Çµ„Ç§„Éâ„ÉÜ„Éº„Éñ„É´„ÅÆ‰∏ä„ÅÆÊú¨',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 25.8, y: 42.2, width: 6.2, height: 7.5,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.posterTree, 'ÊÑèÂë≥„ÅÇ„Çä„Åí„Å™Êú®„ÅÆÁµµ„Å†„ÄÇ');
                        }),
                        description: 'Â£Å„ÅÆÁµµÂ∑¶',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'posterTree', visible: () => true }
                    },
                    {
                        x: 76.5, y: 73.1, width: 22.5, height: 20.1,
                        onClick: clickWrap(function () {
                            openRabitVegetableLockModal();
                        }),
                        description: 'ÈáéËèúÁÆ±',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('map');
                        }, { allowAtNight: true }),
                        description: '„É©„ÉìÈáé„Åï„Çì„ÅÆÂÆ∂Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            roomDog: {
                name: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂÆ∂',
                description: '',
                clickableAreas: [
                    {
                        x: 23.4, y: 43.6, width: 15.4, height: 13.6,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToDog) {
                                updateMessage('„ÉØ„É≥Ëä±„Åï„Çì„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            showObj(null, '', IMAGES.items.mapDog, 'Âú∞Âõ≥„Åå„ÅÇ„Çã');
                        }),
                        description: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂú∞Âõ≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'mapDog', visible: () => true }
                    },
                    {
                        x: 54.7, y: 45.4, width: 20.5, height: 23.2,
                        onClick: clickWrap(function () {
                            // 1ÂõûÁõÆ: Ë©±„ÇíËÅû„ÅèÔºàtalkToDog=trueÔºâ
                            if (!gameState.main.flags.talkToDog) {
                                gameState.main.flags.talkToDog = true;
                                showObj(null,
                                    'È£≤„ÅøÁâ©„ÅÆÂÆÖÈÖçÊ•≠ËÄÖ„Åï„Çì„Å´„ÄÅ<br>„Åì„ÅÆÊùë„Åæ„Åß„ÅÆÈÅìÈ†Ü„Çí‰ºù„Åà„Å™„ÅÑ„Å®„ÅÑ„Åë„Å™„ÅÑ„ÉØ„É≥',
                                    IMAGES.modals.dogWorried,
                                    '„ÉØ„É≥Ëä±„Åï„Çì„ÅØÂõ∞„Å£„Å¶„ÅÑ„Çã„ÄÇ„Çπ„Éû„Éõ„ÇíË¶ã„Å¶„Åø„Çà„ÅÜ'
                                );
                                return;
                            }

                            // 2ÂõûÁõÆ‰ª•Èôç: ÈÅìÈ†Ü„Éë„Ç∫„É´„Å∏
                            openDogRouteAskModal();
                        }),
                        description: '„ÉØ„É≥Ëä±„Åï„ÇìÂõ∞„Å£„Å¶„ÅÑ„Çã',
                        zIndex: 5,
                        usable: () => gameState.roomDog.flags.backgroundState == 0,
                        item: { img: 'IMAGE_KEY', visible: () => gameState.roomDog.flags.backgroundState == 0 }
                    },
                    {
                        x: 54.7, y: 45.4, width: 20.5, height: 23.2,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockRoute) {
                                showObj(null, '„Çà„Åã„Å£„Åü„ÉØ„É≥ÔºÅÂä©„Åã„Å£„Åü„ÉØ„É≥ÔºÅ', IMAGES.modals.dogInspiration, 'ÈÅìÈ†Ü„ÅØ„ÇÇ„ÅÜ‰ºù„Åà„Åü„ÄÇ');
                            }
                        }),
                        description: '„ÉØ„É≥Ëä±„Åï„ÇìÂÆâÂøÉ',
                        zIndex: 5,
                        usable: () => gameState.roomDog.flags.backgroundState == 1,
                        item: { img: 'IMAGE_KEY', visible: () => gameState.roomDog.flags.backgroundState == 1 }
                    },
                    {
                        x: 77.9, y: 62.5, width: 7.8, height: 6.2,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToDog) {
                                updateMessage('„ÉØ„É≥Ëä±„Åï„Çì„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            if (gameState.main.flags.unlockRoute) {
                                showObj(null, '', IMAGES.modals.spImage2, 'ÈÖçÈÅîÂÆå‰∫Ü„Åó„Åü„Çà„ÅÜ„Å†');
                            } else {
                                showObj(null, 'Ë°ó„Åã„ÇâÊù•„ÇãÂÆÖÈÖçÊ•≠ËÄÖ„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏<br>„Äé„Åì„Åì„ÇíÊ∏°„Å£„Åü„Å®„Åì„Çç„ÅßÈÅì„ÅåÂàÜ„Åã„Çâ„Å™„Åè„Å™„Çä„Åæ„Åó„Åü„Äè', IMAGES.modals.spImage, '‰Ωï„ÇíÁ§∫„Åó„Å¶„ÅÑ„Çã„Çì„Å†„Çç„ÅÜ', IMAGES.modals.spImageEn);
                            }

                        }),
                        description: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆ„Çπ„Éû„Éõ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 18.8, y: 64.9, width: 6.2, height: 5.7,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToDog) {
                                updateMessage('„ÉØ„É≥Ëä±„Åï„Çì„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            changeRoom('drawerDog');
                        }),
                        description: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂºï„ÅçÂá∫„Åó',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 5.1, y: 73.5, width: 6.4, height: 4.9,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.talkToDog) {
                                updateMessage('„ÉØ„É≥Ëä±„Åï„Çì„ÅÆË©±„ÇíËÅû„Åì„ÅÜ');
                                return;
                            }
                            acquireItemOnce('foundPruners', 'pruners', 'Ââ™ÂÆö„ÅØ„Åï„Åø„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.pruners, 'Ââ™ÂÆö„ÅØ„Åï„Åø„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                            gameState.main.flags.bearAppear = true;
                        }),
                        description: 'Ââ™ÂÆö„ÅØ„Åï„Åø',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundPruners,
                        item: { img: 'prunersPart', visible: () => !gameState.main.flags.foundPruners }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('map');
                        }, { allowAtNight: true }),
                        description: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂÆ∂Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            drawerDog: {
                name: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂºï„ÅçÂá∫„Åó',
                description: '',
                clickableAreas: [
                    {
                        x: 23.2, y: 31.5, width: 23.2, height: 33.9,
                        onClick: clickWrap(function () {
                            showObj(null, 'ÂíåË£Ö„ÅÆ„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂπ¥Ë≥ÄÁä∂„Å†', IMAGES.modals.nengajoDog, '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂπ¥Ë≥ÄÁä∂„Åå„ÅÇ„Çã„ÄÇË©¶‰ΩúÂìÅ„Åã„Å™Ôºü');
                        }),
                        description: 'Âπ¥Ë≥ÄÁä∂',
                        zIndex: 4,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 37.6, y: 10.2, width: 42.1, height: 41.9,
                        onClick: clickWrap(function () {
                            updateMessage('‰Ωï„ÅãÊõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: '‰∫îËßíÂΩ¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('roomDog');
                        }, { allowAtNight: true }),
                        description: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂºï„ÅçÂá∫„ÅóÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            roomHorse: {
                name: '„Ç¶„ÉûÈáë„Åï„Çì„ÅÆÂÆ∂',
                description: '',
                clickableAreas: [
                    {
                        x: 0.5, y: 64.9, width: 17.4, height: 6.2,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDrawerHorse) {
                                changeRoom('drawerHorse');
                            } else {
                                showHorseDrawerPuzzle();
                            }
                        }),
                        description: 'Âºï„ÅçÂá∫„Åó',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 83.6, y: 28.6, width: 13.5, height: 13.1,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.posterHorse, '„Ç¶„ÉûÈáëÔºà„Åã„Å≠Ôºâ„Åï„Çì„ÅÆ„Éù„Çπ„Çø„Éº„Å†');
                        }),
                        description: 'Ëá™ÊíÆ„Çä„Éù„Çπ„Çø„Éº',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 33.1, y: 30.8, width: 25.1, height: 41.9,
                        onClick: clickWrap(function () {
                            const f = gameState.main.flags;
                            if (!f.talkToHorse) {
                                f.talkToHorse = true;
                                if (typeof renderNotebookTasks === 'function') renderNotebookTasks();
                            }
                            if (gameState.selectedItem == 'brush') {
                                showObj(null, '„Åä„Å£ÔºÅ„Éñ„É©„Ç∑„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ', IMAGES.modals.horseInspiration, '„Éñ„É©„Ç∑„ÇíÊâãÊ∏°„Åó„Åü');
                                playSE('se-clear');
                                removeItem('brush');
                                gameState.main.flags.passBrush = true;
                                gameState.roomHorse.flags.backgroundState++;
                                renderCanvasRoom();
                                // Ëß£Ê±∫„Éà„Éº„Çπ„ÉàÔºà1Âõû„Å†„ÅëÔºâ
                                if (!f.horseSolvedToastShown && typeof showToast === 'function') {
                                    showToast('„Ç¶„ÉûÈáë„Åï„Çì„ÅÆÂïèÈ°å„ÅåËß£Ê±∫„Åó„Åü„ÄÇÊùëÈï∑„Å´Â†±Âëä„Å´Ë°å„Åì„ÅÜ');
                                    f.horseSolvedToastShown = true;
                                }

                                if (typeof renderNotebookTasks === 'function') renderNotebookTasks();

                            } else {
                                showObj(null, '„Éñ„É©„Ç∑„ÅåË¶ãÂΩì„Åü„Çâ„Å™„Åè„Å¶„Åï‚Ä¶<br>„Åü„Å¶„Åå„Åø„ÅÆÊâãÂÖ•„Çå„Åå„Åß„Åç„Å™„ÅÑ„Çì„Å†', IMAGES.modals.horseWorried, '„Åü„Å¶„Åå„Åø„ÅÆ„ÅäÊâãÂÖ•„Çå„Å´„ÄÅ„Éñ„É©„Ç∑„ÅåÂøÖË¶Å„Çâ„Åó„ÅÑ');
                            }

                        }),
                        description: '„Ç¶„ÉûÈáë„Åï„Çì„Åü„Å¶„Åå„Åø„Åç„Å´„Åô„Çã',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.passBrush,

                    },
                    {
                        x: 33.1, y: 30.8, width: 25.1, height: 41.9,
                        onClick: clickWrap(function () {
                            showObj(null, '‚Ä¶„ÅÜ„Å£„Å®„ÇäÔºàËá™ÂàÜ„Å´Ë¶ã„Å®„Çå„Å¶„ÅÑ„ÇãÔºâ', IMAGES.modals.horseInspiration, '„Ç¶„ÉûÈáë„Åï„Çì„ÅØËá™ÂàÜ„Å´Ë¶ã„Å®„Çå„Å¶„ÅÑ„Çã');

                        }),
                        description: '„Ç¶„ÉûÈáë„Åï„Çì„Ç≠„É©„Ç≠„É©',
                        zIndex: 5,
                        usable: () => gameState.main.flags.passBrush,

                    },
                    {
                        x: 9.7, y: 51.0, width: 9.7, height: 9.0,
                        onClick: clickWrap(function () {
                            updateMessage('„Åü„Å¶„Åå„Åø„ÅÆ„ÅäÊâãÂÖ•„ÇåÁî®ÂìÅ„ÅÆ„Çà„ÅÜ„Å†');
                        }),
                        description: '„Åü„Å¶„Åå„Åø„ÅÆ„ÅäÊâãÂÖ•„ÇåÁî®ÂìÅ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 58.4, y: 23.1, width: 20.2, height: 63.9,
                        onClick: clickWrap(function () {
                            updateMessage('Â§ß„Åç„Å™ÂßøË¶ã„Å†');

                        }),
                        description: 'Â§ß„Åç„Å™ÂßøË¶ã',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 79.9, y: 80.0, width: 19.5, height: 12.5,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockBox) {
                                acquireItemOnce('foundBrush', 'brush', '„Éñ„É©„Ç∑„ÅåÂÖ•„Å£„Å¶„ÅÑ„Åü', IMAGES.items.brush, '„Éñ„É©„Ç∑„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                            } else {
                                showHorseBoxPuzzle();
                            }

                        }),
                        description: '„É≠„ÉÉ„ÇØ„Åï„Çå„ÅüÁÆ±',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 82.6, y: 85.5, width: 4.6, height: 2.0,
                        onClick: clickWrap(function () {

                        }),
                        description: 'LOCKED',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'locked', visible: () => !gameState.main.flags.unlockBox }
                    },
                    {
                        x: 82.6, y: 85.5, width: 4.6, height: 2.0,
                        onClick: clickWrap(function () {

                        }),
                        description: 'UNLOCKED',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'unlocked', visible: () => gameState.main.flags.unlockBox }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('map');
                        }, { allowAtNight: true }),
                        description: '„Ç¶„ÉûÈáë„Åï„Çì„ÅÆÂÆ∂Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            drawerHorse: {
                name: '„Ç¶„ÉûÈáë„Åï„Çì„ÅÆÂºï„ÅçÂá∫„Åó',
                description: '',
                clickableAreas: [
                    {
                        x: 18.6, y: 38.3, width: 23.2, height: 33.7,
                        onClick: clickWrap(function () {
                            showObj(null, 'Ëá™ÂàÜ„Åå‰∏ªÂΩπ„ÅÆÂπ¥Ë≥ÄÁä∂„Å†‚Ä¶', IMAGES.modals.nengajo, '„Ç¶„ÉûÈáë„Åï„Çì„Åå‰∏ªÂΩπ„ÅÆÂπ¥Ë≥ÄÁä∂„Åå„ÅÇ„Çã„ÄÇË©¶‰ΩúÂìÅ„Å†„Çç„ÅÜ„Åã„ÄÇ');
                        }),
                        description: 'Âπ¥Ë≥ÄÁä∂',
                        zIndex: 4,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 46.5, y: 37.6, width: 34.7, height: 35.4,
                        onClick: clickWrap(function () {
                            updateMessage('‰Ωï„ÅãÊõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: '‰∫îËßíÂΩ¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('roomHorse');
                        }, { allowAtNight: true }),
                        description: '„Ç¶„ÉûÈáë„Åï„Çì„ÅÆÂºï„ÅçÂá∫„Åó',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },


            end: {
                name: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ',
                description: '„ÅÇ„Å™„Åü„ÅØ„Å™„Åû„Å™„ÅûÊùë„ÅÆ„Éà„É©„Éñ„É´„ÇíËß£Ê±∫„Åó„ÄÅÁÑ°‰∫ã„Å´Êù•Âπ¥„Å∏„Å®ËÑ±Âá∫„Åï„Åõ„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
                clickableAreas: [
                    {
                        x: 88.3, y: 5.8, width: 9.8, height: 8.9,
                        onClick: clickWrap(function () {
                            updateMessage('ÂπªË¶ö„Åã„Å™Ôºü');
                        }),
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            showEndingReport('end');
                        }),
                        description: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ'
                    },

                ]
            },
            trueEnd: {
                name: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                description: '„ÅÇ„Å™„Åü„ÅØ„Å™„Åû„Å™„ÅûÊùë„ÅÆ„Éà„É©„Éñ„É´„ÇíËß£Ê±∫„Åó„ÄÅÁÑ°‰∫ã„Å´Êù•Âπ¥„Å∏„Å®ËÑ±Âá∫„Åï„Åõ„Åæ„Åó„Åü„ÄÇ„ÇØ„Éû„Éù„É≥„ÅÆ„Åä„Åã„Åí„Åß„Çà„ÇäÁæéÂë≥„Åó„ÅÑÈçã„ÅåÊ•Ω„Åó„ÇÅ„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
                clickableAreas: [
                    {
                        x: 59.4, y: 68.8, width: 18.8, height: 20.2,
                        onClick: clickWrap(function () {
                            updateMessage('„ÇØ„Éû„Éù„É≥„Å†„ÄÇ„Åç„Å£„Å®„Ç´„Éã„Å´Âêà„ÅÜ„ÅÆ„Å†„Çç„ÅÜ');
                        }),
                        description: '„ÇØ„Éû„Éù„É≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 34.8, y: 51.4, width: 34.0, height: 15.2,
                        onClick: clickWrap(function () {
                            updateMessage('ÁæéÂë≥„Åó„Åù„ÅÜ„Å†');
                        }),
                        description: '„Ç´„ÉãÈçã',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 71.7, y: 9.3, width: 27.9, height: 19.1,
                        onClick: clickWrap(function () {
                            showObj(null, '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅØÊ•Ω„Åó„Åù„ÅÜ„Å´Ê≠å„Å£„Å¶„ÅÑ„Çã', IMAGES.modals.endFrog, '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅØÊ•Ω„Åó„Åù„ÅÜ„Å´Ê≠å„Å£„Å¶„ÅÑ„Çã');
                            playSE('se-song');
                        }),
                        description: '„Ç´„Ç®„É´Áî∞„Åï„Çì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0.8, y: 26.2, width: 21.6, height: 30.4,
                        onClick: clickWrap(function () {
                            showObj(null, '„ÇØ„Éû„Éù„É≥„ÅØÁæéÂë≥„ÅÑ„ÅÆ„ÅÜÔºÅ', IMAGES.modals.endCat, '„Å≠„ÅìÂ±±ÊùëÈï∑„ÅØÂ¨â„Åó„Åù„ÅÜ„Å´Èçã„Çí„Å§„Å§„ÅÑ„Å¶„ÅÑ„Çã');
                        }),
                        description: '„Å≠„ÅìÂ±±ÊùëÈï∑',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 22.9, y: 8.1, width: 20.1, height: 29.6,
                        onClick: clickWrap(function () {
                            showObj(null, 'ÁæéÂë≥„ÅÑÔºÅÊúÄÈ´òÔºÅ', IMAGES.modals.endHorse, '„Ç¶„ÉûÈáë„Åï„Çì„ÅØ„Ç´„Éã„Çí„Éë„ÇØ„Éë„ÇØÈ£ü„Åπ„Å¶„ÅÑ„Çã');
                        }),
                        description: '„Ç¶„ÉûÈáë„Åï„Çì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 53.1, y: 19.2, width: 23.0, height: 23.6,
                        onClick: clickWrap(function () {
                            showObj(null, 'ÁæéÂë≥„Åó„ÅÑ„ÉØ„É≥ÔºÅ', IMAGES.modals.endDog, '„ÉØ„É≥Ëä±„Åï„Çì„ÅØÂ¨â„Åó„Åù„ÅÜ„Å´„ÅäËÇâ„ÇíÈ£ü„Åπ„Å¶„ÅÑ„Çã');
                        }),
                        description: '„ÉØ„É≥Ëä±„Åï„Çì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 77.3, y: 34.1, width: 21.9, height: 35.5,
                        onClick: clickWrap(function () {
                            showObj(null, '„Åó„ÅÇ„Çè„ÅõÔºÅ„ÇØ„Éû„Éù„É≥„ÇÇÁæéÂë≥„Åó„Åè„Åß„Åç„Å¶ËâØ„Åã„Å£„Åü„Åß„Åô', IMAGES.modals.endRabit, '„É©„ÉìÈáé„Åï„Çì„ÅØ„ÄÅÁôΩËèú„ÅåÂ§ßÂ•Ω„Åç„Å™„Çà„ÅÜ„Å†');
                        }),
                        description: '„É©„ÉìÈáé„Åï„Çì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 79.7, y: 0.7, width: 17.6, height: 12.3,
                        onClick: clickWrap(function () {
                            showObj(null, 'ËÑ±Âá∫ÊàêÂäüÔºÅ‚ù§', IMAGES.modals.endBear, '„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÂ§ßËÉÜ„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Çã');
                        }),
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            updateMessage('„ÅÇ„Å™„Åü„ÅØ„Å™„Åû„Å™„ÅûÊùë„ÅÆ„Éà„É©„Éñ„É´„ÇíËß£Ê±∫„Åó„ÄÅÁÑ°‰∫ã„Å´Êù•Âπ¥„Å∏„Å®ËÑ±Âá∫„Åï„Åõ„Åæ„Åó„Åü„ÄÇ„ÇØ„Éû„Éù„É≥„ÅÆ„Åä„Åã„Åí„Åß„Çà„ÇäÁæéÂë≥„Åó„ÅÑÈçã„ÅåÊ•Ω„Åó„ÇÅ„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ');
                            showEndingReport('trueEnd');
                        }),
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                        usable: () => true,
                    },

                ]
            },
        };

        const hintMessages = {
            main: {
                bear: [
                    '„Åµ„ÅÜ„ÄÅ„Åä„ÅÑ„Åó„Åã„Å£„Åü',
                    '„ÅàÔºüÊ¨≤„Åó„Åã„Å£„Åü„ÅÆ',
                    '„Åµ„Éº„Çì',
                ],
                288: [
                    '288„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã„ÄÇ„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ„ÄÇ',
                    '„Åì„ÅÆÈÉ®Â±ãÁï™Âè∑„ÄÅ‰ªñ„ÅÆÈÉ®Â±ã„Å®Ë¶èÂâá„ÅåÂêà„Å£„Å¶„ÅÑ„Å™„ÅÑÊ∞ó„Åå„Åô„Çã‚Ä¶',
                ]
            },
        };



        // Ë∂≥Èü≥„ÅßÊï∞Ê≠©‚Üí„ÉØ„Éº„ÉóÊºîÂá∫‚ÜíÁõÆÁöÑ„ÅÆÈÉ®Â±ã„Å∏
        function travelWithSteps(destRoom = 'extra') {
            const canvasEl = document.getElementById('gameCanvas');
            const overlay = document.getElementById('roomEffectOverlay');

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-joyanokane');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#000';  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;

                if (step >= 3) {
                    clearInterval(stepTimer);

                    if (overlay) {
                        changeRoom(destRoom);
                    }

                    setTimeout(() => {

                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            // overlay.style.background = '';
                            overlay.style.opacity = 0;

                        }

                    }, 100);
                }
            }, 160);
        }

        function travelWithStepsTrueEnd() {
            const overlay = document.getElementById('roomEffectOverlay');
            let destRoom = 'trueEnd';

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-nami');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#000';  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;


                if (step >= 3) {
                    clearInterval(stepTimer);

                    // Èªí‚Üí„ÉØ„Éº„ÉóÂÖâ„Å∏ÂàáÊõø
                    if (overlay) {
                        overlay.classList.add('warp-active');
                        changeRoom(destRoom);
                        overlay.style.background = '';   // warp „ÅÆÁôΩÁô∫ÂÖâ„Å´Êàª„Åô
                    }

                    setTimeout(() => {


                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            overlay.classList.remove('warp-active');
                            overlay.style.opacity = 0;
                        }

                    }, 900);
                }
            }, 260);
        }

        function quickBlackFade(duration = 300) {
            const fade = document.getElementById('roomEffectOverlay');
            if (!fade) return;

            // „Åæ„Åö‰∏ÄÁû¨„ÅßÈªí„Åè„Åô„Çã
            fade.style.background = '#000';
            fade.style.opacity = '1';

            // duration ms Âæå„Å´ÈÄèÊòé„Å∏Êàª„Åô
            setTimeout(() => {
                fade.style.opacity = '0';
            }, duration);
        }

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            renderNavigation();
            changeRoom('map');
            updateMessage('Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÁü•„Çâ„Å™„ÅÑÊùë„Å´Ëø∑„ÅÑËæº„Çì„Åß„ÅÑ„Åæ„Åó„Åü');

        }

        function findHitArea(x, y, clickableAreas, canvas) {
            // zIndexÈôçÈ†Ü„Åß
            const sorted = clickableAreas.slice().sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            for (const area of sorted) {
                // ÂøÖË¶Å„Å™„ÇâusableÂà§ÂÆö„ÇÇ„Åì„Åì„Åß
                const usable = area.usable === undefined ? true :
                    (typeof area.usable === "function" ? area.usable() : area.usable);

                if (!usable) continue; // ‰Ωø„Åà„Å™„ÅÑ„Ç®„É™„Ç¢„ÅØÂà§ÂÆö„Åó„Å™„ÅÑ
                const ax = area.x / 100 * canvas.width;
                const ay = area.y / 100 * canvas.height;
                const aw = area.width / 100 * canvas.width;
                const ah = area.height / 100 * canvas.height;
                if (x >= ax && x <= ax + aw && y >= ay && y <= ay + ah) {
                    return area; // ÊúÄÂàù„Å´„Éí„ÉÉ„Éà„Åó„Åü„ÇÇ„ÅÆ„Å†„ÅëËøî„ÅôÔºÅ
                }
            }
            return null;
        }

        let hoveredAreaIndex = null;  // ‰ªähover„Åó„Å¶„Çã„Ç®„É™„Ç¢Ôºà„Å™„Åë„Çå„Å∞nullÔºâ
        canvas.addEventListener('mousemove', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);
            const idx = area ? room.clickableAreas.indexOf(area) : null;
            if (hoveredAreaIndex !== idx) {
                hoveredAreaIndex = idx;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('mouseout', function () {
            if (hoveredAreaIndex !== null) {
                hoveredAreaIndex = null;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('click', function (e) {

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // ‚òÖ‰ªä„ÅÑ„ÇãÈÉ®Â±ã„ÅÆ„Ç®„É™„Ç¢„Å†„ÅëÂà§ÂÆöÔºÅ
            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);

            // if (area) {
            //     handleAreaClick(area.action, e);
            // }
            if (area) {
                if (typeof area.onClick === 'function') {
                    area.onClick(e);
                    playSE('se-click');
                } else if (area.action) {
                    handleAreaClick(area.action, e); // ‰∫íÊèõ„ÅÆ„Åü„ÇÅ„Å´ÊÆã„Åó„Å¶„ÇÇOK
                }
            }
        });

        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];

            // ËÉåÊôØÔºã„Ç¢„Ç§„ÉÜ„É†Ôºã„ÇØ„É™„ÉÉ„ÇØ„Ç®„É™„Ç¢„Çícanvas„ÅßÂÖ®ÈÉ®ÂÜçÊèèÁîª
            renderCanvasRoom();
            const msg = (room.name && room.name.trim() !== "")
                ? `${room.name}„Åß„Åô„ÄÇ${room.description}`
                : room.description;
            if (roomId === 'trueEnd') {
                updateMessageHTML(msg);
            } else {
                updateMessage(msg);
            }

            // BGMÂàáÊõø„ÅØ„Åù„ÅÆ„Åæ„Åæ
            if (roomId === "trueEnd") {
                changeBGM("sounds/24/party_day.mp3");

            } else if (roomId === "end") {
                changeBGM("sounds/24/party_day.mp3");

            } else {
                changeBGM("sounds/24/time_for_breakfast_2.mp3");

            }

            // nav
            if (roomId === "roomCat" || roomId === "roomFrog" || roomId === "roomRabit" || roomId === "roomDog" || roomId === "roomHorse") {
                addNaviItem(roomId);
                // renderNavigation();
            }
            if (roomId === "trueEnd" || roomId === "end") {
                gameState.openRooms = [];
                // renderNavigation();
            }
            renderNavigation();
        }

        const END_IDS = new Set(['end', 'trueEnd']);

        // ===== changeRoom „Éï„ÉÉ„ÇØÔºö=====
        const _changeRoom_custom = changeRoom;
        changeRoom = function (roomId) {
            _changeRoom_custom.apply(this, arguments);


            if (END_IDS.has(roomId)) {
                const elapsed = Math.round((Date.now() - ANA.start) / 1000);
                ANA.endTimes = ANA.endTimes || {};
                if (!ANA.endTimes[roomId]) ANA.endTimes[roomId] = elapsed;

                const isTrue = (roomId === 'trueEnd');
                ANA.send('ending_reached', {
                    ending_id: roomId,
                    is_true: isTrue,
                    elapsed_sec: elapsed,
                    hints: ANA.hintCount,

                });
                // setTimeout(() => showFeedbackModal(roomId), 1500);
            }
        };

        function renderCanvasRoom() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const roomId = gameState.currentRoom;
            const room = rooms[roomId];
            const bgImgSrc = getRoomBackgroundImage(roomId, gameState);

            ctx.clearRect(0, 0, canvas.width, canvas.height);


            // ËÉåÊôØÊèèÁîª
            const bgImg = loadedImages[bgImgSrc];
            if (bgImg && bgImg.complete) {
                ctx.save();
                const phase = gameState.main?.flags?.timePhase ?? 0;
                const isNight = (phase === 2);
                if (isNight) {
                    ctx.filter = 'saturate(0.3) brightness(0.6)'; // ËÉåÊôØ„ÅØ„Å°„Çá„ÅÑÊöó„ÇÅ
                } else {
                    ctx.filter = 'none';
                }
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
                ctx.restore();
            }

            // „Ç¢„Ç§„ÉÜ„É†ÊèèÁîªÔºàÊú™ÂèñÂæó„ÅÆ„ÅøÔºâ
            drawRoomItems(ctx, canvas, roomId);

            // ‚òÖ „Åì„Åì„Åã„ÇâÈáç„Å™„ÇäÂÑ™ÂÖà„ÅÆhoverÊû†Á∑ö„ÇíÊèèÁîª
            if (hoveredAreaIndex !== null && hoveredAreaIndex !== undefined) {
                // zIndexÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
                const sortedAreas = room.clickableAreas
                    .map((area, i) => ({ ...area, __idx: i }))
                    .filter(area => area.usable === undefined ? true :
                        (typeof area.usable === "function" ? area.usable() : area.usable)
                    )
                    .sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
                // hoveredAreaIndex„Å®‰∏ÄËá¥„Åô„Çã„Ç®„É™„Ç¢„ÇízIndexÈ†Ü„Åß1„Å§„Å†„ÅëÊû†ÊèèÁîª
                const hoverArea = sortedAreas.find(area => area.__idx === hoveredAreaIndex);
                if (hoverArea) {
                    const ax = hoverArea.x / 100 * canvas.width;
                    const ay = hoverArea.y / 100 * canvas.height;
                    const aw = hoverArea.width / 100 * canvas.width;
                    const ah = hoverArea.height / 100 * canvas.height;
                    ctx.save();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(ax, ay, aw, ah);
                    ctx.restore();
                }
            }


            if (DEV_MODE) {
                ctx.save();
                ctx.lineWidth = 2;


                room.clickableAreas.forEach(a => {

                    ctx.strokeStyle = 'rgba(255,0,0,0.8)';
                    ctx.fillStyle = 'rgba(255,0,0,0.35)';
                    ctx.font = '14px sans-serif';
                    const px = a.x / 100 * canvas.width;
                    const py = a.y / 100 * canvas.height;
                    const pw = a.width / 100 * canvas.width;
                    const ph = a.height / 100 * canvas.height;

                    // ÂçäÈÄèÊòé„ÅÆÊû†
                    ctx.fillRect(px, py, pw, ph);
                    ctx.strokeRect(px, py, pw, ph);

                    // description Ë°®Á§∫
                    if (a.description) {
                        ctx.fillStyle = 'rgba(0,0,0,0.7)';
                        ctx.fillRect(px, py - 18, ctx.measureText(a.description).width + 8, 18);

                        ctx.fillStyle = 'white';
                        ctx.fillText(a.description, px + 4, py - 4);
                    }
                });

                ctx.restore();
            }

        }

        function drawRoomItems(ctx, canvas, roomId) {
            const room = rooms[roomId];
            room.clickableAreas.forEach(area => {
                if (area.item && area.item.visible && area.item.visible()) {
                    const key = (typeof area.item.img === 'function') ? area.item.img() : area.item.img;
                    const img = loadedImages[IMAGES.items[key]];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const alpha = area.alpha ? area.alpha : 1;
                        const px = area.x / 100 * canvas.width;
                        const py = area.y / 100 * canvas.height;
                        const w = area.width / 100 * canvas.width;
                        const h = area.height / 100 * canvas.height;
                        ctx.save();
                        ctx.globalAlpha = alpha;

                        // ‚òÖ Â§ú„É¢„Éº„Éâ„Å™„ÇâÂΩ©Â∫¶ÔºãÊòé„Çã„Åï„ÇíËêΩ„Å®„Åô
                        const phase = gameState.main?.flags?.timePhase ?? 0;
                        const isNight = (phase === 2);
                        if (isNight) {
                            // ÂÄ§„ÅØÂ•Ω„Åø„ÅßË™øÊï¥
                            ctx.filter = 'saturate(0.4) brightness(0.8)';
                        } else {
                            ctx.filter = 'none';
                        }

                        ctx.drawImage(img, px, py, w, h);
                        ctx.restore();
                    }
                }
            });
        }


        function getRoomBackgroundImage(roomId, gameState) {
            const imgList = IMAGES.rooms[roomId];

            // Âçò‰∏ÄÁîªÂÉè„Å™„Çâ„Åù„ÅÆ„Åæ„Åæ
            if (!Array.isArray(imgList)) {
                return imgList;
            }

            const state = gameState[roomId]?.flags?.backgroundState ?? 0;
            return imgList[state] || imgList[0];
        }


        // Â∞èÁâ©„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function pointInRect(x, y, r) {
            return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;
        }

        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
            ctx.beginPath();
            ctx.moveTo(x + r.tl, y);
            ctx.lineTo(x + w - r.tr, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
            ctx.lineTo(x + w, y + h - r.br);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
            ctx.lineTo(x + r.bl, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
            ctx.lineTo(x, y + r.tl);
            ctx.quadraticCurveTo(x, y, x + r.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        // „Éï„É©„ÉÉ„Ç∑„É•„É¨„Ç§„É§„ÇíÁî®ÊÑè
        (function ensureFlashLayer() {
            if (!document.getElementById('fxFlash')) {
                const d = document.createElement('div');
                d.id = 'fxFlash';
                document.body.appendChild(d);
            }
        })();

        // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Ôºàtype: 'white' | 'red'Ôºâ
        function screenFlash(type = 'white', durMs = 180) {
            const f = document.getElementById('fxFlash'); if (!f) return;
            f.style.animation = 'none'; // ÈÄ£ÊâìÂØæÁ≠ñ
            // Âº∑Âà∂reflow„Åß„Ç¢„Éã„É°ÂÜçÈÅ©Áî®
            // eslint-disable-next-line no-unused-expressions
            f.offsetHeight;
            const key = type === 'red' ? 'flashRed' : 'flashWhite';
            f.style.animation = `${key} ${durMs}ms ease`;
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„ÇíÊ•µÂ∞è„Ç∑„Çß„Ç§„ÇØ
            document.documentElement.classList.add('fx-shake');
            setTimeout(() => document.documentElement.classList.remove('fx-shake'), 120);
        }


        function toggleNight() {

            quickBlackFade();
            setTimeout(() => {
                const phase = gameState.main?.flags?.timePhase ?? 0;
                if (phase === 2) {
                    // Â§ú
                    changeBGM("sounds/23/The_night_and_quiet.mp3");
                    updateMessage('Ëá™Âãï„ÅßÊ∂àÁÅØ„Åï„Çå„Åü„Çà„ÅÜ„Å†„ÄÇ');
                } else {
                    // Êòº„ÉªÂ§ïÊñπ
                    if (gameState.currentRoom == 'guestRoom') changeBGM("sounds/23/Paper_craft.mp3");
                }
                renderCanvasRoom();
            }, 300);

        }

        function acquireItemOnce(flagKey, itemId, title, imgSrc, msg) {
            const f = gameState.main.flags;
            if (f[flagKey]) {
                if (itemId == 'glass') {
                    updateMessage('„Ç∞„É©„Çπ„ÅåÊ≤¢Â±±„ÅÇ„Çã');
                } else {
                    updateMessage('„ÇÇ„ÅÜ‰Ωï„ÇÇ„Å™„ÅÑ');
                }

                return;
            }
            f[flagKey] = true;
            addItem(itemId);
            renderCanvasRoom();

            showModal(
                title,
                `<img src="${imgSrc}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );
            updateMessage(msg);
        }

        function clickWrap(fn, { allowAtNight = false } = {}) {
            return function (...args) {
                if (gameState.main.flags.isNight && !allowAtNight) {
                    updateMessage('Êöó„Åè„Å¶„Çà„ÅèË¶ã„Åà„Å™„ÅÑ');
                    return;
                }
                fn.apply(this, args);


                // „Ç¢„Ç§„ÉÜ„É†ÈÅ∏ÊäûËß£Èô§„ÅØ‰ªä„Åæ„ÅßÈÄö„Çä
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            };
        }


        // „Ç¢„ÇØ„Ç∑„Éß„É≥Âêç ‚Üí ÂÆüË°åÈñ¢Êï∞
        const ACTION_HANDLERS = {
            // --- ÁßªÂãïÁ≥ª ---
            examine_start_door_left() {
                // changeRoom('startRight');
            },

        };

        // „Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleAreaClick(action, event) {
            const handler = ACTION_HANDLERS[action];
            playSE('se-click');

            // area.onClick ÊñπÂºèÔºàÂ∞ÜÊù•„ÅÆ„Åü„ÇÅÔºâ
            if (typeof action === 'function') {
                action(event);
                return;
            }

            // actionÂêçÔºàÂæìÊù•„ÅÆÊñπÂºèÔºâ„Å´„ÇÇÂØæÂøú
            const fn = ACTION_HANDLERS[action];
            if (fn) {
                fn(event);
                return;
            }
            console.warn('Êú™ÂÆöÁæ©„ÅÆaction:', action);
        }


        // „ÇØ„É™„Ç¢„É¨„Éù„Éº„ÉàË°®Á§∫
        function showEndingReport(endingId = 'end') {
            const elapsedSec = Math.round((Date.now() - (ANA.start || Date.now())) / 1000);
            const m = Math.floor(elapsedSec / 60);
            const s = elapsedSec % 60;
            const timeStr = `${m}ÂàÜ${s.toString().padStart(2, '0')}Áßí`;

            // ‰ªä‰ΩúÁî®„Ç®„É≥„ÉâÊÉÖÂ†±
            const ENDING_INFO = {
                trueEnd: {
                    title: "üçä TRUE END",
                    label: "TRUE END",
                    desc: "„ÇØ„Éû„Éù„É≥„ÅßÁæéÂë≥„Åó„ÅÑÈçã„Éë„Éº„ÉÜ„Ç£„Åß„ÅôÔºÅ"
                },
                end: {
                    title: "üç≤ NORMAL END ",
                    label: "NORMAL END ",
                    desc: "ÁÑ°‰∫ã„Å´Êùë„ÅÆ„Éà„É©„Éñ„É´„ÇíËß£Ê±∫„Åó„Åæ„Åó„ÅüÔºÅ"
                },

            };

            const info = ENDING_INFO[endingId] || ENDING_INFO.end;

            // „Ç®„É≥„ÉâÂà•„Å≤„Å®„Åì„Å®
            let secretText = "";
            switch (endingId) {
                case "trueEnd":
                    secretText = "ü¶Ä „ÇØ„Éû„Éù„É≥„ÅßÁæéÂë≥„Åó„ÅÑ„Ç´„Éã„ÅåÈ£ü„Åπ„Çâ„Çå„Åæ„Åó„Åü";
                    break;
                case "end":
                    secretText = `üç≤ ÁÑ°‰∫ã„Å´‰ªäÂπ¥„ÇíËÑ±Âá∫„Åß„Åç„Åù„ÅÜ„Åß„Åô`;
                    break;

                default:
                    secretText = "";
            }

            // GAÈÄÅ‰ø°
            ANA.once('ending', endingId, {
                ending: endingId,
                time_sec: elapsedSec,
            });

            const html = `
        <div style="max-width:520px; text-align:center;">
            <h2 style="margin-top:0;">${info.title}</h2>
            <p style="margin:6px 0 12px 0; font-weight:bold;">${info.desc}</p>
            <p style="margin:4px 0;">„Éó„É¨„Ç§ÊôÇÈñìÔºö<b>${timeStr}</b></p>
            <p style="margin:4px 0;">„Éí„É≥„ÉàÂà©Áî®Ôºö<b>${ANA.hintCount || 0} Âõû</b></p>
            ${secretText ? `<p style="margin:12px 0; font-size:.9em; opacity:.85;">${secretText}</p>` : ""}
            
            
        </div>
    `;

            showModal("„Ç®„É≥„Éá„Ç£„É≥„Ç∞", html, [
                {
                    text: "Ë©ï‰æ°„ÅØ„Åì„Å°„Çâ",
                    action: () => openFeedbackForm(endingId),
                },
                {
                    text: "Èñâ„Åò„Çã",
                    action: () => {
                        closeModal();
                    },
                },
            ]);
        }

        // „ÇØ„É™„Ç¢„É≠„Ç∞ÁîüÊàêÔºàÊó¢Â≠ò„ÅÆ„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆ„Åæ„ÅæÊµÅÁî®„ÅßOKÔºâ
        function copyClearLog(label, timeStr) {
            const text =
                `„Äé„Å™„Åû„Å™„ÅûÊùë„ÅÆËÑ±Âá∫„Äè${label} „ÇØ„É™„Ç¢\n` +
                `„Éó„É¨„Ç§ÊôÇÈñìÔºö${timeStr}\n` +
                `„Éí„É≥„ÉàÂà©Áî®Ôºö${ANA.hintCount || 0}Âõû\n` +
                `#ËÑ±Âá∫„Ç≤„Éº„É† #„Å™„Åû„Å™„ÅûÊùë„ÅÆËÑ±Âá∫`;
            navigator.clipboard.writeText(text).then(() => {
                alert("„ÇØ„É™„Ç¢„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
            }).catch(() => {
                alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü‚Ä¶");
            });
        }

        // „Ç¢„É≥„Ç±„Éº„Éà
        function openFeedbackForm(endingId) {
            const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSd0OyJQJhmB29bBJHkDiNX_h-hk8gdhReZEvsFNtT_6ekWAFw/viewform";

            const endingLabel = ({
                trueEnd: "„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ",
                end: "„Éé„Éº„Éû„É´„Ç®„É≥„Éâ",
            })[endingId] || "„Ç®„É≥„Éâ";

            const params = new URLSearchParams({
                "entry.666725843": endingLabel,                  // „Å©„ÅÆ„Ç®„É≥„Éâ„Åã
            });

            window.open(`${FEEDBACK_URL}?${params.toString()}`, "_blank");
        }



        function talkToHintCharacter(roomId, charId) {
            // flagsÂèñÂæó
            let flags = gameState[roomId].flags;
            // „Åæ„Å†„Ç´„Ç¶„É≥„ÉàÁÑ°„Åë„Çå„Å∞ÂàùÊúüÂåñ
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            flags.talkTo[charId]++;

            // „Çª„É™„Éï„É™„Çπ„ÉàÂèñÂæó
            const messages = hintMessages[roomId][charId];

            // ÁØÑÂõ≤Â§ñ„Å™„ÇâÊúÄÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const idx = (flags.talkTo[charId] - 1) % messages.length;
            console.log(flags.talkTo[charId]);

            // Ë°®Á§∫
            updateMessage(messages[idx]);
        }

        // ‚ñº ÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ Êìç‰ΩúÁî®

        function openNotebook() {
            const m = document.getElementById('notebookModal');
            if (!m) return;
            m.style.display = 'flex';
            switchNotebookTab('notes'); // ÊØéÂõûnote„Åã„ÇâÈñã„Åè

            // ‚òÖ ÈÄ≤Êçó„Çø„Çπ„ÇØÔºàNOTESÔºâ„ÇÇÊõ¥Êñ∞„Åó„Å¶„Åä„Åè
            renderNotebookTasks();

            if (gameState.main?.flags?.notebookDeckHintAdded) {
                addDeckDoorHintNote();
            }

        }

        function switchNotebookTab(tabId) {
            const tabs = document.querySelectorAll('.notebook-tab');
            const contents = document.querySelectorAll('.notebook-tab-content');

            tabs.forEach(btn => {
                const t = btn.getAttribute('data-tab');
                btn.classList.toggle('active', t === tabId);
            });

            contents.forEach(c => c.classList.remove('active'));

            const active = document.getElementById('notebook-tab-' + tabId);
            if (active) active.classList.add('active');

            // ‚òÖ „Çø„Éñ„ÇíÈñã„ÅÑ„ÅüÁû¨Èñì„Å´‰∏≠Ë∫´„ÇíÊúÄÊñ∞Âåñ
            if (tabId === 'notes') renderNotebookTasks();
        }

        function closeNotebook() {
            const m = document.getElementById('notebookModal');
            if (!m) return;
            m.style.display = 'none';
        }



        function renderNotebookTasks() {
            const notesBody = document.getElementById('notebook-notes-body');
            if (!notesBody) return;

            const flags = (gameState && gameState.main && gameState.main.flags) ? gameState.main.flags : {};

            // Êó¢Â≠ò„ÅÆ„Äå„Çø„Çπ„ÇØÊû†„Äç„Å†„ÅëÂ∑Æ„ÅóÊõø„Åà„ÇãÔºà‰ªñ„ÅÆËøΩË®ò„É°„É¢„ÅåÂ∞ÜÊù•Â¢ó„Åà„Å¶„ÇÇÊ∂à„Åï„Å™„ÅÑÔºâ
            const old = document.getElementById('notebook-tasks');
            if (old) old.remove();

            const tasks = [];
            if (flags.readFrogMail) {
                tasks.push({ text: '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅÆÂõ∞„Çä„Åî„Å®„ÇíËß£Ê±∫„Åó„Çà„ÅÜ', done: !!flags.unlockSong });
            }
            if (flags.readRabitMail) {
                tasks.push({ text: '„É©„ÉìÈáé„Åï„Çì„ÅÆÂõ∞„Çä„Åî„Å®„ÇíËß£Ê±∫„Åó„Çà„ÅÜ', done: !!flags.unlockVegetables });
            }
            if (flags.readDogMail) {
                tasks.push({ text: '„ÉØ„É≥Ëä±„Åï„Çì„ÅÆÂõ∞„Çä„Åî„Å®„ÇíËß£Ê±∫„Åó„Çà„ÅÜ', done: !!flags.unlockRoute });
            }
            const allSolved = !!(flags.unlockSong && flags.unlockVegetables && flags.unlockRoute);
            if (allSolved) {
                tasks.push({ text: 'ÊùëÈï∑„Å´‰ºö„ÅÑ„Å´Ë°å„Åì„ÅÜ', done: !!flags.metMayorAfterAllSolved });

                if (flags.mayorQuestGiven) {
                    // „ÄåÂÆ∂„Å´Ë°å„Å£„Åü„Äç„Åß„ÅØ„Å™„Åè„ÄåË©±„Åó„Åã„Åë„Åü„Äç„ÅßÂÆå‰∫ÜÊâ±„ÅÑ
                    tasks.push({ text: '„Ç¶„ÉûÈáë„Åï„Çì„Å´‰ºö„ÅÑ„Å´Ë°å„Åì„ÅÜ', done: !!flags.talkToHorse });

                    // ÊúÄÂàù„Å´Ë©±„Åó„Åã„Åë„ÅüÊôÇ„Å´ËøΩÂä†„Åï„Çå„Çã„Çø„Çπ„ÇØ
                    if (flags.talkToHorse) {
                        tasks.push({ text: '„Éñ„É©„Ç∑„ÇíÊé¢„Åù„ÅÜ', done: !!flags.passBrush });
                        if (flags.passBrush) {
                            tasks.push({ text: 'ÊùëÈï∑„Å´Â†±Âëä„Å´Ë°å„Åì„ÅÜ', done: !!flags.reportedHorseToMayor });
                        }
                    }
                }
            }

            // „Ç≠„É£„Éó„Ç∑„Éß„É≥„ÇÇÈÄ≤ÊçóÁî®„Å´ÂØÑ„Åõ„ÇãÔºà„Çø„Çπ„ÇØ„Å™„Åó„Å™„ÇâÂÖÉ„ÅÆ„Éã„É•„Ç¢„É≥„Çπ„Å´Êàª„ÅôÔºâ
            const cap = document.querySelector('#notebook-tab-notes .notebook-cap');
            if (cap) {
                cap.textContent = (tasks.length > 0)
                    ? 'ÈÄ≤Êçó„É°„É¢„ÅåÊõ∏„ÅçË∂≥„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ'
                    : 'Á©∫ÁôΩ„ÅÆ„Éö„Éº„Ç∏„ÄÇ';
            }

            const wrap = document.createElement('div');
            wrap.id = 'notebook-tasks';
            wrap.className = 'notebook-note';

            if (tasks.length === 0) {
                wrap.innerHTML = `<p style="margin:0;">„Åæ„Å†„Çø„Çπ„ÇØ„ÅØ„Å™„ÅÑ„ÄÇ</p>`;
                notesBody.prepend(wrap);
                return;
            }

            const rows = tasks.map(t => {
                const mark = t.done ? '‚úÖ' : '‚¨ú';
                const style = t.done ? 'text-decoration:line-through;opacity:0.75;' : '';
                return `
      <li style="display:flex;gap:8px;align-items:flex-start;">
        <span style="width:1.2em;display:inline-block;">${mark}</span>
        <span style="${style}">${t.text}</span>
      </li>
    `;
            }).join('');

            wrap.innerHTML = `
    <div style="font-weight:700;margin:0 0 8px 0;">ÈÄ≤Êçó</div>
    <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;">
      ${rows}
    </ul>
  `;

            notesBody.prepend(wrap);
        }



        // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Åü„ÅÑÂ†¥ÂêàÔºà‰ªªÊÑèÔºâ
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('notebookModal');
            if (!modal) return;
            if (modal.style.display === 'flex' && e.target === modal) {
                closeNotebook();
            }
        });






        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showSongPuzzle() {
            const f = gameState.main.flags;
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;



            // „É≠„ÉÉ„ÇØ‰∏≠Ôºö4Ê°ÅÂÖ•Âäõ
            const modalContent = `
        <div style="text-align:center;">
            <h3 style="margin:4px 0 10px 0;font-size:1.1em;">„Çµ„Éì„ÅÆÊ≠åË©û„ÅåÊÄù„ÅÑÂá∫„Åõ„Å™„ÅÑ„Çì„Å†„Ç±„É≠‚Ä¶</h3>
            <img src="${IMAGES.modals.frogWorried}" alt="Âõ∞„Å£„Åü„Ç´„Ç®„É´" style="max-width: 400px; border-radius: 10px;">
            <input type="text"
                   id="songInput"
                   class="puzzle-input"
                   placeholder="Ëã±Â≠ó4ÊñáÂ≠ó„ÅßÊïô„Åà„Å¶„ÅÇ„Åí„Çà„ÅÜ"
                   style="max-width:220px;width:70%;">
            <div style="margin-top:8px;">
                <button onclick="checkSongPuzzle()" class="text-btn">OK</button>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;

            mc.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        // Á≠î„Åà„ÉÅ„Çß„ÉÉ„ÇØÔºàwarmÔºâ
        function checkSongPuzzle() {
            const inputEl = document.getElementById('songInput');
            if (!inputEl) return;

            const raw = inputEl.value.trim();

            // ÂÖ®ËßíÊï∞Â≠ó ‚Üí ÂçäËßíÊï∞Â≠ó„Å´Â§âÊèõ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch =>
                String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
            );
            const val = z2h(raw);

            if (val === 'warm') {
                gameState.main.flags.unlockSong = true;
                gameState.roomFrog.flags.backgroundState++;
                checkAllVillagersSolved();
                renderNotebookTasks();

                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                updateMessage('„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅØÊ≠åË©û„ÇíÊÄù„ÅÑÂá∫„Åó„Åü„ÄÇ');
                showModal(
                    '„Ç´„Ç®„É´Áî∞„Åï„Çì„ÅØÊ≠åË©û„ÇíÊÄù„ÅÑÂá∫„Åó„Åü',
                    `
                    <div style="margin-bottom: 12px;">
                        <img src="${IMAGES.modals.frogInspiration}" alt="ÊÄù„ÅÑÂá∫„Åô„Ç´„Ç®„É´Áî∞„Åï„Çì" style="max-width: 400px; border-radius: 10px;">
                    </div>
                    `,
                    [
                        {
                            text: 'Èñâ„Åò„Çã',
                            action: 'close',
                            cssClass: 'text-btn'
                        }
                    ]
                );

                if (typeof renderCanvasRoom === 'function') {
                    renderCanvasRoom();
                }
            } else {
                if (typeof playSE === 'function') playSE('se-error');
                markProgress('song_mistake_24');
                updateMessage('‚Ä¶ÈñìÈÅï„Å£„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†„ÄÇ');
            }
        }

        let gachaBusy = false;

        // „ÅäÂÆà„Çä„ÅÆ„Åä„Åø„Åè„ÅòÔºàÈñãÂ∞Å„ÅØ1Âõû„Å†„ÅëÔºâ
        function drawOmikujiFromOmamori() {
            // „Åô„Åß„Å´ÈñãÂ∞ÅÊ∏à„Åø
            if (gameState.main.flags.omikujiOpened) {
                const r = gameState.main.flags.omikujiResult;
                showModal(
                    '„Åä„Åø„Åè„ÅòÔºàÈñãÂ∞ÅÊ∏à„ÅøÔºâ',
                    `<div style="text-align:center;">
                         ${r ? `ÁµêÊûúÔºö<b style="font-size:28px;letter-spacing:0.12em;">${r}</b>` : '„ÇÇ„ÅÜÈñã„ÅÑ„Å¶„ÅÇ„Çã„ÄÇ'}
                      </div>`,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                return;
            }

            if (gachaBusy) return; // ÈÄ£Êâì„Éñ„É≠„ÉÉ„ÇØ„ÅØÂÖ±Áî®
            gachaBusy = true;

            const lucky = gameState.main.flags.luckyStatus || 0;

            // Âü∫Êú¨Á¢∫ÁéáÔºàÂêàË®à1.0Ôºâ
            let table = [
                { name: 'Â§ßÂêâ', p: 0.10 },
                { name: 'Âêâ', p: 0.26 },
                { name: 'Â∞èÂêâ', p: 0.28 },
                { name: 'Âá∂', p: 0.26 },
                { name: 'Â§ßÂá∂', p: 0.10 },
            ];

            // luckyStatusË£úÊ≠£ÔºöÊÇ™„ÅÑÊñπ„ÇíÂ∞ë„ÅóÂâä„Å£„Å¶ËâØ„ÅÑÊñπ„Å∏
            const boost = lucky >= 2 ? 0.08 : lucky === 1 ? 0.04 : 0;
            if (boost > 0) {
                const take = boost / 2;
                table[4].p = Math.max(0.02, table[4].p - take); // Â§ßÂá∂
                table[3].p = Math.max(0.10, table[3].p - take); // Âá∂
                table[0].p += take; // Â§ßÂêâ
                table[1].p += take; // Âêâ

                // Ê≠£Ë¶èÂåñ
                const sum = table.reduce((s, a) => s + a.p, 0);
                table = table.map(a => ({ ...a, p: a.p / sum }));
            }

            // ÊäΩÈÅ∏
            const r = Math.random();
            let acc = 0;
            let result = table[table.length - 1].name;
            for (const o of table) {
                acc += o.p;
                if (r < acc) { result = o.name; break; }
            }

            // 1ÂõûÈôê„Çä
            gameState.main.flags.omikujiOpened = true;
            gameState.main.flags.omikujiResult = result;

            // ÊºîÂá∫
            if (result === 'Â§ßÂêâ') {
                showKumaFairyFlash();
                playSE && playSE('se-kira');
            } else if (result === 'Â§ßÂá∂') {
                playSE && playSE('se-error');
            } else {
                playSE && playSE('se-click');
            }

            const msgMap = {
                'Â§ßÂêâ': '„Åç„Å£„Å®ËâØ„ÅÑ„Åì„Å®„Åå„ÅÇ„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ',
                'Âêâ': 'ËâØ„ÅÑÊµÅ„Çå„ÄÇÊ≤πÊñ≠„Åó„Å™„Åë„Çå„Å∞Âãù„Å°„Åß„Åô„ÄÇ',
                'Â∞èÂêâ': '„Åò„Çè„Åò„ÇèÊù•„Çã„Çø„Ç§„Éó„ÅÆÂπ∏ÈÅã„Åß„Åô„ÄÇ',
                'Âá∂': 'ÊÖéÈáç„Å´„ÄÇÂ§â„Å™„Éï„É©„Ç∞„ÅØÈÅø„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                'Â§ßÂá∂': '‰ªäÊó•„ÅØÂØù„Å¶Ëµ∑„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ'
            };

            setTimeout(() => {
                showModal(
                    '„Åä„Åø„Åè„Åò',
                    `<div style="text-align:center;">
                         <div style="font-size:32px;font-weight:bold;letter-spacing:0.14em;margin:6px 0 10px;">${result}</div>
                         <div style="font-size:14px;opacity:0.9;">${msgMap[result] || ''}</div>
                      </div>`,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
            }, 350);

            setTimeout(() => {
                gachaBusy = false;
            }, 1200);
        }

        function showKumaFairyFlash() {
            const el = document.createElement('div');
            el.id = 'kuma-fairy-flash';
            el.innerHTML = `
    <img src=${IMAGES.modals.kumaFairy}
         style="
           width:240px;
           image-rendering: pixelated;
         ">
  `;

            Object.assign(el.style, {
                position: 'fixed',
                left: '50%',
                top: '50%',
                transform: 'translate(-50%, -50%) scale(0.8)',
                opacity: '0.8',
                zIndex: '9999',
                transition: 'all 0.3s ease'
            });

            document.body.appendChild(el);

            // „Éï„Çß„Éº„Éâ„Ç§„É≥
            requestAnimationFrame(() => {
                el.style.opacity = '1';
                el.style.transform = 'translate(-50%, -50%) scale(1)';
            });

            // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translate(-50%, -50%) scale(1.1)';
            }, 900);

            // ÂÆåÂÖ®ÂâäÈô§
            setTimeout(() => {
                el.remove();
            }, 1300);
        }

        function lockUI(ms = 2600, opacity = 0.55) {
            // Êó¢„Å´„ÅÇ„Çå„Å∞‰Ωú„ÇäÁõ¥„Åï„Å™„ÅÑ
            if (document.getElementById('ui-lock')) return;
            const prevCursor = document.body.style.cursor;
            document.body.style.cursor = 'url(images/24/cursor_gacha.png) 16 16, wait';

            setTimeout(() => {
                document.body.style.cursor = prevCursor;
                lock.remove();
            }, ms);

            const lock = document.createElement('div');
            lock.id = 'ui-lock';
            Object.assign(lock.style, {
                position: 'fixed',
                left: '0',
                top: '0',
                width: '100vw',
                height: '100vh',
                background: `rgba(0,0,0,${opacity})`,
                zIndex: '100000',          // ‰Ωï„Çà„ÇäÂâçÔºà„É¢„Éº„ÉÄ„É´„Çà„ÇäÂâçÔºâ„Å´Âá∫„Åô
                pointerEvents: 'auto',
                cursor: `url(${IMAGES.items.gachaCursor}) 16 16, wait`
            });

            document.body.appendChild(lock);

            setTimeout(() => {
                lock.remove();
            }, ms);
        }




        let wipeStep = 0;

        function showBearDonutsBadEnd() {
            try { screenFlash && screenFlash('black'); } catch (e) { }
            try { pauseBGM && pauseBGM(); } catch (e) { }
            try { playSE && playSE('se-fire'); } catch (e) { }

            try { markProgress && markProgress('bad_bear_donuts_24'); } catch (e) { }

            showModal(
                '„ÄêBAD END„Äë',
                `
      <div style="text-align:center;">
        <img src="${IMAGES.modals.bearBad}" alt="„ÇØ„Éû„ÅåËø´„Çä„Åè„Çã" style="max-width:420px;width:100%;display:block;margin:0 auto 14px;border-radius:12px;">
        <p style="margin:0;">ÁõÆ„ÅÆÂâç„ÅßÈ£ü„Åπ„Çã„Å®„ÅØ‚Ä¶„Éú„ÇØ„Å∏„ÅÆÂ´å„Åå„Çâ„Åõ„Å™„ÅÆ‚Ä¶Ôºü</p>
      </div>
    `,
                [{ text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart' }]
            );
        }



        // PC„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showPCPuzzle() {

            let msg = '';
            const modalContent = `
            <div class="login-container">
                <div class="login-form">
                    <h3 class="login-title">PC„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å†</h3>
                    <p>${msg}</p>
                    <label>„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="text" class="puzzle-input" id="pcInput" placeholder="„Å≤„Çâ„Åå„Å™ or Ëã±Â≠ó">
                    <br>
                    <button class="login-btn" onclick="checkPcPuzzle()">OK</button>
                    <button class="cancel-btn" onclick="closeModal()">Èñâ„Åò„Çã</button>
                </div>
            </div>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // PC„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkPcPuzzle() {
            const v = document.getElementById('pcInput').value.trim();
            // ÂÖ®ËßíÂØæÁ≠ñ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === '„ÇÇ„ÇÑ„Åó' || val === 'moyashi') {
                if (gameState.main.flags.unlockPc) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('„Åô„Åß„Å´„É≠„ÉÉ„ÇØ„ÅØËß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã');
                    return;
                }
                closeModal();
                gameState.main.flags.unlockPc = true;

                markProgress('pc_normal_unlock_24');
                gameState.roomCat.flags.backgroundState++;

                window._nextModal = {
                    title: '„Åä„Åä„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ„Åï„Å£„Åù„Åè„Ç´„Éã„Çí„Éù„ÉÅ„Å£„Åü„ÅûÔºÅ<br>„ÇìÔºü„É°„Éº„É´„ÅåÊù•„Å¶„ÅÑ„Çã„Çà„ÅÜ„Åò„ÇÉ„Å™',
                    content: `
<div class="modal-anim fast">
  <img src="${IMAGES.modals.catSolved1}">
  <img src="${IMAGES.modals.catSolved2}">
</div>
                                `,
                    buttons: [
                        { text: 'Èñâ„Åò„Çã', action: 'close' }
                    ],
                };

                showModal(
                    '„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                updateMessage('„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åü„ÄÇ');
                playSE('se-clear');
                renderCanvasRoom();

            } else {
                playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }

        // ===============================
        // „É©„ÉìÈáé„Åï„ÇìÔºöÈáéËèúÁÆ±„É≠„ÉÉ„ÇØÔºàÂ∑¶Âè≥„Éú„Çø„É≥‚ÜíOKÔºâ
        // Âè≥,Â∑¶,Âè≥,Â∑¶,Â∑¶ „ÅÆÈ†Ü„ÅßOK ‚Üí unlockVegetables=true
        // ===============================

        // 1) getDefaultGameState() „ÅÆ main.flags „Å´„Åì„Çå„ÇíËøΩÂä†ÔºàÂàùÊúüÂÄ§Ôºâ
        /*
        main: {
          flags: {
            ...
            unlockVegetables: false, // ‚Üê„Åì„Çå„ÇíËøΩÂä†
          }
        }
        */

        // 2) „É©„ÉìÈáé„Åï„Çì„ÇØ„É™„ÉÉ„ÇØ„ÅßÂëº„Å∂„É¢„Éº„ÉÄ„É´Êú¨‰Ωì
        const RABIT_VEG_ANSWER = ['R', 'L', 'R', 'L', 'L'];
        let rabitVegInput = [];

        function openRabitVegetableLockModal() {
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            // Êó¢„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„ÄÅ„Å≤„Çâ„ÇÅ„Åç„É¢„Éº„ÉÄ„É´„Å†„ÅëÂá∫„Åô
            if (gameState.main.flags.unlockVegetables) {
                showModal(
                    '',
                    `
      <div style="text-align:center;">
        <div style="margin-bottom:12px;">
          <!--<img src="${IMAGES.modals.rabitInspiration}" alt="„Å≤„Çâ„ÇÅ„Åè„É©„ÉìÈáé„Åï„Çì"
               style="max-width:400px;width:100%;border-radius:10px;display:block;margin:0 auto;">-->
        </div>
        <p style="margin:0;">ÁÆ±„ÅÆ„É≠„ÉÉ„ÇØ„ÅØÈñã„ÅÑ„Å¶„ÅÑ„Çã</p>
      </div>
      `,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                return;
            }

            rabitVegInput = [];

            mc.innerHTML = `
    <div style="text-align:center;">
      <div style="margin-bottom:12px;">
        <!--<img src="${IMAGES.modals.rabitWorried}" alt="Âõ∞„Å£„Å¶„ÅÑ„Çã„É©„ÉìÈáé„Åï„Çì"
             style="max-width:400px;width:100%;border-radius:10px;display:block;margin:0 auto;">-->
      </div>

      <p style="margin:0 0 14px 0;">ÈáéËèúÁÆ±„ÅÆ„É≠„ÉÉ„ÇØ„Å†</p>

      <div style="display:flex;gap:16px;justify-content:center;align-items:center;margin-bottom:14px;">
        <button id="rabitVegBtnLeft"  aria-label="Â∑¶"  style="cursor:pointer;">
          ‚Üê
        </button>
        <button id="rabitVegBtnRight" aria-label="Âè≥" style="cursor:pointer;">
          ‚Üí
        </button>
      </div>

      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="rabitVegOkBtn" class="text-btn">OK</button>
        <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
      </div>
    </div>
  `;
            modal.style.display = 'flex';

            const leftBtn = document.getElementById('rabitVegBtnLeft');
            const rightBtn = document.getElementById('rabitVegBtnRight');
            const okBtn = document.getElementById('rabitVegOkBtn');

            const push = (v) => {
                playSE('se-click');
                rabitVegInput.push(v);
                if (rabitVegInput.length > RABIT_VEG_ANSWER.length) rabitVegInput.shift();
            };

            const pressFx = (btnEl) => {
                // Êó¢Â≠òCSS„Å´Âêà„Çè„Åõ„Å¶‰∏ÄÁû¨ pressed „Å£„ÅΩ„ÅèË¶ã„Åõ„Çã
                btnEl.classList.add('pressed');
                setTimeout(() => btnEl.classList.remove('pressed'), 120);
            };

            leftBtn.onclick = () => { pressFx(leftBtn); push('L'); };
            rightBtn.onclick = () => { pressFx(rightBtn); push('R'); };

            okBtn.onclick = () => {
                const correct =
                    rabitVegInput.length === RABIT_VEG_ANSWER.length &&
                    rabitVegInput.every((v, i) => v === RABIT_VEG_ANSWER[i]);

                if (!correct) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ');
                    return;
                }

                // Ê≠£Ëß£ ‚Üí „Ç¢„É≥„É≠„ÉÉ„ÇØ
                gameState.main.flags.unlockVegetables = true;
                gameState.roomRabit.flags.backgroundState++;
                renderNotebookTasks();
                renderCanvasRoom();
                checkAllVillagersSolved();

                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                showModal(
                    '',
                    `
      <div style="text-align:center;">
        <div style="margin-bottom:12px;">
          <img src="${IMAGES.modals.rabitInspiration}" alt="„Å≤„Çâ„ÇÅ„Åè„É©„ÉìÈáé„Åï„Çì"
               style="max-width:400px;width:100%;border-radius:10px;display:block;margin:0 auto;">
        </div>
        <p style="margin:0;">Èñã„Åë„Å¶„Åè„Çå„Åü„ÅÆ„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ</p>
      </div>
      `,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );

                updateMessage('ÈáéËèúÁÆ±„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü„ÄÇ');

                if (typeof renderCanvasRoom === 'function') renderCanvasRoom();
            };
        }

        // ===============================
        // „ÉØ„É≥Ëä±„Åï„ÇìÔºöÈÅìÈ†Ü„Éë„Ç∫„É´ÔºàÊù±Ë•øÂçóÂåó‚ÜíOKÔºâ
        // Âåó,Ë•ø,Âçó „ÅÆÈ†Ü„ÅßOK ‚Üí unlockRoute=true / roomDog.backgroundState++
        // ===============================
        const DOG_ROUTE_ANSWER = ['N', 'W', 'S'];
        let dogRouteInput = [];

        function openDogRouteAskModal() {
            // Êó¢„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„ÄÅÂÆâÂøÉ„É¢„Éº„ÉÄ„É´„ÅßÁµÇ„Çè„Çä
            if (gameState.main.flags.unlockRoute) {
                showModal(
                    '',
                    `
      <div style="text-align:center;">
        <div style="margin-bottom:12px;">
          <img src="${IMAGES.modals.dogInspiration}" alt="ÂÆâÂøÉ„Åó„Åü„ÉØ„É≥Ëä±„Åï„Çì"
               style="max-width:400px;width:100%;border-radius:10px;display:block;margin:0 auto;">
        </div>
        <p style="margin:0;">„ÇÇ„ÅÜÈÅìÈ†Ü„ÅØ‰ºù„Åà„Åü„ÉØ„É≥ÔºÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„ÉØ„É≥ÔºÅ</p>
      </div>
      `,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                return;
            }

            showModal(
                '',
                '<div style="text-align:center;">ÈÅìÈ†Ü„ÇíÊïô„Åà„Å¶„ÅÇ„Åí„Åæ„Åô„ÅãÔºü</div>',
                [
                    {
                        text: '„ÅØ„ÅÑ',
                        action: () => {
                            closeModal();
                            openDogRouteLockModal();
                        }
                    },
                    { text: '„ÅÑ„ÅÑ„Åà', action: 'close' }
                ]
            );
        }

        function openDogRouteLockModal() {
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            // Êó¢„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„ÄÅÂÆâÂøÉ„É¢„Éº„ÉÄ„É´„Å†„ÅëÂá∫„Åô
            if (gameState.main.flags.unlockRoute) {
                showModal(
                    '',
                    `
      <div style="text-align:center;">
        <div style="margin-bottom:12px;">
          <img src="${IMAGES.modals.dogInspiration}" alt="ÂÆâÂøÉ„Åó„Åü„ÉØ„É≥Ëä±„Åï„Çì"
               style="max-width:400px;width:100%;border-radius:10px;display:block;margin:0 auto;">
        </div>
        <p style="margin:0;">„ÇÇ„ÅÜÈÅìÈ†Ü„ÅØ‰ºù„Åà„Åü„ÉØ„É≥ÔºÅ</p>
      </div>
      `,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                return;
            }

            dogRouteInput = [];

            mc.innerHTML = `
    <div style="text-align:center;">
      <p style="margin:0 0 14px 0;">Êùë„Åæ„Åß„ÅÆÈÅìÈ†Ü„Çí‰ºù„Åà„Çà„ÅÜ</p>

      <div style="display:flex;flex-direction:column;gap:10px;align-items:center;margin-bottom:14px;">
        <button id="dogRouteBtnN" class="text-btn" style="width:100px;">Âåó</button>
        <div style="display:flex;gap:10px;justify-content:center;">
          <button id="dogRouteBtnW" class="text-btn" style="width:100px;">Ë•ø</button>
          <button id="dogRouteBtnE" class="text-btn" style="width:100px;">Êù±</button>
        </div>
        <button id="dogRouteBtnS" class="text-btn" style="width:100px;">Âçó</button>
      </div>

      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="dogRouteOkBtn" class="text-btn">OK</button>
        <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
      </div>
    </div>
  `;
            modal.style.display = 'flex';

            const nBtn = document.getElementById('dogRouteBtnN');
            const eBtn = document.getElementById('dogRouteBtnE');
            const sBtn = document.getElementById('dogRouteBtnS');
            const wBtn = document.getElementById('dogRouteBtnW');
            const okBtn = document.getElementById('dogRouteOkBtn');

            const push = (v) => {
                playSE('se-click');
                dogRouteInput.push(v);
                if (dogRouteInput.length > DOG_ROUTE_ANSWER.length) dogRouteInput.shift();
            };

            const pressFx = (btnEl) => {
                btnEl.classList.add('pressed');
                setTimeout(() => btnEl.classList.remove('pressed'), 120);
            };

            nBtn.onclick = () => { pressFx(nBtn); push('N'); };
            eBtn.onclick = () => { pressFx(eBtn); push('E'); };
            sBtn.onclick = () => { pressFx(sBtn); push('S'); };
            wBtn.onclick = () => { pressFx(wBtn); push('W'); };

            okBtn.onclick = () => {
                const correct =
                    dogRouteInput.length === DOG_ROUTE_ANSWER.length &&
                    dogRouteInput.every((v, i) => v === DOG_ROUTE_ANSWER[i]);

                if (!correct) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ');
                    return;
                }

                // Ê≠£Ëß£ ‚Üí „Ç¢„É≥„É≠„ÉÉ„ÇØ
                gameState.main.flags.unlockRoute = true;

                // ÊåáÁ§∫„ÅÆ roomDog.backgroundState++ „Å®„ÄÅÊó¢Â≠òË°®Á§∫Áî® flags „ÇíÂêåÊúü
                gameState.roomDog.flags.backgroundState++;
                gameState.roomDog.backgroundState = gameState.roomDog.flags.backgroundState;

                renderNotebookTasks();
                renderCanvasRoom();
                checkAllVillagersSolved();

                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                showModal(
                    '',
                    `
      <div style="text-align:center;">
        <div style="margin-bottom:12px;">
          <img src="${IMAGES.modals.dogInspiration}" alt="ÂÆâÂøÉ„Åó„Åü„ÉØ„É≥Ëä±„Åï„Çì"
               style="max-width:400px;width:100%;border-radius:10px;display:block;margin:0 auto;">
        </div>
        <p style="margin:0;">„Å™„Çã„Åª„Å©„ÄÅÂçµÊ©ã„Å´„ÅÑ„Åü„Çì„Å†„ÉØ„É≥ÔºÅ„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ</p>
      </div>
      `,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );

                updateMessage('ÈÅìÈ†Ü„ÇíÊïô„Åà„Åü„ÄÇ');

                if (typeof renderCanvasRoom === 'function') renderCanvasRoom();
            };
        }

        // ==== „Ç¶„ÉûÈáë„Åï„Çì„ÅÆ„É≠„ÉÉ„ÇØÁÆ±Ôºö „Éë„Ç∫„É´ ====

        function showHorseBoxPuzzle() {
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø
            if (gameState.main.flags.unlockBox) {
                mc.innerHTML = `
      <div style="text-align:center;">
        <p>ÁÆ±„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>
        <div style="margin-top:8px;">
          <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
        </div>
      </div>
    `;
                modal.style.display = 'flex';
                return;
            }

            mc.innerHTML = `
    <div style="text-align:center;">
      <p style="margin-bottom:8px;">„É≠„ÉÉ„ÇØ„Åï„Çå„ÅüÁÆ±„Å†„ÄÇ</p>
      <input type="text"
             id="horseBoxInput"
             class="puzzle-input"
             placeholder="Êï∞Â≠ó4ÊñáÂ≠ó"
             style="max-width:220px;width:70%;">
      <div style="margin-top:8px;">
        <button onclick="checkHorseBoxPuzzle()" class="text-btn">OK</button>
        <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
      </div>
    </div>
  `;
            modal.style.display = 'flex';
        }

        function checkHorseBoxPuzzle() {
            const inputEl = document.getElementById('horseBoxInput');
            if (!inputEl) { closeModal(); return; }

            const raw = inputEl.value.trim();

            // ÂÖ®ËßíÂØæÁ≠ñÔºöËã±Â≠óÔºã[] „ÇíÊúÄ‰ΩéÈôêÂê∏Âèé
            const z2hAlpha = s => s.replace(/[Ôº°-Ôº∫ÔΩÅ-ÔΩö]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const z2hBracket = s => s.replace(/[ÔºªÔºΩ]/g, ch => (ch === 'Ôºª' ? '[' : ']'));

            const val = z2hBracket(z2hAlpha(raw)).toLowerCase();

            if (val === '1536') {
                if (gameState.main.flags.unlockBox) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('ÁÆ±„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                    return;
                }

                gameState.main.flags.unlockBox = true;

                // Âøµ„ÅÆ„Åü„ÇÅÔºà„Çª„Éº„Éñ‰∫íÊèõ„Éª‰∫ãÊïÖÈò≤Ê≠¢Ôºâ
                gameState.roomHorse = gameState.roomHorse || { flags: { backgroundState: 0 } };
                gameState.roomHorse.flags = gameState.roomHorse.flags || { backgroundState: 0 };

                // gameState.roomHorse.flags.backgroundState++;
                // renderCanvasRoom();

                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                showModal(
                    'ÁÆ±„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );

                updateMessage('ÁÆ±„ÅÆ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü„ÄÇ');
                renderCanvasRoom();
            } else {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }

        // ==== „Ç¶„ÉûÈáë„Åï„Çì„ÅÆÂºï„ÅçÂá∫„ÅóÔºöË®òÂè∑„Ç´„Ç¶„É≥„Çø„Éë„Ç∫„É´ ====
        // ‚òÖ,‚ô™,‚ô• „Çí„Åù„Çå„Åû„Çå 5,3,2 „Å´Âêà„Çè„Åõ„Å¶OK„Åß„Ç¢„É≥„É≠„ÉÉ„ÇØ
        function showHorseDrawerPuzzle() {
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            gameState.main = gameState.main || { flags: {} };
            gameState.main.flags = gameState.main.flags || {};
            const f = gameState.main.flags;

            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø
            if (f.unlockDrawerHorse) {
                mc.innerHTML = `
          <div style="text-align:center;">
            <p>Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>
            <div style="margin-top:8px;">
              <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
          </div>
        `;
                modal.style.display = 'flex';
                return;
            }

            let star = 0, note = 0, heart = 0;

            mc.innerHTML = `
      <div style="text-align:center;">
        <p style="margin:0 0 10px;">Âºï„ÅçÂá∫„Åó„ÅØ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>

        <div id="horseDrawerDisplay"
             style="min-height:120px;border:2px solid #d4af37;border-radius:12px;
                    padding:10px;margin:0 auto 12px;max-width:420px;
                    background:rgba(0,0,0,0.25);">
          <div id="horseDrawerRowStar"  style="min-height:30px;margin:6px 0;"></div>
          <div id="horseDrawerRowNote"  style="min-height:30px;margin:6px 0;"></div>
          <div id="horseDrawerRowHeart" style="min-height:30px;margin:6px 0;"></div>
        </div>

        <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-bottom:10px;">
          <button id="horseDrawerBtnStar"  class="text-btn" style="min-width:90px;font-size:2rem;">‚òÖ</button>
          <button id="horseDrawerBtnNote"  class="text-btn" style="min-width:90px;font-size:2rem;">‚ô™</button>
          <button id="horseDrawerBtnHeart" class="text-btn" style="min-width:90px;font-size:2rem;">‚ô•</button>
        </div>

        <div style="display:flex;gap:12px;justify-content:center;">
          <button id="horseDrawerOkBtn" class="text-btn">OK</button>
          <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
        </div>

        <!--<p style="margin:10px 0 0;opacity:.8;font-size:.9em;">
          ‚ÄªÊäº„Åô„Åü„Å≥„Å´ 0‚Üí1‚Üí‚Ä¶‚Üí9‚Üí0 „Å®„É´„Éº„Éó„Åô„Çã
        </p>-->
      </div>
    `;
            modal.style.display = 'flex';

            const rowStar = document.getElementById('horseDrawerRowStar');
            const rowNote = document.getElementById('horseDrawerRowNote');
            const rowHeart = document.getElementById('horseDrawerRowHeart');

            const btnStar = document.getElementById('horseDrawerBtnStar');
            const btnNote = document.getElementById('horseDrawerBtnNote');
            const btnHeart = document.getElementById('horseDrawerBtnHeart');
            const okBtn = document.getElementById('horseDrawerOkBtn');

            const pressFx = (btnEl) => {
                if (!btnEl) return;
                btnEl.classList.add('pressed');
                setTimeout(() => btnEl.classList.remove('pressed'), 120);
            };

            const draw = (el, symbol, n) => {
                if (!el) return;
                const s = symbol.repeat(n);
                el.innerHTML = `<span style="color:#ffd700;font-size:30px;letter-spacing:2px;">${s}</span>`;
            };

            const render = () => {
                draw(rowStar, '‚òÖ', star);
                draw(rowNote, '‚ô™', note);
                draw(rowHeart, '‚ô•', heart);
            };

            const click = (kind) => {
                if (typeof playSE === 'function') playSE('se-click');
                if (kind === 'star') star = (star + 1) % 10;
                if (kind === 'note') note = (note + 1) % 10;
                if (kind === 'heart') heart = (heart + 1) % 10;
                render();
            };

            render();

            if (btnStar) btnStar.onclick = () => { pressFx(btnStar); click('star'); };
            if (btnNote) btnNote.onclick = () => { pressFx(btnNote); click('note'); };
            if (btnHeart) btnHeart.onclick = () => { pressFx(btnHeart); click('heart'); };

            if (okBtn) okBtn.onclick = () => {
                const correct = (star === 5 && note === 3 && heart === 2);

                if (!correct) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ');
                    return;
                }

                f.unlockDrawerHorse = true;

                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                showModal(
                    'Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );

                updateMessage('Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü„ÄÇ');
                if (typeof renderCanvasRoom === 'function') renderCanvasRoom();
            };
        }


        // ==== „Å≠„ÅìÂ±±ÊùëÈï∑„ÅÆÂè≥„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÔºöÂÖ•Âäõ„Éë„Ç∫„É´ ====
        // ÂÖ•Âäõ‚Üíhoneyed „Å™„Çâ unlockCabinet=true
        // ÂÖ•Âäõ‚Üí„Äå„Åü„Åã„Å≠„ÅÆ„ÅØ„Å™„Äçor„ÄåÈ´òÂ∂∫„ÅÆËä±„Äç„Å™„Çâ unlockCabinet=true & unlockCabinetExtra=true
        function showCatCabinetPuzzle() {
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            gameState.main = gameState.main || { flags: {} };
            gameState.main.flags = gameState.main.flags || {};
            const f = gameState.main.flags;

            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø
            if (f.unlockCabinet || f.unlockCabibinet) {
                mc.innerHTML = `
  <div style="text-align:center;">
    <p>„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>
    <div style="margin-top:8px;">
      <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
    </div>
  </div>
`;
                modal.style.display = 'flex';
                return;
            }

            mc.innerHTML = `
<div style="text-align:center;">
  <p style="margin-bottom:8px;">Âè≥„ÅÆ„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅØ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>
  <input type="text"
         id="catCabinetInput"
         class="puzzle-input"
         placeholder="„Å≤„Çâ„Åå„Å™ or Ëã±Â≠ó"
         style="max-width:260px;width:78%;">
  <div style="margin-top:8px;">
    <button onclick="checkCatCabinetPuzzle()" class="text-btn">OK</button>
    <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
  </div>
</div>
`;
            modal.style.display = 'flex';
        }

        function checkCatCabinetPuzzle() {
            const inputEl = document.getElementById('catCabinetInput');
            if (!inputEl) { closeModal(); return; }

            const raw = (inputEl.value || '').trim();

            if (!raw) {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶‰Ωï„ÅãÂÖ•Âäõ„Åó„Çà„ÅÜ');
                return;
            }

            gameState.main = gameState.main || { flags: {} };
            gameState.main.flags = gameState.main.flags || {};
            const f = gameState.main.flags;

            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø
            if (f.unlockCabinet || f.unlockCabibinet) {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            // Ê≠£Ë¶èÂåñÔºöÂÖ®ËßíËã±Êï∞Â≠ó‚ÜíÂçäËßí„ÄÅÁ©∫ÁôΩÈô§Âéª„ÄÅlower
            const z2hAscii = s => s.replace(/[Ôºê-ÔºôÔº°-Ôº∫ÔΩÅ-ÔΩö]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const rawNoSpace = raw.replace(/[\s\u3000]+/g, '');
            const val = z2hAscii(rawNoSpace).toLowerCase();

            const isHoneyed = (val === 'honeyed');
            const isTakane = (rawNoSpace === '„Åü„Åã„Å≠„ÅÆ„ÅØ„Å™' || rawNoSpace === 'È´òÂ∂∫„ÅÆËä±');

            if (!isHoneyed && !isTakane) {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ');
                return;
            }

            // Ê≠£Ëß£Ôºö„Ç¢„É≥„É≠„ÉÉ„ÇØ
            f.unlockCabinet = true;      // Ê≠£Âºè

            if (isTakane) {
                f.unlockCabinetExtra = true;
            }

            if (typeof playSE === 'function') playSE('se-clear');

            closeModal();
            showModal(
                '„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                '',
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );

            updateMessage('„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü„ÄÇ');
            if (typeof renderCanvasRoom === 'function') renderCanvasRoom();
        }






        function handleDoor() {
            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÈÅ∑ÁßªÂÖ±ÈÄö„Éè„É≥„Éâ„É©
            const goEnding = () => {
                if (gameState.flags.trueEndUnlocked) {
                    gameState.endings.true = true;
                    travelWithStepsTrueEnd();
                } else if (gameState.main.flags.blockManStatus >= 2 && gameState.main.flags.blockManStatus < 5) {
                    changeRoom('endWorse');
                } else if (hasItem('hat')) {
                    showModal(
                        '„Åì„ÅÆÂ∏ΩÂ≠ê„ÇíÊåÅ„Å£„Å¶Â∏∞„Çä„Åü„Åè„Å™„ÅÑ„Å™',
                        `<img src="${IMAGES.items.hat}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    return;
                } else if (gameState.main.flags.isNight) {
                    updateMessage('Â§úÈÅì„ÅØÂç±Èô∫„Å™„ÅÆ„Åß„ÇÑ„ÇÅ„Å¶„Åä„Åì„ÅÜ');
                    return;
                } else {
                    updateMessage('„Åæ„Å†Èñã„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');
                    return;
                }
            };

            goEnding();
        }

        function showObj(flagKey, title, imgSrc, msg, altImgSrc) {
            const f = gameState.main.flags;
            if (flagKey) f[flagKey] = true;

            const imgId = 'objImg_' + Date.now(); // 1„É¢„Éº„ÉÄ„É´1ID„ÅßË°ùÁ™ÅÂõûÈÅø
            let isAlt = false;

            const content =
                `<img id="${imgId}" src="${imgSrc}"
          style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`;

            const buttons = [];

            // altImgSrc „Åå„ÅÇ„Çã„Å®„Åç„Å†„Åë„ÄåË®ÄË™ûÂàáÊõø„Äç„Éú„Çø„É≥„ÇíÂá∫„Åô
            if (altImgSrc) {
                buttons.push({
                    text: 'üåê En',
                    action: () => {
                        const el = document.getElementById(imgId);
                        if (!el) return;
                        isAlt = !isAlt;
                        el.src = isAlt ? altImgSrc : imgSrc;
                        updateMessage(isAlt ? 'Ëã±Ë™ûÁâà„ÇíË°®Á§∫‰∏≠' : msg);
                    }
                });
            }

            buttons.push({ text: 'Èñâ„Åò„Çã', action: 'close' });

            showModal(title, content, buttons);
            updateMessage(msg);
        }



        // „Ç¢„Ç§„ÉÜ„É†ÁÆ°ÁêÜ
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 8) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            } else {
                updateMessage('„Ç¢„Ç§„ÉÜ„É†Ê¨Ñ„Åå„ÅÑ„Å£„Å±„ÅÑ„Å†„ÄÇ„Å©„Åì„Åã„ÅßÊ∏õ„Çâ„Åó„Å¶„Åì„Çà„ÅÜ');
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }

        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            const clickedItem = gameState.inventory[slotIndex];

            if (!clickedItem) return;

            // ‚òÖ„Åô„Åß„Å´ÈÅ∏Êäû‰∏≠„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÇíÂÜç„ÇØ„É™„ÉÉ„ÇØ ‚Üí Ëß£Èô§
            if (gameState.selectedItemSlot === slotIndex) {
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateMessage('„Ç¢„Ç§„ÉÜ„É†ÈÅ∏Êäû„ÇíËß£Èô§„Åó„Åæ„Åó„Åü„ÄÇ');
                updateInventoryDisplay();
                return;
            }

            // ‚òÖÈÄöÂ∏∏„ÅÆÈÅ∏Êäû
            gameState.selectedItem = clickedItem;
            gameState.selectedItemSlot = slotIndex;
            updateMessage(`${getItemName(clickedItem)}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ‰ΩøÁî®„Åó„Åü„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            updateInventoryDisplay();
        }

        function getItemName(itemId) {
            const names = {
                coin: '„ÇØ„Éû„Ç≥„Ç§„É≥',
                bear: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                pruners: 'Ââ™ÂÆö„ÅØ„Åï„Åø',
                recipe: '„ÇØ„Éû„Éù„É≥„ÅÆ„É¨„Ç∑„Éî',
                bearCitrus: '„ÇØ„Éû„ÅÆÂÆü',
                donuts: '„Éè„Éã„Éº„Éâ„Éº„Éä„ÉÑ',
                brush: '„Éñ„É©„Ç∑',
                kumapon: '„ÇØ„Éû„Éù„É≥ÈÖ¢',
                seasoning: 'Ë™øÂë≥Êñô„Çª„ÉÉ„Éà',
                honey: '‰ºùË™¨„ÅÆ‰∏ÉËâ≤„Éè„ÉÅ„Éü„ÉÑ',
                omamori: '„ÅäÂÆà„ÇäÔºà„Åä„Åø„Åè„Åò‰ªò„ÅçÔºâ'







            };
            return names[itemId] || itemId;
        }


        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';

            const isMobile = window.matchMedia('(max-width: 600px)').matches;

            if (isMobile) {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = '„Éä„Éì';
                btn.onclick = () => openNavModal();
                navDiv.appendChild(btn);
                return;
            }

            // PC„ÅØÂæìÊù•ÈÄö„ÇäÔºà„É´„Éº„É†„Éú„Çø„É≥‰∏¶„Åπ„ÇãÔºâ
            gameState.openRooms.forEach(roomId => {
                const b = document.createElement('button');
                b.className = 'nav-btn';
                b.textContent = rooms[roomId].name;
                b.onclick = () => changeRoom(roomId);
                navDiv.appendChild(b);
            });
        }

        function openNavModal() {
            const cur = gameState.currentRoom;
            const listHtml = `
    <div style="display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto;">
      ${gameState.openRooms.map(roomId => {
                const isHere = roomId === cur;
                return `
          <button class="nav-btn" style="width:100%; opacity:${isHere ? 0.5 : 1};"
            ${isHere ? 'disabled' : ''}
            onclick="(function(){ closeModal(); changeRoom('${roomId}'); })()">
            ${rooms[roomId].name}${isHere ? 'Ôºà„Åì„ÅìÔºâ' : ''}
          </button>
        `;
            }).join('')}
    </div>
  `;
            showModal('ÁßªÂãïÂÖà', listHtml, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
        }

        function addNaviItem(room) {
            if (!gameState.openRooms.includes(room)) {
                gameState.openRooms.push(room);
                return true;
            }
            return false;
        }

        // „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫Êõ¥Êñ∞
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function () {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                    const magBtn = document.createElement('div');
                    magBtn.className = 'magnifier-btn';
                    magBtn.title = 'Êã°Â§ßË°®Á§∫';
                    magBtn.innerHTML = '<img src="images/magnifier.png" alt="Êã°Â§ß">';
                    magBtn.onclick = (e) => {
                        e.stopPropagation();

                        const itemId = gameState.inventory[index];

                        // „Éá„Éï„Ç©„ÅÆ‰∏≠Ë∫´
                        let content = `<img src="${img.src}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`;
                        let buttons = [{ text: 'Èñâ„Åò„Çã', action: 'close' }];

                        // „Éè„Éã„Éº„Éâ„Éº„Éä„ÉÑÔºöÈ£ü„Åπ„ÇãÔºàÂ∫ÉÂ†¥„ÅßÈ£ü„Åπ„Çã„Å®‚Ä¶Ôºâ
                        if (itemId === 'donuts') {
                            buttons = [
                                {
                                    text: 'È£ü„Åπ„Çã',
                                    action: () => {
                                        closeModal();

                                        // Â∫ÉÂ†¥„ÅßÈ£ü„Åπ„ÇãÔºù„ÇØ„Éû„ÅåËø´„Çä„Åè„ÇãBAD END
                                        if (gameState.currentRoom === 'square' && gameState.main.flags.bearAppear) {
                                            showBearDonutsBadEnd();
                                            return;
                                        }

                                        // „Åù„Çå‰ª•Â§ñÔºùÊôÆÈÄö„Å´È£ü„Åπ„Çã
                                        playSE && playSE('se-bear-eat');
                                        showToast('ÁæéÂë≥„Åó„Åã„Å£„Åü');
                                        removeItem('donuts');
                                        return;
                                    }
                                },
                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                            ];
                        }

                        // „ÅäÂÆà„ÇäÔºö„Åä„Åø„Åè„Åò„ÇíÈñã„ÅèÔºà1Âõû„Å†„ÅëÔºâ
                        if (itemId === 'omamori') {
                            const opened = !!gameState.main.flags.omikujiOpened;
                            const result = gameState.main.flags.omikujiResult;

                            if (opened && result) {
                                content += `<div style="text-align:center;font-size:18px;margin-top:4px;">„Åä„Åø„Åè„Åò„ÅÆÁµêÊûúÔºö<b style="font-size:22px;">${result}</b></div>`;
                            } else {
                                content += `<div style="text-align:center;font-size:14px;color:#ccc;margin-top:6px;"></div>`;
                            }

                            buttons = [
                                ...(opened ? [] : [{
                                    text: '„Åä„Åø„Åè„Åò„ÇíÈñã„Åè',
                                    action: () => {
                                        closeModal();
                                        drawOmikujiFromOmamori();
                                        // lockUI(2200, 0.22);
                                        playSE && playSE('se-can');
                                    }
                                }]),
                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                            ];
                        }


                        showModal(
                            getItemName(itemId),
                            content,
                            buttons
                        );
                    };
                    slot.appendChild(magBtn);
                }
                // ‚òÖÈÅ∏Êäû‰∏≠„Å™„Çâselected„ÇØ„É©„ÇπËøΩÂä†
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }


        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        function updateMessage(message) {
            //document.getElementById('messageArea').innerHTML = message;
            document.getElementById('msgText').textContent = message;
        }

        function updateMessageHTML(html) {
            const el = document.getElementById('msgText');
            el.innerHTML = html;
            el.querySelectorAll('a').forEach(a => {
                a.target = '_blank';
                a.rel = 'noopener';
                a.style.color = '#d4af37';
                a.style.textDecoration = 'underline';
            });
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content, buttons, onSequenceSuccess, options) {
            options = options || {};
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            if (buttons && buttons.length > 0) {
                const columnStyle = options.columnButtons
                    ? 'display:flex; flex-direction:column; gap:12px; align-items:stretch;'
                    : 'text-align:center; display:flex; gap:10px; justify-content:center;';

                modalHtml += `<div id="modalButtons" style="${columnStyle}"></div>`;
                modalHtml += `<div id="modalClose" style="margin-top:25px;text-align:center;"></div>`;
            }
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';

            if (!buttons || buttons.length === 0) return;

            let pressed = [];
            let heartCnt = 0;
            let checkCnt = 0;
            let houseCnt = 0;

            // ÁîªÂÉè/ÈÄöÂ∏∏„Éú„Çø„É≥„Å®close„Éú„Çø„É≥„ÅßÂàÜ„Åë„Çã
            const modalButtons = document.getElementById('modalButtons');
            const modalClose = document.getElementById('modalClose');

            buttons.forEach((button, idx) => {
                // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅØ‰∏ã„Å∏
                if (button.action === 'close') {
                    const btn = document.createElement('button');
                    btn.textContent = button.text || 'Èñâ„Åò„Çã';
                    btn.className = 'modal-close-btn';
                    btn.onclick = function () {
                        closeModal();
                        if (typeof onSequenceSuccess === "function") {
                            onSequenceSuccess();
                        }
                    };
                    modalClose.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.style.margin = "0 10px 10px 0";
                    if (button.img) {
                        btn.innerHTML = `<img src="${button.img}" alt="${button.text || ''}" style="width:80px;height:80px;vertical-align:middle;">`;
                    } else {
                        btn.textContent = button.text;
                        btn.className = 'text-btn';
                    }
                    btn.onclick = function () {
                        if (button.action === 'restart') {
                            restartGame();
                        } else if (typeof button.action === "function") {
                            button.action();
                        } else if (typeof button.action === 'string') {
                            closeModal();
                            handleAreaClick(button.action);
                        }
                    };
                    modalButtons.appendChild(btn);
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
            if (window._nextModal) {
                // ÁôªÈå≤ÂÜÖÂÆπ„ÅØ {title, content, buttons, after} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                let modal = window._nextModal;
                window._nextModal = null; // „ÇØ„É™„Ç¢

                if (typeof modal === 'function') {
                    try { modal(); } catch (e) { }
                    window.dispatchEvent(new Event('modal:closed'));
                    return;
                }

                if (modal.before) modal.before();
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after();
            }
            window.dispatchEvent(new Event('modal:closed'));
        }

        // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„Éà
        function restartGame() {
            gameState = getDefaultGameState();
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;
        let isBGMInitialized = false; // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®

        // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Å†„ÅëBGM„ÇíÂÜçÁîü
        function initBGMOnce() {
            if (!isBGMInitialized) {
                const bgm = document.getElementById('bgm');
                bgm.volume = 0.3;
                bgm.play();
                isBGMPlaying = true;
                isBGMInitialized = true;
                document.getElementById('bgm-toggle').textContent = "üîä BGM";
            }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "üîä BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "üîá BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // „Éï„Ç°„Ç§„É´Âêç„ÅÆ„Åø„ÅßÊØîËºÉ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            if (current === next) return; // „Åô„Åß„Å´„Åù„ÅÆBGM„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function pauseBGM() {
            const bgm = document.getElementById('bgm');
            bgm.src = "";
            bgm.pause();
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }
        function stopSE(id) {
            const se = document.getElementById(id);
            se.pause();
        }

        // „Å©„Åì„Åã„ÅßÊúÄÂàù„Å´‰∏ÄÂ∫¶„Å†„ÅëÂëº„Å∂
        let loadedImages = {};
        function preloadImages() {
            // ÈÉ®Â±ãÁîªÂÉè
            Object.values(IMAGES.rooms).forEach(val => {
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        if (!loadedImages[src]) {
                            const img = new Image();
                            img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                            img.src = src;
                            loadedImages[src] = img;



                        }
                    });
                } else if (typeof val === "string") {
                    if (!loadedImages[val]) {
                        const img = new Image();
                        img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                        img.src = val;
                        loadedImages[val] = img;
                    }
                }
            });
            // „Ç¢„Ç§„ÉÜ„É†ÁîªÂÉè
            Object.values(IMAGES.items).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
            // „É¢„Éº„ÉÄ„É´ÁîªÂÉè
            Object.values(IMAGES.modals).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
        }

        // save&load
        function saveGameToSlot(slotIndex) {
            const toSave = { ...gameState, __version: SAVE_VERSION };

            const payload = {
                data: toSave,
                savedAt: Date.now()
            };

            localStorage.setItem(SAVE_KEYS[slotIndex], JSON.stringify(payload));
            updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function loadGameFromSlot(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`);
                return;
            }

            let saved;
            try {
                const parsed = JSON.parse(raw);
                // Êñ∞ÂΩ¢ÂºèÔºö{ data: {...}, savedAt: ... }
                if (parsed && parsed.data) {
                    saved = parsed.data;
                } else {
                    // ÊóßÂΩ¢ÂºèÔºö„Åù„ÅÆ„Åæ„Åæ gameState „ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã
                    saved = parsed;
                }
            } catch (e) {
                console.error(e);
                updateMessage('„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return;
            }

            const def = getDefaultGameState();
            const merged = deepMerge(def, saved);

            if (!Array.isArray(merged.openRooms)) merged.openRooms = def.openRooms.slice();
            if (!merged.currentRoom || !rooms[merged.currentRoom]) merged.currentRoom = def.currentRoom;

            gameState = merged;

            changeRoom(gameState.currentRoom);
            updateInventoryDisplay?.();
            renderNavigation?.();
            updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function getSaveSlotLabel(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàÁ©∫Ôºâ`;
            }
            try {
                const parsed = JSON.parse(raw);
                const savedAt = parsed.savedAt;
                if (!savedAt) {
                    return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàÊó•ÊôÇ‰∏çÊòéÔºâ`;
                }
                const d = new Date(savedAt);
                const jp = d.toLocaleString('ja-JP');
                return `„Çª„Éº„Éñ${slotIndex + 1}Ôºà${jp}Ôºâ`;
            } catch {
                return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàË™≠„ÅøËæº„Åø„Ç®„É©„ÉºÔºâ`;
            }
        }

        function openLoadMenu() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0),
                    action: () => {
                        loadGameFromSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1),
                    action: () => {
                        loadGameFromSlot(1);
                        closeModal();
                    }
                },
                { text: '„ÇÑ„ÇÅ„Çã', action: 'close' }
            ];

            showModal('„É≠„Éº„Éâ„Åô„Çã„Éá„Éº„Çø„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ', '', buttons, null, { columnButtons: true });
        }

        function saveGame() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0) + ' „Å´‰∏äÊõ∏„Åç‰øùÂ≠ò',
                    action: () => {
                        saveGameToSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1) + ' „Å´‰∏äÊõ∏„Åç‰øùÂ≠ò',
                    action: () => {
                        saveGameToSlot(1);
                        closeModal();
                    }
                },
                { text: '„ÇÑ„ÇÅ„Çã', action: 'close' }
            ];

            showModal('„Çª„Éº„ÉñÂÖà„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ', '', buttons, null, { columnButtons: true });
        }

        function loadGame() {
            openLoadMenu();
        }

        function deepMerge(target, source) {
            if (source === undefined || source === null) return target;
            if (Array.isArray(source)) return source.slice();
            if (typeof source === 'object') {
                const out = (target && typeof target === 'object') ? { ...target } : {};
                for (const k of Object.keys(source)) {
                    out[k] = deepMerge(target ? target[k] : undefined, source[k]);
                }
                return out;
            }
            return source;
        }

        function showToast(text, ms = 2600) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = text;
            el.style.opacity = '1';
            el.style.transform = 'translateX(-50%) translateY(0)';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(-50%) translateY(-8px)';
            }, ms);
        }

        // ‰ΩèÊ∞ë3‰∫∫„ÅÆÊÇ©„Åø„ÅåÂÖ®ÈÉ®Ëß£Ê±∫„Åó„Åü„Çâ„ÄÅ„Éà„Éº„Çπ„ÉàË°®Á§∫ÔºÜÊâãÂ∏≥Êõ¥Êñ∞
        function checkAllVillagersSolved() {
            const f = gameState?.main?.flags;
            if (!f) return;

            const allSolved = !!(f.unlockSong && f.unlockVegetables && f.unlockRoute);
            if (!allSolved) return;

            // NOTESÔºàÈÄ≤ÊçóÔºâ„ÇíÊõ¥Êñ∞„Åó„Å¶„ÄåÊùëÈï∑„Å´‰ºö„ÅÑ„Å´Ë°å„Åì„ÅÜ„Äç„ÇíÂá∫„Åô
            if (typeof renderNotebookTasks === 'function') renderNotebookTasks();

            // „Éà„Éº„Çπ„Éà„ÅØ‰∏ÄÂõû„Å†„Åë
            if (!f.allSolvedToastShown) {
                f.allSolvedToastShown = true;
                showToast('Êùë„ÅÆ‰ΩèÊ∞ë„ÅÆÊÇ©„Åø„ÇíËß£Ê±∫„Åó„Åü„ÄÇ„Å≠„ÅìÂ±±ÊùëÈï∑„Å´‰ºö„ÅÑ„Å´Ë°å„Åì„ÅÜ');
            }
        }


        window.addEventListener('resize', () => renderNavigation());

        window.addEventListener('keydown', e => {
            if (e.key === 'F2') {
                DEV_MODE = !DEV_MODE;
                renderCanvasRoom();
            }
        });

        // „Ç≤„Éº„É†ÈñãÂßã
        preloadImages();
        initGame();
    </script>
    <div id="toast"
        style="position:fixed;left:50%;top:14px;transform:translateX(-50%);
padding:10px 14px;border-radius:8px;background:#1f6feb;color:#fff;font-weight:700;
box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s; z-index:9999;">
    </div>

</body>

</html>