<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ÂÆ¢ÂÆ§„ÇíËàûÂè∞„Å´„Åó„ÅüÂàÜÂ≤ê„Ç®„É≥„Éâ‰ªò„Åç„ÅÆÁÑ°ÊñôËÑ±Âá∫„Ç≤„Éº„É†„ÄÇÂÖ®4„Ç®„É≥„Éâ„ÅÆ„Éû„É´„ÉÅ„Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÄÇ„Çπ„Éû„ÉõÔºÜPCÂØæÂøú„ÄÇ">
    <title>ÂÆ¢ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;
            /* ‚Üê„Åì„ÇåÈáçË¶Å */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #gameCanvas {
            position: relative;
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
        }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            /* flex: 1; */
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 12px;
            /* width:100%; */
        }

        .inventory-slot {
            width: 14vw;
            height: 14vw;
            max-width: 80px;
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;
            /* ÈáëËâ≤„ÉªÂ§™„ÇÅÊé®Â•® */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .magnifier-btn {
            position: absolute;
            right: 4px;
            bottom: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0002;
            cursor: pointer;
            z-index: 10;
            transition: box-shadow .15s;
        }

        .magnifier-btn:hover {
            box-shadow: 0 0 10px #ffd70099;
        }

        .magnifier-btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .info-panel {
            width: 100%;
            padding: 2px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 2px;
            height: 65px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        #msgText {}

        #statusIconArea {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px #0005;
            font-size: 1.4em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        #modalButtons button {
            border: none;
            background: none;
            padding: 0;
            margin: 0 10px 10px 0;
            cursor: pointer;
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
            border-radius: 10px;
        }

        #modalButtons button img {
            width: 80px;
            height: 80px;
            vertical-align: middle;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
        }

        #modalButtons button:hover img {
            filter: brightness(1.08) drop-shadow(0 2px 6px #ffd70050);
            box-shadow: 0 0 10px #ffd70080;
            transform: scale(1.05);
        }

        #modalButtons button:active img,
        #modalButtons button.pressed img {
            filter: brightness(0.95) grayscale(20%);
            box-shadow: 0 0 8px #3332;
            transform: scale(0.97);
        }

        #modalButtons button:disabled img {
            filter: grayscale(90%) opacity(0.5);
            box-shadow: none;
        }

        /* „ÉÜ„Ç≠„Çπ„ÉàÂûã„Éú„Çø„É≥„ÇÇÁîªÂÉè„Éú„Çø„É≥È¢®„Å´ */
        #modalButtons button.text-btn {
            min-width: 120px;
            font-size: 1.15em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            margin: 0 10px 10px 0;
            box-shadow: 0 4px 14px #ffc90022;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s, transform 0.08s;
            vertical-align: middle;
            display: inline-block;
        }

        #modalButtons button.text-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
            transform: scale(1.05);
        }

        #modalButtons button.text-btn:active {
            filter: brightness(0.96);
            transform: scale(0.97);
        }

        #modalButtons button.text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Èñâ„Åò„Çã„Éú„Çø„É≥ */
        #modalClose .modal-close-btn {
            display: inline-block;
            min-width: 160px;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            box-shadow: 0 4px 14px #ffc90022;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s;
        }

        #modalClose .modal-close-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        .login-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            width: 280px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'Segoe UI', sans-serif;
        }

        .login-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .login-form label {
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .login-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .login-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ÁîªÂÉè„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }

        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            /* width: 40%; */
        }

        @media (max-width: 600px) {
            #msgText {
                font-size: .8rem;
            }

            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }

            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width: 100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }

        #roomEffectOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }

        .title-wrapper {
            display: flex;
            width: 100%;
        }

        @keyframes warpFlash {
            0% {
                opacity: 0
            }

            15% {
                opacity: .95
            }

            50% {
                opacity: .4
            }

            100% {
                opacity: 0
            }
        }

        @keyframes chroma {
            0% {
                filter: none
            }

            100% {
                filter: contrast(1.2) saturate(1.2) hue-rotate(20deg)
            }
        }

        .warp-active {
            background: radial-gradient(circle at 50% 50%, #fff, #000 70%);
            animation: warpFlash 900ms ease-out both, chroma 900ms ease-out both;
        }

        #hintModal {
            color: #000;
        }

        @keyframes glowPulse {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            60% {
                opacity: 0.9;
            }

            100% {
                opacity: 0;
            }

            /* Ëá™Âãï„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà */
        }


        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, .45);
            }

            50% {
                box-shadow: 0 0 18px 6px rgba(255, 255, 255, .35);
            }
        }



        /* ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Áî®„ÅÆÂÖ®ÁîªÈù¢„É¨„Ç§„É§ */
        #fxFlash {
            position: fixed;
            inset: 0;
            background: transparent;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
        }

        /* ÁôΩ„Éï„É©„ÉÉ„Ç∑„É• */
        @keyframes flashWhite {
            0% {
                opacity: 0;
                background: #fff;
            }

            12% {
                opacity: .95;
                background: #fff;
            }

            100% {
                opacity: 0;
                background: #fff;
            }
        }

        /* Ëµ§„Éï„É©„ÉÉ„Ç∑„É•Ôºà„Éü„ÇπÔºâ */
        @keyframes flashRed {
            0% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }

            18% {
                opacity: .85;
                background: rgba(255, 0, 0, 0.85);
            }

            100% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }
        }

        /* „Åª„Çì„ÅÆÂ∞ë„Åó„Ç´„É°„É©„Ç∑„Çß„Ç§„ÇØÔºàÂ•Ω„Åø„ÅßÔºâ */
        @keyframes camShake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, -1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, 1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .fx-shake {
            animation: camShake 120ms ease;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .casefile-modal {
            background-color: #f6f2e8;
            color: #2c2c2c;
            width: 80%;
            max-width: 720px;
            max-height: 85vh;
            border: 2px solid #bba;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .casefile-scroll {
            padding: 24px;
            overflow-y: auto;
            max-height: 80vh;
            font-family: "Noto Serif JP", "Times New Roman", serif;
            line-height: 1.6;
        }

        .casefile-modal h1,
        .casefile-modal h2 {
            text-align: center;
            margin-bottom: 8px;
        }

        .casefile-modal h3 {
            margin-top: 20px;
            border-bottom: 1px solid #999;
        }

        .person {
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-left: 3px solid #b44;
        }

        .initial-f {
            font-weight: 900;
            color: #c9a43d;
            /* gold */
            font-size: 1.55em;
            /* margin-left: 6px; */
        }

        .initial-l {
            font-weight: 900;
            color: #8c8fa1;
            /* silver/steel */
            font-size: 1.55em;
            /* margin-left: 4px; */
        }


        .evidence {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .evidence th,
        .evidence td {
            border: 1px solid #bbb;
            padding: 6px 8px;
        }

        /* ÈõªË©±Âõ≥ÈëëÁî®„ÅÆË°å„Éè„Ç§„É©„Ç§„Éà */
        .evidence tr.phone-discovered td {
            background: rgba(255, 248, 210, 0.9);
            /* „ÅÜ„Åô„ÅÑ„ÇØ„É™„Éº„É†Ëâ≤ */
            font-weight: 600;
        }

        .evidence tr.phone-undiscovered td {
            background: rgba(245, 245, 245, 0.7);
            /* „ÅÜ„Åô„Ç∞„É¨„Éº */
            color: #777;
        }

        blockquote {
            font-style: italic;
            color: #444;
            border-left: 4px solid #888;
            padding-left: 10px;
            margin: 10px 0;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.4rem;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }

        .group {
            width: 90%;
            justify-content: center;
            display: flex;
            gap: 8px;
            align-items: center
        }


        @keyframes breathe {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(2px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .modal-content {
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            /* ÁîªÈù¢„Å´Âèé„ÇÅ„Çã */
            overflow: auto;
            /* „ÅØ„ÅøÂá∫„Åó„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´ */
            padding: 20px;
            /* „Å°„Çá„ÅÑÂúßÁ∏Æ */
        }

        /* „É¢„Éº„ÉÄ„É´„ÅÆÁîªÂÉè„Éú„Çø„É≥„ÅØÂõ∫ÂÆö80px‚ÜíÂèØÂ§â„Å´ */
        #modalButtons button img {
            width: clamp(56px, 18vw, 96px);
            height: clamp(56px, 18vw, 96px);
        }

        /* 22„Éñ„É≠„ÉÉ„ÇØ„Éû„É≥Â∏ΩÂ≠ê„É¢„Éº„ÉÄ„É´Áî® */
        .modal-anim {
            position: relative;
            width: min(400px, 80vw);
            margin: 0 auto 16px;
        }

        .modal-anim img {
            display: block;
            width: 100%;
        }

        /* 1ÊûöÁõÆ„ÅØ„Å†„Çì„Å†„ÇìÊ∂à„Åà„Çã */
        .modal-anim img:nth-child(1) {
            position: absolute;
            inset: 0;
            opacity: 1;
            animation: blockmanHatFadeOut 2.8s ease forwards 0.1s;
        }

        /* 2ÊûöÁõÆ„ÅØÂæå„Åã„Çâ„Åµ„Çè„Å£„Å®Âá∫„Å¶„Åè„Çã */
        .modal-anim img:nth-child(2) {
            opacity: 0;
            animation: blockmanHatFadeIn 3.0s ease forwards 0.4s;
        }

        /* 1ÊûöÁõÆ„ÅØ„Å†„Çì„Å†„ÇìÊ∂à„Åà„Çã */
        .fast img:nth-child(1) {
            animation: blockmanHatFadeOut 1.2s ease forwards 0.1s;
        }

        /* 2ÊûöÁõÆ„ÅØÂæå„Åã„Çâ„Åµ„Çè„Å£„Å®Âá∫„Å¶„Åè„Çã */
        .fast img:nth-child(2) {
            animation: blockmanHatFadeIn 1.4s ease forwards 0.4s;
        }

        @keyframes blockmanHatFadeOut {
            to {
                opacity: 0;
            }
        }

        @keyframes blockmanHatFadeIn {
            to {
                opacity: 1;
            }
        }

        /* ‚ñº „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´Áî® */

        .notebook-modal-content {
            background: #f4f7fb;
            color: #2c1810;
            border: 3px solid #d4af37;
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            overflow: auto;
            padding: 18px 18px 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            position: relative;
        }

        .notebook-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .notebook-title {
            font-weight: bold;
            font-size: 1.1rem;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .notebook-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid #c9a43d;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #eaf3ff, #d6e4ff);
        }

        .notebook-close-btn {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: #555;
        }

        .notebook-close-btn:hover {
            color: #000;
        }

        .notebook-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .notebook-tab {
            flex: 1;
            border: 1px solid #c9a43d;
            background: #fdfaf0;
            padding: 6px 4px;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 999px;
            color: #6b4b10;
            font-weight: bold;
        }

        .notebook-tab.active {
            background: linear-gradient(135deg, #ffe9a8, #ffd36b);
            box-shadow: 0 0 6px rgba(217, 165, 33, 0.6);
        }

        .notebook-body {
            background: #fffef8;
            border-radius: 8px;
            padding: 10px 12px 12px;
            border: 1px solid #e0d6b5;
        }

        .notebook-tab-content {
            display: none;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .notebook-tab-content.active {
            display: block;
        }

        .notebook-cap {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .notebook-note {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #6b6b6b;
        }

        .notebook-list {
            margin: 0 0 4px 1.1em;
            padding: 0;
        }

        .notebook-list li {
            margin-bottom: 3px;
        }

        .notebook-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .notebook-table th,
        .notebook-table td {
            border: 1px solid #d5c9a5;
            padding: 4px 6px;
        }

        .notebook-table th {
            background: #faf1d7;
        }

        /* ‚ñ≤ „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´Áî® */
        .distress-btn {
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #ff5555, #ff9900);
            color: #fff;
            box-shadow: 0 0 12px rgba(255, 64, 64, 0.7);
        }

        .distress-btn.distress-holding {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 0 18px rgba(255, 0, 0, 0.9);
        }

        .distress-hint {
            margin-top: 6px;
            font-size: 0.9em;
            color: #b00;
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F2G9BX4FBF"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-F2G9BX4FBF');
</script>

<body>
    <!-- ‚ñº „É¢„Éº„ÉÄ„É´ÂÖ®‰Ωì -->
    <!-- ‚ñº „É¢„Éº„ÉÄ„É´ÂÖ®‰Ωì -->
    <div class="modal-overlay" style="display:none;">
        <div class="casefile-modal">
            <button class="close-btn">√ó</button>
            <div class="casefile-scroll">


            </div>
        </div>
    </div>
    <!-- ‚ñº „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="notebookModal" style="display:none;">
        <div class="modal-content notebook-modal-content">
            <div class="notebook-header">
                <div class="notebook-title">
                    <span class="notebook-logo">‚öì</span>
                    „ÇØ„É´„ÉºÊâãÂ∏≥
                </div>
                <button class="notebook-close-btn" onclick="closeNotebook()">‚úï</button>
            </div>

            <div class="notebook-tabs">
                <button class="notebook-tab active" data-tab="memo" onclick="switchNotebookTab('memo')">
                    MEMO
                </button>
                <button class="notebook-tab" data-tab="calllog" onclick="switchNotebookTab('calllog')">
                    CALL LIST
                </button>
                <button class="notebook-tab" data-tab="notes" onclick="switchNotebookTab('notes')">
                    NOTES
                </button>
            </div>

            <div class="notebook-body">
                <!-- MEMO„Çø„Éñ -->
                <div class="notebook-tab-content active" id="notebook-tab-memo">
                    <p class="notebook-cap">
                        Ê∑°„ÅÑÈùí„ÅÆË°®Á¥ô„Å´„ÄÅËàπ‰ºöÁ§æ„ÅÆÈáëËâ≤„Ç®„É≥„Éñ„É¨„É†„ÅåÊäº„Åï„Çå„Åü„ÇØ„É´„ÉºÊâãÂ∏≥„Å†„ÄÇ
                    </p>
                    <ul class="notebook-list">
                        <li>505 „ÅØ <b>ÊòºÔºà9„Äú15ÊôÇÔºâ</b> „Åó„Åã„Å§„Å™„Åå„Çâ„Å™„ÅÑ„ÄÇ</li>
                        <li>117 „Å´„Åã„Åë„Çã„Å®„ÄÅÁèæÂú®„ÅÆËàπÂÜÖÊôÇÈñì„ÅåÂàÜ„Åã„Çã„ÄÇ</li>
                    </ul>
                    <p class="notebook-note">
                        Êõ∏„ÅçËæº„Åø„ÅØ„ÄÅÊÄ•„ÅÑ„ÅßËµ∞„ÇäÊõ∏„Åç„Åó„Åü„Çà„ÅÜ„Å™‰π±„Çå„ÅüÂ≠ó„Åß‰∏¶„Çì„Åß„ÅÑ„Çã„ÄÇ
                    </p>
                </div>

                <!-- CALL LOG„Çø„ÉñÔºöÈõªË©±Â±•Ê≠¥„ÅÆË°®Á§∫Áî®„Ç≥„É≥„ÉÜ„Éä -->
                <div class="notebook-tab-content" id="notebook-tab-calllog">
                    <p class="notebook-cap" id="notebook-calllog-header">
                        „Åã„Åë„ÅüÈõªË©±Áï™Âè∑„Å®„ÄÅ„Åù„ÅÆ„Å®„Åç„ÅÆ„É°„É¢„ÅåÊÆã„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ
                    </p>
                    <table class="notebook-table">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Áï™Âè∑</th>
                                <th>ÂêçÁß∞</th>
                                <th>ÂèçÂøú</th>
                                <th>Áä∂ÊÖã</th>
                            </tr>
                        </thead>
                        <tbody id="notebook-calllog-body">
                            <!-- JS„Åã„Çâ„Åì„Åì„Å´Ë°å„ÇíËøΩÂä†„Åô„ÇãÊÉ≥ÂÆö„ÄÇ„Å®„Çä„ÅÇ„Åà„Åö„ÉÄ„Éü„Éº1Ë°å -->
                            <tr>
                                <td>505</td>
                                <td>Âñ∂Ê•≠ÊôÇÈñìÂ§ñ„ÄÇ„Å§„Å™„Åå„Çâ„Å™„Åã„Å£„Åü„ÄÇ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- NOTES„Çø„ÉñÔºöÂæå„Åã„ÇâÂ¢ó„Åà„Çã„É°„É¢Áî® -->
                <div class="notebook-tab-content" id="notebook-tab-notes">
                    <p class="notebook-cap">
                        Á©∫ÁôΩ„ÅÆ„Éö„Éº„Ç∏„ÅåÊÆã„Å£„Å¶„ÅÑ„Çã„ÄÇ„ÅÇ„Å®„Åß‰Ωï„Åã„ÅåÊõ∏„ÅçË∂≥„Åï„Çå„Çã„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÄÇ
                    </p>
                    <div id="notebook-notes-body">
                        <!-- ÂæåÂçä„ÅÆ„Ç§„Éô„É≥„Éà„ÅßËøΩË®ò„Åó„Å¶„ÅÑ„ÅèÊÉ≥ÂÆö -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤ „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ -->


    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <!-- <div class="title">ÂÆ¢ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫</div> -->
            <div style="margin:0 0; text-align:center;">
                <a href="escape23_hint.html" target="_blank"
                    style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    üîç „Éí„É≥„Éà„ÇíË¶ã„Çã
                </a>

            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="640" style="width: 90vw; max-width: 640px;"></canvas>


        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="msgText">Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÂÆ¢ÂÆ§„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ</span>
                    <div id="statusIconArea" style="position:absolute; bottom:6px; right:12px; display:flex; gap:8px;">
                    </div>
                </div>
                <div class="navigation">

                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
                <div class="inventory-slot" onclick="useItem(5)"></div>
                <div class="inventory-slot" onclick="useItem(6)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
                üîä BGM
            </button>
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">„Çª„Éº„Éñ</button>
                <button class="nav-btn" onclick="loadGame()">„É≠„Éº„Éâ</button>
            </div>
        </div>
        <div class="notice">ÂΩì„Çµ„Ç§„Éà„ÅÆÈü≥Ê∫ê„ÅØ<a href="https://otologic.jp/" target="blank">OtoLogic</a>,<a
                href="https://dova-s.jp/" target="blank">DOVA-SYNDROME</a>„ÅÆÁ¥†Êùê„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô ‰ΩúËÄÖ:<a href="index.html">„Çπ„É©„Çª„Éñ„É≥</a>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>

    <audio id="bgm" src="sounds/23/Paper_craft.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-clear" src="sounds/common/Cyber03-1.mp3"></audio>
    <audio id="se-change" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-open" src="sounds/common/Short_Accent09-1(Dry).mp3"></audio>
    <audio id="se-fanta" src="sounds/common/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <audio id="se-coin" src="sounds/common/Onoma-Ding01-1(Dry).mp3"></audio>
    <audio id="se-scene-change" src="sounds/common/Scene_Change08-1(Delay-Fast).mp3"></audio>
    <audio id="se-tictac" src="sounds/common/tictac.mp3"></audio>
    <audio id="se-gacha" src="sounds/common/Retro_Anime-Switch02-3(Low).mp3"></audio>

    <audio id="se-bukimi_piano" src="sounds/common/bukimi_piano.mp3"></audio>
    <audio id="se-idea" src="sounds/common/Inspiration11-1(Low).mp3"></audio>
    <audio id="se-grab" src="sounds/common/Motion-Grab07-1(Dry).mp3"></audio>
    <audio id="se-switch" src="sounds/common/switch.mp3"></audio>
    <audio id="se-glich" src="sounds/common/glich.mp3"></audio>
    <audio id="se-bear-appear" src="sounds/common/Anime_Motion19-1(Phrase).mp3"></audio>
    <audio id="se-bear-eat" src="sounds/common/Motion-Eating02-1.mp3"></audio>
    <audio id="se-bear-flying" src="sounds/common/Motion-Blow_Away02-1(Long).mp3"></audio>


    <audio id="se-angel" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-up" src="sounds/common/Inspiration10-1(High).mp3"></audio>
    <audio id="se-ashioto" src="sounds/common/NES-RPG02-01(Enter).mp3"></audio>
    <audio id="se-hasami" src="sounds/common/hasami.mp3"></audio>
    <audio id="se-shutter" src="sounds/common/shutter.mp3"></audio>
    <audio id="se-fire" src="sounds/common/fire.mp3"></audio>
    <audio id="se-call" src="sounds/common/Telephone-Signal_Tone01-1(RingbackShort).mp3"></audio>
    <audio id="se-busy" src="sounds/common/Telephone-Signal_Tone01-2(BusyShort).mp3"></audio>
    <audio id="se-noise" src="sounds/common/Telephone-Signal_Tone01-3(Noise).mp3"></audio>
    <audio id="se-receiver" src="sounds/common/Telephone-Hardware01-6(Receiver-Pick_Up).mp3"></audio>

    <audio id="se-push1" src="sounds/common/Telephone-DTMF01-01(1).mp3"></audio>
    <audio id="se-push2" src="sounds/common/Telephone-DTMF01-02(2).mp3"></audio>

    <audio id="se-cyber" src="sounds/common/Cyber20-1.mp3"></audio>
    <audio id="se-cloth" src="sounds/common/cloth.mp3"></audio>
    <audio id="se-paper" src="sounds/common/Flyer02-3(Rustle).mp3"></audio>
    <audio id="se-zukkoke" src="sounds/common/zukkoke.mp3"></audio>
    <audio id="se-tirori" src="sounds/common/tirori.mp3"></audio>
    <audio id="se-ebi" src="sounds/23/ebi.wav"></audio>
    <audio id="se-nami" src="sounds/common/nami.mp3"></audio>
    <audio id="se-announcement" src="sounds/common/pinponpan.mp3"></audio>



    <script>
        // --- Analytics helper ---
        window.ANA = {
            start: Date.now(),
            hintCount: 0,
            send(ev, params = {}) { try { gtag('event', ev, params); } catch (e) { } }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const a = document.querySelector('a[href*="_hint.html"]');
            if (a) {
                a.addEventListener('click', () => {
                    ANA.hintCount++;
                    ANA.send('open_hint', { count: ANA.hintCount });
                });
            }
        });

        window.ANA = Object.assign(window.ANA || {}, {
            sid: Math.random().toString(36).slice(2),
            sent: new Set(),
            baseParams() {
                return {
                    elapsed_sec: Math.round((Date.now() - this.start) / 1000),
                    hints: this.hintCount || 0,
                    save_version: (typeof SAVE_VERSION === 'number' ? SAVE_VERSION : null),
                    room: (window.gameState && gameState.currentRoom) || null,
                    sid: this.sid,
                };
            },
            once(ev, key = '', params = {}) {
                const k = `${ev}:${key}`;
                if (this.sent.has(k)) return;
                this.sent.add(k);
                this.send(ev, { ...this.baseParams(), ...params });
            }
        });

        // Ê±éÁî®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÄÅ‰ø°Áî®„Éò„É´„Éë
        function markProgress(step, extra = {}) {
            ANA.once('progress', step, { step, ...extra });
        }


        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.querySelector(".modal-overlay");
            const openBtn = document.querySelector("#open-casefile");
            const closeBtn = document.querySelector(".close-btn");

            // ÂàùÊúüÁä∂ÊÖã„ÅßÈùûË°®Á§∫
            modal.style.display = "none";

            // Èñã„Åè
            openBtn?.addEventListener("click", () => {
                modal.style.display = "flex";
            });

            // Èñâ„Åò„Çã
            closeBtn?.addEventListener("click", () => {
                modal.style.display = "none";
            });

            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modal.addEventListener("click", (e) => {
                if (e.target === modal) modal.style.display = "none";
            });
        });



        window._nextModal = null;
        const canvas = document.getElementById('gameCanvas');
        let DEV_MODE = false;
        // „Ç≤„Éº„É†Ë®≠ÂÆö - ÁîªÂÉè„Éë„Çπ„Çí„Åì„Åì„ÅßÁÆ°ÁêÜ
        let IMAGES = {
            rooms: {
                guestRoom: [
                    'images/23/guest_room.png',        // 0: Êòé„Çã„ÅÑ
                    'images/23/guest_room_dark.png',   // 1: ÈõªÊ∞óÊ∂à„ÅóÁâà
                ],
                window: ['images/23/window_1.png', 'images/23/window_2.png', 'images/23/window_3.png', 'images/23/window_4.png'],
                cabinetBottomInner: ['images/23/cabinet_bottom_inner.png'],
                corridor: ['images/23/corridor.png'],
                restaurantEntrance: ['images/23/restaurant_entrance.png'],
                restaurant: ['images/23/restaurant.png'],

                kitchen: ['images/23/kitchen.png'],
                kitchenLeft: ['images/23/kitchen_left.png'],
                deckDoor: ['images/23/deck_door.png'],
                deck: ['images/23/deck.png'],
                storage: ['images/23/storage.png'],
                wheelhouse: ['images/23/wheelhouse.png'],
                room288: ['images/23/room288.png'],
                map: ['images/23/map.png'],
                end: ['images/23/end.png'],
                trueEnd: ['images/23/true_end.png', 'images/23/true_end2.png'],

            },
            items: {
                coin: 'images/bear_coin.png',
                bear: 'images/23/bear.png',
                bearCrying: 'images/22/bear_santa_crying.png',
                bearAfraid: 'images/22/bear_santa_afraid.png',
                back: 'images/common/back.png',
                arrowRight: 'images/common/arrow_right.png',
                arrowLeft: 'images/common/arrow_left.png',
                arrowAbove: 'images/common/arrow_above.png',
                redBack: 'images/common/red_back.png',
                greenBack: 'images/common/green_back.png',
                blueBack: 'images/common/blue_back.png',
                blackBack: 'images/common/black_back.png',
                moonLight: 'images/23/moon_light.png',
                moonLightWindow: 'images/23/moon_light_window.png',
                dirt: 'images/23/dirt.png',
                dirt2: 'images/23/dirt2.png',
                wetpaper: 'images/23/wetpaper.png',
                plateClean: 'images/23/plate_clean.png',
                notebook: 'images/23/notebook.png',
                memoKitchen: 'images/23/memo_kitchen.png',
                foodSet: 'images/23/food_set.png',
                plateAfter: 'images/23/plate_after.png',
                bird: 'images/23/bird.png',
                feather: 'images/23/feather.png',
                cardkey: 'images/23/cardkey.jpeg',
                posterExplore: 'images/23/poster_explore.png',
                posterSuggestion: 'images/23/poster_suggestion.png',
                momokoCard: 'images/23/momoko_card.png',
                brownBack: 'images/23/brown_back.png',
                steak: 'images/23/steak.png',
                keyFrozen: 'images/23/key_frozen.png',
                key: 'images/23/key.png',






            },

            modals: {
                moonCharacter: 'images/23/modal_moon_character.png',
                curryPlan: 'images/23/modal_curry_plan.png',
                pancakePlan: 'images/23/modal_pancake_plan.png',
                corridorDoorLocked: 'images/23/modal_corridor_door_locked.png',
                corridorDoorUnlocked: 'images/23/modal_corridor_door_unlocked.png',
                aSet: 'images/23/modal_a_set.png',
                check4: 'images/23/modal_check_4.png',
                check8: 'images/23/modal_check_8.png',
                check9: 'images/23/modal_check_9.png',
                restaurantWindow1: 'images/23/modal_restaurant_window1.png',
                restaurantWindow2: 'images/23/modal_restaurant_window2.png',
                restaurantWindow3: 'images/23/modal_restaurant_window3.png',
                restaurantWindow4: 'images/23/modal_restaurant_window4.png',
                restaurantWindow5: 'images/23/modal_restaurant_window5.png',
                restaurantWindow6: 'images/23/modal_restaurant_window6.png',
                kitchenBottles: 'images/23/modal_kitchen_bottles.png',
                plate: 'images/23/plate.png',
                plateSteak: 'images/23/steak.png',
                plateShrimp: 'images/23/shrimp.png',
                plateSalad: 'images/23/salad.png',
                aSetCompleted: 'images/23/a_set_completed.jpeg',
                aSetNiku: 'images/23/modal_a_set_niku.png',
                kumaAsetHungry: 'images/23/modal_bear_aset.jpeg',
                kumaAsetEmpty: 'images/23/modal_plate_empty.png',  // Áöø„ÅåÁ©∫
                kumaAsetGoodbye: 'images/23/modal_bear_flying.png',   // Ê∫ÄË∂≥„Åó„Å¶È£õ„Çì„Åß„ÅÑ„Åè
                shrimpAngry: 'images/23/modal_shrimp_angry.png',
                shrimpBad: 'images/23/modal_shrimp_sea.png',
                corridorSign: 'images/23/modal_corridor_sign.png',
                // map: 'images/23/modal_map.png',
                freezerInner: 'images/23/modal_freezer.png'

                // badEnd: 'images/22/badend.jpeg',
            },
        };


        // „Ç≤„Éº„É†Áä∂ÊÖã
        const SAVE_KEY = 'escapeGameState23';
        const SAVE_VERSION = 1;
        const SAVE_KEYS = [
            SAVE_KEY + '_1',
            SAVE_KEY + '_2'
        ];

        // Êóß1„Çπ„É≠„ÉÉ„Éà„Çª„Éº„Éñ„Åå„ÅÇ„Çå„Å∞„ÄÅËá™Âãï„Åß„Çπ„É≠„ÉÉ„Éà1„Å´ÁßªË°å
        (function migrateOldSave() {
            try {
                const old = localStorage.getItem(SAVE_KEY);
                const slot1 = localStorage.getItem(SAVE_KEYS[0]);
                if (old && !slot1) {
                    localStorage.setItem(SAVE_KEYS[0], old);
                    // ÂøÖË¶Å„Å™„ÇâÂè§„ÅÑ„Ç≠„Éº„ÅØÊ∂à„Åó„Å¶„ÇÇOK
                    // localStorage.removeItem(SAVE_KEY);
                    console.log('Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„Çí„Çπ„É≠„ÉÉ„Éà1„Å´ÁßªË°å„Åó„Åæ„Åó„Åü');
                }
            } catch (e) {
                console.warn('„Çª„Éº„Éñ„Éá„Éº„ÇøÁßªË°å„Å´Â§±Êïó', e);
            }
        })();

        function getDefaultGameState() {
            return {
                currentRoom: 'guestRoom',
                openRooms: ['guestRoom'],
                openRoomsTmp: [],
                inventory: [],
                phoneDex: {},
                phoneDexFlags: {},
                main: {
                    flags: {

                        unlockCabinetBottom: false,
                        unlockCabinetTop: false,
                        cleanDirt: false,
                        gotDoorCode: false,
                        gotNotebook: false,

                        // ‚òÖ ÊôÇÈñìÂ∏ØÔºö0=Êòº, 1=Â§ïÊñπ, 2=Â§ú
                        timePhase: 0,
                        // ‚òÖ Âµê„Éï„É©„Ç∞Ôºàtrue „Å™„Çâ window_4 „Çí‰Ωø„ÅÜÔºâ
                        windowStorm: false,

                        isNight: false,
                        unlockCorridorDoor: false,
                        unlockFrozen: false, foundKeyFrozen: false, foundKey: false,
                        unlockRefrigerator: false, foundFoodSet: false, foundSteak: false, completedPlating: false, notebookDeckHintAdded: false,
                        unlockRoom288: false,

                        unlockDeckDoor: false, setReceiver: false, unlockStorageDoor: false,
                        goneBird: false,
                        treasureCoordinateSet: false,
                        notFoundCnt: 0,

                        talkTo: { bear: 0, }, backgroundState: 0,
                    }
                },
                trueEnd: {
                    flags: { backgroundState: 0 }
                },


                flags: { trueEndUnlocked: false },
                selectedItem: null,
                endings: { true: false, normal2: false, normal: false }

            };
        }

        let gameState = getDefaultGameState();




        // ÈÉ®Â±ã„Éá„Éº„Çø
        let rooms = {
            guestRoom: {
                name: 'ÂÆ¢ÂÆ§',
                description: 'Ë¶ãÁü•„Çâ„Å¨ÂÆ¢ÂÆ§',
                clickableAreas: [
                    {
                        x: 52.2, y: 53.0, width: 10.6, height: 5.8,
                        onClick: clickWrap(function () {
                            showPhoneDialModal();
                        }, { allowAtNight: true }),
                        description: 'ÈõªË©±',
                        zIndex: 5,
                        usable: () => true,
                    },
                    {
                        x: 86.0, y: 28.8, width: 11.7, height: 61.5,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.windowStorm) {
                                showModal(
                                    '„Ç¢„Éä„Ç¶„É≥„Çπ„ÅåÊµÅ„Çå„Åü',
                                    '„ÄåÁèæÂú®ËçíÂ§©„ÅÆ„Åü„ÇÅ„ÄÅËàπÂÆ§„Éâ„Ç¢„Çí„É≠„ÉÉ„ÇØ‰∏≠„Åß„Åô„Äç',
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                                updateMessage('„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');
                            } else if (gameState.main.flags.unlockDoor) {
                                changeRoom('corridor');
                            } else {
                                updateMessage('„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ');
                            }
                        }),
                        description: '„Éâ„Ç¢',
                        zIndex: 1,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 28.3, y: 23.4, width: 15.2, height: 14.8,
                        onClick: clickWrap(function () {
                            changeRoom('window');

                        }, { allowAtNight: true }),
                        description: '‰∏∏Á™ì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 10.8, y: 52.8, width: 8.6, height: 16.5,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockCabinetTop) {
                                updateMessage('„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏ä„ÅÆÊÆµ„ÅØÈñã„ÅÑ„Å¶„ÅÑ„Çã„ÄÇ');
                                acquireItemOnce('foundWetpaper', 'wetpaper', '„Ç¶„Çß„ÉÉ„Éà„ÉÜ„Ç£„ÉÉ„Ç∑„É•„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.wetpaper, '„Ç¶„Çß„ÉÉ„Éà„ÉÜ„Ç£„ÉÉ„Ç∑„É•„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                            } else {
                                showCabinetTopLockPuzzle();
                            }

                        }),
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏ä„ÅÆÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 10.8, y: 73.3, width: 9.9, height: 24.2,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockCabinet) {
                                changeRoom('cabinetBottomInner');
                            } else {
                                showCabinetLockPuzzle();
                            }
                        }),
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏ã„ÅÆÊÆµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 27.9, y: 51.2, width: 16.3, height: 8.0,
                        onClick: clickWrap(function () {
                            updateMessage('„Åæ„Åè„Çâ„ÅÆ‰∏ã„Å´„ÅØ‰Ωï„ÇÇ„Å™„ÅÑ');

                        }),
                        description: '„Åæ„Åè„Çâ',
                        zIndex: 0,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 22.1, y: 26.9, width: 26.4, height: 45.6,
                        onClick: clickWrap(function () {

                        }),
                        description: 'Êúà„ÅÆÂÖâ',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'moonLight', visible: () => gameState.main.flags.timePhase == 2 }
                    },
                    {
                        x: 28.6, y: 63.1, width: 12.8, height: 4.4,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.moonCharacter, 'Êúà„ÅÆÂÖâ„ÅåÂ∑Æ„ÅóËæº„Çì„Åß„ÅÑ„Çã');

                        }, { allowAtNight: true }),
                        description: 'Êúà„ÅÆÂÖâÊñáÂ≠ó',
                        zIndex: 5,
                        usable: () => gameState.main.flags.timePhase == 2,

                    },
                    {
                        x: 65.0, y: 37.0, width: 14.5, height: 9.8,
                        onClick: clickWrap(function () {
                            showObj(null, 'Ê°àÂÜÖÊùø„Å†<br>Âõ∞„Å£„Åü„Å®„Åç„ÅØ505„Å´ÈõªË©±„Åô„Çå„Å∞„ÅÑ„ÅÑ„Åø„Åü„ÅÑ„Å†„ÄÇ„Éâ„Ç¢„ÇíÈñã„Åë„Å¶„ÇÇ„Çâ„Åà„Çã„Åã„ÇÇÔºü', IMAGES.items.plateClean, 'Âõ∞„Å£„Åü„Å®„Åç„ÅØ505„Å´ÈõªË©±„Åô„Çå„Å∞„ÅÑ„ÅÑ„Åø„Åü„ÅÑ„Å†„ÄÇ„Éâ„Ç¢„ÇíÈñã„Åë„Å¶„ÇÇ„Çâ„Åà„Çã„Åã„ÇÇÔºü');

                        }),
                        description: 'ÈäòÊùø',
                        zIndex: 2,
                        usable: () => gameState.main.flags.cleanDirt,
                    },
                    {
                        x: 65.8, y: 37.4, width: 13.1, height: 9.1,
                        onClick: clickWrap(function () {
                            if (hasItem('wetpaper') && !gameState.main.flags.cleanDirt) {
                                showPlateModal();
                            } else {
                                showObj(null, '‰Ωï„ÅãÊõ∏„ÅÑ„Å¶„ÅÇ„Çã„Åå„ÄÅÊ±ö„Çå„Å¶„ÅÑ„Å¶Ë™≠„ÇÅ„Å™„ÅÑ', '', '‰Ωï„ÅãÊõ∏„ÅÑ„Å¶„ÅÇ„Çã„Åå„ÄÅÊ±ö„Çå„Å¶„ÅÑ„Å¶Ë™≠„ÇÅ„Å™„ÅÑ');
                            }


                        }),
                        description: 'ÈäòÊùø„ÅÆ„Çà„Åî„Çå',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.cleanDirt,
                        item: { img: 'dirt', visible: () => !gameState.main.flags.cleanDirt }
                    },
                    {
                        x: 81.5, y: 46.9, width: 3.5, height: 5.5,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDoor) {
                                updateMessage('„Éâ„Ç¢„É≠„ÉÉ„ÇØ„ÅØËß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã');
                            } else {
                                showDoorPuzzle();
                            }


                        }),
                        description: '„Éâ„Ç¢„É≠„ÉÉ„ÇØ„Éë„Éç„É´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                ]
            },
            window: {
                name: '‰∏∏Á™ì',
                description: '',
                clickableAreas: [

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('guestRoom');
                        }, { allowAtNight: true }),
                        description: '‰∏∏Á™ìÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            cabinetBottomInner: {
                name: 'ËàπÂÆ§„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏ãÊÆµ',
                description: '',
                clickableAreas: [
                    {
                        x: 60.8, y: 77.7, width: 24.8, height: 9.7,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.curryPlan, 'È£ü‰∫ã„ÅÆË®àÁîª„Åã„Å™Ôºü');
                        }),
                        description: 'üçõ„Éó„É©„É≥',
                        zIndex: 2,
                        usable: () => true,
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('guestRoom');
                        }, { allowAtNight: true }),
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏ãÊÆµÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            corridor: {
                name: 'Âªä‰∏ã',
                description: '',
                clickableAreas: [
                    {
                        x: 46.1, y: 49.5, width: 7.5, height: 12.5,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockCorridorDoor) {
                                changeRoom('restaurantEntrance');
                            } else {
                                showCorridorDoorPuzzle();
                            }

                        }),
                        description: 'Âªä‰∏ã„ÅÆ„Éâ„Ç¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 49.5, y: 51.4, width: 1.0, height: 1.0,
                        onClick: clickWrap(function () {

                        }),
                        description: 'Âªä‰∏ã„ÅÆ„Éâ„Ç¢„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'greenBack', visible: () => gameState.main.flags.unlockCorridorDoor }
                    },
                    {
                        x: 81.3, y: 32.7, width: 11.5, height: 7.4,
                        onClick: clickWrap(function () {
                            updateMessage('„Åï„Å£„Åç„Åæ„ÅßÂ±Ö„ÅüÈÉ®Â±ã„Å†„ÄÇA06„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã');
                        }),
                        description: 'A06„Éó„É¨„Éº„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 71.5, y: 32.8, width: 10.0, height: 66.2,
                        onClick: clickWrap(function () {
                            changeRoom('guestRoom');
                        }),
                        description: 'A06„Éâ„Ç¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 63.1, y: 44.5, width: 6.2, height: 3.1,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'key') {
                                showObj('unlockRoom288', '„Åì„Åì„ÅÆÈçµ„Å†„Çç„ÅÜ„Åã‚Ä¶Èçµ„ÅåÈñã„ÅÑ„Åü', IMAGES.items.key, 'Èçµ„ÅåÈñã„ÅÑ„Åü„ÄÇ');
                                removeItem('key');
                                playSE('se-gacha');

                            } else if (gameState.main.flags.unlockRoom288) {
                                changeRoom('room288');
                            } else {
                                updateMessage('288„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã„ÄÇ‚Ä¶„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ„ÄÇ');
                            }

                        }),
                        description: '288„Éó„É¨„Éº„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 57.2, y: 48.7, width: 3.5, height: 1.7,
                        onClick: clickWrap(function () {
                            updateMessage('A04„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã„ÄÇ‚Ä¶„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ„ÄÇ');
                        }),
                        description: 'A04„Éó„É¨„Éº„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 38.9, y: 48.1, width: 2.9, height: 2.5,
                        onClick: clickWrap(function () {
                            updateMessage('A01„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã„ÄÇ‚Ä¶„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ„ÄÇ');
                        }),
                        description: 'A01„Éó„É¨„Éº„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 29.9, y: 43.8, width: 6.3, height: 4.2,
                        onClick: clickWrap(function () {
                            updateMessage('A02„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã„ÄÇ‚Ä¶„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ„ÄÇ');
                        }),
                        description: 'A02„Éó„É¨„Éº„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 5.8, y: 31.0, width: 12.3, height: 9.8,
                        onClick: clickWrap(function () {
                            updateMessage('A03„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã„ÄÇ‚Ä¶„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ„ÄÇ');
                        }),
                        description: 'A03„Éó„É¨„Éº„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 56.8, y: 84.8, width: 8.6, height: 6.9,
                        onClick: clickWrap(function () {
                            acquireItemOnce('gotNotebook', 'notebook', 'ÊâãÂ∏≥„ÇíÊãæ„Å£„Åü', IMAGES.items.notebook, 'ÊâãÂ∏≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇÈõªË©±Â±•Ê≠¥„ÅåÁ¢∫Ë™ç„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü');

                        }),
                        description: 'ÊâãÂ∏≥',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.gotNotebook,
                        item: { img: 'notebook', visible: () => !gameState.main.flags.gotNotebook }
                    },
                    {
                        x: 47.1, y: 44.5, width: 5.9, height: 2.7,
                        onClick: clickWrap(function () {
                            showObj(null, 'ÈùûÂ∏∏Âè£„Çµ„Ç§„É≥„Åã„Å™Ôºü', IMAGES.modals.corridorSign, 'ÈùûÂ∏∏Âè£„Çµ„Ç§„É≥„Åã„Å™Ôºü');
                        }),
                        description: 'ÈùûÂ∏∏Âè£„Çµ„Ç§„É≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                ]
            },
            restaurantEntrance: {
                name: '„É¨„Çπ„Éà„É©„É≥ÂÖ•„ÇäÂè£',
                description: '',
                clickableAreas: [
                    {
                        x: 32.3, y: 32.3, width: 37.0, height: 43.2,
                        onClick: clickWrap(function () {
                            changeRoom('restaurant');
                        }),
                        description: '„É¨„Çπ„Éà„É©„É≥„Éâ„Ç¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 74.0, y: 35.4, width: 8.1, height: 10.8,
                        onClick: clickWrap(function () {
                            showObj(null, '‰ªäÊó•„ÅÆ„Åä„Åô„Åô„ÇÅ„ÅØA„Çª„ÉÉ„Éà„Çâ„Åó„ÅÑ', IMAGES.modals.aSet, '„É¨„Çπ„Éà„É©„É≥„ÅÆ„Åä„Åô„Åô„ÇÅ„Çª„ÉÉ„Éà„ÅåË≤º„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇ‰∏≠„ÅßÈ£ü„Åπ„Çâ„Çå„Çã„Åã„Å™Ôºü');

                        }),
                        description: '„Éâ„Ç¢Ê®™Ë≤º„ÇäÁ¥ô',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 72.8, y: 48.4, width: 13.7, height: 27.4,
                        onClick: clickWrap(function () {
                            updateMessage('Ë¶≥ËëâÊ§çÁâ©„Å†„ÄÇ„Çà„Åè„Çà„ÅèË¶ã„Çã„Å®„ÄÅ„Éï„Çß„Ç§„ÇØ„Ç∞„É™„Éº„É≥„ÅÆ„Çà„ÅÜ„Å†');
                        }),
                        description: 'Ê§çÁâ©Âè≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 15.0, y: 48.6, width: 12.0, height: 26.5,
                        onClick: clickWrap(function () {
                            updateMessage('Ë¶≥ËëâÊ§çÁâ©„Å†„ÄÇ„Çà„ÅèË¶ã„Çã„Å®„ÄÅ„Éï„Çß„Ç§„ÇØ„Ç∞„É™„Éº„É≥„ÅÆ„Çà„ÅÜ„Å†');
                        }),
                        description: 'Ê§çÁâ©Â∑¶',
                        zIndex: 2,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0.4, y: 64.4, width: 24.9, height: 20.7,
                        onClick: clickWrap(function () {
                            updateMessage('„Éô„É≥„ÉÅ„Å†„ÄÇ');
                        }),
                        description: '„Éô„É≥„ÉÅ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('corridor');
                        }, { allowAtNight: true }),
                        description: '„É¨„Çπ„Éà„É©„É≥ÂÖ•„ÇäÂè£Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            restaurant: {
                name: '„É¨„Çπ„Éà„É©„É≥ÂÆ¢Â∏≠',
                description: '',
                clickableAreas: [
                    {
                        x: 8.4, y: 77.6, width: 5.2, height: 5.9,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.check4, '‰ºùÁ•®„Å†');
                        }),
                        description: '4Áï™‰ºùÁ•®',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 80.9, y: 77.2, width: 6.1, height: 4.3,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.check8, '‰ºùÁ•®„Å†');
                        }),
                        description: '8Áï™‰ºùÁ•®',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 89.0, y: 76.5, width: 10.4, height: 4.4,
                        onClick: clickWrap(function () {
                            updateMessage('„Ç±„Éº„Ç≠„Çª„ÉÉ„Éà„Åã„Å™Ôºü');
                        }),
                        description: '„Ç±„Éº„Ç≠„ÅÆÈ£ü„ÅπÊÆã„Åó',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 68.1, y: 65.9, width: 4.9, height: 3.7,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.check9, '‰ºùÁ•®„Å†');
                        }),
                        description: '9Áï™‰ºùÁ•®',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 17.4, y: 48.1, width: 7.1, height: 8.4,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.restaurantWindow6, 'Ëàπ„Åå6ÈöªË¶ã„Åà„Çã');
                        }),
                        description: 'Á™ìÂ∑¶„Åã„Çâ1',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 27.9, y: 48.3, width: 8.2, height: 8.6,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.restaurantWindow4, 'Ëàπ„Åå4ÈöªË¶ã„Åà„Çã');
                        }),
                        description: 'Á™ìÂ∑¶„Åã„Çâ2',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 39.6, y: 48.3, width: 8.1, height: 8.6,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.restaurantWindow2, 'Ëàπ„Åå2ÈöªË¶ã„Åà„Çã');
                        }),
                        description: 'Á™ìÂ∑¶„Åã„Çâ3',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 51.9, y: 48.4, width: 7.9, height: 8.5,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.restaurantWindow3, 'Ëàπ„Åå3ÈöªË¶ã„Åà„Çã');
                        }),
                        description: 'Á™ìÂ∑¶„Åã„Çâ4',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 63.1, y: 48.3, width: 8.5, height: 8.7,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.restaurantWindow1, 'Ëàπ„Åå1ÈöªË¶ã„Åà„Çã');
                        }),
                        description: 'Á™ìÂ∑¶„Åã„Çâ5',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 75.0, y: 48.5, width: 7.2, height: 7.9,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.restaurantWindow5, 'Ëàπ„Åå5ÈöªË¶ã„Åà„Çã');
                        }),
                        description: 'Á™ìÂ∑¶„Åã„Çâ6',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('kitchen');
                        }, { allowAtNight: true }),
                        description: '„É¨„Çπ„Éà„É©„É≥ÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('deckDoor');
                        }, { allowAtNight: true }),
                        description: '„É¨„Çπ„Éà„É©„É≥ÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('restaurantEntrance');
                        }, { allowAtNight: true }),
                        description: '„É¨„Çπ„Éà„É©„É≥Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            kitchen: {
                name: '„É¨„Çπ„Éà„É©„É≥„Ç≠„ÉÉ„ÉÅ„É≥',
                description: '',
                clickableAreas: [
                    {
                        x: 61.6, y: 38.7, width: 13.9, height: 13.6,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.memoKitchen, '„Ç∑„Çß„Éï„ÅÆ„É°„É¢„ÅÆ„Çà„ÅÜ„Å†');
                        }),
                        description: '„Ç∑„Çß„Éï„ÅÆË≤º„ÇäÁ¥ô',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('kitchenLeft');
                        }, { allowAtNight: true }),
                        description: '„Ç≠„ÉÉ„ÉÅ„É≥ÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 0.2, y: 31.3, width: 25.8, height: 12.0,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.kitchenBottles, '„Éú„Éà„É´„Åå‰∏¶„Çì„Åß„ÅÑ„Çã');
                        }),
                        description: 'ÂÜ∑ËîµÂ∫´‰∏ä„ÅÆÁì∂',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 2.2, y: 60.5, width: 23.3, height: 10.9,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockFrozen) {
                                acquireItemOnce('foundKeyFrozen', 'keyFrozen', 'Âáç„Å£„ÅüÈçµ„ÇíË¶ã„Å§„Åë„Åü', IMAGES.modals.freezerInner, 'Âáç„Å£„ÅüÈçµ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                            } else {
                                showFrozenPuzzle();
                            }

                        }),
                        description: 'ÂÜ∑ÂáçÂ∫´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 2.0, y: 73.6, width: 23.4, height: 23.1,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockRefrigerator) {
                                acquireItemOnce('foundFoodSet', 'foodSet', 'A„Çª„ÉÉ„Éà„ÅÆÈ£üÊùê„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.foodSet, 'A„Çª„ÉÉ„Éà„ÅÆÈ£üÊùê„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                            } else {
                                showRefrigeratorPuzzle();
                            }

                        }),
                        description: 'ÂÜ∑ËîµÂ∫´',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 75.0, y: 65.1, width: 6.3, height: 1.0,
                        onClick: clickWrap(function () {

                        }),
                        description: 'ËÇâ',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'brownBack', visible: () => !gameState.main.flags.foundSteak }
                    },
                    {
                        x: 71.3, y: 63.1, width: 19.9, height: 5.8,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundSteak', 'steak', 'ÁÑº„Åç„Åü„Å¶„Çπ„ÉÜ„Éº„Ç≠„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.steak, 'ÁÑº„Åç„Åü„Å¶„Çπ„ÉÜ„Éº„Ç≠„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        }),
                        description: '„Éï„É©„Ç§„Éë„É≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 54.5, y: 58.5, width: 15.1, height: 9.6,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'keyFrozen') {
                                showModal(
                                    'Âáç„Å£„ÅüÈçµ„ÇíÊ∏©„ÇÅ„Åü',
                                    `
                                        <div class="modal-anim fast">
                                            <img src="${IMAGES.items.keyFrozen}">
                                            <img src="${IMAGES.items.key}">
                                        </div>
                                        `,
                                    [
                                        {
                                            text: 'Èñâ„Åò„Çã',
                                            action: 'close',
                                        }
                                    ]
                                );
                                updateMessage('Èçµ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                                gameState.main.flags.foundKey = true;
                                removeItem('keyFrozen');
                                addItem('key');

                            } else {
                                updateMessage('Èçã„Å´„ÅØ„ÅäÊπØ„ÅåÊ≤∏„ÅÑ„Å¶„ÅÑ„Çã');
                            }
                        }),
                        description: 'Èçã',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 31.4, y: 67.0, width: 13.8, height: 4.2,
                        onClick: clickWrap(function () {
                            if (!gameState.main.flags.unlockRefrigerator) {
                                updateMessage("Á∂∫È∫ó„Å™„ÅäÁöø„Åå„ÅÇ„Çã„ÄÇÈ£üÊùê„Åå„ÅÇ„Çå„Å∞Áõõ„Çä‰ªò„Åë„Çâ„Çå„Åù„ÅÜ„Å†„ÅÜ„ÄÇ");
                                return;
                            }
                            if (!gameState.main.flags.foundFoodSet || !gameState.main.flags.foundSteak) {
                                updateMessage("„Åæ„Å†Áõõ„Çä‰ªò„Åë„ÇãÈ£üÊùê„ÅåÊèÉ„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÄÇ");
                                return;
                            }
                            if (gameState.main.flags.completedPlating) {
                                updateMessage("Á∂∫È∫ó„Å´Âπ≥„Çâ„Åí„Çâ„Çå„Å¶„Åó„Åæ„Å£„Åü‚Ä¶");
                                return;
                            }
                            showPlatingPuzzle();

                        }),
                        description: '„ÅäÁöø',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 34.1, y: 68.4, width: 8.3, height: 1.5,
                        onClick: clickWrap(function () {

                        }),
                        description: 'È£ü„ÅπÊÆã„Åó',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'plateAfter', visible: () => gameState.main.flags.completedPlating }
                    },
                    {
                        x: 36.9, y: 35.2, width: 22.5, height: 19.0,
                        onClick: clickWrap(function () {
                            updateMessage('Á∂∫È∫ó„Å´„ÅäÊâãÂÖ•„Çå„Åï„Çå„Åü„Éï„É©„Ç§„Éë„É≥„Å†');
                        }),
                        description: '„Éï„É©„Ç§„Éë„É≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('restaurant');
                        }, { allowAtNight: true }),
                        description: '„Ç≠„ÉÉ„ÉÅ„É≥Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            kitchenLeft: {
                name: '„É¨„Çπ„Éà„É©„É≥„Ç≠„ÉÉ„ÉÅ„É≥Â••',
                description: '',
                clickableAreas: [
                    {
                        x: 69.1, y: 42.1, width: 12.2, height: 11.7,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.pancakePlan, 'È£ü‰∫ã„ÅÆ‰∫àÂÆöË°®„Åã„Å™Ôºü');

                        }),
                        description: '„Éë„É≥„Ç±„Éº„Ç≠„Éó„É©„É≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'pancakePlan', visible: () => true }
                    },
                    {
                        x: 25.8, y: 39.5, width: 7.1, height: 7.0,
                        onClick: clickWrap(function () {
                            showStorageDoorPanelPuzzle();

                        }),
                        description: 'ÂÖ•Âäõ„Éë„Éç„É´',
                        zIndex: 1,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 28.6, y: 40.8, width: 1.1, height: 0.8,
                        onClick: clickWrap(function () {

                        }),
                        description: 'ÂÖ•Âäõ„Éë„Éç„É´„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'redBack', visible: () => !gameState.main.flags.unlockStorageDoor }
                    },
                    {
                        x: 28.6, y: 40.8, width: 1.1, height: 0.8,
                        onClick: clickWrap(function () {

                        }),
                        description: 'ÂÖ•Âäõ„Éë„Éç„É´„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'greenBack', visible: () => gameState.main.flags.unlockStorageDoor }
                    },
                    {
                        x: 39.3, y: 35.4, width: 24.6, height: 50.4,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockStorageDoor) {
                                changeRoom('storage');
                            } else {
                                updateMessage('Èñã„Åã„Å™„ÅÑ');
                            }

                        }),
                        description: '„Éâ„Ç¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('kitchen');
                        }, { allowAtNight: true }),
                        description: '„Ç≠„ÉÉ„ÉÅ„É≥Â••ÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },

                ]
            },
            deckDoor: {
                name: '„É¨„Çπ„Éà„É©„É≥Â••',
                description: '„Éá„ÉÉ„Ç≠„Å∏„ÅÆ„Éâ„Ç¢„Åå„ÅÇ„Çã',
                clickableAreas: [
                    {
                        x: 74.1, y: 45.0, width: 15.1, height: 12.8,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.posterExplore, '„Éù„Çπ„Çø„Éº„ÅåË≤º„Å£„Å¶„ÅÇ„Çã');
                        }),
                        description: 'Ë¶≥ÂÖâ„Éù„Çπ„Çø„Éº',
                        zIndex: 1,
                        usable: () => true,
                        item: { img: 'posterExplore', visible: () => true }
                    },
                    {
                        x: 72.5, y: 57.9, width: 10.8, height: 11.3,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.posterSuggestion, '„Éù„Çπ„Çø„Éº„ÅåË≤º„Å£„Å¶„ÅÇ„Çã');
                        }),
                        description: 'ÊÑèË¶ãÁÆ±„Éù„Çπ„Çø„Éº',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'posterSuggestion', visible: () => true }
                    },
                    {
                        x: 34.0, y: 43.8, width: 33.8, height: 54.4,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDeckDoor) {
                                changeRoom('deck');
                            } else {
                                updateMessage('Èñã„Åã„Å™„ÅÑ„ÄÇ„Ç´„Éº„Éâ„Ç≠„Éº„ÅåÂøÖË¶Å„Å†');
                            }
                        }),
                        description: '„Éâ„Ç¢',
                        zIndex: 1,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 35.2, y: 64.5, width: 6.3, height: 9.1,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDeckDoor) {
                                updateMessage('„É≠„ÉÉ„ÇØ„ÅØËß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã');
                            } else if (gameState.selectedItem == 'cardkey') {
                                showModal(
                                    '„Ç´„Éº„Éâ„Ç≠„Éº„Çí„Åã„Åñ„Åó„Åü',
                                    ``,
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                                playSE('se-cyber')
                                gameState.main.flags.unlockDeckDoor = true;
                                renderCanvasRoom();
                                updateMessage('„Ç´„Éº„Éâ„Ç≠„Éº„Åß„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü');

                            } else {
                                updateMessage('„É≠„ÉÉ„ÇØ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                            }
                        }),
                        description: '„Ç´„Éº„Éâ„É™„Éº„ÉÄ„Éº',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 37.9, y: 71.0, width: 1.1, height: 1.0,
                        onClick: clickWrap(function () {

                        }),
                        description: '„Ç´„Éº„Éâ„É™„Éº„ÉÄ„Éº„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºËµ§',
                        zIndex: 6,
                        usable: () => false,
                        item: { img: 'redBack', visible: () => !gameState.main.flags.unlockDeckDoor }
                    },
                    {
                        x: 37.9, y: 71.0, width: 1.1, height: 1.0,
                        onClick: clickWrap(function () {

                        }),
                        description: '„Ç´„Éº„Éâ„É™„Éº„ÉÄ„Éº„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÁ∑ë',
                        zIndex: 6,
                        usable: () => false,
                        item: { img: 'greenBack', visible: () => gameState.main.flags.unlockDeckDoor }
                    },
                    {
                        x: 84.8, y: 61.7, width: 14.2, height: 29.9,
                        onClick: clickWrap(function () {
                            updateMessage('„Éï„Çß„Ç§„ÇØ„Ç∞„É™„Éº„É≥„ÅÆ„Çà„ÅÜ„Å†');
                        }),
                        description: 'Ê§çÁâ©Âè≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0.9, y: 59.3, width: 16.7, height: 35.2,
                        onClick: clickWrap(function () {
                            updateMessage('ÂÆüÁâ©„ÅÆ„Çà„ÅÜ„Å´„ÇÇË¶ã„Åà„Çã„Åå„ÄÅ„Éï„Çß„Ç§„ÇØ„Ç∞„É™„Éº„É≥„ÅÆ„Çà„ÅÜ„Å†')
                        }),
                        description: 'Ê§çÁâ©Â∑¶',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('restaurant');
                        }, { allowAtNight: true }),
                        description: '„É¨„Çπ„Éà„É©„É≥Â••ÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },

                ]
            },
            deck: {
                name: '„Éá„ÉÉ„Ç≠',
                description: '',
                clickableAreas: [
                    {
                        x: 27.7, y: 62.2, width: 30.0, height: 24.8,
                        onClick: clickWrap(function () {
                            updateMessage('Â§ß„Åç„Å™È≥•„ÅåÂØù„Å¶„ÅÑ„Çã„ÄÇÈÄö„Çå„Å™„ÅÑ„ÄÇËµ∑„Åì„ÅôÊñπÊ≥ï„ÅØ„Å™„ÅÑ„Å†„Çç„ÅÜ„Åã„ÄÇ');

                        }),
                        description: 'È≥•',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.goneBird,
                        item: { img: 'bird', visible: () => !gameState.main.flags.goneBird }
                    },
                    {
                        x: 38.0, y: 77.4, width: 11.0, height: 6.5,
                        onClick: clickWrap(function () {

                        }),
                        description: 'ÁæΩ',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'feather', visible: () => gameState.main.flags.goneBird }
                    },
                    {
                        x: 12.3, y: 21.5, width: 25.6, height: 50.8,
                        onClick: clickWrap(function () {
                            changeRoom('wheelhouse');
                        }),
                        description: 'ÊìçËàµÂÆ§„Å∏„ÅÆÈöéÊÆµ',
                        zIndex: 5,
                        usable: () => gameState.main.flags.goneBird,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 40.2, y: 5.3, width: 58.9, height: 44.0,
                        onClick: clickWrap(function () {
                            updateMessage('„Åç„Çå„ÅÑ„Å™Á©∫„Å†');
                        }),
                        description: 'Á©∫',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 1.2, y: 52.9, width: 10.5, height: 14.6,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.setReceiver) {
                                showPhoneDialModal();
                            } else {
                                showModal(
                                    'ÂèóË©±Âô®„ÅåÂ∞ë„Åó„Åö„Çå„Å¶„ÅÑ„Çã‚Ä¶',
                                    '<p>ÂèóË©±Âô®„ÇíÊ≠£„Åó„ÅèÊàª„Åó„Åæ„Åô„ÅãÔºü</p>',
                                    [
                                        {
                                            text: '„ÅØ„ÅÑ',
                                            action: () => {
                                                gameState.main.flags.setReceiver = true;
                                                updateMessage('ÂèóË©±Âô®„ÇíÊ≠£„Åó„ÅèÊàª„Åó„Åü„ÄÇ');
                                                playSE('se-receiver');
                                                closeModal();
                                            }
                                        },
                                        {
                                            text: '„ÅÑ„ÅÑ„Åà',
                                            action: 'close'
                                        }
                                    ]
                                );
                            }

                        }),
                        description: '„Éá„ÉÉ„Ç≠ÈõªË©±',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('deckDoor');
                        }, { allowAtNight: true }),
                        description: '„Éá„ÉÉ„Ç≠Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }

                ]
            },
            wheelhouse: {
                name: 'ÊìçËàµÂÆ§',
                description: '',
                clickableAreas: [
                    {
                        x: 45.8, y: 63.3, width: 9.0, height: 9.0,
                        onClick: clickWrap(function () {
                            showDistressModal();
                        }),
                        description: 'distress„Éú„Çø„É≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 62.8, y: 60.2, width: 18.7, height: 13.4,
                        onClick: clickWrap(function () {
                            showCoordinateInputModal();
                        }),
                        description: 'Â∫ßÊ®ôÂÖ•ÂäõÊ©ü',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 3.3, y: 53.1, width: 31.4, height: 32.3,
                        onClick: clickWrap(function () {
                            updateMessage('Ëá™ÂãïÈÅãËª¢„Åã„Å™Ôºü');
                        }),
                        description: 'ÊìçÁ∏¶„Åã„Çì',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 84.0, y: 51.1, width: 13.6, height: 26.6,
                        onClick: clickWrap(function () {
                            updateMessage('ÁÑ°Á∑ö„Åå„ÅÇ„Çã„ÄÇ‰Ωø„ÅÑÊñπ„ÅåÂàÜ„Åã„Çâ„Å™„ÅÑ„Å™‚Ä¶');
                        }),
                        description: 'ÁÑ°Á∑ö',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 66.0, y: 32.3, width: 22.5, height: 24.1,
                        onClick: clickWrap(function () {
                            talkToHintCharacter('main', 'bear');
                        }),
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'bear', visible: () => true }
                    },
                    {
                        x: 12.6, y: 22.6, width: 75.4, height: 27.5,
                        onClick: clickWrap(function () {
                            updateMessage('Ë¶ñÁïåËâØÂ•Ω„Å†„ÄÇ‰∏ÄÈÉ®ÈÅÆ„Çâ„Çå„Å¶„ÅÑ„Çã„Åë„Å©„ÄÇ');

                        }),
                        description: 'Ë¶ñÁïå',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('deck');
                        }, { allowAtNight: true }),
                        description: 'ÊìçËàµÂÆ§Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }

                ]
            },
            room288: {
                name: '288Âè∑ÂÆ§',
                description: '',
                clickableAreas: [
                    {
                        x: 38.5, y: 54.4, width: 27.9, height: 9.9,
                        onClick: clickWrap(function () {
                            changeRoom('map');
                        }),
                        description: 'Êµ∑Âõ≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 28.3, y: 26.2, width: 21.7, height: 17.5,
                        onClick: clickWrap(function () {
                            updateMessage('Èõ≤„ÅÆÊßòÂ≠ê„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã');
                        }),
                        description: '„É¢„Éã„ÇøÂ∑¶',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 51.3, y: 25.9, width: 21.5, height: 18.4,
                        onClick: clickWrap(function () {
                            updateMessage('Êó¢Ë¶ñÊÑü„ÅÆ„ÅÇ„ÇãÁîªÈù¢„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã');
                        }),
                        description: '„É¢„Éã„ÇøÂè≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 27.5, y: 60.4, width: 5.3, height: 3.4,
                        onClick: clickWrap(function () {
                            updateMessage('„Äå12/11 ÂÆùÂ≥∂„ÅÆ‰ΩçÁΩÆ„Å´„Å§„ÅÑ„Å¶„ÅÆÂïè„ÅÑÂêà„Çè„Åõ„ÅÇ„Çä„ÄÇ„Åù„Çì„Å™Â≥∂„ÅØÂú∞Âõ≥„Å´„ÅØË®òËºâ„Åå„Å™„ÅÑ„Å®ËøîÁ≠îÊ∏à„Åø„Äç');
                        }),
                        description: '„É°„É¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('corridor');
                        }, { allowAtNight: true }),
                        description: '288Âè∑ÂÆ§Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }

                ]
            },
            map: {
                name: 'Êµ∑Âõ≥',
                description: '',
                clickableAreas: [
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('room288');
                        }, { allowAtNight: true }),
                        description: 'mapÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }

                ]
            },
            storage: {
                name: 'ÂÄâÂ∫´',
                description: '',
                clickableAreas: [
                    {
                        x: 39.2, y: 62.8, width: 4.5, height: 5.8,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.momokoCard, 'Áµµ„Éè„Ç¨„Ç≠„Å†');
                        }),
                        description: '„Éù„Çπ„Éà„Ç´„Éº„Éâ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'momokoCard', visible: () => true }
                    },
                    {
                        x: 50.5, y: 58.9, width: 12.3, height: 10.7,
                        onClick: clickWrap(function () {
                            updateMessage('ÂÆù„ÅÆÂú∞Âõ≥„ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„Åå„ÅÇ„Çã');
                        }),
                        description: 'Âú∞Âõ≥',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('kitchenLeft');
                        }, { allowAtNight: true }),
                        description: 'ÂÄâÂ∫´Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }

                ]
            },

            endGood: {
                name: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ+',
                description: '„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÁÑ°‰∫ã„Å´ËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇÊÇ™„ÅÆÊ†πÊ∫ê„ÇÇÂá¶ÂàÜ„Åß„Åç„Åæ„Åó„Åü',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            updateMessage('„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÁÑ°‰∫ã„Å´ËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇÊÇ™„ÅÆÊ†πÊ∫ê„ÇÇÂá¶ÂàÜ„Åß„Åç„Åæ„Åó„Åü');
                            showEndingReport('endGood');
                        }),
                        description: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ+',
                        usable: () => true,
                    },

                ]
            },
            end: {
                name: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ',
                description: '„Åæ„ÇÇ„Å™„ÅèÊïëÂä©„Åå„Åè„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ„ÅÇ„Å™„Åü„ÅØÁÑ°‰∫ã„Å´ÂÆ¢ÂÆ§„Åã„ÇâËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            showEndingReport('end');
                        }),
                        description: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ-'
                    },
                ]
            },
            trueEnd: {
                name: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                description: '„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇËàπ„Åã„ÇâËÑ±Âá∫„ÄÅÁÑ°‰∫ã„Å´ÂÆùÂ≥∂„Å´Âà∞ÁùÄ„Åß„Åç„Åù„ÅÜ„Åß„Åô„ÄÇ„Å©„Çì„Å™ÂÆù„Åå„ÅÇ„Çã„Åß„Åó„Çá„ÅÜÔºü',
                clickableAreas: [
                    {
                        x: 81.1, y: 61.4, width: 15.5, height: 10.9,
                        onClick: clickWrap(function () {
                            updateMessage('Ë™∞„Åã‰Ωè„Çì„Åß„ÅÑ„Çã„ÅÆ„Åã„Å™Ôºü');
                        }),
                        description: '„ÉÜ„É≥„Éà',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            updateMessage('„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÂÆùÂ≥∂„Å´Âà∞ÁùÄ„Åß„Åç„Åæ„Åó„Åü„ÄÇ');
                            gameState.trueEnd.flags.backgroundState++;
                            quickBlackFade();
                            renderCanvasRoom();

                        }),
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                        usable: () => gameState.trueEnd.flags.backgroundState == 0,
                    },
                    {
                        x: 55.9, y: 75.7, width: 15.1, height: 16.6,
                        onClick: clickWrap(function () {
                            updateMessage('„ÅäÂÆùÔºÅ„Å©„Åì„Å†„Çç„ÅÜÔºü');
                        }),
                        description: '„Éï„É©„ÇØ„Éû',
                        zIndex: 5,
                        usable: () => gameState.trueEnd.flags.backgroundState == 1,

                    },
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            updateMessage('„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇËàπ„Åã„ÇâËÑ±Âá∫„ÄÅÁÑ°‰∫ã„Å´ÂÆùÂ≥∂„Å´Âà∞ÁùÄ„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Å©„Çì„Å™ÂÆù„Åå„ÅÇ„Çã„Åß„Åó„Çá„ÅÜÔºü');
                            showEndingReport('trueEnd');
                        }),
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                        usable: () => gameState.trueEnd.flags.backgroundState == 1,
                    },

                ]
            },


        };

        const hintMessages = {
            main: {
                bear: [
                    '„ÅäËÖπ„ÅÑ„Å£„Å±„ÅÑ„Å†„Çà',
                    'ËÑ±Âá∫„Åô„Çã„ÅÆÔºü',
                    '„É¨„ÉÉ„ÉÑ„Ç¥„Éº',
                ],
            },
        };



        // Ë∂≥Èü≥„ÅßÊï∞Ê≠©‚Üí„ÉØ„Éº„ÉóÊºîÂá∫‚ÜíÁõÆÁöÑ„ÅÆÈÉ®Â±ã„Å∏
        function travelWithSteps(destRoom = 'saint') {
            const canvasEl = document.getElementById('gameCanvas');
            const overlay = document.getElementById('roomEffectOverlay');

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-ashioto');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#000';  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;

                if (step >= 3) {
                    clearInterval(stepTimer);

                    if (overlay) {
                        changeRoom(destRoom);
                    }

                    setTimeout(() => {

                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            // overlay.style.background = '';
                            overlay.style.opacity = 0;

                        }

                    }, 100);
                }
            }, 160);
        }

        function travelWithStepsTrueEnd() {
            const overlay = document.getElementById('roomEffectOverlay');
            let destRoom = 'trueEnd';

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-nami');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#000';  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;


                if (step >= 3) {
                    clearInterval(stepTimer);

                    // Èªí‚Üí„ÉØ„Éº„ÉóÂÖâ„Å∏ÂàáÊõø
                    if (overlay) {
                        overlay.classList.add('warp-active');
                        changeRoom(destRoom);
                        overlay.style.background = '';   // warp „ÅÆÁôΩÁô∫ÂÖâ„Å´Êàª„Åô
                    }

                    setTimeout(() => {


                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            overlay.classList.remove('warp-active');
                            overlay.style.opacity = 0;
                        }

                    }, 900);
                }
            }, 260);
        }

        function quickBlackFade(duration = 300) {
            const fade = document.getElementById('roomEffectOverlay');
            if (!fade) return;

            // „Åæ„Åö‰∏ÄÁû¨„ÅßÈªí„Åè„Åô„Çã
            fade.style.background = '#000';
            fade.style.opacity = '1';

            // duration ms Âæå„Å´ÈÄèÊòé„Å∏Êàª„Åô
            setTimeout(() => {
                fade.style.opacity = '0';
            }, duration);
        }

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            renderNavigation();
            changeRoom('guestRoom');
            updateMessage('Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÂÆ¢ÂÆ§„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü');

        }

        function findHitArea(x, y, clickableAreas, canvas) {
            // zIndexÈôçÈ†Ü„Åß
            const sorted = clickableAreas.slice().sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            for (const area of sorted) {
                // ÂøÖË¶Å„Å™„ÇâusableÂà§ÂÆö„ÇÇ„Åì„Åì„Åß
                const usable = area.usable === undefined ? true :
                    (typeof area.usable === "function" ? area.usable() : area.usable);

                if (!usable) continue; // ‰Ωø„Åà„Å™„ÅÑ„Ç®„É™„Ç¢„ÅØÂà§ÂÆö„Åó„Å™„ÅÑ
                const ax = area.x / 100 * canvas.width;
                const ay = area.y / 100 * canvas.height;
                const aw = area.width / 100 * canvas.width;
                const ah = area.height / 100 * canvas.height;
                if (x >= ax && x <= ax + aw && y >= ay && y <= ay + ah) {
                    return area; // ÊúÄÂàù„Å´„Éí„ÉÉ„Éà„Åó„Åü„ÇÇ„ÅÆ„Å†„ÅëËøî„ÅôÔºÅ
                }
            }
            return null;
        }

        let hoveredAreaIndex = null;  // ‰ªähover„Åó„Å¶„Çã„Ç®„É™„Ç¢Ôºà„Å™„Åë„Çå„Å∞nullÔºâ
        canvas.addEventListener('mousemove', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);
            const idx = area ? room.clickableAreas.indexOf(area) : null;
            if (hoveredAreaIndex !== idx) {
                hoveredAreaIndex = idx;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('mouseout', function () {
            if (hoveredAreaIndex !== null) {
                hoveredAreaIndex = null;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('click', function (e) {

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // ‚òÖ‰ªä„ÅÑ„ÇãÈÉ®Â±ã„ÅÆ„Ç®„É™„Ç¢„Å†„ÅëÂà§ÂÆöÔºÅ
            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);

            // if (area) {
            //     handleAreaClick(area.action, e);
            // }
            if (area) {
                if (typeof area.onClick === 'function') {
                    area.onClick(e);
                    playSE('se-click');
                } else if (area.action) {
                    handleAreaClick(area.action, e); // ‰∫íÊèõ„ÅÆ„Åü„ÇÅ„Å´ÊÆã„Åó„Å¶„ÇÇOK
                }
            }
        });

        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];

            // ËÉåÊôØÔºã„Ç¢„Ç§„ÉÜ„É†Ôºã„ÇØ„É™„ÉÉ„ÇØ„Ç®„É™„Ç¢„Çícanvas„ÅßÂÖ®ÈÉ®ÂÜçÊèèÁîª
            renderCanvasRoom();
            const msg = (room.name && room.name.trim() !== "")
                ? `${room.name}„Åß„Åô„ÄÇ${room.description}`
                : room.description;
            if (roomId === 'trueEnd') {
                updateMessageHTML(msg);
            } else {
                updateMessage(msg);
            }

            // BGMÂàáÊõø„ÅØ„Åù„ÅÆ„Åæ„Åæ
            if (roomId === "trueEnd") {
                changeBGM("sounds/23/Budding.mp3");

            } else if (roomId === "end") {
                changeBGM("sounds/23/namini_yurareru.mp3");

            } else if (roomId === "deck" || roomId === 'wheelhouse') {
                changeBGM("sounds/23/Aromatum_Chaos.mp3");

            } else {
                if (gameState.main.flags.isNight) {
                    changeBGM("sounds/23/The_night_and_quiet.mp3");
                } else {
                    changeBGM("sounds/23/Paper_craft.mp3");
                }

            }

            // nav
            if (roomId === "corridor" || roomId === "restaurant" || roomId === "storage" || roomId === "wheelhouse" || roomId === "deck") {
                addNaviItem(roomId);
                // renderNavigation();
            }
            if (roomId === "trueEnd" || roomId === "endGood" || roomId === "end") {
                gameState.openRooms = [];
                // renderNavigation();
            }

            renderNavigation();

        }

        const END_IDS = new Set(['endGood', 'trueEnd', 'endWorse']);

        // ===== changeRoom „Éï„ÉÉ„ÇØÔºö=====
        const _changeRoom_custom = changeRoom;
        changeRoom = function (roomId) {
            _changeRoom_custom.apply(this, arguments);


            if (END_IDS.has(roomId)) {
                const elapsed = Math.round((Date.now() - ANA.start) / 1000);
                ANA.endTimes = ANA.endTimes || {};
                if (!ANA.endTimes[roomId]) ANA.endTimes[roomId] = elapsed;

                const isTrue = (roomId === 'trueEnd');
                ANA.send('ending_reached', {
                    ending_id: roomId,
                    is_true: isTrue,
                    elapsed_sec: elapsed,
                    hints: ANA.hintCount,

                });
                // setTimeout(() => showFeedbackModal(roomId), 1500);
            }
        };

        function renderCanvasRoom() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const roomId = gameState.currentRoom;
            const room = rooms[roomId];
            const bgImgSrc = getRoomBackgroundImage(roomId, gameState);

            ctx.clearRect(0, 0, canvas.width, canvas.height);


            // ËÉåÊôØÊèèÁîª
            const bgImg = loadedImages[bgImgSrc];
            if (bgImg && bgImg.complete) {
                ctx.save();
                const phase = gameState.main?.flags?.timePhase ?? 0;
                const isNight = (phase === 2);
                if (isNight) {
                    ctx.filter = 'saturate(0.3) brightness(0.6)'; // ËÉåÊôØ„ÅØ„Å°„Çá„ÅÑÊöó„ÇÅ
                } else {
                    ctx.filter = 'none';
                }
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
                ctx.restore();
            }

            // „Ç¢„Ç§„ÉÜ„É†ÊèèÁîªÔºàÊú™ÂèñÂæó„ÅÆ„ÅøÔºâ
            drawRoomItems(ctx, canvas, roomId);

            // ‚òÖ „Åì„Åì„Åã„ÇâÈáç„Å™„ÇäÂÑ™ÂÖà„ÅÆhoverÊû†Á∑ö„ÇíÊèèÁîª
            if (hoveredAreaIndex !== null && hoveredAreaIndex !== undefined) {
                // zIndexÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
                const sortedAreas = room.clickableAreas
                    .map((area, i) => ({ ...area, __idx: i }))
                    .filter(area => area.usable === undefined ? true :
                        (typeof area.usable === "function" ? area.usable() : area.usable)
                    )
                    .sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
                // hoveredAreaIndex„Å®‰∏ÄËá¥„Åô„Çã„Ç®„É™„Ç¢„ÇízIndexÈ†Ü„Åß1„Å§„Å†„ÅëÊû†ÊèèÁîª
                const hoverArea = sortedAreas.find(area => area.__idx === hoveredAreaIndex);
                if (hoverArea) {
                    const ax = hoverArea.x / 100 * canvas.width;
                    const ay = hoverArea.y / 100 * canvas.height;
                    const aw = hoverArea.width / 100 * canvas.width;
                    const ah = hoverArea.height / 100 * canvas.height;
                    ctx.save();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(ax, ay, aw, ah);
                    ctx.restore();
                }
            }


            if (DEV_MODE) {
                ctx.save();
                ctx.lineWidth = 2;


                room.clickableAreas.forEach(a => {

                    ctx.strokeStyle = 'rgba(255,0,0,0.8)';
                    ctx.fillStyle = 'rgba(255,0,0,0.35)';
                    ctx.font = '14px sans-serif';
                    const px = a.x / 100 * canvas.width;
                    const py = a.y / 100 * canvas.height;
                    const pw = a.width / 100 * canvas.width;
                    const ph = a.height / 100 * canvas.height;

                    // ÂçäÈÄèÊòé„ÅÆÊû†
                    ctx.fillRect(px, py, pw, ph);
                    ctx.strokeRect(px, py, pw, ph);

                    // description Ë°®Á§∫
                    if (a.description) {
                        ctx.fillStyle = 'rgba(0,0,0,0.7)';
                        ctx.fillRect(px, py - 18, ctx.measureText(a.description).width + 8, 18);

                        ctx.fillStyle = 'white';
                        ctx.fillText(a.description, px + 4, py - 4);
                    }
                });

                ctx.restore();
            }

        }

        function drawRoomItems(ctx, canvas, roomId) {
            const room = rooms[roomId];
            room.clickableAreas.forEach(area => {
                if (area.item && area.item.visible && area.item.visible()) {
                    const key = (typeof area.item.img === 'function') ? area.item.img() : area.item.img;
                    const img = loadedImages[IMAGES.items[key]];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const alpha = area.alpha ? area.alpha : 1;
                        const px = area.x / 100 * canvas.width;
                        const py = area.y / 100 * canvas.height;
                        const w = area.width / 100 * canvas.width;
                        const h = area.height / 100 * canvas.height;
                        ctx.save();
                        ctx.globalAlpha = alpha;

                        // ‚òÖ Â§ú„É¢„Éº„Éâ„Å™„ÇâÂΩ©Â∫¶ÔºãÊòé„Çã„Åï„ÇíËêΩ„Å®„Åô
                        const phase = gameState.main?.flags?.timePhase ?? 0;
                        const isNight = (phase === 2);
                        if (isNight) {
                            // ÂÄ§„ÅØÂ•Ω„Åø„ÅßË™øÊï¥
                            ctx.filter = 'saturate(0.4) brightness(0.8)';
                        } else {
                            ctx.filter = 'none';
                        }

                        ctx.drawImage(img, px, py, w, h);
                        ctx.restore();
                    }
                }
            });
        }


        function getRoomBackgroundImage(roomId, gameState) {
            const imgList = IMAGES.rooms[roomId];

            // Âçò‰∏ÄÁîªÂÉè„Å™„Çâ„Åù„ÅÆ„Åæ„Åæ
            if (!Array.isArray(imgList)) {
                return imgList;
            }

            // ‚òÖ ‰∏∏Á™ì„ÅØÁâπÂà•Êâ±„ÅÑ
            if (roomId === 'window') {
                const flags = gameState.main?.flags || {};

                // Âµê„Éï„É©„Ç∞„ÅåÁ´ã„Å£„Å¶„ÅÑ„Çå„Å∞„ÄÅÂ∏∏„Å´ window_4.png
                if (flags.windowStorm) {
                    // imgList[3] = window_4.png ÂâçÊèê
                    return imgList[3] || imgList[imgList.length - 1];
                }

                // 0=Êòº(window_1), 1=Â§ïÊñπ(window_2), 2=Â§ú(window_3)
                const phase = (typeof flags.timePhase === 'number') ? flags.timePhase : 0;
                return imgList[phase] || imgList[0];
            }
            if (roomId === 'guestRoom') {
                const flags = gameState.main?.flags || {};
                const phase = (typeof flags.timePhase === 'number') ? flags.timePhase : 0;
                // Â§ú(2)„Å†„ÅëÊöó„ÅÑÈÉ®Â±ã„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÊòé„Çã„ÅÑÈÉ®Â±ã
                const idx = (phase === 2) ? 1 : 0;
                return imgList[idx] || imgList[0];
            }

            // ‚òÖ „Åù„ÅÆ‰ªñ„ÅÆÈÉ®Â±ã„ÅØÂæìÊù•ÈÄö„Çä backgroundState „ÇíË¶ã„Çã
            const state = gameState[roomId]?.flags?.backgroundState ?? 0;
            return imgList[state] || imgList[0];
        }


        // Â∞èÁâ©„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function pointInRect(x, y, r) {
            return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;
        }

        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
            ctx.beginPath();
            ctx.moveTo(x + r.tl, y);
            ctx.lineTo(x + w - r.tr, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
            ctx.lineTo(x + w, y + h - r.br);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
            ctx.lineTo(x + r.bl, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
            ctx.lineTo(x, y + r.tl);
            ctx.quadraticCurveTo(x, y, x + r.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        // „Éï„É©„ÉÉ„Ç∑„É•„É¨„Ç§„É§„ÇíÁî®ÊÑè
        (function ensureFlashLayer() {
            if (!document.getElementById('fxFlash')) {
                const d = document.createElement('div');
                d.id = 'fxFlash';
                document.body.appendChild(d);
            }
        })();

        // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Ôºàtype: 'white' | 'red'Ôºâ
        function screenFlash(type = 'white', durMs = 180) {
            const f = document.getElementById('fxFlash'); if (!f) return;
            f.style.animation = 'none'; // ÈÄ£ÊâìÂØæÁ≠ñ
            // Âº∑Âà∂reflow„Åß„Ç¢„Éã„É°ÂÜçÈÅ©Áî®
            // eslint-disable-next-line no-unused-expressions
            f.offsetHeight;
            const key = type === 'red' ? 'flashRed' : 'flashWhite';
            f.style.animation = `${key} ${durMs}ms ease`;
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„ÇíÊ•µÂ∞è„Ç∑„Çß„Ç§„ÇØ
            document.documentElement.classList.add('fx-shake');
            setTimeout(() => document.documentElement.classList.remove('fx-shake'), 120);
        }


        function toggleNight() {

            quickBlackFade();
            setTimeout(() => {
                const phase = gameState.main?.flags?.timePhase ?? 0;
                if (phase === 2) {
                    // Â§ú
                    changeBGM("sounds/23/The_night_and_quiet.mp3");
                    updateMessage('Ëá™Âãï„ÅßÊ∂àÁÅØ„Åï„Çå„Åü„Çà„ÅÜ„Å†„ÄÇ');
                } else {
                    // Êòº„ÉªÂ§ïÊñπ
                    if (gameState.currentRoom == 'guestRoom') changeBGM("sounds/23/Paper_craft.mp3");
                }
                renderCanvasRoom();
            }, 300);

        }

        function acquireItemOnce(flagKey, itemId, title, imgSrc, msg) {
            const f = gameState.main.flags;
            if (f[flagKey]) {
                if (itemId == 'glass') {
                    updateMessage('„Ç∞„É©„Çπ„ÅåÊ≤¢Â±±„ÅÇ„Çã');
                } else {
                    updateMessage('„ÇÇ„ÅÜ‰Ωï„ÇÇ„Å™„ÅÑ');
                }

                return;
            }
            f[flagKey] = true;
            addItem(itemId);
            renderCanvasRoom();

            showModal(
                title,
                `<img src="${imgSrc}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );
            updateMessage(msg);
        }

        function clickWrap(fn, { allowAtNight = false } = {}) {
            return function (...args) {
                if (gameState.main.flags.isNight && !allowAtNight) {
                    updateMessage('Êöó„Åè„Å¶„Çà„ÅèË¶ã„Åà„Å™„ÅÑ');
                    return;
                }
                fn.apply(this, args);


                // „Ç¢„Ç§„ÉÜ„É†ÈÅ∏ÊäûËß£Èô§„ÅØ‰ªä„Åæ„ÅßÈÄö„Çä
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            };
        }


        // „Ç¢„ÇØ„Ç∑„Éß„É≥Âêç ‚Üí ÂÆüË°åÈñ¢Êï∞
        const ACTION_HANDLERS = {
            // --- ÁßªÂãïÁ≥ª ---
            examine_start_door_left() {
                // changeRoom('startRight');
            },

        };

        // „Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleAreaClick(action, event) {
            const handler = ACTION_HANDLERS[action];
            playSE('se-click');

            // area.onClick ÊñπÂºèÔºàÂ∞ÜÊù•„ÅÆ„Åü„ÇÅÔºâ
            if (typeof action === 'function') {
                action(event);
                return;
            }

            // actionÂêçÔºàÂæìÊù•„ÅÆÊñπÂºèÔºâ„Å´„ÇÇÂØæÂøú
            const fn = ACTION_HANDLERS[action];
            if (fn) {
                fn(event);
                return;
            }
            console.warn('Êú™ÂÆöÁæ©„ÅÆaction:', action);
        }


        // „ÇØ„É™„Ç¢„É¨„Éù„Éº„ÉàË°®Á§∫
        function showEndingReport(endingId = 'end') {
            const elapsedSec = Math.round((Date.now() - (ANA.start || Date.now())) / 1000);
            const m = Math.floor(elapsedSec / 60);
            const s = elapsedSec % 60;
            const timeStr = `${m}ÂàÜ${s.toString().padStart(2, '0')}Áßí`;

            // ‰ªä‰ΩúÁî®„Ç®„É≥„ÉâÊÉÖÂ†±
            const ENDING_INFO = {
                trueEnd: {
                    title: "üéÑ TRUE END",
                    label: "TRUE END",
                    desc: "ÂÆùÂ≥∂„Å´Âà∞ÁùÄ„Åó„Åæ„Åó„Åü„ÄÇ„Å©„Çì„Å™„ÅäÂÆù„Åå„ÅÇ„Çã„ÅÆ„Åã„Å™Ôºü"
                },
                end: {
                    title: "üîî NORMAL END ",
                    label: "NORMAL END ",
                    desc: "„Åæ„ÇÇ„Å™„ÅèÊïëÂä©„ÅåÂà∞ÁùÄ„Åó„Åæ„Åô„ÄÇËâØ„Åã„Å£„Åü„Åß„Åô„Å≠„ÄÇ"
                },

            };

            const info = ENDING_INFO[endingId] || ENDING_INFO.end;

            // „Ç®„É≥„ÉâÂà•„Å≤„Å®„Åì„Å®
            let secretText = "";
            switch (endingId) {
                case "trueEnd":
                    secretText = "üéÅ „Çà„Åè„ÅûÂÆùÂ≥∂„ÅÆ‰ΩçÁΩÆ„ÇíÂ∞é„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åó„ÅüÔºÅ";
                    break;
                case "end":
                    secretText = "üö¢ ÊïëÂä©Ëàπ„Åå„Åò„Çä„Åò„Çä„Å®Ëøë„Å•„ÅÑ„Å¶„Åç„Åæ„Åô„ÄÇ";
                    break;

                default:
                    secretText = "";
            }

            // GAÈÄÅ‰ø°
            ANA.once('ending', endingId, {
                ending: endingId,
                time_sec: elapsedSec,
            });

            const html = `
        <div style="max-width:520px; text-align:center;">
            <h2 style="margin-top:0;">${info.title}</h2>
            <p style="margin:6px 0 12px 0; font-weight:bold;">${info.desc}</p>
            <p style="margin:4px 0;">„Éó„É¨„Ç§ÊôÇÈñìÔºö<b>${timeStr}</b></p>
            <p style="margin:4px 0;">„Éí„É≥„ÉàÂà©Áî®Ôºö<b>${ANA.hintCount || 0} Âõû</b></p>
            ${secretText ? `<p style="margin:12px 0; font-size:.9em; opacity:.85;">${secretText}</p>` : ""}
            
            
        </div>
    `;

            showModal("„Ç®„É≥„Éá„Ç£„É≥„Ç∞", html, [
                {
                    text: "„Ç¢„É≥„Ç±„Éº„Éà„Å´Á≠î„Åà„Çã",
                    action: () => openFeedbackForm(endingId),
                },
                {
                    text: "Èñâ„Åò„Çã",
                    action: () => {
                        closeModal();
                    },
                },
            ]);
        }

        // „ÇØ„É™„Ç¢„É≠„Ç∞ÁîüÊàêÔºàÊó¢Â≠ò„ÅÆ„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆ„Åæ„ÅæÊµÅÁî®„ÅßOKÔºâ
        function copyClearLog(label, timeStr) {
            const text =
                `„ÄéÂÆ¢ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫„Äè${label} „ÇØ„É™„Ç¢\n` +
                `„Éó„É¨„Ç§ÊôÇÈñìÔºö${timeStr}\n` +
                `„Éí„É≥„ÉàÂà©Áî®Ôºö${ANA.hintCount || 0}Âõû\n` +
                `#ËÑ±Âá∫„Ç≤„Éº„É† #ÂÆ¢ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫`;
            navigator.clipboard.writeText(text).then(() => {
                alert("„ÇØ„É™„Ç¢„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
            }).catch(() => {
                alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü‚Ä¶");
            });
        }

        // „Ç¢„É≥„Ç±„Éº„Éà
        function openFeedbackForm(endingId) {
            const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfHwbvJDtkCjV_WTaecKDeyNo6u1V-GAt8E5_ngoTO-lHjN8A/viewform";

            const endingLabel = ({
                trueEnd: "„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ",
                end: "„Éé„Éº„Éû„É´„Ç®„É≥„Éâ",
            })[endingId] || "„Ç®„É≥„Éâ";

            const params = new URLSearchParams({
                "entry.666725843": endingLabel,                  // „Å©„ÅÆ„Ç®„É≥„Éâ„Åã
            });

            window.open(`${FEEDBACK_URL}?${params.toString()}`, "_blank");
        }



        function talkToHintCharacter(roomId, charId) {
            // flagsÂèñÂæó
            let flags = gameState[roomId].flags;
            // „Åæ„Å†„Ç´„Ç¶„É≥„ÉàÁÑ°„Åë„Çå„Å∞ÂàùÊúüÂåñ
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            flags.talkTo[charId]++;

            // „Çª„É™„Éï„É™„Çπ„ÉàÂèñÂæó
            const messages = hintMessages[roomId][charId];

            // ÁØÑÂõ≤Â§ñ„Å™„ÇâÊúÄÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const idx = (flags.talkTo[charId] - 1) % messages.length;
            console.log(flags.talkTo[charId]);

            // Ë°®Á§∫
            updateMessage(messages[idx]);
        }

        // ‚ñº „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ Êìç‰ΩúÁî®

        function openNotebook() {
            const m = document.getElementById('notebookModal');
            if (!m) return;
            m.style.display = 'flex';
            switchNotebookTab('memo'); // ÊØéÂõûMEMO„Åã„ÇâÈñã„Åè

            // ‚òÖ CALL LOG „ÇíÊõ¥Êñ∞„Åó„Å¶„Åä„Åè
            renderNotebookCallLog();

            if (gameState.main?.flags?.notebookDeckHintAdded) {
                addDeckDoorHintNote();
            }
        }

        function closeNotebook() {
            const m = document.getElementById('notebookModal');
            if (!m) return;
            m.style.display = 'none';
        }

        function switchNotebookTab(tabId) {
            const tabs = document.querySelectorAll('.notebook-tab');
            const contents = document.querySelectorAll('.notebook-tab-content');

            tabs.forEach(btn => {
                const t = btn.getAttribute('data-tab');
                btn.classList.toggle('active', t === tabId);
            });

            contents.forEach(c => {
                c.classList.remove('active');
            });

            const active = document.getElementById('notebook-tab-' + tabId);
            if (active) active.classList.add('active');
        }

        function renderNotebookCallLog() {
            const tHead = document.getElementById("notebook-calllog-header");
            const body = document.getElementById("notebook-calllog-body");
            if (!tHead || !body) return;

            const total = PHONE_DEX_LIST.length;
            let discoveredCount = 0;
            for (const entry of PHONE_DEX_LIST) {
                if (gameState.phoneDexFlags[entry.num]) discoveredCount++;
            }

            body.innerHTML = ""; // ÂàùÊúüÂåñ

            let html = `
<h2>‚Äï‚Äï Áô∫Ë¶ãÊï∞Ôºö ${discoveredCount} / ${total} ‚Äï‚Äï</h2>`;
            tHead.innerHTML = html;
            console.log(html);

            html = '';

            let row = 1;
            for (const entry of PHONE_DEX_LIST) {
                const discovered = !!gameState.phoneDex[entry.num];
                const rowClass = discovered ? "phone-discovered" : "phone-undiscovered";

                const num = discovered
                    ? (entry.num || "")
                    : "???";

                const label = discovered
                    ? (gameState.phoneDex[entry.num].label || "")
                    : "???";

                const desc = discovered
                    ? (gameState.phoneDex[entry.num].desc || "")
                    : "???";

                const state = discovered ? "Áô∫Ë¶ã" : "Êú™Áô∫Ë¶ã";

                html += `
            <tr class="${rowClass}">
                <td>${row}</td>
                <td>${num}</td>
                <td>${label}</td>
                <td>${desc}</td>
                <td>${state}</td>
            </tr>
        `;
                row++;
            }


            html += `</table>`;
            console.log(html);
            body.innerHTML = html;

        }


        // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Åü„ÅÑÂ†¥ÂêàÔºà‰ªªÊÑèÔºâ
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('notebookModal');
            if (!modal) return;
            if (modal.style.display === 'flex' && e.target === modal) {
                closeNotebook();
            }
        });

        // ‚ñ≤ „ÇØ„É´„ÉºÊâãÂ∏≥„É¢„Éº„ÉÄ„É´ Êìç‰ΩúÁî®


        const PHONE_DEX_LIST = [
            
            { num: "117", label: "ÊôÇÂ†±„ÅÆÁï™Âè∑", desc: "ÊôÇÂàª„ÇíÊïô„Åà„Å¶„Åè„Çå„ÇãÁï™Âè∑„Å†„ÄÇ" },
            { num: "212", label: "Ë©±„Åó‰∏≠„ÅÆÁï™Âè∑", desc: "„ÅäË©±„Åó‰∏≠„Å†„Å£„Åü„ÄÇ" },
            { num: "272", label: "Êé°Áî®„Çª„É≥„Çø„Éº„ÅÆÁï™Âè∑", desc: "„Ç≠„ÉÉ„ÉÅ„É≥„Çπ„Çø„ÉÉ„Éï„ÇíÂãüÈõÜ‰∏≠„Å†„ÄÇ" },
            { num: "288", label: "Â§©Ê∞ó‰∫àÂ†±„ÅÆÁï™Âè∑", desc: "Â§©Ê∞ó„ÅåÂàÜ„Åã„Å£„Å¶‰æøÂà©„Åß„Åô„ÄÇ" },
            { num: "301", label: "Ë≠¶ÂÇô„Çª„É≥„Çø„Éº„ÅÆÁï™Âè∑", desc: "„Éú„Éº„Éà„Åå‰∏ÄÈöªË°åÊñπ‰∏çÊòé„Çâ„Åó„ÅÑ„ÄÇ" },
            { num: "312", label: "„Çπ„Çø„ÉÉ„ÉïÊÑèË¶ãÁÆ±", desc: "„Äé„Éï„Çß„Ç§„ÇØ„Ç∞„É™„Éº„É≥„ÅØÂë≥Ê∞ó„Å™„ÅÑ„Åß„Åô„ÄÇÂÆüÁâ©„ÅÆËä±„ÇíÁΩÆ„Åç„Åü„ÅÑ„Åß„Åô„ÄÇ„Äèby „Ç≠„ÉÉ„ÉÅ„É≥„Çπ„Çø„ÉÉ„Éï" },
            { num: "314", label: "Áü¢Âç∞„ÅÆÁï™Âè∑", desc: "„Åã„Åô„Çå„ÅüÂ£∞„Åß„Äé‚Üë ‚Üì ‚Üì ‚Üí„Äè„Å®Ë®Ä„Å£„Å¶„ÅÑ„Åü„ÄÇ" },
            { num: "389", label: "„Çπ„Çø„ÉÉ„Éï‰ºùË®ÄÊùø„ÅÆÁï™Âè∑", desc: "ÂÄâÂ∫´„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊïô„Åà„Å¶„Åè„Çå„Åü„ÄÇ8834„Å†„ÄÇ" },
            { num: "404", label: "Â≠òÂú®„Åó„Å™„ÅÑÁï™Âè∑", desc: "„Åì„ÅÆÁï™Âè∑„ÅØÂ≠òÂú®„Åó„Å™„ÅÑ„Å®Ë®Ä„Çè„Çå„Åü„ÄÇ" },
            { num: "461", label: "Ë¶≥ÂÖâ„Éá„Çπ„ÇØ„ÅÆÁï™Âè∑", desc: "„ÉÑ„Ç¢„Éº„ÅØÊ∫ÄÂ∏≠„Å†„Å®Ë®Ä„Çè„Çå„Åü„ÄÇ" },
            { num: "505", label: "Á∑äÊÄ•„Çª„É≥„Çø„Éº„ÅÆÁï™Âè∑", desc: "Âõ∞„Å£„Åü„Å®„Åç„Å´ÈõªË©±„Åó„Å¶„Åø„Çà„ÅÜ" },
            { num: "660", label: "Ê©üÊ¢∞Èü≥„ÅÆÁï™Âè∑", desc: "„É≠„Éú„ÉÉ„Éà„ÅÆÂãï‰ΩúÈü≥„ÅÆ„Çà„ÅÜ„Å™Èü≥„ÅåËÅû„Åì„Åà„Åü„ÄÇ" },
            { num: "777", label: "„É¨„Çπ„Éà„É©„É≥„ÅÆÁï™Âè∑", desc: "‰ªäÊó•„ÅÆ„É°„Éã„É•„Éº„ÇíËÅû„Åë„Çã„ÄÇ" },
            { num: "886", label: "Ë¨é„ÅÆÈå≤Èü≥Èü≥Â£∞„ÅÆÁï™Âè∑", desc: "„Å©„Åì„Åã„ÅÆÂ∫ßÊ®ô„Å´„Å§„ÅÑ„Å¶„Å§„Å∂„ÇÑ„ÅÑ„Å¶„ÅÑ„Åü„ÄÇ" },
            { num: "921", label: "Âè§„ÅÑËàπÂÜÖÊîæÈÄÅ", desc: "ÈÄî‰∏≠„ÅßÂàá„Çå„ÅüÁ∑äÊÄ•„Ç¢„Éä„Ç¶„É≥„Çπ„ÅåÊµÅ„Çå„Åü„ÄÇ" },
        ];

        let phoneInput = "";

        function showPhoneDialModal() {
            phoneInput = "";

            showModal(
                "ÈõªË©±",
                `
        <div style="font-size:1.8em; margin-bottom:12px; letter-spacing:4px;">
            <span id="phoneDisplay">---</span>
        </div>

        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:10px;">
            ${[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n =>
                    `<button class="text-btn" onclick="pressPhoneDigit(${n})">${n}</button>`
                ).join("")}
            <div></div>
            <button class="text-btn" onclick="pressPhoneDigit(0)">0</button>
            <div></div>
        </div>

        <button class="text-btn" onclick="callPhoneNumber()" style="width:80%; font-size:1.2em;">
            ‚òé Áô∫‰ø°
        </button>
        <div style="margin-top:16px;">
            <button class="text-btn" onclick="
                closeModal(); 
                setTimeout(() => showPhoneDexModal(), 50);
            ">üìì ÈõªË©±Ë®òÈå≤„ÇíË¶ã„Çã
            </button>
        </div>
        `,
                [{ text: "Èñâ„Åò„Çã", action: "close" }]
            );
        }

        function pressPhoneDigit(n) {
            if (phoneInput.length >= 3) return;
            phoneInput += n;
            document.getElementById("phoneDisplay").textContent = phoneInput.padEnd(3, "-");
            if (n % 2 == 0) {
                playSE('se-push1');
            } else {
                playSE('se-push2');
            }
        }

        function registerPhoneCall(num, label, desc) {
            if (!gameState.phoneDex[num]) {
                gameState.phoneDex[num] = {
                    label,
                    desc,
                    count: 0,
                };
            } else {
                // gameState.phoneDex[num].count++;
                gameState.phoneDex[num].label = label;
                gameState.phoneDex[num].desc = desc;
            }
            gameState.phoneDex[num].count++;
        }


        function callPhoneNumber() {
            // Áô∫‰ø°Èü≥„ÇíÈ≥¥„Çâ„Åô
            playSE("se-call");


            // Áô∫‰ø°‰∏≠„É¢„Éº„ÉÄ„É´„ÇíÂá∫„ÅôÔºàÈñâ„Åò„Çâ„Çå„Å™„ÅÑÔºâ
            showModal(
                "Áô∫‰ø°‰∏≠‚Ä¶",
                "<p>‚Ä¶‚Ä¶</p>",
                [] // „Éú„Çø„É≥ÁÑ°„Åó
            );

            // 0.7 ÁßíÂæå„Å´ÁµêÊûú„ÇíË°®Á§∫„Åô„Çã
            setTimeout(() => {

                closeModal(); // Áô∫‰ø°‰∏≠„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã


                // ‚òÖ 117 : ÊôÇÂ†±
                if (phoneInput === "117") {
                    gameState.phoneDexFlags[phoneInput] = true;

                    // ÁèæÂú®„ÅÆÊôÇÈñìÂ∏Ø„ÇíÂèñÂæóÔºà0=Êòº,1=Â§ïÊñπ,2=Â§úÔºâ
                    const phase = gameState.main?.flags?.timePhase ?? 0;

                    // „Éï„Çß„Éº„Ç∫„Åî„Å®„ÅÆ„Ç¢„Éä„Ç¶„É≥„ÇπÊñá
                    let title = "ÊôÇÂ†±";


                    // Ê¨°„ÅÆÊôÇÈñìÂ∏Ø
                    const next = gameState.main.flags.gotDoorCode ? 0 : (phase + 1) % 3;

                    // ÊôÇÂ†±„ÉÜ„Ç≠„Çπ„Éà
                    let announceText = "";
                    if (next === 0) {
                        announceText = "ÂçàÂâçÔºôÊôÇÔºëÔºíÂàÜ„Çí„ÅäÁü•„Çâ„Åõ„Åó„Åæ„Åô„ÄÇ„Éî„ÉÉ„ÄÅ„Éî„ÉÉ„ÄÅ„Éî„ÉÉ‚Ä¶‚Ä¶„Éù„Éº„É≥„ÄÇ";
                    } else if (next === 1) {
                        announceText = "ÂçàÂæåÔºïÊôÇÔºëÔºíÂàÜ„Çí„ÅäÁü•„Çâ„Åõ„Åó„Åæ„Åô„ÄÇ„Éî„ÉÉ„ÄÅ„Éî„ÉÉ„ÄÅ„Éî„ÉÉ‚Ä¶‚Ä¶„Éù„Éº„É≥„ÄÇ";
                    } else {
                        announceText = "ÂçàÂæåÔºëÔºëÊôÇÔºëÔºíÂàÜ„Çí„ÅäÁü•„Çâ„Åõ„Åó„Åæ„Åô„ÄÇ„Éî„ÉÉ„ÄÅ„Éî„ÉÉ„ÄÅ„Éî„ÉÉ‚Ä¶‚Ä¶„Éù„Éº„É≥„ÄÇ";
                    }



                    // ÈõªË©±Ë®òÈå≤„Ç´„Ç¶„É≥„ÉàÔºàÂêçÁß∞„ÉªË™¨Êòé„ÅØ PHONE_DEX_LIST „Å´Âêà„Çè„Åõ„Å¶„Åä„ÅèÔºâ
                    registerPhoneCall("117", "ÊôÇÂ†±„ÅÆÁï™Âè∑", "ÊôÇÂàª„ÇíÊïô„Åà„Å¶„Åè„Çå„ÇãÁï™Âè∑„Å†„ÄÇ");

                    // ÂèóË©±Èü≥
                    playSE("se-receiver");

                    // ÁµêÊûú„É¢„Éº„ÉÄ„É´Ë°®Á§∫
                    showModal(
                        title,
                        `<p>${announceText}</p>`,
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );

                    // ‚òÖ ÊôÇÈñìÂ∏Ø„ÇíÈÄ≤„ÇÅ„Çã: 0 ‚Üí 1 ‚Üí 2 ‚Üí 0‚Ä¶
                    gameState.main.flags.timePhase = next;

                    // Êóß isNight „ÇÇ‰∏ÄÂøúÂêà„Çè„Åõ„Å¶„Åä„ÅèÔºà‰∫íÊèõÁî®Ôºâ
                    gameState.main.flags.isNight = (next === 2);
                    toggleNight();

                    // Á™ì„ÅÆÊôØËâ≤„ÉªBGM „ÇíÊõ¥Êñ∞„Åó„Åü„ÅÑ„ÅÆ„ÅßÂÜçÊèèÁîª
                    // Ôºà‰ªä„Å©„ÅÆÈÉ®Â±ã„Å´„ÅÑ„Å¶„ÇÇ„Å®„Çä„ÅÇ„Åà„ÅöÂÜçÊèèÁîª„Åó„Å¶OKÔºâ
                    renderCanvasRoom();

                    return;
                }

                if (phoneInput === "272") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    registerPhoneCall("272", "Êé°Áî®„Çª„É≥„Çø„Éº„ÅÆÁï™Âè∑", "„Ç≠„ÉÉ„ÉÅ„É≥„Çπ„Çø„ÉÉ„Éï„ÇíÂãüÈõÜ‰∏≠„Å†");
                    showModal(
                        "„Åì„Å°„Çâ„ÅØÊé°Áî®„Çª„É≥„Çø„Éº„Åß„Åô",
                        `
                <p>ÁèæÂú®„Ç≠„ÉÉ„ÉÅ„É≥„Çπ„Çø„ÉÉ„Éï„Çí1ÂêçÂãüÈõÜ‰∏≠„Åß„Åô„ÄÇ‚Ä¶</p>
                `,
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }



                if (phoneInput === "212") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    if (gameState.main.flags.setReceiver && gameState.currentRoom != 'deck') {
                        showModal(
                            "Áô∫‰ø°ÁµêÊûú",
                            `
                <p>Âëº„Å≥Âá∫„ÅóÈü≥„ÅåÈ≥¥„ÇäÁ∂ö„Åë„Å¶„ÅÑ„Çã„ÄÇ</p>
                `,
                            [{ text: "Èñâ„Åò„Çã", action: "close" }]
                        );
                        registerPhoneCall("212", "ÂèçÂøú„Å™„Åó„ÅÆÁï™Âè∑", "Ë™∞„ÇÇÂá∫„Å™„Åã„Å£„Åü");
                        gameState.main.flags.goneBird = true;
                        return;
                    } else {
                        playSE("se-busy");
                        registerPhoneCall("212", "Ë©±„Åó‰∏≠„ÅÆÁï™Âè∑", "„ÅäË©±„Åó‰∏≠„Å†„ÄÇ");
                        showModal(
                            "Áô∫‰ø°ÁµêÊûú",
                            "<p>„ÅäË©±„Åó‰∏≠„ÅÆ„Çà„ÅÜ„Å†„ÄÇ</p>",
                            [{ text: "Èñâ„Åò„Çã", action: "close" }]
                        );
                        return;
                    }
                }

                if (phoneInput === "288") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("288", "Â§©Ê∞ó‰∫àÂ†±„ÅÆÁï™Âè∑", "„ÅäÂ§©Ê∞ó„ÇíÊïô„Åà„Å¶„Åè„Çå„Çã„ÄÇ");

                    // Ê¨°„ÅÆÊôÇÈñìÂ∏Ø
                    if (gameState.currentRoom == 'guestRoom') {
                        gameState.main.flags.windowStorm = !gameState.main.flags.windowStorm;
                    }
                    const nextWeather = gameState.main.flags.windowStorm;

                    // ÊôÇÂ†±„ÉÜ„Ç≠„Çπ„Éà
                    let announceText = "";
                    if (!nextWeather) {
                        announceText = "„Åæ„ÇÇ„Å™„ÅèÊô¥„ÇåÈñì„ÅåË¶ã„Åà„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ„Éî„ÉÉ‚Ä¶‚Ä¶„ÄÇ";
                    } else {
                        announceText = "„Åæ„ÇÇ„Å™„Åè‚Ä¶Èõ∑„Çí‰º¥„Å£„ÅüÂ§ßÈõ®„Å´„Å™„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ„Éî„ÉÉ‚Ä¶‚Ä¶„ÄÇ";
                    }

                    showModal(
                        "Â§©Ê∞ó‰∫àÂ†±",
                        `<p>${announceText}</p>`,
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );

                    return;
                }

                if (phoneInput === "301") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("301", "Ë≠¶ÂÇô„Çª„É≥„Çø„Éº„ÅÆÁï™Âè∑", "„Éú„Éº„Éà„Åå‰∏ÄÈöªË°åÊñπ‰∏çÊòé„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Çâ„Åó„ÅÑ„ÄÇ");
                    showModal(
                        "Áô∫‰ø°ÁµêÊûú",
                        "<p>„ÄéË≠¶ÂÇô„Çª„É≥„Çø„Éº„Åã„Çâ„ÅÆ„ÅäÁü•„Çâ„Åõ„ÄÇ<br>ÂÖàÊó•„ÄÅÊé•Â≤∏Áî®„Éú„Éº„Éà„Åå‰∏ÄÈöªÁ¥õÂ§±„Åó„Åæ„Åó„Åü„ÄÇ<br>„ÅäÂøÉÂΩì„Åü„Çä„ÅÆ„ÅÇ„ÇãÊñπ„ÅØË≠¶ÂÇô„Çª„É≥„Çø„Éº„Åæ„Åß‚Ä¶„Äè</p>",
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }
                if (phoneInput === "312") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("312", "„Çπ„Çø„ÉÉ„ÉïÊÑèË¶ãÁÆ±„ÅÆÁï™Âè∑", "„Éï„Çß„Ç§„ÇØ„Ç∞„É™„Éº„É≥„ÇÑÈ≥•„Å´Èñ¢„Åô„Çã„Çπ„Çø„ÉÉ„Éï„ÅÆÊÑèË¶ã„ÅåÊäïÁ®ø„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ");
                    showModal(
                        "„Çπ„Çø„ÉÉ„ÉïÊÑèË¶ãÁÆ±",
                        `<p>„Äé„Éï„Çß„Ç§„ÇØ„Ç∞„É™„Éº„É≥„ÅØÂë≥Ê∞ó„Å™„ÅÑ„Åß„Åô„ÄÇÂÆüÁâ©„ÅÆËä±„ÇíÁΩÆ„Åç„Åü„ÅÑ„Åß„Åô„ÄÇ„Äè<br>by „Ç≠„ÉÉ„ÉÅ„É≥„Çπ„Çø„ÉÉ„Éï</p>
                        <p>„Äé„Éá„ÉÉ„Ç≠„Å´„Çà„Åè„Åß„Åã„ÅÑÈ≥•„ÅåÂ±Ö„Å¶ÈÇ™È≠î„ÄÇÈ≥•„Çà„Åë„ÇíË®≠ÁΩÆ„Åó„Åæ„Åõ„Çì„ÅãÔºü„Äè<br>by Ëà™Êµ∑Â£´</p>
                        <p>„Äé„ÅÇ„ÅÆÈ≥•„ÅØÈü≥„Å´Âº±„ÅÑ„Åß„Åô„Çà„ÄÇ„Åô„ÅêÈÄÉ„Åí„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇ„Äè<br>by Ê∏ÖÊéÉ„Çπ„Çø„ÉÉ„Éï</p>`,
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }

                if (phoneInput === "314") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("314", "„Åã„Åô„Çå„ÅüÂ£∞„ÅÆÁï™Âè∑", "ÊñπÂêë„ÇíÊïô„Åà„Å¶„Åè„Çå„Åü„ÄÇ");
                    showModal(
                        "Áô∫‰ø°ÁµêÊûú",
                        `
        <p>‚Ä¶‚Ä¶„Åã„Åô„Çå„ÅüÂ£∞„ÅåËÅû„Åì„Åà„Çã„ÄÇ</p>
        <p>„Äé<span style="font-size:1.2em;">‚Üë ‚Üì ‚Üì ‚Üí</span>„Äè</p>
        `,
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }
                if (phoneInput === "389") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("389", "„Çπ„Çø„ÉÉ„Éï‰ºùË®ÄÊùø„ÅÆÁï™Âè∑", "ÂÄâÂ∫´„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊïô„Åà„Å¶„Åè„Çå„Åü„ÄÇ");
                    showModal(
                        "Áô∫‰ø°ÁµêÊûú",
                        "<p>„Äé„Çπ„Çø„ÉÉ„Éï‰ºùË®ÄÊùø„Åß„Åô„ÄÇ1‰ª∂ÁõÆ„ÇíÂÜçÁîü„Åó„Åæ„Åô„ÄÇ<br>‚Ä¶„Ç≠„ÉÉ„ÉÅ„É≥„ÅÆÁöÜ„Åï„Çì„ÄÇÂÄâÂ∫´„Éë„Çπ„Çí„Åæ„ÅüÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ<br>‚Ä¶‰ªäÂõû„ÅØ 8834„ÄÇ‰ª•‰∏ä„ÄÇ„Éó„ÉÑ„ÉÉ‚Ä¶‚Ä¶„Äè</p>",
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }

                if (phoneInput === "404") {
                    const flags = gameState.main.flags || (gameState.main.flags = {});
                    const current = (flags.notFoundCnt || 0) + 1;
                    flags.notFoundCnt = current;

                    // 404 „ÅØ‰∏ÄÂ∫¶„Åß„ÇÇÊéõ„Åë„Åü„ÇâÂõ≥ÈëëÁôªÈå≤„Åó„Å¶„Åä„Åè
                    if (!gameState.phoneDexFlags[phoneInput]) {
                        gameState.phoneDexFlags[phoneInput] = true;
                        registerPhoneCall(
                            "404",
                            "Â≠òÂú®„Åó„Å™„ÅÑÁï™Âè∑",
                            "„Åì„ÅÆÁï™Âè∑„ÅØÂ≠òÂú®„Åó„Å™„ÅÑ„Å®Ë®Ä„Çè„Çå„Åü„ÄÇ"
                        );
                    }

                    // 1ÂõûÁõÆÔºöÊôÆÈÄö„ÅÆ„ÄåÂ≠òÂú®„Åó„Åæ„Åõ„Çì„Äç
                    if (current === 1) {
                        playSE("se-busy");
                        showModal(
                            "Áô∫‰ø°ÁµêÊûú",
                            "<p>„Äé„Åä„Åã„Åë„Å´„Å™„Å£„ÅüÂÜÖÁ∑ö„ÅØÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇ„Äè</p>",
                            [{ text: "Èñâ„Åò„Çã", action: "close" }]
                        );
                        return;
                    }

                    // 2ÂõûÁõÆÔºöÊ°àÂÜÖ„Åô„ÇâÊ∂à„Åà„Å¶„Éé„Ç§„Ç∫„Å†„Åë„Å´„Å™„Çã
                    if (current === 2) {
                        playSE("se-noise");
                        showModal(
                            "Áô∫‰ø°ÁµêÊûú",
                            `
                            <p>‚Ä¶‚Ä¶„Åï„Å£„ÅçËÅû„Åì„Åà„ÅüÊ°àÂÜÖ„ÅÆÂ£∞„Åô„Çâ„ÄÅ„ÇÇ„ÅÜÊµÅ„Çå„Å¶„Åì„Å™„ÅÑ„ÄÇ</p>
                            <p>ËÄ≥„ÅÆÂ••„Å´„ÄÅÁ†ÇÂµê„Åø„Åü„ÅÑ„Å™„Éé„Ç§„Ç∫„Å†„Åë„ÅåËñÑ„Åè„Åì„Å≥„Çä„Å§„ÅÑ„Å¶„ÅÑ„Çã„ÄÇ</p>
                            `,
                            [{ text: "Èñâ„Åò„Çã", action: "close" }]
                        );
                        return;
                    }

                    // 3ÂõûÁõÆ‰ª•ÈôçÔºöËôöÁÑ° BAD END „Å∏
                    showVoidBadEnd();
                    return;

                }

                if (phoneInput === "461") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("461", "Ë¶≥ÂÖâ„Éá„Çπ„ÇØ„ÅÆÁï™Âè∑", "„ÉÑ„Ç¢„Éº„ÅØÊ∫ÄÂ∏≠„Çâ„Åó„ÅÑ„ÄÇ");
                    showModal(
                        "Áô∫‰ø°ÁµêÊûú",
                        "<p>„Äé„Åì„Å°„Çâ„ÄÅËàπÂÜÖ„ÉÑ„Ç¢„ÉºÁî≥„ÅóËæº„Åø„ÉÄ„Ç§„É§„É´461Áï™„Åß„Åô„ÄÇ<br>ÁèæÂú®„ÄÅÂÖ®„Å¶„ÅÆ„ÉÑ„Ç¢„Éº„ÅØÊ∫ÄÂ∏≠„Åß„Åô„ÄÇ „Éó„ÉÑ„ÉÉ‚Ä¶‚Ä¶„Äè</p>",
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }


                // ‚ñº 505ÔºàÁ∑äÊÄ•„Çª„É≥„Çø„ÉºÔºâ
                if (phoneInput === "505") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    registerPhoneCall("505", "Á∑äÊÄ•„Çª„É≥„Çø„Éº„ÅÆÁï™Âè∑", "ËàπÂÆ§„ÅÆ„Éâ„Ç¢„Ç≥„Éº„Éâ„ÇíÊïô„Åà„Å¶„Åè„Çå„Åü„ÄÇ");
                    if (gameState.main.flags.timePhase === 0) {
                        // Êòº„Å†„ÅëÂøúÁ≠î
                        if (gameState.main.flags.unlockDoor) {
                            showModal(
                                "Áô∫‰ø°ÁµêÊûú",
                                "<p>„ÄéÁèæÂú®„ÄÅ„É°„É≥„ÉÜ„Éä„É≥„Çπ‰∏≠„Åß„Åô„ÄÇ„Äè</p>",
                                [{ text: "Èñâ„Åò„Çã", action: "close" }]
                            );
                            playSE("se-receiver");
                        } else {
                            const code = "3849";
                            showModal(
                                "Áô∫‰ø°ÁµêÊûú",
                                "<p>„Äé„Éâ„Ç¢„É≠„ÉÉ„ÇØÈñãÈå†„Ç≥„Éº„Éâ„Çí„Åä‰ºù„Åà„Åó„Åæ„Åô„ÄÇ" + code + " „Åß„Åô„ÄÇ„Äè</p>",
                                [{ text: "Èñâ„Åò„Çã", action: "close" }]
                            );
                            playSE("se-receiver");
                            gameState.main.flags.gotDoorCode = true;
                        }


                    } else {
                        // ÊôÇÈñìÂ§ñ
                        showModal(
                            "Áô∫‰ø°ÁµêÊûú",
                            "<p>„ÄéÁ∑äÊÄ•„Çª„É≥„Çø„Éº„ÅÆÂñ∂Ê•≠ÊôÇÈñì„ÅØ„ÄÅÂçàÂâç9ÊôÇ„Åã„ÇâÂçàÂæå15ÊôÇ„Åæ„Åß„Åß„Åô„ÄÇ„Äè</p>",
                            [{ text: "Èñâ„Åò„Çã", action: "close" }]
                        );

                    }
                    return;
                }

                if (phoneInput === "660") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("660", "Ê©üÊ¢∞Èü≥„ÅÆÁï™Âè∑", "„É≠„Éú„ÉÉ„Éà„ÅÆÂãï‰ΩúÈü≥„ÅÆ„Çà„ÅÜ„Å™Èü≥„Åå„Åó„Åü„ÄÇ");
                    showModal(
                        "Áô∫‰ø°ÁµêÊûú",
                        "<p>„Éî‚Ä¶‚Ä¶„Ç¨„ÉÉ„ÄÇ</p>",
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }

                if (phoneInput === "777") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("777", "„É¨„Çπ„Éà„É©„É≥„ÅÆÁï™Âè∑", "‰ªäÊó•„ÅÆ„É°„Éã„É•„Éº„ÇíËÅû„Åë„Çã„ÄÇ");
                    showModal(
                        "Áô∫‰ø°ÁµêÊûú",
                        "<p>„Äé„Åì„Å°„Çâ„ÅØ„É¨„Çπ„Éà„É©„É≥Ê°àÂÜÖ‰øÇ„Åß„Åô„ÄÇ<br>Êú¨Êó•„ÅÆ„É°„Éã„É•„Éº„ÅØ<br>A„Çª„ÉÉ„Éà„ÄÅ„Çπ„ÉÜ„Éº„Ç≠ÔºÜ„Ç∑„É•„É™„É≥„Éó„ÅÆ„Çµ„É©„ÉÄÊ∑ª„Åà„ÄÇ<br>B„Çª„ÉÉ„Éà„ÄÅ„Ç∑„É•„É™„É≥„ÉóÈ¢®Âë≥„ÅÆ„Éê„Çø„Éº„Ç±„Éº„Ç≠ÔºÜ„Ç≥„Éº„Éí„Éº„Åæ„Åü„ÅØÁ¥ÖËå∂<br>„Å®„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô‚Ä¶„Äè</p>",
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }

                if (phoneInput === "886") {
                    gameState.phoneDexFlags[phoneInput] = true;
                    playSE("se-receiver");
                    registerPhoneCall("886", "Ë¨é„ÅÆÈå≤Èü≥Èü≥Â£∞„ÅÆÁï™Âè∑", "Â∫ßÊ®ô„Å´„Å§„ÅÑ„Å¶„Å§„Å∂„ÇÑ„ÅÑ„Å¶„ÅÑ„Åü„ÄÇ");
                    showModal(
                        "Ë™∞„Åã„ÅÆÈå≤Èü≥Èü≥Â£∞„Å†",
                        "<p>„Äé‚Ä¶‚Ä¶„ÇÇ„ÅÜÈÄÉ„Åí„Çã„ÅÆ„ÅØÁñ≤„Çå„Åü„Çì„Å†‚Ä¶‚Ä¶„ÄÇ<br>ÂÆù„Åï„Åà„ÅÇ„Çå„Å∞„ÄÅÊó•Êú¨„Å´Â∏∞„Å£„Å¶„Å°„ÇÉ„Çì„Å®Â∫ó„ÇíÊßã„Åà„Å¶‚Ä¶‚Ä¶Ëä±„Åü„Å°„Å®ÊöÆ„Çâ„Åó„Åü„ÅÑ„ÄÇ<br>Â∫ßÊ®ô„ÅØ„ÄÅ„Å®‚Ä¶3„Å§„ÅÆÊòü„ÅÆ‰∏≠ÂøÉ„ÄÇ<br>„Åì„ÅÆ„Éú„Éº„Éà„ÇíÂÄü„Çä„Çã„Åã„ÄÇ„Äè</p>",
                        [{ text: "Èñâ„Åò„Çã", action: "close" }]
                    );
                    return;
                }

                // 921ÔºöÈÄî‰∏≠„ÅßÂàá„Çå„ÇãÁ∑äÊÄ•ÊîæÈÄÅ
                if (phoneInput === "921") {
                    const flags = gameState.main.flags || (gameState.main.flags = {});

                    // Â±•Ê≠¥„Å´ÁôªÈå≤Ôºà„Åæ„Å†„Å™„ÇâÔºâ
                    if (!gameState.phoneDexFlags[phoneInput]) {
                        gameState.phoneDexFlags[phoneInput] = true;
                        registerPhoneCall(
                            "921",
                            "Âè§„ÅÑËàπÂÜÖÊîæÈÄÅ",
                            "ÈÄî‰∏≠„ÅßÂàá„Çå„ÅüÁ∑äÊÄ•„Ç¢„Éä„Ç¶„É≥„Çπ„ÅåÊµÅ„Çå„Åü„ÄÇ"
                        );
                    }

                    // ÊîæÈÄÅ„ÉÅ„É£„Ç§„É†„Å£„ÅΩ„ÅÑSE
                    if (typeof playSE === "function") {
                        playSE("se-announcement"); 
                        playSE("se-noise"); 
                    }

                    showModal(
                        "Áô∫‰ø°ÁµêÊûú",
                        `
        <p>„Äé‚Ä¶‚Ä¶„Åî‰πóËàπ‰∏≠„ÅÆ„ÅäÂÆ¢„Åï„Åæ„Å´„ÅäÁü•„Çâ„Åõ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ„Äè</p>
        <p>„ÄéÂÖà„Åª„Å©Áô∫Áîü„Åó„Åü‚Ä¶‚Ä¶„Éà„É©„Éñ„É´„Å´„Çà„Çä„ÄÅ„ÅÑ„Åè„Å§„Åã„ÅÆ„Ç®„É™„Ç¢„Åå‚Äî‚Äî„Äè</p>
        <p>„Ç∂„Ç∂„ÉÉ„ÄÅ„Å®Âº∑„ÅÑ„Éé„Ç§„Ç∫„ÅåÊ∑∑„Åò„Çã„ÄÇ</p>
        <p>„Äé‚Äî‚Äî„Åô„Åπ„Å¶„ÅÆ‰πóÂì°„ÅØ„ÄÅÊåáÁ§∫„Åå„ÅÇ„Çã„Åæ„ÅßËá™ÂÆ§„ÅßÂæÖÊ©ü„Åó„Å¶„Åè„Å†‚Äî‚Äî„Äè</p>
        <p>„Åù„Åì„Åß„ÄÅÈå≤Èü≥„ÅØ„Å∑„Å§„Çä„Å®ÈÄîÂàá„Çå„Åü„ÄÇ</p>
        `,
                        [
                            {
                                text: "Âàá„Çã",
                                action: "close"
                            }
                        ]
                    );

                    return;
                }


                // „Åù„ÅÆ‰ªñ„ÅÆÁï™Âè∑
                showModal(
                    "Áô∫‰ø°Â§±Êïó",
                    `<p>${phoneInput} „Å´„Åã„Åë„Åü„Åå„ÄÅÂèçÂøú„Åå„Å™„ÅÑ„ÄÇ</p>`,
                    [{ text: "Èñâ„Åò„Çã", action: "close" }]
                );

            }, 700); // ‚Üê 0.7ÁßíÂæÖ„Å£„Å¶„Åã„ÇâÁµêÊûú„ÇíÂá∫„Åô
        }

        function showPhoneDexModal() {
            const overlay = document.querySelector(".modal-overlay");
            const scroll = overlay?.querySelector(".casefile-scroll");
            if (!overlay || !scroll) return;

            const total = PHONE_DEX_LIST.length;
            let discoveredCount = 0;
            for (const entry of PHONE_DEX_LIST) {
                if (gameState.phoneDexFlags[entry.num]) discoveredCount++;
            }

            let html = `
        <h1>ÈõªË©±Ë®òÈå≤</h1>
        <h2>‚Äï‚Äï Áô∫Ë¶ãÊï∞Ôºö ${discoveredCount} / ${total} ‚Äï‚Äï</h2>
        <hr>
        <table class="evidence">
            <tr>
                <th>No.</th>
                <th>Áï™Âè∑</th>
                <th>ÂêçÁß∞</th>
                <th>ÂèçÂøú</th>
                <th>Áä∂ÊÖã</th>
            </tr>
    `;

            let row = 1;
            for (const entry of PHONE_DEX_LIST) {
                const discovered = !!gameState.phoneDex[entry.num];
                const rowClass = discovered ? "phone-discovered" : "phone-undiscovered";

                const num = discovered
                    ? (entry.num || "")
                    : "???";

                // const label = discovered
                //     ? (entry.label || "")
                //     : "???";

                const label = discovered
                    ? (gameState.phoneDex[entry.num].label || "")
                    : "???";

                const desc = discovered
                    ? (gameState.phoneDex[entry.num].desc || "")
                    : "???";

                const state = discovered ? "Áô∫Ë¶ã" : "Êú™Áô∫Ë¶ã";

                html += `
            <tr class="${rowClass}">
                <td>${row}</td>
                <td>${num}</td>
                <td>${label}</td>
                <td>${desc}</td>
                <td>${state}</td>
            </tr>
        `;
                row++;
            }

            html += `</table>`;

            scroll.innerHTML = html;
            overlay.style.display = "flex";

        }



        let cabinetDirSeq = [];

        function resetCabinetDirSeq() {
            cabinetDirSeq = [];
            renderCabinetDirDisplay();
        }

        function pushCabinetDir(dir) {
            // dir: 'up' | 'down' | 'left' | 'right'
            cabinetDirSeq.push(dir);
            if (cabinetDirSeq.length > 16) {
                cabinetDirSeq = cabinetDirSeq.slice(-16);
            }
            renderCabinetDirDisplay();
            if (typeof playSE === 'function') playSE('se-click');
        }

        function renderCabinetDirDisplay() {
            const el = document.getElementById('cabinetDirDisplay');
            if (!el) return;

            if (cabinetDirSeq.length === 0) {
                el.textContent = 'ÔºàÁü¢Âç∞„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ÂÖ•ÂäõÔºâ';
            } else {
                el.textContent = cabinetDirSeq
                    .map(d => {
                        if (d === 'up') return '‚Üë';
                        if (d === 'down') return '‚Üì';
                        if (d === 'left') return '‚Üê';
                        if (d === 'right') return '‚Üí';
                    })
                    .slice(-8)
                    .join(' ');
            }
        }

        function showCabinetLockPuzzle() {
            if (gameState.main.flags.unlockCabinet) {
                updateMessage('„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Â§ñ„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            resetCabinetDirSeq();

            const modalContent = `
        <div style="
            padding:14px;
            border-radius:12px;
            background: radial-gradient(circle at 30% 20%, #fdfdfd, #e2ddd5);
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.15),
                0 4px 10px rgba(0,0,0,0.6);
            color:#2b1908;
            text-align:center;
            max-width:340px;
            margin:0 auto;
        ">
            <h2 style="margin:4px 0 10px 0;font-size:1.1em;">„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆ„É≠„ÉÉ„ÇØ</h2>

            <div id="cabinetDirDisplay"
                 style="min-height:1.4em;font-size:0.95em;margin:0 0 8px 0;">
                ÔºàÁü¢Âç∞„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ÂÖ•ÂäõÔºâ
            </div>

            <div style="
                margin:6px 0 10px 0;
                display:flex;
                justify-content:center;
            ">
                <div style="position:relative;width:160px;height:160px;">
                    <!-- ‰∏ä -->
                    <button onclick="pushCabinetDir('up')" style="
                        position:absolute;
                        left:50%;
                        top:10px;
                        transform:translateX(-50%);
                        width:46px;height:34px;
                        border:none;border-radius:10px;
                        background:linear-gradient(#fffdf7,#ded4c4);
                        box-shadow:0 2px 4px rgba(0,0,0,0.45);
                        cursor:pointer;
                    ">‚Üë</button>

                    <!-- Â∑¶ -->
                    <button onclick="pushCabinetDir('left')" style="
                        position:absolute;
                        left:16px;
                        top:44%;
                        transform:translateY(-50%);
                        width:46px;height:34px;
                        border:none;border-radius:10px;
                        background:linear-gradient(#fffdf7,#ded4c4);
                        box-shadow:0 2px 4px rgba(0,0,0,0.45);
                        cursor:pointer;
                    ">‚Üê</button>

                    <!-- Âè≥ -->
                    <button onclick="pushCabinetDir('right')" style="
                        position:absolute;
                        right:0px;
                        top:44%;
                        transform:translateY(-50%);
                        width:46px;height:34px;
                        border:none;border-radius:10px;
                        background:linear-gradient(#fffdf7,#ded4c4);
                        box-shadow:0 2px 4px rgba(0,0,0,0.45);
                        cursor:pointer;
                    ">‚Üí</button>

                    <!-- ‰∏ã -->
                    <button onclick="pushCabinetDir('down')" style="
                        position:absolute;
                        left:50%;
                        bottom:10px;
                        transform:translateX(-50%);
                        width:46px;height:34px;
                        border:none;border-radius:10px;
                        background:linear-gradient(#fffdf7,#ded4c4);
                        box-shadow:0 2px 4px rgba(0,0,0,0.45);
                        cursor:pointer;
                    ">‚Üì</button>
                </div>
            </div>

            <div style="margin-top:6px;">
                <button onclick="checkCabinetLockPuzzle()" class="text-btn">OK</button>
                <button onclick="resetCabinetDirSeq()" class="text-btn">„É™„Çª„ÉÉ„Éà</button>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;

            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            mc.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        function checkCabinetLockPuzzle() {
            const correct = ['up', 'down', 'down', 'right'];
            const last = cabinetDirSeq.slice(-correct.length);

            const ok = correct.every((v, i) => last[i] === v);

            if (!ok) {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶‰Ωï„ÅãÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ');
                return;
            }

            gameState.main.flags.unlockCabinet = true;
            if (typeof playSE === 'function') playSE('se-gacha');

            closeModal();
            updateMessage('„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„ÄÇ');

            if (typeof renderCanvasRoom === 'function') {
                renderCanvasRoom();
            }
        }

        // ==== „Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏äÊÆµÔºöË®òÂè∑„Éú„Çø„É≥„Éë„Ç∫„É´ ====
        let cabinetTopSeq = [];

        function resetCabinetTopSeq() {
            cabinetTopSeq = [];
            renderCabinetTopDisplay();
        }

        function pushCabinetTop(sym) {
            // sym: '‚óè' | '‚ñº' | '‚ñ≤' | '‚ñ†'
            cabinetTopSeq.push(sym);
            if (cabinetTopSeq.length > 8) {
                cabinetTopSeq = cabinetTopSeq.slice(-8);
            }
            renderCabinetTopDisplay();
            if (typeof playSE === 'function') playSE('se-click');
        }

        function renderCabinetTopDisplay() {
            const el = document.getElementById('cabinetTopDisplay');
            if (!el) return;

            if (cabinetTopSeq.length === 0) {
                el.textContent = 'Ôºà„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ÂÖ•ÂäõÔºâ';
            } else {
                el.textContent = cabinetTopSeq.join(' ');
            }
        }

        function showCabinetTopLockPuzzle() {
            if (gameState.main.flags.unlockCabinetTop) {
                updateMessage('„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏ä„ÅÆÊÆµ„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Â§ñ„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                return;
            }

            resetCabinetTopSeq();

            const modalContent = `
        <div style="
            padding:14px;
            border-radius:12px;
            background: radial-gradient(circle at 30% 20%, #fdfdfd, #e2ddd5);
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.15),
                0 4px 10px rgba(0,0,0,0.6);
            color:#2b1908;
            text-align:center;
            max-width:340px;
            margin:0 auto;
        ">
            <h2 style="margin:4px 0 10px 0;font-size:1.1em;">„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏äÊÆµ„ÅÆ„É≠„ÉÉ„ÇØ</h2>

            <div id="cabinetTopDisplay"
                 style="min-height:1.4em;font-size:0.95em;margin:0 0 8px 0;">
                Ôºà„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ÂÖ•ÂäõÔºâ
            </div>

            <div style="margin:6px 0 10px 0; display:flex; justify-content:center; gap:8px; flex-wrap:wrap;">
                <button onclick="pushCabinetTop('‚óè')" class="text-btn" style="min-width:100px; background-color:#d9d9d9;">‚óè</button>
                <button onclick="pushCabinetTop('‚ñº')" class="text-btn" style="min-width:100px; background-color:#d9d9d9;">‚ñº</button>
                <button onclick="pushCabinetTop('‚ñ≤')" class="text-btn" style="min-width:100px; background-color:#d9d9d9;">‚ñ≤</button>
                <button onclick="pushCabinetTop('‚ñ†')" class="text-btn" style="min-width:100px; background-color:#d9d9d9;">‚ñ†</button>
            </div>

            <div style="margin-top:6px;">
                <button onclick="checkCabinetTopLockPuzzle()" class="text-btn">OK</button>
                <button onclick="resetCabinetTopSeq()" class="text-btn">„É™„Çª„ÉÉ„Éà</button>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
        `;

            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            mc.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        function checkCabinetTopLockPuzzle() {
            // Ê≠£Ëß£Ôºö‚ñ≤„ÄÅ‚ñ†„ÄÅ‚ñ†„ÄÅ‚óè
            const correct = ['‚ñ≤', '‚ñ†', '‚ñ†', '‚óè'];
            const last = cabinetTopSeq.slice(-correct.length);

            const ok = correct.every((v, i) => last[i] === v);

            if (!ok) {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶„É≠„ÉÉ„ÇØ„ÅØÂ§ñ„Çå„Å™„ÅÑ„Çà„ÅÜ„Å†„ÄÇ');
                return;
            }

            gameState.main.flags.unlockCabinetTop = true;
            if (typeof playSE === 'function') playSE('se-gacha');

            closeModal();
            updateMessage('„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏ä„ÅÆÊÆµ„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„ÄÇ');

            if (typeof renderCanvasRoom === 'function') {
                renderCanvasRoom();
            }
        }

        // ==== Âªä‰∏ã„Éâ„Ç¢ÔºöËã±ÂçòË™û„Äårain„Äç„Éë„Ç∫„É´ ====

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showCorridorDoorPuzzle() {
            const f = gameState.main.flags;
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„ÄÅÈñã„ÅÑ„ÅüÁµµ„Å†„ÅëË¶ã„Åõ„Çã
            if (f.unlockCorridorDoor) {
                const modalContent = `
            <div style="text-align:center;">
                <img src="${IMAGES.modals.corridorDoorUnlocked}"
                     style="width:420px;max-width:100%;display:block;margin:0 auto 16px;">
                <p>Âªä‰∏ã„ÅÆ„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        `;
                mc.innerHTML = modalContent;
                modal.style.display = 'flex';
                return;
            }

            // „É≠„ÉÉ„ÇØ‰∏≠Ôºö„É≠„ÉÉ„ÇØÁîªÂÉèÔºãÂÖ•ÂäõÊ¨ÑÔºãOK
            const modalContent = `
        <div style="text-align:center;">
            <img id="corridorDoorModalImg"
                 src="${IMAGES.modals.corridorDoorLocked}"
                 style="width:420px;max-width:100%;display:block;margin:0 auto 16px;">
            <div style="margin-top:4px;">
                <input type="text"
                       id="corridorDoorInput"
                       class="puzzle-input"
                       placeholder="Ëã±Â≠ó"
                       style="max-width:220px;width:70%;">
            </div>
            <div style="margin-top:8px;">
                <button onclick="checkCorridorDoorPuzzle()" class="text-btn">OK</button>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;

            mc.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        function checkCorridorDoorPuzzle() {
            const inputEl = document.getElementById('corridorDoorInput');
            if (!inputEl) {
                closeModal();
                return;
            }

            const raw = inputEl.value.trim();

            // ÂÖ®Ëßí„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÂØæÁ≠ñÔºàÔΩíÔΩÅÔΩâÔΩé „Å®„ÅãÔºâ
            const z2hAlpha = s =>
                s.replace(/[Ôº°-Ôº∫ÔΩÅ-ÔΩö]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));

            const val = z2hAlpha(raw).toLowerCase();

            if (val === 'rain') {
                // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„ÇâËªΩ„ÅèÊ≥®ÊÑè„Å†„Åë
                if (gameState.main.flags.unlockCorridorDoor) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('Âªä‰∏ã„ÅÆ„Éâ„Ç¢„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                    return;
                }

                gameState.main.flags.unlockCorridorDoor = true;
                renderCanvasRoom();

                // ÂÆüÁ∏æ„É≠„Ç∞
                if (typeof markProgress === 'function') {
                    markProgress('corridor_door_unlock_23');
                }

                if (typeof playSE === 'function') playSE('se-clear');

                // ÁîªÂÉè„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØÁâà„Å´Â∑Æ„ÅóÊõø„Åà
                const imgEl = document.getElementById('corridorDoorModalImg');
                if (imgEl) {
                    imgEl.src = IMAGES.modals.corridorDoorUnlocked;
                }

                // ÂÖ•ÂäõÊ¨Ñ„ÅØ„ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑ„ÅÆ„ÅßÁÑ°ÂäπÂåñ
                inputEl.disabled = true;
                inputEl.placeholder = '„É≠„ÉÉ„ÇØ„ÅØËß£Èô§„Åï„Çå„Åü';
                closeModal();
                showModal(
                    '„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );

                updateMessage('Âªä‰∏ã„ÅÆ„Éâ„Ç¢„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü„ÄÇ');

            } else {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ');
            }
        }

        // ==== „Ç≠„ÉÉ„ÉÅ„É≥ÂÜ∑ÂáçÂ∫´ÔºöËã±ÂçòË™û„Äåshrimp„Äç„Éë„Ç∫„É´ ====

        function showFrozenPuzzle() {
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„É°„ÉÉ„Çª„Éº„Ç∏„Å†„Åë
            if (gameState.main.flags.unlockFrozen) {
                const modalContent = `
        <div style="text-align:center;">
            <p>ÂÜ∑ÂáçÂ∫´„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>
            <div style="margin-top:8px;">
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
        `;
                mc.innerHTML = modalContent;
                modal.style.display = 'flex';
                return;
            }

            // „É≠„ÉÉ„ÇØ‰∏≠Ôºö„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÔºãOK
            const modalContent = `
    <div style="text-align:center;">
        <p style="margin-bottom:8px;">„É≠„ÉÉ„ÇØ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†„ÄÇ</p>
        <input type="text"
               id="frozenInput"
               class="puzzle-input"
               placeholder="Ëã±Â≠ó"
               style="max-width:220px;width:70%;">
        <div style="margin-top:8px;">
            <button onclick="checkFrozenPuzzle()" class="text-btn">OK</button>
            <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>
    `;
            mc.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        function checkFrozenPuzzle() {
            const inputEl = document.getElementById('frozenInput');
            if (!inputEl) {
                closeModal();
                return;
            }

            const raw = inputEl.value.trim();

            // ÂÖ®Ëßí„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÂØæÁ≠ñÔºàÔΩìÔΩàÔΩíÔΩâÔΩçÔΩê „Å®„ÅãÔºâ
            const z2hAlpha = s =>
                s.replace(/[Ôº°-Ôº∫ÔΩÅ-ÔΩö]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));

            const val = z2hAlpha(raw).toLowerCase();

            if (val === 'butter') {
                // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„ÇâËªΩ„ÅèÊ≥®ÊÑè„Å†„Åë
                if (gameState.main.flags.unlockFrozen) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('ÂÜ∑ÂáçÂ∫´„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                    return;
                }

                gameState.main.flags.unlockFrozen = true;

                if (typeof markProgress === 'function') {
                    markProgress('kitchen_frozen_unlock_23');
                }
                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                showModal(
                    'ÂÜ∑ÂáçÂ∫´„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );

                updateMessage('ÂÜ∑ÂáçÂ∫´„ÅÆ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü„ÄÇ');
            } else {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ');
            }
        }

        // ==== „Ç≠„ÉÉ„ÉÅ„É≥ÂÜ∑ËîµÂ∫´ÔºöÊï∞Â≠ó„Äå23„Äç„Éë„Ç∫„É´ ====

        function showRefrigeratorPuzzle() {
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„É°„ÉÉ„Çª„Éº„Ç∏„Å†„Åë
            if (gameState.main.flags.unlockRefrigerator) {
                const modalContent = `
        <div style="text-align:center;">
            <p>ÂÜ∑ËîµÂ∫´„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>
            <div style="margin-top:8px;">
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
        `;
                mc.innerHTML = modalContent;
                modal.style.display = 'flex';
                return;
            }

            // „É≠„ÉÉ„ÇØ‰∏≠Ôºö„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÔºãOKÔºàÁîªÂÉè„Å™„ÅóÔºâ
            const modalContent = `
    <div style="text-align:center;">
        <p style="margin-bottom:8px;">ü¶êÊï∞Â≠ó„É≠„ÉÉ„ÇØ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†„ÄÇ</p>
        <input type="text"
               id="refrigeratorInput"
               class="puzzle-input"
               inputmode="numeric"
               placeholder="Êï∞Â≠ó"
               style="max-width:220px;width:70%;">
        <div style="margin-top:8px;">
            <button onclick="checkRefrigeratorPuzzle()" class="text-btn">OK</button>
            <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>
    `;
            mc.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        function checkRefrigeratorPuzzle() {
            const inputEl = document.getElementById('refrigeratorInput');
            if (!inputEl) {
                closeModal();
                return;
            }

            const raw = inputEl.value.trim();

            // ÂÖ®ËßíÊï∞Â≠óÂØæÁ≠ñÔºàÔºíÔºì „Å™„Å©Ôºâ
            const z2hNum = s =>
                s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));

            const val = z2hNum(raw);

            if (val === '23') {
                // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„ÇâËªΩ„ÅèÊ≥®ÊÑè„Å†„Åë
                if (gameState.main.flags.unlockRefrigerator) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('ÂÜ∑ËîµÂ∫´„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');
                    return;
                }

                gameState.main.flags.unlockRefrigerator = true;

                if (typeof markProgress === 'function') {
                    markProgress('kitchen_refrigerator_unlock_23');
                }
                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                showModal(
                    'ÂÜ∑ËîµÂ∫´„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );

                updateMessage('ÂÜ∑ËîµÂ∫´„ÅÆ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü„ÄÇ');

            } else {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ');
            }
        }

        // ==== „Ç≠„ÉÉ„ÉÅ„É≥ÔºöA„Çª„ÉÉ„ÉàÁõõ„Çä‰ªò„Åë„Éë„Ç∫„É´ ====

        // „Éú„Çø„É≥„Åß„Éà„Ç∞„É´„Åó„Å¶„ÅÑ„ÅèÈ†ÜÁï™
        const PLATE_PUZZLE_ORDER = ['none', 'shrimp', 'steak', 'salad'];

        // Ê≠£Ëß£ÈÖçÁΩÆÔºàÂ∑¶„Éª‰∏ä„ÉªÂè≥Ôºâ
        const PLATE_PUZZLE_ANSWER = {
            left: 'salad',   // Â∑¶Ôºö„Çµ„É©„ÉÄ
            top: 'steak',    // ‰∏äÔºö„Çπ„ÉÜ„Éº„Ç≠
            right: 'shrimp', // Âè≥Ôºö„Ç®„Éì
        };

        // ÁèæÂú®„ÅÆÈÅ∏ÊäûÁä∂ÊÖã
        let platePuzzleState = {
            left: 'none',
            top: 'none',
            right: 'none',
        };

        // ÈÄèÈÅéÁîªÂÉè„Éû„ÉÉ„ÉóÔºàÂøÖ„ÅöÁî®ÊÑè„Åó„Å¶„Åä„ÅÑ„Å¶„Å≠Ôºâ
        const PLATE_INGREDIENT_IMAGES = {
            steak: IMAGES.modals.plateSteak,
            shrimp: IMAGES.modals.plateShrimp,
            salad: IMAGES.modals.plateSalad,
        };

        // „ÅäÁöø„Éë„Ç∫„É´„ÇíÈñã„ÅèÔºà„Ç≠„ÉÉ„ÉÅ„É≥„ÅÆ„ÄåÁõõ„Çä‰ªò„Åë„Çπ„Éö„Éº„Çπ„Äç„ÇØ„É™„ÉÉ„ÇØ„Åã„ÇâÂëº„Å∂Ôºâ
        function showPlatingPuzzle() {
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            const f = gameState.main.flags;

            // È£üÊùê„Çª„ÉÉ„Éà„Çí„Åæ„Å†ÂÖ•Êâã„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà
            if (!f.foundFoodSet) {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('„Åæ„Å†Áõõ„Çä‰ªò„Åë„ÇãÈ£üÊùê„Åå„Å™„ÅÑ„ÄÇÂÜ∑ËîµÂ∫´„Çí„Çà„ÅèË™ø„Åπ„Çà„ÅÜ„ÄÇ');
                return;
            }

            // „Åô„Åß„Å´Áõõ„Çä‰ªò„ÅëÊ∏à„Åø
            if (f.completedPlating) {
                mc.innerHTML = `
      <div style="text-align:center;">
        <p>„Åô„Åß„Å´A„Çª„ÉÉ„Éà„ÅØ„Åç„Çå„ÅÑ„Å´Áõõ„Çä‰ªò„Åë„Å¶„ÅÇ„Çã„ÄÇ</p>
        <div style="margin-top:8px;">
          <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
        </div>
      </div>
    `;
                modal.style.display = 'flex';
                return;
            }

            // Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            platePuzzleState = { left: 'none', top: 'none', right: 'none' };

            // „É¢„Éº„ÉÄ„É´„ÅÆ‰∏≠Ë∫´
            mc.innerHTML = `
    <div style="text-align:center;">
      <div style="margin-bottom:8px;font-weight:bold;">
        A„Çª„ÉÉ„Éà„Çí„Åç„Çå„ÅÑ„Å´Áõõ„Çä‰ªò„Åë„Çà„ÅÜ
      </div>

      <div id="platePuzzleView"
           style="position:relative;max-width:320px;margin:0 auto;">
        <!-- ÂúüÂè∞„ÅÆ„ÅäÁöø -->
        <img src="${IMAGES.modals.plate}"
             alt="plate"
             style="width:100%;display:block;margin:0 auto;">

        <!-- Â∑¶„Çπ„É≠„ÉÉ„Éà -->
        <img id="plateSlot_left"
             alt=""
             style="position:absolute;left:9%;top:46%;width:38%;
                    pointer-events:none;display:none;">

        <!-- ‰∏ä„Çπ„É≠„ÉÉ„Éà -->
        <img id="plateSlot_top"
             alt=""
             style="position:absolute;right:28%;top:12%;width:38%;
                    pointer-events:none;display:none;">

        <!-- Âè≥„Çπ„É≠„ÉÉ„Éà -->
        <img id="plateSlot_right"
             alt=""
             style="position:absolute;right:14%;top:43%;width:38%;
                    pointer-events:none;display:none;">
      </div>

      <!--<p style="margin-top:8px;font-size:0.9rem;">
        „Éú„Çø„É≥„ÇíÊäº„Åô„Å®
        „ÄåÔºà„Å™„ÅóÔºâ ‚Üí „Çπ„ÉÜ„Éº„Ç≠ ‚Üí „Ç®„Éì ‚Üí „Çµ„É©„ÉÄ„Äç
        „ÅÆÈ†Ü„Å´Âàá„ÇäÊõø„Çè„Çä„Åæ„Åô„ÄÇ
      </p>-->

      <div id="plateButtons"
           style="margin-top:4px;display:flex;flex-direction:column;
                  gap:4px;align-items:center;">
      </div>

      <div style="margin-top:10px;display:flex;justify-content:center;
                  gap:8px;flex-wrap:wrap;">
        <button class="text-btn" onclick="checkPlatingPuzzle()">OK</button>
        <button class="text-btn" onclick="resetPlatingPuzzle()">„É™„Çª„ÉÉ„Éà</button>
        <button class="text-btn" onclick="closeModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  `;

            modal.style.display = 'flex';

            // ÂàùÊúüÊèèÁîª
            renderPlateButtons();
            updatePlateOverlayAll();
        }

        // Ë°®Á§∫Âêç
        function plateDisplayName(v) {
            switch (v) {
                case 'steak': return '„Çπ„ÉÜ„Éº„Ç≠';
                case 'shrimp': return '„Ç®„Éì';
                case 'salad': return '„Çµ„É©„ÉÄ';
                default: return 'Ôºà„Å™„ÅóÔºâ';
            }
        }

        // „Éú„Çø„É≥Áæ§„ÅÆÊèèÁîª
        function renderPlateButtons() {
            const container = document.getElementById('plateButtons');
            if (!container) return;
            container.innerHTML = '';

            const labels = {
                left: 'Â∑¶',
                top: '‰∏ä',
                right: 'Âè≥',
            };

            ['left', 'top', 'right'].forEach(function (slot) {
                const btn = document.createElement('button');
                btn.className = 'text-btn';
                btn.textContent =
                    labels[slot] + 'Ôºö' + plateDisplayName(platePuzzleState[slot]);

                btn.onclick = function () {
                    cyclePlateSlot(slot);
                };

                container.appendChild(btn);
            });
        }

        // „Çπ„É≠„ÉÉ„Éà„Çí„Éà„Ç∞„É´„Åï„Åõ„Çã
        function cyclePlateSlot(slot) {
            const current = platePuzzleState[slot] || 'none';
            const idx = PLATE_PUZZLE_ORDER.indexOf(current);
            const next = PLATE_PUZZLE_ORDER[(idx + 1) % PLATE_PUZZLE_ORDER.length];
            platePuzzleState[slot] = next;

            renderPlateButtons();
            updatePlateOverlay(slot);
        }

        // ÊåáÂÆö„Çπ„É≠„ÉÉ„Éà„ÅÆ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÊõ¥Êñ∞
        function updatePlateOverlay(slot) {
            const imgEl = document.getElementById('plateSlot_' + slot);
            if (!imgEl) return;

            const ingredient = platePuzzleState[slot];
            const src = PLATE_INGREDIENT_IMAGES[ingredient];

            if (src) {
                imgEl.src = src;
                imgEl.style.display = 'block';
            } else {
                imgEl.src = '';
                imgEl.style.display = 'none';
            }
        }

        // ÂÖ®„Çπ„É≠„ÉÉ„Éà„ÅÆ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÊõ¥Êñ∞
        function updatePlateOverlayAll() {
            ['left', 'top', 'right'].forEach(updatePlateOverlay);
        }

        // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
        function resetPlatingPuzzle() {
            platePuzzleState = { left: 'none', top: 'none', right: 'none' };
            renderPlateButtons();
            updatePlateOverlayAll();
        }

        // Âà§ÂÆö
        function checkPlatingPuzzle() {
            const s = platePuzzleState;

            const ok =
                s.left === PLATE_PUZZLE_ANSWER.left &&
                s.top === PLATE_PUZZLE_ANSWER.top &&
                s.right === PLATE_PUZZLE_ANSWER.right;

            const niku = s.left === 'steak' &&
                s.top === 'steak' &&
                s.right === 'steak';

            if (ok) {
                if (!gameState.main.flags.completedPlating) {
                    gameState.main.flags.completedPlating = true;

                    if (typeof markProgress === 'function') {
                        markProgress('kitchen_plating_complete_23');
                        renderCanvasRoom();
                    }
                }

                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                showModal(
                    'A„Çª„ÉÉ„Éà„ÇíÁõõ„Çä‰ªò„Åë„Åü',
                    `<img src="${IMAGES.modals.aSetCompleted}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                updateMessage('A„Çª„ÉÉ„Éà„Çí„Åç„Çå„ÅÑ„Å´Áõõ„Çä‰ªò„Åë„Åü„ÄÇ');
                startKumaASetEvent();
                removeItem('foodSet');
                removeItem('steak');


            } else if (niku) {
                removeItem('foodSet');
                showShrimpCurseBadEnd();
            } else {
                if (typeof playSE === 'function') playSE('se-error');
                if (typeof showToast === 'function') {
                    showToast('‚Ä¶„Åì„ÅÆÁõõ„Çä‰ªò„Åë„Åß„ÅØ„Å™„ÅÑÊ∞ó„Åå„Åô„Çã„ÄÇ');
                } else {
                    updateMessage('‚Ä¶„Åì„ÅÆÁõõ„Çä‰ªò„Åë„Åß„ÅØ„Å™„ÅÑÊ∞ó„Åå„Åô„Çã„ÄÇ');
                }
            }
        }

        // ================================
        // A„Çª„ÉÉ„Éà„Çí„ÇØ„ÉûÂ¶ñÁ≤æ„Å´È£ü„Åπ„Åï„Åõ„Çã„Ç§„Éô„É≥„Éà
        // ================================

        function startKumaASetEvent() {
            const flags = gameState.main.flags || (gameState.main.flags = {});

            // ‰∫åÈáçÁô∫ÁÅ´Èò≤Ê≠¢Ôºà„Çª„Éº„ÉñÔºÜ„É≠„Éº„Éâ„Å™„Å©„Åß‰øùÈô∫Ôºâ
            if (flags.kumaASetEventDone) {
                showModal(
                    'A„Çª„ÉÉ„Éà„ÇíÁõõ„Çä‰ªò„Åë„Åü',
                    `
            <div style="margin-bottom: 12px;">
                <img src="${IMAGES.modals.aSet}" alt="A„Çª„ÉÉ„Éà" style="max-width: 100%; border-radius: 10px;">
            </div>
            <p>„Åï„Å£„Åç„ÇØ„ÉûÂ¶ñÁ≤æ„ÅåÂπ≥„Çâ„Åí„Å¶„ÅÑ„Å£„ÅüA„Çª„ÉÉ„Éà„ÅÆ„Åì„Å®„ÇíÊÄù„ÅÑÂá∫„Åó„Åü„ÄÇ</p>
            `,
                    [
                        { text: 'Èñâ„Åò„Çã', action: 'close', cssClass: 'text-btn' }
                    ]
                );
                return;
            }

            flags.kumaASetEventDone = true;

            showModal(
                'A„Çª„ÉÉ„Éà„ÅåÂÆåÊàê„Åó„ÅüÔºÅ‚Ä¶„Å®ÊÄù„Å£„Åü„Çâ„ÇØ„ÉûÂ¶ñÁ≤æ„ÅåÁèæ„Çå„Åü',
                `
<div class="modal-anim">
  <img src="${IMAGES.modals.aSetCompleted}">
  <img src="${IMAGES.modals.kumaAsetHungry}">
</div>
                                
        <!--<div style="margin-bottom: 12px;">
            <img src="${IMAGES.modals.kumaAsetHungry}" alt="È£ü„ÅÑ„Åó„ÇìÂùä„ÅÆ„ÇØ„ÉûÂ¶ñÁ≤æ" style="max-width: 400px; border-radius: 10px;">
        </div>-->
        <!--<p>A„Çª„ÉÉ„Éà„ÅÆ„ÅÑ„ÅÑÂåÇ„ÅÑ„Å´„Åï„Åù„Çè„Çå„Å¶„ÄÅ„ÇØ„ÉûÂ¶ñÁ≤æ„ÅåÁ™ÅÁÑ∂Áèæ„Çå„Åü„ÄÇ</p>-->
        <p>„Äå„Åù„ÅÆA„Çª„ÉÉ„Éà‚Ä¶‚Ä¶È£ü„Åπ„Åü„ÅÑ„Äç</p>
        `,
                [
                    {
                        text: 'A„Çª„ÉÉ„Éà„Çí„ÅÇ„Åí„Çã',
                        action: kumaASetStep2,
                        cssClass: 'text-btn'
                    }
                ]
            );
            playSE('se-bear-appear');

            updateMessage('„ÅÑ„ÅÑÂåÇ„ÅÑ„Å´„Å§„Çâ„Çå„Å¶„ÄÅ„ÇØ„ÉûÂ¶ñÁ≤æ„ÅåÁèæ„Çå„Åü„ÄÇ');
        }

        function kumaASetStep2() {
            showModal(
                '„ÅäÁöø„ÅØÁ©∫„Å£„ÅΩ„Å´„Å™„Å£„Åü',
                `
        <div class="modal-anim fast">
            <img src="${IMAGES.modals.aSetCompleted}">
            <img src="${IMAGES.modals.kumaAsetEmpty}">
        </div>
        <p>„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØA„Çª„ÉÉ„Éà„Çí„ÅÇ„Å£„Å®„ÅÑ„ÅÜÈñì„Å´Âπ≥„Çâ„Åí„Å¶„Åó„Åæ„Å£„Åü„ÄÇ</p>
        <p>„Äå„Åî„Å°„Åù„ÅÜ„Åï„ÅæÔºÅ„ÅäÁ§º„Å´„ÄÅÈ≠îÊ≥ï„Çí„Åã„Åë„Å¶„ÅÇ„Åí„ÇãÔºÅ„Äç</p>
        `,
                [
                    {
                        text: 'È≠îÊ≥ï„Çí„Åã„Åë„Å¶„ÇÇ„Çâ„ÅÜ',
                        action: kumaASetStep3,
                        cssClass: 'text-btn'
                    }
                ]
            );
            playSE('se-bear-eat');
        }

        function kumaASetStep3() {
            // ÊâãÂ∏≥„Å´„Éá„ÉÉ„Ç≠„Éâ„Ç¢„ÅÆ„Éí„É≥„Éà„ÇíËøΩË®ò
            addDeckDoorHintNote();

            showModal(
                '„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÂéª„Å£„Å¶„ÅÑ„Å£„Åü',
                `
        <div style="margin-bottom: 12px;">
            <img src="${IMAGES.modals.kumaAsetGoodbye}" alt="È£õ„Å≥Âéª„Çã„ÇØ„ÉûÂ¶ñÁ≤æ" style="max-width: 400px; border-radius: 10px;">
        </div>
        <p>„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÊ∫ÄË∂≥„Åù„ÅÜ„Å´Á©∫‰∏≠„Åß„Åè„Çã„Çä„Å®‰∏ÄÂõûËª¢„Åô„Çã„Å®„ÄÅÂÖâ„ÅÆÁ≠ã„ÇíÊÆã„Åó„Å¶È£õ„Å≥Âéª„Å£„Å¶„ÅÑ„Å£„Åü„ÄÇ</p>
        <p>„Äå„ÇØ„É´„ÉºÊâãÂ∏≥„Å´„ÄÅ„ÅÑ„ÅÑ„Åì„Å®„ÇíÊõ∏„ÅçË∂≥„Åó„Å¶„Åä„ÅÑ„Åü„ÇàÔºÅ„Å§„ÅÑ„Åß„Å´„Åì„Çå„ÇÇ„ÅÇ„Åí„ÇãÔºÅ„Äç</p>
        `,
                [
                    {
                        text: 'Èñâ„Åò„Çã',
                        action: 'close',
                        cssClass: 'text-btn'
                    }
                ]
            );
            addItem('cardkey');
            playSE('se-bear-flying');

            updateMessage('„ÇØ„É´„ÉºÊâãÂ∏≥„ÅÆ NOTES „Å´„Éí„É≥„Éà„Åå„É°„É¢„Åï„Çå„Åü„Çà„ÅÜ„Å†„ÄÇ„Å§„ÅÑ„Åß„Å´„Ç´„Éº„Éâ„Ç≠„Éº„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇ');
        }

        // ================================
        // „ÇØ„É´„ÉºÊâãÂ∏≥ NOTES „Å´„Éí„É≥„Éà„ÇíËøΩÂä†
        // ================================

        function addDeckDoorHintNote() {
            const flags = gameState.main.flags || (gameState.main.flags = {});

            const notesCap = document.querySelector('#notebook-tab-notes .notebook-cap');
            const notesBody = document.getElementById('notebook-notes-body');
            if (!notesBody) return;

            // „Åô„Åß„Å´Âêå„Åò„Éé„Éº„Éà„ÅåÊèè„ÅÑ„Å¶„ÅÇ„Çå„Å∞‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„É≠„Éº„ÉâÂæå„ÅÆ‰∫åÈáçËøΩÂä†Èò≤Ê≠¢Ôºâ
            if (notesBody.querySelector('.notebook-note.deck-door-hint')) {
                flags.notebookDeckHintAdded = true;
                return;
            }

            // „Ç≠„É£„Éó„Ç∑„Éß„É≥„ÅåÂàùÊúüÁä∂ÊÖã„Å™„ÇâÂ∑Æ„ÅóÊõø„Åà
            if (notesCap && notesCap.textContent.includes('Á©∫ÁôΩ„ÅÆ„Éö„Éº„Ç∏')) {
                notesCap.textContent = '„ÇØ„ÉûÂ¶ñÁ≤æ„ÅÆÈ≠îÊ≥ï„Åß„ÄÅ„ÅÑ„Å§„ÅÆÈñì„Å´„Åã„É°„É¢„ÅåÊõ∏„ÅçË∂≥„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ';
            }

            // ÂÆüÈöõ„ÅÆ„Éí„É≥„ÉàÊñá
            const p = document.createElement('p');
            p.className = 'notebook-note deck-door-hint';
            p.textContent = '„Åì„ÅÆËàπ„Åã„ÇâËÑ±Âá∫„Åô„Çã„Å´„ÅØ„ÄÅ„Äådistress„Äç„Éú„Çø„É≥„ÇíÈï∑Êäº„Åó„Åó„Çà„ÅÜ„ÄÇ';
            notesBody.appendChild(p);
            const p2 = document.createElement('p');
            p2.className = 'notebook-note deck-door-hint';
            p2.textContent = 'Ë≠¶ÂÇô„Çª„É≥„Çø„ÉºÔºöÂÜÖÁ∑ö301';
            notesBody.appendChild(p2);

            flags.notebookDeckHintAdded = true;
        }


        function showShrimpCurseBadEnd() {
            // ÂøÖË¶Å„Å™„Çâ„Åì„Åì„ÅßÂäπÊûúÈü≥
            playSE && playSE('se-zukkoke');

            window._nextModal = {
                title: '„ÄêBAD END„Äë„Ç®„Éì„ÅÆÂë™„ÅÑ',
                content: `
        <div class="modal-anim">
            <!-- 1ÊûöÁõÆÔºöËÇâËÇâÁõõ„Éó„É¨„Éº„ÉàÔºàÈÄöÂ∏∏Ôºâ -->
            <img src="${IMAGES.modals.shrimpAngry}" alt="„Ç®„Éì„ÅÆÊÄí„Çä">

            <!-- 2ÊûöÁõÆÔºö„Ç®„Éì„ÅÆÊÄ®Âøµ„ÅåÁô∫Âãï„Åó„Åü„Éó„É¨„Éº„Éà -->
            <img src="${IMAGES.modals.shrimpBad}" alt="„Ç®„Éì„ÅÆÂë™„ÅÑ">
        </div>

        <p style="margin-top:8px;">
            ËÇâ„Å∞„Åã„ÇäÁõõ„Çâ„Çå„ÅüA„Çª„ÉÉ„Éà„ÇíË¶ã„Å¶„ÄÅ„Ç®„Éì„Åü„Å°„ÅÆÊÄí„Çä„ÅåÁàÜÁô∫„Åó„Åü‚îÄ‚îÄ„ÄÇ<br>
            Ëàπ„ÅØÂ∑®Â§ß„Ç®„Éì„ÅÆÁæ§„Çå„Å´Âèñ„ÇäÂõ≤„Åæ„Çå„ÄÅÈùô„Åã„Å´Ëà™Ë∑Ø„ÇíÂ§ñ„Çå„Å¶„ÅÑ„Å£„Åü‚Ä¶‚Ä¶„ÄÇ
        </p>
        `,
                buttons: [
                    { text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart' }
                ],
                before() {
                    screenFlash('black');
                    pauseBGM && pauseBGM();
                    playSE('se-ebi');
                },
                after() {
                    playSE('se-tirori');


                }
            };

            showModal(
                'A„Çª„ÉÉ„ÉàÔºü„ÅåÂÆåÊàê„Åó„ÅüÔºÅ',
                `<img src="${IMAGES.modals.aSetNiku}" alt="ËÇâÁõõ„Éó„É¨„Éº„Éà" style="max-width: 400px; border-radius: 10px;">`,
                [
                    {
                        text: 'OK',
                        action: 'close'
                    }
                ]
            );
        }

        function showVoidBadEnd() {
            // ÈõªË©±„Éé„Ç§„Ç∫„Åã„Çâ‰∏ñÁïå„ÅåÂ¥©„ÇåÂßã„ÇÅ„ÇãÊÑü„Åò
            playSE && playSE('se-noise');

            // Ê¨°„Å´Âá∫„Åô BAD END „É¢„Éº„ÉÄ„É´„Çí‰∫àÁ¥Ñ
            window._nextModal = {
                title: '„ÄêBAD END„ÄëËôöÁÑ°',
                content: `
                <p>
                    ÈõªË©±„ÅÆË°®Á§∫„Åã„Çâ„ÄÅÊï∞Â≠ó„Åå„Åô„Å£„Å®Ê∫∂„Åë„Å¶Ê∂à„Åà„Åü„ÄÇ<br>
                </p>
                <p>
                    ÊÆã„Å£„Åü„ÅÆ„ÅØ„ÄÅ‰Ωï„ÇÇÊèè„Åã„Çå„Å¶„ÅÑ„Å™„ÅÑÈªí„ÅÑËÉåÊôØ„Å®„ÄÅ<br>
                    „Åï„Å£„ÅçËá™ÂàÜ„ÅåÊäº„Åó„Åü„Ç≠„Éº„ÅÆÈü≥„Å†„Åë„Å†„ÄÇ<br>
                    ‚Ä¶‚Ä¶„Åì„Åì„Åã„ÇâÊàª„ÇãÊâãÊÆµ„ÅØ„ÄÅÁî®ÊÑè„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÄÇ
                </p>
                `,
                buttons: [
                    { text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart' }
                ],
                before() {
                    // „Å°„Çá„Å£„Å®Âº∑„ÇÅ„ÅÆÁôΩ„Éï„É©„ÉÉ„Ç∑„É•ÔºãBGMÂÅúÊ≠¢„Åß„Äå‰∏ñÁïåËêΩ„Å°„Åü„ÄçÊÑü
                    screenFlash && screenFlash('white', 420);
                    pauseBGM && pauseBGM();
                },
                after() {
                    // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÂäπÊûúÈü≥
                    playSE && playSE('se-glich');
                }
            };

            // Áõ¥Ââç„Å´„ÇÇ„ÅÜ‰∏ÄÊÆµ„ÄåÁô∫‰ø°ÁµêÊûú„Äç„ÇíÊåü„Çì„Åß„Åò„Çè„Åò„Çè„Åï„Åõ„Çã
            showModal(
                'Áô∫‰ø°ÁµêÊûú',
                `
                <p>‚Ä¶‚Ä¶‰Ωï„ÇÇËøî„Å£„Å¶„Åì„Å™„ÅÑ„ÄÇ</p>
                <p>ËÄ≥„ÅÆÂ••„Åß„ÄÅ„Åï„Å£„ÅçÊäº„Åó„Åü„ÅØ„Åö„ÅÆ„Éú„Çø„É≥Èü≥„Å†„Åë„Åå„ÄÅ„ÅÑ„Å§„Åæ„Åß„ÇÇÂèçÈüø„Åó„Å¶„ÅÑ„ÇãÊ∞ó„Åå„Åô„Çã„ÄÇ</p>
                `,
                [{ text: 'Âàá„Çã', action: 'close' }]
            );
        }



        // ===== distress Èï∑Êäº„Åó SOS „Ç®„É≥„Éâ =====

        function showDistressModal() {
            const content = `
        <div style="text-align:center; margin-top:4px;">
            <p style="margin-bottom:6px;">
                3ÁßíÈñìÊäº„ÅóÁ∂ö„Åë„Çã„Å®„ÄÅÊïëÈõ£‰ø°Âè∑„ÇíÁô∫‰ø°„Åó„Åæ„Åô„ÄÇ
            </p>
            <button id="distressBtn" class="text-btn distress-btn">
                üö® DISTRESS / SOS üö®
            </button>
            <div id="distressHint" class="distress-hint">
                ‚Äª Èõ¢„Åô„Å®„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åô„ÄÇ
            </div>
        </div>
    `;

            showModal(
                'Á∑äÊÄ•„Éú„Çø„É≥',
                content,
                [
                    { text: '„ÇÑ„ÇÅ„Å¶„Åä„Åè', action: 'close' }
                ],
                null,
                { columnButtons: false }
            );

            setupDistressButton();
        }

        function setupDistressButton() {
            const btn = document.getElementById('distressBtn');
            const hint = document.getElementById('distressHint');
            if (!btn) return;

            let timer = null;
            let finished = false;

            function startPress(e) {
                e.preventDefault();
                if (finished || timer) return;

                btn.classList.add('distress-holding');
                hint.textContent = 'Èï∑Êäº„Åó‰∏≠‚Ä¶';
                timer = setTimeout(() => {
                    timer = null;
                    finished = true;
                    handleDistressSuccess(btn, hint);
                }, 3000); // 3Áßí
            }

            function cancelPress(e) {
                if (e) e.preventDefault();
                if (finished) return;
                if (timer) {
                    clearTimeout(timer);
                    timer = null;
                }
                btn.classList.remove('distress-holding');
                hint.textContent = '3Áßí‰ª•‰∏äÊäº„ÅóÁ∂ö„Åë„Çã„Å®SOS„ÇíÁô∫‰ø°„Åó„Åæ„Åô„ÄÇ';
            }

            // PCÁî®
            btn.addEventListener('mousedown', startPress);
            btn.addEventListener('mouseup', cancelPress);
            btn.addEventListener('mouseleave', cancelPress);

            // „Çπ„Éû„Éõ„Éª„Çø„Éñ„É¨„ÉÉ„ÉàÁî®
            btn.addEventListener('touchstart', startPress, { passive: false });
            btn.addEventListener('touchend', cancelPress, { passive: false });
            btn.addEventListener('touchcancel', cancelPress, { passive: false });
        }

        function handleDistressSuccess(btn, hint) {
            btn.classList.remove('distress-holding');
            btn.disabled = true;
            hint.textContent = 'SOS‰ø°Âè∑„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü‚Ä¶';

            // Ëµ§„Éï„É©„ÉÉ„Ç∑„É•
            screenFlash('red');
            playSE('se-push1'); // Â•Ω„Åç„Å™SE„Å´Â∑Æ„ÅóÊõø„ÅàÂèØ

            // Èªí„Éï„Çß„Éº„Éâ ‚Üí room:end „Å∏
            const overlay = document.getElementById('roomEffectOverlay');

            setTimeout(() => {
                if (overlay) {
                    overlay.style.transition = 'opacity 0.8s ease';
                    overlay.style.background = '#000';
                    overlay.style.opacity = 1;
                }

                setTimeout(() => {
                    closeModal();
                    changeRoom('end');  // Normal end „Å∏

                    // Èªí„Åã„Çâ„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                    setTimeout(() => {
                        if (overlay) overlay.style.opacity = 0;
                    }, 700);
                }, 900);
            }, 400);
        }

        // ==== ÊìçËàµÂÆ§ÔºöÂ∫ßÊ®ôÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ ====

        // ‚òÖÊ≠£Ëß£Â∫ßÊ®ô
        //   1Ë°åÁõÆ„Éª2Ë°åÁõÆ„Éª3Ë°åÁõÆ„ÅßÂà§ÂÆö
        const TREASURE_COORDINATE = {
            line1: '19',
            line2: '162',

        };

        // ÂÖ®ËßíÊï∞Â≠ó‚ÜíÂçäËßíÊï∞Â≠óÔºÜÁ©∫ÁôΩÈô§Âéª
        function normalizeCoordInput(str) {
            if (!str) return '';
            return str
                .replace(/[Ôºê-Ôºô]/g, ch =>
                    String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
                )
                .replace(/\s+/g, '');
        }

        // Â∫ßÊ®ôÂÖ•Âäõ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function showCoordinateInputModal() {
            const modal = document.getElementById('modal');
            const mc = document.getElementById('modalContent');
            if (!modal || !mc) return;

            const body = `
      <div style="text-align:center;">
        <p style="margin-bottom:8px;">
          Â∫ßÊ®ô„Çí„ÄÅÊï¥Êï∞„ÅßÂÖ•Âäõ„Åó„Å¶„Åø„Çà„ÅÜ„ÄÇ
        </p>

        <div style="
          display:flex;
          flex-direction:column;
          gap:6px;
          align-items:center;
          margin-bottom:8px;
        ">
          <input id="coordLine1"
                 type="text"
                 class="puzzle-input"
                 placeholder="Êù±Ë•øÊñπÂêë"
                 maxlength="16"
                 style="max-width:220px;width:80%;">

          <input id="coordLine2"
                 type="text"
                 class="puzzle-input"
                 placeholder="ÂçóÂåóÊñπÂêë"
                 maxlength="16"
                 style="max-width:220px;width:80%;">

          
        </div>

        <div style="margin-top:4px;">
          <button class="text-btn" onclick="checkCoordinateInput()">OK</button>
          <button class="text-btn" onclick="closeModal()">Èñâ„Åò„Çã</button>
        </div>
      </div>
    `;

            mc.innerHTML = body;
            modal.style.display = 'flex';

            // „Éï„Ç©„Éº„Ç´„ÇπÂΩì„Å¶„Å¶„Åä„Åè
            setTimeout(() => {
                const first = document.getElementById('coordLine1');
                if (first) first.focus();
            }, 0);
        }

        // ÂÖ•Âäõ„ÉÅ„Çß„ÉÉ„ÇØ
        function checkCoordinateInput() {
            const el1 = document.getElementById('coordLine1');
            const el2 = document.getElementById('coordLine2');

            if (!el1 || !el2) {
                closeModal();
                return;
            }

            const v1 = normalizeCoordInput(el1.value.trim());
            const v2 = normalizeCoordInput(el2.value.trim());

            const ok =
                v1 === TREASURE_COORDINATE.line1 &&
                (v2 === TREASURE_COORDINATE.line2 || v2 === TREASURE_COORDINATE.line2 + 1);

            if (!ok) {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶‚Ä¶„Åì„ÅÆÂ∫ßÊ®ô„Åß„ÅØ„Å™„ÅÑ„Çà„ÅÜ„Å†„ÄÇ');
                return;
            }

            // Ê≠£Ëß£ÊôÇ
            gameState.main.flags.treasureCoordinateSet = true;
            if (typeof playSE === 'function') playSE('se-clear');
            if (typeof markProgress === 'function') {
                markProgress('wheelhouse_coordinate_ok');
            }

            closeModal();

            showModal(
                'Ëà™Ë∑Ø„ÇíË®≠ÂÆö„Åó„Åü',
                `
          <p>ÂÆùÂ≥∂„Å∏„ÅÆÂ∫ßÊ®ô„ÇíÂÖ•Âäõ„Åó„Åü„ÄÇ</p>
          <p>Ëàπ„ÅØ„ÇÜ„Å£„Åè„Çä„Å®ÈÄ≤Ë∑Ø„ÇíÂ§â„ÅàÂßã„ÇÅ„Çã‚Ä¶‚Ä¶„ÄÇ</p>
        `,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );

            updateMessage('ÂÆùÂ≥∂„Å∏„ÅÆËà™Ë∑Ø„ÇíË®≠ÂÆö„Åó„Åü„ÄÇ');
            travelWithStepsTrueEnd();
        }


        // ==== ÂÄâÂ∫´„Éâ„Ç¢Ôºö4Ê°Å„Ç≥„Éº„Éâ„Äå8834„Äç„Éë„Ç∫„É´ ====

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showStorageDoorPanelPuzzle() {
            const f = gameState.main.flags;
            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ‰∏ÄË®Ä„É°„ÉÉ„Çª„Éº„Ç∏„Å†„Åë
            if (f.unlockStorageDoor) {
                const modalContent = `
            <div style="text-align:center;">
                <p>ÂÄâÂ∫´„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„ÅØ„Åô„Åß„Å´Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ</p>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        `;
                mc.innerHTML = modalContent;
                modal.style.display = 'flex';
                return;
            }

            // „É≠„ÉÉ„ÇØ‰∏≠Ôºö4Ê°ÅÂÖ•Âäõ
            const modalContent = `
        <div style="text-align:center;">
            <h3 style="margin:4px 0 10px 0;font-size:1.1em;">ÂÄâÂ∫´„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„Éë„Éç„É´„Å†</h3>
            <input type="text"
                   id="storageDoorCodeInput"
                   class="puzzle-input"
                   placeholder="4Ê°Å„ÅÆÊï∞Â≠ó"
                   style="max-width:220px;width:70%;">
            <div style="margin-top:8px;">
                <button onclick="checkStorageDoorPanelPuzzle()" class="text-btn">OK</button>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;

            mc.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        // Á≠î„Åà„ÉÅ„Çß„ÉÉ„ÇØÔºà8834Ôºâ
        function checkStorageDoorPanelPuzzle() {
            const inputEl = document.getElementById('storageDoorCodeInput');
            if (!inputEl) return;

            const raw = inputEl.value.trim();

            // ÂÖ®ËßíÊï∞Â≠ó ‚Üí ÂçäËßíÊï∞Â≠ó„Å´Â§âÊèõ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch =>
                String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
            );
            const val = z2h(raw);

            if (val === '8834') {
                gameState.main.flags.unlockStorageDoor = true;

                if (typeof playSE === 'function') playSE('se-cyber');

                closeModal();
                updateMessage('ÂÄâÂ∫´„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü„ÄÇ');

                if (typeof renderCanvasRoom === 'function') {
                    renderCanvasRoom();
                }
            } else {
                if (typeof playSE === 'function') playSE('se-error');
                updateMessage('‚Ä¶„É≠„ÉÉ„ÇØ„ÅØÂ§ñ„Çå„Å™„ÅÑ„Çà„ÅÜ„Å†„ÄÇ');
            }
        }

        let wipeStep = 0;

        function showPlateModal() {
            const modal = document.getElementById('modal');
            const mc = document.getElementById('modalContent');

            // wipeStep = 0;

            mc.innerHTML = `
      <div style="position:relative; width:320px; margin:0 auto;">
         <img src="${IMAGES.items.plateClean}" style="width:100%;">
         <img id="dirtLayer" src="${IMAGES.items.dirt}"
              style="position:absolute; top:0; left:0; width:100%;">
      </div>
      <div id="msg"></div>

      <button onclick="wipeDirt()" class="text-btn">„Ç¶„Çß„ÉÉ„Éà„ÉÜ„Ç£„ÉÉ„Ç∑„É•„ÅßÊã≠„Åè</button>
      <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
    `;

            modal.style.display = 'flex';
        }

        function wipeDirt() {
            const dirt = document.getElementById('dirtLayer');

            // ‚òÖ „Åô„Åß„Å´Á∂∫È∫ó„Å´„Å™„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (wipeStep >= 2) {
                document.getElementById('msg').innerText = "„ÇÇ„ÅÜ„Åç„Çå„ÅÑ„Å†„ÄÇ";
                updateMessage("„ÇÇ„ÅÜ„Åç„Çå„ÅÑ„Å†„ÄÇ");
                // if (typeof playSE === 'function') playSE('se-cloth');
                return;
            }

            wipeStep++;

            if (wipeStep === 1) {
                dirt.src = IMAGES.items.dirt2;  // 50%ËñÑ„ÅÑ„Éê„Éº„Ç∏„Éß„É≥
                updateMessage("‚Ä¶‚Ä¶„Åæ„Å†„Å°„Çá„Å£„Å®Ê±ö„ÅÑ„ÄÇ");
                if (typeof playSE === 'function') playSE('se-cloth');  // „Ç≥„Çπ„Ç≥„ÇπÈü≥
                return;
            }

            // ‚òÖ 2ÂõûÁõÆ„ÅßÁ∂∫È∫ó„Å´„Å™„Çã
            if (wipeStep === 2) {
                dirt.style.opacity = 0;
                updateMessage("Ê±ö„Çå„ÅåËêΩ„Å°„Å¶„ÄÅÈäòÊùø„ÅÆÊñáÂ≠ó„ÅåË™≠„ÇÅ„Çã„Çà„ÅÜ„Å´„Å™„Å£„ÅüÔºÅ");
                gameState.main.flags.cleanDirt = true;
                renderCanvasRoom();
                removeItem('wetpaper');

                if (typeof playSE === 'function') playSE('se-clear');  // „Éî„Ç´„Éº„É≥Èü≥
                return;
            }
        }

        function showClockPuzzle() {
            if (!gameState.main.flags.bearAppear) {
                updateMessage('„Åæ„Å†ÂèçÂøú„Åó„Å™„ÅÑ„Çà„ÅÜ„Å†');
                return;
            }
            // Êó¢„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„Åù„ÅÆÊó®„Å†„Åë
            if (gameState.main.flags.unlockClock) {
                return;
            }

            const content = `
            <div><img src="${IMAGES.modals.clock}"
                     style="max-width:380px;height:auto;display:block;margin:0 auto;"></div>
        <div style="
            display:flex;
            justify-content:center;
            align-items:center;
            gap:8px;
            margin:12px 0;
        ">
        
            <input id="hourInput"
                type="text"
                inputmode="numeric"
                maxlength="2" placeholder="hh"
                style="width:40px;padding:4px;text-align:center;font-size:1.2rem;">
            <span style="font-size:1.2rem;">:</span>
            <input id="minuteInput"
                type="text"
                inputmode="numeric"
                maxlength="2" placeholder="mm"
                style="width:40px;padding:4px;text-align:center;font-size:1.2rem;">
                <span style="font-size:1.2rem;">:</span>
            <input id="secondInput"
                type="text"
                inputmode="numeric" placeholder="ss"
                maxlength="2"
                style="width:40px;padding:4px;text-align:center;font-size:1.2rem;">
        </div>
    `;

            showModal(
                'ÊôÇË®à',
                content,
                [
                    { text: 'OK', action: checkClockInput },
                    { text: 'Èñâ„Åò„Çã', action: 'close' }
                ]
            );
        }

        function checkClockInput() {
            const hourEl = document.getElementById('hourInput');
            const minEl = document.getElementById('minuteInput');
            const secEl = document.getElementById('secondInput');
            if (!hourEl || !minEl || !secEl) {
                // ‰Ωï„Åã„Åä„Åã„Åó„Åã„Å£„Åü„Çâ„Å®„Çä„ÅÇ„Åà„ÅöÈñâ„Åò„Çã
                closeModal();
                return;
            }

            const hour = hourEl.value.trim();
            const minute = minEl.value.trim();
            const second = secEl.value.trim();

            const isOk = (hour === '12' && minute === '23' && second === '23');

            if (!isOk) {
                closeModal();
                showModal(
                    '',
                    '‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                if (typeof playSE === 'function') playSE('se-error');
                return;
            }

            gameState.main.flags.unlockClock = true;

            if (typeof playSE === 'function') playSE('se-clear');

            closeModal();
            showModal(
                '„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„Çà„ÅÜ„Å™Èü≥„Åå„Åó„Åü',
                '',
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );
            updateMessage('„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„Çà„ÅÜ„Å™Èü≥„Åå„Åó„Åü');
            markProgress('clock_unlock_22');

            if (typeof renderCanvasRoom === 'function') {
                renderCanvasRoom();
            }

        }


        // „Éâ„Ç¢„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showDoorPuzzle() {

            let msg = '';
            const modalContent = `
                <h3>„Éâ„Ç¢„ÅÆÊìç‰Ωú„Éë„Éç„É´„ÅÆ„Çà„ÅÜ„Å†</h3>
                <p>${msg}</p>
                <input type="text" class="puzzle-input" id="doorInput" placeholder="Êï∞Â≠ó">
                <br>
                <button onclick="checkDoorPuzzle()">OK</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // „Éâ„Ç¢„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkDoorPuzzle() {
            const v = document.getElementById('doorInput').value.trim();
            // ÂÖ®ËßíÂØæÁ≠ñ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === '3849') {
                if (gameState.main.flags.unlockDoor) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('„Åô„Åß„Å´„Éâ„Ç¢„É≠„ÉÉ„ÇØ„ÅØËß£Èô§„Åï„Çå„Å¶„ÅÑ„Çã');
                    return;
                }
                closeModal();
                gameState.main.flags.unlockDoor = true;

                markProgress('door_normal_unlock_23');

                showModal(
                    '„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                updateMessage('„Éâ„Ç¢„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü„ÄÇ');
                playSE('se-clear');
                renderCanvasRoom();

            } else {
                playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }



        function showNewspaperModal() {
            playSE('se-paper');

            showModal(
                'Âè§„ÅÑÊñ∞ËÅû„ÅÆÂàá„ÇåÁ´Ø',
                `
      <div class="newspaper" style="text-align:left;">
        
        <!-- Êñ∞ËÅû„ÅÆÂÜôÁúü„Ç®„É™„Ç¢ -->
        <div style="text-align:center; margin-bottom:14px;">
          <img src="${IMAGES.items.newsPaperPic}"
               style="width:90%; max-width:420px; border:2px solid #444; box-shadow:0 0 6px #0008;">
        </div>

        <h2 style="margin:6px 0 0 0;">Â±±Èñì„ÅÆÈõÜËêΩ„ÅßÈÄ£Á∂öÊÆ∫‰∫∫‰∫ã‰ª∂</h2>
        <p class="subtitle" style="margin-top:0; font-size:0.95em; color:#ccc;">
          Ôºì‰∫∫ÁõÆ„ÅÆË¢´ÂÆ≥ËÄÖ„ÄÅÁäØË°å„ÅØÂêå‰∏Ä‰∫∫Áâ©„Åã
        </p>

        <p>14Êó•Êú™Êòé„ÄÅÂ∏ÇÂÜÖÂåóÈÉ®„ÅÆÂ±±Êûó„Åß20‰ª£Â•≥ÊÄß„ÅåÊ≠ª‰∫°„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅåË¶ã„Å§„Åã„Å£„Åü„ÄÇË≠¶ÂØü„ÅÆÁô∫Ë°®„Å´„Çà„Çã„Å®„ÄÅË¢´ÂÆ≥ËÄÖ„ÅØÂâçÊó•Â§ïÊñπ„Åã„ÇâË°åÊñπ„Åå„Çè„Åã„Çâ„Åö„ÄÅÂèã‰∫∫„ÅÆÈÄöÂ†±„Å´„Çà„ÇäÊçúÁ¥¢„ÅåË°å„Çè„Çå„Å¶„ÅÑ„Åü„ÄÇ</p>
        <p>ÈÅ∫‰ΩìÁô∫Ë¶ãÁèæÂ†¥„ÅØ„Éè„Ç§„Ç≠„É≥„Ç∞„Ç≥„Éº„Çπ„Åã„ÇâÂ§ñ„Çå„ÅüÂ∞è„Åï„Å™Á©∫„ÅçÂú∞„Åß„ÄÅ‰∫â„Å£„ÅüÂΩ¢Ë∑°„ÅØ„Åª„Å®„Çì„Å©„Å™„Åã„Å£„Åü„ÄÇÊâÄÊåÅÂìÅ„ÅÆÂ§ßÂçä„ÅØ„Åù„ÅÆÂ†¥„Å´ÊÆã„Åï„Çå„Å¶„ÅÑ„Åü„Åå„ÄÅË¢´ÂÆ≥ËÄÖ„ÅåÂ∏∏„Å´Êê∫Â∏Ø„Åó„Å¶„ÅÑ„Åü„Å®„ÅÑ„ÅÜ„Ç∏„É≥„Ç∏„É£„Éº„Éû„É≥Âûã„ÅÆ„Å¨„ÅÑ„Åê„Çã„Åø „ÅåË∑°ÂΩ¢„ÇÇ„Å™„ÅèÊ∂à„Åà„Å¶„Åä„Çä„ÄÅË≠¶ÂØü„ÅØÁäØ‰∫∫„ÅåÊåÅ„Å°Âéª„Å£„ÅüÂèØËÉΩÊÄß„ÇÇ„ÅÇ„Çã„Å®„Åø„Å¶Ë™ø„Åπ„Å¶„ÅÑ„Çã„ÄÇ</p>
<p>Ë≠¶ÂØü„ÅØ„ÄÅÁèæÂ†¥„ÅÆÁä∂Ê≥Å„Åå„Åì„Çå„Åæ„Åß„ÅÆ‰∫ã‰ª∂„Å®È°û‰ºº„Åó„Å¶„ÅÑ„ÇãÁÇπ„Åã„ÇâÂêå‰∏ÄÁäØ„Å´„Çà„ÇãË®àÁîªÁöÑ„Å™ÁäØË°å„Å®„Åø„Å¶ÊçúÊüª„ÇíË°å„Å£„Å¶„ÅÑ„Çã„ÄÇ</p>

        <p>
          Âú∞Âüü‰ΩèÊ∞ë„ÅÆË®ºË®Ä„Å´„Çà„Çå„Å∞„ÄÅ„ÄåÂ∏ΩÂ≠ê„ÇíÊ∑±„Åè„Åã„Å∂„Å£„ÅüÂΩ±„Äç„Çí
          ‰ΩïÂ∫¶„ÅãË¶ã„Åã„Åë„Åü„Å®„ÅÑ„ÅÜ„ÄÇÁäØË°å„Å®„ÅÆÈñ¢ÈÄ£„ÅØ‰∏çÊòé„ÄÇ
        </p>

        <p style="margin-top:14px;color:#a33;font-size:0.9em;">
          ‚Äª Á´Ø„Å´Ëµ§„ÅÑÊâãÊõ∏„Åç„É°„É¢Ôºö<br>
          „Äå„ÇÇ„ÅÜÊ≠¢„ÇÅ„Çâ„Çå„Å™„ÅÑ‚Ä¶„Äç
        </p>
      </div>
    `,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );

            gameState.main.flags.readNewspaper = true;
        }




        function handleDoor() {
            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÈÅ∑ÁßªÂÖ±ÈÄö„Éè„É≥„Éâ„É©
            const goEnding = () => {
                if (gameState.flags.trueEndUnlocked) {
                    gameState.endings.true = true;
                    travelWithStepsTrueEnd();
                } else if (gameState.main.flags.blockManStatus >= 2 && gameState.main.flags.blockManStatus < 5) {
                    changeRoom('endWorse');
                } else if (hasItem('hat')) {
                    showModal(
                        '„Åì„ÅÆÂ∏ΩÂ≠ê„ÇíÊåÅ„Å£„Å¶Â∏∞„Çä„Åü„Åè„Å™„ÅÑ„Å™',
                        `<img src="${IMAGES.items.hat}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    return;
                } else if (gameState.main.flags.isNight) {
                    updateMessage('Â§úÈÅì„ÅØÂç±Èô∫„Å™„ÅÆ„Åß„ÇÑ„ÇÅ„Å¶„Åä„Åì„ÅÜ');
                    return;
                } else {
                    updateMessage('„Åæ„Å†Èñã„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');
                    return;
                }
            };

            goEnding();
        }

        function showObj(flagKey, title, imgSrc, msg) {
            const f = gameState.main.flags;
            if (flagKey) {
                // Ë¶ã„Åü„Åì„Å®„Çí„Éï„É©„Ç∞ÁÆ°ÁêÜ„Åô„ÇãÂ†¥Âêà
                f[flagKey] = true;
            }

            showModal(
                title,
                `<img src="${imgSrc}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );
            updateMessage(msg);
        }


        // „Ç¢„Ç§„ÉÜ„É†ÁÆ°ÁêÜ
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 8) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            } else {
                updateMessage('„Ç¢„Ç§„ÉÜ„É†Ê¨Ñ„Åå„ÅÑ„Å£„Å±„ÅÑ„Å†„ÄÇ„Å©„Åì„Åã„ÅßÊ∏õ„Çâ„Åó„Å¶„Åì„Çà„ÅÜ');
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }

        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            const clickedItem = gameState.inventory[slotIndex];

            if (!clickedItem) return;

            // ‚òÖ„Åô„Åß„Å´ÈÅ∏Êäû‰∏≠„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÇíÂÜç„ÇØ„É™„ÉÉ„ÇØ ‚Üí Ëß£Èô§
            if (gameState.selectedItemSlot === slotIndex) {
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateMessage('„Ç¢„Ç§„ÉÜ„É†ÈÅ∏Êäû„ÇíËß£Èô§„Åó„Åæ„Åó„Åü„ÄÇ');
                updateInventoryDisplay();
                return;
            }

            // ‚òÖÈÄöÂ∏∏„ÅÆÈÅ∏Êäû
            gameState.selectedItem = clickedItem;
            gameState.selectedItemSlot = slotIndex;
            updateMessage(`${getItemName(clickedItem)}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ‰ΩøÁî®„Åó„Åü„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            updateInventoryDisplay();
        }

        function getItemName(itemId) {
            const names = {
                coin: '„ÇØ„Éû„Ç≥„Ç§„É≥',
                bear: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                notebook: '„ÇØ„É´„Éº„ÅÆÊâãÂ∏≥',
                wetpaper: '„Ç¶„Çß„ÉÉ„Éà„ÉÜ„Ç£„ÉÉ„Ç∑„É•',
                foodSet: 'A„Çª„ÉÉ„Éà„ÅÆÈ£üÊùê',
                steak: 'ÁÑº„Åç„Åü„Å¶„Çπ„ÉÜ„Éº„Ç≠',
                keyFrozen: 'Âáç„Å£„ÅüÈçµ',
                key: 'Èçµ',





            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            if (gameState.currentRoom === 'saint') return;
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;

                btn.onclick = () => changeRoom(roomId);

                // btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        function addNaviItem(room) {
            if (!gameState.openRooms.includes(room)) {
                gameState.openRooms.push(room);
                return true;
            }
            return false;
        }

        // „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫Êõ¥Êñ∞
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function () {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                    const magBtn = document.createElement('div');
                    magBtn.className = 'magnifier-btn';
                    magBtn.title = 'Êã°Â§ßË°®Á§∫';
                    magBtn.innerHTML = '<img src="images/magnifier.png" alt="Êã°Â§ß">';
                    magBtn.onclick = (e) => {
                        e.stopPropagation();

                        const itemId = gameState.inventory[index];

                        // „Éá„Éï„Ç©„ÅÆ‰∏≠Ë∫´
                        let content = `<img src="${img.src}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`;
                        let buttons = [{ text: 'Èñâ„Åò„Çã', action: 'close' }];

                        // „Éû„É≥„Éà„Å™„Çâ„ÄåË™ø„Åπ„Çã„Äç„Éú„Çø„É≥„ÇíËøΩÂä†ÔºàÈçµÊú™ÂÖ•ÊâãÔºÜÊú™Áô∫Ë¶ã„Éï„É©„Ç∞ÊôÇ„ÅÆ„ÅøÔºâ
                        if (itemId === 'notebook') {
                            buttons = [
                                {
                                    text: 'Èñã„Åè', action: () => {
                                        closeModal();
                                        openNotebook();
                                        return;
                                    }
                                },
                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                            ];
                        }

                        showModal(
                            getItemName(itemId),
                            content,
                            buttons
                        );
                    };
                    slot.appendChild(magBtn);
                }
                // ‚òÖÈÅ∏Êäû‰∏≠„Å™„Çâselected„ÇØ„É©„ÇπËøΩÂä†
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }


        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        function updateMessage(message) {
            //document.getElementById('messageArea').innerHTML = message;
            document.getElementById('msgText').textContent = message;
        }

        function updateMessageHTML(html) {
            const el = document.getElementById('msgText');
            el.innerHTML = html;
            el.querySelectorAll('a').forEach(a => {
                a.target = '_blank';
                a.rel = 'noopener';
                a.style.color = '#d4af37';
                a.style.textDecoration = 'underline';
            });
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content, buttons, onSequenceSuccess, options) {
            options = options || {};
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            if (buttons && buttons.length > 0) {
                const columnStyle = options.columnButtons
                    ? 'display:flex; flex-direction:column; gap:12px; align-items:stretch;'
                    : 'text-align:center; display:flex; gap:10px; justify-content:center;';

                modalHtml += `<div id="modalButtons" style="${columnStyle}"></div>`;
                modalHtml += `<div id="modalClose" style="margin-top:25px;text-align:center;"></div>`;
            }
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';

            if (!buttons || buttons.length === 0) return;

            let pressed = [];
            let heartCnt = 0;
            let checkCnt = 0;
            let houseCnt = 0;

            // ÁîªÂÉè/ÈÄöÂ∏∏„Éú„Çø„É≥„Å®close„Éú„Çø„É≥„ÅßÂàÜ„Åë„Çã
            const modalButtons = document.getElementById('modalButtons');
            const modalClose = document.getElementById('modalClose');

            buttons.forEach((button, idx) => {
                // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅØ‰∏ã„Å∏
                if (button.action === 'close') {
                    const btn = document.createElement('button');
                    btn.textContent = button.text || 'Èñâ„Åò„Çã';
                    btn.className = 'modal-close-btn';
                    btn.onclick = function () {
                        closeModal();
                        if (typeof onSequenceSuccess === "function") {
                            onSequenceSuccess();
                        }
                    };
                    modalClose.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.style.margin = "0 10px 10px 0";
                    if (button.img) {
                        btn.innerHTML = `<img src="${button.img}" alt="${button.text || ''}" style="width:80px;height:80px;vertical-align:middle;">`;
                    } else {
                        btn.textContent = button.text;
                        btn.className = 'text-btn';
                    }
                    btn.onclick = function () {
                        if (button.action === 'restart') {
                            restartGame();
                        } else if (typeof button.action === "function") {
                            button.action();
                        } else if (typeof button.action === 'string') {
                            closeModal();
                            handleAreaClick(button.action);
                        }
                    };
                    modalButtons.appendChild(btn);
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
            if (window._nextModal) {
                // ÁôªÈå≤ÂÜÖÂÆπ„ÅØ {title, content, buttons, after} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                let modal = window._nextModal;
                window._nextModal = null; // „ÇØ„É™„Ç¢

                if (typeof modal === 'function') {
                    try { modal(); } catch (e) { }
                    window.dispatchEvent(new Event('modal:closed'));
                    return;
                }

                if (modal.before) modal.before();
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after();
            }
            window.dispatchEvent(new Event('modal:closed'));
        }

        // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„Éà
        function restartGame() {
            gameState = getDefaultGameState();
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;
        let isBGMInitialized = false; // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®

        // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Å†„ÅëBGM„ÇíÂÜçÁîü
        function initBGMOnce() {
            if (!isBGMInitialized) {
                const bgm = document.getElementById('bgm');
                bgm.volume = 0.3;
                bgm.play();
                isBGMPlaying = true;
                isBGMInitialized = true;
                document.getElementById('bgm-toggle').textContent = "üîä BGM";
            }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "üîä BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "üîá BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // „Éï„Ç°„Ç§„É´Âêç„ÅÆ„Åø„ÅßÊØîËºÉ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            if (current === next) return; // „Åô„Åß„Å´„Åù„ÅÆBGM„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function pauseBGM() {
            const bgm = document.getElementById('bgm');
            bgm.src = "";
            bgm.pause();
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }
        function stopSE(id) {
            const se = document.getElementById(id);
            se.pause();
        }

        // „Å©„Åì„Åã„ÅßÊúÄÂàù„Å´‰∏ÄÂ∫¶„Å†„ÅëÂëº„Å∂
        let loadedImages = {};
        function preloadImages() {
            // ÈÉ®Â±ãÁîªÂÉè
            Object.values(IMAGES.rooms).forEach(val => {
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        if (!loadedImages[src]) {
                            const img = new Image();
                            img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                            img.src = src;
                            loadedImages[src] = img;



                        }
                    });
                } else if (typeof val === "string") {
                    if (!loadedImages[val]) {
                        const img = new Image();
                        img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                        img.src = val;
                        loadedImages[val] = img;
                    }
                }
            });
            // „Ç¢„Ç§„ÉÜ„É†ÁîªÂÉè
            Object.values(IMAGES.items).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
            // „É¢„Éº„ÉÄ„É´ÁîªÂÉè
            Object.values(IMAGES.modals).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
        }

        // save&load
        function saveGameToSlot(slotIndex) {
            const toSave = { ...gameState, __version: SAVE_VERSION };

            const payload = {
                data: toSave,
                savedAt: Date.now()
            };

            localStorage.setItem(SAVE_KEYS[slotIndex], JSON.stringify(payload));
            updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function loadGameFromSlot(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`);
                return;
            }

            let saved;
            try {
                const parsed = JSON.parse(raw);
                // Êñ∞ÂΩ¢ÂºèÔºö{ data: {...}, savedAt: ... }
                if (parsed && parsed.data) {
                    saved = parsed.data;
                } else {
                    // ÊóßÂΩ¢ÂºèÔºö„Åù„ÅÆ„Åæ„Åæ gameState „ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã
                    saved = parsed;
                }
            } catch (e) {
                console.error(e);
                updateMessage('„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return;
            }

            const def = getDefaultGameState();
            const merged = deepMerge(def, saved);

            if (!Array.isArray(merged.openRooms)) merged.openRooms = def.openRooms.slice();
            if (!merged.currentRoom || !rooms[merged.currentRoom]) merged.currentRoom = def.currentRoom;

            gameState = merged;

            changeRoom(gameState.currentRoom);
            updateInventoryDisplay?.();
            renderNavigation?.();
            updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function getSaveSlotLabel(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàÁ©∫Ôºâ`;
            }
            try {
                const parsed = JSON.parse(raw);
                const savedAt = parsed.savedAt;
                if (!savedAt) {
                    return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàÊó•ÊôÇ‰∏çÊòéÔºâ`;
                }
                const d = new Date(savedAt);
                const jp = d.toLocaleString('ja-JP');
                return `„Çª„Éº„Éñ${slotIndex + 1}Ôºà${jp}Ôºâ`;
            } catch {
                return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàË™≠„ÅøËæº„Åø„Ç®„É©„ÉºÔºâ`;
            }
        }

        function openLoadMenu() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0),
                    action: () => {
                        loadGameFromSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1),
                    action: () => {
                        loadGameFromSlot(1);
                        closeModal();
                    }
                },
                { text: '„ÇÑ„ÇÅ„Çã', action: 'close' }
            ];

            showModal('„É≠„Éº„Éâ„Åô„Çã„Éá„Éº„Çø„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ', '', buttons, null, { columnButtons: true });
        }

        function saveGame() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0) + ' „Å´‰∏äÊõ∏„Åç‰øùÂ≠ò',
                    action: () => {
                        saveGameToSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1) + ' „Å´‰∏äÊõ∏„Åç‰øùÂ≠ò',
                    action: () => {
                        saveGameToSlot(1);
                        closeModal();
                    }
                },
                { text: '„ÇÑ„ÇÅ„Çã', action: 'close' }
            ];

            showModal('„Çª„Éº„ÉñÂÖà„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ', '', buttons, null, { columnButtons: true });
        }

        function loadGame() {
            openLoadMenu();
        }

        function deepMerge(target, source) {
            if (source === undefined || source === null) return target;
            if (Array.isArray(source)) return source.slice();
            if (typeof source === 'object') {
                const out = (target && typeof target === 'object') ? { ...target } : {};
                for (const k of Object.keys(source)) {
                    out[k] = deepMerge(target ? target[k] : undefined, source[k]);
                }
                return out;
            }
            return source;
        }

        function showToast(text, ms = 2600) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = text;
            el.style.opacity = '1';
            el.style.transform = 'translateX(-50%) translateY(0)';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(-50%) translateY(-8px)';
            }, ms);
        }

        window.addEventListener('keydown', e => {
            if (e.key === 'F2') {
                DEV_MODE = !DEV_MODE;
                renderCanvasRoom();
            }
        });

        // „Ç≤„Éº„É†ÈñãÂßã
        preloadImages();
        initGame();
    </script>
    <div id="toast"
        style="position:fixed;left:50%;top:14px;transform:translateX(-50%);
padding:10px 14px;border-radius:8px;background:#1f6feb;color:#fff;font-weight:700;
box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s; z-index:9999;">
    </div>

</body>

</html>