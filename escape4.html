<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë¶ãÁü•„Çâ„Å¨„Ç™„Éï„Ç£„Çπ„Åã„Çâ„ÅÆËÑ±Âá∫„Ç≤„Éº„É†</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;  /* ‚Üê„Åì„ÇåÈáçË¶Å */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .room-view {
            aspect-ratio: 1/1;           /* ‚ÜêÊ≠£ÊñπÂΩ¢ */
            width: 90vw;                 /* ÁîªÈù¢ÂπÖ„ÅÆ90% */
            max-width: 640px;            /* PCÊôÇÊúÄÂ§ß„Çµ„Ç§„Ç∫ */
            max-height: 90vw;       
            background-size: cover;      
            background-repeat: no-repeat;
            background-position: center center;
            position: relative;
            margin: 0 auto;
            cursor: crosshair;
            transition: background-image 0.5s ease-in-out;
        }

        #roomImage {
            width: 100%;
            height: 100%;
            object-fit: contain;    /* ÁîªÂÉèÂÖ®‰Ωì„ÇíË°®Á§∫ */
            position: absolute;
            left: 0;
            top: 0;
            z-index: 0;
            pointer-events: none;   /* ÁîªÂÉè‰∏ä„Åß„ÇÇ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÅåÈÄö„Çã„Çà„ÅÜ„Å´ */
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
            }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }



        .clickable-area {
            position: absolute;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            z-index: 2;
            pointer-events: auto;

        }

        .clickable-area:hover {
            border-color: #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 20px;
            width:100%;
        }

        .inventory-slot {
            width: 14vw; 
            height: 14vw; 
            max-width: 80px; 
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;   /* ÈáëËâ≤„ÉªÂ§™„ÇÅÊé®Â•® */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .info-panel {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            height:80px;
            min-height: 40px;
            border: 1px solid #d4af37;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        /* ÁîªÂÉè„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }
        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            width: 40%;
        }

        @media (max-width: 600px) {
            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }
            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width:100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }
        #roomEffectOverlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }
        .title-wrapper {
            display: flex;
            width:100%;
        }
    </style>
</head>
<body>
    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <div class="title">Ë¶ãÁü•„Çâ„Å¨„Ç™„Éï„Ç£„Çπ„Åã„ÇâËÑ±Âá∫„Åõ„Çà</div>
            <div style="margin:12px 0; text-align:center;">
                <a href="escape4_hint.html" target="_blank" style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    üîç „Éí„É≥„Éà„ÇíË¶ã„Çã
                </a>
            </div>
        </div>
        <div class="room-view" id="roomView">
            <!-- „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Ç®„É™„Ç¢„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
              <img id="roomImage" src="">
              
        </div> 
        <div id="endingShareArea" style="display:none;">
            <div style="font-size:1.4em; font-weight:bold; margin-bottom:8px;color:#2c1810;">üéâ„ÇØ„É™„Ç¢„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅüéâ</div>
            <button onclick="shareOnTwitter()">X„Åß„Ç∑„Çß„Ç¢</button>
            <button onclick="copyShareText()">„ÇØ„É™„Ç¢Â†±Âëä„Çí„Ç≥„Éî„Éº</button>
            <div style="font-size:0.9em; margin-top:6px; color:#555;">#ËÑ±Âá∫„Ç≤„Éº„É† #Ëá™‰Ωú„Ç≤„Éº„É†</div>
        </div>
        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØË¶ãÁü•„Çâ„Å¨„Ç™„Éï„Ç£„Çπ„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ„Éâ„Ç¢„ÅØ„Ç´„ÇÆ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Å¶Âá∫„Çâ„Çå„Åæ„Åõ„Çì
                </div>
                <div class="navigation">
                    
                </div> 
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
            üîä BGM
            </button> 
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">„Çª„Éº„Éñ</button>
                <button class="nav-btn" onclick="loadGame()">„É≠„Éº„Éâ</button>
            </div>
        </div>
        <div class="notice">ÂΩì„Çµ„Ç§„Éà„ÅØOtoLogic„ÅÆÁ¥†Êùê„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô ‰ΩúËÄÖ:<a href="index.html">„Çπ„É©„Çª„Éñ„É≥</a></div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>
    <audio id="bgm" src="sounds/4/Social Documentary05.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-tv" src="sounds/TV-Hardware02-01(Button).mp3"></audio>

    <audio id="se-metal" src="sounds/Horror_Accent13-1(Short).mp3"></audio>
    <audio id="se-subclear" src="sounds/Quiz-Ding_Dong01-1(Short).mp3"></audio>
    <audio id="se-clear" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-parin" src="sounds/Onoma-Impact04-1(High).mp3"></audio>
    <audio id="se-box" src="sounds/Retro_Anime-Switch02-1(Mid).mp3"></audio>
    <audio id="se-person" src="sounds/Short_Accent04-1(Single).mp3"></audio>
    <audio id="se-fanta" src="sounds/4/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <script>
        window._nextModal = null;
        // „Ç≤„Éº„É†Ë®≠ÂÆö - ÁîªÂÉè„Éë„Çπ„Çí„Åì„Åì„ÅßÁÆ°ÁêÜ
        let IMAGES = {
            rooms: {
                office: 'images/4/office.jpg',        
                end: 'images/4/end.jpg',    
            },
            items: {
                key: 'images/4/key.jpg',
                honey: 'images/4/honey.jpg'   
            }
        };

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            inventory: [],
            
            flags: {
                foundKey: false, 
                unlockPc: false,
                safePuzzleSolved: false,
                foundBear: false,
                foundHoney: false,
            },
            selectedItem: null
        };

        // ÈÉ®Â±ã„Éá„Éº„Çø
        let rooms = {
            office: {
                name: '„Ç™„Éï„Ç£„Çπ',
                description: 'Ë¶ãÁü•„Çâ„Å¨„Ç™„Éï„Ç£„Çπ„Å†',
                clickableAreas: [
                    {
                        x: 21.1, y: 55, width: 10.4, height: 7.6,
                        action: 'examine_pc',
                        description: 'PC',
                        zIndex:5
                    },
                    {
                        x: 45.3, y: 18.3, width: 13.5, height: 11.7,
                        action: 'examine_clock',
                        description: 'ÊôÇË®à„Åå„ÅÇ„Çã',
                        zIndex:5
                    },
                    {
                        x: 33.6, y: 57, width: 5.3, height: 7.8,
                        action: 'examine_green',
                        description: 'Ë¶≥ËëâÊ§çÁâ©'
                    },
                    {
                        x: 41.2, y: 65.7, width: 18.8, height: 21,
                        action: 'examine_kinko',
                        description: 'ÈáëÂ∫´'
                    },
                    {
                        x: 5.6, y: 31.2, width: 7.9, height: 2.2,
                        action: 'examine_paper1',
                        description: 'Êé≤Á§∫Áâ©„Å†'
                    },
                    {
                        x: 5.9, y: 37.8, width: 4.5, height: 8.4,
                        action: 'examine_paper2',
                        description: 'ÂΩìÁï™Ë°®„Å†'
                    },
                    {
                        x: 11.3, y: 35.6, width: 7.3, height: 10.3,
                        action: 'examine_paper3',
                        description: 'Êé≤Á§∫Áâ©„Å†'
                    },
                    {
                        x: 24.8, y: 30.4, width: 10.1, height: 11.8,
                        action: 'examine_paper4',
                        description: ''
                    },
                    {
                        x: 29.2, y: 43.7, width: 7.3, height: 9.5,
                        action: 'examine_paper5',
                        description: ''
                    },
                    {
                        x: 50, y: 37.3, width: 12, height: 16,
                        action: 'examine_paper6',
                        description: ''
                    },
                    {
                        x: 69.3, y: 56.8, width: 6.5, height: 7.5,
                        action: 'examine_door_key',
                        description: '„Éâ„Ç¢„Å´„ÅØÈçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã'
                    },
                    {
                        x: 72.7, y: 31, width: 20.9, height: 25.1,
                        action: 'examine_door_window',
                        description: '„Éâ„Ç¢„Å´„ÅØÈçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã'
                    },
                    {
                        x: 1.4, y: 54.5, width: 4.4, height: 10.5,
                        action: 'examine_file1',
                        description: '„Éï„Ç°„Ç§„É´„Å†'
                    },
                    {
                        x: 44.1, y: 57.7, width: 5.2, height: 7.3,
                        action: 'examine_nazo',
                        description: '„Åì„Çå„ÅØ„Å™„Çì„Å†„Çç„ÅÜ'
                    },
                    {
                        x: 13.5, y: 77.3, width: 16.3, height: 4,
                        action: 'examine_chair',
                        description: 'Â∫ßÈù¢'
                    },
                    {
                        x: 40.1, y: 47.5, width: 10.3, height: 10.3,
                        action: 'examine_bear',
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 5,
                        usable: () => !!gameState.flags.foundBear,
                    }
                ]
            },
            end: {
                name: 'Â§ñ„ÅÆ‰∏ñÁïå„Å∏„É´„Éº„Éà',
                description: '„ÅÇ„Å™„Åü„ÅØÁÑ°‰∫ãËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_end',
                        description: 'Â§ñ„ÅÆ‰∏ñÁïå'
                    },
                ]
            }
        };


        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            changeRoom('office');
            updateMessage('Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØË¶ãÁü•„Çâ„Å¨„Ç™„Éï„Ç£„Çπ„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ„Éâ„Ç¢„ÅØ„Ç´„ÇÆ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Å¶Âá∫„Çâ„Çå„Åæ„Åõ„Çì');
        }

        // ÈÉ®Â±ã„ÇíÂ§âÊõ¥
        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${IMAGES.rooms[roomId]})`;
            
            // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Ç®„É™„Ç¢„ÇíÁîüÊàê
            generateClickableAreas(room);
            updateMessage(`${room.name}„Å´ÂÖ•„Çä„Åæ„Åó„Åü„ÄÇ${room.description}`);


            // BGMÂàáÊõø
            if (roomId === "end") {
                changeBGM("sounds/egao to namida.mp3");
            } else if (roomId === "extraEnd") {
                changeBGM("sounds/hokkori tea time.mp3");
            } else {
                changeBGM("sounds/4/Social Documentary05.mp3");
            }
        }

        // ËÉåÊôØÁîªÂÉè„ÇíÂ∑Æ„ÅóÊõø„Åà
        function changeRoomImage(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            // ËÉåÊôØÁîªÂÉè„ÇíË®≠ÂÆöÔºàÁîªÂÉè„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÔºâ
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${IMAGES.rooms[roomId]})`;
            generateClickableAreas(room);
        }

        function unlockRoom(roomId) {
            if (!gameState.openRooms.includes(roomId)) gameState.openRooms.push(roomId);
            renderNavigation();
        }

        // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Ç®„É™„Ç¢„ÇíÁîüÊàê
        // 
        function generateClickableAreas(room) {
            const roomView = document.getElementById('roomView');

            roomView.innerHTML = '<img id="roomImage" src="'+IMAGES.rooms[gameState.currentRoom]+'" style="width:100%;height:100%;object-fit:contain;position:absolute;left:0;top:0;">';

            // ÁîªÂÉè„ÅÆ„É≠„Éº„ÉâÂæå„Å´ÈÖçÁΩÆ
            const img = roomView.querySelector('#roomImage');
            img.onload = function() {

                room.clickableAreas.forEach(area => {
                    const clickableDiv = document.createElement('div');
                    clickableDiv.className = 'clickable-area';
                    clickableDiv.style.left   = (area.x) + '%';
                    clickableDiv.style.top    = (area.y) + '%';
                    clickableDiv.style.width  = (area.width) + '%';
                    clickableDiv.style.height = (area.height) + '%';
                    clickableDiv.style.position = 'absolute';
                    clickableDiv.style.zIndex = area.zIndex || 1;
                    console.log(area.action+ ':' + area.usable);
                    const usable = (typeof area.usable === 'function') ? area.usable() :
                         (typeof area.usable === 'boolean') ? area.usable : true;
                    clickableDiv.style.display = usable ? 'block' : 'none';

                    clickableDiv.onclick = () => handleAreaClick(area.action);
                    clickableDiv.title = area.description;

                    roomView.appendChild(clickableDiv);
                });
            };
            img.src = IMAGES.rooms[gameState.currentRoom]; // ÂøÖ„ÅöÁîªÂÉè„Çª„ÉÉ„Éà
        }

        // „Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleAreaClick(action) {
            switch(action) {
                case 'examine_pc':
                    if (gameState.flags.unlockPc) {
                        showModal(
                        'ÊùëÁî∞„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Çã',
                        '<img src="images/4/pc.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );  
                    } else {
                         showPcPuzzle();
                    }
                     break;
                case 'examine_clock':
                    updateMessage('8ÊôÇ„ÇíÊåá„Åó„Å¶„ÅÑ„Çã');
                    break;
                case 'examine_green':
                    if (gameState.flags.unlockPc) {
                        updateMessage('Áôí„Åï„Çå„ÇãÊ§çÁâ©„Å†');
                        showModal(
                            'Áôí„Åï„Çå„ÇãÊ§çÁâ©„Å†',
                            '<img src="images/4/green.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );  
                    } else {
                        updateMessage('Áôí„Åï„Çå„ÇãÊ§çÁâ©„Å†');
                    }
                    
                    break;
                case 'examine_kinko':
                    if (!gameState.flags.safePuzzleSolved) {
                        showSafePuzzle();
                    } else {
                        updateMessage('ÈáëÂ∫´„ÅØ„Åã„Çâ„Å£„ÅΩ„Å†');
                    }   
                    break;
                case 'examine_paper1':
                    updateMessage('Á§æÂÜÖ„ÅÆ„ÅäÁü•„Çâ„Åõ„Å†');
                    showModal(
                        'Á§æÂì°„ÅÆ„Åø„Å™„Åï„Çì„Å∏',
                        '<img src="images/4/paper1.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );  
                    break;  
                case 'examine_paper2':
                    updateMessage('Á§æÂÜÖ„ÅÆ„ÅäÁü•„Çâ„Åõ„Å†');
                    showModal(
                        '‰Ωï„ÅÆÂΩìÁï™„Å†„Çç„ÅÜÔºü',
                        '<img src="images/4/paper2.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );  
                    break;  
                case 'examine_paper3':
                    updateMessage('Á§æÂÜÖ„ÅÆ„ÅäÁü•„Çâ„Åõ„Å†');
                    showModal(
                        'Á§æÂì°„ÅÆ„Åø„Å™„Åï„Çì„Å∏',
                        '<img src="images/4/paper3.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );  
                    break;  
                case 'examine_paper4':
                    updateMessage('Á§æÂÜÖ„ÅÆ„ÅäÁü•„Çâ„Åõ„Å†');
                    showModal(
                        'Á§æÂì°„ÅÆ„Åø„Å™„Åï„Çì„Å∏',
                        '<img src="images/4/paper4.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );  
                    break;  
                case 'examine_paper5':
                    updateMessage('Á§æÂÜÖ„ÅÆ„ÅäÁü•„Çâ„Åõ„Å†');
                    showModal(
                        'Á§æÂì°„ÅÆ„Åø„Å™„Åï„Çì„Å∏',
                        '<img src="images/4/paper5.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );  
                    break;  
                case 'examine_paper6':
                    updateMessage('Á§æÂÜÖ„ÅÆ„ÅäÁü•„Çâ„Åõ„Å†');
                    showModal(
                        'Á§æÂì°„ÅÆ„Åø„Å™„Åï„Çì„Å∏',
                        '<img src="images/4/paper6.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                    );  
                    break;  
                case 'examine_door_key':
                    if (gameState.selectedItem=='key') {
                        removeItem('key');
                        playSE('se-box');
                        showModal(
                            'Èçµ„ÅåÈñã„ÅÑ„ÅüÔºÅ',
                            '<img src="images/4/open.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );
                        playSE('se-clear');
                        window._nextModal = {
                            before: function() { playSE('se-clear'); },
                            title: '„ÅÇ„Å™„Åü„ÅØÂ§ñ„Å∏Ë∂≥„ÇíË∏è„ÅøÂá∫„Åó„Åü',
                            content: '<img src="images/4/clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            buttons: [{text: 'Èñâ„Åò„Çã', action: 'close'}],
                            after: function() { changeRoom('end'); }
                        };     

                    } else {
                        updateMessage('Èçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                    }  
                    break; 
                case 'examine_door_window':
                    updateMessage('Â§ñ„ÅØÊòé„Çã„ÅÑ');
                    break; 
                case 'examine_file1':
                    if (gameState.flags.foundMemo) {
                        showModal(
                            '„ÇØ„ÉûÂ¶ñÁ≤æ„ÅÆ„É°„É¢„Å†',
                            '<img src="images/4/memo.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                        );  
                    } else {
                        updateMessage('„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çã');
                    }
                    break; 
                case 'examine_nazo':
                    if(gameState.flags.foundBear) {
                        updateMessage('Â¶ñÁ≤æ„ÅÆ„Åä„ÅÜ„Å°„Å™„ÅÆ„Åã„Å™Ôºü');
                    } else {
                        updateMessage('Ë¨é„ÅÆÁâ©‰Ωì„Å†');
                    }
                    
                    break; 
                case 'examine_chair':
                    if(gameState.flags.foundBear) {
                        if (!gameState.flags.foundHoney) {
                            addItem('honey');
                            gameState.flags.foundHoney = true;
                            updateMessage('„Éè„ÉÅ„Éü„ÉÑ„ÅåËêΩ„Å°„Å¶„ÅÑ„Åü');
                            showModal(
                                '„Éè„ÉÅ„Éü„ÉÑ„ÅåËêΩ„Å°„Å¶„ÅÑ„Åü',
                                '<img src="images/4/honey.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                                [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                            );  
                        } else {
                            updateMessage('Â∫ß„Å£„Å¶„Åø„Çà„ÅÜ„Åã„Å™Ôºü');
                        }
                    } else {
                        updateMessage('Â∫ß„Å£„Å¶„Åø„Çà„ÅÜ„Åã„Å™Ôºü');
                    }
                    
                    break; 
                case 'examine_bear':
                    if (gameState.selectedItem=='honey') {
                        removeItem('honey');
                        updateMessage('„Çè„Éº„ÅÑÔºÅ„ÅÑ„ÅÑ„Åì„Å®Êïô„Åà„Å¶„ÅÇ„Åí„Çã„ÄÇ„Éú„ÇØ„ÅÆÁßòÂØÜ„ÅÆ„É°„É¢„Åå„Éï„Ç°„Ç§„É´„Å´Êåü„Çì„Åß„ÅÇ„Çã„Çà');
                        gameState.flags.foundMemo = true;
                    } else {
                        updateMessage('Âëº„Çì„Å†Ôºü');
                    }  
                    break; 
                case 'examine_end':
                    updateMessage('„ÅÇ„Å™„Åü„ÅØÂ§ñ„Å∏„Å®Ë∂≥„ÇíË∏è„ÅøÂá∫„Åó„Åæ„Åó„Åü„ÄÇÔºà„Éé„Éº„Éû„É´„Ç®„É≥„ÉâÔºâ');
                    break; 
            }
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;

            playSE('se-click');
            updateInventoryDisplay();
        }

        // Pc„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showPcPuzzle() {
            const modalContent = `
                <h3>ÂÖ•Âäõ„Éë„Éç„É´</h3>
                <p>„É≠„Ç∞„Ç§„É≥„Éë„Çπ„ÉØ„Éº„ÉâÔºü</p>
                <input type="text" class="puzzle-input" id="pcInput" placeholder="ÂõõÂ≠óÁÜüË™û„ÇíÂÖ•ÂäõÔºà‰æã:‰∏ÄÊúü‰∏Ä‰ºöÔºâ">
                <br>
                <button onclick="checkPcPuzzle()">Á¢∫Ë™ç</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // Pc„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkPcPuzzle() {
            const input = document.getElementById('pcInput').value;
            if (input === '‰∫îÈáåÈúß‰∏≠' || input === '5ÈáåÈúß‰∏≠' || input === 'ÔºïÈáåÈúß‰∏≠') {
                closeModal();
                updateMessage('„É≠„Ç∞„Ç§„É≥ÊàêÂäü');
                playSE('se-subclear');
                showModal(
                    '„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ',
                    '<img src="images/4/pc_login.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                );

                gameState.flags.unlockPc = true;

            } else {
                playSE('se-error');
                updateMessage('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
            }
        }

        // ÈáëÂ∫´„ÇØ„Ç§„Ç∫„ÇíË°®Á§∫
        function showSafePuzzle() {
            const modalContent = `
                <h3>ÊöóË®ºÁï™Âè∑„ÇíÂÖ•Âäõ</h3>
                <p>Êï∞Â≠ó„ÅßÂÖ•Âäõ„Åó„Çà„ÅÜ</p>
                <input type="text" class="puzzle-input" id="safeInput" placeholder="123or1234or12345">
                <br>
                <button onclick="checkSafePuzzle()">Á¢∫Ë™ç</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ÈáëÂ∫´„ÇØ„Ç§„Ç∫„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkSafePuzzle() {
            const input = document.getElementById('safeInput').value;
            if (input === '532' || input=== 'ÔºïÔºìÔºí') {
                closeModal();
                updateMessage('ÈáëÂ∫´„ÅÆÈçµ„ÅåÈñã„ÅÑ„Åü');
                playSE('se-box');
                showModal(
                    'Èçµ„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ',
                    '<img src="images/4/key.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                );
                addItem('key');
                gameState.flags.safePuzzleSolved = true;
                updateMessage('„Åì„Çå„ÅßÂ§ñ„Å´Âá∫„Çâ„Çå„Çã„Åû');

            } else if (input === '52235' || input=== 'ÔºïÔºíÔºíÔºìÔºï') {
                closeModal();
                updateMessage('„ÅÇ„Å™„Åü„ÅØÈáëÂ∫´„Å´Âê∏„ÅÑËæº„Åæ„Çå„Åü');
                playSE('se-fanta');
                showModal(
                    '„Éê„ÉÉ„Éâ„Ç®„É≥„Éâ',
                    '<img src="images/4/badend.jpg" style="width:300px;display:block;margin:0 auto 20px;">' +
                    '<br>„ÅÇ„Å™„Åü„ÅØ„ÇØ„Éû„ÅÆÂ¶ñÁ≤æ„Ç∑„ÉÜ„Ç£„Å´Ëª¢Áßª„Åó„Å¶„Åó„Åæ„Å£„Åü„ÄÇ„ÇÇ„ÅÜÂ∏∞„Çã„Åì„Å®„ÅØ„Åß„Åç„Å™„ÅÑ„ÄÇ',
                    [{text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart'}]
                );          

            } else if (input === '879' || input=== 'ÔºòÔºóÔºô') {
                gameState.flags.foundBear = true;
                IMAGES.rooms.office = 'images/4/office2.jpg';
                updateMessage("‰∏çÊÄùË≠∞„Å™Áîü„ÅçÁâ©„ÅåÁèæ„Çå„Åü„ÄÇ");
                changeRoomImage('office');
                generateClickableAreas('office');
                playSE('se-fanta');
                showModal(
                    '„Å™„Çì„Å†„Çç„ÅÜÔºü',
                    '<img src="images/4/ex.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'Èñâ„Åò„Çã', action: 'close'}]
                );

            } else {
                playSE('se-error');
                updateMessage('ÈÅï„ÅÑ„Åæ„Åô„ÄÇ');
            }
        }


        // „Ç¢„Ç§„ÉÜ„É†ÁÆ°ÁêÜ
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 5) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }
            
        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ‰ΩøÁî®„Åó„Åü„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay(); 
            }
        }

        function getItemName(itemId) {
            const names = {
                key: 'Èçµ',
                honey: '„Éè„ÉÅ„Éü„ÉÑ'
            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;
                btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        // „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫Êõ¥Êñ∞
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function() {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                }
                // ‚òÖÈÅ∏Êäû‰∏≠„Å™„Çâselected„ÇØ„É©„ÇπËøΩÂä†
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        function updateMessage(message) {
            document.getElementById('messageArea').innerHTML = message;
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content, buttons) {
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            buttons.forEach(button => {
                modalHtml += `<button onclick="${button.action === 'close' ? 'closeModal' : button.action === 'restart' ? 'restartGame()' : button.action}()">${button.text}</button>`;
            });
            
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
            if (window._nextModal) {
                // ÁôªÈå≤ÂÜÖÂÆπ„ÅØ {title, content, buttons, after} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                let modal = window._nextModal;
                window._nextModal = null; // „ÇØ„É™„Ç¢
                if (modal.before) modal.before(); // „ÇÇ„ÅóplaySE„Å™„Å©‰∫ãÂâçÂá¶ÁêÜ„Åó„Åü„Åë„Çå„Å∞
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after(); // „ÇÇ„ÅóshowModalÁõ¥Âæå„Å´„ÇÑ„Çä„Åü„ÅÑ„Åì„Å®„ÅÇ„Çå„Å∞
            }
        }

        // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„Éà
        function restartGame() {
            gameState = {
                currentRoom: 'office',
                openRooms:  ['office'], 
                inventory: [],
                flags: {
                    foundKey: false, 
                    unlockPc: false,
                    safePuzzleSolved: false,
                    foundBear: false,
                    foundHoney: false
                    
                },
                selectedItem: null,
                selectedItemSlot: null,
            };
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;   // ‚Üê„Éá„Éï„Ç©„É´„Éà„ÅØÂÜçÁîü„Åó„Å¶„Å™„ÅÑ
        let isBGMInitialized = false; // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®

        // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Å†„ÅëBGM„ÇíÂÜçÁîü
        function initBGMOnce() {
        if (!isBGMInitialized) {
            const bgm = document.getElementById('bgm');
            bgm.volume = 0.3;
            bgm.play();
            isBGMPlaying = true;
            isBGMInitialized = true;
            document.getElementById('bgm-toggle').textContent = "üîä BGM";
        }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "üîä BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "üîá BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            if (bgm.src.endsWith(newSrc)) return; // „Åô„Åß„Å´„Åù„ÅÆBGM„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // „Å©„Åì„Åã„ÅßÊúÄÂàù„Å´‰∏ÄÂ∫¶„Å†„ÅëÂëº„Å∂
        function preloadImages() {
            Object.values(IMAGES.rooms).forEach(src => {
                const img = new Image();
                img.src = src;
            });
            Object.values(IMAGES.items).forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        function shareOnTwitter(resultType) {
            // ‰æãÔºöresultType = "true_end" or "normal_end"
            let url = encodeURIComponent(location.href);
            let text;
            if (resultType === "true_end") {
                text = encodeURIComponent("ËÑ±Âá∫„Ç≤„Éº„É†„ÄéÂ±ãÊï∑„Å´ÊÆã„Åï„Çå„ÅüÂ§¢„Äè„ÅßÁúü„Ç®„É≥„ÉâÈÅîÊàêÔºÅ #ËÑ±Âá∫„Ç≤„Éº„É†");
            } else {
                text = encodeURIComponent("ËÑ±Âá∫„Ç≤„Éº„É†„ÄéÂ±ãÊï∑„Å´ÊÆã„Åï„Çå„ÅüÂ§¢„Äè„Çí„ÇØ„É™„Ç¢ÔºÅ #ËÑ±Âá∫„Ç≤„Éº„É†");
            }
            window.open(`https://x.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }
        function copyShareText() {
            let text = "ËÑ±Âá∫„Ç≤„Éº„É†„ÄéÂ±ãÊï∑„Å´ÊÆã„Åï„Çå„ÅüÂ§¢„Äè„Çí„ÇØ„É™„Ç¢ÔºÅ #ËÑ±Âá∫„Ç≤„Éº„É† " + location.href;
            navigator.clipboard.writeText(text).then(() => alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'));
        }

        function saveGame() {
            localStorage.setItem('escapeGameState', JSON.stringify(gameState));
            const oldMsg = document.getElementById('messageArea').innerHTML;
            updateMessage('„Çª„Éº„Éñ„Åó„Åæ„Åó„ÅüÔºÅ');
            setTimeout(() => {
                updateMessage(oldMsg);
            }, 1500);
        }

        function loadGame() {
            const saved = localStorage.getItem('escapeGameState');
            if (saved) {
                gameState = JSON.parse(saved);
                // „Åì„Åì„ÅßIMAGES.rooms.office„ÇíÊõ∏„ÅçÊèõ„Åà„ÇãÔºÅ
                if (gameState.flags.foundBear) {
                    IMAGES.rooms.office = 'images/4/office2.jpg';
                } else {
                    IMAGES.rooms.office = 'images/4/office.jpg';
                }
                // UI„ÇÑÁîªÈù¢„Çístate„Å´Âêà„Çè„Åõ„Å¶Âæ©ÂÖÉ„Åô„Çã
                changeRoom(gameState.currentRoom);
                updateInventoryDisplay();
                renderNavigation();
                updateMessage('„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ');
            } else {
                updateMessage('„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        preloadImages();
        initGame();
    </script>
</body>
</html>