<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="å±±å°å±‹ã‚’èˆå°ã«ã—ãŸåˆ†å²ã‚¨ãƒ³ãƒ‰ä»˜ãã®ç„¡æ–™è„±å‡ºã‚²ãƒ¼ãƒ ã€‚å…¨4ã‚¨ãƒ³ãƒ‰ã®ãƒãƒ«ãƒã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€‚ã‚¹ãƒãƒ›ï¼†PCå¯¾å¿œã€‚">
    <title>å±±å°å±‹ã‹ã‚‰ã®è„±å‡º</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;
            /* â†ã“ã‚Œé‡è¦ */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #gameCanvas {
            position: relative;
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
        }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            /* flex: 1; */
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 12px;
            /* width:100%; */
        }

        .inventory-slot {
            width: 14vw;
            height: 14vw;
            max-width: 80px;
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;
            /* é‡‘è‰²ãƒ»å¤ªã‚æ¨å¥¨ */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .magnifier-btn {
            position: absolute;
            right: 4px;
            bottom: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0002;
            cursor: pointer;
            z-index: 10;
            transition: box-shadow .15s;
        }

        .magnifier-btn:hover {
            box-shadow: 0 0 10px #ffd70099;
        }

        .magnifier-btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .info-panel {
            width: 100%;
            padding: 2px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 2px;
            height: 65px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        #msgText {}

        #statusIconArea {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px #0005;
            font-size: 1.4em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        #modalButtons button {
            border: none;
            background: none;
            padding: 0;
            margin: 0 10px 10px 0;
            cursor: pointer;
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
            border-radius: 10px;
        }

        #modalButtons button img {
            width: 80px;
            height: 80px;
            vertical-align: middle;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
        }

        #modalButtons button:hover img {
            filter: brightness(1.08) drop-shadow(0 2px 6px #ffd70050);
            box-shadow: 0 0 10px #ffd70080;
            transform: scale(1.05);
        }

        #modalButtons button:active img,
        #modalButtons button.pressed img {
            filter: brightness(0.95) grayscale(20%);
            box-shadow: 0 0 8px #3332;
            transform: scale(0.97);
        }

        #modalButtons button:disabled img {
            filter: grayscale(90%) opacity(0.5);
            box-shadow: none;
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆå‹ãƒœã‚¿ãƒ³ã‚‚ç”»åƒãƒœã‚¿ãƒ³é¢¨ã« */
        #modalButtons button.text-btn {
            min-width: 120px;
            font-size: 1.15em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            margin: 0 10px 10px 0;
            box-shadow: 0 4px 14px #ffc90022;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s, transform 0.08s;
            vertical-align: middle;
            display: inline-block;
        }

        #modalButtons button.text-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
            transform: scale(1.05);
        }

        #modalButtons button.text-btn:active {
            filter: brightness(0.96);
            transform: scale(0.97);
        }

        #modalButtons button.text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */
        #modalClose .modal-close-btn {
            display: inline-block;
            min-width: 160px;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            box-shadow: 0 4px 14px #ffc90022;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s;
        }

        #modalClose .modal-close-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        .login-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            width: 280px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'Segoe UI', sans-serif;
        }

        .login-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .login-form label {
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .login-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .login-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }

        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            /* width: 40%; */
        }

        @media (max-width: 600px) {
            #msgText {
                font-size: .8rem;
            }

            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }

            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width: 100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }

        #roomEffectOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }

        .title-wrapper {
            display: flex;
            width: 100%;
        }

        @keyframes warpFlash {
            0% {
                opacity: 0
            }

            15% {
                opacity: .95
            }

            50% {
                opacity: .4
            }

            100% {
                opacity: 0
            }
        }

        @keyframes chroma {
            0% {
                filter: none
            }

            100% {
                filter: contrast(1.2) saturate(1.2) hue-rotate(20deg)
            }
        }

        .warp-active {
            background: radial-gradient(circle at 50% 50%, #fff, #000 70%);
            animation: warpFlash 900ms ease-out both, chroma 900ms ease-out both;
        }

        #hintModal {
            color: #000;
        }

        @keyframes glowPulse {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            60% {
                opacity: 0.9;
            }

            100% {
                opacity: 0;
            }

            /* è‡ªå‹•ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ */
        }


        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, .45);
            }

            50% {
                box-shadow: 0 0 18px 6px rgba(255, 255, 255, .35);
            }
        }



        /* ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç”¨ã®å…¨ç”»é¢ãƒ¬ã‚¤ãƒ¤ */
        #fxFlash {
            position: fixed;
            inset: 0;
            background: transparent;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
        }

        /* ç™½ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
        @keyframes flashWhite {
            0% {
                opacity: 0;
                background: #fff;
            }

            12% {
                opacity: .95;
                background: #fff;
            }

            100% {
                opacity: 0;
                background: #fff;
            }
        }

        /* èµ¤ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆãƒŸã‚¹ï¼‰ */
        @keyframes flashRed {
            0% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }

            18% {
                opacity: .85;
                background: rgba(255, 0, 0, 0.85);
            }

            100% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }
        }

        /* ã»ã‚“ã®å°‘ã—ã‚«ãƒ¡ãƒ©ã‚·ã‚§ã‚¤ã‚¯ï¼ˆå¥½ã¿ã§ï¼‰ */
        @keyframes camShake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, -1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, 1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .fx-shake {
            animation: camShake 120ms ease;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .casefile-modal {
            background-color: #f6f2e8;
            color: #2c2c2c;
            width: 80%;
            max-width: 720px;
            max-height: 85vh;
            border: 2px solid #bba;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .casefile-scroll {
            padding: 24px;
            overflow-y: auto;
            max-height: 80vh;
            font-family: "Noto Serif JP", "Times New Roman", serif;
            line-height: 1.6;
        }

        .casefile-modal h1,
        .casefile-modal h2 {
            text-align: center;
            margin-bottom: 8px;
        }

        .casefile-modal h3 {
            margin-top: 20px;
            border-bottom: 1px solid #999;
        }

        .person {
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-left: 3px solid #b44;
        }

        .initial-f {
            font-weight: 900;
            color: #c9a43d;
            /* gold */
            font-size: 1.55em;
            /* margin-left: 6px; */
        }

        .initial-l {
            font-weight: 900;
            color: #8c8fa1;
            /* silver/steel */
            font-size: 1.55em;
            /* margin-left: 4px; */
        }


        .evidence {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .evidence th,
        .evidence td {
            border: 1px solid #bbb;
            padding: 6px 8px;
        }

        blockquote {
            font-style: italic;
            color: #444;
            border-left: 4px solid #888;
            padding-left: 10px;
            margin: 10px 0;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.4rem;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }

        .group {
            width: 90%;
            justify-content: center;
            display: flex;
            gap: 8px;
            align-items: center
        }


        @keyframes breathe {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(2px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .modal-content {
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            /* ç”»é¢ã«åã‚ã‚‹ */
            overflow: auto;
            /* ã¯ã¿å‡ºã—ãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            padding: 20px;
            /* ã¡ã‚‡ã„åœ§ç¸® */
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç”»åƒãƒœã‚¿ãƒ³ã¯å›ºå®š80pxâ†’å¯å¤‰ã« */
        #modalButtons button img {
            width: clamp(56px, 18vw, 96px);
            height: clamp(56px, 18vw, 96px);
        }

        /* 22ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³å¸½å­ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ */
        .blockman-hat-anim {
            position: relative;
            width: min(400px, 80vw);
            margin: 0 auto 16px;
        }

        .blockman-hat-anim img {
            display: block;
            width: 100%;
        }

        /* 1æšç›®ã¯ã ã‚“ã ã‚“æ¶ˆãˆã‚‹ */
        .blockman-hat-anim img:nth-child(1) {
            position: absolute;
            inset: 0;
            opacity: 1;
            animation: blockmanHatFadeOut 0.6s ease forwards 0.1s;
        }

        /* 2æšç›®ã¯å¾Œã‹ã‚‰ãµã‚ã£ã¨å‡ºã¦ãã‚‹ */
        .blockman-hat-anim img:nth-child(2) {
            opacity: 0;
            animation: blockmanHatFadeIn 0.8s ease forwards 0.4s;
        }

        @keyframes blockmanHatFadeOut {
            to {
                opacity: 0;
            }
        }

        @keyframes blockmanHatFadeIn {
            to {
                opacity: 1;
            }
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F2G9BX4FBF"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-F2G9BX4FBF');
</script>

<body>
    <!-- â–¼ ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ -->
    <!-- â–¼ ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ -->
    <div class="modal-overlay" style="display:none;">
        <div class="casefile-modal">
            <button class="close-btn">Ã—</button>
            <div class="casefile-scroll">

                <h1>å±±å°å±‹æ—¥èªŒ</h1>
                <h2>â€•â€• æœ€å¾Œã®è¨˜éŒ²ã¨æ€ã‚ã‚Œã‚‹ãƒšãƒ¼ã‚¸ â€•â€•</h2>

                <p>
                    ãƒ™ãƒƒãƒ‰ã«å¯ã‹ã›ãŸã‚ã®ãƒ–ãƒ­ãƒƒã‚¯ã®ä½“ã¯ã€ã‚‚ã†å‹•ã‹ãªã„ã€‚<br>
                    ã“ã‚Œã§å°‘ãªãã¨ã‚‚ã€æ‘ã«æ–°ã—ã„éºä½“ãŒå¢—ãˆã‚‹ã“ã¨ã¯ãªã„ã¯ãšã ã€‚
                </p>

                <p>
                    å¸½å­ã‚’å¤–ã—ãŸã¨ãã ã‘ã€å½¼ã¯æ­£æ°—ã‚’å–ã‚Šæˆ»ã™ã€‚ã ãŒâ€¦<br>
                    æ®‹ã•ã‚ŒãŸé¸æŠè‚¢ã¯ã€ã‚‚ã†ã€Œå°å°ã€ã—ã‹ãªã‹ã£ãŸã€‚
                </p>

                <hr>
                <p>
                    ç§ã¯é ­ã¨ä½“ã‚’åˆ†é›¢ã—ãŸã€‚<br>
                    ä½“ã¯ã“ã®å±±å°å±‹ã®ãƒ™ãƒƒãƒ‰ã«ã€é ­ã¯å …ã„ç®±ã«é–‰ã˜è¾¼ã‚ãŸã€‚å¸½å­ã¯ã€ã•ã‚‰ã«åˆ¥ã®ç®±ã¸ã€‚
                </p>

                <p>
                    â€•â€•ã‚‚ã—ã“ã®æ—¥è¨˜ã‚’èª­ã‚“ã§ã„ã‚‹è€…ãŒã„ã‚‹ãªã‚‰ã€è¦šãˆã¦ãŠã„ã¦ã»ã—ã„ã€‚<br>
                    <b>ã€Œå¸½å­ã‚’è¢«ã›ã‚‹ãªã€‚ã€</b><br>
                </p>
                <p>
                    â€¦ã—ã‹ã—ã€æœ¬å½“ã¯å½¼ãŒãŠæ°—ã«å…¥ã‚Šã®å¸½å­ã‚’ä½•ã®æ°—å…¼ã­ã‚‚ãªãã‹ã¶ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã‚„ã‚ŠãŸã„ã‚‚ã®ã ã€‚<br>
                </p>

                <hr>

                <p>
                    ãƒšãƒ¼ã‚¸ã®é–“ã‹ã‚‰ã€å¤ã³ãŸæ–°èã®åˆ‡ã‚Œç«¯ãŒã²ã‚‰ã‚Šã¨æ»‘ã‚Šè½ã¡ãŸã€‚
                </p>

                <div style="text-align:center; margin-top: 12px;">
                    <button class="text-btn" onclick="showNewspaperModal()">
                        æ–°èã®åˆ‡ã‚Œç«¯ã‚’èª­ã‚€
                    </button>
                </div>






            </div>
        </div>
    </div>

    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <!-- <div class="title">å±±å°å±‹ã‹ã‚‰ã®è„±å‡º</div> -->
            <div style="margin:0 0; text-align:center;">
                <a href="escape22_hint.html" target="_blank"
                    style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    ğŸ” ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
                </a>

            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="640" style="width: 90vw; max-width: 640px;"></canvas>


        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="msgText">æ°—ãŒä»˜ãã¨ã‚ãªãŸã¯å±±å°å±‹ã«ç«‹ã£ã¦ã„ã¾ã—ãŸã€‚</span>
                    <div id="statusIconArea" style="position:absolute; bottom:6px; right:12px; display:flex; gap:8px;">
                    </div>
                </div>
                <div class="navigation">

                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
                <div class="inventory-slot" onclick="useItem(5)"></div>
                <div class="inventory-slot" onclick="useItem(6)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
                ğŸ”Š BGM
            </button>
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">ã‚»ãƒ¼ãƒ–</button>
                <button class="nav-btn" onclick="loadGame()">ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
        <div class="notice">å½“ã‚µã‚¤ãƒˆã®éŸ³æºã¯<a href="https://otologic.jp/" target="blank">OtoLogic</a>,<a
                href="https://dova-s.jp/" target="blank">DOVA-SYNDROME</a>ã®ç´ æã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ ä½œè€…:<a href="index.html">ã‚¹ãƒ©ã‚»ãƒ–ãƒ³</a>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã¯å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>

    <audio id="bgm" src="sounds/22/kimitohitotoki.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-clear" src="sounds/common/Cyber03-1.mp3"></audio>
    <audio id="se-change" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-open" src="sounds/common/Short_Accent09-1(Dry).mp3"></audio>
    <audio id="se-fanta" src="sounds/common/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <audio id="se-coin" src="sounds/common/Onoma-Ding01-1(Dry).mp3"></audio>
    <audio id="se-scene-change" src="sounds/common/Scene_Change08-1(Delay-Fast).mp3"></audio>
    <audio id="se-tictac" src="sounds/common/tictac.mp3"></audio>
    <audio id="se-gacha" src="sounds/common/Retro_Anime-Switch02-3(Low).mp3"></audio>

    <audio id="se-bukimi_piano" src="sounds/common/bukimi_piano.mp3"></audio>
    <audio id="se-idea" src="sounds/common/Inspiration11-1(Low).mp3"></audio>
    <audio id="se-grab" src="sounds/common/Motion-Grab07-1(Dry).mp3"></audio>
    <audio id="se-switch" src="sounds/common/switch.mp3"></audio>
    <audio id="se-badend" src="sounds/common/sekaino_owari.mp3"></audio>

    <audio id="se-angel" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-up" src="sounds/common/Inspiration10-1(High).mp3"></audio>
    <audio id="se-ashioto" src="sounds/common/NES-RPG02-01(Enter).mp3"></audio>
    <audio id="se-hasami" src="sounds/common/hasami.mp3"></audio>
    <audio id="se-shutter" src="sounds/common/shutter.mp3"></audio>
    <audio id="se-fire" src="sounds/common/fire.mp3"></audio>
    <audio id="se-peta" src="sounds/common/Anime_Motion19-1(Phrase).mp3"></audio>


    <script>
        // --- Analytics helper ---
        window.ANA = {
            start: Date.now(),
            hintCount: 0,
            send(ev, params = {}) { try { gtag('event', ev, params); } catch (e) { } }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const a = document.querySelector('a[href*="_hint.html"]');
            if (a) {
                a.addEventListener('click', () => {
                    ANA.hintCount++;
                    ANA.send('open_hint', { count: ANA.hintCount });
                });
            }
        });

        window.ANA = Object.assign(window.ANA || {}, {
            sid: Math.random().toString(36).slice(2),
            sent: new Set(),
            baseParams() {
                return {
                    elapsed_sec: Math.round((Date.now() - this.start) / 1000),
                    hints: this.hintCount || 0,
                    save_version: (typeof SAVE_VERSION === 'number' ? SAVE_VERSION : null),
                    room: (window.gameState && gameState.currentRoom) || null,
                    sid: this.sid,
                };
            },
            once(ev, key = '', params = {}) {
                const k = `${ev}:${key}`;
                if (this.sent.has(k)) return;
                this.sent.add(k);
                this.send(ev, { ...this.baseParams(), ...params });
            }
        });

        // æ±ç”¨ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€ä¿¡ç”¨ãƒ˜ãƒ«ãƒ‘
        function markProgress(step, extra = {}) {
            ANA.once('progress', step, { step, ...extra });
        }


        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.querySelector(".modal-overlay");
            const openBtn = document.querySelector("#open-casefile");
            const closeBtn = document.querySelector(".close-btn");

            // åˆæœŸçŠ¶æ…‹ã§éè¡¨ç¤º
            modal.style.display = "none";

            // é–‹ã
            openBtn?.addEventListener("click", () => {
                modal.style.display = "flex";
            });

            // é–‰ã˜ã‚‹
            closeBtn?.addEventListener("click", () => {
                modal.style.display = "none";
            });

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚é–‰ã˜ã‚‹
            modal.addEventListener("click", (e) => {
                if (e.target === modal) modal.style.display = "none";
            });
        });



        window._nextModal = null;
        const canvas = document.getElementById('gameCanvas');
        let DEV_MODE = false;
        // ã‚²ãƒ¼ãƒ è¨­å®š - ç”»åƒãƒ‘ã‚¹ã‚’ã“ã“ã§ç®¡ç†
        let IMAGES = {
            rooms: {
                door: ['images/22/door.png'],
                window: ['images/22/window.png'],
                fireplace: ['images/22/fireplace.png', 'images/22/fireplace2.png'],
                bed: ['images/22/bed.png'],
                outside: ['images/22/outside22.png', 'images/22/outside22_2.png'],
                boxInner: ['images/22/box_inner.png'],
                saint: ['images/22/saint.jpeg'],
                end: ['images/22/end.jpeg'],
                endWorse: ['images/22/end_worse.png'],
                endGood: ['images/22/good_end.png', 'images/22/good_end2.png'],
                trueEnd: ['images/22/true_end.jpg'],

            },
            items: {
                coin: 'images/bear_coin.png',
                bear: 'images/22/bear_santa.png',
                bearCrying: 'images/22/bear_santa_crying.png',
                bearAfraid: 'images/22/bear_santa_afraid.png',
                back: 'images/common/back.png',
                arrowRight: 'images/common/arrow_right.png',
                arrowLeft: 'images/common/arrow_left.png',
                arrowAbove: 'images/common/arrow_above.png',
                redBack: 'images/common/red_back.png',
                greenBack: 'images/common/green_back.png',
                blueBack: 'images/common/blue_back.png',
                blackBack: 'images/common/black_back.png',
                boxClose: 'images/22/box_close.png',
                boxOpen: 'images/22/box_open.png',
                tree: 'images/22/tree.png',
                treeLight: 'images/22/tree_light.png',
                blockStocking: 'images/22/stocking.png',
                scissors: 'images/22/scissors.png',
                stool: 'images/22/stool.png',
                diaryClose: 'images/22/diary_close.png',
                diaryOpen: 'images/22/diary_open.png',
                blockFire: 'images/22/block_fire.png',
                blockFirePart: 'images/22/block_fire_part.png',
                boxBigClose: 'images/22/box_big_close.png',
                boxBigOpen: 'images/22/box_big_open.png',
                boxMiddleClose: 'images/22/box_middle_close.png',
                boxMiddleOpen: 'images/22/box_middle_open.png',
                boxMiddlePart: 'images/22/box_middle_part.png',
                boxSmallClose: 'images/22/box_small_close.png',
                boxSmallOpen: 'images/22/box_small_open.png',
                boxSmallPart: 'images/22/box_small_part.png',
                boxSmallLid: 'images/22/box_small_lid.png',
                boxWoodClose: 'images/22/box_wood_close.png',
                boxWoodOpen: 'images/22/box_wood_open.png',
                wallLight: 'images/22/wall_light.png',
                wallLight2: 'images/22/wall_light2.png',
                blockBody: 'images/22/block_body.png',
                blockHead: 'images/22/block_head.png',
                blockMan: 'images/22/block_man.png',
                blockManViolent: 'images/22/block_man_violent.png',
                blockManScissors: 'images/22/block_man_scissors.png',
                blockManHappy: 'images/22/block_man_happy.png',
                doll: 'images/22/doll.png',
                key: 'images/22/key.png',
                charaN: 'images/22/chara_n.png',
                map: 'images/22/map.png',
                newsPaperPic: 'images/22/newspaper_pic.png',
                star: 'images/22/star.png',
                pineCone: 'images/22/pine_cone.png',
                hat: 'images/22/hat.png',
                memo: 'images/22/memo.png',
                button: 'images/22/button.png',
                cake: 'images/22/cake.png',
                calendar: 'images/22/calendar.png',
                poster: 'images/22/poster.png',
                maze: 'images/22/maze.png',
                bearSleep: 'images/22/bear_sleep.png',
                ghost: 'images/22/ghost.png',
                envelope: 'images/22/envelope.jpeg',
                memoGhost: 'images/22/memo_ghost.png',
                faceSeal: 'images/22/face_seal.png',
                memoCushion: 'images/22/memo_cushion.png',




            },

            modals: {
                wreath: 'images/22/modal_wreath.png',
                memory: 'images/22/modal_memory.png',
                boxBigOpen: 'images/22/modal_box_big_open.png',
                boxMiddleOpen: 'images/22/modal_box_middle_open.png',
                bearAppear: 'images/22/modal_bear_appear.png',
                stockingSet: 'images/22/modal_stocking_set.png',
                headSet: 'images/22/modal_head_set.png',
                boxSmallLid: 'images/22/modal_box_small_lid.png',
                blockManHat1: 'images/22/modal_blockman_hat1.png',
                blockManHat2: 'images/22/modal_blockman_hat2.png',
                blockManScissors: 'images/22/modal_blockman_scissors.jpeg',
                blockManSeal: 'images/22/modal_blockman_seal.jpeg',
                blockManSealAfter: 'images/22/modal_blockman_seal_after.png',
                bearHat: 'images/22/modal_bear_hat.png',
                bearMemo: 'images/22/modal_bear_memo.png',
                bearCoin: 'images/22/modal_bear_coin.jpeg',
                bearBox: 'images/22/modal_bear_box.png',
                blockManGone: 'images/22/modal_blockman_gone.png',
                dollPaper: 'images/22/modal_doll_paper.png',
                mazeReverse: 'images/22/modal_maze_reverse.png',
                compass: 'images/22/modal_compass.jpeg',
                clock: 'images/22/modal_clock.png',
                ghostEnvelope: 'images/22/modal_ghost.jpeg',
                openEnvelope: 'images/22/modal_open_envelope.png',
                dollBack: 'images/22/modal_doll_back.png',
                cushionCut: 'images/22/modal_cushion_cut.png',
                mvEnding: 'images/22/ending.mp4',
                // badEnd: 'images/22/badend.jpeg',
            },
        };


        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        const SAVE_KEY = 'escapeGameState22';
        const SAVE_VERSION = 1;
        const SAVE_KEYS = [
            SAVE_KEY + '_1',
            SAVE_KEY + '_2'
        ];

        // æ—§1ã‚¹ãƒ­ãƒƒãƒˆã‚»ãƒ¼ãƒ–ãŒã‚ã‚Œã°ã€è‡ªå‹•ã§ã‚¹ãƒ­ãƒƒãƒˆ1ã«ç§»è¡Œ
        (function migrateOldSave() {
            try {
                const old = localStorage.getItem(SAVE_KEY);
                const slot1 = localStorage.getItem(SAVE_KEYS[0]);
                if (old && !slot1) {
                    localStorage.setItem(SAVE_KEYS[0], old);
                    // å¿…è¦ãªã‚‰å¤ã„ã‚­ãƒ¼ã¯æ¶ˆã—ã¦ã‚‚OK
                    // localStorage.removeItem(SAVE_KEY);
                    console.log('æ—§ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ­ãƒƒãƒˆ1ã«ç§»è¡Œã—ã¾ã—ãŸ');
                }
            } catch (e) {
                console.warn('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã«å¤±æ•—', e);
            }
        })();

        function getDefaultGameState() {
            return {
                currentRoom: 'door',
                openRooms: ['door'],
                openRoomsTmp: [],
                inventory: [],
                main: {
                    flags: {
                        unlockBox: false, foundBlockFire: false, setBlockFire: false,
                        unlockBoxBig: false, unlockBoxMiddle: false, unlockBoxSmall: false,
                        cutDiaryString: false, foundMaze: false,
                        foundMiddleBox: false, foundSmallBox: false,
                        foundScissors: false, foundBlockStocking: false, setBlockStocking: false,
                        foundBlockHead: false, foundHat: false, foundKey: false,
                        readNewspaper: false, coinAppear: false, foundCoin: false, gotCake: false,
                        blockManStatus: 0, //0:èƒ´ä½“ 1:é ­ã‚»ãƒƒãƒˆ 2:å¸½å­ã‚»ãƒƒãƒˆ 3:ã¯ã•ã¿ 4:å¤–å‡º
                        unlockDoor: false, unlockClock: false,
                        gotBearMap: false, scissorsTaken: false, gotEnvelope: false, gotSeal: false,
                        isNight: false,


                        talkTo: { bear: 0, blockMan: 0 }, backgroundState: 0,
                    }
                },
                fireplace: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                outside: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                endGood: {
                    flags: {
                        backgroundState: 0,
                    }
                },

                flags: { trueEndUnlocked: false },
                selectedItem: null,
                endings: { true: false, normal2: false, normal: false }

            };
        }

        let gameState = getDefaultGameState();




        // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿
        let rooms = {
            door: {
                name: 'å±±å°å±‹',
                description: 'ãƒ‰ã‚¢ãŒã‚ã‚‹',
                clickableAreas: [
                    {
                        x: 34.3, y: 30.4, width: 30.8, height: 58.0,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockDoor) {
                                handleDoor();
                            } else {
                                updateMessage('ãƒ‰ã‚¢ã¯é–‹ã‹ãªã„');
                            }


                        }),
                        description: 'ãƒ‰ã‚¢',
                        zIndex: 1,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 37.9, y: 32.9, width: 23.4, height: 22.7,
                        onClick: clickWrap(function () {
                            showObj(null, 'ã‚¯ãƒªã‚¹ãƒã‚¹ãƒªãƒ¼ã‚¹ã ', IMAGES.modals.wreath, 'ã‚¯ãƒªã‚¹ãƒã‚¹ãƒªãƒ¼ã‚¹ã ');

                        }),
                        description: 'ãƒªãƒ¼ã‚¹',
                        zIndex: 5,
                    },
                    {
                        x: 65.0, y: 43.8, width: 8.4, height: 12.4,
                        onClick: clickWrap(function () {
                            showDoorPuzzle();
                        }),
                        description: 'ãƒ‰ã‚¢æ“ä½œãƒ‘ãƒãƒ«',
                        zIndex: 5,
                    },
                    {
                        x: 74.6, y: 31.7, width: 12.7, height: 12.9,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.memo, 'ä½•ã‹ã®ãƒ¡ãƒ¢ã ');

                        }),
                        description: 'ãƒ‰ã‚¢æ¨ªãƒ¡ãƒ¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'memo', visible: () => true }
                    },
                    {
                        x: 68.1, y: 45.6, width: 2.3, height: 1.8,
                        onClick: clickWrap(function () {

                        }),
                        description: 'ãƒ‰ã‚¢æ“ä½œãƒ‘ãƒãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'redBack', visible: () => !gameState.main.flags.unlockDoor }
                    },
                    {
                        x: 68.1, y: 45.6, width: 2.3, height: 1.8,
                        onClick: clickWrap(function () {

                        }),
                        description: 'ãƒ‰ã‚¢æ“ä½œãƒ‘ãƒãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'greenBack', visible: () => gameState.main.flags.unlockDoor }
                    },
                    {
                        x: 71.8, y: 72.8, width: 23.5, height: 24.0,
                        onClick: clickWrap(function () {
                            showDoorBoxColorPuzzle();
                        }),
                        description: 'æœ¨ç®±é–‰ã˜',
                        zIndex: 1,
                        usable: () => !gameState.main.flags.unlockBox,
                        item: { img: 'boxClose', visible: () => !gameState.main.flags.unlockBox, }
                    },
                    {
                        x: 70.8, y: 69.8, width: 25.5, height: 26.0,
                        onClick: clickWrap(function () {
                            updateMessage('é–‹ã„ãŸæœ¨ç®±ã ');
                        }),
                        description: 'æœ¨ç®±é–‹ã',
                        zIndex: 1,
                        usable: () => gameState.main.flags.unlockBox,
                        item: { img: 'boxOpen', visible: () => gameState.main.flags.unlockBox, }
                    },
                    {
                        x: 80.8, y: 78.5, width: 5.5, height: 6.0,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundBlockFire', 'blockFire', 'ç‚ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¦‹ã¤ã‘ãŸ', IMAGES.items.blockFire, 'ç‚ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¦‹ã¤ã‘ãŸ');
                        }),
                        description: 'ç®±ã®ä¸­ã®ç‚ãƒ‘ãƒ¼ãƒ„',
                        zIndex: 5,
                        usable: () => gameState.main.flags.unlockBox && !gameState.main.flags.foundBlockFire,
                        item: { img: 'blockFirePart', visible: () => gameState.main.flags.unlockBox && !gameState.main.flags.foundBlockFire, }
                    },
                    {
                        x: 0, y: 32.9, width: 42.6, height: 62.8,
                        onClick: clickWrap(function () {
                            updateMessage('ã‚¯ãƒªã‚¹ãƒã‚¹ãƒ„ãƒªãƒ¼ã ');
                        }),
                        description: 'ãƒ„ãƒªãƒ¼',
                        zIndex: 3,
                        usable: () => !gameState.main.flags.bearAppear,
                        item: { img: 'tree', visible: () => !gameState.main.flags.bearAppear, }
                    },
                    {
                        x: 0, y: 32.9, width: 42.6, height: 62.8,
                        onClick: clickWrap(function () {
                            updateMessage('ã‚­ãƒ©ã‚­ãƒ©ã®ã‚¯ãƒªã‚¹ãƒã‚¹ãƒ„ãƒªãƒ¼ã ');
                        }),
                        description: 'ãƒ„ãƒªãƒ¼',
                        zIndex: 3,
                        usable: () => gameState.main.flags.bearAppear,
                        item: { img: 'treeLight', visible: () => gameState.main.flags.bearAppear, }
                    },
                    {
                        x: 16.4, y: 63.8, width: 7.4, height: 7.0,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundCoin', 'coin', 'ã‚¯ãƒã‚³ã‚¤ãƒ³ã‚’è¦‹ã¤ã‘ãŸ', IMAGES.items.coin, 'ã‚¯ãƒã‚³ã‚¤ãƒ³ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');

                        }),
                        description: 'ã‚¯ãƒã‚³ã‚¤ãƒ³',
                        zIndex: 5,
                        usable: () => gameState.main.flags.coinAppear && !gameState.main.flags.foundCoin,
                        item: { img: 'coin', visible: () => gameState.main.flags.coinAppear && !gameState.main.flags.foundCoin, }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('bed');
                        }),
                        description: 'ãƒ‰ã‚¢é¢ï¼šå·¦', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('window');
                        }),
                        description: 'ãƒ‰ã‚¢é¢ï¼šå³', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            bed: {
                name: 'å±±å°å±‹',
                description: 'ãƒ™ãƒƒãƒ‰ãŒã‚ã‚‹',
                clickableAreas: [
                    {
                        x: 26.1, y: 10.8, width: 50.5, height: 15.6,
                        onClick: clickWrap(function () {
                            updateMessage('ã‚¯ãƒªã‚¹ãƒã‚¹ã®é£¾ã‚Šã ')

                        }),
                        description: 'é›»é£¾',
                        zIndex: 5,
                        usable: () => gameState.main.flags.bearAppear,
                        item: { img: 'wallLight2', visible: () => gameState.main.flags.bearAppear }
                    },
                    {
                        x: 6.5, y: 16.3, width: 15.7, height: 14.1,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.calendar, 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã ');

                        }),
                        description: 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'calendar', visible: () => true }
                    },
                    {
                        x: 77.1, y: 13.3, width: 15.0, height: 13.6,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.items.poster, 'è±†çŸ¥è­˜ãƒã‚¹ã‚¿ãƒ¼ã ');
                        }),
                        description: 'ãƒã‚¹ã‚¿ãƒ¼',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'poster', visible: () => true }
                    },
                    {
                        x: 51.2, y: 35.1, width: 20.0, height: 19.1,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'scissors' && !gameState.main.flags.cutCushion) {
                                showObj('cutCushion', 'ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã‚’å°‘ã—åˆ‡ã£ãŸ', IMAGES.modals.cushionCut, 'ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã‚’å°‘ã—åˆ‡ã£ãŸ');
                                playSE('se-hasami');
                            } else if (gameState.main.flags.cutCushion) {
                                updateMessage('å¯æ„›ã„ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã ã€‚ç«¯ãŒå°‘ã—åˆ‡ã‚‰ã‚Œã¦ã„ã‚‹');
                            } else {
                                updateMessage('å¯æ„›ã„ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã ');
                            }
                        }),
                        description: 'ã‚¯ãƒƒã‚·ãƒ§ãƒ³å³',
                        zIndex: 5,
                        usable: () => true,
                    },
                    {
                        x: 67.4, y: 52.5, width: 7.9, height: 5.4,
                        onClick: clickWrap(function () {
                            showObj(null, 'ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å‡ºã¦ããŸç´™åˆ‡ã‚Œ', IMAGES.items.memoCushion, '');
                        }),
                        description: 'ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å‡ºã¦ããŸãƒ¡ãƒ¢',
                        zIndex: 5,
                        usable: () => gameState.main.flags.cutCushion,
                        item: { img: 'memoCushion', visible: () => gameState.main.flags.cutCushion }
                    },
                    {
                        x: 38.8, y: 46.8, width: 25.7, height: 15.5,
                        onClick: clickWrap(function () {
                            // é ­ãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸æŠã—ã¦ã„ã‚‹å ´åˆã ã‘ã€Œé ­ã‚»ãƒƒãƒˆã€ã‚¤ãƒ™ãƒ³ãƒˆ
                            if (gameState.selectedItem === 'blockHead') {

                                // SE
                                playSE('se-switch');

                                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é€²ã‚ã‚‹ï¼ˆ0 â†’ 1ï¼‰
                                gameState.main.flags.blockManStatus++;

                                // é ­ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¶ˆè²»ï¼†é¸æŠè§£é™¤
                                removeItem('blockHead');

                                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                                updateMessage('ãƒ–ãƒ­ãƒƒã‚¯ãƒœãƒ‡ã‚£ã«é ­ã‚’ã‚»ãƒƒãƒˆã—ãŸã€‚');
                                showModal(
                                    'é ­ã‚’ã‚»ãƒƒãƒˆã—ãŸ',
                                    `<img src="${IMAGES.modals.headSet}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                                );

                                // è¦‹ãŸç›®æ›´æ–°
                                renderCanvasRoom();

                            } else {
                                // ä½•ã‚‚æŒã£ã¦ã„ãªã„ï¼åˆ¥ã‚¢ã‚¤ãƒ†ãƒ é¸æŠæ™‚ã¯å¾“æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                                updateMessage('ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚ˆã†ãªãƒœãƒ‡ã‚£ã ã€‚æ±ºã—ã¦ã€‡ã€‡GOã§ã¯ãªã„');
                            }

                        }),
                        description: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒœãƒ‡ã‚£',
                        zIndex: 5,
                        usable: () => gameState.main.flags.blockManStatus == 0,
                        item: { img: 'blockBody', visible: () => gameState.main.flags.blockManStatus == 0 }
                    },
                    {
                        x: 47.8, y: 53.7, width: 6.5, height: 4.4,
                        onClick: clickWrap(function () {
                            acquireItemOnce('foundKey', 'key', 'éµã‚’è¦‹ã¤ã‘ãŸ', IMAGES.items.key, 'éµã‚’æ‰‹ã«å…¥ã‚ŒãŸ');

                        }),
                        description: 'éµ',
                        zIndex: 5,
                        usable: () => gameState.main.flags.blockManStatus > 0 && !gameState.main.flags.foundKey,
                        item: { img: 'key', visible: () => gameState.main.flags.blockManStatus > 0 && !gameState.main.flags.foundKey }
                    },
                    {
                        x: 74.3, y: 61.1, width: 22.6, height: 33.7,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.isNight) {
                                updateMessage('è‰¯ãè¦‹ãˆãªã„ãŒã€ç«‹ã£ãŸã¾ã¾ã€ç›®ã‚’é–‹ã‘ãŸã¾ã¾çœ ã£ã¦ã„ã‚‹ã‚ˆã†ã ');
                                return;
                            }
                            // å¸½å­ã‚’æŒã£ã¦ã„ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ 1 ã®ã¨ãã ã‘ã€Œæ¸¡ã—ã¾ã™ã‹ï¼Ÿã€
                            if (gameState.selectedItem === 'hat' && gameState.main.flags.blockManStatus === 1) {
                                showModal(
                                    'å¸½å­ã‚’æ¸¡ã—ã¾ã™ã‹ï¼Ÿ',
                                    'ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã«å¸½å­ã‚’æ¸¡ã—ã¾ã™ã€‚',
                                    [
                                        {
                                            text: 'ã¯ã„',
                                            action() {
                                                // å¸½å­æ¶ˆè²»
                                                if (typeof removeItem === 'function') {
                                                    removeItem('hat');
                                                }

                                                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€²è¡Œ
                                                gameState.main.flags.blockManStatus++;

                                                // if (typeof playSE === 'function') playSE('se-switch');
                                                updateMessage('ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã«å¸½å­ã‚’æ¸¡ã—ãŸã€‚ä¸å®‰ã‚’æ„Ÿã˜ã‚‹ã€‚æ—©ãè„±å‡ºã—ã‚ˆã†');


                                                // â˜… æ¬¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œå¸½å­ã‚’ã‹ã¶ã£ãŸã€ã‚’äºˆç´„
                                                window._nextModal = {
                                                    title: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã¯å¸½å­ã‚’ã‹ã¶ã£ãŸ',
                                                    content: `
<div class="blockman-hat-anim">
  <img src="${IMAGES.modals.blockManHat1}">
  <img src="${IMAGES.modals.blockManHat2}">
</div>
                                `,
                                                    buttons: [
                                                        { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                                    ],
                                                    after() {
                                                        playSE('se-bukimi_piano');
                                                        if (typeof renderCanvasRoom === 'function') {
                                                            renderCanvasRoom();
                                                        }
                                                        if (gameState.main.flags.unlockDoor) {
                                                            window._nextModal = {
                                                                title: 'ãƒ‰ã‚¢ã‚’é–‹ã‘ã¦ãã‚ŒãŸã®ã‹ã€‚ã‚ã‚ŠãŒã¨ã‚ˆ',
                                                                content: `<img src="${IMAGES.modals.blockManGone}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                                                buttons: [
                                                                    { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                                                ],
                                                                before() {
                                                                    screenFlash('black');
                                                                },
                                                                after() {
                                                                    playSE('se-ashioto');
                                                                    gameState.main.flags.blockManStatus = 4;
                                                                    if (typeof renderCanvasRoom === 'function') {
                                                                        renderCanvasRoom();
                                                                    }
                                                                    updateMessage('ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã¯å‡ºã¦è¡Œã£ã¦ã—ã¾ã£ãŸâ€¦');
                                                                }
                                                            };
                                                        }
                                                    }
                                                };

                                                // ã¾ãšã€Œå¸½å­ã‚’æ¸¡ã—ãŸã€‚ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ã‚’ç™»éŒ²
                                                const next = function () {
                                                    showModal(
                                                        'å¸½å­ã‚’æ¸¡ã—ãŸã€‚',
                                                        '',
                                                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                                                    );
                                                };

                                                // ä»Šã®ã€Œå¸½å­ã‚’æ¸¡ã—ã¾ã™ã‹ï¼Ÿã€ã‚’é–‰ã˜ã‚‹ â†’ next ãŒèµ°ã‚‹
                                                window._nextModal = (function (origNextModal, fn) {
                                                    // 1. ã€Œå¸½å­ã‚’æ¸¡ã—ãŸã€‚ã€ã‚’å‡ºã™
                                                    // 2. ãã®å¾Œã«ã•ã£ãã‚»ãƒƒãƒˆã—ãŸå¸½å­ã‚¢ãƒ‹ãƒ¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã™
                                                    return function () {
                                                        // ã¾ãšå¸½å­ã‚¢ãƒ‹ãƒ¡ã‚’ _nextModal ã«æˆ»ã™
                                                        window._nextModal = origNextModal;
                                                        fn();
                                                    };
                                                })(window._nextModal, next);

                                                closeModal();
                                            }
                                        },
                                        {
                                            text: 'ã„ã„ãˆ',
                                            action: 'close'
                                        }
                                    ],
                                    null,
                                    { columnButtons: true }
                                );
                            } else {
                                // ã„ã¤ã‚‚ã®ä¼šè©±
                                talkToHintCharacter('main', 'blockMan');
                            }

                        }),
                        description: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³',
                        zIndex: 5,
                        usable: () => gameState.main.flags.blockManStatus == 1,
                        item: { img: 'blockMan', visible: () => gameState.main.flags.blockManStatus == 1 }
                    },
                    {
                        x: 64.6, y: 57.5, width: 27.6, height: 40.7,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.isNight) {
                                updateMessage('è‰¯ãè¦‹ãˆãªã„ãŒã€æ€–ã„é¡”ã®ã¾ã¾çœ ã£ã¦ã„ã‚‹ã‚ˆã†ã ');
                                return;
                            }
                            if (gameState.selectedItem == 'scissors') {
                                removeItem('scissors');
                                showObj(null, 'è‰¯ã„ã‚‚ã®æŒã£ã¦ã‚‹ãªã‚ã€‚ã‚‚ã‚‰ã£ã¦ãŠãã‚ˆ', IMAGES.modals.blockManScissors, 'ã¯ã•ã¿ã‚’å¥ªã‚ã‚ŒãŸ');
                                playSE('se-grab');
                                gameState.main.flags.scissorsTaken = true;
                                gameState.main.flags.blockManStatus++;
                            } else if (gameState.selectedItem == 'faceSeal') {
                                putSeal();
                            } else if (gameState.main.flags.unlockDoor) {
                                talkToHintCharacter('main', 'blockMan4');
                            } else {
                                talkToHintCharacter('main', 'blockMan2');
                            }

                        }),
                        description: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³å¸½å­ON',
                        zIndex: 5,
                        usable: () => gameState.main.flags.blockManStatus == 2,
                        item: { img: 'blockManViolent', visible: () => gameState.main.flags.blockManStatus == 2 }
                    },
                    {
                        x: 64.6, y: 57.5, width: 34.6, height: 40.7,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.isNight) {
                                updateMessage('è‰¯ãè¦‹ãˆãªã„ãŒã€æ€–ã„é¡”ã®ã¾ã¾ã¯ã•ã¿ã‚’æŒã£ã¦çœ ã£ã¦ã„ã‚‹ã‚ˆã†ã ');
                                return;
                            }
                            if (gameState.main.flags.unlockDoor) {
                                talkToHintCharacter('main', 'blockMan4');
                            } else if (gameState.selectedItem == 'faceSeal') {
                                putSeal();
                            } else {
                                talkToHintCharacter('main', 'blockMan3');
                            }

                        }),
                        description: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³å¸½å­ONã¯ã•ã¿æŒã¡',
                        zIndex: 5,
                        usable: () => gameState.main.flags.blockManStatus == 3,
                        item: { img: 'blockManScissors', visible: () => gameState.main.flags.blockManStatus == 3 }
                    },
                    {
                        x: 64.6, y: 57.5, width: 25.6, height: 40.7,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.isNight) {
                                updateMessage('è‰¯ãè¦‹ãˆãªã„ãŒã€ç«‹ã£ãŸã¾ã¾ã€ç›®ã‚’é–‹ã‘ãŸã¾ã¾çœ ã£ã¦ã„ã‚‹ã‚ˆã†ã ');
                                return;
                            }

                            talkToHintCharacter('main', 'blockManHappy');


                        }),
                        description: 'ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³å¸½å­ONã«ã“ã‚„ã‹',
                        zIndex: 5,
                        usable: () => gameState.main.flags.blockManStatus == 5,
                        item: { img: 'blockManHappy', visible: () => gameState.main.flags.blockManStatus == 5 }
                    },
                    {
                        x: 64.6, y: 89.2, width: 7.4, height: 8.8,
                        onClick: clickWrap(function () {

                        }),
                        description: 'è½ã¨ã•ã‚ŒãŸã¯ã•ã¿',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'scissors', visible: () => gameState.main.flags.scissorsTaken && gameState.main.flags.blockManStatus == 5 }
                    },
                    {
                        x: 79.1, y: 33.2, width: 17.3, height: 16.8,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockClock) {
                                toggleNight();
                            } else {
                                showClockPuzzle();
                            }

                        }),
                        description: 'æ™‚è¨ˆ',
                        zIndex: 5,
                        usable: () => true,
                    },

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('fireplace');
                        }),
                        description: 'ãƒ™ãƒƒãƒ‰ï¼šå·¦', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('door');
                        }),
                        description: 'ãƒ™ãƒƒãƒ‰ï¼šå³', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            fireplace: {
                name: 'å±±å°å±‹',
                description: 'æš–ç‚‰ãŒã‚ã‚‹',
                clickableAreas: [
                    {
                        x: 43.5, y: 62.8, width: 15.1, height: 13.5,
                        onClick: clickWrap(function () {
                            // ç‚ãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸æŠã—ã¦ã„ã‚‹ã¨ãã ã‘ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
                            if (gameState.selectedItem === 'blockFire') {
                                showModal(
                                    'ç‚ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®ãã¾ã™ã‹ï¼Ÿ',
                                    '<p>æš–ç‚‰ã«ç‚ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¯ã‚è¾¼ã¿ã¾ã™ã€‚</p>',
                                    [
                                        {
                                            text: 'ã¯ã„',
                                            action: () => {
                                                // èƒŒæ™¯ã‚’ç‚ã‚ã‚Šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸
                                                gameState.fireplace.flags.backgroundState++;
                                                gameState.main.flags.setBlockFire = true;

                                                removeItem('blockFire');

                                                updateMessage('ç‚ãƒ–ãƒ­ãƒƒã‚¯ã‚’æš–ç‚‰ã«ã¯ã‚ãŸã€‚');
                                                playSE('se-fire');
                                                renderCanvasRoom();
                                                closeModal();
                                            }
                                        },
                                        {
                                            text: 'ã„ã„ãˆ',
                                            action: 'close'
                                        }
                                    ]
                                );
                            } else if (gameState.main.flags.setBlockFire) {
                                if (gameState.selectedItem == 'maze') {
                                    updateMessage('å®Ÿéš›ã®ç‚ã§ã¯ãªã„ã®ã§ã€ç‡ƒã‚„ã™ã“ã¨ã¯ã§ããªã•ãã†ã ');
                                } else if (gameState.selectedItem == 'map') {
                                    updateMessage('ç‡ƒã‚„ã™ã“ã¨ã¯ã§ããªã•ãã†ã ã€‚ã›ã£ã‹ãã‚¯ãƒã‚µãƒ³ã‚¿ãŒæ›¸ã„ã¦ãã‚ŒãŸã‚“ã ã—â€¦');
                                } else if (gameState.selectedItem == 'hat') {
                                    updateMessage('ç‡ƒã‚„ã™ã“ã¨ã¯ã§ããªã•ãã†ã ã€‚å¸½å­ã‚’å°‘ã—æ¸©ã‚ã¦ã¿ãŸ');
                                } else if (gameState.selectedItem == 'blockHead') {
                                    updateMessage('ãã‚“ãªã“ã¨ã¯ã‚„ã‚ã‚ˆã†');
                                } else if (gameState.selectedItem == 'key') {
                                    updateMessage('éµã‚’æ¸©ã‚ã¦ã‚‚ä»•æ–¹ãªã„');
                                } else {
                                    updateMessage('ç‚ãƒ–ãƒ­ãƒƒã‚¯ãŒç™ºå…‰ã—ã¦ã„ã‚‹ã€‚æš–ã‹ã„ã€‚');
                                }

                            } else {
                                // ä½•ã‚‚æŒã£ã¦ã„ãªã„ã¨ã
                                updateMessage('ç«ã¯æ¶ˆãˆã¦ã„ã‚‹');
                            }

                        }),
                        description: 'æš–ç‚‰',

                    },
                    {
                        x: 51.1, y: 56.6, width: 11.0, height: 7.7,
                        onClick: clickWrap(function () {
                            showObj(null, 'æ–‡å­—ãŒè¦‹ãˆã‚‹â€¦', IMAGES.modals.memory, 'æ–‡å­—ãŒè¦‹ãˆã‚‹â€¦');

                        }),
                        description: 'æš–ç‚‰æ–‡å­—',
                        zIndex: 5,
                        usable: () => gameState.main.flags.setBlockFire,
                    },

                    {
                        x: 72.9, y: 75.6, width: 24.3, height: 24.4,
                        onClick: clickWrap(function () {
                            updateMessage('æœ¨è£½ã®æ¤…å­ã ');

                        }),
                        description: 'ã‚¹ãƒ„ãƒ¼ãƒ«',
                        zIndex: 1,
                        usable: () => true,
                        item: { img: 'stool', visible: () => true }
                    },
                    {
                        x: 79.2, y: 71.7, width: 16.4, height: 12.6,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'scissors') {
                                gameState.main.flags.cutDiaryString = true;
                                playSE('se-hasami');
                                renderCanvasRoom();
                                updateMessage('ã¯ã•ã¿ã§ç´ã‚’åˆ‡ã£ãŸ');

                            } else {
                                updateMessage('ã²ã‚‚ã§ç¸›ã‚‰ã‚ŒãŸæœ¬ã ');
                            }

                        }),
                        description: 'æ—¥è¨˜',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.cutDiaryString,
                        item: { img: 'diaryClose', visible: () => !gameState.main.flags.cutDiaryString }
                    },
                    {
                        x: 79.2, y: 71.7, width: 16.4, height: 12.6,
                        onClick: clickWrap(function () {
                            const caseModal = document.querySelector('.modal-overlay');
                            if (caseModal) {
                                caseModal.style.display = 'flex';
                                showModal(
                                    'èª°ã‹ã®æ—¥è¨˜ã ',
                                    '',
                                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                                );
                                updateMessage('èª°ã‹ã®æ—¥è¨˜ã ');
                            } else {
                                console.warn('èª°ã‹ã®æ—¥è¨˜ã ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                            }

                        }),
                        description: 'æ—¥è¨˜',
                        zIndex: 5,
                        usable: () => gameState.main.flags.cutDiaryString,
                        item: { img: 'diaryOpen', visible: () => gameState.main.flags.cutDiaryString }
                    },
                    {
                        x: 43.8, y: 13.7, width: 13.9, height: 19.3,
                        onClick: clickWrap(function () {
                            // é´ä¸‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŒã£ã¦ã„ã‚‹ï¼†ã¾ã è¨­ç½®ã—ã¦ã„ãªã„ã¨ã
                            if (gameState.selectedItem === 'blockStocking' && !gameState.main.flags.setBlockStocking) {

                                // é´ä¸‹è¨­ç½®ãƒ•ãƒ©ã‚°ON
                                gameState.main.flags.setBlockStocking = true;

                                // ã‚¢ã‚¤ãƒ†ãƒ æ¶ˆè²»ï¼†é¸æŠè§£é™¤
                                removeItem('blockStocking');
                                playSE('se-switch');

                                // è¦‹ãŸç›®æ›´æ–°
                                updateMessage('é´ä¸‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’æš–ç‚‰ã®ä¸Šã«è¨­ç½®ã—ãŸã€‚');
                                renderCanvasRoom();

                                // æ¬¡ã«å‡ºã™ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¯ãƒã‚µãƒ³ã‚¿ç™»å ´ï¼‰ã‚’äºˆç´„
                                window._nextModal = {
                                    title: 'ãªã‚“ã ã‚ã†ï¼Ÿ',
                                    content: `<img src="${IMAGES.modals.bearAppear}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    buttons: [
                                        { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                    ],
                                    before() {
                                        // ã‚¯ãƒç™»å ´ãƒ•ãƒ©ã‚°ON
                                        gameState.main.flags.bearAppear = true;
                                        updateMessage('ã‚‚ãã‚‚ãã—ãŸç…™ã‹ã‚‰ã‚¯ãƒã‚µãƒ³ã‚¿ãŒç¾ã‚ŒãŸã€‚éƒ¨å±‹ã®é›°å›²æ°—ãŒå°‘ã—å¤‰ã‚ã£ãŸã‚ˆã†ã ');
                                        renderCanvasRoom();
                                    },
                                    after() {
                                        try { playSE('se-fanta'); } catch (e) { }
                                    }
                                };

                                // 1æšç›®ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé´ä¸‹è¨­ç½®ï¼‰
                                showModal(
                                    'é´ä¸‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¨­ç½®ã—ãŸ',
                                    `<img src="${IMAGES.modals.stockingSet}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }],
                                    () => {
                                        window._nextModal = {
                                            title: 'éƒ¨å±‹ã®é›°å›²æ°—ãŒã‹ã‚ã£ãŸã‚ˆã†ã ',
                                            content: ``,
                                            buttons: [
                                                { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                            ],

                                        };
                                    },

                                );

                            } else if (gameState.main.flags.bearAppear) {
                                // æ—¢ã«ã‚¯ãƒãŒå‡ºã¦ã„ã‚‹çŠ¶æ…‹
                                updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ãŒã“ã¡ã‚‰ã‚’è¦‹ã¦ã„ã‚‹ã€‚');
                            } else if (gameState.main.flags.setBlockStocking) {
                                updateMessage('é´ä¸‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’é£¾ã£ãŸã€‚ä½•ã‹èµ·ããã†ã â€¦ã€‚');
                            } else {
                                // ä½•ã‚‚ã—ã¦ã„ãªã„ã¨ã
                                updateMessage('é£¾ã‚Šã‚’ç½®ã‘ãã†ãªã‚¹ãƒšãƒ¼ã‚¹ã ã€‚');
                            }

                        }),
                        description: 'æš–ç‚‰ä¸Šã®ç©ºãã‚¹ãƒšãƒ¼ã‚¹',
                        zIndex: 1,
                        usable: () => !gameState.main.flags.setBlockStocking,
                    },
                    {
                        x: 37.2, y: 12.4, width: 21.0, height: 27.3,
                        onClick: clickWrap(function () {
                            updateMessage('ã•ã£ãé£¾ã£ãŸé´ä¸‹ã ');

                        }),
                        description: 'é´ä¸‹',
                        zIndex: 5,
                        usable: () => gameState.main.flags.setBlockStocking,
                        item: { img: 'blockStocking', visible: () => gameState.main.flags.setBlockStocking }
                    },
                    {
                        x: 77.3, y: 51.8, width: 17.8, height: 18.6,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.blockManStatus == 5) {
                                updateMessage('ãŠã°ã‘ã¯å¬‰ã—ãã†ã«ãµã‚ãµã‚ã—ã¦ã„ã‚‹');
                            } else if (gameState.main.flags.gotEnvelope) {
                                updateMessage('ãŠã°ã‘ã¯ãµã‚ãµã‚ã—ã¦ã„ã‚‹');
                            } else {
                                acquireItemOnce('gotEnvelope', 'envelope', 'ãŠã°ã‘ã¯å°ç­’ã‚’å·®ã—å‡ºã—ã¦ããŸ', IMAGES.modals.ghostEnvelope, 'å°ç­’ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');
                            }

                        }),
                        description: 'ãŠã°ã‘',
                        zIndex: 5,
                        usable: () => gameState.main.flags.isNight,
                        item: { img: 'ghost', visible: () => gameState.main.flags.isNight }
                    },
                    {
                        x: 57.9, y: 19.7, width: 21.7, height: 21.7,
                        onClick: clickWrap(function () {
                            // â˜… ã‚¯ãƒã‚³ã‚¤ãƒ³ â†’ ã‚±ãƒ¼ã‚­ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ
                            if (gameState.selectedItem === 'coin' && !gameState.main.flags.gotCake) {
                                // ã‚³ã‚¤ãƒ³æ¶ˆè²»
                                removeItem('coin');
                                playSE('se-coin');



                                window._nextModal = {
                                    title: 'ã‚µãƒ³ã‚¿ã•ã‚“ã‹ã‚‰ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼',
                                    content: `<img src="${IMAGES.modals.bearBox}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    buttons: [
                                        { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                    ],
                                    after() {
                                        // ã‚±ãƒ¼ã‚­ä»˜ä¸
                                        addItem('cake');
                                        gameState.main.flags.gotCake = true;
                                        updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ã‹ã‚‰ã‚±ãƒ¼ã‚­ã‚’ã‚‚ã‚‰ã£ãŸã€‚ãŠã„ã—ãã†ã€‚');
                                    }
                                };

                                showModal(
                                    'ãŠã£ï¼ã‚³ã‚¤ãƒ³ã‚ã‚ŠãŒã¨ã†',
                                    `<img src="${IMAGES.modals.bearCoin}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                                );

                                return;
                            }
                            // å¸½å­ã‚’é¸æŠä¸­ ï¼† ã¾ã åœ°å›³ã‚’ã‚‚ã‚‰ã£ã¦ã„ãªã„ã¨ã
                            if (gameState.selectedItem === 'hat' && !gameState.main.flags.gotBearMap) {

                                updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ã«å¸½å­ã‚’è¦‹ã›ãŸã€‚ãªã‚“ã‹ã‚¤ãƒ¤ãªäºˆæ„ŸãŒã™ã‚‹â€¦');

                                // æ¬¡ã«å‡ºã™ã€Œãã†ã ï¼ãƒœã‚¯ã„ã„å ´æ‰€çŸ¥ã£ã¦ã‚‹ã‚ˆï¼ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’äºˆç´„
                                window._nextModal = {
                                    title: 'ãã†ã ï¼ãƒœã‚¯ã„ã„å ´æ‰€çŸ¥ã£ã¦ã‚‹ã‚ˆï¼',
                                    content: `
                    <img src="${IMAGES.modals.bearMemo}"
                         style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">
                `,
                                    buttons: [
                                        { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                    ],
                                    before() {
                                        // åœ°å›³ç²å¾—å‡¦ç†
                                        playSE('se-idea');
                                        addItem('map');
                                        gameState.main.flags.gotBearMap = true;
                                        updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ã‹ã‚‰é›‘ãªåœ°å›³ã‚’ã‚‚ã‚‰ã£ãŸã€‚');

                                    }
                                };

                                // 1æšç›®ã®ã€Œã†ã‚ã‚â€¦ãªã‚“ã‹ã„ã‚„ãªã‹ã‚“ã˜ã€ãƒ¢ãƒ¼ãƒ€ãƒ«
                                showModal(
                                    'ã†ã‚ã‚â€¦ãªã‚“ã‹ã„ã‚„ãªã‹ã‚“ã˜ãŒã™ã‚‹ã€‚ã‚µãƒ³ã‚¿ã«ã¯åˆ†ã‹ã‚‹ã‚“ã ',
                                    `<img src="${IMAGES.modals.bearHat}"
                      style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [
                                        { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                    ]
                                );

                            } else if (gameState.main.flags.blockManStatus == 5) {

                                updateMessage('ãŠãŠãŠãƒ¼ã€ã™ã”ã„ã­');
                            } else if (gameState.selectedItem == 'scissors') {

                                updateMessage('ã“ã£ã¡ã«å‘ã‘ãªã„ã§ãƒ¼');
                            } else if (gameState.selectedItem == 'cake') {

                                updateMessage('ã‚¯ãƒéƒ¨åˆ†ã‚‚é£Ÿã¹ã‚‰ã‚Œã‚‹ã‚ˆï¼');
                            } else if (gameState.selectedItem == 'map') {

                                updateMessage('ãªã‹ãªã‹ã®å‡ºæ¥æ „ãˆã§ã—ã‚‡ï¼Ÿæ—©ãè¡Œã“ã†');
                            } else if (gameState.main.flags.gotBearMap) {
                                talkToHintCharacter('main', 'bear2');
                            } else {
                                talkToHintCharacter('main', 'bear');
                            }

                        }),
                        description: 'ã‚¯ãƒå¦–ç²¾',
                        zIndex: 5,
                        usable: () => gameState.main.flags.bearAppear && (gameState.main.flags.blockManStatus < 2 || gameState.main.flags.blockManStatus == 5) && !gameState.main.flags.isNight,
                        item: { img: 'bear', visible: () => gameState.main.flags.bearAppear && (gameState.main.flags.blockManStatus < 2 || gameState.main.flags.blockManStatus == 5) && !gameState.main.flags.isNight }
                    },
                    {
                        x: 57.9, y: 19.7, width: 21.7, height: 21.7,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'cake') {
                                updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ã¯ãŠã³ãˆã¦ã„ã¦ã€è¨€è‘‰ãŒå‡ºãªã„ã‚ˆã†ã ');
                            } else if (gameState.selectedItem === 'coin' && !gameState.main.flags.gotCake) {
                                updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ã¯ãŠã³ãˆã¦ã„ã¦ã€ãã‚Œã©ã“ã‚ã§ã¯ãªã„ã‚ˆã†ã ');
                            } else if (gameState.main.flags.isNight) {
                                updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ã¯ãŠã³ãˆã¦ã„ã¦ã€å¤œã‚‚çœ ã‚Œãªã„ã‚ˆã†ã ');
                            } else {
                                updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ã¯ãŠã³ãˆã¦ã„ã‚‹');
                            }

                        }),
                        description: 'ã‚¯ãƒå¦–ç²¾',
                        zIndex: 5,
                        usable: () => gameState.main.flags.bearAppear && (gameState.main.flags.blockManStatus == 2 || gameState.main.flags.blockManStatus == 3),
                        item: { img: 'bearCrying', visible: () => gameState.main.flags.bearAppear && (gameState.main.flags.blockManStatus == 2 || gameState.main.flags.blockManStatus == 3) }
                    },
                    {
                        x: 57.9, y: 19.7, width: 21.7, height: 21.7,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.blockManStatus == 4) {
                                talkToHintCharacter('main', 'bear3');
                            }

                        }),
                        description: 'ã‚¯ãƒå¦–ç²¾å¿ƒé…',
                        zIndex: 5,
                        usable: () => gameState.main.flags.bearAppear && gameState.main.flags.blockManStatus == 4,
                        item: { img: 'bearAfraid', visible: () => gameState.main.flags.bearAppear && gameState.main.flags.blockManStatus == 4 }
                    },
                    {
                        x: 57.9, y: 19.7, width: 23.7, height: 21.7,
                        onClick: clickWrap(function () {
                            updateMessage('ã‚¯ãƒã‚µãƒ³ã‚¿ã¯çœ ã£ã¦ã„ã‚‹')


                        }),
                        description: 'ã‚¯ãƒå¦–ç²¾çœ ã‚‹',
                        zIndex: 5,
                        usable: () => gameState.main.flags.bearAppear && (gameState.main.flags.blockManStatus < 2 || gameState.main.flags.blockManStatus == 5) && gameState.main.flags.isNight,
                        item: { img: 'bearSleep', visible: () => gameState.main.flags.bearAppear && (gameState.main.flags.blockManStatus < 2 || gameState.main.flags.blockManStatus == 5) && gameState.main.flags.isNight }
                    },
                    {
                        x: 2.4, y: 77.1, width: 29.0, height: 19.0,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem == 'key') {
                                gameState.main.flags.unlockBoxWood = true;
                                renderCanvasRoom();
                                removeItem('key');
                                updateMessage('éµã§ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ãŸ');
                                playSE('se-gacha');
                            } else {
                                updateMessage('éµãŒã‹ã‹ã£ã¦ã„ã‚‹');
                            }

                        }),
                        description: 'éµä»˜ãç®±é–‰',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.unlockBoxWood,
                        item: { img: 'boxWoodClose', visible: () => !gameState.main.flags.unlockBoxWood }
                    },
                    {
                        x: 2.4, y: 73.1, width: 29.0, height: 23.2,
                        onClick: clickWrap(function () {
                            changeRoom('boxInner');

                        }),
                        description: 'éµä»˜ãç®±é–‹',
                        zIndex: 5,
                        usable: () => gameState.main.flags.unlockBoxWood,
                        item: { img: 'boxWoodOpen', visible: () => gameState.main.flags.unlockBoxWood }
                    },
                    {
                        x: 26.2, y: 48.1, width: 6.7, height: 6.4,
                        onClick: clickWrap(function () {
                            buttonSeq.push('L');
                            checkButtonSeq();
                            updateMessage('ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸ');

                        }),
                        description: 'ãƒœã‚¿ãƒ³å·¦',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'button', visible: () => true }
                    },
                    {
                        x: 67.8, y: 48.2, width: 6.4, height: 6.6,
                        onClick: clickWrap(function () {
                            buttonSeq.push('R');
                            checkButtonSeq();
                            updateMessage('ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸ');


                        }),
                        description: 'ãƒœã‚¿ãƒ³å³',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'button', visible: () => true }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('window');
                        }),
                        description: 'æš–ç‚‰ï¼šå·¦', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('bed');
                        }),
                        description: 'æš–ç‚‰ï¼šå³', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            window: {
                name: 'å±±å°å±‹',
                description: 'çª“ãŒã‚ã‚‹',
                clickableAreas: [
                    {
                        x: 42.2, y: 39.6, width: 29.1, height: 29.9,
                        onClick: clickWrap(function () {
                            changeRoom('outside');

                        }),
                        description: 'çª“',

                    },
                    {
                        x: 40.3, y: 70.6, width: 30.2, height: 28.4,
                        onClick: clickWrap(function () {
                            showBoxBigPuzzle();
                        }),
                        description: 'å¤§ãã„ç®±é–‰',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.unlockBoxBig,
                        item: { img: 'boxBigClose', visible: () => !gameState.main.flags.unlockBoxBig }
                    },
                    {
                        x: 40.3, y: 64.6, width: 30.2, height: 34.4,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockBoxBig && gameState.main.flags.foundMiddleBox) {
                                updateMessage('ä¸­ã¯ã‹ã‚‰ã£ã½ã ')

                            } else if (gameState.main.flags.unlockBoxBig && !gameState.main.flags.foundMiddleBox) {
                                gameState.main.flags.foundMiddleBox = true;
                                acquireItemOnce('foundBlockStocking', 'blockStocking', 'å¤§ãã„ç®±ã‹ã‚‰ä¸­ãã‚‰ã„ã®ç®±ã¨é´ä¸‹ãƒ–ãƒ­ãƒƒã‚¯ãŒå‡ºã¦ããŸ', IMAGES.modals.boxBigOpen, 'é´ä¸‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');

                            }


                        }),
                        description: 'å¤§ãã„ç®±é–‹',
                        zIndex: 5,
                        usable: () => gameState.main.flags.unlockBoxBig,
                        item: { img: 'boxBigOpen', visible: () => gameState.main.flags.unlockBoxBig }
                    },
                    {
                        x: 43.3, y: 80.6, width: 23.2, height: 5.4,
                        onClick: clickWrap(function () {


                        }),
                        description: 'å¤§ãã„ç®±é–‹ã®ä¸­ã®èµ¤ã„ç®±ãƒ‘ãƒ¼ãƒ„',
                        zIndex: 6,
                        usable: () => false,
                        item: { img: 'boxMiddlePart', visible: () => gameState.main.flags.unlockBoxBig && !gameState.main.flags.foundMiddleBox }
                    },
                    {
                        x: 74.3, y: 78.6, width: 20.6, height: 19.5,
                        onClick: clickWrap(function () {
                            showMiddleBoxPuzzle();
                        }),
                        description: 'ä¸­ãã‚‰ã„ã®ç®±é–‰',
                        zIndex: 5,
                        usable: () => gameState.main.flags.foundMiddleBox && !gameState.main.flags.unlockBoxMiddle,
                        item: { img: 'boxMiddleClose', visible: () => gameState.main.flags.foundMiddleBox && !gameState.main.flags.unlockBoxMiddle }
                    },
                    {
                        x: 74.3, y: 73.6, width: 20.6, height: 24.5,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockBoxMiddle && gameState.main.flags.foundSmallBox) {
                                updateMessage('ä¸­ã¯ã‹ã‚‰ã£ã½ã ')

                            } else if (gameState.main.flags.unlockBoxMiddle && !gameState.main.flags.foundSmallBox) {
                                gameState.main.flags.foundSmallBox = true;
                                acquireItemOnce('foundBlockHead', 'blockHead', 'ä¸­ãã‚‰ã„ã®èµ¤ã„ç®±ã‹ã‚‰å°ã•ã„ç®±ã¨é ­ãƒ–ãƒ­ãƒƒã‚¯ãŒå‡ºã¦ããŸ', IMAGES.modals.boxMiddleOpen, 'é ­ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');

                            }
                        }),
                        description: 'ä¸­ãã‚‰ã„ã®ç®±é–‹',
                        zIndex: 5,
                        usable: () => gameState.main.flags.unlockBoxMiddle,
                        item: { img: 'boxMiddleOpen', visible: () => gameState.main.flags.unlockBoxMiddle }
                    },
                    {
                        x: 82.3, y: 83.6, width: 10.2, height: 5.4,
                        onClick: clickWrap(function () {

                        }),
                        description: 'ä¸­ãã‚‰ã„ã®ç®±é–‹ã®ä¸­ã®ç´«ç®±ãƒ‘ãƒ¼ãƒ„',
                        zIndex: 6,
                        usable: () => false,
                        item: { img: 'boxSmallPart', visible: () => gameState.main.flags.unlockBoxMiddle && !gameState.main.flags.foundSmallBox }
                    },
                    {
                        x: 21.7, y: 87.2, width: 10.1, height: 7.9,
                        onClick: clickWrap(function () {
                            showSmallBoxPuzzle();

                        }),
                        description: 'å°ã•ã„ç®±é–‰',
                        zIndex: 5,
                        usable: () => gameState.main.flags.foundSmallBox && !gameState.main.flags.unlockBoxSmall,
                        item: { img: 'boxSmallClose', visible: () => gameState.main.flags.foundSmallBox && !gameState.main.flags.unlockBoxSmall }
                    },
                    {
                        x: 21.7, y: 87.2, width: 10.1, height: 7.9,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.unlockBoxSmall && gameState.main.flags.foundHat) {
                                updateMessage('ä¸­ã¯ã‹ã‚‰ã£ã½ã ')

                            } else if (gameState.main.flags.unlockBoxSmall && !gameState.main.flags.foundHat) {

                                acquireItemOnce('foundHat', 'hat', 'å°ã•ã„ç®±ã‹ã‚‰å¸½å­ã‚’è¦‹ã¤ã‘ãŸ', IMAGES.items.hat, 'å¸½å­ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');

                            }
                        }),
                        description: 'å°ã•ã„ç®±é–‹',
                        zIndex: 5,
                        usable: () => gameState.main.flags.foundSmallBox && gameState.main.flags.unlockBoxSmall,
                        item: { img: 'boxSmallOpen', visible: () => gameState.main.flags.foundSmallBox && gameState.main.flags.unlockBoxSmall }
                    },
                    {
                        x: 23.7, y: 94.2, width: 10.1, height: 3.9,
                        onClick: clickWrap(function () {
                            showObj(null, '', IMAGES.modals.boxSmallLid, 'å°ã•ã„ç®±ã®ãµãŸã ');
                        }),
                        description: 'å°ã•ã„ç®±ãµãŸ',
                        zIndex: 5,
                        usable: () => gameState.main.flags.foundSmallBox && gameState.main.flags.unlockBoxSmall,
                        item: { img: 'boxSmallLid', visible: () => gameState.main.flags.foundSmallBox && gameState.main.flags.unlockBoxSmall }
                    },


                    {
                        x: 28.1, y: 16.7, width: 56.4, height: 13.8,
                        onClick: clickWrap(function () {
                            updateMessage('ã‚¯ãƒªã‚¹ãƒã‚¹ã®é£¾ã‚Šã ')

                        }),
                        description: 'é›»é£¾',
                        zIndex: 5,
                        usable: () => gameState.main.flags.bearAppear,
                        item: { img: 'wallLight', visible: () => gameState.main.flags.bearAppear }
                    },

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('door');
                        }),
                        description: 'çª“ï¼šå·¦', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick: clickWrap(function () {
                            changeRoom('fireplace');
                        }),
                        description: 'çª“ï¼šå³', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            // inner
            boxInner: {
                name: 'ç®±ã®ä¸­',
                description: '',
                clickableAreas: [
                    {
                        x: 10.5, y: 8.2, width: 40.2, height: 63.4,
                        onClick: clickWrap(function () {
                            updateMessage('ãƒãƒ•ãƒ©ãƒ¼ã‚„ãƒœãƒ¼ãƒ«ãƒšãƒ³ãªã©ãŒé›‘å¤šã«å…¥ã£ã¦ã„ã‚‹');
                        }),
                        description: 'ãƒãƒ•ãƒ©ãƒ¼ãªã©',
                        zIndex: 2,
                        usable: () => true,

                    },
                    {
                        x: 25.3, y: 65.1, width: 21.4, height: 22.4,
                        onClick: clickWrap(function () {
                            // ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ã®ã¬ã„ãã‚‹ã¿ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ã
                            showModal(
                                'ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ã®ã¬ã„ãã‚‹ã¿',
                                `<img src="${IMAGES.items.doll}" 
          style="max-width:380px;max-height:380px;width:auto;height:auto;
                 object-fit:contain;display:block;margin:0 auto 16px;">`,
                                [
                                    {
                                        text: 'èª¿ã¹ã‚‹',
                                        action: () => {
                                            // 2æšç›®ï¼šè£å´ã®ãƒ¢ãƒ¼ãƒ€ãƒ«
                                            showModal(
                                                'ã¬ã„ãã‚‹ã¿ã®è£å´',
                                                `<img src="${IMAGES.modals.dollBack}" 
                          style="max-width:380px;max-height:380px;width:auto;height:auto;
                                 object-fit:contain;display:block;margin:0 auto 16px;">`,
                                                [
                                                    { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                                ]
                                            );
                                        }
                                    },
                                    { text: 'é–‰ã˜ã‚‹', action: 'close' }
                                ]
                            );

                        }),
                        description: 'doll',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'doll', visible: () => true }
                    },
                    {
                        x: 54.5, y: 20.3, width: 36.9, height: 55.4,
                        onClick: clickWrap(function () {
                            updateMessage('ã‚¯ãƒªã‚¹ãƒã‚¹ã®é£¾ã‚Šç”¨ã®é´ä¸‹ã ');

                        }),
                        description: 'ã‚¯ãƒªã‚¹ãƒã‚¹é´ä¸‹',
                        zIndex: 2,
                        usable: () => true,

                    },
                    {
                        x: 41.8, y: 30.2, width: 15.4, height: 23.3,
                        onClick: clickWrap(function () {
                            if (gameState.main.flags.foundScissors) {
                                updateMessage('ã‚ã¼ã—ã„ã‚‚ã®ã¯ãªã„');

                            } else {
                                acquireItemOnce('foundScissors', 'scissors', 'ã¯ã•ã¿ã‚’è¦‹ã¤ã‘ãŸ', IMAGES.items.scissors, 'ã¯ã•ã¿ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');
                            }
                        }),
                        description: 'ã¯ã•ã¿',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundScissors,
                        item: { img: 'scissors', visible: () => !gameState.main.flags.foundScissors }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('fireplace');
                        }),
                        description: 'ç®±ã®ä¸­æˆ»ã‚‹',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },

            // outer
            outside: {
                name: 'å¤–ã®æ™¯è‰²',
                description: '',
                clickableAreas: [

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick: clickWrap(function () {
                            changeRoom('window');
                        }),
                        description: 'å¤–ã®æ™¯è‰²æˆ»ã‚‹',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            saint: {
                name: 'è¬ã®å ´æ‰€',
                description: '',
                clickableAreas: [
                    {
                        x: 34.9, y: 45.0, width: 33.5, height: 16.2,
                        onClick: clickWrap(function () {
                            if (gameState.selectedItem === 'hat') {

                                // å¸½å­ã‚’ç¥­å£‡ã«ç½®ãï¼šæ¶ˆè²»ï¼‹é¸æŠè§£é™¤
                                removeItem('hat');
                                updateMessage('æ€ªã—ã„å¸½å­ã‚’ç¥­å£‡ã«ãã£ã¨ç½®ã„ãŸâ€¦');

                                if (hasItem('cake')) gameState.endGood.flags.backgroundState++;

                                // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ ãƒ¼ãƒ“ãƒ¼ â†’ ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰ç”»é¢
                                const html = `
                        <div style="text-align:center">
                            <video src="${IMAGES.modals.mvEnding}"
                                   autoplay
                                   controls
                                   playsinline
                                   style="width:100%;max-width:640px;border-radius:10px;background:#000;">
                            </video>
                        </div>
                    `;

                                showModal(
                                    '',
                                    html,
                                    [
                                        {
                                            text: 'æ¬¡ã¸',
                                            action: () => {
                                                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã‹ã‚‰ã‚¨ãƒ³ãƒ‰ç”»é¢ã¸
                                                closeModal();
                                                changeRoom('endGood');
                                                screenFlash('white');
                                                playSE('se-shutter');
                                            }
                                        }
                                    ]
                                );

                            } else {
                                updateMessage('ç¥­å£‡ã®ã‚ˆã†ãªå ´æ‰€ã ');
                            }

                        }),
                        description: 'ç¥­å£‡',
                        zIndex: 5,
                        usable: () => true,
                    },
                    {
                        x: 8.6, y: 61.2, width: 17.8, height: 17.3,
                        onClick: clickWrap(function () {
                            updateMessage('ãã“ã«å¸½å­ã‚’ãƒã‚¤ã£ã¨ã—ã¡ã‚ƒãŠã†');

                        }),
                        description: 'ã‚¯ãƒã‚µãƒ³ã‚¿',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'bear', visible: () => true }
                    },
                ]
            },

            endGood: {
                name: 'ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰+',
                description: 'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ç„¡äº‹ã«è„±å‡ºã§ãã¾ã—ãŸã€‚æ‚ªã®æ ¹æºã‚‚å‡¦åˆ†ã§ãã¾ã—ãŸ',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            updateMessage('ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ç„¡äº‹ã«è„±å‡ºã§ãã¾ã—ãŸã€‚æ‚ªã®æ ¹æºã‚‚å‡¦åˆ†ã§ãã¾ã—ãŸ');
                            showEndingReport('endGood');
                        }),
                        description: 'ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰+',
                        usable: () => true,
                    },

                ]
            },
            endWorse: {
                name: 'ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰-',
                description: 'ã‚ãªãŸã¯ç„¡äº‹ã«å±±å°å±‹ã‹ã‚‰è„±å‡ºã§ãã¾ã—ãŸã€‚ã—ã‹ã—ã€æ‘ã®é‹å‘½ã¯â€¦',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            showEndingReport('endWorse');
                        }),
                        description: 'ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰-'
                    },
                ]
            },
            trueEnd: {
                name: 'ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰',
                description: 'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ç„¡äº‹ã«è„±å‡ºã§ãã¾ã—ãŸã€‚ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã¯ãŠæ°—ã«å…¥ã‚Šã®å¸½å­ã¨å…±ã«å¹¸ã›ã«éã”ã›ã‚‹ã“ã¨ã§ã—ã‚‡ã†',
                clickableAreas: [
                    {
                        x: 17.8, y: 40.9, width: 13.7, height: 10.9,
                        onClick: clickWrap(function () {
                            updateMessage('å¸½å­ã®é‚ªæ°—ã¯ã€ç¬‘é¡”ã®åŠ¹ç”¨ã§æ¶ˆãˆãŸã‚ˆã†ã ');
                        }),
                        description: 'å¸½å­',
                        zIndex: 5,
                        usable: () => true,

                    },
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick: clickWrap(function () {
                            updateMessage('ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ç„¡äº‹ã«è„±å‡ºã§ãã¾ã—ãŸã€‚ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã¯ãŠæ°—ã«å…¥ã‚Šã®å¸½å­ã¨å…±ã«å¹¸ã›ã«éã”ã›ã‚‹ã“ã¨ã§ã—ã‚‡ã†');
                            showEndingReport('trueEnd');
                        }),
                        description: 'ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰',
                        usable: () => true,
                    },

                ]
            },


        };

        const hintMessages = {
            main: {
                bear: [
                    'å‘¼ã‚“ã ï¼Ÿ',
                    'ã‚µãƒ³ã‚¿ã•ã‚“ã ã‚ˆ',
                ],
                bear2: [
                    'ä¸€ç·’ã«ãã“ã«è¡Œã“ã†ã‚ˆ',
                    'å¸½å­ã‚’ãƒã‚¤ã£ã¨ã—ã¦ã“ã‚ˆã†ï¼',
                ],
                bear3: [
                    'ã‚ã‚ã‚ãƒ¼',
                    'æ‘ãŒå¿ƒé…ã ã‚ˆ',
                ],
                blockMan: [
                    'ã‚„ã‚ã€ãŠã¯ã‚ˆã†ã€‚ã­ã‡ã€åƒ•ã®å¸½å­è¦‹ãªã‹ã£ãŸï¼Ÿ ',
                    'å¤§äº‹ãªã‚‚ã®ãªã‚“ã â€¦ ',
                    'å¸½å­ãŒãªã„ã¨åƒ•ã˜ã‚ƒãªã„æ„Ÿã˜ãŒã™ã‚‹ã‚“ã ã‚ˆã­ã‡ã€‚ãµãµã£ã€‚',
                    'é ­ãŒã‚€ãå‡ºã—ã§æ¥ãšã‹ã—ã„ã‚ˆ'
                ],
                blockMan2: [
                    'ãªã‚“ã ã„ï¼Ÿ ',
                    'ãƒ‰ã‚¢ã‚’é–‹ã‘ã¦ãã‚Œãªã„ã¨å¤–ã«å‡ºã‚‰ã‚Œãªã„ãªã‚â€¦',
                ],
                blockMan3: [
                    'å¤–ã«å‡ºãŸã„ãªã‚ ',
                ],
                blockMan4: [
                    'ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ã‚’é–‹ã‘ã¦ãã‚ŒãŸã‚“ã ã­ ',
                    'ä¹…ã—ã¶ã‚Šã«æ‘ã«è¡Œã£ã¦ã¿ã‚‹ã®ã‚‚è‰¯ã„ãªã‚ ',
                ],
                blockManHappy: [
                    'å¸½å­ã€è¦‹ã¤ã‘ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã† ',
                    'ä¹…ã—ã¶ã‚Šã«æ‘ã«è¡Œã£ã¦ã¿ãŸã„ãª',
                ]
            },


        };

        let buttonSeq = [];
        const BUTTON_TARGET_SEQ = ['R', 'R', 'R', 'L', 'L'];

        function checkButtonSeq() {
            if (gameState.main.flags.coinAppear) {
                playSE('se-switch');
                buttonSeq = [];
                return;
            }
            // å…¥åŠ›ãŒç›®æ¨™ä»¥ä¸Šã«é•·ããªã£ãŸã‚‰å‰ã‹ã‚‰å‰Šã‚‹
            if (buttonSeq.length > BUTTON_TARGET_SEQ.length) {
                buttonSeq.shift();
            }
            playSE('se-switch');
            console.log(buttonSeq);

            // ç¾åœ¨ã®å…¥åŠ›ãŒå®Œå…¨ä¸€è‡´ã—ãŸï¼Ÿ
            const ok = BUTTON_TARGET_SEQ.every((v, i) => buttonSeq[i] === v);

            if (ok) {
                // æˆåŠŸï¼
                playSE('se-coin');
                gameState.main.flags.coinAppear = true;

                showModal(
                    'ãƒ‰ã‚¢ã®ã»ã†ã§ç‰©éŸ³ãŒã—ãŸã‚ˆã†ã ',
                    '',
                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                );

                // ä¸€åº¦ç™ºç«ã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆæ¨å¥¨
                buttonSeq = [];
            }
        }



        // è¶³éŸ³ã§æ•°æ­©â†’ãƒ¯ãƒ¼ãƒ—æ¼”å‡ºâ†’ç›®çš„ã®éƒ¨å±‹ã¸
        function travelWithSteps(destRoom = 'saint') {
            const canvasEl = document.getElementById('gameCanvas');
            const overlay = document.getElementById('roomEffectOverlay');

            // è¶³éŸ³ã‚’é³´ã‚‰ã™
            try {
                const se = document.getElementById('se-ashioto');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ç”»é¢ã‚’é»’ãƒ•ã‚§ãƒ¼ãƒ‰ã«
            if (overlay) {
                overlay.style.background = '#000';  // é»’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
                overlay.style.opacity = 1;          // ã—ã£ã‹ã‚Šé»’
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;

                if (step >= 3) {
                    clearInterval(stepTimer);

                    if (overlay) {
                        changeRoom(destRoom);
                    }

                    setTimeout(() => {

                        // æ¼”å‡ºå¾Œã«ç¶ºéº—ã«æ¶ˆã™
                        if (overlay) {
                            // overlay.style.background = '';
                            overlay.style.opacity = 0;

                        }

                    }, 100);
                }
            }, 160);
        }

        function travelWithStepsTrueEnd() {
            const overlay = document.getElementById('roomEffectOverlay');
            let destRoom = hasItem('elixirModern') ? 'trueEndPlus' : 'trueEnd';

            // è¶³éŸ³ã‚’é³´ã‚‰ã™
            try {
                const se = document.getElementById('se-scene-change');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ç”»é¢ã‚’é»’ãƒ•ã‚§ãƒ¼ãƒ‰ã«
            if (overlay) {
                overlay.style.background = '#000';  // é»’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
                overlay.style.opacity = 1;          // ã—ã£ã‹ã‚Šé»’
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;


                if (step >= 3) {
                    clearInterval(stepTimer);

                    // é»’â†’ãƒ¯ãƒ¼ãƒ—å…‰ã¸åˆ‡æ›¿
                    if (overlay) {
                        overlay.classList.add('warp-active');
                        changeRoom(destRoom);
                        overlay.style.background = '';   // warp ã®ç™½ç™ºå…‰ã«æˆ»ã™
                    }

                    setTimeout(() => {


                        // æ¼”å‡ºå¾Œã«ç¶ºéº—ã«æ¶ˆã™
                        if (overlay) {
                            overlay.classList.remove('warp-active');
                            overlay.style.opacity = 0;
                        }

                    }, 900);
                }
            }, 260);
        }

        function quickBlackFade(duration = 300) {
            const fade = document.getElementById('roomEffectOverlay');
            if (!fade) return;

            // ã¾ãšä¸€ç¬ã§é»’ãã™ã‚‹
            fade.style.background = '#000';
            fade.style.opacity = '1';

            // duration ms å¾Œã«é€æ˜ã¸æˆ»ã™
            setTimeout(() => {
                fade.style.opacity = '0';
            }, duration);
        }

        function putSeal() {
            showModal(
                'ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã®éš™ã‚’ã¤ã„ã¦é¡”ã®ã‚·ãƒ¼ãƒ«ã‚’ãƒšã‚¿ã£ã¨è²¼ã£ãŸï¼',
                `<div class="blockman-hat-anim">
  <img src="${IMAGES.modals.blockManSeal}">
  <img src="${IMAGES.modals.blockManSealAfter}">
</div>`,
                //   <img src="${IMAGES.modals.blockManSeal}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
            );
            playSE('se-peta');
            removeItem('faceSeal');
            playSE('se-angel');
            gameState.flags.trueEndUnlocked = true;
            gameState.main.flags.blockManStatus = 5;
            renderCanvasRoom();

        }



        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            renderNavigation();
            changeRoom('door');
            updateMessage('æ°—ãŒä»˜ãã¨ã‚ãªãŸã¯å±±å°å±‹ã«ç«‹ã£ã¦ã„ã¾ã—ãŸ');

        }

        function findHitArea(x, y, clickableAreas, canvas) {
            // zIndexé™é †ã§
            const sorted = clickableAreas.slice().sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            for (const area of sorted) {
                // å¿…è¦ãªã‚‰usableåˆ¤å®šã‚‚ã“ã“ã§
                const usable = area.usable === undefined ? true :
                    (typeof area.usable === "function" ? area.usable() : area.usable);

                if (!usable) continue; // ä½¿ãˆãªã„ã‚¨ãƒªã‚¢ã¯åˆ¤å®šã—ãªã„
                const ax = area.x / 100 * canvas.width;
                const ay = area.y / 100 * canvas.height;
                const aw = area.width / 100 * canvas.width;
                const ah = area.height / 100 * canvas.height;
                if (x >= ax && x <= ax + aw && y >= ay && y <= ay + ah) {
                    return area; // æœ€åˆã«ãƒ’ãƒƒãƒˆã—ãŸã‚‚ã®ã ã‘è¿”ã™ï¼
                }
            }
            return null;
        }

        let hoveredAreaIndex = null;  // ä»Šhoverã—ã¦ã‚‹ã‚¨ãƒªã‚¢ï¼ˆãªã‘ã‚Œã°nullï¼‰
        canvas.addEventListener('mousemove', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);
            const idx = area ? room.clickableAreas.indexOf(area) : null;
            if (hoveredAreaIndex !== idx) {
                hoveredAreaIndex = idx;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('mouseout', function () {
            if (hoveredAreaIndex !== null) {
                hoveredAreaIndex = null;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('click', function (e) {

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // â˜…ä»Šã„ã‚‹éƒ¨å±‹ã®ã‚¨ãƒªã‚¢ã ã‘åˆ¤å®šï¼
            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);

            // if (area) {
            //     handleAreaClick(area.action, e);
            // }
            if (area) {
                if (typeof area.onClick === 'function') {
                    area.onClick(e);
                    playSE('se-click');
                } else if (area.action) {
                    handleAreaClick(area.action, e); // äº’æ›ã®ãŸã‚ã«æ®‹ã—ã¦ã‚‚OK
                }
            }



        });

        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];

            // èƒŒæ™¯ï¼‹ã‚¢ã‚¤ãƒ†ãƒ ï¼‹ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒªã‚¢ã‚’canvasã§å…¨éƒ¨å†æç”»
            renderCanvasRoom();
            const msg = (room.name && room.name.trim() !== "")
                ? `${room.name}ã§ã™ã€‚${room.description}`
                : room.description;
            if (roomId === 'trueEnd') {
                updateMessageHTML(msg);
            } else {
                updateMessage(msg);
            }

            // BGMåˆ‡æ›¿ã¯ãã®ã¾ã¾
            if (roomId === "trueEnd") {
                changeBGM("sounds/22/seiyanomachi_kuridasou.mp3");

            } else if (roomId === "endGood") {
                changeBGM("sounds/22/nice_xmas_eve.mp3");

            } else if (roomId === "endWorse") {
                changeBGM("sounds/22/jubaku.mp3");

            } else {
                if (gameState.main.flags.isNight) {
                    changeBGM("sounds/22/oyasumi_jikan.mp3");
                } else {
                    changeBGM("sounds/22/kimitohitotoki.mp3");
                }

            }

            // nav
            if (roomId === "trueEnd" || roomId === "end") {
                gameState.openRooms = [];
                // renderNavigation();
            }

            renderNavigation();

        }

        const END_IDS = new Set(['end', 'trueEnd', 'endWorse']);

        // ===== changeRoom ãƒ•ãƒƒã‚¯ï¼š=====
        const _changeRoom_custom = changeRoom;
        changeRoom = function (roomId) {
            _changeRoom_custom.apply(this, arguments);


            if (END_IDS.has(roomId)) {
                const elapsed = Math.round((Date.now() - ANA.start) / 1000);
                ANA.endTimes = ANA.endTimes || {};
                if (!ANA.endTimes[roomId]) ANA.endTimes[roomId] = elapsed;

                const isTrue = (roomId === 'trueEnd');
                ANA.send('ending_reached', {
                    ending_id: roomId,
                    is_true: isTrue,
                    elapsed_sec: elapsed,
                    hints: ANA.hintCount,

                });
                // setTimeout(() => showFeedbackModal(roomId), 1500);
            }
        };

        function renderCanvasRoom() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const roomId = gameState.currentRoom;
            const room = rooms[roomId];
            const bgImgSrc = getRoomBackgroundImage(roomId, gameState);

            ctx.clearRect(0, 0, canvas.width, canvas.height);


            // èƒŒæ™¯æç”»
            const bgImg = loadedImages[bgImgSrc];
            if (bgImg && bgImg.complete) {
                ctx.save();
                if (gameState.main?.flags?.isNight) {
                    ctx.filter = 'saturate(0.3) brightness(0.6)'; // èƒŒæ™¯ã¯ã¡ã‚‡ã„æš—ã‚
                } else {
                    ctx.filter = 'none';
                }
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
                ctx.restore();
            }

            // ã‚¢ã‚¤ãƒ†ãƒ æç”»ï¼ˆæœªå–å¾—ã®ã¿ï¼‰
            drawRoomItems(ctx, canvas, roomId);

            // â˜… ã“ã“ã‹ã‚‰é‡ãªã‚Šå„ªå…ˆã®hoveræ ç·šã‚’æç”»
            if (hoveredAreaIndex !== null && hoveredAreaIndex !== undefined) {
                // zIndexé™é †ã§ã‚½ãƒ¼ãƒˆ
                const sortedAreas = room.clickableAreas
                    .map((area, i) => ({ ...area, __idx: i }))
                    .filter(area => area.usable === undefined ? true :
                        (typeof area.usable === "function" ? area.usable() : area.usable)
                    )
                    .sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
                // hoveredAreaIndexã¨ä¸€è‡´ã™ã‚‹ã‚¨ãƒªã‚¢ã‚’zIndexé †ã§1ã¤ã ã‘æ æç”»
                const hoverArea = sortedAreas.find(area => area.__idx === hoveredAreaIndex);
                if (hoverArea) {
                    const ax = hoverArea.x / 100 * canvas.width;
                    const ay = hoverArea.y / 100 * canvas.height;
                    const aw = hoverArea.width / 100 * canvas.width;
                    const ah = hoverArea.height / 100 * canvas.height;
                    ctx.save();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(ax, ay, aw, ah);
                    ctx.restore();
                }
            }

            if (roomId === 'fireplace') {
                drawFireGlow(ctx, canvas);
            }

            if (DEV_MODE) {
                ctx.save();
                ctx.lineWidth = 2;


                room.clickableAreas.forEach(a => {

                    ctx.strokeStyle = 'rgba(255,0,0,0.8)';
                    ctx.fillStyle = 'rgba(255,0,0,0.35)';
                    ctx.font = '14px sans-serif';
                    const px = a.x / 100 * canvas.width;
                    const py = a.y / 100 * canvas.height;
                    const pw = a.width / 100 * canvas.width;
                    const ph = a.height / 100 * canvas.height;

                    // åŠé€æ˜ã®æ 
                    ctx.fillRect(px, py, pw, ph);
                    ctx.strokeRect(px, py, pw, ph);

                    // description è¡¨ç¤º
                    if (a.description) {
                        ctx.fillStyle = 'rgba(0,0,0,0.7)';
                        ctx.fillRect(px, py - 18, ctx.measureText(a.description).width + 8, 18);

                        ctx.fillStyle = 'white';
                        ctx.fillText(a.description, px + 4, py - 4);
                    }
                });

                ctx.restore();
            }

        }

        function drawRoomItems(ctx, canvas, roomId) {
            const room = rooms[roomId];
            room.clickableAreas.forEach(area => {
                if (area.item && area.item.visible && area.item.visible()) {
                    const key = (typeof area.item.img === 'function') ? area.item.img() : area.item.img;
                    const img = loadedImages[IMAGES.items[key]];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const alpha = area.alpha ? area.alpha : 1;
                        const px = area.x / 100 * canvas.width;
                        const py = area.y / 100 * canvas.height;
                        const w = area.width / 100 * canvas.width;
                        const h = area.height / 100 * canvas.height;
                        ctx.save();
                        ctx.globalAlpha = alpha;

                        // â˜… å¤œãƒ¢ãƒ¼ãƒ‰ãªã‚‰å½©åº¦ï¼‹æ˜ã‚‹ã•ã‚’è½ã¨ã™
                        if (gameState.main?.flags?.isNight) {
                            // å€¤ã¯å¥½ã¿ã§èª¿æ•´
                            ctx.filter = 'saturate(0.4) brightness(0.8)';
                        } else {
                            ctx.filter = 'none';
                        }

                        ctx.drawImage(img, px, py, w, h);
                        ctx.restore();
                    }
                }
            });
        }

        function drawFireGlow(ctx, canvas) {
            if (!gameState.main.flags.isNight) return;

            const cx = canvas.width * 0.5;
            const cy = canvas.height * 0.75;
            const r = canvas.width * 0.38; // å°‘ã—åºƒã‚ã«ã—ãŸ

            const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, r);

            // å†…å´ï¼šèµ¤ã«è¿‘ã„å¼·ã‚ã®æ¸©ã‹ã•
            g.addColorStop(0.00, 'rgba(255,140, 60, 0.65)'); // æ¿ƒã„æ©™
            g.addColorStop(0.20, 'rgba(255,160, 80, 0.55)'); // å°‘ã—æŸ”ã‚‰ã‹ã„æ©™

            // ä¸­é–“ï¼šæš–ç‚‰ã‚‰ã—ã„ã‚ªãƒ¬ãƒ³ã‚¸ã®â€œã½ã‚ã£â€
            g.addColorStop(0.55, 'rgba(255,180,100, 0.35)');

            // å¤–å´ï¼šå£ã«åå°„ã—ã¦ã‚‹ãã‚‰ã„ã®è–„ã„å…‰
            g.addColorStop(1.00, 'rgba(255,200,120, 0.05)');

            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        }




        function getRoomBackgroundImage(roomId, gameState) {
            let state = gameState[roomId]?.flags?.backgroundState || 0;
            let imgList = IMAGES.rooms[roomId];
            if (Array.isArray(imgList)) {
                return imgList[state] || imgList[0];
            } else {
                return imgList;
            }
        }

        // å°ç‰©ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function pointInRect(x, y, r) {
            return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;
        }

        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
            ctx.beginPath();
            ctx.moveTo(x + r.tl, y);
            ctx.lineTo(x + w - r.tr, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
            ctx.lineTo(x + w, y + h - r.br);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
            ctx.lineTo(x + r.bl, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
            ctx.lineTo(x, y + r.tl);
            ctx.quadraticCurveTo(x, y, x + r.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¬ã‚¤ãƒ¤ã‚’ç”¨æ„
        (function ensureFlashLayer() {
            if (!document.getElementById('fxFlash')) {
                const d = document.createElement('div');
                d.id = 'fxFlash';
                document.body.appendChild(d);
            }
        })();

        // ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆtype: 'white' | 'red'ï¼‰
        function screenFlash(type = 'white', durMs = 180) {
            const f = document.getElementById('fxFlash'); if (!f) return;
            f.style.animation = 'none'; // é€£æ‰“å¯¾ç­–
            // å¼·åˆ¶reflowã§ã‚¢ãƒ‹ãƒ¡å†é©ç”¨
            // eslint-disable-next-line no-unused-expressions
            f.offsetHeight;
            const key = type === 'red' ? 'flashRed' : 'flashWhite';
            f.style.animation = `${key} ${durMs}ms ease`;
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’æ¥µå°ã‚·ã‚§ã‚¤ã‚¯
            document.documentElement.classList.add('fx-shake');
            setTimeout(() => document.documentElement.classList.remove('fx-shake'), 120);
        }


        function toggleNight() {
            if (gameState.main.flags.blockManStatus == 4) {
                updateMessage('ã“ã‚“ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹å ´åˆã§ã¯ãªã„');
                return;
            }

            playSE('se-tictac');

            gameState.main.flags.isNight = !gameState.main.flags.isNight;
            const msg = gameState.main.flags.isNight ? 'å¤œ' : 'æ˜¼';
            gameState.outside.flags.backgroundState = gameState.main.flags.isNight ? 1 : 0;

            updateMessage(`${msg}ã«ãªã£ãŸ`);
            quickBlackFade();
            setTimeout(() => {
                if (gameState.main.flags.isNight) {
                    changeBGM("sounds/22/oyasumi_jikan.mp3");
                } else {
                    changeBGM("sounds/22/kimitohitotoki.mp3");
                }
                renderCanvasRoom();
            }, 300);

        }

        function acquireItemOnce(flagKey, itemId, title, imgSrc, msg) {
            const f = gameState.main.flags;
            if (f[flagKey]) {
                if (itemId == 'glass') {
                    updateMessage('ã‚°ãƒ©ã‚¹ãŒæ²¢å±±ã‚ã‚‹');
                } else {
                    updateMessage('ã‚‚ã†ä½•ã‚‚ãªã„');
                }

                return;
            }
            f[flagKey] = true;
            addItem(itemId);
            renderCanvasRoom();

            showModal(
                title,
                `<img src="${imgSrc}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
            );
            updateMessage(msg);
        }

        function clickWrap(fn) {
            return function (...args) {
                // ä¸­èº«ã®ã‚½ãƒ¼ã‚¹ã‚’è¦‹ã¦ã€Œç§»å‹•ç³»ã‹ã©ã†ã‹ã€ã‚’ã–ã£ãã‚Šåˆ¤å®š
                const src = fn.toString();
                const isMoveAction =
                    src.includes('changeRoom(') || src.includes('travelWithSteps(') || src.includes('toggleNight(')
                    || src.includes('blockManHat1') || src.includes('blockManScissors' || src.includes('blockMan3') || src.includes('blockManHappy'));

                if (
                    gameState.main.flags.isNight &&
                    gameState.currentRoom !== 'fireplace' &&
                    !isMoveAction // ç§»å‹•ä»¥å¤–ã ã‘ãƒ–ãƒ­ãƒƒã‚¯
                ) {
                    updateMessage('æš—ãã¦ã‚ˆãè¦‹ãˆãªã„');
                } else {
                    fn.apply(this, args);
                }

                // ã‚¢ã‚¤ãƒ†ãƒ é¸æŠè§£é™¤ã¯ä»Šã¾ã§é€šã‚Š
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            };
        }


        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å â†’ å®Ÿè¡Œé–¢æ•°
        const ACTION_HANDLERS = {
            // --- ç§»å‹•ç³» ---
            examine_start_door_left() {
                changeRoom('startRight');
            },

        };

        // ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleAreaClick(action, event) {
            const handler = ACTION_HANDLERS[action];
            playSE('se-click');

            // area.onClick æ–¹å¼ï¼ˆå°†æ¥ã®ãŸã‚ï¼‰
            if (typeof action === 'function') {
                action(event);
                return;
            }

            // actionåï¼ˆå¾“æ¥ã®æ–¹å¼ï¼‰ã«ã‚‚å¯¾å¿œ
            const fn = ACTION_HANDLERS[action];
            if (fn) {
                fn(event);
                return;
            }
            console.warn('æœªå®šç¾©ã®action:', action);
        }


        // ã‚¯ãƒªã‚¢ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
        function showEndingReport(endingId = 'end') {
            const elapsedSec = Math.round((Date.now() - (ANA.start || Date.now())) / 1000);
            const m = Math.floor(elapsedSec / 60);
            const s = elapsedSec % 60;
            const timeStr = `${m}åˆ†${s.toString().padStart(2, '0')}ç§’`;

            // ä»Šä½œç”¨ã‚¨ãƒ³ãƒ‰æƒ…å ±
            const ENDING_INFO = {
                trueEnd: {
                    title: "ğŸ„ TRUE END",
                    label: "TRUE END",
                    desc: "ãŠæ°—ã«å…¥ã‚Šã®å¸½å­ã‚’ã‹ã¶ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã¯ã€å¹¸ã›ã«éã”ã›ã‚‹ã“ã¨ã§ã—ã‚‡ã†ã€‚"
                },
                endGood: {
                    title: "ğŸ”” NORMAL END +",
                    label: "NORMAL END +",
                    desc: "å‘ªã‚ã‚ŒãŸå¸½å­ã‚’æµ„åŒ–ã—ã€æ‘ã«ã‚‚é™ã‹ãªã‚¯ãƒªã‚¹ãƒã‚¹ãŒæˆ»ã£ã¦ãã¾ã—ãŸã€‚"
                },
                endWorse: {
                    title: "ğŸ’€ NORMAL END -",
                    label: "NORMAL END -",
                    desc: "ã‚ãªãŸã¯è„±å‡ºã«æˆåŠŸã—ã¾ã—ãŸãŒã€æ‘ã®é‹å‘½ã¯â€¦çŸ¥ã‚‰ãªã„ã»ã†ãŒã‚ˆã‹ã£ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"
                },
            };

            const info = ENDING_INFO[endingId] || ENDING_INFO.end;

            // ã‚¨ãƒ³ãƒ‰åˆ¥ã²ã¨ã“ã¨
            let secretText = "";
            switch (endingId) {
                case "trueEnd":
                    secretText = "ğŸ ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã¯ã—ã‚ã‚ã›ã«ãªã‚Šã¾ã—ãŸã€‚";
                    break;
                case "end":
                    secretText = "â›„ å¸½å­ã¯æµ„åŒ–ã•ã‚Œã€ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã«ã‚‚é ­ã‚’å®ˆã‚‹é«ªã®æ¯›ãŒç”ŸãˆãŸã‚ˆã†ã ã€‚";
                    break;
                case "endWorse":
                    secretText = "âš ï¸ ã‚ã®å¸½å­ã‚’ã‹ã¶ã›ã¦è‰¯ã‹ã£ãŸã®ã ã‚ã†ã‹ã€‚";
                    break;
                default:
                    secretText = "";
            }

            // GAé€ä¿¡
            ANA.once('ending', endingId, {
                ending: endingId,
                time_sec: elapsedSec,
            });

            const html = `
        <div style="max-width:520px; text-align:center;">
            <h2 style="margin-top:0;">${info.title}</h2>
            <p style="margin:6px 0 12px 0; font-weight:bold;">${info.desc}</p>
            <p style="margin:4px 0;">ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼š<b>${timeStr}</b></p>
            <p style="margin:4px 0;">ãƒ’ãƒ³ãƒˆåˆ©ç”¨ï¼š<b>${ANA.hintCount || 0} å›</b></p>
            ${secretText ? `<p style="margin:12px 0; font-size:.9em; opacity:.85;">${secretText}</p>` : ""}
            
            
        </div>
    `;

            showModal("ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°", html, [
                {
                    text: "ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ç­”ãˆã‚‹",
                    action: () => openFeedbackForm(endingId),
                },
                {
                    text: "é–‰ã˜ã‚‹",
                    action: () => {
                        closeModal();
                    },
                },
            ]);
        }

        // ã‚¯ãƒªã‚¢ãƒ­ã‚°ç”Ÿæˆï¼ˆæ—¢å­˜ã®ãŒã‚ã‚Œã°ãã®ã¾ã¾æµç”¨ã§OKï¼‰
        function copyClearLog(label, timeStr) {
            const text =
                `ã€å±±å°å±‹ã‹ã‚‰ã®è„±å‡ºã€${label} ã‚¯ãƒªã‚¢\n` +
                `ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼š${timeStr}\n` +
                `ãƒ’ãƒ³ãƒˆåˆ©ç”¨ï¼š${ANA.hintCount || 0}å›\n` +
                `#è„±å‡ºã‚²ãƒ¼ãƒ  #å±±å°å±‹ã‹ã‚‰ã®è„±å‡º`;
            navigator.clipboard.writeText(text).then(() => {
                alert("ã‚¯ãƒªã‚¢ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
            }).catch(() => {
                alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦");
            });
        }

        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
        function openFeedbackForm(endingId) {
            const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLScj6v4_pN42Tw1ITFi33ddmLt7hQm4X69B87b9vWEnUBw3r7Q/viewform";

            const endingLabel = ({
                trueEnd: "ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰",
                endGood: "ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰+",
                endWorse: "ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰-",
            })[endingId] || "ã‚¨ãƒ³ãƒ‰";

            const params = new URLSearchParams({
                "entry.666725843": endingLabel,                  // ã©ã®ã‚¨ãƒ³ãƒ‰ã‹
            });

            window.open(`${FEEDBACK_URL}?${params.toString()}`, "_blank");
        }



        function talkToHintCharacter(roomId, charId) {
            // flagså–å¾—
            let flags = gameState[roomId].flags;
            // ã¾ã ã‚«ã‚¦ãƒ³ãƒˆç„¡ã‘ã‚Œã°åˆæœŸåŒ–
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
            flags.talkTo[charId]++;

            // ã‚»ãƒªãƒ•ãƒªã‚¹ãƒˆå–å¾—
            const messages = hintMessages[roomId][charId];
            if (roomId == 'main' && charId == 'bear' && flags.talkTo[charId] == 3) {
                gameState.main.flags.canRemovePoster = true;
            }
            // ç¯„å›²å¤–ãªã‚‰æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const idx = (flags.talkTo[charId] - 1) % messages.length;
            console.log(flags.talkTo[charId]);

            // è¡¨ç¤º
            updateMessage(messages[idx]);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ãƒ‰ã‚¢æ¨ª æœ¨ç®±ã‚«ãƒ©ãƒ¼ ãƒ‘ã‚ºãƒ«
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // 0: ç™½ / 1: èµ¤ / 2: é’ / 3: é»„
        let doorBoxColorState = Array(9).fill(0);

        /** çŠ¶æ…‹ â†’ è‰²ã‚³ãƒ¼ãƒ‰ */
        function getDoorBoxColor(value) {
            switch (value) {
                case 1: return '#e53e3e';   // èµ¤
                case 2: return '#3182ce';   // é’
                case 3: return '#ecc94b';   // é»„
                default: return '#f7fafc';  // ç™½
            }
        }

        /** æœ¨ç®±ãƒ‘ã‚ºãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º */
        function showDoorBoxColorPuzzle() {
            // åˆå›ã¯å…¨éƒ¨ç™½ã§OKã€‚ã‚»ãƒ¼ãƒ–å¾Œã®å†æŒ‘æˆ¦ã‚‚è€ƒãˆã‚‹ãªã‚‰ã“ã“ã§çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚OKã€‚
            // doorBoxColorState = Array(9).fill(0);

            const modalContent = `
        <div style="
            padding:14px;
            border-radius:12px;
            background: radial-gradient(circle at 30% 20%, #f8e7b0, #9c7a2f);
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.4),
                0 4px 10px rgba(0,0,0,0.6);
            color:#2b1908;
            text-align:center;
            max-width:320px;
            margin:0 auto;
        ">
            <h2 style="margin:4px 0 10px 0;font-size:1.1em;">æœ¨ç®±ã®ãƒ­ãƒƒã‚¯</h2>
            

            <div id="doorBoxGrid"
                 style="
                    display:grid;
                    grid-template-columns:repeat(3, 1fr);
                    gap:10px;
                    justify-items:center;
                    margin:10px 0 12px 0;
                 ">
                ${doorBoxColorState.map((v, i) => `
                    <div id="doorBoxCircle${i}"
                        onclick="cycleDoorBoxColor(${i})"
                        style="
                            width:52px;
                            height:52px;
                            border-radius:50%;
                            background:${getDoorBoxColor(v)};
                            border:2px solid rgba(0,0,0,0.25);
                            box-shadow:
                                0 3px 6px rgba(0,0,0,0.45),
                                inset 0 2px 4px rgba(255,255,255,0.7);
                            cursor:pointer;
                        ">
                    </div>
                `).join('')}
            </div>

            <p id="doorBoxMsg"
               style="min-height:1.4em;font-size:0.85em;margin:0 0 8px 0;"></p>

            <div style="margin-top:6px;">
                <button onclick="checkDoorBoxColorPuzzle()" class="text-btn">OK</button>
                <button onclick="closeModal()" class="text-btn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    `;

            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            mc.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        /** å††ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãï¼šç™½â†’èµ¤â†’é’â†’é»„â†’ç™½â€¦ */
        function cycleDoorBoxColor(index) {
            doorBoxColorState[index] = (doorBoxColorState[index] + 1) % 4;

            const el = document.getElementById('doorBoxCircle' + index);
            if (!el) return;

            el.style.background = getDoorBoxColor(doorBoxColorState[index]);
        }

        /** æ­£è§£åˆ¤å®šï¼†é–‹éŒ  */
        function checkDoorBoxColorPuzzle() {
            // 0:ç™½ 1:èµ¤ 2:é’ 3:é»„
            // æ¨¡æ§˜:
            // é’, é»„, èµ¤
            // é»„, èµ¤, é’
            // é»„, èµ¤, é’
            const correct = [
                2, 3, 1,
                3, 1, 2,
                3, 1, 2
            ];

            const ok = correct.every((v, i) => doorBoxColorState[i] === v);
            const msg = document.getElementById('doorBoxMsg');

            if (!ok) {
                if (msg) msg.textContent = 'â€¦ä½•ã‹é•ã†ã‚ˆã†ã ã€‚';
                if (typeof playSE === 'function') playSE('se-error');
                return;
            }

            // æ­£è§£æ™‚
            gameState.main.flags.unlockBox = true;  // â˜…æœ¨ç®±ãƒ•ãƒ©ã‚°ON
            if (typeof markProgress === 'function') {
                markProgress('door_box_unlock_22');
            }
            if (typeof playSE === 'function') playSE('se-gacha');

            closeModal();
            updateMessage('æœ¨ç®±ã®ãƒ­ãƒƒã‚¯ãŒå¤–ã‚ŒãŸ');
            renderCanvasRoom();
        }


        // å¤§ãã„ç®±ãƒ‘ã‚ºãƒ«ã‚’è¡¨ç¤º
        function showBoxBigPuzzle() {
            const modalContent = `
                <h3>ğŸ“…é’ã„ç®±ã®ãƒ­ãƒƒã‚¯éƒ¨åˆ†ã </h3>
                <input type="text" class="puzzle-input" id="boxBigInput" placeholder="æ•°å­—">
                <br>
                <button onclick="checkBoxBigPuzzle()">OK</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // å¤§ãã„ç®±ãƒ‘ã‚ºãƒ«ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkBoxBigPuzzle() {
            const v = document.getElementById('boxBigInput').value.trim();
            // å…¨è§’å¯¾ç­–
            const z2h = s => s.replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === '1231') {
                closeModal();
                gameState.main.flags.unlockBoxBig = true;

                markProgress('boxbig_unlock_22');

                showModal(
                    'é’ã„ç®±ã®ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸ',
                    '',
                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                );
                playSE('se-clear');
                renderCanvasRoom();

            } else {
                playSE('se-error');
                updateMessage('ã¡ãŒã†ã‚ˆã†ã ');
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ä¸­ãã‚‰ã„ã®ç®±ãƒ‘ã‚ºãƒ«ï¼ˆé’èµ¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼‰
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        let middleBoxGreenCount = 0;  // é’ä¸¸ã®æ•° 0ã€œ9
        let middleBoxLightBlueCount = 0;  // èµ¤ä¸¸ã®æ•° 0ã€œ9

        function resetMiddleBoxCounts() {
            middleBoxGreenCount = 0;
            middleBoxLightBlueCount = 0;
        }

        function renderMiddleBoxCircles() {
            const blueArea = document.getElementById('middleBoxGreenArea');
            const redArea = document.getElementById('middleBoxLightBlueArea');
            if (!blueArea || !redArea) return;

            const buildCircles = (color, count) => {
                if (count <= 0) {
                    // 0å€‹ã®ã¨ãã‚‚é«˜ã•ã ã‘ã¯ç¢ºä¿
                    return '<div style="height:24px;"></div>';
                }
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `
                <div style="
                    width:20px;
                    height:20px;
                    border-radius:50%;
                    background:${color};
                    margin:2px;
                    box-shadow:0 1px 3px rgba(0,0,0,0.4);
                "></div>
            `;
                }
                return html;
            };

            blueArea.innerHTML = buildCircles('#00bf63', middleBoxGreenCount); // ç·‘
            redArea.innerHTML = buildCircles('#5ce1e6', middleBoxLightBlueCount);  // æ°´è‰²
        }

        function incrementMiddleBoxCount(color) {
            if (color === 'green') {
                middleBoxGreenCount = (middleBoxGreenCount + 1) % 10;  // 0ã€œ9ã§ãƒ«ãƒ¼ãƒ—
            } else if (color === 'lightblue') {
                middleBoxLightBlueCount = (middleBoxLightBlueCount + 1) % 10;
            }

            renderMiddleBoxCircles();

            if (typeof playSE === 'function') {
                playSE('se-click');
            }
        }

        function showMiddleBoxPuzzle() {
            // ã™ã§ã«è§£é™¤æ¸ˆã¿ãªã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘
            if (gameState.main.flags.unlockBoxMiddle) {
                updateMessage('ä¸­ãã‚‰ã„ã®ç®±ã®ãƒ­ãƒƒã‚¯ã¯ã™ã§ã«å¤–ã‚Œã¦ã„ã‚‹ã€‚');
                return;
            }

            resetMiddleBoxCounts();

            const modalContent = `
        <div style="
            padding:14px;
            border-radius:12px;
            background: radial-gradient(circle at 30% 20%, #fdfdfd, #e2ddd5);
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.15),
                0 4px 10px rgba(0,0,0,0.6);
            color:#2b1908;
            text-align:center;
            max-width:340px;
            margin:0 auto;
        ">
            <h2 style="margin:4px 0 10px 0;font-size:1.1em;">èµ¤ã„ç®±ã®ãƒ­ãƒƒã‚¯</h2>

            <div style="
                background:#ffffff;
                border-radius:10px;
                border:2px solid #b5a58a;
                padding:10px;
                margin:8px 0 10px 0;
                display:flex;
                justify-content:space-between;
                gap:8px;
            ">
                <div style="flex:1;text-align:center;border-right:1px solid #ddd;padding-right:4px;">
                    <div style="font-size:0.8em;margin-bottom:4px;"></div>
                    <div id="middleBoxGreenArea"
                         style="display:flex;flex-wrap:wrap;justify-content:center;min-height:24px;">
                    </div>
                </div>
                <div style="flex:1;text-align:center;padding-left:4px;">
                    <div style="font-size:0.8em;margin-bottom:4px;"></div>
                    <div id="middleBoxLightBlueArea"
                         style="display:flex;flex-wrap:wrap;justify-content:center;min-height:24px;">
                    </div>
                </div>
            </div>

            <div style="
                display:flex;
                justify-content:center;
                gap:12px;
                margin:6px 0 10px 0;
            ">
                <button onclick="incrementMiddleBoxCount('green')" style="
                    width:70px;
                    height:40px;
                    background:#00bf63;
                    border:none;
                    border-radius:6px;
                    color:#fff;
                    font-weight:bold;
                    box-shadow:0 2px 6px rgba(0,0,0,0.4);
                    cursor:pointer;
                ">
                    ç·‘
                </button>
                <button onclick="incrementMiddleBoxCount('lightblue')" style="
                    width:70px;
                    height:40px;
                    background:#5ce1e6;
                    border:none;
                    border-radius:6px;
                    color:#fff;
                    font-weight:bold;
                    box-shadow:0 2px 6px rgba(0,0,0,0.4);
                    cursor:pointer;
                ">
                    æ°´è‰²
                </button>
            </div>

            <p id="middleBoxMsg"
               style="min-height:1.4em;font-size:0.85em;margin:0 0 8px 0;"></p>

            <div style="margin-top:6px;">
                <button onclick="checkMiddleBoxPuzzle()" class="text-btn">OK</button>
                <button onclick="closeModal()" class="text-btn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    `;

            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            mc.innerHTML = modalContent;
            modal.style.display = 'flex';

            // åˆæœŸæç”»
            renderMiddleBoxCircles();
        }

        function checkMiddleBoxPuzzle() {
            const msg = document.getElementById('middleBoxMsg');

            const ok = (middleBoxGreenCount === 7 && middleBoxLightBlueCount === 4);

            if (!ok) {
                if (msg) msg.textContent = 'â€¦ä½•ã‹é•ã†ã‚ˆã†ã ã€‚';
                if (typeof playSE === 'function') playSE('se-error');
                return;
            }

            // æ­£è§£æ™‚ï¼šä¸­ãã‚‰ã„ã®ç®±ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
            gameState.main.flags.unlockBoxMiddle = true;  // â˜…ã“ã“ã§é–‹éŒ ãƒ•ãƒ©ã‚°ON

            if (typeof markProgress === 'function') {
                markProgress('box_middle_unlock_22');
            }
            if (typeof playSE === 'function') playSE('se-gacha');

            closeModal();
            updateMessage('ä¸­ãã‚‰ã„ã®ç®±ã®ãƒ­ãƒƒã‚¯ãŒå¤–ã‚ŒãŸ');
            if (typeof renderCanvasRoom === 'function') {
                renderCanvasRoom();
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // å°ã•ã„ç®±ãƒ‘ã‚ºãƒ«ï¼ˆã‚³ãƒ³ãƒ‘ã‚¹ï¼šNâ†’Eâ†’Wâ†’Sï¼‰
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // æŠ¼ã•ã‚ŒãŸæ–¹è§’ã®å±¥æ­´
        let smallBoxDirSequence = [];

        function resetSmallBoxDirections() {
            smallBoxDirSequence = [];
            renderSmallBoxDirections();
        }

        function renderSmallBoxDirections() {
            const el = document.getElementById('smallBoxDirDisplay');
            if (!el) return;

            if (smallBoxDirSequence.length === 0) {
                el.textContent = 'ï¼ˆæ–¹è§’ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å…¥åŠ›ï¼‰';
            } else {
                el.textContent = smallBoxDirSequence
                    .slice(-8)
                    .map(ch => ch.toUpperCase())
                    .join(' ');
            }
        }

        function pushSmallBoxDirection(dir) {
            // dir: 'n' | 'e' | 'w' | 's'
            smallBoxDirSequence.push(dir);
            if (smallBoxDirSequence.length > 16) {
                smallBoxDirSequence = smallBoxDirSequence.slice(-16);
            }

            renderSmallBoxDirections();

            if (typeof playSE === 'function') {
                playSE('se-click');
            }
        }

        function showSmallBoxPuzzle() {
            // ã™ã§ã«è§£é™¤æ¸ˆã¿ãªã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘
            if (gameState.main.flags.unlockBoxSmall) {
                updateMessage('å°ã•ã„ç®±ã®ãƒ­ãƒƒã‚¯ã¯ã™ã§ã«å¤–ã‚Œã¦ã„ã‚‹ã€‚');
                return;
            }

            resetSmallBoxDirections();

            const modalContent = `
        <div style="
            padding:14px;
            border-radius:12px;
            background: radial-gradient(circle at 30% 20%, #fdfdfd, #e2ddd5);
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.15),
                0 4px 10px rgba(0,0,0,0.6);
            color:#2b1908;
            text-align:center;
            max-width:340px;
            margin:0 auto;
        ">
            <h2 style="margin:4px 0 10px 0;font-size:1.1em;">å°ã•ã„ç®±ã®ãƒ­ãƒƒã‚¯</h2>
            <h3></h3>

            <div style="
                background:#ffffff;
                border-radius:10px;
                border:2px solid #b5a58a;
                padding:8px;
                margin:6px 0 8px 0;
            ">
            N<br>â†‘
             <!--   <img src="${IMAGES.modals.compass}"
                     style="max-width:100%;height:auto;display:block;margin:0 auto;">-->
            </div> 

            <!-- ãã®ä¸‹ã«åå­—å‹ãƒœã‚¿ãƒ³ -->
            <div style="
                margin:6px 0 10px 0;
                display:flex;
                justify-content:center;
            ">
                <div style="
                    position:relative;
                    width:160px;
                    height:160px;
                ">
                    <!-- ä¸­å¤®ã®åŸºæº–ï¼ˆé£¾ã‚Šï¼‰ -->
                    <div style="
                        position:absolute;
                        left:50%;
                        top:50%;
                        transform:translate(-50%,-50%);
                        width:48px;
                        height:48px;
                        border-radius:50%;
                        background:radial-gradient(circle, #fdf7e8, #cab79a);
                        box-shadow:
                            inset 0 1px 2px rgba(255,255,255,0.8),
                            0 2px 4px rgba(0,0,0,0.45);
                        opacity:0.9;
                    "></div>

                    <!-- åŒ—ãƒœã‚¿ãƒ³ -->
                    <button onclick="pushSmallBoxDirection('n')" style="
                        position:absolute;
                        left:44%;
                        top:10px;
                        transform:translateX(-50%);
                        width:46px;
                        height:34px;
                        border:none;
                        border-radius:10px;
                        background:linear-gradient(#fffdf7,#ded4c4);
                        box-shadow:0 2px 4px rgba(0,0,0,0.45);
                        cursor:pointer;
                    "></button>

                    <!-- æ±ãƒœã‚¿ãƒ³ -->
                    <button onclick="pushSmallBoxDirection('e')" style="
                        position:absolute;
                        right:0px;
                        top:70px;
                        transform:translateY(-50%);
                        width:46px;
                        height:34px;
                        border:none;
                        border-radius:10px;
                        background:linear-gradient(#fffdf7,#ded4c4);
                        box-shadow:0 2px 4px rgba(0,0,0,0.45);
                        cursor:pointer;
                    "></button>

                    <!-- å—ãƒœã‚¿ãƒ³ -->
                    <button onclick="pushSmallBoxDirection('s')" style="
                        position:absolute;
                        left:44%;
                        bottom:10px;
                        transform:translateX(-50%);
                        width:46px;
                        height:34px;
                        border:none;
                        border-radius:10px;
                        background:linear-gradient(#fffdf7,#ded4c4);
                        box-shadow:0 2px 4px rgba(0,0,0,0.45);
                        cursor:pointer;
                    "></button>

                    <!-- è¥¿ãƒœã‚¿ãƒ³ -->
                    <button onclick="pushSmallBoxDirection('w')" style="
                        position:absolute;
                        left:0px;
                        top:70px;
                        transform:translateY(-50%);
                        width:46px;
                        height:34px;
                        border:none;
                        border-radius:10px;
                        background:linear-gradient(#fffdf7,#ded4c4);
                        box-shadow:0 2px 4px rgba(0,0,0,0.45);
                        cursor:pointer;
                    "></button>
                </div>
            </div>

            <!-- å…¥åŠ›å±¥æ­´ -->
            <!-- <div id="smallBoxDirDisplay"
                  style="min-height:1.4em;font-size:0.9em;margin:0 0 6px 0;"></div> -->

            <p id="smallBoxMsg"
               style="min-height:1.4em;font-size:0.85em;margin:0 0 8px 0;">&nbsp;</p>

            <div style="margin-top:6px;">
                <button onclick="checkSmallBoxPuzzle()" class="text-btn">OK</button>
                <button onclick="closeModal()" class="text-btn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    `;

            const mc = document.getElementById('modalContent');
            const modal = document.getElementById('modal');
            if (!mc || !modal) return;

            mc.innerHTML = modalContent;
            modal.style.display = 'flex';

            renderSmallBoxDirections();
        }

        function checkSmallBoxPuzzle() {
            const msg = document.getElementById('smallBoxMsg');

            // ç›´è¿‘4å…¥åŠ›ã ã‘è¦‹ã‚‹
            const seq = smallBoxDirSequence.slice(-8).join('');
            const ok = (seq === 'swennews'); // nâ†’eâ†’wâ†’s
            console.log(seq);

            if (!ok) {
                if (msg) msg.textContent = 'â€¦ä½•ã‹é•ã†ã‚ˆã†ã ã€‚';
                if (typeof playSE === 'function') playSE('se-error');
                return;
            }

            // æ­£è§£
            gameState.main.flags.unlockBoxSmall = true;

            if (typeof markProgress === 'function') {
                markProgress('box_small_unlock_22');
            }
            if (typeof playSE === 'function') playSE('se-gacha');

            closeModal();
            updateMessage('å°ã•ã„ç®±ã®ãƒ­ãƒƒã‚¯ãŒå¤–ã‚ŒãŸ');
            if (typeof renderCanvasRoom === 'function') {
                renderCanvasRoom();
            }
        }

        function showClockPuzzle() {
            if (!gameState.main.flags.bearAppear) {
                updateMessage('ã¾ã åå¿œã—ãªã„ã‚ˆã†ã ');
                return;
            }
            // æ—¢ã«è§£é™¤æ¸ˆã¿ãªã‚‰ãã®æ—¨ã ã‘
            if (gameState.main.flags.unlockClock) {
                return;
            }

            const content = `
            <div><img src="${IMAGES.modals.clock}"
                     style="max-width:380px;height:auto;display:block;margin:0 auto;"></div>
        <div style="
            display:flex;
            justify-content:center;
            align-items:center;
            gap:8px;
            margin:12px 0;
        ">
        
            <input id="hourInput"
                type="text"
                inputmode="numeric"
                maxlength="2"
                style="width:40px;padding:4px;text-align:center;font-size:1.2rem;">
            <span style="font-size:1.2rem;">:</span>
            <input id="minuteInput"
                type="text"
                inputmode="numeric"
                maxlength="2"
                style="width:40px;padding:4px;text-align:center;font-size:1.2rem;">
                <span style="font-size:1.2rem;">:</span>
            <input id="secondInput"
                type="text"
                inputmode="numeric"
                maxlength="2"
                style="width:40px;padding:4px;text-align:center;font-size:1.2rem;">
        </div>
    `;

            showModal(
                'æ™‚è¨ˆ',
                content,
                [
                    { text: 'OK', action: checkClockInput },
                    { text: 'é–‰ã˜ã‚‹', action: 'close' }
                ]
            );
        }

        function checkClockInput() {
            const hourEl = document.getElementById('hourInput');
            const minEl = document.getElementById('minuteInput');
            const secEl = document.getElementById('secondInput');
            if (!hourEl || !minEl || !secEl) {
                // ä½•ã‹ãŠã‹ã—ã‹ã£ãŸã‚‰ã¨ã‚Šã‚ãˆãšé–‰ã˜ã‚‹
                closeModal();
                return;
            }

            const hour = hourEl.value.trim();
            const minute = minEl.value.trim();
            const second = secEl.value.trim();

            const isOk = (hour === '12' && minute === '23' && second === '23');

            if (!isOk) {
                closeModal();
                showModal(
                    '',
                    'â€¦é•ã†ã‚ˆã†ã ã€‚',
                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                );
                if (typeof playSE === 'function') playSE('se-error');
                return;
            }

            gameState.main.flags.unlockClock = true;

            if (typeof playSE === 'function') playSE('se-clear');

            closeModal();
            showModal(
                'ãƒ­ãƒƒã‚¯ãŒå¤–ã‚ŒãŸ',
                'ã‚«ãƒãƒªã¨éŸ³ãŒã—ãŸã€‚',
                [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
            );
            updateMessage('ãƒ­ãƒƒã‚¯ãŒå¤–ã‚ŒãŸ');
            markProgress('clock_unlock_22');

            if (typeof renderCanvasRoom === 'function') {
                renderCanvasRoom();
            }

        }


        // ãƒ‰ã‚¢ãƒ‘ã‚ºãƒ«ã‚’è¡¨ç¤º
        function showDoorPuzzle() {
            if (gameState.main.flags.blockManStatus == 4) {
                updateMessage('ã‚‚ã†æ‰‹ã®æ‰“ã¡ã‚ˆã†ãŒãªã„â€¦');
                return;
            }
            if (!gameState.main.flags.bearAppear) {
                updateMessage('ã¾ã åå¿œã—ãªã„ã‚ˆã†ã ');
                return;
            }
            const msg = gameState.main.flags.unlockDoor && hasItem('hat') ? '(ã¾ã å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã )' : '';
            const modalContent = `
                <h3>ãƒ‰ã‚¢ã®æ“ä½œãƒ‘ãƒãƒ«ã ã‚ã†ã‹ï¼Ÿ</h3>
                <p>${msg}</p>
                <input type="text" class="puzzle-input" id="doorInput" placeholder="è‹±å­—">
                <br>
                <button onclick="checkDoorPuzzle()">OK</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ãƒ‰ã‚¢ãƒ‘ã‚ºãƒ«ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkDoorPuzzle() {
            const v = document.getElementById('doorInput').value.trim();
            // å…¨è§’å¯¾ç­–
            const z2h = s => s.replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === 'exit') {
                if (gameState.main.flags.unlockDoor) {
                    if (typeof playSE === 'function') playSE('se-error');
                    updateMessage('ã™ã§ã«ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ã¯è§£é™¤ã•ã‚Œã¦ã„ã‚‹');
                    return;
                }
                closeModal();
                gameState.main.flags.unlockDoor = true;

                markProgress('door_normal_unlock_22');

                if (gameState.main.flags.blockManStatus == 2 || gameState.main.flags.blockManStatus == 3) {
                    window._nextModal = {
                        title: 'ã‚ã‚ŠãŒã¨ã‚ˆ',
                        content: `<img src="${IMAGES.modals.blockManGone}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        buttons: [
                            { text: 'é–‰ã˜ã‚‹', action: 'close' }
                        ],
                        before() {
                            screenFlash('black');
                        },
                        after() {
                            playSE('se-ashioto');
                            gameState.main.flags.blockManStatus = 4;
                            if (typeof renderCanvasRoom === 'function') {
                                renderCanvasRoom();
                            }
                            updateMessage('ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ãŸã€‚ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ³ã‚’è§£ãæ”¾ã£ã¦ã—ã¾ã£ãŸâ€¦');
                        }
                    };
                }

                showModal(
                    'ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸ',
                    '',
                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                );
                updateMessage('ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ãŸã€‚');
                playSE('se-clear');
                renderCanvasRoom();

            } else if (val === 'return') {
                if (gameState.main.flags.blockManStatus > 1 || !hasItem('hat') || !hasItem('map')) {
                    showModal(
                        'åå¿œãŒç„¡ã„â€¦',
                        '',
                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                    );
                } else {
                    closeModal();
                    travelWithSteps('saint');
                    markProgress('door_normal_plus_unlock_22');
                }


            } else {
                playSE('se-error');
                updateMessage('ã¡ãŒã†ã‚ˆã†ã ');
            }
        }



        function showNewspaperModal() {
            // playSE('paper'); // ã‚ã‚Œã°æœ€é«˜

            showModal(
                'å¤ã„æ–°èã®åˆ‡ã‚Œç«¯',
                `
      <div class="newspaper" style="text-align:left;">
        
        <!-- æ–°èã®å†™çœŸã‚¨ãƒªã‚¢ -->
        <div style="text-align:center; margin-bottom:14px;">
          <img src="${IMAGES.items.newsPaperPic}"
               style="width:90%; max-width:420px; border:2px solid #444; box-shadow:0 0 6px #0008;">
        </div>

        <h2 style="margin:6px 0 0 0;">å±±é–“ã®é›†è½ã§é€£ç¶šæ®ºäººäº‹ä»¶</h2>
        <p class="subtitle" style="margin-top:0; font-size:0.95em; color:#ccc;">
          ï¼“äººç›®ã®è¢«å®³è€…ã€çŠ¯è¡Œã¯åŒä¸€äººç‰©ã‹
        </p>

        <p>14æ—¥æœªæ˜ã€å¸‚å†…åŒ—éƒ¨ã®å±±æ—ã§20ä»£å¥³æ€§ãŒæ­»äº¡ã—ã¦ã„ã‚‹ã®ãŒè¦‹ã¤ã‹ã£ãŸã€‚è­¦å¯Ÿã®ç™ºè¡¨ã«ã‚ˆã‚‹ã¨ã€è¢«å®³è€…ã¯å‰æ—¥å¤•æ–¹ã‹ã‚‰è¡Œæ–¹ãŒã‚ã‹ã‚‰ãšã€å‹äººã®é€šå ±ã«ã‚ˆã‚Šæœç´¢ãŒè¡Œã‚ã‚Œã¦ã„ãŸã€‚</p>
        <p>éºä½“ç™ºè¦‹ç¾å ´ã¯ãƒã‚¤ã‚­ãƒ³ã‚°ã‚³ãƒ¼ã‚¹ã‹ã‚‰å¤–ã‚ŒãŸå°ã•ãªç©ºãåœ°ã§ã€äº‰ã£ãŸå½¢è·¡ã¯ã»ã¨ã‚“ã©ãªã‹ã£ãŸã€‚æ‰€æŒå“ã®å¤§åŠã¯ãã®å ´ã«æ®‹ã•ã‚Œã¦ã„ãŸãŒã€è¢«å®³è€…ãŒå¸¸ã«æºå¸¯ã—ã¦ã„ãŸã¨ã„ã†ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³å‹ã®ã¬ã„ãã‚‹ã¿ ãŒè·¡å½¢ã‚‚ãªãæ¶ˆãˆã¦ãŠã‚Šã€è­¦å¯Ÿã¯çŠ¯äººãŒæŒã¡å»ã£ãŸå¯èƒ½æ€§ã‚‚ã‚ã‚‹ã¨ã¿ã¦èª¿ã¹ã¦ã„ã‚‹ã€‚</p>
<p>è­¦å¯Ÿã¯ã€ç¾å ´ã®çŠ¶æ³ãŒã“ã‚Œã¾ã§ã®äº‹ä»¶ã¨é¡ä¼¼ã—ã¦ã„ã‚‹ç‚¹ã‹ã‚‰åŒä¸€çŠ¯ã«ã‚ˆã‚‹è¨ˆç”»çš„ãªçŠ¯è¡Œã¨ã¿ã¦æœæŸ»ã‚’è¡Œã£ã¦ã„ã‚‹ã€‚</p>

        <p>
          åœ°åŸŸä½æ°‘ã®è¨¼è¨€ã«ã‚ˆã‚Œã°ã€ã€Œå¸½å­ã‚’æ·±ãã‹ã¶ã£ãŸå½±ã€ã‚’
          ä½•åº¦ã‹è¦‹ã‹ã‘ãŸã¨ã„ã†ã€‚çŠ¯è¡Œã¨ã®é–¢é€£ã¯ä¸æ˜ã€‚
        </p>

        <p style="margin-top:14px;color:#a33;font-size:0.9em;">
          â€» ç«¯ã«èµ¤ã„æ‰‹æ›¸ããƒ¡ãƒ¢ï¼š<br>
          ã€Œã‚‚ã†æ­¢ã‚ã‚‰ã‚Œãªã„â€¦ã€
        </p>
      </div>
    `,
                [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
            );

            gameState.main.flags.readNewspaper = true;
        }




        function handleDoor() {
            // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°é·ç§»å…±é€šãƒãƒ³ãƒ‰ãƒ©
            const goEnding = () => {
                if (gameState.flags.trueEndUnlocked) {
                    gameState.endings.true = true;
                    travelWithStepsTrueEnd();
                } else if (gameState.main.flags.blockManStatus >= 2 && gameState.main.flags.blockManStatus < 5) {
                    changeRoom('endWorse');
                } else if (hasItem('hat')) {
                    showModal(
                        'ã“ã®å¸½å­ã‚’æŒã£ã¦å¸°ã‚ŠãŸããªã„ãª',
                        `<img src="${IMAGES.items.hat}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                    );
                    return;
                } else if (gameState.main.flags.isNight) {
                    updateMessage('å¤œé“ã¯å±é™ºãªã®ã§ã‚„ã‚ã¦ãŠã“ã†');
                    return;
                } else {
                    updateMessage('ã¾ã é–‹ã‹ãªã„ã‚ˆã†ã ');
                    return;
                }
            };

            goEnding();
        }

        function showObj(flagKey, title, imgSrc, msg) {
            const f = gameState.main.flags;
            if (flagKey) {
                // è¦‹ãŸã“ã¨ã‚’ãƒ•ãƒ©ã‚°ç®¡ç†ã™ã‚‹å ´åˆ
                f[flagKey] = true;
            }

            showModal(
                title,
                `<img src="${imgSrc}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
            );
            updateMessage(msg);
        }


        // ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 8) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            } else {
                updateMessage('ã‚¢ã‚¤ãƒ†ãƒ æ¬„ãŒã„ã£ã±ã„ã ã€‚ã©ã“ã‹ã§æ¸›ã‚‰ã—ã¦ã“ã‚ˆã†');
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }

        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            const clickedItem = gameState.inventory[slotIndex];

            if (!clickedItem) return;

            // â˜…ã™ã§ã«é¸æŠä¸­ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’å†ã‚¯ãƒªãƒƒã‚¯ â†’ è§£é™¤
            if (gameState.selectedItemSlot === slotIndex) {
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateMessage('ã‚¢ã‚¤ãƒ†ãƒ é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
                updateInventoryDisplay();
                return;
            }

            // â˜…é€šå¸¸ã®é¸æŠ
            gameState.selectedItem = clickedItem;
            gameState.selectedItemSlot = slotIndex;
            updateMessage(`${getItemName(clickedItem)}ã‚’é¸æŠã—ã¾ã—ãŸã€‚ä½¿ç”¨ã—ãŸã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`);
            updateInventoryDisplay();
        }

        function getItemName(itemId) {
            const names = {
                coin: 'ã‚¯ãƒã‚³ã‚¤ãƒ³',
                bear: 'ã‚¯ãƒå¦–ç²¾',
                blockFire: 'ç‚ã®ãƒ–ãƒ­ãƒƒã‚¯',
                blockHead: 'é ­ã®ãƒ–ãƒ­ãƒƒã‚¯',
                scissors: 'ã¯ã•ã¿',
                blockStocking: 'é´ä¸‹ã®ãƒ–ãƒ­ãƒƒã‚¯',
                key: 'éµ',
                hat: 'å¸½å­',
                map: 'é›‘ãªåœ°å›³',
                cake: 'ã‚±ãƒ¼ã‚­',
                memoGhost: 'ãŠã°ã‘ã®ãƒ¡ãƒ¢',
                faceSeal: 'é¡”ã®ã‚·ãƒ¼ãƒ«',



            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            if (gameState.currentRoom === 'saint') return;
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;

                btn.onclick = () => changeRoom(roomId);

                // btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        function addNaviItem(room) {
            if (!gameState.openRooms.includes(room)) {
                gameState.openRooms.push(room);
                return true;
            }
            return false;
        }

        // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªè¡¨ç¤ºæ›´æ–°
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function () {
                        // ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                    const magBtn = document.createElement('div');
                    magBtn.className = 'magnifier-btn';
                    magBtn.title = 'æ‹¡å¤§è¡¨ç¤º';
                    magBtn.innerHTML = '<img src="images/magnifier.png" alt="æ‹¡å¤§">';
                    magBtn.onclick = (e) => {
                        e.stopPropagation();

                        const itemId = gameState.inventory[index];

                        // ãƒ‡ãƒ•ã‚©ã®ä¸­èº«
                        let content = `<img src="${img.src}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`;
                        let buttons = [{ text: 'é–‰ã˜ã‚‹', action: 'close' }];

                        // ãƒãƒ³ãƒˆãªã‚‰ã€Œèª¿ã¹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆéµæœªå…¥æ‰‹ï¼†æœªç™ºè¦‹ãƒ•ãƒ©ã‚°æ™‚ã®ã¿ï¼‰
                        if (itemId === 'envelope') {
                            buttons = [
                                {
                                    text: 'é–‹ã‘ã‚‹', action: () => {
                                        showModal(
                                            'å°ç­’ã‚’é–‹ã‘ãŸ',
                                            `<img src="${IMAGES.modals.openEnvelope}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`,
                                            [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                                        );
                                        removeItem('envelope');
                                        addItem('memoGhost');
                                        addItem('faceSeal');
                                        updateMessage('å°ç­’ã‚’é–‹ã‘ãŸ');
                                    }
                                },
                                { text: 'é–‰ã˜ã‚‹', action: 'close' }
                            ];
                        }

                        showModal(
                            getItemName(itemId),
                            content,
                            buttons
                        );
                    };
                    slot.appendChild(magBtn);
                }
                // â˜…é¸æŠä¸­ãªã‚‰selectedã‚¯ãƒ©ã‚¹è¿½åŠ 
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }


        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
        function updateMessage(message) {
            //document.getElementById('messageArea').innerHTML = message;
            document.getElementById('msgText').textContent = message;
        }

        function updateMessageHTML(html) {
            const el = document.getElementById('msgText');
            el.innerHTML = html;
            el.querySelectorAll('a').forEach(a => {
                a.target = '_blank';
                a.rel = 'noopener';
                a.style.color = '#d4af37';
                a.style.textDecoration = 'underline';
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(title, content, buttons, onSequenceSuccess, options) {
            options = options || {};
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            if (buttons && buttons.length > 0) {
                const columnStyle = options.columnButtons
                    ? 'display:flex; flex-direction:column; gap:12px; align-items:stretch;'
                    : 'text-align:center; display:flex; gap:10px; justify-content:center;';

                modalHtml += `<div id="modalButtons" style="${columnStyle}"></div>`;
                modalHtml += `<div id="modalClose" style="margin-top:25px;text-align:center;"></div>`;
            }
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';

            if (!buttons || buttons.length === 0) return;

            let pressed = [];
            let heartCnt = 0;
            let checkCnt = 0;
            let houseCnt = 0;

            // ç”»åƒ/é€šå¸¸ãƒœã‚¿ãƒ³ã¨closeãƒœã‚¿ãƒ³ã§åˆ†ã‘ã‚‹
            const modalButtons = document.getElementById('modalButtons');
            const modalClose = document.getElementById('modalClose');

            buttons.forEach((button, idx) => {
                // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã¯ä¸‹ã¸
                if (button.action === 'close') {
                    const btn = document.createElement('button');
                    btn.textContent = button.text || 'é–‰ã˜ã‚‹';
                    btn.className = 'modal-close-btn';
                    btn.onclick = function () {
                        closeModal();
                        if (typeof onSequenceSuccess === "function") {
                            onSequenceSuccess();
                        }
                    };
                    modalClose.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.style.margin = "0 10px 10px 0";
                    if (button.img) {
                        btn.innerHTML = `<img src="${button.img}" alt="${button.text || ''}" style="width:80px;height:80px;vertical-align:middle;">`;
                    } else {
                        btn.textContent = button.text;
                        btn.className = 'text-btn';
                    }
                    btn.onclick = function () {
                        if (button.action === 'restart') {
                            restartGame();
                        } else if (typeof button.action === "function") {
                            button.action();
                        } else if (typeof button.action === 'string') {
                            closeModal();
                            handleAreaClick(button.action);
                        }
                    };
                    modalButtons.appendChild(btn);
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // æ¬¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
            if (window._nextModal) {
                // ç™»éŒ²å†…å®¹ã¯ {title, content, buttons, after} ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                let modal = window._nextModal;
                window._nextModal = null; // ã‚¯ãƒªã‚¢

                if (typeof modal === 'function') {
                    try { modal(); } catch (e) { }
                    window.dispatchEvent(new Event('modal:closed'));
                    return;
                }

                if (modal.before) modal.before();
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after();
            }
            window.dispatchEvent(new Event('modal:closed'));
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
        function restartGame() {
            gameState = getDefaultGameState();
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;
        let isBGMInitialized = false; // åˆå›ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç”¨

        // åˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã ã‘BGMã‚’å†ç”Ÿ
        function initBGMOnce() {
            if (!isBGMInitialized) {
                const bgm = document.getElementById('bgm');
                bgm.volume = 0.3;
                bgm.play();
                isBGMPlaying = true;
                isBGMInitialized = true;
                document.getElementById('bgm-toggle').textContent = "ğŸ”Š BGM";
            }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "ğŸ”Š BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "ğŸ”‡ BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ã§æ¯”è¼ƒ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            if (current === next) return; // ã™ã§ã«ãã®BGMãªã‚‰ä½•ã‚‚ã—ãªã„

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function pauseBGM() {
            const bgm = document.getElementById('bgm');
            bgm.src = "";
            bgm.pause();
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // ã©ã“ã‹ã§æœ€åˆã«ä¸€åº¦ã ã‘å‘¼ã¶
        let loadedImages = {};
        function preloadImages() {
            // éƒ¨å±‹ç”»åƒ
            Object.values(IMAGES.rooms).forEach(val => {
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        if (!loadedImages[src]) {
                            const img = new Image();
                            img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                            img.src = src;
                            loadedImages[src] = img;



                        }
                    });
                } else if (typeof val === "string") {
                    if (!loadedImages[val]) {
                        const img = new Image();
                        img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                        img.src = val;
                        loadedImages[val] = img;
                    }
                }
            });
            // ã‚¢ã‚¤ãƒ†ãƒ ç”»åƒ
            Object.values(IMAGES.items).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒ
            Object.values(IMAGES.modals).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
        }

        // save&load
        function saveGameToSlot(slotIndex) {
            const toSave = { ...gameState, __version: SAVE_VERSION };

            const payload = {
                data: toSave,
                savedAt: Date.now()
            };

            localStorage.setItem(SAVE_KEYS[slotIndex], JSON.stringify(payload));
            updateMessage(`ã‚»ãƒ¼ãƒ–${slotIndex + 1}ã«ä¿å­˜ã—ã¾ã—ãŸï¼`);
        }

        function loadGameFromSlot(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                updateMessage(`ã‚»ãƒ¼ãƒ–${slotIndex + 1}ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“`);
                return;
            }

            let saved;
            try {
                const parsed = JSON.parse(raw);
                // æ–°å½¢å¼ï¼š{ data: {...}, savedAt: ... }
                if (parsed && parsed.data) {
                    saved = parsed.data;
                } else {
                    // æ—§å½¢å¼ï¼šãã®ã¾ã¾ gameState ãŒå…¥ã£ã¦ã„ã‚‹
                    saved = parsed;
                }
            } catch (e) {
                console.error(e);
                updateMessage('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }

            const def = getDefaultGameState();
            const merged = deepMerge(def, saved);

            if (!Array.isArray(merged.openRooms)) merged.openRooms = def.openRooms.slice();
            if (!merged.currentRoom || !rooms[merged.currentRoom]) merged.currentRoom = def.currentRoom;

            gameState = merged;

            changeRoom(gameState.currentRoom);
            updateInventoryDisplay?.();
            renderNavigation?.();
            updateMessage(`ã‚»ãƒ¼ãƒ–${slotIndex + 1}ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼`);
        }

        function getSaveSlotLabel(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                return `ã‚»ãƒ¼ãƒ–${slotIndex + 1}ï¼ˆç©ºï¼‰`;
            }
            try {
                const parsed = JSON.parse(raw);
                const savedAt = parsed.savedAt;
                if (!savedAt) {
                    return `ã‚»ãƒ¼ãƒ–${slotIndex + 1}ï¼ˆæ—¥æ™‚ä¸æ˜ï¼‰`;
                }
                const d = new Date(savedAt);
                const jp = d.toLocaleString('ja-JP');
                return `ã‚»ãƒ¼ãƒ–${slotIndex + 1}ï¼ˆ${jp}ï¼‰`;
            } catch {
                return `ã‚»ãƒ¼ãƒ–${slotIndex + 1}ï¼ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼‰`;
            }
        }

        function openLoadMenu() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0),
                    action: () => {
                        loadGameFromSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1),
                    action: () => {
                        loadGameFromSlot(1);
                        closeModal();
                    }
                },
                { text: 'ã‚„ã‚ã‚‹', action: 'close' }
            ];

            showModal('ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸ã‚“ã§ãã ã•ã„', '', buttons, null, { columnButtons: true });
        }

        function saveGame() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0) + ' ã«ä¸Šæ›¸ãä¿å­˜',
                    action: () => {
                        saveGameToSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1) + ' ã«ä¸Šæ›¸ãä¿å­˜',
                    action: () => {
                        saveGameToSlot(1);
                        closeModal();
                    }
                },
                { text: 'ã‚„ã‚ã‚‹', action: 'close' }
            ];

            showModal('ã‚»ãƒ¼ãƒ–å…ˆã‚’é¸ã‚“ã§ãã ã•ã„', '', buttons, null, { columnButtons: true });
        }

        function loadGame() {
            openLoadMenu();
        }

        function deepMerge(target, source) {
            if (source === undefined || source === null) return target;
            if (Array.isArray(source)) return source.slice();
            if (typeof source === 'object') {
                const out = (target && typeof target === 'object') ? { ...target } : {};
                for (const k of Object.keys(source)) {
                    out[k] = deepMerge(target ? target[k] : undefined, source[k]);
                }
                return out;
            }
            return source;
        }

        function showToast(text, ms = 2600) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = text;
            el.style.opacity = '1';
            el.style.transform = 'translateX(-50%) translateY(0)';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(-50%) translateY(-8px)';
            }, ms);
        }

        window.addEventListener('keydown', e => {
            if (e.key === 'F2') {
                DEV_MODE = !DEV_MODE;
                renderCanvasRoom();
            }
        });

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        preloadImages();
        initGame();
    </script>
    <div id="toast"
        style="position:fixed;left:50%;top:14px;transform:translateX(-50%);
padding:10px 14px;border-radius:8px;background:#1f6feb;color:#fff;font-weight:700;
box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s; z-index:9999;">
    </div>

</body>

</html>