<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Èü≥Ê•ΩÂÆ§„ÇíËàûÂè∞„Å´„Åó„ÅüÂàÜÂ≤ê„Ç®„É≥„Éâ‰ªò„Åç„ÅÆÁÑ°ÊñôËÑ±Âá∫„Ç≤„Éº„É†„ÄÇÂÖ®4„Ç®„É≥„Éâ„ÅÆ„Éû„É´„ÉÅ„Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÄÇ„Çπ„Éû„ÉõÔºÜPCÂØæÂøú„ÄÇ">
    <title>Èü≥Ê•ΩÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;
            /* ‚Üê„Åì„ÇåÈáçË¶Å */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
        }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            /* flex: 1; */
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 12px;
            /* width:100%; */
        }

        .inventory-slot {
            width: 14vw;
            height: 14vw;
            max-width: 80px;
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;
            /* ÈáëËâ≤„ÉªÂ§™„ÇÅÊé®Â•® */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .magnifier-btn {
            position: absolute;
            right: 4px;
            bottom: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0002;
            cursor: pointer;
            z-index: 10;
            transition: box-shadow .15s;
        }

        .magnifier-btn:hover {
            box-shadow: 0 0 10px #ffd70099;
        }

        .magnifier-btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .info-panel {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            height: 65px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        #msgText {}

        #statusIconArea {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px #0005;
            font-size: 1.4em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        #modalButtons button {
            border: none;
            background: none;
            padding: 0;
            margin: 0 10px 10px 0;
            cursor: pointer;
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
            border-radius: 10px;
        }

        #modalButtons button img {
            width: 80px;
            height: 80px;
            vertical-align: middle;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
        }

        #modalButtons button:hover img {
            filter: brightness(1.08) drop-shadow(0 2px 6px #ffd70050);
            box-shadow: 0 0 10px #ffd70080;
            transform: scale(1.05);
        }

        #modalButtons button:active img,
        #modalButtons button.pressed img {
            filter: brightness(0.95) grayscale(20%);
            box-shadow: 0 0 8px #3332;
            transform: scale(0.97);
        }

        #modalButtons button:disabled img {
            filter: grayscale(90%) opacity(0.5);
            box-shadow: none;
        }

        /* „ÉÜ„Ç≠„Çπ„ÉàÂûã„Éú„Çø„É≥„ÇÇÁîªÂÉè„Éú„Çø„É≥È¢®„Å´ */
        #modalButtons button.text-btn {
            min-width: 120px;
            font-size: 1.15em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            margin: 0 10px 10px 0;
            box-shadow: 0 4px 14px #ffc90022;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s, transform 0.08s;
            vertical-align: middle;
            display: inline-block;
        }

        #modalButtons button.text-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
            transform: scale(1.05);
        }

        #modalButtons button.text-btn:active {
            filter: brightness(0.96);
            transform: scale(0.97);
        }

        #modalButtons button.text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Èñâ„Åò„Çã„Éú„Çø„É≥ */
        #modalClose .modal-close-btn {
            display: inline-block;
            min-width: 160px;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            box-shadow: 0 4px 14px #ffc90022;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s;
        }

        #modalClose .modal-close-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        .login-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            width: 280px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'Segoe UI', sans-serif;
        }

        .login-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .login-form label {
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .login-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .login-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ÁîªÂÉè„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }

        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            /* width: 40%; */
        }

        @media (max-width: 600px) {
            #msgText {
                font-size: .8rem;
            }

            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }

            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width: 100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }

        #roomEffectOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }

        .title-wrapper {
            display: flex;
            width: 100%;
        }

        @keyframes warpFlash {
            0% {
                opacity: 0
            }

            15% {
                opacity: .95
            }

            50% {
                opacity: .4
            }

            100% {
                opacity: 0
            }
        }

        @keyframes chroma {
            0% {
                filter: none
            }

            100% {
                filter: contrast(1.2) saturate(1.2) hue-rotate(20deg)
            }
        }

        .warp-active {
            background: radial-gradient(circle at 50% 50%, #fff, #000 70%);
            animation: warpFlash 900ms ease-out both, chroma 900ms ease-out both;
        }

        #hintModal {
            color: #000;
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F2G9BX4FBF"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-F2G9BX4FBF');
</script>

<body>
    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <div class="title">Èü≥Ê•ΩÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫</div>
            <div style="margin:0 0; text-align:center;">
                <a href="escape14_hint.html" target="_blank"
                    style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    üîç „Éí„É≥„Éà„ÇíË¶ã„Çã
                </a>

            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="640" style="width: 90vw; max-width: 640px;"></canvas>

        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="msgText">Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÈü≥Ê•ΩÂÆ§„Å´Èñâ„ÅòËæº„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ</span>
                    <div id="statusIconArea" style="position:absolute; bottom:6px; right:12px; display:flex; gap:8px;">
                    </div>
                </div>
                <div class="navigation">

                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
                <div class="inventory-slot" onclick="useItem(5)"></div>
                <div class="inventory-slot" onclick="useItem(6)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
                üîä BGM
            </button>
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">„Çª„Éº„Éñ</button>
                <button class="nav-btn" onclick="loadGame()">„É≠„Éº„Éâ</button>
            </div>
        </div>
        <div class="notice">ÂΩì„Çµ„Ç§„Éà„ÅÆÈü≥Ê∫ê„ÅØ<a href="https://otologic.jp/" target="blank">OtoLogic</a>,<a
                href="https://dova-s.jp/" target="blank">DOVA-SYNDROME</a>„ÄÅ<a href="https://maou.audio/"
                target="blank">È≠îÁéãÈ≠Ç</a>„ÅÆÁ¥†Êùê„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô ‰ΩúËÄÖ:<a href="index.html">„Çπ„É©„Çª„Éñ„É≥</a>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>
    <!-- hint„É¢„Éº„ÉÄ„É´ -->
    <div id="hintModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.5)">
        <div
            style="max-width:560px;margin:10vh auto;background:#fff;border-radius:12px;padding:16px 16px 8px;box-shadow:0 10px 30px rgba(0,0,0,.3)">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                <strong id="hintTitle">„Éí„É≥„Éà</strong>
                <button id="hintClose"
                    style="border:none;background:transparent;font-size:20px;cursor:pointer">‚úï</button>
            </div>
            <div id="hintBody" style="margin:12px 0">
                <!-- ÊÆµÈöé„Éí„É≥„Éà„ÅåÂÖ•„Çã -->
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center">
                <small id="hintUsage" style="opacity:.7"></small>
                <button id="hintMore"
                    style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#f7f7f7;cursor:pointer">„Åï„Çâ„Å´Ë¶ã„Çã</button>
            </div>
        </div>
    </div>
    <audio id="bgm" src="sounds/14/canvasintheroom.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-clear" src="sounds/common/Cyber03-1.mp3"></audio>
    <audio id="se-change" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-down" src="sounds/14/Motion-Slam01-1(Dry).mp3"></audio>
    <audio id="se-open" src="sounds/common/Short_Accent09-1(Dry).mp3"></audio>
    <audio id="se-fanta" src="sounds/common/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <audio id="se-coin" src="sounds/common/Onoma-Ding01-1(Dry).mp3"></audio>
    <audio id="se-scene-change" src="sounds/common/Scene_Change08-1(Delay-Fast).mp3"></audio>
    <audio id="se-gacha" src="sounds/common/Retro_Anime-Switch02-3(Low).mp3"></audio>
    <audio id="se-eat" src="sounds/common/Motion-Eating02-1.mp3"></audio>
    <audio id="se-bad-space" src="sounds/13/Single_Accent18-1(Mid).mp3"></audio>
    <audio id="se-maracas" src="sounds/14/Maracas01-01(Single).mp3"></audio>
    <audio id="se-do" src="sounds/14/maou_se_inst_piano2_1do.mp3"></audio>
    <audio id="se-re" src="sounds/14/maou_se_inst_piano2_2re.mp3"></audio>
    <audio id="se-mi" src="sounds/14/maou_se_inst_piano2_3mi.mp3"></audio>
    <audio id="se-fa" src="sounds/14/maou_se_inst_piano2_4fa.mp3"></audio>
    <audio id="se-so" src="sounds/14/maou_se_inst_piano2_5so.mp3"></audio>
    <audio id="se-ra" src="sounds/14/maou_se_inst_piano2_6ra.mp3"></audio>
    <audio id="se-shi" src="sounds/14/maou_se_inst_piano2_7si.mp3"></audio>
    <audio id="se-do2" src="sounds/14/maou_se_inst_piano1_8do.mp3"></audio>
    <audio id="se-harmonica" src="sounds/14/harmonica.mp3"></audio>
    <audio id="se-donguri" src="sounds/14/donguri.mp3"></audio>
    <audio id="se-kumasan" src="sounds/14/kumasan.mp3"></audio>
    <audio id="se-chime" src="sounds/14/chime.mp3"></audio>
    <audio id="se-hakone" src="sounds/14/harmonica_hakone.mp3"></audio>
    <audio id="se-drum1" src="sounds/14/Woodblock02-3(High).mp3"></audio>
    <audio id="se-drum2" src="sounds/14/Woodblock02-1(Low).mp3"></audio>
    <audio id="se-drum3" src="sounds/14/Woodblock02-2(Mid).mp3"></audio>
    <audio id="se-drum4" src="sounds/14/Woodblock01-1(Low).mp3"></audio>
    <audio id="se-drum5" src="sounds/14/Woodblock01-3(Mid).mp3"></audio>
    <audio id="se-gaan" src="sounds/14/gaan.mp3"></audio>
    <script>
        // --- Analytics helper ---
        window.ANA = {
            start: Date.now(),
            hintCount: 0,
            send(ev, params = {}) { try { gtag('event', ev, params); } catch (e) { } }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const a = document.querySelector('a[href*="_hint.html"]');
            if (a) {
                a.addEventListener('click', () => {
                    ANA.hintCount++;
                    ANA.send('open_hint', { count: ANA.hintCount });
                });
            }
        });

        window.ANA = Object.assign(window.ANA || {}, {
            sid: Math.random().toString(36).slice(2),
            sent: new Set(),
            baseParams() {
                return {
                    elapsed_sec: Math.round((Date.now() - this.start) / 1000),
                    hints: this.hintCount || 0,
                    save_version: (typeof SAVE_VERSION === 'number' ? SAVE_VERSION : null),
                    room: (window.gameState && gameState.currentRoom) || null,
                    sid: this.sid,
                };
            },
            once(ev, key = '', params = {}) {
                const k = `${ev}:${key}`;
                if (this.sent.has(k)) return;
                this.sent.add(k);
                this.send(ev, { ...this.baseParams(), ...params });
            }
        });

        // Ê±éÁî®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÄÅ‰ø°Áî®„Éò„É´„Éë
        function markProgress(step, extra = {}) {
            ANA.once('progress', step, { step, ...extra });
        }

        window._nextModal = null;
        const canvas = document.getElementById('gameCanvas');
        // „Ç≤„Éº„É†Ë®≠ÂÆö - ÁîªÂÉè„Éë„Çπ„Çí„Åì„Åì„ÅßÁÆ°ÁêÜ
        let IMAGES = {
            rooms: {
                piano: ['images/14/piano.png'],
                mainWindow: ['images/14/main_window.jpeg'],
                mainPiano: ['images/14/main_piano.png'],
                mainDrum: ['images/14/main_drum.png'],
                mainDoor: ['images/14/main_door.jpeg'],
                maracas: ['images/14/maracas_back.png'],
                safeCenter: ['images/14/safe_close_center.png'],
                drum: ['images/14/drum.png'],
                ghost: ['images/14/ghost_back.png'],
                humendai: ['images/14/gakuhu_yama.png', 'images/14/gakuhu_yama_cloud.png'],
                guitarCase: ['images/14/guitar_case.png'],
                end: ['images/14/end.jpeg'],
                end2: ['images/14/end2.png'],
                trueEnd: ['images/14/true_end.png'],
                trueEnd2: ['images/14/true_end2.png'],
                hakone: ['images/14/hakone.jpeg'],
                // end1969: ['images/14/end1969.png'],

            },
            items: {

                coin: 'images/bear_coin.png',
                bear: 'images/bear.png',
                back: 'images/common/back.png',
                arrowRight: 'images/common/arrow_right.png',
                arrowLeft: 'images/common/arrow_left.png',
                redBack: 'images/common/red_back.png',
                greenBack: 'images/common/green_back.png',
                ghost: 'images/14/ghost.png',
                ghost2: 'images/14/ghost2.png',
                safeOpened: 'images/14/safe_open.png',
                safeCenterClosed: 'images/14/safe_close_center.png',
                safeLeftOpened: 'images/14/safe_open_left.png',
                safeLeftClosed: 'images/14/safe_close_left.png',
                harmonica: 'images/14/harmonica_wind.png',
                harmonicaNormal: 'images/14/harmonica_normal.png',
                tani: 'images/14/tani.png',
                kashi: 'images/14/kashi.png',
                fog: 'images/14/fog.png',
                picDonguri: 'images/14/pic_donguri.png',
                keyDonguri: 'images/14/key_donguri.png',
                maracasBeamLeft: 'images/14/maracas_beam_left.png',
                maracasBeamRight: 'images/14/maracas_beam_right.png',
                maracasBeamDoor: 'images/14/door_beam.png',
                maracasBeamDoorLeft: 'images/14/maracas_beam_door_left.png',
                maracasBeamDoorRight: 'images/14/maracas_beam_door_right.png',
                cloudSeal: 'images/14/cloud_seal.png',
                posterCloud: 'images/14/poster_cloud.png',
                posterHakone: 'images/14/poster_hakone.png',
                bachi: 'images/14/bachi.png',
                maracas: 'images/14/maracas.png',
                posterOngaku: 'images/14/poster_ongaku.png',
                locked: 'images/14/locked.png',
                goout: 'images/14/goout.png',
                score: 'images/14/score.png',
                door: 'images/14/door.png',
                key: 'images/14/key.png',
                bearMaracas: 'images/14/bear_maracas.jpeg',
                bearBoardTrans: 'images/14/bear_board_trans.png',

            },

            modals: {
                kashi: 'images/14/kashi.png',
                beethoven: 'images/14/beethoven.png',
                mozart: 'images/14/mozart.png',
                chopin: 'images/14/chopin.png',
                bach: 'images/14/bach.png',
                brahms: 'images/14/brahms.png',
                taki: 'images/14/taki.png',
                picDonguri: 'images/14/pic_donguri.png',
                safeLeftClosedDonguri: 'images/14/left_sage_closed_donguri.png',
                drumGhost: 'images/14/drum_ghost.png',
                maracasOnfloor: 'images/14/maracas_onfloor.png',
                bearSticker: 'images/14/bear_sticker.png',
                bearReceiveHarmonica: 'images/14/bear_receive_harmonica.png',
                bearPlayHarmonica: 'images/14/bear_play_harmonica.png',
                windowZoom: 'images/14/window_zoom.png',
                otoshimono: 'images/14/otoshimono.png',
                otoshimonoCoin: 'images/14/otoshimono_coin.jpeg',
                bearMaracasGiving: 'images/14/bear_maracas_giving.jpeg',
                badend: 'images/14/badend.png',
                badendBear: 'images/14/badend_bear.jpeg',
                bearBoard: 'images/14/bear_board.png',
            },


        };


        // „Ç≤„Éº„É†Áä∂ÊÖã
        const SAVE_KEY = 'escapeGameState14';
        const SAVE_VERSION = 1;

        function getDefaultGameState() {
            return {
                currentRoom: 'main',
                openRooms: ['mainPiano'],
                inventory: [],
                main: {
                    flags: {
                        hintTiers: {},
                        safeCenterOpened: false, safeLeftOpend: false, safeRightOpend: false,
                        unlockBox: false, foundKey: false, putBachi: false,
                        foundHarmonica: false, foundDonguri: false, foundBachi: false, badEnd: false,
                        foundDonguriKey: false, ghostMoved: false, foundMaracasMemo: false, foundScore: false, setScore: false,
                        pianoSeq: [], drumSeq: [], unlockDoor: false, gotMaracas: false,
                        talkTo: { bear: 0 }, backgroundState: 0, dangoAppear: false, foundDango: false, wakeupBear: false
                    }

                },
                safeCenter: {
                    counts: [0, 0, 0, 0, 0],  // ÂêÑÊï∞Â≠ó(1„Äú5)„ÅÆÊäº‰∏ãÂõûÊï∞
                    target: [3, 1, 4, 1, 5]   // ÁõÆÊ®ôÂõûÊï∞
                },

                maracas: {
                    playing: false,
                    clusters: [3, 1, 4, 1, 5],
                    t0: 0
                },
                humendai: {
                    flags: { backgroundState: 0, }
                },

                endings: { normal: false, true: false },
                flags: { trueEndUnlocked: false },
                selectedItem: null,

            };
        }

        let gameState = getDefaultGameState();




        // ÈÉ®Â±ã„Éá„Éº„Çø
        let rooms = {
            mainPiano: {
                name: 'Èü≥Ê•ΩÂÆ§',
                description: '',
                clickableAreas: [
                    {
                        x: 37.5, y: 65.1, width: 20.1, height: 9.0,
                        action: 'examine_main_piano_kenban',
                        description: 'ÈçµÁõ§',
                        usable: () => gameState.main.flags.clearFog,

                    },
                    {
                        x: 9.0, y: 19.2, width: 28.9, height: 25.2,
                        action: 'examine_main_kokuban_kashi',
                        description: 'ÈªíÊùø„ÅÆÊ≠åË©û',
                        usable: () => true,
                        item: {
                            img: 'kashi',
                            visible: () => true,
                        },
                    },
                    {
                        x: 41.2, y: 37.6, width: 14.6, height: 15.3,
                        action: 'examine_main_kokuban_tani',
                        description: 'ÈªíÊùø„ÅÆË∞∑',
                        usable: () => true,
                        item: {
                            img: 'tani',
                            visible: () => true,
                        },
                    },
                    {
                        x: 46.2, y: 47.1, width: 8.1, height: 9.1,
                        action: 'examine_main_kokuban_donguri',
                        description: 'ÈªíÊùø„ÅÆ„Å©„Çì„Åê„Çä',
                        usable: () => true,
                        item: {
                            img: 'picDonguri',
                            visible: () => true,
                        },
                    },
                    {
                        x: 79.1, y: 29.1, width: 10.8, height: 10.1,
                        action: 'examine_main_kokuban_bear',
                        description: 'ÈªíÊùø„ÅÆ„ÇØ„Éû„ÅÆÁµµ',
                        usable: () => true,
                        item: {
                            img: 'bearBoardTrans',
                            visible: () => true,
                        },
                    },
                    {
                        x: 32.9, y: 42.7, width: 48.1, height: 33.9,
                        action: 'examine_main_fog',
                        description: 'Èúß',
                        usable: () => !gameState.main.flags.clearFog,
                        zIndex: 10,
                        item: {
                            img: 'fog',
                            visible: () => !gameState.main.flags.clearFog,
                        },
                    },
                    {
                        x: 10.0, y: 0.0, width: 16.6, height: 15.4,
                        action: 'examine_main_piano_beethoven',
                        description: '„Éô„Éº„Éà„Éº„É¥„Çß„É≥„ÅÆËÇñÂÉèÁîª',
                    },
                    {
                        x: 42.0, y: 0.0, width: 14.6, height: 15.4,
                        action: 'examine_main_piano_mozart',
                        description: '„É¢„Éº„ÉÑ„Ç°„É´„Éà„ÅÆËÇñÂÉèÁîª',
                    },
                    {
                        x: 74.2, y: 0.0, width: 13.9, height: 15.0,
                        action: 'examine_main_piano_chopin',
                        description: '„Ç∑„Éß„Éë„É≥„ÅÆËÇñÂÉèÁîª',
                    },
                    {
                        x: 70, y: 85, width: 7, height: 8,
                        action: 'examine_main_piano_donguri_key',
                        description: '„Å©„Çì„Åê„ÇäÈçµ',
                        usable: () => gameState.main.flags.foundDonguriKey && !gameState.main.flags.foundDonguri,
                        item: {
                            img: 'keyDonguri',
                            visible: () => gameState.main.flags.foundDonguriKey && !gameState.main.flags.foundDonguri,
                        },
                    },
                    {
                        x: 32.1, y: 20.9, width: 65.1, height: 76,
                        action: 'examine_main_piano_door',
                        description: '„Éâ„Ç¢',
                        zIndex: 9,
                        usable: () => gameState.main.flags.ghostDisappeared,
                        item: {
                            img: 'door',
                            visible: () => gameState.main.flags.ghostDisappeared,
                        },
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_main_piano_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_main_piano_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },

                ]
            },
            mainWindow: {
                name: 'Á™ìÂÅ¥',
                description: '',
                clickableAreas: [
                    {
                        x: 11.3, y: 60.3, width: 15.8, height: 4.5,
                        action: 'examine_main_window_case1',
                        description: 'Ê•ΩÂô®„Ç±„Éº„ÇπÂ∑¶',
                    },
                    {
                        x: 34.0, y: 60.2, width: 13.7, height: 4.8,
                        action: 'examine_main_window_case2',
                        description: 'Ê•ΩÂô®„Ç±„Éº„ÇπÂ∑¶‰∏≠Â§Æ',
                    },
                    {
                        x: 51.9, y: 60.0, width: 20.8, height: 4.2,
                        action: 'examine_main_window_case3',
                        description: 'Ê•ΩÂô®„Ç±„Éº„ÇπÂè≥‰∏≠Â§Æ',
                    },
                    {
                        x: 81.3, y: 58.1, width: 13.9, height: 6.8,
                        action: 'examine_main_window_case4',
                        description: 'Ê•ΩÂô®„Ç±„Éº„ÇπÂè≥',
                    },
                    {
                        x: 33.4, y: 46.0, width: 16.5, height: 14.5,
                        action: 'examine_main_window_ghost',
                        description: '„Åä„Å∞„Åë',
                        zIndex: 1,
                        usable: () => !gameState.main.flags.ghostMoved,
                        item: {
                            img: 'ghost',
                            visible: () => !gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 33.4, y: 46.0, width: 16.5, height: 14.5,
                        action: 'enter_maracas',
                        description: '„Éû„É©„Ç´„Çπ',
                        zIndex: 2,
                        usable: () => !gameState.main.flags.ghostMoved,
                        item: {
                            img: 'ghost',
                            visible: () => !gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 72.0, y: 15.0, width: 10.1, height: 8.2,
                        action: 'examine_main_window_cloud',
                        description: 'Èõ≤',
                        zIndex: 2,
                        usable: () => !gameState.main.flags.foundCloudSeal,
                        item: {
                            img: 'cloudSeal',
                            visible: () => !gameState.main.flags.foundCloudSeal,
                        },
                    },
                    {
                        x: 38.1, y: 28.9, width: 22.0, height: 14.0,
                        action: 'examine_main_window_zoom',
                        description: 'Á™ì',

                    },
                    {
                        x: 72.6, y: 68.9, width: 16.9, height: 15.6,
                        action: 'examine_main_window_safe_center',
                        description: '‰∏≠Â§ÆÈáëÂ∫´',
                        zIndex: 2,
                        usable: () => !gameState.main.flags.safeCenterOpened,
                        item: {
                            img: 'safeCenterClosed',
                            visible: () => !gameState.main.flags.safeCenterOpened,
                        },
                    },
                    {
                        x: 72.6, y: 68.9, width: 16.9, height: 15.6,
                        action: 'examine_main_window_safe_center',
                        description: '‰∏≠Â§ÆÈáëÂ∫´',
                        zIndex: 2,
                        usable: () => gameState.main.flags.safeCenterOpened,
                        item: {
                            img: 'safeOpened',
                            visible: () => gameState.main.flags.safeCenterOpened,
                        },
                    },
                    {
                        x: 12.6, y: 68.9, width: 16.9, height: 15.6,
                        action: 'examine_main_window_safe_left',
                        description: 'Â∑¶ÈáëÂ∫´',
                        zIndex: 2,
                        usable: () => !gameState.main.flags.safeLeftOpend,
                        item: {
                            img: 'safeLeftClosed',
                            visible: () => !gameState.main.flags.safeLeftOpend,
                        },
                    },
                    {
                        x: 12.6, y: 68.9, width: 16.9, height: 15.6,
                        action: 'examine_main_window_safe_left',
                        description: 'Â∑¶ÈáëÂ∫´',
                        zIndex: 2,
                        usable: () => gameState.main.flags.safeLeftOpend,
                        item: {
                            img: 'safeLeftOpened',
                            visible: () => gameState.main.flags.safeLeftOpend,
                        },
                    },
                    {
                        x: 72.6, y: 68.9, width: 16.9, height: 15.6,
                        action: 'examine_main_window_harmonica',
                        description: '‰∏≠Â§ÆÈáëÂ∫´ÂÜÖ„Éè„Éº„É¢„Éã„Ç´',
                        zIndex: 3,
                        usable: () => gameState.main.flags.safeCenterOpened && !gameState.main.flags.foundHarmonica,
                        item: {
                            img: 'harmonica',
                            visible: () => gameState.main.flags.safeCenterOpened && !gameState.main.flags.foundHarmonica,
                        },
                    },
                    {
                        x: 12.6, y: 76.6, width: 12.9, height: 5,
                        action: 'examine_main_window_bachi',
                        description: 'Â∑¶ÈáëÂ∫´ÂÜÖ„Å∞„Å°',
                        zIndex: 3,
                        usable: () => gameState.main.flags.safeLeftOpend && !gameState.main.flags.foundBachi,
                        item: {
                            img: 'bachi',
                            visible: () => gameState.main.flags.safeLeftOpend && !gameState.main.flags.foundBachi,
                        },
                    },
                    {
                        x: 28.3, y: 51.2, width: 8.5, height: 45.2,
                        action: 'examine_main_window_maracas_beam_left',
                        description: '„Éû„É©„Ç´„Çπ„Éì„Éº„É†',
                        zIndex: 9,
                        usable: () => !gameState.main.flags.ghostMoved,
                        item: {
                            img: 'maracasBeamLeft',
                            visible: () => !gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 47.6, y: 51.5, width: 12.5, height: 45.2,
                        action: 'examine_main_window_maracas_beam_right',
                        description: '„Éû„É©„Ç´„Çπ„Éì„Éº„É†',
                        zIndex: 9,
                        usable: () => !gameState.main.flags.ghostMoved,
                        item: {
                            img: 'maracasBeamRight',
                            visible: () => !gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 27.9, y: 82.8, width: 13.2, height: 14.0,
                        action: 'examine_main_window_maracas',
                        description: 'ËêΩ„Å°„Å¶„ÅÑ„Çã„Éû„É©„Ç´„Çπ',
                        zIndex: 2,
                        usable: () => gameState.main.flags.ghostMoved,
                        item: {
                            img: 'maracas',
                            visible: () => gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_main_window_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_main_window_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },

                ]
            },
            mainDrum: {
                name: 'ÊïôÂÆ§ÂæåÊñπ',
                description: '',
                clickableAreas: [
                    {
                        x: 27.7, y: 32.3, width: 30.4, height: 29.0,
                        action: 'examine_main_drum',
                        description: 'Â§™Èºì'
                    },
                    {
                        x: 63.1, y: 44.7, width: 17.7, height: 13.1,
                        action: 'examine_main_drum_humendai',
                        description: 'Ë≠úÈù¢Âè∞',
                    },
                    {
                        x: 68.4, y: 45.8, width: 7.5, height: 9.2,
                        action: 'examine_main_drum_humendai_scpre',
                        description: 'Ë≠úÈù¢Âè∞„ÅÆÊ•ΩË≠ú',
                        usable: () => false,
                        item: {
                            img: 'score',
                            visible: () => gameState.main.flags.setScore,
                        },
                    },
                    {
                        x: 4.3, y: 0.0, width: 19.2, height: 19.0,
                        action: 'examine_main_drum_bach',
                        description: '„Éê„ÉÉ„Éè'
                    },
                    {
                        x: 30.1, y: 0.0, width: 18.8, height: 18.8,
                        action: 'examine_main_drum_brahms',
                        description: '„Éñ„É©„Éº„É†„Çπ'
                    },
                    {
                        x: 55.3, y: 0.0, width: 17.4, height: 18.8,
                        action: 'examine_main_drum_taki',
                        description: 'ÊªùÂªâÂ§™ÈÉé'
                    },
                    {
                        x: 58.0, y: 27.0, width: 18.3, height: 16.4,
                        action: 'examine_main_drum_ghost',
                        description: '„Åä„Å∞„Åë',
                        zIndex: 1,
                        usable: () => gameState.main.flags.ghostMoved && !gameState.main.flags.ghostDisappeared,
                        item: {
                            img: 'ghost2',
                            visible: () => gameState.main.flags.ghostMoved && !gameState.main.flags.ghostDisappeared,
                        },
                    },
                    {
                        x: 61.6, y: 61.3, width: 19.3, height: 21.9,
                        action: 'examine_main_drum_bear',
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 6,
                        usable: () => gameState.main.flags.wakeupBear,
                        item: {
                            img: 'bear',
                            visible: () => gameState.main.flags.wakeupBear,
                        },
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_main_drum_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_main_drum_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },

                ]
            },
            mainDoor: {
                name: 'ÈÄöË∑ØÂÅ¥',
                description: '',
                clickableAreas: [
                    {
                        x: 82.1, y: 33.3, width: 6.9, height: 8.4,
                        action: 'examine_door_poster_hakone',
                        description: 'ÁÆ±Ê†π„ÅÆ„Éù„Çπ„Çø„Éº',
                        zIndex: 1,
                        usable: () => true,
                        item: {
                            img: 'posterHakone',
                            visible: () => true,
                        },
                    },
                    {
                        x: 90.7, y: 37.6, width: 8.9, height: 12.0,
                        action: 'examine_door_poster_cloud',
                        description: 'Èõ≤„ÅÆ„Éù„Çπ„Çø„Éº',
                        zIndex: 1,
                        usable: () => true,
                        item: {
                            img: 'posterCloud',
                            visible: () => true,
                        },
                    },
                    {
                        x: 82.2, y: 42.7, width: 7.5, height: 8.4,
                        action: 'examine_door_poster_ongaku',
                        description: 'Èü≥Ê•ΩÂÆ§„ÅÆ„Éù„Çπ„Çø„Éº',
                        zIndex: 1,
                        usable: () => true,
                        item: {
                            img: 'posterOngaku',
                            visible: () => true,
                        },
                    },
                    {
                        x: 14.8, y: 23.6, width: 60.0, height: 55.0,
                        action: 'examine_door_beam',
                        description: '„Éû„É©„Ç´„Çπ„Éì„Éº„É†„Åã„Çâ„ÅÆÂÖâ',
                        zIndex: 1,
                        usable: () => !gameState.main.flags.ghostMoved,
                        item: {
                            img: 'maracasBeamDoor',
                            visible: () => !gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 30.7, y: 57.4, width: 12.0, height: 41.9,
                        action: 'examine_door_beam',
                        description: '„Éû„É©„Ç´„Çπ„Éì„Éº„É†„Åã„Çâ„ÅÆÂÖâÂ∑¶',
                        zIndex: 1,
                        usable: () => false,
                        item: {
                            img: 'maracasBeamDoorLeft',
                            visible: () => !gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 53.6, y: 57.4, width: 12.0, height: 41.9,
                        action: 'examine_door_beam',
                        description: '„Éû„É©„Ç´„Çπ„Éì„Éº„É†„Åã„Çâ„ÅÆÂÖâÂè≥',
                        zIndex: 1,
                        usable: () => false,
                        item: {
                            img: 'maracasBeamDoorRight',
                            visible: () => !gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 77.3, y: 55.4, width: 10.5, height: 26.2,
                        action: 'examine_door_guitar_case_left',
                        description: 'Ê•ΩÂô®„Ç±„Éº„ÇπÂ∑¶',
                        zIndex: 1,
                        usable: () => true,
                        item: {
                            img: 'light',
                            visible: () => gameState.main.flags.foundMaracasMemo,
                        },
                    },
                    {
                        x: 88.8, y: 52.4, width: 10.8, height: 29.0,
                        action: 'examine_door_guitar_case_right',
                        description: 'Ê•ΩÂô®„Ç±„Éº„ÇπÂè≥',
                        zIndex: 4,

                    },
                    {
                        x: 22.4, y: 29.8, width: 19.6, height: 9.3,
                        action: 'examine_door_disp_left',
                        description: '„Éâ„Ç¢Á™ìÂ∑¶',
                        zIndex: 1,
                        usable: () => false,
                        item: {
                            img: 'locked',
                            visible: () => !gameState.main.flags.unlockDoor && gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 49.0, y: 29.8, width: 19.9, height: 9.5,
                        action: 'examine_door_disp_right',
                        description: '„Éâ„Ç¢Á™ìÂè≥',
                        zIndex: 1,
                        usable: () => false,
                        item: {
                            img: 'locked',
                            visible: () => !gameState.main.flags.unlockDoor && gameState.main.flags.ghostMoved,
                        },
                    },
                    {
                        x: 22.4, y: 29.8, width: 19.6, height: 9.3,
                        action: 'examine_door_disp_left',
                        description: '„Éâ„Ç¢Á™ìÂ∑¶',
                        zIndex: 1,
                        usable: () => false,
                        item: {
                            img: 'goout',
                            visible: () => gameState.main.flags.unlockDoor,
                        },
                    },
                    {
                        x: 49.0, y: 29.8, width: 19.9, height: 9.5,
                        action: 'examine_door_disp_right',
                        description: '„Éâ„Ç¢Á™ìÂè≥',
                        zIndex: 1,
                        usable: () => false,
                        item: {
                            img: 'goout',
                            visible: () => gameState.main.flags.unlockDoor,
                        },
                    },
                    {
                        x: 17.5, y: 25.9, width: 56.1, height: 52.3,
                        action: 'examine_door',
                        description: '„Éâ„Ç¢',
                        zIndex: 1,
                        usable: () => gameState.main.flags.ghostMoved,
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_main_door_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_main_door_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },

                ]
            },
            piano: {
                name: 'ÈçµÁõ§',
                description: '',
                clickableAreas: [

                    {
                        x: 2.6, y: 70.2, width: 9.6, height: 12.7,
                        action: 'examine_piano_do',
                        description: '„Éâ',

                    },
                    {
                        x: 13.8, y: 70.2, width: 9.6, height: 12.7,
                        action: 'examine_piano_re',
                        description: '„É¨',

                    },
                    {
                        x: 25.6, y: 70.2, width: 9.6, height: 12.7,
                        action: 'examine_piano_mi',
                        description: '„Éü',

                    },
                    {
                        x: 37.4, y: 70.2, width: 9.6, height: 12.7,
                        action: 'examine_piano_fa',
                        description: '„Éï„Ç°',

                    },
                    {
                        x: 48.9, y: 70.2, width: 9.6, height: 12.7,
                        action: 'examine_piano_so',
                        description: '„ÇΩ',

                    },
                    {
                        x: 60.4, y: 70.2, width: 9.6, height: 12.7,
                        action: 'examine_piano_ra',
                        description: '„É©',

                    },
                    {
                        x: 72.4, y: 70.2, width: 9.6, height: 12.7,
                        action: 'examine_piano_shi',
                        description: '„Ç∑',

                    },
                    {
                        x: 83.8, y: 70.2, width: 9.6, height: 12.7,
                        action: 'examine_piano_do2',
                        description: '„Éâ',

                    },
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_piano_back',
                        description: 'Êàª„Çã', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            safeCenter: {
                name: '‰∏≠Â§Æ„ÅÆÈáëÂ∫´',
                description: '',
                clickableAreas: [

                    {
                        x: 9.3, y: 20.0, width: 14.0, height: 14.4,
                        action: 'examine_safe_center_1',
                        description: '1Áï™ÁõÆ',

                    },
                    {
                        x: 24.2, y: 20.0, width: 14.0, height: 14.4,
                        action: 'examine_safe_center_2',
                        description: '2Áï™ÁõÆ',

                    },
                    {
                        x: 39.5, y: 20.0, width: 14.0, height: 14.4,
                        action: 'examine_safe_center_3',
                        description: '3Áï™ÁõÆ',

                    },
                    {
                        x: 54.7, y: 20.0, width: 14.0, height: 14.4,
                        action: 'examine_safe_center_4',
                        description: '4Áï™ÁõÆ',

                    },
                    {
                        x: 69.5, y: 20.0, width: 14.0, height: 14.4,
                        action: 'examine_safe_center_5',
                        description: '5Áï™ÁõÆ',

                    },
                    {
                        x: 7.4, y: 39.6, width: 36.3, height: 19.2,
                        action: 'examine_safe_center_lever',
                        description: '„É¨„Éê„Éº',

                    },
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_safe_center_back',
                        description: 'Êàª„Çã', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            drum: {
                name: 'Â§™Èºì',
                description: '',
                clickableAreas: [
                    {
                        x: 46.1, y: 17.0, width: 17, height: 16,
                        action: 'drum_tap_above',
                        description: 'Âè©„Åè„Éù„Ç§„É≥„Éà‰∏ä'
                    },
                    {
                        x: 21.1, y: 43.8, width: 17, height: 16,
                        action: 'drum_tap_left',
                        description: 'Âè©„Åè„Éù„Ç§„É≥„ÉàÂ∑¶'
                    },
                    {
                        x: 46.3, y: 68.9, width: 17, height: 16.3,
                        action: 'drum_tap_bellow',
                        description: 'Âè©„Åè„Éù„Ç§„É≥„Éà‰∏ã'
                    },
                    {
                        x: 71.7, y: 43.8, width: 17, height: 16,
                        action: 'drum_tap_right',
                        description: 'Âè©„Åè„Éù„Ç§„É≥„ÉàÂè≥'
                    },
                    {
                        x: 46.0, y: 42.6, width: 17.7, height: 17.2,
                        action: 'drum_tap_center',
                        description: 'Âè©„Åè„Éù„Ç§„É≥„Éà‰∏≠Â§Æ'
                    },
                    {
                        x: 90.6, y: 90.6, width: 9.4, height: 9.4,
                        action: 'examine_drum_back',
                        description: 'Êàª„Çã',
                        zIndex: 5,
                        item: {
                            img: 'back',
                            visible: () => true,
                        },
                    },
                ]
            },
            humendai: {
                name: 'Ë≠úÈù¢Âè∞',
                description: '',
                clickableAreas: [
                    {
                        x: 27.0, y: 29.3, width: 47.7, height: 34.3,
                        action: 'examine_humendai_center',
                        description: 'Ë≠úÈù¢Âè∞„ÅÆÂ±±'
                    },
                    {
                        x: 90.6, y: 90.6, width: 9.4, height: 9.4,
                        action: 'examine_drum_back',
                        description: 'Êàª„Çã',
                        zIndex: 5,
                        item: {
                            img: 'back',
                            visible: () => true,
                        },
                    },
                ]
            },
            guitarCase: {
                name: '„ÇÆ„Çø„Éº„Ç±„Éº„Çπ',
                description: '',
                clickableAreas: [
                    {
                        x: 38.9, y: 57.9, width: 19.0, height: 28.9,
                        action: 'examine_guitar_case_score',
                        description: 'Ë≠úÈù¢'
                    },
                    {
                        x: 50.3, y: 44.1, width: 9.9, height: 11.2,
                        action: 'examine_guitar_case_sticker',
                        description: '„Çπ„ÉÜ„ÉÉ„Ç´„Éº'
                    },
                    {
                        x: 90.6, y: 90.6, width: 9.4, height: 9.4,
                        action: 'examine_guitar_case_back',
                        description: 'Êàª„Çã',
                        zIndex: 5,
                        item: {
                            img: 'back',
                            visible: () => true,
                        },
                    },
                ]
            },
            maracas: {
                name: '„Éû„É©„Ç´„Çπ',
                description: '',
                clickableAreas: [
                    { x: 10, y: 84, width: 22, height: 9, action: 'maracas_play', description: 'ÂÜçÁîü', zIndex: 5 },
                    { x: 74, y: 84, width: 10, height: 9, action: 'maracas_back', description: 'Êàª„Çã', zIndex: 5 },
                ]
            },
            ghost: {
                name: '„Åä„Å∞„Åë',
                description: 'Ë∏ä„Å£„Å¶„ÅÑ„Çã',
                clickableAreas: [
                    {
                        x: 90.6, y: 90.6, width: 9.4, height: 9.4,
                        action: 'examine_ghost_back',
                        description: 'Êàª„Çã', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },


            end: {
                name: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ',
                description: 'ËÑ±Âá∫„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„ÉÅ„É£„Ç§„É†„ÇíÁÑ°‰∫ãÈ≥¥„Çâ„Åõ„Åæ„Åó„Åü„Å≠ÔºÅ',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_end',
                        description: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ'
                    },
                ]
            },
            end2: {
                name: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ+',
                description: 'ËÑ±Âá∫„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„ÉÅ„É£„Ç§„É†„ÇíÁÑ°‰∫ãÈ≥¥„Çâ„Åõ„Åæ„Åó„Åü„Å≠ÔºÅ„Éû„É©„Ç´„Çπ„ÉÅ„É£„Éº„É†„ÇÇ‰Ωï„Åã„Å´‰ªò„Åë„Å¶„Å≠',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_end2',
                        description: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ+'
                    },
                ]
            },
            trueEnd: {
                name: 'Â±ã‰∏ä„Å´ËÑ±Âá∫ÊàêÂäü',
                description:
                    '„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅÁßãÊô¥„Çå„ÅÆÁ©∫„Åå„Åô„Åå„Åô„Åå„Åó„ÅÑ„Åß„Åô„Å≠' +
                    '',
                clickableAreas: [{ x: 0, y: 0, width: 100, height: 100, action: 'examine_true_end', description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ' }]
            },
            trueEnd2: {
                name: 'Â±ã‰∏ä„Å´ËÑ±Âá∫ÊàêÂäü',
                description:
                    '„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„Éû„É©„Ç´„Çπ„ÉÅ„É£„Éº„É†„ÇÇ‰Ωï„Åã„Å´‰ªò„Åë„Å¶„Å≠' +
                    '',
                clickableAreas: [
                    // { x: 0, y: 0, width: 100, height: 100, action: 'examine_true_end2', description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ+' }
                    { x: 23.1, y: 18.5, width: 47.2, height: 20.7, action: 'examine_true_end2_hole', description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ+„ÉØ„Éº„Éó„Éõ„Éº„É´' }
                ]
            },
            hakone: {
                name: 'ÁÆ±Ê†π„Å∏„Éà„É™„ÉÉ„ÉóÊàêÂäü',
                description:
                    'ËÑ±Âá∫ÔºÜ„Éà„É™„ÉÉ„ÉóÊàêÂäüÔºÅ „Åù„Åó„Å¶„ÄÅ„Åã„Åæ„Åº„Åì„Å∏‚îÄ‚îÄ„Åì„Åì„Åæ„ÅßÈÅä„Çì„Åß„Åè„Çå„Å¶„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ' +
                    '',
                clickableAreas: [
                    { x: 0, y: 0, width: 100, height: 100, action: 'examine_true_end2', description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ+' }

                ]
            },

        };

        const hintMessages = {
            main: {
                bear: [
                    "Âëº„Çì„Å†Ôºü",
                    "„Åà„Å∏„Å∏",
                    "„Éú„ÇØÊ•ΩÂô®ÂæóÊÑè„Å™„Çì„Å†",
                ],
                bearNormalEnd: [
                    "Â§ñ„Å´Âá∫„Çâ„Çå„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü„Åø„Åü„ÅÑ„Å†„Çà",
                    "„Çà„Åã„Å£„Åü„Å≠„Åà",
                ],
                bearTrueEnd: [
                    "„Åò„Çá„ÅÜ„Åö„Å†„Å£„ÅüÔºü",
                    "„Åà„Å∏„Å∏",
                ],
                bearBachi: [
                    "Âè©„ÅÑ„Åü„Çâ„Å†„ÇÅ„Å†„Çà",
                    "Âè©„ÅÑ„Åü„ÇâÊÄí„Çã„Çà",
                    "„Éú„ÇØÂøçËÄê„ÇíË∫´„Å´„Å§„Åë„Åü„ÅÆ"
                ],

            },
            atticRight: {
                bear: [
                    "‚Ä¶",
                ],

            },

        };

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            renderNavigation();
            changeRoom('mainPiano');
            updateMessage('Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÈü≥Ê•ΩÂÆ§„Å´Èñâ„ÅòËæº„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Åæ„Åó„Åü');
        }

        function findHitArea(x, y, clickableAreas, canvas) {
            // zIndexÈôçÈ†Ü„Åß
            const sorted = clickableAreas.slice().sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            for (const area of sorted) {
                // ÂøÖË¶Å„Å™„ÇâusableÂà§ÂÆö„ÇÇ„Åì„Åì„Åß
                const usable = area.usable === undefined ? true :
                    (typeof area.usable === "function" ? area.usable() : area.usable);

                if (!usable) continue; // ‰Ωø„Åà„Å™„ÅÑ„Ç®„É™„Ç¢„ÅØÂà§ÂÆö„Åó„Å™„ÅÑ
                const ax = area.x / 100 * canvas.width;
                const ay = area.y / 100 * canvas.height;
                const aw = area.width / 100 * canvas.width;
                const ah = area.height / 100 * canvas.height;
                if (x >= ax && x <= ax + aw && y >= ay && y <= ay + ah) {
                    return area; // ÊúÄÂàù„Å´„Éí„ÉÉ„Éà„Åó„Åü„ÇÇ„ÅÆ„Å†„ÅëËøî„ÅôÔºÅ
                }
            }
            return null;
        }

        let hoveredAreaIndex = null;  // ‰ªähover„Åó„Å¶„Çã„Ç®„É™„Ç¢Ôºà„Å™„Åë„Çå„Å∞nullÔºâ
        canvas.addEventListener('mousemove', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);
            const idx = area ? room.clickableAreas.indexOf(area) : null;
            if (hoveredAreaIndex !== idx) {
                hoveredAreaIndex = idx;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('mouseout', function () {
            if (hoveredAreaIndex !== null) {
                hoveredAreaIndex = null;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('click', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // ‚òÖ‰ªä„ÅÑ„ÇãÈÉ®Â±ã„ÅÆ„Ç®„É™„Ç¢„Å†„ÅëÂà§ÂÆöÔºÅ
            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);

            if (area) {
                handleAreaClick(area.action, e);
            }

        });

        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];

            // ËÉåÊôØÔºã„Ç¢„Ç§„ÉÜ„É†Ôºã„ÇØ„É™„ÉÉ„ÇØ„Ç®„É™„Ç¢„Çícanvas„ÅßÂÖ®ÈÉ®ÂÜçÊèèÁîª
            renderCanvasRoom();
            const msg = (room.name && room.name.trim() !== "")
                ? `${room.name}„Åß„Åô„ÄÇ${room.description}`
                : room.description;
            if (roomId === 'trueEnd') {
                updateMessageHTML(msg);
            } else {
                updateMessage(msg);
            }

            // BGMÂàáÊõø„ÅØ„Åù„ÅÆ„Åæ„Åæ
            if (roomId === "trueEnd" || roomId === "trueEnd2") {
                changeBGM("sounds/14/akihasnti.mp3");
                gameState.openRooms = [];
                renderNavigation();
            } else if (roomId === "end" || roomId === "end2") {
                changeBGM("sounds/14/minorinokisetsu.mp3");
                gameState.openRooms = [];
                renderNavigation();
            } else if (roomId === "piano") {
                pauseBGM();
            } else if (roomId === "hakone") {
                changeBGM("sounds/14/1458.mp3");
            } else {
                changeBGM("sounds/14/canvasintheroom.mp3");
            }

            if (roomId === 'maracas') {
                cancelAnimationFrame(_maracasRAF);
                _maracasRAF = requestAnimationFrame(maracasTick);

                // ‚òÖÂÖ•ÂÆ§1.5ÁßíÂæå„Å´Ëá™ÂãïÂÜçÁîü
                clearTimeout(_maracasAutoTimer);
                _maracasAutoTimer = setTimeout(() => {
                    if (gameState.currentRoom === 'maracas' && !gameState.maracas.playing) {
                        _maracasIdx = 0;
                        _maracasCount = 0;
                        gameState.maracas.playing = true;
                        updateMessage('‚Ä¶„Ç∑„É£„Ç´„Ç∑„É£„Ç´‚Ä¶');
                    }
                }, 1500);
            } else {
                cancelAnimationFrame(_maracasRAF);
                clearTimeout(_maracasAutoTimer);
            }

            if (roomId !== 'ghost') {
                cancelAnimationFrame(_ghostRAF);
                ghostLetters = [];
            }


        }

        const END_IDS = new Set(['end', 'trueEnd', 'end2', 'trueEnd2']);

        const _changeRoom_orig = changeRoom;
        changeRoom = function (roomId) {
            _changeRoom_orig.apply(this, arguments);

            if (END_IDS.has(roomId)) {
                const elapsed = Math.round((Date.now() - ANA.start) / 1000);
                ANA.endTimes = ANA.endTimes || {};
                if (!ANA.endTimes[roomId]) ANA.endTimes[roomId] = elapsed;

                const isTrue = (roomId === 'trueEnd' || roomId === 'trueEnd2');
                ANA.send('ending_reached', {
                    ending_id: roomId,
                    is_true: isTrue,
                    elapsed_sec: elapsed,
                    hints: ANA.hintCount,

                });
                // setTimeout(() => showFeedbackModal(roomId), 1500);
            }
        }


        function renderCanvasRoom() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const roomId = gameState.currentRoom;
            const room = rooms[roomId];
            const bgImgSrc = getRoomBackgroundImage(roomId, gameState);

            ctx.clearRect(0, 0, canvas.width, canvas.height);


            // ËÉåÊôØÊèèÁîª
            const bgImg = loadedImages[bgImgSrc];
            if (bgImg && bgImg.complete) {
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            }

            // „Ç¢„Ç§„ÉÜ„É†ÊèèÁîªÔºàÊú™ÂèñÂæó„ÅÆ„ÅøÔºâ
            drawRoomItems(ctx, canvas, roomId);

            // ‚òÖ „Åì„Åì„Åã„ÇâÈáç„Å™„ÇäÂÑ™ÂÖà„ÅÆhoverÊû†Á∑ö„ÇíÊèèÁîª
            if (hoveredAreaIndex !== null && hoveredAreaIndex !== undefined) {
                // zIndexÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
                const sortedAreas = room.clickableAreas
                    .map((area, i) => ({ ...area, __idx: i }))
                    .filter(area => area.usable === undefined ? true :
                        (typeof area.usable === "function" ? area.usable() : area.usable)
                    )
                    .sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
                // hoveredAreaIndex„Å®‰∏ÄËá¥„Åô„Çã„Ç®„É™„Ç¢„ÇízIndexÈ†Ü„Åß1„Å§„Å†„ÅëÊû†ÊèèÁîª
                const hoverArea = sortedAreas.find(area => area.__idx === hoveredAreaIndex);
                if (hoverArea) {
                    const ax = hoverArea.x / 100 * canvas.width;
                    const ay = hoverArea.y / 100 * canvas.height;
                    const aw = hoverArea.width / 100 * canvas.width;
                    const ah = hoverArea.height / 100 * canvas.height;
                    ctx.save();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(ax, ay, aw, ah);
                    ctx.restore();
                }
            }

            if (gameState.currentRoom === 'ghost') {
                drawGhostDance(ctx, canvas, performance.now());
                cancelAnimationFrame(_ghostRAF);
                _ghostRAF = requestAnimationFrame(() => renderCanvasRoom());
            }


        }

        function drawRoomItems(ctx, canvas, roomId) {
            const room = rooms[roomId];
            room.clickableAreas.forEach(area => {
                if (area.item && area.item.visible && area.item.visible()) {
                    const img = loadedImages[IMAGES.items[area.item.img]];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const alpha = area.alpha ? area.alpha : 1;
                        const px = area.x / 100 * canvas.width;
                        const py = area.y / 100 * canvas.height;
                        const w = area.width / 100 * canvas.width;
                        const h = area.height / 100 * canvas.height;
                        ctx.save();
                        ctx.globalAlpha = alpha;
                        ctx.drawImage(img, px, py, w, h);
                        ctx.restore();
                    }
                }
            });
        }


        function getRoomBackgroundImage(roomId, gameState) {
            let state = gameState[roomId]?.flags?.backgroundState || 0;
            let imgList = IMAGES.rooms[roomId];
            if (Array.isArray(imgList)) {
                return imgList[state] || imgList[0];
            } else {
                return imgList;
            }
        }

        // ===== „Éû„É©„Ç´„ÇπÊèèÁîªÔºàproceduralÔºâ =====
        let _maracasRAF = 0;
        let _maracasAutoTimer = 0;
        let _maracasAnimNow = 0;
        let _maracasIdx = 0;   // „Å©„ÅÆ„ÇØ„É©„Çπ„Çø„Åã
        let _maracasCount = 0; // „ÇØ„É©„Çπ„ÇøÂÜÖ„ÅÆ‰ΩïÂõûÁõÆ„Åã
        let _maracasPhase = 0; // ÊåØ„Çä„ÅÆ‰ΩçÁõ∏

        function drawMaraca(ctx, x, y, angle, color) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            // ÊåÅ„Å°Êâã
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(-4, 60, 8, 48);
            // Áéâ
            ctx.fillStyle = color;
            ctx.fillRect(-20, -24, 40, 90);
            // Ê®°Êßò
            ctx.fillStyle = '#fff';
            ctx.fillRect(-20, -6, 40, 6);
            ctx.restore();
        }

        function drawMaracasRoomScene(ctx, canvas) {
            // ËÉåÊôØ„ÅåÁÑ°„ÅÑÂ†¥Âêà„ÅÆ„Éô„ÇøÂ°ó„Çä
            if (!IMAGES.rooms.maracas) {
                ctx.fillStyle = '#0e0e18';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            // ËªΩ„ÅÑ„Ç¨„Ç§„Éâ
            ctx.fillStyle = '#bfc3ff';
            ctx.font = '16px monospace';
            // ctx.fillText('', 20, canvas.height - 20);

            // ËßíÂ∫¶
            const maxAng = 0.33; // ‚âí 19deg
            const angle = Math.sin(_maracasPhase) * maxAng;

            // Â∑¶Âè≥
            const Lx = canvas.width * 0.32, Rx = canvas.width * 0.68, Y = canvas.height * 0.25;
            drawMaraca(ctx, Lx, Y, -angle, '#00c2ff');
            drawMaraca(ctx, Rx, Y, angle, '#ff7a00');

            // --- „Éú„Çø„É≥ÊèèÁîª ---
            ctx.font = '36px sans-serif';     // ‚òÖÊñáÂ≠ó„Çµ„Ç§„Ç∫„Çí2ÂÄç„Å´
            ctx.textBaseline = 'middle';

            // ‚ñ∂ÂÜçÁîü„Éú„Çø„É≥
            const playText = '‚ñ∂ ÂÜçÁîü';
            const playX = canvas.width * 0.12;
            const playY = canvas.height * 0.88;
            const playMetrics = ctx.measureText(playText);
            const playW = playMetrics.width + 24; // ‚òÖ‰ΩôÁôΩ„ÇÇ2ÂÄç
            const playH = 56;                     // ‚òÖÈ´ò„Åï„ÇÇ2ÂÄç
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(playX - 12, playY - playH / 2, playW, playH);
            ctx.fillStyle = '#fff';
            ctx.fillText(playText, playX, playY);

            // Êàª„Çã„Éú„Çø„É≥
            const backText = 'Êàª';
            const backX = canvas.width * 0.76;
            const backY = canvas.height * 0.88;
            const backMetrics = ctx.measureText(backText);
            const backW = backMetrics.width + 24;
            const backH = 56;
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(backX - 12, backY - backH / 2, backW, backH);
            ctx.fillStyle = '#fff';
            ctx.fillText(backText, backX, backY);
        }

        let _lastTime = performance.now();

        function maracasTick(now) {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            renderCanvasRoom();
            if (gameState.currentRoom === 'maracas') {
                drawMaracasRoomScene(ctx, canvas);
            }
            if (gameState.currentRoom !== 'maracas') return;

            if (gameState.maracas.playing) {
                const spd = 0.65;
                const hz = 6 * spd; // 1Áßí„ÅÇ„Åü„Çä„ÅÆÊåØ„Çä„Çµ„Ç§„ÇØ„É´

                const deltaSec = (now - _lastTime) / 1000; 
                _lastTime = now;

                _maracasPhase += (Math.PI * 2) * hz * deltaSec;

                if (Math.sin(_maracasPhase) > 0.98) {
                    _maracasCount++;
                    playSE('se-maracas');
                    const need = gameState.maracas.clusters[_maracasIdx] || 0;
                    if (_maracasCount >= need && need > 0) {
                        _maracasIdx++;
                        _maracasCount = 0;
                        gameState.maracas.playing = false;
                        setTimeout(() => {
                            if (gameState.currentRoom === 'maracas') {
                                if (_maracasIdx < gameState.maracas.clusters.length) {
                                    gameState.maracas.playing = true;
                                } else {
                                    _maracasIdx = 0;
                                    ANA.send('maracas_pattern_done', { seq: gameState.maracas.clusters.join('') });
                                }
                            }
                        }, Math.max(400, 600 / spd));
                    }
                }
            }

            _maracasRAF = requestAnimationFrame(maracasTick);
        }


        let _ghostRAF = 0;
        let ghostLetters = [];
        let ghostLetterIdx = 0;
        let ghostLettersText = 'kane';
        let ghostLastEmit = 0;

        // // Ëßí‰∏∏Áü©ÂΩ¢ÔºàÁ∞°ÊòìÔºâ
        // function roundRect(ctx, x, y, w, h, r) {
        //     const rr = Math.min(r, w / 2, h / 2);
        //     ctx.beginPath();
        //     ctx.moveTo(x + rr, y);
        //     ctx.arcTo(x + w, y, x + w, y + h, rr);
        //     ctx.arcTo(x + w, y + h, x, y + h, rr);
        //     ctx.arcTo(x, y + h, x, y, rr);
        //     ctx.arcTo(x, y, x + w, y, rr);
        //     ctx.closePath();
        // }


        function emitGhostLetter(x, y) {
            if (!ghostLettersText || !ghostLettersText.length) return;
            const ch = ghostLettersText[ghostLetterIdx % ghostLettersText.length];
            ghostLetterIdx++;

            ghostLetters.push({
                ch,
                x: x + (Math.random() * 14 - 7),
                y: y - 110,
                // y: y + (Math.random() * 10 - 5),
                vx: (Math.random() * 0.4 - 0.2),
                vy: -0.6 - Math.random() * 0.6,
                life: 3200,       // ms
                t0: performance.now(),
                rot: (Math.random() * 0.3 - 0.15),
                spin: (Math.random() * 0.02 - 0.01),
                scale: 0.9 + Math.random() * 0.25,
                hue: 200 + Math.random() * 40   // ÈùíÁ≥ª
            });
        }

        function updateGhostLetters(now) {
            ghostLetters = ghostLetters.filter(p => {
                const dt = now - p.t0;
                if (dt > p.life) return false;
                p.vy += 0.004;
                p.x += p.vx;
                p.y += p.vy * 0.35;
                p.rot += p.spin;
                return true;
            });
        }

        function drawGhostLetters(ctx, now) {
            const maxSimul = 1; // ÂêåÊôÇ„Å´Ë¶ã„Åà„ÇãÊï∞

            const visible = ghostLetters.slice(-maxSimul);

            for (const p of visible) {
                const dt = now - p.t0;
                const a = 1 - (dt / p.life);         // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot);
                ctx.scale(p.scale, p.scale);
                ctx.globalAlpha = Math.max(0, a);

                // ÊñáÂ≠óÊèèÁîªÔºàËº™ÈÉ≠ÔºãÂ°ó„Çä„Å§„Å∂„ÅóÔºâ
                ctx.font = 'bold 60px sans-serif';
                ctx.lineWidth = 3;
                ctx.strokeStyle = `hsl(${p.hue} 80% 30%)`;
                ctx.fillStyle = `hsl(${p.hue} 90% 65%)`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(p.ch, 0, 0);
                ctx.fillText(p.ch, 0, 0);

                ctx.restore();
            }
        }


        function drawGhostDance(ctx, canvas, now) {
            const img = loadedImages[IMAGES.items.ghost2];
            if (!img || !img.complete) return;

            const baseX = canvas.width * 0.62;
            const baseY = canvas.height * 0.38;

            const sway = Math.sin(now * 0.004) * 10;
            const bob = Math.sin(now * 0.003 + 1.2) * 6;
            const rot = Math.sin(now * 0.005) * 0.05;
            const scale = 1 + Math.sin(now * 0.006) * 0.04;

            const x = baseX + sway, y = baseY + bob;
            const w = canvas.width * 0.48, h = w * (img.height / img.width);

            // „Ç¥„Éº„Çπ„ÉàÊú¨‰Ωì
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(rot);
            ctx.scale(scale, scale);
            ctx.drawImage(img, -w / 2, -h / 2, w, h);
            ctx.restore();

            // --- „Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÁô∫ÁîüÔºàÁ¥Ñ150msÈñìÈöî / ÂêåÊôÇ5ÊñáÂ≠óÁ®ãÂ∫¶Ôºâ ---
            if (now - ghostLastEmit > 200 && ghostLetters.length < 4) {
                ghostLastEmit = now;
                // Âè≥‰∏äÔºÜÂ∑¶‰∏ä„ÅÇ„Åü„Çä„Åã„Çâ1„Äú2ÂÄã„Åö„Å§
                emitGhostLetter(x + w * 0.18, y - h * 0.08);
                // if (Math.random() < 0.5) emitGhostLetter(x - w * 0.12, y - h * 0.10);
                // emitGhostLetter(x - w * 0.12, y - h * 0.10);
            }

            updateGhostLetters(now);
            drawGhostLetters(ctx, now);
        }







        // Â∞èÁâ©„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function pointInRect(x, y, r) {
            return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;
        }

        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
            ctx.beginPath();
            ctx.moveTo(x + r.tl, y);
            ctx.lineTo(x + w - r.tr, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
            ctx.lineTo(x + w, y + h - r.br);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
            ctx.lineTo(x + r.bl, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
            ctx.lineTo(x, y + r.tl);
            ctx.quadraticCurveTo(x, y, x + r.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }


        let _ghostFadeRAF = 0;

        function startGhostFadeOut(duration = 1600) {
            // mainDrum „ÅÆ„Ç¥„Éº„Çπ„Éà„Ç®„É™„Ç¢„ÇíÂèñÂæó
            const room = rooms.mainDrum;
            const ghostArea = room.clickableAreas.find(a => a.action === 'examine_main_drum_ghost');
            if (!ghostArea) return;

            ghostArea.alpha = 1;

            const t0 = performance.now();
            const startY = ghostArea.y;
            const rise = 6;

            cancelAnimationFrame(_ghostFadeRAF);

            const tick = (now) => {
                const t = Math.min(1, (now - t0) / duration);
                // „Ç§„Éº„Ç∏„É≥„Ç∞Ôºà„ÅäÂ•Ω„Åø„ÅßÔºâ
                const ease = 1 - Math.pow(1 - t, 3); // easeOutCubic

                // ÈÄèÊòéÂ∫¶„ÇíËêΩ„Å®„Åô & ‰ΩçÁΩÆ„ÇíÂ∞ë„Åó‰∏ä„Åí„Çã
                ghostArea.alpha = 1 - ease;
                ghostArea.y = startY - rise * ease;

                renderCanvasRoom();

                if (t < 1) {
                    _ghostFadeRAF = requestAnimationFrame(tick);
                } else {
                    // ÊèèÁîª„ÇíÊ∂à„Åó„ÄÅ‰ª•ÂæåÂá∫„Å¶„Åì„Å™„ÅÑ„Çà„ÅÜ„Éï„É©„Ç∞ON
                    delete ghostArea.alpha;
                    ghostArea.y = startY;
                    gameState.main.flags.ghostDisappeared = true;
                    renderCanvasRoom();
                }
            };

            _ghostFadeRAF = requestAnimationFrame(tick);
        }


        function _tryOpenSafeCenter() {
            if (gameState.main.flags.safeCenterOpened) return;
            const ok = gameState.safeCenter.counts.every(
                (v, i) => v === gameState.safeCenter.target[i]
            );
            if (ok) {
                gameState.main.flags.safeCenterOpened = true;
                playSE('se-gacha');
                showModal(
                    'ÈáëÂ∫´„ÅåÈñã„ÅÑ„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
            }
        }

        function checkPianoSequence(note) {
            // Ë§áÊï∞„Ç∑„Éº„Ç±„É≥„Çπ„ÇíÂæåÊñπ‰∏ÄËá¥„ÅßÂà§ÂÆö„Åô„Çã„Åü„ÇÅÊúÄÂ§ß8Èü≥‰øùÊåÅ
            const seq = gameState.main.flags.pianoSeq;
            seq.push(note);
            const MAX_LEN = 8;
            if (seq.length > MAX_LEN) seq.splice(0, seq.length - MAX_LEN);

            // „Éò„É´„Éë
            function endsWith(target) {
                if (seq.length < target.length) return false;
                for (let i = 0; i < target.length; i++) {
                    if (seq[seq.length - target.length + i] !== target[i]) return false;
                }
                return true;
            }

            // „Å©„Çì„Åê„ÇäÈçµ
            const TARGET_DONGURI = ['so', 'mi', 'mi', 're'];
            if (!gameState.main.flags.foundDonguriKey && endsWith(TARGET_DONGURI)) {
                gameState.main.flags.foundDonguriKey = true;
                showModal(
                    '„Å™„Å´„ÅãËêΩ„Å°„Å¶„Åç„Åü„Çà„ÅÜ„Å™Èü≥„Åå„Åó„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                updateMessage("„Å™„Å´„ÅãËêΩ„Å°„Å¶„Åç„Åü„Çà„ÅÜ„Å™Èü≥„Åå„Åó„Åü");
                playSE('se-donguri');
                playSE('se-down');
                return;
            }

            // „Éâ„Ç¢Ëß£Èå†
            const TARGET_UNLOCK = ['ra', 'fa', 'so', 'do'];
            if (!gameState.main.flags.unlockDoor && endsWith(TARGET_UNLOCK)) {
                gameState.main.flags.unlockDoor = true;
                playSE && playSE('se-chime');
                showModal('„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„ÅüÊ∞óÈÖç„Åå„Åô„Çã„ÄÇ', '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                updateMessage('„Éâ„Ç¢„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü„Çà„ÅÜ„Å†');
                return;
            }

            // „ÇØ„ÉûÂ¶ñÁ≤æÂá∫Áèæ
            const TARGET_BEAR = ['mi', 're', 'do', 're', 'so', 'ra', 'so', 'mi'];
            if (!gameState.main.flags.wakeupBear && gameState.main.flags.ghostMoved && endsWith(TARGET_BEAR)) {
                gameState.main.flags.wakeupBear = true;
                playSE && playSE('se-kumasan');
                markProgress('morino_kumasan');
                showModal('„Å©„Åì„Åã„Çâ„Åã„ÄåÂëº„Çì„Å†Ôºü„Äç„Å®„ÅÑ„ÅÜÂ£∞„Åå„Åó„Åü', '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                renderCanvasRoom();
                return;
            }
        }


        // ---- Â§™Èºì„Ç∑„Éº„Ç±„É≥„ÇπÂà§ÂÆö ----
        function drumPush(step) {
            const target = ['left', 'bellow', 'left', 'center', 'above', 'center'];
            const arr = gameState.main.flags.drumSeq;

            arr.push(step);
            if (arr.length > target.length) arr.shift();

            // „Çø„ÉÉ„ÉóÈü≥
            switch (step) {
                case 'left':
                    playSE('se-drum1');
                    break;
                case 'bellow':
                    playSE('se-drum2');
                    break;
                case 'right':
                    playSE('se-drum3');
                    break;
                case 'above':
                    playSE('se-drum4');
                    break;
                case 'center':
                    playSE('se-drum5');
                    break;
            }

            if (arr.join(',') === target.join(',')) {
                // ÊàêÂäüÔºÅ
                gameState.main.flags.drumSeq = []; // „ÇØ„É™„Ç¢
                if (!gameState.main.flags.ghostMoved) {
                    gameState.main.flags.ghostMoved = true;
                    showModal(
                        '!',
                        `<img src="${IMAGES.modals.drumGhost}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('Â§™Èºì„ÅÆÈüø„Åç„Å´È©ö„ÅÑ„Å¶„ÄÅ„Éû„É©„Ç´„Çπ„Åä„Å∞„Åë„ÅåÁßªÂãï„Åó„Å¶„Åç„Åü');
                    playSE('se-clear');
                    markProgress('ghost_moved');

                    // changeRoom('mainDoor');
                }
            }
        }

        // „Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleAreaClick(action, event) {
            const f = gameState.main.flags;
            switch (action) {
                case 'examine_main_kokuban_kashi':
                    showModal(
                        '',
                        `<img src="${IMAGES.modals.kashi}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_main_kokuban_tani':
                    if (f.clearFog) {
                        showModal(
                            'Ë∞∑„ÅÆÁµµ',
                            `<img src="${IMAGES.items.tani}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                    } else {
                        updateMessage('Ë∞∑„ÅÆÁµµ„ÅåÊèè„Åã„Çå„Å¶„ÅÑ„Çã');
                    }

                    break;
                case 'examine_main_kokuban_donguri':
                    showModal(
                        '',
                        `<img src="${IMAGES.modals.picDonguri}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_main_kokuban_bear':
                    showModal(
                        '',
                        `<img src="${IMAGES.modals.bearBoard}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_main_fog':
                    if (gameState.selectedItem === 'harmonica') {
                        // È¢®„ÅÆ„Éè„Éº„É¢„Éã„Ç´‰ΩøÁî®ÊôÇ„ÅÆÈúß„ÅåÊô¥„Çå„ÇãÊºîÂá∫
                        playSE('se-harmonica');


                        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                        updateMessage('È¢®„ÅÆ„Éè„Éº„É¢„Éã„Ç´„ÇíÂêπ„ÅÑ„Åü„ÄÇ‚ô™ÔΩû‚ô™‚ô™');

                        gameState.main.flags.clearFog = true;

                        const ctx = canvas.getContext('2d');
                        let alpha = 1.0;
                        function fadeFog() {
                            renderCanvasRoom(); // ÈÄöÂ∏∏ÊèèÁîª
                            const fogImg = loadedImages[IMAGES.items.fog];
                            if (fogImg && fogImg.complete) {
                                ctx.save();
                                ctx.globalAlpha = alpha;
                                ctx.drawImage(fogImg, canvas.width * 0.329, canvas.height * 0.427, canvas.width * 0.481, canvas.height * 0.339);
                                ctx.restore();
                            }
                            alpha -= 0.05;
                            if (alpha > 0) {
                                requestAnimationFrame(fadeFog);
                            } else {
                                renderCanvasRoom();
                                updateMessage('È¢®„ÅÆ„Éè„Éº„É¢„Éã„Ç´„ÇíÂêπ„Åè„Å®„ÄÅÈúß„ÅåÈ¢®„Å´Âêπ„ÅçÈ£õ„Å∞„Åï„Çå„Å¶„ÅÑ„Å£„Åü‚Ä¶„ÄÇÈ¢®„ÅÆ„Éè„Éº„É¢„Éã„Ç´„ÅØÈ¢®„ÅÆÂäõ„ÇíÂ§±„Å£„Åü„ÄÇ');
                                removeItem('harmonica');
                                addItem('harmonicaNormal');
                                markProgress('harmonica_use');
                            }
                        }
                        setTimeout(() => fadeFog(), 1500);

                        return;
                    } else {
                        updateMessage('Èúß„ÅåÁ´ã„Å°Ëæº„ÇÅ„Å¶„ÅÑ„Å¶„ÄÅ„Çà„ÅèË¶ã„Åà„Å™„ÅÑ‚Ä¶');
                    }
                    break;
                case 'examine_main_piano_kenban':
                    changeRoom('piano');
                    break;
                case 'examine_main_piano_beethoven':
                    showModal(
                        '„Éô„Éº„Éà„Éº„É¥„Çß„É≥„ÅÆËÇñÂÉè„Å†',
                        `<img src="${IMAGES.modals.beethoven}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('„Éô„Éº„Éà„Éº„É¥„Çß„É≥„ÅÆËÇñÂÉè„Å†');
                    break;
                case 'examine_main_piano_mozart':
                    showModal(
                        '„É¢„Éº„ÉÑ„Ç°„É´„Éà„ÅÆËÇñÂÉè„Å†',
                        `<img src="${IMAGES.modals.mozart}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('„É¢„Éº„ÉÑ„Ç°„É´„Éà„ÅÆËÇñÂÉè„Å†');
                    break;
                case 'examine_main_piano_chopin':
                    showModal(
                        '„Ç∑„Éß„Éë„É≥„ÅÆËÇñÂÉè„Å†',
                        `<img src="${IMAGES.modals.chopin}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('„Ç∑„Éß„Éë„É≥„ÅÆËÇñÂÉè„Å†');
                    break;
                case 'examine_main_piano_donguri_key':
                    addItem('keyDonguri');
                    gameState.main.flags.foundDonguri = true;
                    updateMessage("„Å©„Çì„Åê„Çä„ÇíÊâã„Å´ÂÖ•„Çå„Åü");
                    renderCanvasRoom();
                    break;
                case 'examine_main_piano_door':
                    handleDoor();
                    break;
                // mainWindow
                case 'examine_main_window_case1':
                    updateMessage("Ë™∞„Åã„ÅÆÊ•ΩÂô®„Ç±„Éº„Çπ„Å†");
                    break;
                case 'examine_main_window_case2':
                    updateMessage("Ë™∞„Åã„ÅÆÊ•ΩÂô®„Ç±„Éº„Çπ„Å†");
                    break;
                case 'examine_main_window_case3':
                    updateMessage("Ë™∞„Åã„ÅÆÊ•ΩÂô®„Ç±„Éº„Çπ„Å†");
                    break;
                case 'examine_main_window_case4':
                    if (gameState.main.flags.unlockBox && !gameState.main.flags.foundKey) {
                        gameState.main.flags.foundKey = true;
                        addItem('key');
                        updateMessage('„Ç´„ÇÆ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                    } else if (gameState.main.flags.unlockBox && gameState.main.flags.ghostMoved && gameState.selectedItem == 'bachi') {
                        updateMessage('„Å∞„Å°„Çí„Åä„Å®„Åó„ÇÇ„ÅÆ„Å∞„Åì„Å´ÂÖ•„Çå„Åü');
                        removeItem('bachi');
                        addItem('coin');
                        gameState.main.flags.putBachi = true;
                        showModal(
                            '„Å∞„Å°„Çí„Åä„Å®„Åó„ÇÇ„ÅÆ„Å∞„Åì„Å´ÂÖ•„Çå„Çã„Å®„ÄÅ„Ç≥„Ç§„É≥„ÅåËêΩ„Å°„Å¶„Åç„Åü„ÄÇ<br>„Äå„ÅÇ„Å™„Åü„ÅÆË¶™ÂàáÂøÉ„Å´Â†±„ÅÑ„Çí‚Ä¶„Äç',
                            `<img src="${IMAGES.modals.otoshimonoCoin}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                    } else if (gameState.main.flags.unlockBox && gameState.main.flags.putBachi) {
                        updateMessage('„Åä„Å®„Åó„ÇÇ„ÅÆ„Å∞„Åì„Å´„ÅØ„ÄÅÂ§™Èºì„ÅÆ„Å∞„Å°„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã');
                    } else if (gameState.main.flags.unlockBox) {
                        updateMessage('„Åä„Å®„Åó„ÇÇ„ÅÆ„Å∞„Åì„Å´„ÅØ„ÄÅ‰Ωï„ÇÇÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑ');
                    } else {
                        showboxPuzzle();
                        updateMessage("ËêΩ„Å®„ÅóÁâ©ÁÆ±„Å†„ÄÇ„É≠„ÉÉ„ÇØ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã");
                    }

                    break;

                case 'examine_main_window_cloud':
                    addItem('cloudSeal');
                    gameState.main.flags.foundCloudSeal = true;
                    updateMessage("Èõ≤„ÅÆ„Ç∑„Éº„É´„ÇíÊâã„Å´ÂÖ•„Çå„Åü");
                    renderCanvasRoom();
                    break;
                case 'examine_main_window_zoom':
                    showModal(
                        '',
                        `<img src="${IMAGES.modals.windowZoom}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_main_window_safe_center':
                    if (!f.safeCenterOpened) {
                        changeRoom('safeCenter');
                    } else {
                        updateMessage('ÈáëÂ∫´„ÅØ„Åô„Åß„Å´Èñã„ÅÑ„Å¶„ÅÑ„Çã');
                    }
                    break;
                case 'examine_main_window_safe_left':
                    if (gameState.selectedItem == 'keyDonguri') {
                        removeItem('keyDonguri');
                        f.safeLeftOpend = true;
                        showModal(
                            '„Åè„Åº„Åø„Å´„Å©„Çì„Åê„Çä„ÇíÂµå„ÇÅËæº„Çì„Å†„ÄÇ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü„Çà„ÅÜ„Å†',
                            `<img src="${IMAGES.modals.safeLeftClosedDonguri}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        playSE('se-gacha');
                        updateMessage('„Åè„Åº„Åø„Å´„Å©„Çì„Åê„Çä„ÇíÂµå„ÇÅËæº„Çì„Å†„ÄÇ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü„Çà„ÅÜ„Å†');
                    }
                    if (!f.safeLeftOpend) {
                        showModal(
                            'Èñã„Åã„Å™„ÅÑ„ÄÇÊââ„Å´Â¶ô„Å™ÂΩ¢„ÅÆ„Åè„Åº„Åø„Åå„ÅÇ„Çã',
                            `<img src="${IMAGES.items.safeLeftClosed}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                    } else {
                        updateMessage('ÈáëÂ∫´„ÅØ„Åô„Åß„Å´Èñã„ÅÑ„Å¶„ÅÑ„Çã');
                    }
                    break;
                case 'examine_main_window_harmonica':
                    if (!f.foundHarmonica) {
                        addItem('harmonica');
                        updateMessage('È¢®„ÅÆ„Éè„Éº„É¢„Éã„Ç´„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        f.foundHarmonica = true;
                        renderCanvasRoom();
                    }
                    break;
                case 'examine_main_window_bachi':
                    if (!f.foundBachi) {
                        addItem('bachi');
                        updateMessage('Â§™Èºì„ÅÆ„Å∞„Å°(Âè©„ÅèÊ£í)„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        f.foundBachi = true;
                        renderCanvasRoom();
                    }
                    break;
                case 'examine_main_window_maracas_beam_left':
                    updateMessage('„Éû„É©„Ç´„Çπ„Éì„Éº„É†„Å†');
                    break;
                case 'examine_main_window_maracas_beam_right':
                    updateMessage('„Éû„É©„Ç´„Çπ„Éì„Éº„É†„Å†„ÄÇ„Éâ„Ç¢„ÅÆ„Åª„ÅÜ„Å´Âêë„Åã„Å£„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†');
                    break;
                case 'examine_main_window_maracas':
                    updateMessage('„Éû„É©„Ç´„Çπ„Å†„ÄÇ');
                    showModal(
                        '',
                        `<img src="${IMAGES.modals.maracasOnfloor}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    gameState.main.flags.foundMaracasMemo = true;
                    break;
                // mainDoor
                case 'examine_main_door':
                    if (gameState.main.flags.unlockDoor) {
                        handleDoor();
                    } else {
                        updateMessage('Èñã„Åã„Å™„ÅÑ');
                    }
                    break;
                case 'examine_main_piano_key':
                    changeRoom('piano');
                    break;
                case 'examine_door_beam':
                    updateMessage('Ë¨é„ÅÆÂÖâ„Å´Èòª„Åæ„Çå„Å¶Ëøë„Å•„Åë„Å™„ÅÑ');
                    break;
                case 'examine_door':
                    if (gameState.main.flags.unlockDoor) {
                        handleDoor();
                    } else {
                        updateMessage('Èñã„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');
                    }
                    break;
                case 'examine_door_guitar_case_left':
                    if (gameState.main.flags.foundMaracasMemo) {
                        // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                        showModal(
                            "Ê•ΩÂô®„Ç±„Éº„Çπ",
                            "„Éû„É©„Ç´„Çπ„Å®Âêå„Åò„Ç§„Éã„Ç∑„É£„É´„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã„ÄÇ„ÇÇ„ÅÜÂ∞ë„ÅóË™ø„Åπ„Å¶„Åø„Åæ„Åô„ÅãÔºü",
                            [
                                { text: "„ÅØ„ÅÑ", action: () => { closeModal(); changeRoom("guitarCase"); } },
                                { text: "„ÅÑ„ÅÑ„Åà", action: "close" }
                            ]
                        );
                    } else {
                        updateMessage('‰Ωø„ÅÑËæº„Åæ„Çå„Åü„ÇÆ„Çø„Éº„Ç±„Éº„Çπ„Å†„ÄÇT.K„Å®„Ç§„Éã„Ç∑„É£„É´„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã');
                    }
                    break;


                case 'examine_door_guitar_case_right':
                    updateMessage('„ÇÆ„Çø„Éº„Ç±„Éº„Çπ„Å†');
                    break;
                case 'examine_door_poster_cloud':
                    showModal(
                        '',
                        `<img src="${IMAGES.items.posterCloud}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_door_poster_ongaku':
                    showModal(
                        '',
                        `<img src="${IMAGES.items.posterOngaku}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_door_poster_hakone':
                    showModal(
                        '',
                        `<img src="${IMAGES.items.posterHakone}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                // mainDrum
                case 'examine_main_drum': {
                    if (gameState.selectedItem === 'bachi' || gameState.main.flags.foundBachi) {
                        updateMessage('„Å∞„Å°„ÇíÊâã„Å´Âèñ„Çä„ÄÅÂ§™Èºì„ÅÆÂâç„Å´Á´ã„Å£„Åü„ÄÇ');
                        changeRoom('drum');
                    } else {
                        updateMessage('Á¥†Êâã„Åß„ÅØ„ÅÜ„Åæ„ÅèÂè©„Åë„Å™„ÅÑ‚Ä¶„Å∞„Å°„ÅåÂøÖË¶Å„Å†„ÄÇ');
                    }
                    break;
                }
                case 'drum_tap_left': drumPush('left'); break;
                case 'drum_tap_bellow': drumPush('bellow'); break;
                case 'drum_tap_center': drumPush('center'); break;
                case 'drum_tap_above': drumPush('above'); break;
                case 'drum_tap_right': drumPush('right'); break;

                case 'examine_drum_back':
                    changeRoom('mainDrum');
                    break;
                case 'examine_main_drum_ghost':
                    updateMessage('„Åä„Å∞„Åë„Åå„ÅÜ„Çå„Åó„Åù„ÅÜ„Å´Ë∏ä„Å£„Å¶„ÅÑ„Çã‚Ä¶');
                    changeRoom('ghost');
                    break;
                case 'examine_ghost_back':
                    changeRoom('mainDrum');
                    break;
                case 'examine_main_drum_bach':
                    if (gameState.selectedItem == 'bachi') {
                        showModal(
                            'BAD END\n„ÅÇ„Å™„Åü„ÅØÈü≥Ê•Ω„ÅÆÁà∂„Å´‰∏çÊï¨„Å™Ë°åÁÇ∫„Çí„Åó„Åü„ÄÇ<br>„Éê„ÉÉ„Éè„Å´ÊÄí„Çâ„Çå„Å¶Ê∞ó„ÇíÂ§±„Å£„Åü',
                            `<img src="${IMAGES.modals.badend}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart' }]
                        );
                        playSE('se-gaan');
                    } else {
                        showModal(
                            '„Éê„ÉÉ„Éè„ÅÆËÇñÂÉè„Å†',
                            `<img src="${IMAGES.modals.bach}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('„Éê„ÉÉ„Éè„ÅÆËÇñÂÉè„Å†');
                    }

                    break;
                case 'examine_main_drum_brahms':
                    showModal(
                        '„Éñ„É©„Éº„É†„Çπ„ÅÆËÇñÂÉè„Å†',
                        `<img src="${IMAGES.modals.brahms}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('„Éñ„É©„Éº„É†„Çπ„ÅÆËÇñÂÉè„Å†');
                    break;
                case 'examine_main_drum_taki':
                    showModal(
                        'ÁÄßÂªâÂ§™ÈÉé„ÅÆËÇñÂÉè„Å†',
                        `<img src="${IMAGES.modals.taki}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('ÁÄßÂªâÂ§™ÈÉé„ÅÆËÇñÂÉè„Å†');
                    break;
                case 'examine_main_drum_humendai':
                    if (gameState.main.flags.ghostMoved && gameState.selectedItem == 'score') {
                        updateMessage('Ê•ΩË≠ú„ÇíË≠úÈù¢Âè∞„Å´ÁΩÆ„ÅÑ„Åü');
                        gameState.main.flags.setScore = true;
                        removeItem('score');
                        renderCanvasRoom();
                    } else if (gameState.main.flags.ghostMoved && !gameState.main.flags.setScore) {
                        updateMessage('Ê•ΩË≠ú„Åå„ÅÇ„Çå„Å∞ÁΩÆ„Åë„Åù„ÅÜ„Å†');
                    } else if (gameState.main.flags.ghostMoved && gameState.main.flags.setScore) {
                        updateMessage('Ê•ΩË≠ú„ÅåÁΩÆ„ÅÑ„Å¶„ÅÇ„Çã');
                    } else {
                        changeRoom('humendai');
                    }

                    break;
                case 'examine_humendai_center':
                    if (gameState.selectedItem == 'cloudSeal') {
                        gameState.humendai.flags.backgroundState = 1;
                        removeItem('cloudSeal');
                        renderCanvasRoom();
                        updateMessage('Èõ≤„Ç∑„Éº„É´„ÇíË≤º„Å£„Å¶„Åø„Åü');
                    } else {
                        updateMessage('Â±±„ÅÆÁµµ„ÅåÊèè„Åã„Çå„ÅüÁ¥ô„Åå„ÅÇ„Çã');
                    }
                    break;
                // guitarCase
                case 'examine_guitar_case_score':
                    if (gameState.selectedItem == 'key' && !gameState.main.flags.foundScore) {
                        gameState.main.flags.foundScore = true;
                        addItem('score');
                        removeItem('key');
                        renderCanvasRoom();
                        updateMessage('Ê•ΩË≠ú„ÇíË¶ã„Å§„Åë„Åü');
                    } else if (!gameState.main.flags.foundScore) {
                        updateMessage('„Ç´„ÇÆ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                    } else {
                        updateMessage('„Å™„Å´„ÇÇ„Å™„ÅÑ');
                    }
                    break;
                case 'examine_guitar_case_sticker':
                    showModal(
                        '„Çπ„ÉÜ„ÉÉ„Ç´„Éº„Å†',
                        `<img src="${IMAGES.modals.bearSticker}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_guitar_case_back':
                    changeRoom('mainDoor');
                    break;

                case 'examine_main_drum_bear':
                    if (gameState.selectedItem == 'coin') {
                        gameState.main.flags.gotMaracas = true;
                        removeItem('coin');
                        addItem('bearMaracas');
                        showModal(
                            '„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ„Åì„Çå„ÅÇ„Åí„Çã',
                            `<img src="${IMAGES.modals.bearMaracasGiving}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('„Éû„É©„Ç´„Çπ„ÉÅ„É£„Éº„É†„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        break;
                    }
                    if (gameState.main.flags.unlockDoor) {
                        talkToHintCharacter('main', 'bearNormalEnd');
                        break;
                    }
                    if (gameState.flags.trueEndUnlocked) {
                        talkToHintCharacter('main', 'bearTrueEnd');
                        break;
                    }
                    if (gameState.selectedItem == 'bearMaracas') {
                        showModal(
                            'BAD END\n„ÅÇ„Å™„Åü„ÅØ„ÇÇ„Çâ„Å£„Åü„Éû„É©„Ç´„Çπ„ÉÅ„É£„Éº„É†„Åß„ÇØ„ÉûÂ¶ñÁ≤æ„Çí„Åü„Åü„Åì„ÅÜ„Å®„Åó„Åü„ÄÇ<br>„ÇØ„ÉûÂ¶ñÁ≤æ„Å´ÊÄí„Çâ„Çå„Å¶Ê∞ó„ÇíÂ§±„Å£„Åü',
                            `<img src="${IMAGES.modals.badendBear}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart' }]
                        );
                        playSE('se-gaan');
                        break;
                    }
                    if (gameState.selectedItem == 'bachi') {
                        talkToHintCharacter('main', 'bearBachi');
                        break;
                    }
                    if (gameState.main.flags.setScore && gameState.selectedItem == 'harmonicaNormal') {
                        window._nextModal = {
                            title: '„Éû„É©„Ç´„Çπ„Åä„Å∞„Åë„ÅåÊòáÂ§©„Åó„Å¶„ÅÑ„Åè‚Ä¶',
                            content: `<img src="${IMAGES.modals.bearPlayHarmonica}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            buttons: [{ text: 'Èñâ„Åò„Çã', action: 'close' }],


                        };
                        gameState.flags.trueEndUnlocked = true;
                        let needCloses = 2; // 1ÊûöÁõÆÔºàÂèó„ÅëÂèñ„ÇäÔºâ‚Üí2ÊûöÁõÆÔºàÊòáÂ§©Ôºâ
                        const onClosed = () => {
                            if (--needCloses === 0) {
                                window.removeEventListener('modal:closed', onClosed);
                                startGhostFadeOut(2600);
                                playSE('se-change');
                            }
                        };
                        window.addEventListener('modal:closed', onClosed);
                        showModal('„Åµ„Åµ„Çì„ÄÇ„Éú„ÇØ„Éè„Éº„É¢„Éã„Ç´Âêπ„Åë„Çã„Çì„Å†„Çà', `<img src="${IMAGES.modals.bearReceiveHarmonica}" style="width:300px;display:block;margin:0 auto 20px;">`, [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                        updateMessage('„Éû„É©„Ç´„Çπ„Åä„Å∞„Åë„ÅåÊòáÂ§©„Åó„Åü„ÄÇ„Éî„Ç¢„Éé„ÅÆ„Åª„ÅÜ„ÅßÈü≥„Åå„Åó„Åü„Çà„ÅÜ„Å†');

                        removeItem('harmonicaNormal');
                        setTimeout(() => playSE('se-hakone'), 1500);
                        markProgress('bear_play_harmonica');
                        renderCanvasRoom();
                    } else if (!gameState.main.flags.setScore && gameState.selectedItem == 'harmonicaNormal') {
                        updateMessage('Ê•ΩË≠ú„Åå„ÅÇ„Çå„Å∞„Å™„ÅÇ');
                    } else if (gameState.selectedItem == 'score') {
                        updateMessage('„Åº„ÇÑ„Åë„Å¶„Çã„Åë„Å©„ÄÅ„Éú„ÇØ„ÅÆÂ¶ñÁ≤æ„ÅÆ„Å°„Åã„Çâ„ÅßË™≠„ÇÅ„Çã„Çà');
                    } else {
                        talkToHintCharacter('main', 'bear');
                    }
                    break;

                // ÁßªÂãï
                case 'examine_main_piano_right':
                    changeRoom('mainDoor');
                    break;
                case 'examine_main_piano_left':
                    changeRoom('mainWindow');
                    break;
                case 'examine_main_window_right':
                    changeRoom('mainPiano');
                    break;
                case 'examine_main_window_left':
                    changeRoom('mainDrum');
                    break;
                case 'examine_main_drum_right':
                    changeRoom('mainWindow');
                    break;
                case 'examine_main_drum_left':
                    changeRoom('mainDoor');
                    break;
                case 'examine_main_door_right':
                    changeRoom('mainDrum');
                    break;
                case 'examine_main_door_left':
                    changeRoom('mainPiano');
                    break;
                // piano
                case 'examine_piano_do':
                    playSE('se-do');
                    checkPianoSequence('do');
                    break;
                case 'examine_piano_re':
                    playSE('se-re');
                    checkPianoSequence('re');
                    break;
                case 'examine_piano_mi':
                    playSE('se-mi');
                    checkPianoSequence('mi');
                    break;
                case 'examine_piano_fa':
                    playSE('se-fa');
                    checkPianoSequence('fa');
                    break;
                case 'examine_piano_so':
                    playSE('se-so');
                    checkPianoSequence('so');
                    break;
                case 'examine_piano_ra':
                    playSE('se-ra');
                    checkPianoSequence('ra');
                    break;
                case 'examine_piano_shi':
                    playSE('se-shi');
                    checkPianoSequence('shi');
                    break;
                case 'examine_piano_do2':
                    playSE('se-do2');
                    checkPianoSequence('do2');
                    break;
                case 'examine_piano_back':
                    changeRoom('mainPiano');
                    break;
                // safeCenter
                case 'examine_safe_center_1':
                case 'examine_safe_center_2':
                case 'examine_safe_center_3':
                case 'examine_safe_center_4':
                case 'examine_safe_center_5': {
                    if (f.safeCenterOpened) return;
                    playSE('se-maracas');
                    const idx = parseInt(action.split('_').pop(), 10) - 1;
                    gameState.safeCenter.counts[idx]++;

                    // „Ç™„Éº„Éê„Éº„Åó„Åü„Çâ„É™„Çª„ÉÉ„Éà
                    if (gameState.safeCenter.counts[idx] > gameState.safeCenter.target[idx]) {
                        playSE('se-error');
                        gameState.safeCenter.counts = [0, 0, 0, 0, 0];
                        updateMessage('„ÇÑ„ÇäÁõ¥„Åó„Å†„ÄÇ');
                    } else {
                        // ÁõÆÊ®ô„Å´‰∏ÄËá¥„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                        _tryOpenSafeCenter();
                    }
                    break;
                }
                case 'examine_safe_center_lever':
                    if (f.safeCenterOpened) {
                        playSE('se-gacha');
                        changeRoom('mainWindow');
                    } else {
                        updateMessage('Èñã„Åã„Å™„ÅÑ');
                    }
                    break;
                case 'examine_safe_center_back':
                    gameState.safeCenter.counts = [0, 0, 0, 0, 0];
                    changeRoom('mainWindow');
                    break;

                // === „Éû„É©„Ç´„ÇπÂ∞éÁ∑ö ===
                case 'enter_maracas':
                    changeRoom('maracas');
                    updateMessage('„Éû„É©„Ç´„Çπ„Åä„Å∞„Åë„Å†„ÄÇ');
                    break;

                case 'maracas_play':
                    // ÂÜçÁîü„ÇíÊúÄÂàù„Åã„Çâ
                    _maracasIdx = 0;
                    _maracasCount = 0;
                    gameState.maracas.playing = true;
                    updateMessage('„Éû„É©„Ç´„Çπ„Åä„Å∞„Åë„Å†„ÄÇ‚Ä¶„Ç∑„É£„Ç´„Ç∑„É£„Ç´‚Ä¶ÔºàÈï∑„ÅÑ„Éù„Éº„Ç∫„ÅßÂå∫Âàá„ÇäÔºâ');
                    break;
                case 'maracas_back':
                    gameState.maracas.playing = false;
                    changeRoom('mainWindow');
                    break;

                case 'examine_end':
                    showEndingReport('end');
                    break;
                case 'examine_end2':
                    showEndingReport('end2');
                    break;
                case 'examine_true_end':
                    showEndingReport('trueEnd');
                    break;
                case 'examine_true_end2_hole':
                    changeRoom('hakone');
                    break;
                case 'examine_true_end2':
                    showEndingReport('trueEnd2');
                    break;

            }
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;

            playSE('se-click');
            updateInventoryDisplay();
        }

        function showEndingReport(endingId) {
            console.log(endingId);
            const f = gameState?.main?.flags || {};
            const ana = window.ANA || {};
            const sec = Math.max(
                1,
                (ana.endTimes && ana.endTimes[endingId]) ||
                Math.round((Date.now() - (ana.start || Date.now())) / 1000)
            );
            const mm = String(Math.floor(sec / 60)).padStart(2, '0');
            const ss = String(sec % 60).padStart(2, '0');

            // ‰ªä‰Ωú„ÅÆ„Ç®„É≥„Éá„Ç£„É≥„Ç∞Ë°®Ë®ò
            const endingTxt = ({
                trueEnd: 'üå§ TRUE ENDÔºàÂ±ã‰∏ä„Å∏ËÑ±Âá∫ÔΩúÁßãÁ©∫Ôºâ',
                trueEnd2: 'üå§ TRUE+ ENDÔºàÁÆ±Ê†π„Å∏„Éà„É™„ÉÉ„ÉóÔºâ',
                end: 'üîî NORMAL ENDÔºà„ÉÅ„É£„Ç§„É†„ÇíÈ≥¥„Çâ„Åó„Å¶ËÑ±Âá∫Ôºâ',
                end2: 'üîî NORMAL+ ENDÔºà„ÉÅ„É£„Ç§„É†Ôºã„Éû„É©„Ç´„Çπ„ÉÅ„É£„Éº„É†Ôºâ',
                badEnd: 'üíÄ BAD ENDÔºàÊ•ΩËÅñ„ÅÆÈÄÜÈ±óÔºâ'
            })[endingId] || '‚≠ê END';

            // ÂÆüÁ∏æ/ÈÅîÊàêÁä∂Ê≥ÅÔºà‰ªä‰Ωú„Éï„É©„Ç∞„Å´Âêà„Çè„Åõ„Å¶Ôºâ
            const rows = [
                `üêª „ÇØ„ÉûÂ¶ñÁ≤æÔºö${f.wakeupBear ? 'Áèæ„Çå„Åü' : '„ÅÑ„Å™„ÅÑ'}`,
                `üîç „Éí„É≥„Éà‰ΩøÁî®Ôºö${ana.hintCount || 0}Âõû`,
                `‚åõ „Éó„É¨„Ç§ÊôÇÈñìÔºö${mm}:${ss}`,
            ];

            const html = `
    <div style="text-align:left;max-width:560px">
      <div style="font-size:1.4em;margin-bottom:10px">${endingTxt}</div>
      <ul style="line-height:1.8;margin:0;padding-left:1.1em">
        ${rows.map(r => `<li>${r}</li>`).join('')}
      </ul>
      <div style="margin-top:14px;font-size:.95em;opacity:.9">
        „ÇØ„É™„Ç¢„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ<br>„ÅîÊÑèË¶ã„ÅåÊ¨°Âõû„ÅÆÊîπÂñÑ„Å´Áõ¥Áµê„Åó„Åæ„Åôüôè
      </div>
    </div>
  `;
            // ÂÖ±Êúâ„ÉÜ„Ç≠„Çπ„ÉàÔºàXÁî®Ôºâ
            const shareText = (() => {
                const short = {
                    trueEnd: 'TRUE ENDÔºàÂ±ã‰∏äÔºâ',
                    trueEnd2: 'TRUE+ ENDÔºàÂ±ã‰∏äÔºã„ÉÅ„É£„Éº„É†Ôºâ',
                    end: 'NORMAL ENDÔºà„ÉÅ„É£„Ç§„É†Ôºâ',
                    end2: 'NORMAL+ ENDÔºà„ÉÅ„É£„Ç§„É†Ôºã„ÉÅ„É£„Éº„É†Ôºâ',
                    badEnd: 'BAD END'
                }[endingId] || 'END';
                return `„ÄéÈü≥Ê•ΩÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫„Äè${short} „ÇíÈÅîÊàêÔºÅ ‚åõ${mm}:${ss} / „Éí„É≥„Éà${ana.hintCount || 0}Âõû #ËÑ±Âá∫„Ç≤„Éº„É† #Èü≥Ê•ΩÂÆ§`;
            })();

            showModal('', html, [
                { text: 'ÊÑüÊÉ≥„Éï„Ç©„Éº„É†„ÇíÈñã„Åè', action: () => openFeedbackForm(endingId, { mm, ss }) },
                { text: 'Èñâ„Åò„Çã', action: 'close' },
            ]);

        }


        const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSed7bJdV_IIlhSbjnRQ-rbct2p2RnsoJV6Cu4uc2nt7-S_9sw/viewform?";
        const FORM_FIELDS = {
            ending: 'entry.666725843',


        };

        function openFeedbackForm(endingId, meta = {}) {
            const f = gameState?.main?.flags || {};
            const mm = meta.mm || "00";
            const ss = meta.ss || "00";

            const endingLabel = ({
                trueEnd: "„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ",
                trueEnd2: "„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ+",
                end: "„Éé„Éº„Éû„É´„Ç®„É≥„Éâ",
                end2: "„Éé„Éº„Éû„É´„Ç®„É≥„Éâ+",
                badEnd: "BAD END"
            })[endingId] || "";

            const params = new URLSearchParams();
            params.set("usp", "pp_url");
            if (FORM_FIELDS.ending && endingLabel) params.set(FORM_FIELDS.ending, endingLabel);
            // „ÇÇ„Åó„Éï„Ç©„Éº„É†„Å´È†ÖÁõÆ„Åå„ÅÇ„Çå„Å∞„ÄÅ‰ª•‰∏ã„Çí„Ç¢„É≥„Ç≥„É°„É≥„ÉàÔºÜÈ†ÖÁõÆID„ÇíË®≠ÂÆö
            if (FORM_FIELDS.bear_appeared) params.set(FORM_FIELDS.bear_appeared, f.wakeupBear ? "ÁôªÂ†¥„Åó„Åü" : "Êú™ÁôªÂ†¥");

            window.open(`${FEEDBACK_URL}?${params.toString()}`, "_blank", "noopener,noreferrer");
        }

        function talkToHintCharacter(roomId, charId) {
            // flagsÂèñÂæó
            let flags = gameState[roomId].flags;
            // „Åæ„Å†„Ç´„Ç¶„É≥„ÉàÁÑ°„Åë„Çå„Å∞ÂàùÊúüÂåñ
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            flags.talkTo[charId]++;

            // „Çª„É™„Éï„É™„Çπ„ÉàÂèñÂæó
            const messages = hintMessages[roomId][charId];
            if (roomId == 'main' && charId == 'bear' && flags.talkTo[charId] == 3) {
                gameState.main.flags.canRemovePoster = true;
            }
            // ÁØÑÂõ≤Â§ñ„Å™„ÇâÊúÄÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const idx = (flags.talkTo[charId] - 1) % messages.length;

            // Ë°®Á§∫
            updateMessage(messages[idx]);
        }

        // „Åä„Å®„Åó„ÇÇ„ÅÆ„Å∞„Åì„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showboxPuzzle() {
            const modalContent = `
                <h3>„É≠„ÉÉ„ÇØ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã</h3>
                <p><img src="${IMAGES.modals.otoshimono}" style="width:300px;display:block;margin:0 auto 20px;"></p>
                <input type="text" class="puzzle-input" id="boxInput" placeholder="Êï∞Â≠ó3Ê°Å">
                <br>
                <button onclick="checkBoxPuzzle()">Á¢∫Ë™ç</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // „Åä„Å®„Åó„ÇÇ„ÅÆ„Å∞„Åì„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkBoxPuzzle() {
            const v = document.getElementById('boxInput').value.trim();
            // ÂÖ®ËßíÂØæÁ≠ñ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === '463') {
                closeModal();
                gameState.main.flags.unlockBox = true;
                markProgress('otoshimonobox_open');
                showModal(
                    '„É≠„ÉÉ„ÇØËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                playSE('se-gacha');
                updateMessage('„É≠„ÉÉ„ÇØËß£Èô§„Åï„Çå„Åü„ÄÇ‰∏≠„ÇíË™ø„Åπ„Çà„ÅÜ');

            } else {
                playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }

        function handleDoor() {

            // ÂàÜÂ≤êÔºötrueEndUnlocked „ÅåÁ´ã„Å£„Å¶„ÅÑ„Çå„Å∞„Éà„Ç•„É´„ÉºEND„Å∏
            if (gameState.flags.trueEndUnlocked && hasItem('bearMaracas')) {
                gameState.endings.true = true;
                changeRoom('trueEnd2');
            } else if (gameState.flags.trueEndUnlocked) {
                gameState.endings.true = true;
                changeRoom('trueEnd');
            } else if (!gameState.flags.trueEndUnlocked && hasItem('bearMaracas')) {
                gameState.endings.true = true;
                changeRoom('end2');
            } else {
                changeRoom('end');
            }
        }

        // „Ç¢„Ç§„ÉÜ„É†ÁÆ°ÁêÜ
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 8) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }

        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ‰ΩøÁî®„Åó„Åü„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay();
            }
        }

        function getItemName(itemId) {
            const names = {
                coin: '„ÇØ„Éû„Ç≥„Ç§„É≥',
                bear: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                key: '„Ç´„ÇÆ',
                harmonica: 'È¢®„ÅÆ„Éè„Éº„É¢„Éã„Ç´ÔºàÂêπ„Åè„Å®È¢®„ÅåÂêπ„ÅèÔºâ',
                harmonicaNormal: '„Éè„Éº„É¢„Éã„Ç´',
                keyDonguri: '„Å©„Çì„Åê„Çä',
                score: 'ÊâãÊõ∏„Åç„ÅÆÊ•ΩË≠ú',
                bachi: 'Â§™Èºì„ÅÆ„Å∞„Å°ÔºàÂè©„ÅèÊ£íÔºâ',
                bearMaracas: '„Éû„É©„Ç´„Çπ„ÉÅ„É£„Éº„É†',
                cloudSeal: 'Èõ≤„ÅÆ„Ç∑„Éº„É´'


            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;
                btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        // „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫Êõ¥Êñ∞
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function () {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                    const magBtn = document.createElement('div');
                    magBtn.className = 'magnifier-btn';
                    magBtn.title = 'Êã°Â§ßË°®Á§∫';
                    magBtn.innerHTML = '<img src="images/magnifier.png" alt="Êã°Â§ß">';
                    magBtn.onclick = (e) => {
                        e.stopPropagation();

                        showModal(
                            getItemName(gameState.inventory[index]),
                            `<img src="${img.src}" style="max-width: 300px; max-height: 300px; width: auto; height: auto; object-fit: contain; display:block;margin:0 auto 16px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                    };
                    slot.appendChild(magBtn);
                }
                // ‚òÖÈÅ∏Êäû‰∏≠„Å™„Çâselected„ÇØ„É©„ÇπËøΩÂä†
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        function updateMessage(message) {
            //document.getElementById('messageArea').innerHTML = message;
            document.getElementById('msgText').textContent = message;
        }

        function updateMessageHTML(html) {
            const el = document.getElementById('msgText');
            el.innerHTML = html;
            el.querySelectorAll('a').forEach(a => {
                a.target = '_blank';
                a.rel = 'noopener';
                a.style.color = '#d4af37';
                a.style.textDecoration = 'underline';
            });
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content, buttons, onSequenceSuccess) {
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            if (buttons && buttons.length > 0) {
                modalHtml += `<div id="modalButtons" style="text-align:center;"></div>`;
                modalHtml += `<div id="modalClose" style="margin-top:25px;text-align:center;"></div>`;
            }
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';

            if (!buttons || buttons.length === 0) return;

            let pressed = [];
            let heartCnt = 0;
            let checkCnt = 0;
            let houseCnt = 0;

            // ÁîªÂÉè/ÈÄöÂ∏∏„Éú„Çø„É≥„Å®close„Éú„Çø„É≥„ÅßÂàÜ„Åë„Çã
            const modalButtons = document.getElementById('modalButtons');
            const modalClose = document.getElementById('modalClose');

            buttons.forEach((button, idx) => {
                // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅØ‰∏ã„Å∏
                if (button.action === 'close') {
                    const btn = document.createElement('button');
                    btn.textContent = button.text || 'Èñâ„Åò„Çã';
                    btn.className = 'modal-close-btn';
                    btn.onclick = function () {
                        closeModal();
                        if (typeof onSequenceSuccess === "function") {
                            onSequenceSuccess();
                        }
                    };
                    modalClose.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.style.margin = "0 10px 10px 0";
                    if (button.img) {
                        btn.innerHTML = `<img src="${button.img}" alt="${button.text || ''}" style="width:80px;height:80px;vertical-align:middle;">`;
                    } else {
                        btn.textContent = button.text;
                        btn.className = 'text-btn';
                    }
                    btn.onclick = function () {
                        if (button.action === 'restart') {
                            restartGame();
                        } else if (typeof button.action === "function") {
                            button.action();
                        } else if (typeof button.action === 'string') {
                            closeModal();
                            handleAreaClick(button.action);
                        }
                    };
                    modalButtons.appendChild(btn);
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
            if (window._nextModal) {
                // ÁôªÈå≤ÂÜÖÂÆπ„ÅØ {title, content, buttons, after} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                let modal = window._nextModal;
                window._nextModal = null; // „ÇØ„É™„Ç¢
                if (modal.before) modal.before();
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after();
            }
            window.dispatchEvent(new Event('modal:closed'));
        }

        // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„Éà
        function restartGame() {
            gameState = getDefaultGameState();
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;
        let isBGMInitialized = false; // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®

        // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Å†„ÅëBGM„ÇíÂÜçÁîü
        function initBGMOnce() {
            if (!isBGMInitialized) {
                const bgm = document.getElementById('bgm');
                bgm.volume = 0.2;
                bgm.play();
                isBGMPlaying = true;
                isBGMInitialized = true;
                document.getElementById('bgm-toggle').textContent = "üîä BGM";
            }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "üîä BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "üîá BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // „Éï„Ç°„Ç§„É´Âêç„ÅÆ„Åø„ÅßÊØîËºÉ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            if (current === next) return; // „Åô„Åß„Å´„Åù„ÅÆBGM„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function pauseBGM() {
            const bgm = document.getElementById('bgm');
            bgm.src = "";
            bgm.pause();
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // „Å©„Åì„Åã„ÅßÊúÄÂàù„Å´‰∏ÄÂ∫¶„Å†„ÅëÂëº„Å∂
        let loadedImages = {};
        function preloadImages() {
            // ÈÉ®Â±ãÁîªÂÉè
            Object.values(IMAGES.rooms).forEach(val => {
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        if (!loadedImages[src]) {
                            const img = new Image();
                            img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                            img.src = src;
                            loadedImages[src] = img;



                        }
                    });
                } else if (typeof val === "string") {
                    if (!loadedImages[val]) {
                        const img = new Image();
                        img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                        img.src = val;
                        loadedImages[val] = img;
                    }
                }
            });
            // „Ç¢„Ç§„ÉÜ„É†ÁîªÂÉè
            Object.values(IMAGES.items).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
            // „É¢„Éº„ÉÄ„É´ÁîªÂÉè
            Object.values(IMAGES.modals).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
        }

        function saveGame() {
            const toSave = { ...gameState, __version: SAVE_VERSION };
            localStorage.setItem(SAVE_KEY, JSON.stringify(toSave));
            updateMessage('„Çª„Éº„Éñ„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function loadGame() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) {
                updateMessage('„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            const saved = JSON.parse(raw);

            // „Éá„Éï„Ç©„É´„Éà„Å®„Éû„Éº„Ç∏„Åó„Å¶‰∏çË∂≥„Ç≠„Éº„ÇíË£úÂÆå
            const def = getDefaultGameState();
            const merged = deepMerge(def, saved);

            if (!Array.isArray(merged.openRooms)) merged.openRooms = def.openRooms.slice();
            if (!merged.currentRoom || !rooms[merged.currentRoom]) merged.currentRoom = def.currentRoom;

            gameState = merged;

            changeRoom(gameState.currentRoom);
            updateInventoryDisplay?.();
            renderNavigation?.();
            updateMessage('„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ');
        }


        function deepMerge(target, source) {
            if (source === undefined || source === null) return target;
            if (Array.isArray(source)) return source.slice();
            if (typeof source === 'object') {
                const out = (target && typeof target === 'object') ? { ...target } : {};
                for (const k of Object.keys(source)) {
                    out[k] = deepMerge(target ? target[k] : undefined, source[k]);
                }
                return out;
            }
            return source;
        }


        // „Ç≤„Éº„É†ÈñãÂßã
        preloadImages();
        initGame();
    </script>
</body>

</html>