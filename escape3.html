<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¿ã‚¤ã‚¢ãŠã˜ã•ã‚“ã®è„±å‡º</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;  /* â†ã“ã‚Œé‡è¦ */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .room-view {
            aspect-ratio: 1/1;           /* â†æ­£æ–¹å½¢ */
            width: 90vw;                 /* ç”»é¢å¹…ã®90% */
            max-width: 640px;            /* PCæ™‚æœ€å¤§ã‚µã‚¤ã‚º */
            max-height: 90vw;       
            background-size: cover;      
            background-repeat: no-repeat;
            background-position: center center;
            position: relative;
            margin: 0 auto;
            cursor: crosshair;
            transition: background-image 0.5s ease-in-out;
        }

        #roomImage {
            width: 100%;
            height: 100%;
            object-fit: contain;    /* ç”»åƒå…¨ä½“ã‚’è¡¨ç¤º */
            position: absolute;
            left: 0;
            top: 0;
            z-index: 0;
            pointer-events: none;   /* ç”»åƒä¸Šã§ã‚‚ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒé€šã‚‹ã‚ˆã†ã« */
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
            }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }



        .clickable-area {
            position: absolute;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            z-index: 2;
            pointer-events: auto;

        }

        .clickable-area:hover {
            border-color: #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 20px;
            width:100%;
        }

        .inventory-slot {
            width: 14vw; 
            height: 14vw; 
            max-width: 80px; 
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;   /* é‡‘è‰²ãƒ»å¤ªã‚æ¨å¥¨ */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .info-panel {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            height:80px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        /* ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }
        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            width: 40%;
        }

        @media (max-width: 600px) {
            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }
            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width:100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }
        #roomEffectOverlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: black;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }
        #overlayText {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 2em;
            text-shadow: 0 2px 6px #222;
            letter-spacing: 0.08em;
            opacity: 0.93;
            pointer-events: none;
        }
        .calendar-panel {
            position: absolute;
            top: 52px;
            right: 22px;
            z-index: 200;
            background: rgba(255,255,255,0.13);
            border: 2.5px solid #d4af37;
            border-radius: 18px;
            font-size: 1.25em;
            color: #d4af37;
            font-family: 'Arial', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
            padding: 6px 20px 6px 18px;
            /* min-width: 120px; */
            text-align: right;
            box-shadow: 0 2px 10px #2c181055;
            font-weight: bold;
            letter-spacing: 0.08em;
        }
        @media (max-width: 600px) {
            .calendar-panel {
                background: #444;
                font-size: 1em;
                right: 8px;
                top: 50px;
                /* min-width: 70px; */
                padding: 3px 10px 3px 10px;
            }
        }
        #actionCounter {
            position: absolute;
            top: 102px;
            right: 12px;
            z-index: 200;
            background: rgba(255,255,255,0.13);
            border: 2.5px solid #d4af37;
            border-radius: 18px;
            font-size: 1.25em;
            color: #d4af37;
            font-family: 'Arial', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
            padding: 6px 20px 6px 18px;
            /* min-width: 120px; */
            text-align: right;
            box-shadow: 0 2px 10px #2c181055;
            font-weight: bold;
            letter-spacing: 0.08em;
        }
        @media (max-width: 600px) {
            .actionCounter {
                background: #444;
                font-size: 1em;
                right: 8px;
                top: 50px;
                /* min-width: 70px; */
                padding: 3px 10px 3px 10px;
            }
        }
        #goOutsideBtn {
            position: absolute;
            right: 12px;
            top: 7px;
            z-index: 9999;  /* â†æœ€å‰é¢ã« */
            padding: 8px 16px;
            background: gold;
            color: #333;
            font-size: 1em;
            border-radius: 10px;
            border: 1px solid #b8941f;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }
        #goOutsideBtn:hover {
            background: #ffe168;
        }


    </style>
</head>
<body>
    <div id="roomEffectOverlay"><span id="overlayText"></span></div>
    <div class="game-container">
        <div class="title">å¤‰åŒ–ãŒãªã„æ—¥å¸¸ã‹ã‚‰è„±å‡ºã›ã‚ˆ</div>
        <div class="calendar-panel" id="calendar">
        </div>
        <div id="actionCounter"></div>
        
        <div class="room-view" id="roomView">
            <!-- ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã¯å‹•çš„ã«ç”Ÿæˆ -->
              <img id="roomImage" src="">
              
        </div> 
        <div id="endingShareArea" style="display:none;">
            <div style="font-size:1.4em; font-weight:bold; margin-bottom:8px;color:#2c1810;">ğŸ‰ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼ğŸ‰</div>
            <button onclick="shareOnTwitter()">Xã§ã‚·ã‚§ã‚¢</button>
            <button onclick="copyShareText()">ã‚¯ãƒªã‚¢å ±å‘Šã‚’ã‚³ãƒ”ãƒ¼</button>
            <div style="font-size:0.9em; margin-top:6px; color:#555;">#è„±å‡ºã‚²ãƒ¼ãƒ  #è‡ªä½œã‚²ãƒ¼ãƒ </div>
        </div>
        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="messageText">
                        æœã ã€‚ã§ã‚‚ä»Šæ—¥ã‚‚ä½•ã‚‚ã‚„ã‚‹ã“ã¨ãŒãªã„ã€‚éŠ€è¡Œæ®‹é«˜ã‚’ç¢ºèªã—ã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’çœºã‚ã‚‹ã ã‘ã®æ—¥ã€…ã€‚â€œç”ŸããŒã„â€ã¨ã¯ãªã‚“ã ã£ãŸã®ã‹â€¦
                    </span>  
                <button id="goOutsideBtn" onclick="showGenkanPuzzle()">å¤–ã¸å‡ºã‚ˆã†</button>
                </div>
                <div class="navigation">
                    
                </div> 
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
            ğŸ”Š BGM
            </button> 
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">ã‚»ãƒ¼ãƒ–</button>
                <button class="nav-btn" onclick="loadGame()">ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
        <div class="notice">å½“ã‚µã‚¤ãƒˆã¯OtoLogicã®ç´ æã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ ä½œè€…:<a href="index.html">ã‚¹ãƒ©ã‚»ãƒ–ãƒ³</a></div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã¯å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>
    <audio id="bgm" src="sounds/3/heisarenai.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-tv" src="sounds/TV-Hardware02-01(Button).mp3"></audio>
    <audio id="se-skeleton" src="sounds/Motion-Tremble02-1(Short).mp3"></audio>
    <audio id="se-metal" src="sounds/Horror_Accent13-1(Short).mp3"></audio>
    <audio id="se-subclear" src="sounds/Quiz-Ding_Dong01-1(Short).mp3"></audio>
    <audio id="se-clear" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-parin" src="sounds/Onoma-Impact04-1(High).mp3"></audio>
    <audio id="se-box" src="sounds/Retro_Anime-Switch02-1(Mid).mp3"></audio>
    <audio id="se-person" src="sounds/Short_Accent04-1(Single).mp3"></audio>
    <audio id="se-warp" src="sounds/3/Scene_Change08-2(Delay-Slow).mp3"></audio>
    <audio id="se-flash" src="sounds/3/Scene-Flashback06-2(Short).mp3"></audio>
    <audio id="se-inspiration" src="sounds/3/Inspiration06-2(Mid).mp3"></audio>
    <audio id="se-siren" src="sounds/3/Warning-Siren04-09(Reverb-Low-Mid).mp3"></audio>
    <script>
        window._nextModal = null;
        // ã‚²ãƒ¼ãƒ è¨­å®š - ç”»åƒãƒ‘ã‚¹ã‚’ã“ã“ã§ç®¡ç†
        let IMAGES = {
            rooms: {
                room: 'images/3/room.jpg',        
                road: 'images/3/road.jpg',       
                park: 'images/3/park.jpg',      
                supermarket: 'images/3/supermarket.jpg',
                tvEnd: 'images/3/tvEnd.jpg',
                roomEnd: 'images/3/roomEnd.jpg',
                roadEnd: 'images/3/roadEnd.jpg',
                superEnd: 'images/3/superEnd.jpg',
                parkEnd: 'images/3/parkEnd.jpg',
                bokeEnd: 'images/3/bokeEnd.jpg',
                normalEnd: 'images/3/normalEnd.jpg',
                normal2End: 'images/3/normalEnd2.jpg',
                muneEnd: 'images/3/muneEnd.jpg'     
            },
            items: {
                tamago: 'images/3/tamago.jpg',
                muneniku: 'images/3/muneniku.jpg',
                shiokoji: 'images/3/shiokoji.jpg',
                tanpopo: 'images/3/tanpopoItem.jpg',
                book: 'images/3/book.jpg',

            }
        };

        let isActionLocked = false;

        // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ã ã‘ä½¿ã†ãƒ†ãƒ³ãƒ—ãƒ¬
        const tvMessagesByDay = {
            1: [
                "ã€ŒWSãƒ†ãƒ¬ãƒ“ã§ã™ã€‚ä»Šæœã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™ã€",
                "ã€ŒçŸ³ç©´ç·ç†ã¯ã€ã€",
                "ã€Œå…¨å›½ã§ç™ºç”Ÿã—ã¦ã„ã‚‹ã‚³ãƒ¡ä¸è¶³å•é¡Œã«å¯¾å‡¦ã™ã‚‹ãŸã‚â€¦ã€",
                "â€¦ã¾ã£ãŸãã€ä½•ã¨ã‹ã—ã¦ã»ã—ã„ã‚‚ã‚“ã ",
                "ã‚³ãƒ¡ã˜ã‚ƒãªãã¦ã€ä½•ã‚’è²·ã†ã‚“ã ã£ã‘ã€‚ãƒ¡ãƒ¢ã‚’æ›¸ã„ãŸã¯ãšã ãŒâ€¦",
                "ãŸã‚æ¯ã ã‘ãŒã€ä¸Šæ‰‹ããªã£ãŸæ°—ãŒã™ã‚‹",
                "ãŠãªã˜ã¿â€œè€å¾Œ2000ä¸‡å•é¡Œâ€ã€‚ä¿ºã«ã¯ã‚‚ã†é–¢ä¿‚ãªã„è©±ã "
            ],
            2: [
                "WSãƒ†ãƒ¬ãƒ“ã¯æ˜¨æ—¥ã¨åŒã˜ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã¾ãŸã‚„ã£ã¦ã„ã‚‹â€¦ãƒ‡ã‚¸ãƒ£ãƒ´ã‹ï¼Ÿ",
                "ç‰¹é›†ï¼šäººç”Ÿ100å¹´æ™‚ä»£ã€‚â€¦é•·ã™ãã‚‹ã£ã¦ã®",
                "é€šè²©ç•ªçµ„ï¼šã€ã“ã‚Œä¸€æœ¬ã§è€å¾Œã‚‚å®‰å¿ƒï¼ã€â€¦ä½•ãŒå®‰å¿ƒãªã‚“ã ã‹",
                "â€œç¯€ç´„ç”Ÿæ´»ã®ã‚³ãƒ„â€ã°ã‹ã‚Šç´¹ä»‹ã—ã¦ã‚‹ã€‚ä¿ºã‚‚å‡ºã‚‰ã‚Œãã†ã ãª",
                "ã¾ãŸå¥åº·é£Ÿå“ã®CMâ€¦æ˜¨æ—¥ã‚‚è¦‹ãŸãã€ã“ã‚Œ",
                "ã‚¢ãƒŠã‚¦ãƒ³ã‚µãƒ¼ã®å£°ãŒå¿ƒãªã—ã‹ç–²ã‚Œã¦èã“ãˆã‚‹",
                "ä»Šæ—¥ã‚‚ã©ã“ã‹ã§èª°ã‹ãŒä½•ã‹ã‚’ã‚„ã‚‰ã‹ã—ãŸã‚‰ã—ã„ã€‚ä¿ºã«ã¯é–¢ä¿‚ãªã„"
            ],
            3: [
                "ä»Šæ—¥ã‚‚ã¾ãŸWSãƒ†ãƒ¬ãƒ“å†æ”¾é€ã€‚ä½•å›ç›®ã ã‚ã†",
                "ãƒ†ãƒ¬ãƒ“ã‚’ã¤ã‘ã¦ã‚‚ã€ä½•ã‚‚é ­ã«å…¥ã£ã¦ã“ãªã„",
                "ä»Šæ—¥ã‚‚ã‚„ã‚‹ã“ã¨ãŒè¦‹ã¤ã‹ã‚‰ãªã„",
                "â€œæ˜æ—¥ãŒå¤‰ã‚ã‚‹ï¼â€â€¦çª“æ ãƒªãƒ•ã‚©ãƒ¼ãƒ ã®CMã‹",
                "ã‚¹ãƒãƒ›ä¿®ç†ã®CMã€‚ä¿ºã®ã‚‚å£Šã‚ŒãŸã‚‰è²·ã†é‡‘ã¯ãªã„ã‹ã‚‰ã€ãŠä¸–è©±ã«ãªã‚‹ã ã‚ã†",
                "WSãƒ†ãƒ¬ãƒ“ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒæ¯æ—¥åŒã˜ã“ã¨ã‚’è¨€ã£ã¦ã‚‹ã€‚ä¿ºã®äººç”Ÿã‚‚åŒã˜ã‹",
                "ãƒ†ãƒ¬ãƒ“ã ã‘ãŒå‹é”â€¦å†—è«‡ã«ãªã‚‰ãªã„ãª",
                "ç”»é¢ã®å‘ã“ã†ã®äººãŒé ã„ä¸–ç•Œã®ä½äººã¿ãŸã„ã ",
                "ã“ã“ã‹ã‚‰æŠœã‘å‡ºã™æ–¹æ³•ã€ã‚ã‚‹ã®ã‹ï¼Ÿ"
            ]
        };

        const selfMessagesByDay = {
            1: [
                "ä»Šæ—¥ã‚‚ç‰¹ã«ã‚„ã‚‹ã“ã¨ãŒãªã„â€¦",
                "å¹´é‡‘ç”Ÿæ´»ã§ã€ç”Ÿæ´»è²»ã¯ãã‚Šãã‚Šã ",
                "â€¦",
                "ã¯ãâ€¦ä½•ã®ãŸã‚ã«ç”Ÿãã¦ã‚‹ã‚“ã ã‚ã†ã€‚",
                "èª°ã‹ã¨è©±ã—ãŸã®ã¯ã€ã„ã¤ãŒæœ€å¾Œã ã£ãŸã‹â€¦",
                "æ˜”ã¯ã€å¿™ã—ã‹ã£ãŸãªã€‚",
                "ä»Šã®è‡ªåˆ†ã¯ã€ã‚ã®é ƒæƒ³åƒã—ãŸâ€œæœªæ¥â€ã ã£ãŸã‚“ã ã‚ã†ã‹ã€‚",
                "â€¦ã„ã‚„ã€ä½•ã‚‚è€ƒãˆã¦ã‚‚ä»•æ–¹ãªã„ã‹ã€‚",
                "å°‘ã—æ¨ªã«ãªã‚ã†ã€‚"
            ],
            2: [
                "æ˜¨æ—¥ã¨åŒã˜ä¸€æ—¥ãŒå§‹ã¾ã£ãŸã ã‘ã ",
                "ä»Šæ—¥ã‚‚ã‚„ã‚‹ã“ã¨ãŒè¦‹ã¤ã‹ã‚‰ãªã„",
                "â€œã„ã¤ã‚‚é€šã‚Šâ€ã£ã¦ã€æ„å¤–ã¨ã¤ã‚‰ã„ã‚‚ã‚“ã ãª",
                "è‡ªåˆ†ã§ã‚‚é©šãã»ã©ã€ä½•ã‚‚ã—ãªã„ã§ä¸€æ—¥ãŒéãã¦ã„ã",
                "ç”Ÿãã¦ã‚‹å®Ÿæ„Ÿã£ã¦ã€ã©ã“ã§å¾—ã‚Œã°ã„ã„ã‚“ã ã‚ã†",
                "ãŸã‚æ¯ã ã‘ãŒã€ä¸Šæ‰‹ããªã£ãŸæ°—ãŒã™ã‚‹",
                "ç«‹ã¡ä¸ŠãŒã‚‹ã®ã‚‚ãŠã£ãã†ã "
            ],
            3: [
                "â€¦ä½•ã‚‚å¤‰ã‚ã‚‰ãªã‹ã£ãŸãª",
                "ã“ã‚ŒãŒã€ä¿ºã®â€œæ–°ã—ã„ç”Ÿæ´»â€ã ã£ãŸã‚“ã ã‚ã†ã‹",
                "ã“ã“ã‹ã‚‰æŠœã‘å‡ºã™æ–¹æ³•ã€ã‚ã‚‹ã®ã‹ï¼Ÿ",
                "ãªã‚“ã§ç”Ÿãã¦ã‚‹ã‚“ã ã‚ã†ã€ãªã‚“ã¦è€ƒãˆã¦ã‚‚ä»•æ–¹ãªã„ã‹",
                "ã‚‚ã—æ˜æ—¥ãŒæ¥ã¦ã‚‚ã€ã¾ãŸåŒã˜æ°—ãŒã™ã‚‹",
                "ãƒ†ãƒ¬ãƒ“ã ã‘ãŒå‹é”â€¦å†—è«‡ã«ãªã‚‰ãªã„ãª",
                "è…¹ãŒæ¸›ã£ãŸãªâ€¦",
            ]
        };

        const tumblerMessagesByDay = {
            1: [
                "æœå…¥ã‚ŒãŸãŠèŒ¶ãŒã¾ã æ®‹ã£ã¦ã„ã‚‹ã€‚ã¬ã‚‹ã„ã€‚",
                "ã“ã®ã‚¿ãƒ³ãƒ–ãƒ©ãƒ¼ã€èª°ã«ã‚‚ã‚‰ã£ãŸã‚“ã ã£ã‘ã€‚",
                "ãŠèŒ¶ã®å‘³ã‚‚ã€ã‚‚ã†ã‚ˆãåˆ†ã‹ã‚‰ãªã„ã€‚",
                "æ¸©ã‹ã„é£²ã¿ç‰©ã ã‘ãŒã€ãªã‚“ã¨ãªãå®‰å¿ƒã•ã›ã¦ãã‚Œã‚‹ã€‚",
                "ãŠèŒ¶ã£è‘‰ã€ä½•å›ä½¿ã„å›ã—ãŸã ã‚ã†ã€‚",
                "é£²ã¿å¹²ã—ã¦ã‚‚ã€ã¾ãŸã™ãã«æ·¹ã‚Œã‚‹ã ã‘ã ã€‚",
                "ä»Šæ—¥ã¯æ–°ã—ã„ãŠèŒ¶ã£è‘‰ã‚’ä½¿ãŠã†ã‹â€¦ã„ã‚„ã€ã‚‚ã£ãŸã„ãªã„ãªã€‚"
            ],
            2: [
                "ä»Šæ—¥ã‚‚åŒã˜ãŠèŒ¶ã ã€‚",
                "å‘³ãŒè–„ã„â€¦ã¾ã‚ã€ã‚‚ã£ãŸã„ãªã„ã‹ã‚‰ä»•æ–¹ãªã„ã€‚",
                "ã‚¿ãƒ³ãƒ–ãƒ©ãƒ¼ã®åº•ã«èŒ¶æ¸‹ãŒæ®‹ã£ã¦ã„ã‚‹ã€‚",
                "ä½•æ¯é£²ã‚“ã§ã‚‚ã€ç‰¹ã«å¤‰ã‚ã‚‰ãªã„ã€‚",
                "æ˜”ã¯ç·‘èŒ¶ãŒå¥½ãã ã£ãŸæ°—ãŒã™ã‚‹ã€‚",
                "å®‰ç‰©ã§ã‚‚ã€æ¸©ã‹ã‘ã‚Œã°ã„ã„ã€‚",
                "æ–°ã—ã„ãŠèŒ¶ã£è‘‰ã‚’è²·ã†ã®ã‚‚ã€ã¡ã‚‡ã£ã¨è´…æ²¢ã«æ„Ÿã˜ã‚‹ã€‚"
            ],
            3: [
                "ä»Šæ—¥ã‚‚åŒã˜ãŠèŒ¶ã€‚å¤‰ã‚ã‚‰ãªã„å‘³ã€‚",
                "ãŠèŒ¶ã‚‚ä¿ºã‚‚ã€ãã‚ãã‚é™ç•Œã‹ã‚‚ã—ã‚Œãªã„ã€‚",
                "ã‚‚ã†å‘³ã‚‚ã—ãªããªã£ã¦ããŸã€‚",
                "ãŠèŒ¶ã‚’é£²ã‚€ã®ã‚‚ã€ãŸã ã®ç¿’æ…£ã«ãªã£ã¦ã„ã‚‹ã€‚",
                "ã‚¿ãƒ³ãƒ–ãƒ©ãƒ¼ãŒæ‰‹ã«é¦´æŸ“ã¿ã™ãã¦ã„ã‚‹ã€‚",
                "ã“ã®ãŠèŒ¶ã€ä½•å›ç›®ã ã‚ã†â€¦",
                "ã¬ã‚‹ã„ãŠèŒ¶ã«ãŸã‚æ¯ãŒæ··ã–ã‚‹ã€‚"
            ]
        };

        const spMessagesByDay = {
            1: [
                "é€šçŸ¥ã¯ã‚¼ãƒ­ã€‚èª°ã‚‚ä¿ºã‚’å¿…è¦ã¨ã—ã¦ã„ãªã„ã‚‰ã—ã„ã€‚",
                "å¹´é‡‘ã®æŒ¯è¾¼ã ã‘ãŒå”¯ä¸€ã®é€£çµ¡â€¦ã‚ã‚ŠãŒãŸã„ã‚“ã ã‹ã€ãªã‚“ã ã‹ã€‚",
                "â€¦è²·ã„ç‰©ãƒªã‚¹ãƒˆã«ãªã‚“ã¦å…¥ã‚ŒãŸã‚“ã ã£ã‘",
                "SNSã‚’é–‹ã„ã¦ã¿ãŸãŒã€ä½•ã‚‚æ›¸ãã“ã¨ãŒæ€ã„ã¤ã‹ãªã„ã€‚",
                "çŸ¥ã‚Šåˆã„ã®ã‚¢ã‚¤ã‚³ãƒ³ãŒã©ã‚“ã©ã‚“æ¸›ã£ã¦ã„ãã€‚",
                "å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªã§æ”¯å‡ºã‚’ãƒã‚§ãƒƒã‚¯â€¦ã¾ãŸç¯€ç´„ã®æ—¥ã€…ã ã€‚",
                "ã‚²ãƒ¼ãƒ ã‚¢ãƒ—ãƒªï¼Ÿâ€¦ãªã‚“ã ã‹é¢å€’ãã•ã„ãªã€‚",
                "éŠ€è¡Œã‚¢ãƒ—ãƒªã®æ®‹é«˜ã‚’è¦‹ãŸã€‚ãŸã‚æ¯ãŒã§ãŸã€‚"
            ],
            2: [
                "æ–°ã—ã„é€šçŸ¥ã¯ã‚„ã£ã±ã‚Šç„¡ã„ã€‚",
                "é€£çµ¡å…ˆãƒªã‚¹ãƒˆã‚’çœºã‚ã¦ã„ã‚‹ã ã‘ã§æ™‚é–“ãŒéãã‚‹ã€‚",
                "â€¦è²·ã„ç‰©ãƒªã‚¹ãƒˆã«ãªã‚“ã¦å…¥ã‚ŒãŸã‚“ã ã£ã‘",
                "æ¤œç´¢å±¥æ­´ã‚‚ã€ã¤ã¾ã‚‰ãªã„ã‚‚ã®ã°ã‹ã‚Šã€‚",
                "ã¤ã„ã‚¹ãƒãƒ›ã‚’æ‰‹ã«å–ã‚‹ã‘ã©ã€ã™ãé–‰ã˜ã‚‹ã€‚",
                "èª°ã«ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Œãªã„ã¾ã¾çµ‚ã‚ã‚‹ã€‚",
                "æœ€è¿‘ã®ãŠã™ã™ã‚è¨˜äº‹ã€ã©ã‚Œã‚‚èˆˆå‘³ãŒæ¹§ã‹ãªã„ã€‚"
            ],
            3: [
                "ä»Šæ—¥ã‚‚ã‚¹ãƒãƒ›ã¯é™ã‹ã ã€‚",
                "èª°ã‹ã‹ã‚‰ã®é€£çµ¡ã‚’æœŸå¾…ã—ã¦ã„ã‚‹è‡ªåˆ†ãŒã„ã‚‹ã€‚",
                "â€¦ãªã«ã‚’ã—ã‚ˆã†ã¨ã—ãŸã‚“ã ã£ã‘ã€‚",
                "ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªã«ã¯ä½•ã‚‚æ›¸ã‹ã‚Œã¦ã„ãªã„ã€‚",
                "å¤©æ°—äºˆå ±ã™ã‚‰è¦‹ãªããªã£ã¦ããŸã€‚",
                "ãƒãƒƒãƒ†ãƒªãƒ¼ã®æ¸›ã‚Šã‚‚é…ã„ã€‚",
                "ãŸã æ‰‹ã«æŒã£ã¦ã„ã‚‹ã ã‘ã€‚"
            ]
        };

        const pcMessagesByDay = {
            1: [
                "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ€ã„å‡ºã™ã®ã«æ™‚é–“ãŒã‹ã‹ã£ãŸã€‚",
                "ãƒ¡ãƒ¼ãƒ«ã¯è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ã°ã‹ã‚Šã€‚å‹é”ã‹ã‚‰ã¯æ¥ãªã„ã€‚",
                "ãƒãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚‚å…¨éƒ¨æ˜¨æ—¥ã¨åŒã˜è©±é¡Œã ã€‚",
                "æ˜”ã¯ã“ã‚Œã§ä»•äº‹ã—ã¦ãŸã®ã«ãªâ€¦ä»Šã¯ä½•ã‚‚ã™ã‚‹ã“ã¨ãŒãªã„ã€‚",
                "ãŸã¾ã«PCã‚’ç«‹ã¡ä¸Šã’ã¦ã‚‚ã€ç›®çš„ãŒãªãã¦é–‰ã˜ã¦ã—ã¾ã†ã€‚",
                "å‹•ä½œãŒé…ã„ã€‚ã¾ã‚‹ã§ä¿ºã¿ãŸã„ã ã€‚",
                "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¼šè­°ï¼Ÿã‚‚ã†èª˜ã‚ã‚Œã‚‹ã“ã¨ã‚‚ãªã„ã€‚"
            ],
            2: [
                "PCã®é›»æºã‚’å…¥ã‚Œã¦ã‚‚ã€ã‚„ã£ã±ã‚Šã‚„ã‚‹ã“ã¨ãŒç„¡ã„ã€‚",
                "ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®é€šçŸ¥ã°ã‹ã‚Šè¡¨ç¤ºã•ã‚Œã‚‹ã€‚",
                "ä½•ã‹ä½œæ¥­ã‚’å§‹ã‚ã‚ˆã†ã¨ã—ã¦ã‚‚ã€ã™ãã«æ°—åŠ›ãŒåˆ‡ã‚Œã‚‹ã€‚",
                "æ˜”ã®å†™çœŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã„ã¦ã¿ãŸãŒã€æ‡ã‹ã—ã„ã ã‘ã€‚",
                "ãƒ–ãƒ©ã‚¦ã‚¶ã®å±¥æ­´ã‚‚ã»ã¨ã‚“ã©å¤‰ã‚ã‚‰ãªã„ã€‚",
                "é–‰ã˜ã‚‹ã®ãŒã©ã‚“ã©ã‚“æ—©ããªã£ã¦ã„ã‚‹ã€‚",
                "èµ·å‹•éŸ³ã ã‘ãŒç„¡é§„ã«å…ƒæ°—ã ã€‚"
            ],
            3: [
                "ä»Šæ—¥ã‚‚PCã¯ãŸã ã®ç½®ç‰©ã ã€‚",
                "ãƒãƒƒãƒˆã®ä¸–ç•Œã‚‚ç¾å®Ÿã‚‚ã€é ãæ„Ÿã˜ã‚‹ã€‚",
                "ä½œæ¥­ã‚’å§‹ã‚ã‚‹æ°—åŠ›ãŒèµ·ããªã„ã€‚",
                "æ˜”ã®è‡ªåˆ†ã«ä½•ã‹ä¼ãˆã‚‰ã‚Œã‚‹ãªã‚‰ã€ãªã‚“ã¦æ€ã†ã€‚",
                "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚Œã¦ã€å…¥åŠ›ã™ã‚‹æ°—ã‚‚ãªããªã£ãŸã€‚",
                "é›»æºã‚’å…¥ã‚Œãšã«ä¸€æ—¥ãŒçµ‚ã‚ã‚‹ã€‚",
                "PCã®å‰ã§ã¼ã‚“ã‚„ã‚Šã™ã‚‹ã ã‘ã ã£ãŸã€‚"
            ]
        };

        const defaltActions = 7;

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            currentRoom: 'room',
            openRooms: ['room'], 
            currentDay:1,
            currentActionCount:0,
            maxActionsPerDay: defaltActions,
            puzzleSequence: [],
            wentOutsideToday: false,
            canGoOutside: false,
            tvActionCount: 0,          // ä»Šæ—¥ãƒ†ãƒ¬ãƒ“è¦‹ãŸå›æ•°
            tvConsecutiveDays: 0,      // ãƒ†ãƒ¬ãƒ“ã ã‘ã®æ—¥ãŒä½•æ—¥ç¶šã„ãŸã‹
            laptopActionCount: 0,
            tumblerActionCount: 0,
            spActionCount: 0,
            selfActionCount: 0,
            actionsToday: [],          // ä»Šæ—¥ã‚„ã£ãŸã“ã¨ï¼ˆ"tv", "window", ...ï¼‰
            memoAppeared: false,
            genkanPuzzleSolved: false,
            tanpopoAction: null,
            keyHolderAction: null,
            watchBoard: false,
            watchShodouSchool: false,
            gotEgg: false,
            gotMuneRecipe: false,
            playShogi: false,
            positiveCount: 0,
            inventory: [],
            room: {
                flags: {
                    talkTo: {
                    }, 
                }
            },
            park: {
                flags: {
                    talkTo: {
                        mushokuman:0,
                        shogiman:0,
                        child:0,
                    },
                }
            },
            road: {
                flags: {
                    
                }
            },
            supermarket: {
                flags: { 
                }
            },
            flags: {
                mushokumanFavor :0,
                shogimanFavor :0,
                dayCount:0,   
            },
            selectedItem: null
        };

        // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿
        let rooms = {
            room: {
                name: 'è‡ªåˆ†ã®éƒ¨å±‹',
                description: 'è¦‹æ…£ã‚ŒãŸè‡ªåˆ†ã®éƒ¨å±‹',
                clickableAreas: [
                    {
                        x: 9, y: 44, width: 15, height: 11.3,
                        action: 'examine_tv',
                        description: 'ãƒ†ãƒ¬ãƒ“',
                        zIndex:5
                    },
                    {
                        x: 36, y: 25.6, width: 29, height: 23,
                        action: 'examine_window',
                        description: 'å…‰ãŒå·®ã—è¾¼ã‚€çª“',
                        zIndex:5
                    },
                    {
                        x: 78, y: 45, width: 10.4, height: 16,
                        action: 'examine_self',
                        description: 'è‡ªåˆ†'
                    },
                    {
                        x: 60, y: 63, width: 3.3, height: 4.4,
                        action: 'examine_tumbler',
                        description: 'ä¿æ¸©ã‚¿ãƒ³ãƒ–ãƒ©ãƒ¼'
                    },
                    {
                        x: 51.2, y: 65.8, width: 4.6, height: 5.2,
                        action: 'examine_smartphone',
                        description: 'ã‚¹ãƒãƒ›'
                    },
                    {
                        x: 31, y: 68, width: 8, height: 2.7,
                        action: 'examine_book',
                        description: 'æœ¬'
                    },
                    {
                        x: 0.4, y: 80, width: 27, height: 17.6,
                        action: 'examine_pc',
                        description: 'ãƒãƒ¼ãƒˆPC'
                    },
                    {
                        x: 92, y: 31.3, width: 7.8, height: 4.7,
                        action: 'examine_books1',
                        description: 'æœ¬æ£š'
                    },
                    {
                        x: 92, y: 40, width: 7.8, height: 5,
                        action: 'examine_books2',
                        description: '?'
                    },
                    {
                        x: 75, y: 24, width: 8, height: 11,
                        action: 'examine_wallposter',
                        description: 'æ²ç¤ºç‰©'
                    },
                    {
                        x: 74.6, y: 82, width: 9, height: 3.7,
                        action: 'examine_memo',
                        description: 'ãƒ¡ãƒ¢',
                        usable: () => !!gameState.flags.memoAppeared
                    }
                ]
            },
            road: {
                name: 'é“',
                description: 'ä½•ã®å¤‰å“²ã‚‚ãªã„ä½å®…è¡—ã®é“è·¯ã ',
                clickableAreas: [
                    {
                        x: 14.4, y: 67.6, width: 35.6, height: 14.5,
                        action: 'examine_tanpopo',
                        description: 'ã‚¿ãƒ³ãƒãƒ'
                    },
                    {
                        x: 84.5, y: 46.2, width: 8.7, height: 8.1,
                        action: 'examine_board',
                        description: 'æ²ç¤ºæ¿'
                    },
                    {
                        x: 46, y: 75.6, width: 28, height: 12,
                        action: 'examine_road',
                        description: 'é“ã®ã²ã³å‰²ã‚Œ'
                    },
                    {
                        x: 23.6, y: 37.4, width: 2.6, height: 14.5,
                        action: 'examine_pole',
                        description: 'é›»æŸ±'
                    },
                    ,
                    {
                        x: 63.1, y: 49, width: 4.7, height: 11.3,
                        action: 'examine_child',
                        description: 'å­ä¾›',
                        usable: () => !!hasItem('tamago')
                    }
                ]
            },
            park: {
                name: 'å…¬åœ’',
                description: 'ã®ã©ã‹ãªå…¬åœ’ã ',
                clickableAreas: [
                    {
                        x: 40.3, y: 32.8, width: 11.5, height: 18.8,
                        action: 'examine_womens',
                        description: 'å¥³æ€§ãŸã¡'
                    },
                    {
                        x: 53.2, y: 55.3, width: 32.4, height: 17.6,
                        action: 'examine_shogiman',
                        description: 'å°†æ£‹ã‚’ã—ã¦ã„ã‚‹äººãŸã¡'
                    },
                    {
                        x: 76.6, y: 80, width: 10, height: 8.2,
                        action: 'examine_watage',
                        description: 'ã‚¿ãƒ³ãƒãƒã®ç¶¿æ¯›'
                    },
                    {
                        x: 70.7, y: 28.2, width: 7.8, height: 17,
                        action: 'examine_mushokuman',
                        description: 'ã²ã¾ãã†ãªç”·æ€§'
                    },
                    {
                        x: 9.2, y: 40, width: 9, height: 13.4,
                        action: 'examine_kids',
                        description: 'å­ä¾›ãŸã¡'
                    }
                ]
            },
            supermarket: {
                name: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼',
                description: 'ãªã˜ã¿ã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ã ',
                clickableAreas: [
                    {
                        x: 12, y: 30.7, width: 45, height: 22.6,
                        action: 'examine_super_womens',
                        description: 'è«‡ç¬‘ã—ã¦ã„ã‚‹å¥³æ€§ãŸã¡'
                    },
                    {
                        x: 47.5, y: 75.4, width: 23, height: 21.3,
                        action: 'examine_muneniku',
                        description: 'ã‚€ã­è‚‰',
                        zIndex:5
                    },
                    {
                        x: 88, y: 37, width: 7.6, height: 12.6,
                        action: 'examine_register',
                        description: 'ã‚»ãƒ«ãƒ•ãƒ¬ã‚¸'
                    }
                ]
            },
            tvEnd: {
                name: 'ãƒ†ãƒ¬ãƒ“é¬±ã‚¨ãƒ³ãƒ‰',
                description: '<br>ï¼ˆãƒ†ãƒ¬ãƒ“ã ã‘è¦‹ã¦ã„ã‚‹ä½™ç”Ÿã€‚ãã‚Œã§ã„ã„ã®ã‹ï¼Ÿã„ã‚„ã€è‰¯ã„ã‚“ã ã€‚ã“ã‚Œã§ä¿ºã¯â€¦ï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦â€¦ãŠã¤ã‹ã‚Œã•ã¾ã€ãã‚Œã‚‚äººç”Ÿã ã‚ˆã€‚ã€',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_utu',
                        description: 'é¬±'
                    },
                ]
            },
            roomEnd: {
                name: 'ã²ãã“ã‚‚ã‚Šã‚¨ãƒ³ãƒ‰',
                description: '<br>ï¼ˆçµå±€ã€éƒ¨å±‹ã‹ã‚‰ä¸€æ­©ã‚‚å‡ºãšã«3æ—¥ãŒçµ‚ã‚ã£ãŸã€‚æœ€é«˜ã®çœã‚¨ãƒç”Ÿæ´»â€¦ã„ã‚„ã€è™šç„¡ç”Ÿæ´»ã ã£ãŸãªã€‚ï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦â€¦ãŠã¤ã‹ã‚Œã•ã¾ã€ã¾ãŸæ˜æ—¥ã‚‚åŒã˜æ—¥ãŒæ¥ã‚‹ã‚ˆã€‚ã€',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_room_end',
                        description: 'æ—¥å¸¸ãŒç¶šã„ã¦ã„ãâ€¦'
                    },
                ]
            },
            bokeEnd: {
                name: 'ã¼ã‘ã‚¨ãƒ³ãƒ‰',
                description: '<br>ï¼ˆã‚‚ã†ä½•ã‚‚ã‹ã‚‚ãŒã¼ã‚“ã‚„ã‚Šã—ã¦ã„ã‚‹â€¦ï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦â€¦ãŠã¤ã‹ã‚Œã•ã¾ã€å¤§ä¸ˆå¤«ã€ã¼ããŒç›´ã—ã¦ã‚ã’ã‚‹ã‚ˆã€‚ã€',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_room_end',
                        description: 'ã¼ã‚“ã‚„ã‚Šã—ãŸæ—¥å¸¸ãŒç¶šã„ã¦ã„ãâ€¦'
                    },
                ]
            },
            roadEnd: {
                name: 'é“ç«¯ã‚¨ãƒ³ãƒ‰',
                getDescription: () => {
                    if (hasItem('tamago')) {
                        return '<br>ï¼ˆåµã‚’è²·ã£ãŸã‘ã‚Œã©â€¦å¤‰ã‚ã‚‰ã¬æ¯æ—¥ã ãªï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦åµã‚’æŒã£ãŸã¾ã¾çµ‚ã‚ã‚‹äººç”Ÿã‚‚æ‚ªããªã„ã‚ˆã€‚ã€';
                    } else {
                        return '<br>ï¼ˆä½•ã‹ã‚’è²·ã„ã«å‡ºãŸã®ã§ã¯ãªã‹ã£ãŸã‹â€¦ï¼Ÿï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦â€¦ãŠã¤ã‹ã‚Œã•ã¾ã€å¤§ä¸ˆå¤«ã€ãŠéƒ¨å±‹ã«å¸°ã‚ã†ã€‚ã€';
                    }
                },
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_room_end',
                        description: 'ã¼ã‚“ã‚„ã‚Šã—ãŸæ—¥å¸¸ãŒç¶šã„ã¦ã„ãâ€¦'
                    },
                ]
            },
            superEnd: {
                name: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¨ãƒ³ãƒ‰',
                getDescription: () => {
                    if (hasItem('tamago')) {
                        return '<br>ï¼ˆåµã‚’è²·ã£ãŸã‘ã‚Œã©â€¦å¤‰ã‚ã‚‰ã¬æ¯æ—¥ã ãªï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦åµã‚’æŒã£ãŸã¾ã¾çµ‚ã‚ã‚‹äººç”Ÿã‚‚æ‚ªããªã„ã‚ˆã€‚ã€';
                    } else {
                        return '<br>ï¼ˆä½•ã‹ã‚’è²·ã„ã«å‡ºãŸã®ã§ã¯ãªã‹ã£ãŸã‹â€¦ï¼Ÿï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦â€¦ãŠã¤ã‹ã‚Œã•ã¾ã€å¤§ä¸ˆå¤«ã€ãŠéƒ¨å±‹ã«å¸°ã‚ã†ã€‚ã€';
                    }
                },
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_room_end',
                        description: 'ã¼ã‚“ã‚„ã‚Šã—ãŸæ—¥å¸¸ãŒç¶šã„ã¦ã„ãâ€¦'
                    },
                ]
            },
            parkEnd: {
                name: 'å…¬åœ’ã‚¨ãƒ³ãƒ‰',
                getDescription: () => {
                    if (hasItem('tamago')) {
                        return '<br>ï¼ˆåµã‚’è²·ã£ãŸã‘ã‚Œã©â€¦å¤‰ã‚ã‚‰ã¬æ¯æ—¥ã ãªï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦åµã‚’æŒã£ãŸã¾ã¾çµ‚ã‚ã‚‹äººç”Ÿã‚‚æ‚ªããªã„ã‚ˆã€‚ã€';
                    } else {
                        return '<br>ï¼ˆä½•ã‹ã‚’è²·ã„ã«å‡ºãŸã®ã§ã¯ãªã‹ã£ãŸã‹â€¦ï¼Ÿï¼‰<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦â€¦ãŠã¤ã‹ã‚Œã•ã¾ã€å¤§ä¸ˆå¤«ã€ãŠéƒ¨å±‹ã«å¸°ã‚ã†ã€‚ã€';
                    }
                },
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_room_end',
                        description: 'ã¼ã‚“ã‚„ã‚Šã—ãŸæ—¥å¸¸ãŒç¶šã„ã¦ã„ãâ€¦'
                    },
                ]
            },
            muneEnd: {
                name: 'ç¾å‘³ã—ã„ã‚€ã­è‚‰ã‚¨ãƒ³ãƒ‰',
                description: 'ã‚ãªãŸã¯æ•™ã‚ã£ãŸãƒ¬ã‚·ãƒ”ã‚’è©¦ã—ã€æ¯æ—¥ã‚’ç¾å‘³ã—ãéã”ã™ã“ã¨ã«æˆåŠŸã—ã¾ã—ãŸ<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦â€¦ãƒœã‚¯ã«ã‚‚é ‚æˆ´ã€‚ã€',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_mune_end',
                        description: 'ã‚€ã­è‚‰ç¾å‘³ã—ã„'
                    },
                ]
            },
            normalEnd: {
                name: 'å°‘ã—å‰å‘ãã‚¨ãƒ³ãƒ‰',
                description: 'ã‚ãªãŸã¯èº«è¿‘ãªå ´æ‰€ã§ã‚„ã‚ŠãŒã„ã‚’è¦‹å‡ºã—ã€æ¯æ—¥ã‚’ã™ã“ã—ã ã‘æ˜ã‚‹ãã§ãã¾ã—ãŸ<br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦â€¦ãƒœã‚¯ã‚‚å®‰å¿ƒã—ãŸã‚ˆã€‚ã€',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_normal_end',
                        description: 'å°‘ã—å‰å‘ã'
                    },
                ]
            },
            normal2End: {
                name: 'å‰å‘ãã‚¨ãƒ³ãƒ‰',
                description: 'ã‚ãªãŸã¯èº«è¿‘ãªå ´æ‰€ã§ã‚„ã‚ŠãŒã„ã‚’è¦‹å‡ºã—ã€ä½™ç”Ÿã‚’æ¥½ã—ãéã”ã›ãã†ã§ã™<br>ã‚¯ãƒå¦–ç²¾ã€Œãƒãƒƒãƒ”ãƒ¼è€å¾Œã ã­ã€‚ã€',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_normal2_end',
                        description: 'å‰å‘ãï¼'
                    },
                ]
            }
        };
    
        const hintMessages = {
            room: {  
                wallposter: [
                    "æ¯›ç­†ã§æ›¸ã„ãŸæ›¸é“ä½œå“ã ",
                    "30å¹´ã»ã©å‰ã«æ›¸ã„ãŸã‚‚ã®ã ",
                    "ã‚‚ã†ã€ã“ã®ã‚ˆã†ã«ã¯æ›¸ã‘ãªã„ã ã‚ã†â€¦",
                    "æ›¸é“ã®é“å…·ã¯ã©ã“ã¸ã„ã£ãŸã®ã ã‚ã†",
                ],
                window: [
                    "ã‚«ãƒ¼ãƒ†ãƒ³ã‚’é–‹ã‘ã¦ã¿ã‚‹ã€‚",
                    "å¤–ã¯ä»Šæ—¥ã‚‚é™ã‹ã ã€‚",
                    "é ãã§å­ä¾›ã®å£°ãŒã™ã‚‹ã€‚",
                    "èª°ã¨ã‚‚ç›®ãŒåˆã‚ãªã„ã€‚"
                ],
            },
        };

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            updateCalendar();
            updateActionCounter();
            changeRoom('room');
            updateMessage('æœã ã€‚ã§ã‚‚ä»Šæ—¥ã‚‚ä½•ã‚‚ã‚„ã‚‹ã“ã¨ãŒãªã„ã€‚éŠ€è¡Œæ®‹é«˜ã‚’ç¢ºèªã—ã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’çœºã‚ã‚‹ã ã‘ã®æ—¥ã€…ã€‚â€œç”ŸããŒã„â€ã¨ã¯ãªã‚“ã ã£ãŸã®ã‹â€¦');
        }

        // éƒ¨å±‹ã‚’å¤‰æ›´
        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${IMAGES.rooms[roomId]})`;
            
            // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã‚’ç”Ÿæˆ
            generateClickableAreas(room);

            let desc = typeof room.getDescription === 'function'
            ? room.getDescription()
            : room.description;
            updateMessage(`${room.name}ã«å…¥ã‚Šã¾ã—ãŸã€‚${desc}`);
            updateActionCounter();

            const shareArea = document.getElementById('endingShareArea');
            if (shareArea) { 
                if (roomId === "end" || roomId === "dreamEnd" || roomId === "trueEnd" || roomId === "extraEnd") {
                    shareArea.style.display = "block";
                    console.log("ã‚·ã‚§ã‚¢UIã‚’è¡¨ç¤ºï¼roomId:", roomId);
                } else {
                    shareArea.style.display = "none";
                }
            }
            // BGMåˆ‡æ›¿
            if (roomId === "tvEnd" || roomId === "roomEnd" || roomId === "trueEnd" 
            || roomId === "roadEnd" || roomId === "superEnd"|| roomId === "parkEnd") {
                changeBGM("sounds/3/Sakura_Sakura-MB02-1(Reverb-Slow).mp3");
            } else if (roomId === "bokeEnd") {
                changeBGM("sounds/3/Neko_Funjatta-Xy02-1(Straight).mp3");
            } else if (roomId === "normalEnd" || roomId === "normalEnd2" || roomId === "muneEnd") {
                changeBGM("sounds/hokkori tea time.mp3");
            } else {
                changeBGM("sounds/3/heisarenai.mp3");
            }

            if (roomId!='room') {
                gameState.flags.wentOutsideToday = true;
            }

        }

        // èƒŒæ™¯ç”»åƒã‚’å·®ã—æ›¿ãˆ
        function changeRoomImage(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];
            
            // èƒŒæ™¯ç”»åƒã‚’è¨­å®šï¼ˆç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
            const roomView = document.getElementById('roomView');
            roomView.style.backgroundImage = `url(${IMAGES.rooms[roomId]})`;
            generateClickableAreas(room);
        }

        function unlockRoom(roomId) {
            if (!gameState.openRooms.includes(roomId)) gameState.openRooms.push(roomId);
            renderNavigation();
        }

        // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¨ãƒªã‚¢ã‚’ç”Ÿæˆ
        // 
        function generateClickableAreas(room) {
            const roomView = document.getElementById('roomView');
            roomView.innerHTML = '<img id="roomImage" src="'+IMAGES.rooms[gameState.currentRoom]+'" style="width:100%;height:100%;object-fit:contain;position:absolute;left:0;top:0;">';

            // ç”»åƒã®ãƒ­ãƒ¼ãƒ‰å¾Œã«é…ç½®
            const img = roomView.querySelector('#roomImage');
            img.onload = function() {

                room.clickableAreas.forEach(area => {
                    const clickableDiv = document.createElement('div');
                    clickableDiv.className = 'clickable-area';
                    clickableDiv.style.left   = (area.x) + '%';
                    clickableDiv.style.top    = (area.y) + '%';
                    clickableDiv.style.width  = (area.width) + '%';
                    clickableDiv.style.height = (area.height) + '%';
                    clickableDiv.style.position = 'absolute';
                    clickableDiv.style.zIndex = area.zIndex || 1;
                    clickableDiv.style.display = (area.usable === false) ? 'none' : 'block';
                    clickableDiv.onclick = () => handleAreaClick(area.action);
                    clickableDiv.title = area.description;

                    roomView.appendChild(clickableDiv);
                });
            };
            showGoOutsideBtn(gameState.canGoOutside && gameState.currentRoom === 'room' && !gameState.flags.genkanPuzzleSolved);
            img.src = IMAGES.rooms[gameState.currentRoom]; // å¿…ãšç”»åƒã‚»ãƒƒãƒˆ
        }

        // ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleAreaClick(action) {
            if (isActionLocked) return; // ã‚¯ãƒªãƒƒã‚¯ãƒ­ãƒƒã‚¯
            isActionLocked = true;
            if (gameState.currentActionCount >= gameState.maxActionsPerDay && action!='examine_memo') {
                // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°åˆ¤å®šï¼ˆtrueãªã‚‰advanceDayå‘¼ã°ãªã„ã§returnï¼‰
                if (checkDayBehavior()) {
                    isActionLocked = false; // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°é·ç§»ã§è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
                    return;
                }
                closeModal();
                advanceDay();
                setTimeout(() => { isActionLocked = false; }, 500); // ã¡ã‚‡ã„ä½™è£•æŒã£ã¦è§£é™¤
                return;
            }

            if (action!='examine_memo') {
                gameState.currentActionCount++;
            }
            
            
            switch(action) {
                case 'examine_tv':
                    const msgs = getTvMessage();
                    const idx = gameState.tvActionCount % msgs.length;
                    updateMessage(msgs[idx]);
                    gameState.tvActionCount++;
                    gameState.actionsToday.push("tv");
                    gameState.puzzleSequence.push("tv");

                     break;
                case 'examine_smartphone':
                    const spMsgs = getSpMessage();
                    const idxSp = gameState.spActionCount % spMsgs.length;
                    updateMessage(spMsgs[idxSp]);
                    gameState.spActionCount++;
                    gameState.actionsToday.push("sp");
                    gameState.puzzleSequence.push("sp");
                    break;
                case 'examine_pc':
                    const pcMsgs = getPcMessage();
                    const idxLaptop = gameState.laptopActionCount % pcMsgs.length;
                    updateMessage(pcMsgs[idxLaptop]);
                    gameState.laptopActionCount++;
                    gameState.actionsToday.push("laptop");
                    gameState.puzzleSequence.push("laptop");
                    break;
                case 'examine_tumbler':
                    const tumblerMsgs = getTumblerMessage();
                    const idxTumbler = gameState.tumblerActionCount % tumblerMsgs.length;
                    updateMessage(tumblerMsgs[idxTumbler]);
                    gameState.tumblerActionCount++;
                    gameState.actionsToday.push("tumbler");
                    gameState.puzzleSequence.push("tumbler");
                    break;
                case 'examine_self':
                    const selfMsgs = getSelfMessage();
                    const idxSelf = gameState.selfActionCount % selfMsgs.length;
                    updateMessage(selfMsgs[idxSelf]);
                    gameState.selfActionCount++;
                    gameState.actionsToday.push("self");
                    gameState.puzzleSequence.push("self");
                    break;
                case 'examine_book':
                    updateMessage('ãšã„ã¶ã‚“å‰ã«è²·ã£ãŸæœ¬ã€‚é€”ä¸­ã§èª­ã‚€ã®ã‚’ã‚„ã‚ã¦ã—ã¾ã£ãŸ');
                   
                    break;
                case 'examine_books1':
                    updateMessage('æ˜”å¥½ãã ã£ãŸæ™‚ä»£å°èª¬ãŒä¸¦ã‚“ã§ã„ã‚‹');
                    gameState.actionsToday.push("jidaiBook");
                    gameState.puzzleSequence.push("jidaiBook");
                    break;  
                case 'examine_books2':
                    console.log(gameState.flags.tanpopoAction);
                    if (gameState.flags.tanpopoAction == "pick") {
                        showModal(
                            'ãã†ã„ãˆã°æ˜”ã‚‚ã€å±±ã§ã‚¿ãƒ³ãƒãƒã‚’è¦‹ã¤ã‘ã¦â€¦',
                            '<img src="images/3/pic_tozan.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );
                        gameState.flags.positiveCount++;
                    } else {
                        updateMessage('æ˜”ç™»å±±ã‚’ã—ãŸæ™‚ã®ã‚¢ãƒ«ãƒãƒ ãŒã‚ã‚‹');  
                    }
                    gameState.actionsToday.push("tozanBook");
                    gameState.puzzleSequence.push("tozanBook");

                    break; 
                case 'examine_wallposter':
                    talkToHintCharacter('room','wallposter');
                    gameState.puzzleSequence.push("wallposter");
                    break; 
                case 'examine_window':
                    talkToHintCharacter('room','window');
                    gameState.puzzleSequence.push("window");
                    break; 
                case 'examine_memo':
                    if (gameState.genkanPuzzleSolved) {
                        updateMessage('æœ¬å½“ã«ä¿ºãŒæ›¸ã„ãŸã‚“ã ã£ã‘â€¦ï¼Ÿã¾ã‚ã„ã„ã‹');
                    } else {
                        showModal(
                            'ãªã‚“ã â€¦ã“ã®ãƒ¡ãƒ¢ï¼Ÿä¿ºãŒæ›¸ã„ãŸã®ã‹ï¼Ÿ',
                            '<img src="images/3/memo.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );
                        gameState.canGoOutside = true;
                        showGoOutsideBtn(true);
                    }
                    break; 
                // road
                case 'examine_tanpopo':
                    if (hasItem('tanpopo')) {
                        updateMessage('ã‚¿ãƒ³ãƒãƒãŒå’²ã„ã¦ã„ã‚‹');
                    } else {
                        showTanpopoChoice();
                    }
                    break; 
                case 'examine_road':
                    updateMessage('ã“ã‚“ãªã«ã²ã³å‰²ã‚Œã¦ã„ãŸã‚“ã ãª');
                    break;
                case 'examine_pole':
                    updateMessage('æ›¸é“æ•™å®¤ã‹â€¦');
                    gameState.flags.watchShodouSchool = true;
                    break;
                case 'examine_board':
                    updateMessage('è½ã¨ã—ç‰©ã®ãŠçŸ¥ã‚‰ã›ã ã€‚<br>å­ä¾›ãŒæã„ãŸæ§˜ãªçµµã®ã‚¢ã‚¯ã‚¹ã‚¿ã‚’ä¿ç®¡ã—ã¦ã„ã‚‹ã¨æ›¸ã„ã¦ã‚ã‚‹ã€‚');
                    gameState.flags.watchBoard = true;
                    break;
                case 'examine_child':
                    if (gameState.selectedItem=='tamago') {
                        // ãƒãƒƒãƒ‰ã‚¨ãƒ³ãƒ‰æ¼”å‡º
                        showModal(
                            'ãƒãƒƒãƒ‰ã‚¨ãƒ³ãƒ‰',
                            '<img src="images/3/fushinEnd.jpg" style="width:300px;display:block;margin:0 auto 20px;">' +
                            '<br>ã€Œã»ã‚‰ã€ã“ã‚Œé£Ÿã¹ãªã€<br><b>å­ä¾›ã€Œãªã«ï¼Ÿã“ã®ãŠã˜ã•ã‚“ï¼ã“ã‚ã„ã‚ˆãƒ¼ã€</b><br><span style="color:#f00;">ã€ãƒãƒƒãƒ‰ã‚¨ãƒ³ãƒ‰ã€‘</span><br>ã‚¯ãƒå¦–ç²¾ã€Œâ€¦æ¬¡ã¯è‡ªåˆ†ã§é£Ÿã¹ã‚ˆã†ã­ã€',
                            [{text: 'æœ€åˆã‹ã‚‰', action: 'restart'}]
                        );
                        playSE('se-siren');
                        break;
                    } else {
                        updateMessage('å­ä¾›ã€ŒãŠãªã‹ãŒã™ã„ãŸãªâ€¦ã€');
                    }
                    break; 
                // supermarket
                case 'examine_muneniku':
                    if (gameState.flags.gotMuneRecipe) {
                        updateMessage('ã›ã£ã‹ãæ•™ã‚ã£ãŸãƒ¬ã‚·ãƒ”ã€è©¦ã—ã¦ã¿ã‚‹ã‹ã€‚');
                    } else {
                        updateMessage('ã‚€ã­è‚‰ãŒå®‰ã„ãªâ€¦æ¯æ—¥ã‚€ã­è‚‰ã‚’è²·ã£ã¦ã€æ¯æ—¥ã‚€ã­è‚‰ã‚’é£Ÿã¹ã¦ã€‚ã“ã‚ŒãŒã€è€å¾Œã¨ã„ã†ã‚‚ã®ã‹ã€‚');
                    }
                    break;
                case 'examine_super_womens':
                    talkToSuperWomens();
                    break; 
                case 'examine_register':
                    if (!gameState.flags.gotMuneRecipe) {
                        if (hasItem('tamago')) {
                            updateMessage('ã‚‚ã†è²·ã„ç‰©ã¯æ¸ˆã‚“ã ');
                        } else {
                            updateMessage('åµã‚’è²·ã£ã¦ä»£é‡‘ã‚’æ”¯æ‰•ã£ãŸ');
                            IMAGES.rooms.road = 'images/3/road2.jpg';
                            addItem('tamago');
                        }         
                    } else {
                        if (hasItem('tamago')) {
                            updateMessage('ã‚‚ã†è²·ã„ç‰©ã¯æ¸ˆã‚“ã ');
                        } else {
                            updateMessage('åµã¨ã‚€ã­è‚‰ã¨å¡©ã“ã†ã˜ã‚’è²·ã£ã¦ä»£é‡‘ã‚’æ”¯æ‰•ã£ãŸ');
                            IMAGES.rooms.road = 'images/3/road2.jpg';
                            addItem('tamago');
                            addItem('muneniku');
                            addItem('shiokoji');
                        }          
                    } 
                    gameState.flags.gotEgg = true;
                    break;  
                // park
                case 'examine_kids':
                    updateMessage('å£°ã‚’ã‹ã‘ã‚Œã°ä¸å¯©è€…ã€‚â€¦â€¦ã“ã®æ­³ã«ãªã‚‹ã¨ã€ãŸã ãã‚Œã ã‘ã§å£ãŒã§ãã‚‹ã€‚');
                    break;
                case 'examine_womens':
                    if (!gameState.flags.gotMuneRecipe) {
                        updateMessage('ã‚ã‚ã‚„ã£ã¦ã€èª°ã‹ã¨ä»–æ„›ãªã„è©±ã‚’ã§ããŸã®ã¯ã„ã¤ã ã£ãŸã‹â€¦â€¦æ€ã„å‡ºã›ãªã„ã€‚');
                    } else {
                        updateMessage('ä¼šè©±ã‚‚æ¥½ã—ã„ã‚‚ã‚“ã ã‚ˆãªâ€¦');
                    }
                    break; 
                case 'examine_shogiman':
                    talkToShogiman();
                    break; 
                case 'examine_mushokuman':
                    if (gameState.positiveCount>1 && !gameState.flags.gotMuneRecipe) {
                        showModal(
                            'æš‡ãã†ãªç”·æ€§ã¨ç›®ãŒã‚ã†ã¨ã€è©±ã—ã‹ã‘ã‚‰ã‚ŒãŸã€‚<br>â€¦å¶ç„¶ç›®ãŒåˆã£ãŸã ã‘ãªã®ã«ã€ã„ã¤ã®é–“ã«ã‹ã‚€ã­è‚‰è«‡ç¾©ã«èŠ±ãŒå’²ã„ãŸã€‚<br>â€œå¡©éº¹ã«ã¤ã‘ã¦ã¿ã‚‹ã¨ã„ã„ã§ã™ã‚ˆâ€â€•â€•ã¡ã‚‡ã£ã¨ã—ãŸç™ºè¦‹ã ã£ãŸã€‚',
                            '<img src="images/3/mushokuman1.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                        );
                        gameState.flags.gotMuneRecipe = true;
                        gameState.maxActionsPerDay += 2;
                        window._nextModal = {
                            before: function() { playSE('se-inspiration'); },
                            title: 'ãªã‚“ã ã‹ä»Šæ—¥ã¯ã‚‚ã†å°‘ã—å‹•ã‘ãã†ãªæ°—ãŒã™ã‚‹â€¦<br>ï¼ˆè¡Œå‹•å›æ•°ãŒå¢—ãˆãŸï¼ï¼‰',
                            content: '<img src="images/3/sub_clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                            buttons: [{text: 'é–‰ã˜ã‚‹', action: 'close'}],
                            after: null 
                        };
                        
                    } else {
                        updateMessage('æš‡ãã†ãªç”·æ€§ã¨ç›®ãŒã‚ã„ã€è»½ãä¼šé‡ˆã—ãŸã€‚');
                    }  
                    break; 
                case 'examine_watage':
                    updateMessage('ç¶¿æ¯›ãŒãµã‚ã‚Šã¨å®™ã‚’èˆã£ãŸ');
                    break;  

                case 'examine_room_end':
                    updateMessage('ã‚ãªãŸã¯å¤‰ã‚ã‚‰ã¬æ—¥å¸¸ã‚’éã”ã—ã¾ã—ãŸã€‚ï¼ˆãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰ï¼‰');
                    break; 
                case 'examine_normal_end':
                    updateMessage('ã‚ãªãŸã¯ã™ã“ã—ã ã‘å‰å‘ãã«æš®ã‚‰ã—ã¾ã—ãŸã€‚ï¼ˆãƒã‚¸ãƒ†ã‚£ãƒ–ã‚¨ãƒ³ãƒ‰1ï¼‰');
                    break; 
                case 'examine_normal2_end':
                    updateMessage('ã‚ãªãŸã¯ã„ãã„ãã¨å‰å‘ãã«æš®ã‚‰ã—ã¾ã—ãŸã€‚ï¼ˆãƒã‚¸ãƒ†ã‚£ãƒ–ã‚¨ãƒ³ãƒ‰2ï¼‰');
                    break; 
                case 'examine_mune_end':
                    updateMessage('ã‚ãªãŸã¯ç¾å‘³ã—ã„æ—¥å¸¸ã‚’éã”ã—ã¾ã—ãŸã€‚ï¼ˆã‚€ã­è‚‰ã‚¨ãƒ³ãƒ‰ï¼‰');
                    break; 

            }
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;
            updateActionCounter();

            playSE('se-click');
            updateInventoryDisplay();

            if (gameState.currentRoom=='room' && !gameState.flags.memoAppeared) {
                checkPuzzleSequence();
            }
            setTimeout(() => { isActionLocked = false; }, 300); // ã¡ã‚‡ã„ä½™è£•æŒã£ã¦è§£é™¤
        }

        function talkToHintCharacter(roomId, charId) {
            // flagså–å¾—
            let flags = gameState[roomId].flags;
            // ã¾ã ã‚«ã‚¦ãƒ³ãƒˆç„¡ã‘ã‚Œã°åˆæœŸåŒ–
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
            flags.talkTo[charId]++;
            const count = flags.talkTo[charId];

            // ã‚»ãƒªãƒ•ãƒªã‚¹ãƒˆå–å¾—
            const messages = hintMessages[roomId][charId];
            // ç¯„å›²å¤–ãªã‚‰æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const idx = (flags.talkTo[charId] - 1) % messages.length;
            const loop = Math.floor((count - 1) / messages.length) + 1;

            // è¡¨ç¤º
            let message = messages[idx];
            if (loop > 1) {
                message += "ï¼ˆã¾ãŸåŒã˜ã“ã¨ã‚’è€ƒãˆã¦ã„ã‚‹æ°—ãŒã™ã‚‹â€¦ï¼‰";
            }
            updateMessage(message);
            
        }

        // ç„é–¢ãƒ‘ã‚ºãƒ«ã‚’è¡¨ç¤º
        function showGenkanPuzzle() {
            const modalContent = `
                <h3>å…¥åŠ›ãƒ‘ãƒãƒ«</h3>
                <p>ä½•ã‚’è²·ã†ã‚“ã ã£ã‘ï¼Ÿ</p>
                <input type="text" class="puzzle-input" id="genkanInput" placeholder="è²·ã†ã‚‚ã®ã‚’å…¥åŠ›ï¼ˆä¾‹:ã‚€ã­è‚‰ï¼‰">
                <br>
                <button onclick="checkGenkanPuzzle()">ç¢ºèª</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ç„é–¢ãƒ‘ã‚ºãƒ«ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkGenkanPuzzle() {
            const input = document.getElementById('genkanInput').value;
            if (input === 'ãŸã¾ã”' || input === 'åµ' || input === 'ã‚¿ãƒã‚´') {
                closeModal();
                updateMessage('ãã†ã ã€ãã†ã ã£ãŸãª');
                playSE('se-subclear');
                showModal(
                    'å¤–ã¸å‡ºã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚å°‘ã—æ°—åŠ›ãŒã‚ã„ãŸã€‚<br>ï¼ˆè¡Œå‹•å›æ•°ã‚¢ãƒƒãƒ—ï¼ï¼‰',
                    '<img src="images/3/sub_clear.jpg" style="width:300px;display:block;margin:0 auto 20px;">',
                    [{text: 'é–‰ã˜ã‚‹', action: 'close'}]
                );
                unlockRoom('road');
                unlockRoom('park');
                unlockRoom('supermarket');
                renderNavigation();
                showGoOutsideBtn(false);
                gameState.flags.genkanPuzzleSolved = true;
                gameState.maxActionsPerDay += 3;
                changeRoom('road');

            } else {
                playSE('se-error');
                closeModal();
                showEnding('bokeEnd');
            }
        }
        
        function showTanpopoChoice() {
            showModal(
                'é“ç«¯ã«å°ã•ãªã‚¿ãƒ³ãƒãƒãŒå’²ã„ã¦ã„ã‚‹ã€‚ã©ã†ã™ã‚‹ï¼Ÿ',
                '<img src="images/3/tanpopo.jpg" style="width:220px;display:block;margin:0 auto 18px;">',
                [
                    { text: 'æ‘˜ã‚“ã§æŒã¡å¸°ã‚‹', action: 'pickTanpopo' },
                    { text: 'ãã®ã¾ã¾çœºã‚ã‚‹', action: 'watchTanpopo' },
                    { text: 'é€šã‚Šéãã‚‹', action: 'ignoreTanpopo' }
                ]
            );
        }

        function pickTanpopo() {
            closeModal();
            updateMessage("ã‚¿ãƒ³ãƒãƒã‚’æ‘˜ã‚“ã ã€‚ãªã‚“ã¨ãªãæ‡ã‹ã—ã„æ°—æŒã¡ã«ãªã£ãŸã€‚");
            addItem('tanpopo');
            gameState.flags.tanpopoAction = "pick";
        }

        function watchTanpopo() {
            closeModal();
            updateMessage("ã—ã°ã‚‰ãçœºã‚ã¦ã„ãŸã‚‰ã€èª°ã‹ã«è©±ã—ã‹ã‘ã‚‰ã‚ŒãŸæ°—ãŒã—ãŸã€‚<br>â€¦ã„ã‚„ã€æ°—ã®ã›ã„ã ã£ãŸã€‚");
            gameState.flags.tanpopoAction = "watch";
        }

        function ignoreTanpopo() {
            closeModal();
            updateMessage("ä½•ã‚‚ã›ãšé€šã‚ŠéããŸã€‚");
            gameState.flags.tanpopoAction = "ignore";
        }

        function talkToSuperWomens() {
            if (gameState.flags.keyHolderAction==null && gameState.flags.watchBoard) {
                showModal(
                    'å¥³æ€§ãŸã¡ãŒå­«ã®çµµã‚’ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ã«ã™ã‚‹ã®ãŒæ¥½ã—ã„ã¨è©±ã—ã¦ã„ã‚‹ã€‚',
                    'ä¸€äººã€ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç„¡ãã—ã¦ã—ã¾ã£ãŸäººãŒã„ã‚‹ã‚ˆã†ã ',
                    // '<img src="images/tanpopo.jpg" style="width:220px;display:block;margin:0 auto 18px;">',
                    [
                        { text: 'è½ã¨ã—ç‰©æ²ç¤ºæ¿ã®ã“ã¨ã‚’ä¼ãˆã‚‹', action: 'tellKeyholder' },
                        { text: 'é€šã‚Šéãã‚‹', action: 'ignoreKeyholder' }
                    ]
                );
            } else {
                updateMessage("å¥³æ€§ãŸã¡ãŒå­«ã®è©±é¡Œã§ç››ã‚Šä¸ŠãŒã£ã¦ã„ã‚‹");
            }    
        }

        function tellKeyholder() {
            closeModal();
            updateMessage("å¥³æ€§ã€Œã¾ã‚ï¼æœ¬å½“ã§ã™ã‹ã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã€<br>â€¦æ‚ªããªã„æ°—åˆ†ã ã€‚");
            playSE('se-inspiration');
            gameState.flags.keyHolderAction = "tell";
            gameState.positiveCount++;
        }

        function ignoreKeyholder() {
            closeModal();
            updateMessage("ä½•ã‚‚ã›ãšé€šã‚ŠéããŸã€‚");
            gameState.flags.keyHolderAction = "ignore";
        }

        function talkToShogiman() {
            if (!gameState.flags.playShogi) {
                showModal(
                    'ç”·æ€§ã«å°†æ£‹ã‚’ä¸€ç·’ã«ã—ãªã„ã‹ã¨èª˜ã‚ã‚ŒãŸ',
                     '<img src="images/3/shogiman.jpg" style="width:220px;display:block;margin:0 auto 18px;">',
                    [
                        { text: 'ã‚ã‚ŠãŒãŸãã”ä¸€ç·’ã™ã‚‹', action: 'playShogi' },
                        { text: 'å¿™ã—ã„ã®ã§â€¦', action: 'rejectShogi' }
                    ]
                );
            } else {
                updateMessage("å°†æ£‹ã§éŠã‚“ã§ã„ã‚‹é«˜é½¢è€…ãŸã¡ã ");
            }    
        }

        function playShogi() {
            closeModal();
            updateMessage("ä¸€ç·’ã«å°†æ£‹ã‚’æ¥½ã—ã‚“ã ã€‚<br>ã“ã†ã„ã†ã®ã‚‚æ‚ªããªã„ãªâ€¦");
            playSE('se-inspiration');
            gameState.flags.playShogi = true;
            gameState.positiveCount++;
        }

        function rejectShogi() {
            closeModal();
            updateMessage("ç«‹ã¡å»ã£ãŸã€‚");
            gameState.flags.playShogi = false;
        }


        // ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 5) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }
            
        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}ã‚’é¸æŠã—ã¾ã—ãŸã€‚ä½¿ç”¨ã—ãŸã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay(); 
            }
        }

        function getItemName(itemId) {
            const names = {
                key: 'éµ',
                tamago: 'åµ',
                muneniku: 'ã‚€ã­è‚‰',
                shiokoji: 'å¡©ã“ã†ã˜',
                tanpopo: 'ä¸€è¼ªã®ã‚¿ãƒ³ãƒãƒ',
                book: 'ã‚³ã‚°ãƒã®å¤§å†’é™ºã®çµµæœ¬',
            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;
                btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªè¡¨ç¤ºæ›´æ–°
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function() {
                        // ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                }
                // â˜…é¸æŠä¸­ãªã‚‰selectedã‚¯ãƒ©ã‚¹è¿½åŠ 
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
        function updateMessage(message) {
            document.getElementById('messageText').innerHTML = message;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(title, content, buttons) {
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            buttons.forEach(button => {
                modalHtml += `<button onclick="${button.action === 'close' ? 'closeModal' : button.action === 'restart' ? 'restartGame()' : button.action}()">${button.text}</button>`;
            });
            
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // æ¬¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
            if (window._nextModal) {
                // ç™»éŒ²å†…å®¹ã¯ {title, content, buttons, after} ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                let modal = window._nextModal;
                window._nextModal = null; // ã‚¯ãƒªã‚¢
                if (modal.before) modal.before(); // ã‚‚ã—playSEãªã©äº‹å‰å‡¦ç†ã—ãŸã‘ã‚Œã°
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after(); // ã‚‚ã—showModalç›´å¾Œã«ã‚„ã‚ŠãŸã„ã“ã¨ã‚ã‚Œã°
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
        function restartGame() {
            gameState = {
                currentRoom: 'room',
                openRooms: ['room'], 
                currentDay:1,
                currentActionCount:0,
                maxActionsPerDay: defaltActions,
                puzzleSequence: [],
                wentOutsideToday: false,
                canGoOutside: false,
                tvActionCount: 0,          // ä»Šæ—¥ãƒ†ãƒ¬ãƒ“è¦‹ãŸå›æ•°
                tvConsecutiveDays: 0,      // ãƒ†ãƒ¬ãƒ“ã ã‘ã®æ—¥ãŒä½•æ—¥ç¶šã„ãŸã‹
                laptopActionCount: 0,
                tumblerActionCount: 0,
                spActionCount: 0,
                selfActionCount: 0,
                actionsToday: [],          // ä»Šæ—¥ã‚„ã£ãŸã“ã¨ï¼ˆ"tv", "window", ...ï¼‰
                memoAppeared: false,
                genkanPuzzleSolved: false,
                tanpopoAction: null,
                keyHolderAction: null,
                watchBoard: false,
                watchShodouSchool: false,
                gotEgg: false,
                gotMuneRecipe: false,
                playShogi: false,
                positiveCount: 0,
                inventory: [],
                room: {
                    flags: {
                        talkTo: {
                        }, 
                    }
                },
                park: {
                    flags: {
                        talkTo: {
                            mushokuman:0,
                            shogiman:0,
                            child:0,
                        },
                    }
                },
                road: {
                    flags: {
                        
                    }
                },
                supermarket: {
                    flags: { 
                    }
                },
                flags: {
                    mushokumanFavor :0,
                    shogimanFavor :0,
                    dayCount:0,   
                },
                selectedItem: null
            };
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;   // â†ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å†ç”Ÿã—ã¦ãªã„
        let isBGMInitialized = false; // åˆå›ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç”¨

        // åˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã ã‘BGMã‚’å†ç”Ÿ
        function initBGMOnce() {
        if (!isBGMInitialized) {
            const bgm = document.getElementById('bgm');
            bgm.volume = 0.3;
            bgm.play();
            isBGMPlaying = true;
            isBGMInitialized = true;
            document.getElementById('bgm-toggle').textContent = "ğŸ”Š BGM";
        }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "ğŸ”Š BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "ğŸ”‡ BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            if (bgm.src.endsWith(newSrc)) return; // ã™ã§ã«ãã®BGMãªã‚‰ä½•ã‚‚ã—ãªã„
            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // ã©ã“ã‹ã§æœ€åˆã«ä¸€åº¦ã ã‘å‘¼ã¶
        function preloadImages() {
            Object.values(IMAGES.rooms).forEach(src => {
                const img = new Image();
                img.src = src;
            });
            Object.values(IMAGES.items).forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        function shareOnTwitter(resultType) {
            // ä¾‹ï¼šresultType = "true_end" or "normal_end"
            let url = encodeURIComponent(location.href);
            let text;
            if (resultType === "true_end") {
                text = encodeURIComponent("è„±å‡ºã‚²ãƒ¼ãƒ ã€ãƒªã‚¿ã‚¤ã‚¢ãŠã˜ã•ã‚“ã®è„±å‡ºã€ã§çœŸã‚¨ãƒ³ãƒ‰é”æˆï¼ #è„±å‡ºã‚²ãƒ¼ãƒ ");
            } else {
                text = encodeURIComponent("è„±å‡ºã‚²ãƒ¼ãƒ ã€ãƒªã‚¿ã‚¤ã‚¢ãŠã˜ã•ã‚“ã®è„±å‡ºã€ã‚’ã‚¯ãƒªã‚¢ï¼ #è„±å‡ºã‚²ãƒ¼ãƒ ");
            }
            window.open(`https://x.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }
        function copyShareText() {
            let text = "è„±å‡ºã‚²ãƒ¼ãƒ ã€ãƒªã‚¿ã‚¤ã‚¢ãŠã˜ã•ã‚“ã®è„±å‡ºã€ã‚’ã‚¯ãƒªã‚¢ï¼ #è„±å‡ºã‚²ãƒ¼ãƒ  " + location.href;
            navigator.clipboard.writeText(text).then(() => alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'));
        }

        let isAdvancingDay = false;
        function advanceDay() {
            isActionLocked = true;
            if (isAdvancingDay) return;
            isAdvancingDay = true;
            const overlay = document.getElementById('roomEffectOverlay');
            const overlayText = document.getElementById('overlayText');

            // æš—è»¢å‰ã«ä¸€è¨€è¡¨ç¤º
            overlay.style.opacity = 0.0;
            overlayText.textContent = 'å¤œã«ãªã£ãŸâ€¦';
            overlay.style.pointerEvents = "all"; // ãƒ–ãƒ­ãƒƒã‚¯
            overlay.style.opacity = 1;
            setTimeout(() => {
                // ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆã™ or æœç”¨ã«åˆ‡ã‚Šæ›¿ãˆ
                overlayText.textContent = 'ã¾ãŸä¸€æ—¥ãŒå§‹ã¾ã£ã¦ã—ã¾ã£ãŸ';
                // æ—¥ä»˜ãƒ»ã‚«ã‚¦ãƒ³ãƒˆé€²è¡Œ
                gameState.currentDay++;
                gameState.currentActionCount = 0;

                gameState.tvActionCount = 0;
                gameState.selfActionCount = 0;
                gameState.tumblerActionCount = 0;
                gameState.laptopActionCount = 0;
                gameState.spActionCount = 0;
                gameState.actionsToday = [];
                updateCalendar();
                
                changeRoom('room');

                // å°‘ã—é–“ã‚’ç©ºã‘ã¦æš—è»¢è§£é™¤
                setTimeout(() => {
                    overlay.style.opacity = 0;
                    overlayText.textContent = ''; // æœãƒ†ã‚­ã‚¹ãƒˆã‚‚æ¶ˆã™
                    if (!gameState.flags.wentOutsideToday) {
                        gameState.maxActionsPerDay = Math.max(3, gameState.maxActionsPerDay - 2);
                        updateMessage("â€¦ä½•ã‚‚ã—ãªã„æ—¥ãŒç¶šãã¨ã€ã€ã©ã‚“ã©ã‚“å‹•ã‘ãªããªã£ã¦ã„ãã€‘æ°—ãŒã™ã‚‹ã€‚");
                    } else {
                        gameState.maxActionsPerDay = defaltActions;
                        updateMessage('ã¾ãŸä¸€æ—¥ãŒå§‹ã¾ã£ã¦ã—ã¾ã£ãŸ');
                    }
                    updateActionCounter();
                    gameState.flags.wentOutsideToday = false; // æ¯æ—¥ãƒªã‚»ãƒƒãƒˆ 
                    overlay.style.pointerEvents = "none";
                }, 1000);

            }, 900); // æœ€åˆã®å¤œãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºï¼‹æš—è»¢æ™‚é–“
            setTimeout(() => { isAdvancingDay = false; isActionLocked = false; }, 300);
        }

        function updateCalendar() {
            document.getElementById("calendar").textContent = `ç¬¬${gameState.currentDay}æ—¥`;
        }

        function updateActionCounter() {
            const counter = document.getElementById('actionCounter');
            console.log(counter);
            if (counter) {
                if (
                    gameState.flags.genkanPuzzleSolved)
                {
                    counter.innerText = `æ®‹ï¼š${gameState.maxActionsPerDay - gameState.currentActionCount}å›`;
                    counter.style.display = 'block';
                } else {
                    counter.innerText = "";
                    counter.style.display = 'none';
                }
            } 
        }

        let isEndingShowing = false;
        function checkDayBehavior() {
            if (isEndingShowing) return true; // ã™ã§ã«ã‚¨ãƒ³ãƒ‰é·ç§»ä¸­ãªã‚‰ä½•ã‚‚å‡¦ç†ã—ãªã„
            // ãƒ†ãƒ¬ãƒ“ã ã‘ï¼ˆactionsTodayãŒ"tv"ã ã‘ or tvActionCount === currentActionCountï¼‰
            if (gameState.actionsToday.length > 0 &&
                gameState.actionsToday.every(action => action === "tv")) {
                gameState.tvConsecutiveDays++;
            } else {
                gameState.tvConsecutiveDays = 0;
            }

            if (gameState.tvConsecutiveDays >= 3) {
                isEndingShowing = true;
                showEnding('tvEnd');
                playSE('se-warp');
                return true;
            // å¤–ã«å‡ºã¦ãªã„
            } else if (gameState.currentDay>2 && !gameState.flags.genkanPuzzleSolved) {
                isEndingShowing = true;
                showEnding('roomEnd');
                playSE('se-warp');
                return true;
            } else if (gameState.currentDay>2 && gameState.flags.gotMuneRecipe && hasItem('muneniku') 
            && hasItem('shiokoji')) {
                isEndingShowing = true;
                showEnding('muneEnd');
                playSE('se-warp');
                return true;
            } else if (gameState.currentDay>2 && gameState.positiveCount>1) {
                isEndingShowing = true;
                showEnding('normal2End');
                playSE('se-warp');
                return true;
            } else if (gameState.currentDay>2 && gameState.positiveCount>0) {
                isEndingShowing = true;
                showEnding('normalEnd');
                playSE('se-warp');
                return true;
            } else if (gameState.currentDay>2 && gameState.currentRoom == 'road') {
                isEndingShowing = true;
                showEnding('roadEnd');
                playSE('se-warp');
                return true;
            } else if (gameState.currentDay>2 && gameState.currentRoom == 'supermarket') {
                isEndingShowing = true;
                showEnding('superEnd');
                playSE('se-warp');
                return true;
            } else if (gameState.currentDay>2 && gameState.currentRoom == 'park') {
                isEndingShowing = true;
                showEnding('parkEnd');
                playSE('se-warp');
                return true;
            } 
            return false;
        }

        function showEnding(endId) {
            gameState.currentEndId = endId;
            if (endId=='bokeEnd') {
                playSE('se-flash');
            }
            endingTransition(() => {
                
                
            });   
        }

        function endingTransition(callback, text = "") {
            document.getElementById('roomImage').style.display='none';
            const overlay = document.getElementById('roomEffectOverlay');
            overlay.style.background = "white";
            overlay.style.opacity = "0";
            overlay.style.transition = "opacity 0.7s";
            overlay.querySelector("#overlayText").textContent = text;
            overlay.querySelector("#overlayText").style.color = "#333";
            overlay.style.display = "block"; 
            setTimeout(() => {
                overlay.style.opacity = "1";
                setTimeout(() => {
                    overlay.style.opacity = "0";
                    changeRoom(gameState.currentEndId);
                    document.getElementById('roomImage').style.display='none';
                    document.getElementById("calendar").style.display = "none"; 
                    document.getElementById("actionCounter").style.display = "none"; 
                    setTimeout(() => {
                        overlay.style.display = "none";
                        if (callback) callback(); 
                    }, 900);
                }, 750);
                
            }, 50);
        }

        function checkPuzzleSequence() {
            const correct = ['window', 'sp', 'tv'];
            if (gameState.puzzleSequence.length >= 3) {
                const lastThree = gameState.puzzleSequence.slice(-3);
                if (JSON.stringify(lastThree) === JSON.stringify(correct)) {
                    gameState.flags.memoAppeared = true;
                    IMAGES.rooms.room = 'images/3/room2.jpg';
                    // ãƒ¡ãƒ¢ãŒç¾ã‚ŒãŸæ¼”å‡º
                    updateMessage("ç•³ã®ä¸Šã«ä¸€æšã®ãƒ¡ãƒ¢ãŒç½®ã‹ã‚Œã¦ã„ã‚‹ã®ã«æ°—ã¥ã„ãŸã€‚");
                    changeRoomImage('room');
                    generateClickableAreas('room');
                }
            }
        }

        function showGoOutsideBtn(show) {
            console.log('showGoOutsideBtn called. show:', show); // â†ç¢ºèªç”¨
            const btn = document.getElementById('goOutsideBtn');
            if (!btn) return;
            btn.style.display = show ? 'block' : 'none';
        }

        function getTvMessage() {
            const day = gameState.currentDay;
            const messages = tvMessagesByDay[day];
            if (gameState.positiveCount >= 2) {
                // ãƒã‚¸ãƒ†ã‚£ãƒ–å›æ•°ãŒ2ä»¥ä¸Šãªã‚‰ã€æ˜ã‚‹ã„/å‰å‘ããƒãƒ¼ã‚¸ãƒ§ãƒ³
                return [
                    "ä»Šæ—¥ã¯åŒã˜ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã‚‚ã€ã¡ã‚‡ã£ã¨é•ã†æ°—åˆ†ã§è¦‹ã‚‰ã‚ŒãŸã€‚",
                    "â€œå¤‰ã‚ã‚‰ãªã„æ¯æ—¥â€ã‚‚ã€æ‚ªããªã„ã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚",
                    "ä½•ã‹ã‚’å§‹ã‚ã¦ã¿ã‚ˆã†ã‹ãªã€ãªã‚“ã¦æ€ã£ã¦ã—ã¾ã†ã€‚"
                ];
            } else if (gameState.positiveCount === 1) {
                // ã¡ã‚‡ã£ã¨ã ã‘å‰å‘ã
                return [
                    "ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒå°‘ã—ã ã‘é•ã£ã¦èã“ãˆãŸæ°—ãŒã™ã‚‹ã€‚",
                    "ä»Šæ—¥ã¯ãªã‚“ã¨ãªããƒ†ãƒ¬ãƒ“ã‚‚æ‚ªããªã„ã€‚",
                ];
            } else {
                // é€šå¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³
                return messages;
            }
        }

        function getSelfMessage() {
            const day = gameState.currentDay;
            const messages = selfMessagesByDay[day];
            if (gameState.positiveCount >= 2) {
                return [
                    "å°‘ã—ã ã‘å‰å‘ããªæ°—åˆ†ã ã€‚",
                    "ä»Šæ—¥ã¯ä½•ã‹å¤‰ã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€ãã‚“ãªæ°—ãŒã™ã‚‹ã€‚"
                ];
            } else if (gameState.positiveCount === 1) {
                // ã¡ã‚‡ã£ã¨ã ã‘å‰å‘ã
                return [
                    "ä»Šæ—¥ã¯æ˜¨æ—¥ã‚ˆã‚Šã‚‚å°‘ã—ä½“ãŒè»½ã„ã€‚",
                    "æ•£æ­©ã§ã‚‚ã—ã¦ã“ã‚ˆã†ã‹",
                ];
            } else {
                // é€šå¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³
                return messages;
            }
            return messages;
        }

        function getTumblerMessage() {
            const day = gameState.currentDay;
            const messages = tumblerMessagesByDay[day];
            if (gameState.positiveCount >= 2) {
                return [
                    "ä»Šæ—¥ã®ãŠèŒ¶ã¯ã†ã¾ã„ã€‚",
                    "é£²ã¿å¹²ã™ã¨ã•ã‚ã‚„ã‹ãªæ°—åˆ†ã«ãªã£ãŸ"
                ];
            } else if (gameState.positiveCount === 1) {
                // ã¡ã‚‡ã£ã¨ã ã‘å‰å‘ã
                return [
                    "æ¸©ã‹ã„ãŠèŒ¶ã ",
                    "ä¿æ¸©ã§ãã‚‹ã®ã§ä¾¿åˆ©ãªã‚¿ãƒ³ãƒ–ãƒ©ãƒ¼ã ",
                ];
            } else {
                // é€šå¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³
                return messages;
            }
            return messages;
        }

        function getSpMessage() {
            const day = gameState.currentDay;
            const messages = spMessagesByDay[day];
            if (gameState.positiveCount >= 2) {
                return [
                    "ã‚²ãƒ¼ãƒ ã§ã‚‚ã—ã¦ã¿ã‚ˆã†ã‹",
                    "æ˜”ã®çŸ¥äººã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã¿ã‚‹ã‹â€¦"
                ];
            } else if (gameState.positiveCount === 1) {
                // ã¡ã‚‡ã£ã¨ã ã‘å‰å‘ã
                return [
                    "ä»Šæ—¥ã®äºˆå®šã¯ã‚ã£ãŸã‹ãªâ€¦",
                    "å¤©æ°—äºˆå ±ã‚’è¦‹ã¦ã¿ã‚ˆã†",
                ];
            } else {
                // é€šå¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³
                return messages;
            }
            return messages;
        }

        function getPcMessage() {
            const day = gameState.currentDay;
            const messages = pcMessagesByDay[day];
            if (gameState.positiveCount >= 2) {
                return [
                    "æ–™ç†ãƒ¬ã‚·ãƒ”ã§ã‚‚æ¤œç´¢ã—ã¦ã¿ã‚‹ã‹",
                    "ãƒ¡ãƒ¼ãƒ«ãŒæ¥ã¦ã„ã‚‹ã‚ˆã†ã "
                ];
            } else if (gameState.positiveCount === 1) {
                // ã¡ã‚‡ã£ã¨ã ã‘å‰å‘ã
                return [
                    "ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’æ•´ç†ã—ã¦ãŠã“ã†",
                    "å‹•ç”»ã‚µã‚¤ãƒˆã§ã‚‚è¦‹ã¦ã¿ã‚‹ã‹",
                ];
            } else {
                // é€šå¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³
                return messages;
            }
            return messages;
        }


        function saveGame() {
            localStorage.setItem('escapeGameState', JSON.stringify(gameState));
            const oldMsg = document.getElementById('messageText').innerHTML;
            updateMessage('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼');
            setTimeout(() => {
                updateMessage(oldMsg);
            }, 1500);
        }

        function loadGame() {
            const saved = localStorage.getItem('escapeGameState');
            if (saved) {
                gameState = JSON.parse(saved);
                // UIã‚„ç”»é¢ã‚’stateã«åˆã‚ã›ã¦å¾©å…ƒã™ã‚‹
                changeRoom(gameState.currentRoom);
                updateInventoryDisplay();
                renderNavigation();
                updateCalendar();
                updateActionCounter();
                updateMessage('ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
            } else {
                updateMessage('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        preloadImages();
        initGame();
    </script>
</body>
</html>