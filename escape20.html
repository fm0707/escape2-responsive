<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Áü≥ÂÆ§„ÇíËàûÂè∞„Å´„Åó„ÅüÂàÜÂ≤ê„Ç®„É≥„Éâ‰ªò„Åç„ÅÆÁÑ°ÊñôËÑ±Âá∫„Ç≤„Éº„É†„ÄÇÂÖ®4„Ç®„É≥„Éâ„ÅÆ„Éû„É´„ÉÅ„Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÄÇ„Çπ„Éû„ÉõÔºÜPCÂØæÂøú„ÄÇ">
    <title>Áü≥ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;
            /* ‚Üê„Åì„ÇåÈáçË¶Å */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #gameCanvas {
            position: relative;
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
        }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            /* flex: 1; */
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 12px;
            /* width:100%; */
        }

        .inventory-slot {
            width: 14vw;
            height: 14vw;
            max-width: 80px;
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;
            /* ÈáëËâ≤„ÉªÂ§™„ÇÅÊé®Â•® */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .magnifier-btn {
            position: absolute;
            right: 4px;
            bottom: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0002;
            cursor: pointer;
            z-index: 10;
            transition: box-shadow .15s;
        }

        .magnifier-btn:hover {
            box-shadow: 0 0 10px #ffd70099;
        }

        .magnifier-btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .info-panel {
            width: 100%;
            padding: 2px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 2px;
            height: 65px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        #msgText {}

        #statusIconArea {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px #0005;
            font-size: 1.4em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        #modalButtons button {
            border: none;
            background: none;
            padding: 0;
            margin: 0 10px 10px 0;
            cursor: pointer;
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
            border-radius: 10px;
        }

        #modalButtons button img {
            width: 80px;
            height: 80px;
            vertical-align: middle;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
        }

        #modalButtons button:hover img {
            filter: brightness(1.08) drop-shadow(0 2px 6px #ffd70050);
            box-shadow: 0 0 10px #ffd70080;
            transform: scale(1.05);
        }

        #modalButtons button:active img,
        #modalButtons button.pressed img {
            filter: brightness(0.95) grayscale(20%);
            box-shadow: 0 0 8px #3332;
            transform: scale(0.97);
        }

        #modalButtons button:disabled img {
            filter: grayscale(90%) opacity(0.5);
            box-shadow: none;
        }

        /* „ÉÜ„Ç≠„Çπ„ÉàÂûã„Éú„Çø„É≥„ÇÇÁîªÂÉè„Éú„Çø„É≥È¢®„Å´ */
        #modalButtons button.text-btn {
            min-width: 120px;
            font-size: 1.15em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            margin: 0 10px 10px 0;
            box-shadow: 0 4px 14px #ffc90022;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s, transform 0.08s;
            vertical-align: middle;
            display: inline-block;
        }

        #modalButtons button.text-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
            transform: scale(1.05);
        }

        #modalButtons button.text-btn:active {
            filter: brightness(0.96);
            transform: scale(0.97);
        }

        #modalButtons button.text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Èñâ„Åò„Çã„Éú„Çø„É≥ */
        #modalClose .modal-close-btn {
            display: inline-block;
            min-width: 160px;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            box-shadow: 0 4px 14px #ffc90022;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s;
        }

        #modalClose .modal-close-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        .login-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            width: 280px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'Segoe UI', sans-serif;
        }

        .login-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .login-form label {
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .login-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .login-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ÁîªÂÉè„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }

        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            /* width: 40%; */
        }

        @media (max-width: 600px) {
            #msgText {
                font-size: .8rem;
            }

            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }

            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width: 100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }

        #roomEffectOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }

        .title-wrapper {
            display: flex;
            width: 100%;
        }

        @keyframes warpFlash {
            0% {
                opacity: 0
            }

            15% {
                opacity: .95
            }

            50% {
                opacity: .4
            }

            100% {
                opacity: 0
            }
        }

        @keyframes chroma {
            0% {
                filter: none
            }

            100% {
                filter: contrast(1.2) saturate(1.2) hue-rotate(20deg)
            }
        }

        .warp-active {
            background: radial-gradient(circle at 50% 50%, #fff, #000 70%);
            animation: warpFlash 900ms ease-out both, chroma 900ms ease-out both;
        }

        #hintModal {
            color: #000;
        }

        @keyframes glowPulse {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            60% {
                opacity: 0.9;
            }

            100% {
                opacity: 0;
            }

            /* Ëá™Âãï„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà */
        }


        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, .45);
            }

            50% {
                box-shadow: 0 0 18px 6px rgba(255, 255, 255, .35);
            }
        }



        /* ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Áî®„ÅÆÂÖ®ÁîªÈù¢„É¨„Ç§„É§ */
        #fxFlash {
            position: fixed;
            inset: 0;
            background: transparent;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
        }

        /* ÁôΩ„Éï„É©„ÉÉ„Ç∑„É• */
        @keyframes flashWhite {
            0% {
                opacity: 0;
                background: #fff;
            }

            12% {
                opacity: .95;
                background: #fff;
            }

            100% {
                opacity: 0;
                background: #fff;
            }
        }

        /* Ëµ§„Éï„É©„ÉÉ„Ç∑„É•Ôºà„Éü„ÇπÔºâ */
        @keyframes flashRed {
            0% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }

            18% {
                opacity: .85;
                background: rgba(255, 0, 0, 0.85);
            }

            100% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }
        }

        /* „Åª„Çì„ÅÆÂ∞ë„Åó„Ç´„É°„É©„Ç∑„Çß„Ç§„ÇØÔºàÂ•Ω„Åø„ÅßÔºâ */
        @keyframes camShake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, -1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, 1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .fx-shake {
            animation: camShake 120ms ease;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .casefile-modal {
            background-color: #f6f2e8;
            color: #2c2c2c;
            width: 80%;
            max-width: 720px;
            max-height: 85vh;
            border: 2px solid #bba;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .casefile-scroll {
            padding: 24px;
            overflow-y: auto;
            max-height: 80vh;
            font-family: "Noto Serif JP", "Times New Roman", serif;
            line-height: 1.6;
        }

        .casefile-modal h1,
        .casefile-modal h2 {
            text-align: center;
            margin-bottom: 8px;
        }

        .casefile-modal h3 {
            margin-top: 20px;
            border-bottom: 1px solid #999;
        }

        .person {
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-left: 3px solid #b44;
        }

        .initial-f {
            font-weight: 900;
            color: #c9a43d;
            /* gold */
            font-size: 1.55em;
            /* margin-left: 6px; */
        }

        .initial-l {
            font-weight: 900;
            color: #8c8fa1;
            /* silver/steel */
            font-size: 1.55em;
            /* margin-left: 4px; */
        }


        .evidence {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .evidence th,
        .evidence td {
            border: 1px solid #bbb;
            padding: 6px 8px;
        }

        blockquote {
            font-style: italic;
            color: #444;
            border-left: 4px solid #888;
            padding-left: 10px;
            margin: 10px 0;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.4rem;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }

        .group {
            width: 90%;
            justify-content: center;
            display: flex;
            gap: 8px;
            align-items: center
        }


        @keyframes breathe {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(2px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .modal-content {
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            /* ÁîªÈù¢„Å´Âèé„ÇÅ„Çã */
            overflow: auto;
            /* „ÅØ„ÅøÂá∫„Åó„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´ */
            padding: 20px;
            /* „Å°„Çá„ÅÑÂúßÁ∏Æ */
        }

        /* „É¢„Éº„ÉÄ„É´„ÅÆÁîªÂÉè„Éú„Çø„É≥„ÅØÂõ∫ÂÆö80px‚ÜíÂèØÂ§â„Å´ */
        #modalButtons button img {
            width: clamp(56px, 18vw, 96px);
            height: clamp(56px, 18vw, 96px);
        }





        /* „ÇØ„É™„ÉÉ„ÇØ„ÅØ„É°„Ç§„É≥„Å∏ÈÄö„Åô */
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F2G9BX4FBF"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-F2G9BX4FBF');
</script>

<body>
    <!-- ‚ñº „É¢„Éº„ÉÄ„É´ÂÖ®‰Ωì -->
    <div class="modal-overlay" style="display:none;">
        <div class="casefile-modal">
            <button class="close-btn">√ó</button>

        </div>
    </div>

    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <!-- <div class="title">Áü≥ÂÆ§„Åã„Çâ„ÅÆËÑ±Âá∫</div> -->
            <div style="margin:0 0; text-align:center;">
                <a href="escape20_hint.html" target="_blank"
                    style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    üîç „Éí„É≥„Éà„ÇíË¶ã„Çã
                </a>

            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="640" style="width: 90vw; max-width: 640px;"></canvas>


        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="msgText">Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÁü≥ÂÆ§„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ</span>
                    <div id="statusIconArea" style="position:absolute; bottom:6px; right:12px; display:flex; gap:8px;">
                    </div>
                </div>
                <div class="navigation">

                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
                <div class="inventory-slot" onclick="useItem(5)"></div>
                <div class="inventory-slot" onclick="useItem(6)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
                üîä BGM
            </button>
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">„Çª„Éº„Éñ</button>
                <button class="nav-btn" onclick="loadGame()">„É≠„Éº„Éâ</button>
            </div>
        </div>
        <div class="notice">ÂΩì„Çµ„Ç§„Éà„ÅÆÈü≥Ê∫ê„ÅØ<a href="https://otologic.jp/" target="blank">OtoLogic</a>,<a
                href="https://dova-s.jp/" target="blank">DOVA-SYNDROME</a>„ÅÆÁ¥†Êùê„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô ‰ΩúËÄÖ:<a href="index.html">„Çπ„É©„Çª„Éñ„É≥</a>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>

    <audio id="bgm" src="sounds/20/Three_Pyramids.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-clear" src="sounds/common/Cyber03-1.mp3"></audio>
    <audio id="se-change" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-open" src="sounds/common/Short_Accent09-1(Dry).mp3"></audio>
    <audio id="se-fanta" src="sounds/common/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <audio id="se-coin" src="sounds/common/Onoma-Ding01-1(Dry).mp3"></audio>
    <audio id="se-scene-change" src="sounds/common/Scene_Change08-1(Delay-Fast).mp3"></audio>
    <audio id="se-gacha" src="sounds/common/Retro_Anime-Switch02-3(Low).mp3"></audio>
    <audio id="se-gaan" src="sounds/common/gaan.mp3"></audio>
    <audio id="se-gao" src="sounds/common/gao.mp3"></audio>

    <audio id="se-god" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-trap" src="sounds/common/Retro_Anime-Mech_Equip02-2.mp3"></audio>
    <audio id="se-falling" src="sounds/common/Motion-Falling_Whistle04-2(Short).mp3"></audio>
    <audio id="se-badend" src="sounds/common/sekaino_owari.mp3"></audio>

    <audio id="se-angel" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-down" src="sounds/common/Onoma-Sigh03-1(Delay-Mid).mp3"></audio>
    <audio id="se-up" src="sounds/common/Inspiration10-1(High).mp3"></audio>
    <audio id="se-gogogo" src="sounds/common/gogogo.mp3"></audio>
    <audio id="se-mouse" src="sounds/common/PC-Mouse06-1.mp3"></audio>
    <audio id="se-ashioto" src="sounds/common/NES-RPG02-01(Enter).mp3"></audio>
    <audio id="se-metal" src="sounds/common/metal.mp3"></audio>
    <audio id="se-explosion" src="sounds/common/Explosion02-2(Short).mp3"></audio>
    <audio id="se-mini-monstar" src="sounds/common/mini-monstar.mp3"></audio>
    <audio id="se-noroi" src="sounds/common/noroi.mp3"></audio>
    <audio id="se-fire" src="sounds/common/fire.mp3"></audio>

    <script>
        // --- Analytics helper ---
        window.ANA = {
            start: Date.now(),
            hintCount: 0,
            send(ev, params = {}) { try { gtag('event', ev, params); } catch (e) { } }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const a = document.querySelector('a[href*="_hint.html"]');
            if (a) {
                a.addEventListener('click', () => {
                    ANA.hintCount++;
                    ANA.send('open_hint', { count: ANA.hintCount });
                });
            }
        });

        window.ANA = Object.assign(window.ANA || {}, {
            sid: Math.random().toString(36).slice(2),
            sent: new Set(),
            baseParams() {
                return {
                    elapsed_sec: Math.round((Date.now() - this.start) / 1000),
                    hints: this.hintCount || 0,
                    save_version: (typeof SAVE_VERSION === 'number' ? SAVE_VERSION : null),
                    room: (window.gameState && gameState.currentRoom) || null,
                    sid: this.sid,
                };
            },
            once(ev, key = '', params = {}) {
                const k = `${ev}:${key}`;
                if (this.sent.has(k)) return;
                this.sent.add(k);
                this.send(ev, { ...this.baseParams(), ...params });
            }
        });

        // Ê±éÁî®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÄÅ‰ø°Áî®„Éò„É´„Éë
        function markProgress(step, extra = {}) {
            ANA.once('progress', step, { step, ...extra });
        }


        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.querySelector(".modal-overlay");
            const openBtn = document.querySelector("#open-casefile");
            const closeBtn = document.querySelector(".close-btn");

            // ÂàùÊúüÁä∂ÊÖã„ÅßÈùûË°®Á§∫
            modal.style.display = "none";

            // Èñã„Åè
            openBtn?.addEventListener("click", () => {
                modal.style.display = "flex";
            });

            // Èñâ„Åò„Çã
            closeBtn?.addEventListener("click", () => {
                modal.style.display = "none";
            });

            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modal.addEventListener("click", (e) => {
                if (e.target === modal) modal.style.display = "none";
            });
        });



        window._nextModal = null;
        const canvas = document.getElementById('gameCanvas');
        // „Ç≤„Éº„É†Ë®≠ÂÆö - ÁîªÂÉè„Éë„Çπ„Çí„Åì„Åì„ÅßÁÆ°ÁêÜ
        let IMAGES = {
            rooms: {
                startFront: ['images/20/start_front.png'],
                startLeft: ['images/20/start_left.png'],
                startRight: ['images/20/start_right.png'],
                startDoor: ['images/20/start_door.png'],

                corridorEntrance: ['images/20/corridor_entrance.png', 'images/20/corridor_entrance2.png'],
                corridorLeft: ['images/20/corridor_left.png'],
                corridorRight: ['images/20/corridor_right.png'],
                corridorDoor: ['images/20/corridor_door.png'],
                corridorRightRoom: ['images/20/corridor_right_room.png'],

                underground: ['images/20/underground.png', 'images/20/underground2.png'],
                entrance: ['images/20/entrance.png', 'images/20/entrance2.png'],
                entranceLeft: ['images/20/entrance_left.png', 'images/20/entrance_left2.png'],
                entranceWall: ['images/20/entrance_wall.png'],
                tresureHouse: ['images/20/tresure_house.png', 'images/20/tresure_house2.png'],

                end: ['images/20/end.jpeg'],
                trueEnd: ['images/20/true_end.jpeg', 'images/20/true_end2.png'],



            },
            items: {
                coin: 'images/bear_coin.png',
                bear: 'images/bear.png',
                back: 'images/common/back.png',
                arrowRight: 'images/common/arrow_right.png',
                arrowLeft: 'images/common/arrow_left.png',
                arrowAbove: 'images/common/arrow_above.png',
                redBack: 'images/common/red_back.png',
                greenBack: 'images/common/green_back.png',
                blueBack: 'images/common/blue_back.png',
                blackBack: 'images/common/black_back.png',
                sun: 'images/20/sun.png',
                moon: 'images/20/moon.png',
                snake: 'images/20/snake.png',
                bird: 'images/20/bird.png',
                eye: 'images/20/eye.png',
                ank: 'images/20/ank.png',
                water: 'images/20/water.png',
                star: 'images/20/star.png',
                hand: 'images/20/hand.png',
                human: 'images/20/human.png',
                handUnder: 'images/20/hand_under.png',
                house: 'images/20/house.png',
                tallGrass: 'images/20/tall_grass.png',
                tsubo: 'images/20/tsubo.png',
                leaf: 'images/20/leaf.png',
                scarab: 'images/20/scarab.png',
                fan: 'images/20/fan.png',
                boxOpen: 'images/20/box_open.png',
                boxClose: 'images/20/box_close.png',
                itemLever: 'images/20/item_lever.png',
                lever: 'images/20/lever.png',
                leverDown: 'images/20/lever_down.png',
                redTriangle: 'images/20/red_triangle.png',
                statue: 'images/20/statue.png',
                statueInSand: 'images/20/statue_in_sand.png',
                hachimaki: 'images/20/hachimaki.png',
                hachimakiInSand: 'images/20/hachimaki_in_sand.png',
                mummy: 'images/20/mummy.png',
                memo: 'images/20/memo.png',
                stick: 'images/20/stick.png',
                torch: 'images/20/torch.png',
                torchOn: 'images/20/torch_on.png',
                stoneRed: 'images/20/stone_red.png',
                stoneGreen: 'images/20/stone_green.png',
                stoneBlue: 'images/20/stone_blue.png',
                whiteKey: 'images/20/white_key.png',
                tri1: 'images/20/tri1.png',
                tri2: 'images/20/tri2.png',
                tri3: 'images/20/tri3.png',
                tri4: 'images/20/tri4.png',
                tri5: 'images/20/tri5.png',
                tri6: 'images/20/tri6.png',
                tri7: 'images/20/tri7.png',
                tri8: 'images/20/tri8.png',
                bearMummy: 'images/20/bear_mummy.png',
                shine: 'images/20/shine.png',
                carpet: 'images/20/carpet.jpeg',
                outdoor: 'images/20/outdoor.png',
                boxMapOpened: 'images/20/box_map_opened.png',
                boxMapClosed: 'images/20/box_map_closed.png',
                money: 'images/20/money.jpeg',
                gyoza: 'images/20/gyoza.jpeg',

            },

            modals: {
                slateSnake: 'images/20/left_snake.png',
                slateBird: 'images/20/left_bird.png',
                slateHuman: 'images/20/right_human.png',
                slateDog: 'images/20/right_dog.png',
                slateMummy: 'images/20/slate_mummy.jpeg',
                entranceWall: 'images/20/entrance_wall.png',
                entranceWallClear: 'images/20/modal_entrance_wall_clear.png',
                torch: 'images/20/modal_torch.png',
                mummyStatue: 'images/20/modal_mummy_statue.jpeg',
                mummyCrying: 'images/20/modal_mummy_crying.png',
                mummyTorch: 'images/20/modal_mummy_torch.jpeg',
                battle: 'images/20/modal_badend_mummy.jpeg',
                battle2: 'images/20/modal_reflect.png',
                bearTorch: 'images/20/modal_bear_wall.png',
                bearStatue: 'images/20/modal_bear_statue.jpeg',
                mvKey: 'images/20/mv_key.mp4',
                map: 'images/20/map.png',
                keyOpen: 'images/20/modal_key_open.png',
                statuePlaced: 'images/20/modal_statue_placed.jpeg',

                bearGyoza: 'images/20/modal_gyoza_bear.jpeg',

                badEnd: 'images/20/badend.jpeg',
                badEndBear: 'images/20/badend_bear.png',
            },
        };


        // „Ç≤„Éº„É†Áä∂ÊÖã
        const SAVE_KEY = 'escapeGameState20';
        const SAVE_VERSION = 1;

        function getDefaultGameState() {
            return {
                currentRoom: 'startFront',
                openRooms: ['startFront'],
                openRoomsTmp: [],
                inventory: [],
                main: {
                    flags: {
                        unlockStartBox: false, foundLever: false, setLever: false, downLever: false, unlockStartDoor: false,
                        corridorTrapIsActive: false, foundStatue: false, setStatue: false, foundHachimaki: false, foundStick: false,
                        gotTorch: false, sleepMummy: false, foundMemo: false, foundStick: false, setTorch: false,
                        foundStoneRed: false, foundStoneBlue: false, foundStoneGreen: false, gotWhiteKey: false,
                        wallPuzzleSolved: false, foundCarpet: false, unlockEntranceDoor: false, unlockCorridorBox: false,
                        torchSequence: [], foundMoney: false, gotGyoza: false, gaveGyozaToBear: false, bearMoveCnt: 0,
                        curseBroken: false, bearMummyPosition: 0, // 0:ÂÆùÁâ©Â∫´,1:„Ç®„É≥„Éà„É©„É≥„Çπ
                        talkTo: { bear: 0 }, backgroundState: 0,
                    }
                },
                startBoxState: [0, 0, 0],
                startDoorState: [0, 0, 0, 0],
                underground: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                corridorEntrance: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                entrance: {
                    flags: {
                        talkTo: { mummy: 0 }, backgroundState: 0,
                    }
                },
                entranceLeft: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                tresureHouse: {
                    flags: {
                        talkTo: { bear: 0, bearMummy: 0 }, backgroundState: 0,
                    }
                },
                trueEnd: {
                    flags: {
                        backgroundState: 0,
                    }
                },

                flags: { exEndUnlocked: false, trueEndUnlocked: false },
                selectedItem: null,
                endings: { true: false, ex: false, normal: false }

            };
        }

        let gameState = getDefaultGameState();




        // ÈÉ®Â±ã„Éá„Éº„Çø
        let rooms = {
            startFront: {
                name: 'Áü≥ÂÆ§',
                description: 'Áü≥ÈÄ†„Çä„ÅÆÈÉ®Â±ã„Å†',
                clickableAreas: [
                    {
                        x: 72.2, y: 67.1, width: 23.2, height: 19.2,
                        action: 'examine_start_box_close',
                        description: 'ÁÆ±',
                        usable: () => !gameState.main.flags.unlockStartBox,
                        item: {
                            img: 'boxClose', visible: () => !gameState.main.flags.unlockStartBox,
                        },

                    },
                    {
                        x: 72.2, y: 62.1, width: 23.2, height: 24.2,
                        action: 'examine_start_box_open',
                        description: 'ÁÆ±',
                        usable: () => gameState.main.flags.unlockStartBox,
                        item: {
                            img: 'boxOpen', visible: () => gameState.main.flags.unlockStartBox,
                        },

                    },
                    {
                        x: 27.3, y: 28.3, width: 44.5, height: 41.9,
                        action: 'examine_start_wall_picture',
                        description: 'Â£ÅÁîª',


                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_start_front_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_start_front_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },



                ]
            },
            startLeft: {
                name: 'Áü≥ÂÆ§',
                description: '',
                clickableAreas: [
                    {
                        x: 7.4, y: 23.7, width: 34.8, height: 53.9,
                        action: 'examine_blue_stone_plate',
                        description: 'Â∑¶„ÅÆÁü≥Êùø',
                    },
                    {
                        x: 57.9, y: 24.6, width: 35.3, height: 53.7,
                        action: 'examine_red_stone_plate',
                        description: 'Âè≥„ÅÆÁü≥Êùø',
                    },
                    {
                        x: 15.4, y: 80.2, width: 11.6, height: 12.7,
                        action: 'examine_blue_lever',
                        description: 'Â∑¶„ÅÆ„É¨„Éê„Éº',
                    },

                    {
                        x: 72.5, y: 83.1, width: 9.0, height: 7.6,
                        action: 'examine_hole',
                        description: 'Á©¥',
                        usable: () => !gameState.main.flags.setLever,
                    },
                    {
                        x: 74.9, y: 78.6, width: 4.4, height: 10.8,
                        action: 'examine_lever_up',
                        description: '„É¨„Éê„Éº‰∏äÂêë„Åç',
                        usable: () => gameState.main.flags.setLever && !gameState.main.flags.downLever,
                        item: {
                            img: 'lever',
                            visible: () => gameState.main.flags.setLever && !gameState.main.flags.downLever,
                        }
                    },
                    {
                        x: 74.9, y: 86.3, width: 4.4, height: 10.8,
                        action: 'examine_lever_down',
                        description: '„É¨„Éê„Éº‰∏ãÂêë„Åç',
                        usable: () => gameState.main.flags.setLever && gameState.main.flags.downLever,
                        item: {
                            img: 'leverDown',
                            visible: () => gameState.main.flags.setLever && gameState.main.flags.downLever,
                        }
                    },
                    {
                        x: 62.1, y: 36.3, width: 21.2, height: 23.9,
                        action: 'examine_red_triangle',
                        description: 'Ëµ§„ÅÑ‰∏âËßí',
                        usable: () => false,
                        item: {
                            img: 'redTriangle',
                            visible: () => gameState.main.flags.setLever && gameState.main.flags.downLever,
                        }
                    },
                    {
                        x: 70.3, y: 1.2, width: 7.3, height: 10.4,
                        action: 'examine_desk_candle',
                        description: 'Êú∫„ÅÆ„Ç≠„É£„É≥„Éâ„É´',
                        zIndex: 2,
                        usable: () => gameState.main.flags.setCandle && gameState.main.flags.candleStatus == 1,
                        item: {
                            img: 'candleOn',
                            visible: () => gameState.main.flags.setCandle && gameState.main.flags.candleStatus == 1
                        }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_start_left_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_start_left_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            startRight: {
                name: 'Áü≥ÂÆ§',
                description: '',
                clickableAreas: [
                    {
                        x: 7.4, y: 23.7, width: 34.8, height: 53.9,
                        action: 'examine_green_stone_plate',
                        description: 'Â∑¶„ÅÆÁü≥Êùø',
                    },
                    {
                        x: 57.9, y: 16.5, width: 34.5, height: 63.2,
                        action: 'examine_white_stone_plate',
                        description: 'Âè≥„ÅÆÁü≥Êùø',
                    },
                    {
                        x: 18.7, y: 79.9, width: 11.6, height: 13.4,
                        action: 'examine_green_lever',
                        description: 'Â∑¶„ÅÆ„É¨„Éê„Éº',
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_start_right_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_start_right_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },

            startDoor: {
                name: 'Áü≥ÂÆ§„ÅÆ„Éâ„Ç¢',
                description: '',
                clickableAreas: [

                    {
                        x: 33.1, y: 26.1, width: 34.0, height: 51.3,
                        action: 'examine_start_door',
                        description: '„Éâ„Ç¢',
                        item: {
                            img: 'blackBack',
                            visible: () => gameState.main.flags.unlockStartDoor,
                        }


                    },

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_start_door_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_start_door_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            // corridor
            corridorEntrance: {
                name: 'Âªä‰∏ã',
                description: '',
                clickableAreas: [
                    {
                        x: 30.5, y: 65.7, width: 39.6, height: 20.4,
                        action: 'examine_corridor_hole',
                        description: 'Á©¥',
                        usable: () => gameState.main.flags.corridorTrapIsActive

                    },
                    {
                        x: 40.4, y: 31.0, width: 17.6, height: 26.9,
                        action: 'examine_corridor_door_far',
                        description: 'ÈÅ†„ÅÑ„Éâ„Ç¢',
                        item: {
                            img: 'blackBack',
                            visible: () => gameState.main.flags.unlockCorridorDoor,
                        }
                    },
                    {
                        x: 80.9, y: 29.7, width: 5.6, height: 40.6,
                        action: 'examine_corridor_entrance_right_hole',
                        description: 'Âè≥„ÅÆÁ©¥',

                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_corridor_entrance_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_corridor_entrance_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                    {
                        x: 92, y: 92, width: 8, height: 8,
                        action: 'examine_corridor_entrance_back',
                        description: 'Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            corridorLeft: {
                name: 'Âªä‰∏ã„ÅÆÂ∑¶„ÅÆÂ£Å',
                description: '',
                clickableAreas: [
                    {
                        x: 6.9, y: 24.1, width: 30.7, height: 30.5,
                        action: 'examine_corridor_left_snake',
                        description: 'Ëõá„ÅÆÁü≥Êùø',
                    },
                    {
                        x: 48.0, y: 23.6, width: 31.5, height: 31.3,
                        action: 'examine_corridor_left_bird',
                        description: 'È≥•„ÅÆÁü≥Êùø',
                    },
                    {
                        x: 85.1, y: 24.4, width: 8.2, height: 13.5,
                        action: 'examine_corridor_left_torch',
                        description: 'Âªä‰∏ãÂ∑¶Â£ÅÈù¢„Åü„ÅÑ„Åæ„Å§',
                    },
                    {
                        x: 6.8, y: 73.7, width: 27.8, height: 21.7,
                        action: 'examine_corridor_left_box',
                        description: 'ÁÆ±',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.unlockCorridorBox,
                        item: { img: 'boxMapClosed', visible: () => !gameState.main.flags.unlockCorridorBox }

                    },
                    {
                        x: 6.8, y: 70.7, width: 27.8, height: 23.7,
                        action: 'examine_corridor_left_box_opened',
                        description: 'ÁÆ±',
                        zIndex: 5,
                        usable: () => gameState.main.flags.unlockCorridorBox,
                        item: { img: 'boxMapOpened', visible: () => gameState.main.flags.unlockCorridorBox }

                    },
                    // {
                    //     x: 85.3, y: 92.4, width: 6.0, height: 4.0,
                    //     action: 'examine_corridor_left_stone',
                    //     description: 'Áü≥',
                    //     zIndex: 5,
                    //     usable: () => !gameState.main.flags.foundStoneRed,
                    //     item: { img: 'stoneRed', visible: () => !gameState.main.flags.foundStoneRed }

                    // },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_corridor_left_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            corridorRight: {
                name: 'Âªä‰∏ã„ÅÆÂè≥„ÅÆÂ£Å',
                description: '',
                clickableAreas: [
                    {
                        x: 24.7, y: 23.4, width: 34.2, height: 34.1,
                        action: 'examine_corridor_right_human',
                        description: '‰∫∫„ÅÆÁü≥Êùø',
                    },
                    {
                        x: 64.3, y: 23.4, width: 34.0, height: 34.0,
                        action: 'examine_corridor_right_dog',
                        description: 'Áä¨„ÅÆÁü≥Êùø',
                    },
                    {
                        x: 0.2, y: 16.4, width: 17.6, height: 73.2,
                        action: 'examine_corridor_right_hole',
                        description: 'Âªä‰∏ãÂè≥„ÅÆÂ£ÅÈù¢„ÅÆÁ©¥',
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_corridor_right_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                ]
            },

            corridorDoor: {
                name: 'Âªä‰∏ã„ÅÆ„Éâ„Ç¢',
                description: '„Éâ„Ç¢„Å´Ëøë„Å•„ÅÑ„Åü',
                clickableAreas: [

                    {
                        x: 31.9, y: 27.8, width: 33.2, height: 51.4,
                        action: 'examine_corridor_door',
                        description: '„Éâ„Ç¢',
                        item: {
                            img: 'blackBack',
                            visible: () => gameState.main.flags.unlockCorridorDoor,
                        }
                    },
                    {
                        x: 92, y: 92, width: 8, height: 8,
                        action: 'examine_corridor_door_back',
                        description: 'Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            corridorRightRoom: {
                name: 'Â∞èÈÉ®Â±ã',
                description: 'Âú∞‰∏ã„Åã„ÇâÈöéÊÆµ„Çí‰∏ä„Å£„ÅüÈÉ®Â±ã„Å†',
                clickableAreas: [

                    {
                        x: 10.8, y: 23.9, width: 11.4, height: 47.6,
                        action: 'examine_corridor_right_room_door',
                        description: 'Âªä‰∏ã„Å∏Á∂ö„ÅèÁ©¥',

                    },
                    {
                        x: 37.2, y: 72.3, width: 45.4, height: 15,
                        action: 'examine_corridor_right_room_step',
                        description: 'Âú∞‰∏ã„Å∏„ÅÆÈöéÊÆµ',

                    },
                    {
                        x: 31.3, y: 28, width: 23.1, height: 22.9,
                        action: 'examine_corridor_right_room_slate',
                        description: 'Â∞èÈÉ®Â±ã„ÅÆÂ£ÅÁîª',

                    },
                    {
                        x: 57.9, y: 28, width: 22.8, height: 22.9,
                        action: 'examine_corridor_right_room_picture',
                        description: 'Â∞èÈÉ®Â±ã„ÅÆÂ£ÅÁîª2',

                    },
                    {
                        x: 73.8, y: 52.1, width: 16.0, height: 19.5,
                        action: 'examine_corridor_right_room_tsubo',
                        description: 'Â∞èÈÉ®Â±ã„ÅÆÊ≤πÂ£∑',

                    },
                    {
                        x: 24.0, y: 28.1, width: 7.9, height: 10.0,
                        action: 'examine_corridor_right_room_torch',
                        description: 'Â∞èÈÉ®Â±ã„ÅÆ„Åü„ÅÑ„Åæ„Å§',

                    }
                ]
            },
            underground: {
                name: 'ËêΩ„Å®„ÅóÁ©¥„Åã„ÇâËêΩ„Å°„ÅüÂú∞ÁÇπ',
                description: 'Âú∞‰∏ã„Åß„Åô',
                clickableAreas: [

                    {
                        x: 33.1, y: 26.1, width: 30.0, height: 51.3,
                        action: 'examine_underground_step',
                        description: 'ÈöéÊÆµ',
                        usable: () => gameState.underground.flags.backgroundState == 1,

                    },
                    {
                        x: 16.9, y: 74.3, width: 8, height: 6.8,
                        action: 'examine_underground_statue_in_sand',
                        description: 'Âüã„ÇÇ„Çå„ÅüÂÉè',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundStatue,
                        item: { img: 'statueInSand', visible: () => !gameState.main.flags.foundStatue }
                    },
                    {
                        x: 63.9, y: 58.2, width: 8.6, height: 8.2,
                        action: 'examine_underground_statue_base',
                        description: 'ÂÉè„ÅÆË®≠ÁΩÆ‰ΩçÁΩÆ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.setStatue && !gameState.main.flags.setTorch,
                        item: { img: 'blueBack', visible: () => !gameState.main.flags.setStatue && !gameState.main.flags.setTorch }

                    },
                    {
                        x: 60.8, y: 65.4, width: 20.1, height: 20.3,
                        action: 'examine_underground_statue_standing',
                        description: 'Ë®≠ÁΩÆ„Åó„ÅüÂÉè',
                        zIndex: 2,
                        usable: () => gameState.main.flags.setStatue,
                        item: { img: 'statue', visible: () => gameState.main.flags.setStatue }

                    },
                    {
                        x: 63.3, y: 49.7, width: 5.0, height: 4.7,
                        action: 'examine_underground_column',
                        description: 'Êü±„ÅÆ„Éï„ÉÉ„ÇØ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.setTorch && gameState.underground.flags.backgroundState == 1,

                    },
                    {
                        x: 61.1, y: 46.8, width: 8.5, height: 13.1,
                        action: 'examine_underground_torch',
                        description: 'Ë®≠ÁΩÆ„Åó„Åü„Åü„ÅÑ„Åæ„Å§',
                        zIndex: 5,
                        usable: () => gameState.main.flags.setTorch,
                        item: { img: 'torchOn', visible: () => gameState.main.flags.setTorch }

                    },
                    {
                        x: 75.6, y: 68.9, width: 6.4, height: 3.8,
                        action: 'examine_underground_hachimaki_in_sand',
                        description: 'Âüã„ÇÇ„Çå„Åü„ÅØ„Å°„Åæ„Åç',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundHachimaki && gameState.underground.flags.backgroundState == 1,
                        item: { img: 'hachimakiInSand', visible: () => !gameState.main.flags.foundHachimaki && gameState.underground.flags.backgroundState == 1 }
                    },
                    {
                        x: 76.5, y: 65.0, width: 6.0, height: 4.0,
                        action: 'examine_underground_stone',
                        description: 'Áü≥',
                        zIndex: 6,
                        usable: () => !gameState.main.flags.foundStoneGreen,
                        item: { img: 'stoneGreen', visible: () => !gameState.main.flags.foundStoneGreen }

                    }

                ]
            },
            // entrance
            entrance: {
                name: 'Âá∫Âè£‰ªòËøë',
                description: 'Áü≥Ê£∫„Åå„ÅÇ„Çã',
                clickableAreas: [

                    {
                        x: 25.7, y: 43.6, width: 15.1, height: 19.4,
                        action: 'examine_entrance_mummy',
                        description: '„Éü„Ç§„É©Âêõ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.sleepMummy && !gameState.main.flags.curseBroken,
                        item: { img: 'mummy', visible: () => !gameState.main.flags.sleepMummy && !gameState.main.flags.curseBroken }
                    },
                    {
                        x: 70.8, y: 64.1, width: 22.1, height: 22.1,
                        action: 'examine_entrance_bear_mummy',
                        description: '„ÇØ„Éû„Éü„Ç§„É©',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.curseBroken && gameState.main.flags.bearMummyPosition == 1,
                        item: { img: 'bearMummy', visible: () => !gameState.main.flags.curseBroken && gameState.main.flags.bearMummyPosition == 1 }
                    },
                    {
                        x: 70.8, y: 64.1, width: 22.1, height: 22.1,
                        action: 'examine_tresure_house_bear',
                        description: '„Ç®„É≥„Éà„É©„É≥„Çπ„ÅÆ„ÇØ„Éû',
                        usable: () => gameState.main.flags.curseBroken && gameState.main.flags.bearMummyPosition == 1,
                        item: { img: 'bear', visible: () => gameState.main.flags.curseBroken && gameState.main.flags.bearMummyPosition == 1 }
                    },
                    {
                        x: 52.5, y: 44.7, width: 39.4, height: 32.5,
                        action: 'examine_entrance_coffin',
                        description: 'Ê£∫',
                    },
                    {
                        x: 93.3, y: 63.3, width: 6.3, height: 4.6,
                        action: 'examine_entrance_memo',
                        description: '„É°„É¢',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundMemo,
                        item: { img: 'memo', visible: () => !gameState.main.flags.foundMemo }
                    },
                    {
                        x: 14.2, y: 68.2, width: 9.6, height: 19.4,
                        action: 'examine_entrance_stick',
                        description: 'Ê£í',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundStick,
                        item: { img: 'stick', visible: () => !gameState.main.flags.foundStick }
                    },
                    {
                        x: 23.6, y: 27.0, width: 20.0, height: 31.4,
                        action: 'examine_entrance_door',
                        description: '„Ç®„É≥„Éà„É©„É≥„Çπ„ÅÆ„Éâ„Ç¢',
                        item: { img: 'outdoor', visible: () => gameState.main.flags.unlockEntranceDoor }

                    },
                    {
                        x: 3.9, y: 31.2, width: 6.6, height: 9.1,
                        action: 'examine_entrance_torch',
                        description: '„Ç®„É≥„Éà„É©„É≥„Çπ„ÅÆ„Åü„ÅÑ„Åæ„Å§',

                    },
                    {
                        x: 72.7, y: 38.4, width: 7.0, height: 7.3,
                        action: 'examine_entrance_torch2',
                        description: '„Ç®„É≥„Éà„É©„É≥„Çπ„ÅÆ„Åü„ÅÑ„Åæ„Å§Â••',

                    },
                    {
                        x: 19.1, y: 65.7, width: 6.0, height: 4.0,
                        action: 'examine_entrance_stone',
                        description: 'Áü≥',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundStoneBlue && (gameState.main.flags.sleepMummy || gameState.main.flags.curseBroken),
                        item: { img: 'stoneBlue', visible: () => !gameState.main.flags.foundStoneBlue && (gameState.main.flags.sleepMummy || gameState.main.flags.curseBroken) }

                    },
                    {
                        x: 92, y: 92, width: 8, height: 8,
                        action: 'examine_entrance_back',
                        description: 'Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_entrance_left',
                        description: '‚Üê', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                ]
            },
            entranceLeft: {
                name: 'Âá∫Âè£‰ªòËøë',
                description: 'Â£ÅÁîª„Åå„ÅÇ„Çã',
                clickableAreas: [


                    {
                        x: 15.6, y: 30.1, width: 21.5, height: 27.0,
                        action: 'examine_entrance_left_wall',
                        description: '„Ç®„É≥„Éà„É©„É≥„Çπ„ÅÆÂ£ÅÁîª',
                        usable: () => !gameState.main.flags.wallPuzzleSolved,
                    },
                    {
                        x: 17.8, y: 63.2, width: 17.8, height: 4.1,
                        action: 'examine_entrance_left_wall_input',
                        description: '„Ç®„É≥„Éà„É©„É≥„Çπ„ÅÆÂ£ÅÁîª‰∏ã„Ç§„É≥„Éó„ÉÉ„Éà',
                        usable: () => !gameState.main.flags.wallPuzzleSolved,

                    },
                    {
                        x: 10.0, y: 19.4, width: 32.7, height: 63.1,
                        action: 'examine_entrance_left_to_tresure',
                        description: 'Èö†„ÅóÊââ', zIndex: 5,
                        usable: () => gameState.main.flags.wallPuzzleSolved,

                    },
                    {
                        x: 72.8, y: 35.9, width: 9.6, height: 11.1,
                        action: 'examine_entrance_left_torch',
                        description: '„Ç®„É≥„Éà„É©„É≥„Çπ„ÅÆ„Åü„ÅÑ„Åæ„Å§',

                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_entrance_right',
                        description: '‚Üí', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            entranceWall: {
                name: 'Â£ÅÁîª',
                description: '',
                clickableAreas: [
                    {
                        x: 92, y: 92, width: 8, height: 8,
                        action: 'examine_entrance_wall_back',
                        description: 'Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            tresureHouse: {
                name: 'ÂÆùÁâ©Â∫´',
                description: '',
                clickableAreas: [


                    {
                        x: 32.2, y: 23.8, width: 35.5, height: 32.8,
                        action: 'examine_tresure_house_wall',
                        description: 'ÂÆùÁâ©Â∫´„ÅÆÂ£Å',
                    },
                    {
                        x: 33.5, y: 60.2, width: 33.6, height: 21.7,
                        action: 'examine_tresure_house_box_closed',
                        description: 'ÂÆùÁâ©Â∫´„ÅÆÂÆùÁÆ±',
                        usable: () => !gameState.main.flags.curseBroken,

                    },
                    {
                        x: 33.5, y: 60.2, width: 33.6, height: 21.7,
                        action: 'examine_tresure_house_box_opened',
                        description: 'ÂÆùÁâ©Â∫´„ÅÆÂÆùÁÆ±',
                        usable: () => gameState.main.flags.curseBroken,

                    },
                    {
                        x: 44.0, y: 49.5, width: 12.8, height: 17.4,
                        action: 'examine_tresure_house_shine',
                        description: 'ÂÆùÁâ©Â∫´„ÅÆÂÆù„ÅÆÂÖâ',
                        usable: () => false,
                        item: { img: 'shine', visible: () => gameState.main.flags.curseBroken && !gameState.main.flags.foundCarpet }

                    },
                    {
                        x: 4.7, y: 64.1, width: 23.4, height: 23.3,
                        action: 'examine_tresure_house_bear_mummy',
                        description: 'ÂÆùÁâ©Â∫´„ÅÆ„ÇØ„Éû„Éü„Ç§„É©',
                        usable: () => !gameState.main.flags.curseBroken && gameState.main.flags.bearMummyPosition == 0,
                        item: { img: 'bearMummy', visible: () => !gameState.main.flags.curseBroken && gameState.main.flags.bearMummyPosition == 0 }

                    },
                    {
                        x: 4.7, y: 64.1, width: 23.4, height: 23.3,
                        action: 'examine_tresure_house_bear',
                        description: 'ÂÆùÁâ©Â∫´„ÅÆ„ÇØ„Éû',
                        usable: () => gameState.main.flags.curseBroken && gameState.main.flags.bearMummyPosition == 0,
                        item: { img: 'bear', visible: () => gameState.main.flags.curseBroken && gameState.main.flags.bearMummyPosition == 0 }
                    },
                    {
                        x: 6.3, y: 62.8, width: 15.7, height: 11.9,
                        action: 'examine_tresure_house_left_tresure',
                        description: 'ÂÆùÁâ©Â∫´„ÅÆÂ∑¶„ÅÆÂÆù',
                        usable: () => gameState.main.flags.bearMummyPosition == 1,

                    },
                    {
                        x: 92, y: 92, width: 8, height: 8,
                        action: 'examine_tresure_house_back',
                        description: 'Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },

            end: {
                name: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ',
                description: 'ÁÑ°‰∫ã„Å´Áü≥ÂÆ§„Åã„ÇâËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_end',
                        description: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ'
                    },
                ]
            },
            trueEnd: {
                name: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                description: 'ÁÑ°‰∫ã„Å´ËÑ±Âá∫„ÄÅÁ©∫„ÇíÈ£õ„Çì„ÅßÂ∏∞„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_true_end_next',
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                        usable: () => gameState.trueEnd.flags.backgroundState == 0,

                    },
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_true_end',
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                        usable: () => gameState.trueEnd.flags.backgroundState == 1,

                    },
                    {
                        x: 20.3, y: 44.9, width: 25.4, height: 25.3,
                        action: 'examine_true_end_yatai',
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ„ÅÆÂ±ãÂè∞',
                        zIndex: 3,
                        usable: () => gameState.trueEnd.flags.backgroundState == 1,
                    },
                    {
                        x: 52.5, y: 67.8, width: 15.0, height: 14.0,
                        action: 'examine_true_end_bear',
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ„ÅÆ„ÇØ„Éû',
                        zIndex: 5,
                        usable: () => gameState.trueEnd.flags.backgroundState == 1,
                    },
                ]
            },
            boss: {
                name: 'È≠îÁéãÊà¶',
                description: 'È≠îÁéã„Å®„ÅÆÂØæÊ±∫„Å†„ÄÇ‰∏Ä‰∫∫„Åß„ÇÇÂÄí„Åó„Å¶„ÇÑ„Çã„Åû',
                clickableAreas: [
                    {
                        x: 5.9, y: 5.6, width: 89.6, height: 42.1,
                        action: 'examine_boss',
                        description: 'boss',
                        usable: () => gameState.boss.flags.backgroundState == 0,
                    },
                    {
                        x: 53.5, y: 79.4, width: 11.7, height: 10.0,
                        action: 'examine_bear',
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        usable: () => gameState.boss.flags.backgroundState == 0,
                    },
                ]
            },
            exEnd: {
                name: '„Ç®„ÇØ„Çπ„Éà„É©„Ç®„É≥„Éâ',
                description: 'ÁÑ°‰∫ã„Å´ËÑ±Âá∫„ÄÅ„ÅÇ„Å™„Åü„ÅØÊñ∞„Åü„Å™È≠îÁéã„Å®„Åó„Å¶Ë¶öÈÜí„Åó„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_ex_end',
                        description: '„Ç®„ÇØ„Çπ„Éà„É©„Ç®„É≥„Éâ'
                    },
                ]
            },

        };

        const hintMessages = {

            tresureHouse: {
                bear: [
                    '„Åä„ÅØ„Çà„ÅÜ',
                    '„Åà„Å∏„Å∏',
                ],
                bearMummy: [
                    '„ÇØ„Éû„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢„ÅÆ„Éü„Ç§„É©„Å†',
                    '„Åº„Çì„ÇÑ„Çä„Åó„Å¶„ÅÑ„Çã',
                ],


            },
        };



        // Ë∂≥Èü≥„ÅßÊï∞Ê≠©‚Üí„ÉØ„Éº„ÉóÊºîÂá∫‚ÜíÁõÆÁöÑ„ÅÆÈÉ®Â±ã„Å∏
        function travelWithSteps(destRoom = 'corridorRightRoom') {
            const canvasEl = document.getElementById('gameCanvas');
            const overlay = document.getElementById('roomEffectOverlay');

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-ashioto');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#000';  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;

                if (step >= 3) {
                    clearInterval(stepTimer);

                    if (overlay) {
                        changeRoom(destRoom);
                    }

                    setTimeout(() => {

                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            // overlay.style.background = '';
                            overlay.style.opacity = 0;

                        }

                    }, 100);
                }
            }, 160);
        }

        function travelWithStepsTrueEnd(destRoom = 'trueEnd') {
            const overlay = document.getElementById('roomEffectOverlay');

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-scene-change');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#000';  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;


                if (step >= 3) {
                    clearInterval(stepTimer);

                    // Èªí‚Üí„ÉØ„Éº„ÉóÂÖâ„Å∏ÂàáÊõø
                    if (overlay) {
                        overlay.classList.add('warp-active');
                        changeRoom(destRoom);
                        overlay.style.background = '';   // warp „ÅÆÁôΩÁô∫ÂÖâ„Å´Êàª„Åô
                    }

                    setTimeout(() => {


                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            overlay.classList.remove('warp-active');
                            overlay.style.opacity = 0;
                        }

                    }, 900);
                }
            }, 260);
        }



        function fallIntoPit(destRoom = 'underground') {
            const canvasEl = document.getElementById('gameCanvas');
            const overlay = document.getElementById('roomEffectOverlay');

            gameState.main.flags.corridorTrapIsActive = true;

            // ËêΩ‰∏ã„ÅÆSEÔºàÊâãÊåÅ„Å°Á¥†Êùê„Åã„ÇâÔºâ
            try { playSE('se-trap'); } catch (e) { }

            // Èªí„Éï„Çß„Éº„ÉâÈñãÂßã
            if (overlay) { overlay.style.background = '#000'; overlay.style.opacity = 1; }

            let step = 0;
            const timer = setInterval(() => {
                step++;

                // „Å°„Çá„ÅÑÊè∫„Çå
                if (canvasEl) {
                    canvasEl.classList.add('fx-shake');
                    setTimeout(() => canvasEl.classList.remove('fx-shake'), 120);
                }

                if (step >= 3) {
                    clearInterval(timer);
                    if (overlay) {
                        try { playSE('se-falling'); } catch (e) { }
                        overlay.classList.add('warp-active');
                        changeRoom(destRoom);     // Âú∞‰∏ã„Å∏
                        overlay.style.background = '';
                    }
                    setTimeout(() => {
                        if (overlay) {
                            overlay.classList.remove('warp-active');
                            overlay.style.opacity = 0;
                        }
                    }, 900);
                }
            }, 220);
        }




        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            renderNavigation();
            changeRoom('startDoor');
            updateMessage('Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØÁü≥ÂÆ§„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü');

        }

        function findHitArea(x, y, clickableAreas, canvas) {
            // zIndexÈôçÈ†Ü„Åß
            const sorted = clickableAreas.slice().sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            for (const area of sorted) {
                // ÂøÖË¶Å„Å™„ÇâusableÂà§ÂÆö„ÇÇ„Åì„Åì„Åß
                const usable = area.usable === undefined ? true :
                    (typeof area.usable === "function" ? area.usable() : area.usable);

                if (!usable) continue; // ‰Ωø„Åà„Å™„ÅÑ„Ç®„É™„Ç¢„ÅØÂà§ÂÆö„Åó„Å™„ÅÑ
                const ax = area.x / 100 * canvas.width;
                const ay = area.y / 100 * canvas.height;
                const aw = area.width / 100 * canvas.width;
                const ah = area.height / 100 * canvas.height;
                if (x >= ax && x <= ax + aw && y >= ay && y <= ay + ah) {
                    return area; // ÊúÄÂàù„Å´„Éí„ÉÉ„Éà„Åó„Åü„ÇÇ„ÅÆ„Å†„ÅëËøî„ÅôÔºÅ
                }
            }
            return null;
        }

        let hoveredAreaIndex = null;  // ‰ªähover„Åó„Å¶„Çã„Ç®„É™„Ç¢Ôºà„Å™„Åë„Çå„Å∞nullÔºâ
        canvas.addEventListener('mousemove', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);
            const idx = area ? room.clickableAreas.indexOf(area) : null;
            if (hoveredAreaIndex !== idx) {
                hoveredAreaIndex = idx;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('mouseout', function () {
            if (hoveredAreaIndex !== null) {
                hoveredAreaIndex = null;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('click', function (e) {

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // ‚òÖ‰ªä„ÅÑ„ÇãÈÉ®Â±ã„ÅÆ„Ç®„É™„Ç¢„Å†„ÅëÂà§ÂÆöÔºÅ
            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);

            if (area) {
                handleAreaClick(area.action, e);
            }


        });

        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];

            // ËÉåÊôØÔºã„Ç¢„Ç§„ÉÜ„É†Ôºã„ÇØ„É™„ÉÉ„ÇØ„Ç®„É™„Ç¢„Çícanvas„ÅßÂÖ®ÈÉ®ÂÜçÊèèÁîª
            renderCanvasRoom();
            const msg = (room.name && room.name.trim() !== "")
                ? `${room.name}„Åß„Åô„ÄÇ${room.description}`
                : room.description;
            if (roomId === 'trueEnd') {
                updateMessageHTML(msg);
            } else {
                updateMessage(msg);
            }

            // BGMÂàáÊõø„ÅØ„Åù„ÅÆ„Åæ„Åæ
            if (roomId === "trueEnd") {
                changeBGM("sounds/20/Neon_Garden.mp3");

            } else if (roomId === "end") {
                changeBGM("sounds/20/Scirocco.mp3");

            } else {
                changeBGM("sounds/20/Three_Pyramids.mp3");
            }

            // nav
            if (roomId === "corridorEntrance") {
                addNaviItem('corridorEntrance');
                // renderNavigation();
            } else if (roomId === "entrance") {
                addNaviItem('entrance');
                // renderNavigation();
            } else if (roomId === "tresureHouse") {
                addNaviItem('tresureHouse');
                // renderNavigation();
            } else if (roomId === "trueEnd" || roomId === "end") {
                gameState.openRooms = [];
                // renderNavigation();
            }
            renderNavigation();

        }

        const END_IDS = new Set(['end', 'trueEnd', 'exEnd']);

        // ===== changeRoom „Éï„ÉÉ„ÇØÔºö=====
        const _changeRoom_custom = changeRoom;
        changeRoom = function (roomId) {
            _changeRoom_custom.apply(this, arguments);


            if (END_IDS.has(roomId)) {
                const elapsed = Math.round((Date.now() - ANA.start) / 1000);
                ANA.endTimes = ANA.endTimes || {};
                if (!ANA.endTimes[roomId]) ANA.endTimes[roomId] = elapsed;

                const isTrue = (roomId === 'trueEnd');
                ANA.send('ending_reached', {
                    ending_id: roomId,
                    is_true: isTrue,
                    elapsed_sec: elapsed,
                    hints: ANA.hintCount,

                });
                // setTimeout(() => showFeedbackModal(roomId), 1500);
            }
        };

        function renderCanvasRoom() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const roomId = gameState.currentRoom;
            const room = rooms[roomId];
            const bgImgSrc = getRoomBackgroundImage(roomId, gameState);

            ctx.clearRect(0, 0, canvas.width, canvas.height);


            // ËÉåÊôØÊèèÁîª
            const bgImg = loadedImages[bgImgSrc];
            if (bgImg && bgImg.complete) {
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            }

            // „Ç¢„Ç§„ÉÜ„É†ÊèèÁîªÔºàÊú™ÂèñÂæó„ÅÆ„ÅøÔºâ
            drawRoomItems(ctx, canvas, roomId);

            // ‚òÖ „Åì„Åì„Åã„ÇâÈáç„Å™„ÇäÂÑ™ÂÖà„ÅÆhoverÊû†Á∑ö„ÇíÊèèÁîª
            if (hoveredAreaIndex !== null && hoveredAreaIndex !== undefined) {
                // zIndexÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
                const sortedAreas = room.clickableAreas
                    .map((area, i) => ({ ...area, __idx: i }))
                    .filter(area => area.usable === undefined ? true :
                        (typeof area.usable === "function" ? area.usable() : area.usable)
                    )
                    .sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
                // hoveredAreaIndex„Å®‰∏ÄËá¥„Åô„Çã„Ç®„É™„Ç¢„ÇízIndexÈ†Ü„Åß1„Å§„Å†„ÅëÊû†ÊèèÁîª
                const hoverArea = sortedAreas.find(area => area.__idx === hoveredAreaIndex);
                if (hoverArea) {
                    const ax = hoverArea.x / 100 * canvas.width;
                    const ay = hoverArea.y / 100 * canvas.height;
                    const aw = hoverArea.width / 100 * canvas.width;
                    const ah = hoverArea.height / 100 * canvas.height;
                    ctx.save();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(ax, ay, aw, ah);
                    ctx.restore();
                }
            }




        }

        function drawRoomItems(ctx, canvas, roomId) {
            const room = rooms[roomId];
            room.clickableAreas.forEach(area => {
                if (area.item && area.item.visible && area.item.visible()) {
                    const key = (typeof area.item.img === 'function') ? area.item.img() : area.item.img;
                    const img = loadedImages[IMAGES.items[key]];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const alpha = area.alpha ? area.alpha : 1;
                        const px = area.x / 100 * canvas.width;
                        const py = area.y / 100 * canvas.height;
                        const w = area.width / 100 * canvas.width;
                        const h = area.height / 100 * canvas.height;
                        ctx.save();
                        ctx.globalAlpha = alpha;
                        ctx.drawImage(img, px, py, w, h);
                        ctx.restore();
                    }
                }
            });
        }


        function getRoomBackgroundImage(roomId, gameState) {
            let state = gameState[roomId]?.flags?.backgroundState || 0;
            let imgList = IMAGES.rooms[roomId];
            if (Array.isArray(imgList)) {
                return imgList[state] || imgList[0];
            } else {
                return imgList;
            }
        }

        // Â∞èÁâ©„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function pointInRect(x, y, r) {
            return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;
        }

        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
            ctx.beginPath();
            ctx.moveTo(x + r.tl, y);
            ctx.lineTo(x + w - r.tr, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
            ctx.lineTo(x + w, y + h - r.br);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
            ctx.lineTo(x + r.bl, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
            ctx.lineTo(x, y + r.tl);
            ctx.quadraticCurveTo(x, y, x + r.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        // „Éï„É©„ÉÉ„Ç∑„É•„É¨„Ç§„É§„ÇíÁî®ÊÑè
        (function ensureFlashLayer() {
            if (!document.getElementById('fxFlash')) {
                const d = document.createElement('div');
                d.id = 'fxFlash';
                document.body.appendChild(d);
            }
        })();

        // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Ôºàtype: 'white' | 'red'Ôºâ
        function screenFlash(type = 'white', durMs = 180) {
            const f = document.getElementById('fxFlash'); if (!f) return;
            f.style.animation = 'none'; // ÈÄ£ÊâìÂØæÁ≠ñ
            // Âº∑Âà∂reflow„Åß„Ç¢„Éã„É°ÂÜçÈÅ©Áî®
            // eslint-disable-next-line no-unused-expressions
            f.offsetHeight;
            const key = type === 'red' ? 'flashRed' : 'flashWhite';
            f.style.animation = `${key} ${durMs}ms ease`;
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„ÇíÊ•µÂ∞è„Ç∑„Çß„Ç§„ÇØ
            document.documentElement.classList.add('fx-shake');
            setTimeout(() => document.documentElement.classList.remove('fx-shake'), 120);
        }

        function _cycle1to9(v) { return v >= 9 ? 1 : (v + 1); }


        // „Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleAreaClick(action, event) {
            const f = gameState.main.flags;

            switch (action) {
                // ÁßªÂãï
                case 'examine_start_door_left':
                    changeRoom('startRight');
                    break;
                case 'examine_start_door_right':
                    changeRoom('startLeft');
                    break;
                case 'examine_start_right_left':
                    changeRoom('startFront');
                    break;
                case 'examine_start_right_right':
                    changeRoom('startDoor');
                    break;
                case 'examine_start_front_left':
                    changeRoom('startLeft');
                    break;
                case 'examine_start_front_right':
                    changeRoom('startRight');
                    break;
                case 'examine_start_left_left':
                    changeRoom('startDoor');
                    break;
                case 'examine_start_left_right':
                    changeRoom('startFront');
                    break;
                case 'examine_corridor_entrance_left':
                    changeRoom('corridorLeft');
                    break;
                case 'examine_corridor_entrance_right':
                    if (f.corridorTrapIsActive === false) {
                        gameState.corridorEntrance.flags.backgroundState =
                            Math.min(1, (gameState.corridorEntrance.flags.backgroundState || 0) + 1);

                        showModal(
                            'Ë∂≥ÂÖÉ„ÅÆÂ∫ä„ÅåÊäú„Åë„ÅüÔºÅ',
                            ``,

                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        fallIntoPit('underground');
                        return;
                    }
                    changeRoom('corridorRight');
                    break;
                case 'examine_corridor_entrance_back':
                    changeRoom('startDoor');
                    break;
                // case 'examine_corridor_door_far':
                //     changeRoom('corridorDoor');
                //     break;
                // case 'examine_corridor_left_left': 
                //     changeRoom('corridorLeft');
                //     break;
                case 'examine_corridor_left_right':
                    changeRoom('corridorEntrance');
                    break;
                case 'examine_corridor_right_left':
                    changeRoom('corridorEntrance');
                    break;
                case 'examine_corridor_door_back':
                    changeRoom('corridorEntrance');
                    break;
                case 'examine_entrance_left':
                    changeRoom('entranceLeft');
                    break;
                case 'examine_entrance_right':
                    changeRoom('entrance');
                    break;
                case 'examine_entrance_back':
                    changeRoom('corridorDoor');
                    break;
                case 'examine_tresure_house_back':
                    changeRoom('entranceLeft');
                    break;
                case 'examine_entrance_wall_back':
                    changeRoom('entranceLeft');
                    break;
                // startDoor
                case 'examine_start_door':
                    if (gameState.main.flags.unlockStartDoor) {
                        changeRoom('corridorEntrance');

                    } else if (!gameState.main.flags.setLever) {
                        updateMessage('ÂèçÂøú„ÅåÁÑ°„ÅÑ');
                    } else {
                        showDoorPuzzle();
                    }
                    break;
                // start
                case 'examine_start_box_close':
                    showStartBoxPuzzle();
                    break;
                case 'examine_start_box_open':
                    if (gameState.main.flags.foundLever) {
                        updateMessage('„Åã„Çâ„Å£„ÅΩ„Å†');
                    } else {
                        gameState.main.flags.foundLever = true;
                        addItem('lever');
                        showModal(
                            '„É¨„Éê„Éº„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                            `<img src="${IMAGES.items.itemLever}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,

                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('„É¨„Éê„Éº„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                    }
                    break;
                case 'examine_start_wall_picture':
                    updateMessage('ÂÖâ„ÅÆÔºìÂéüËâ≤„ÅÆ„Çà„ÅÜ„Å™Ê®°Êßò„ÅÆÂ£ÅÁîª„Å†');
                    break;
                // startLeft
                case 'examine_blue_stone_plate':
                case 'examine_red_stone_plate':
                case 'examine_green_stone_plate':
                    updateMessage('Ë¨é„ÅÆÁü≥Êùø„Å†');
                    break;
                case 'examine_white_stone_plate':
                    updateMessage('Ë¨é„ÅÆÁü≥Êùø„Å†„ÄÇ„Åì„ÅÆÁü≥Êùø„Å†„ÅëÁôΩ„ÅÑ');
                    break;
                case 'examine_hole':
                    if (gameState.selectedItem == 'lever') {
                        removeItem('lever');
                        gameState.main.flags.setLever = true;
                        renderCanvasRoom();
                        playSE('se-gacha');
                        updateMessage('„É¨„Éê„Éº„ÇíÂ∑Æ„ÅóËæº„Çì„Å†');
                    } else {
                        updateMessage('‰Ωï„ÅãÂ∑Æ„ÅóËæº„ÇÅ„Åù„ÅÜ„Å™Á©¥„Å†');
                    }
                    break;
                case 'examine_lever_up':
                    if (gameState.main.flags.downLever) {
                        updateMessage('„É¨„Éê„Éº„ÅØ‰∏ã„Åå„Å£„Å¶„ÅÑ„Çã');
                    } else {
                        gameState.main.flags.downLever = true;
                        renderCanvasRoom();
                        playSE('se-gacha');
                        updateMessage('„É¨„Éê„Éº„Çí‰∏ã„Åí„Åü');
                    }
                    break;
                case 'examine_lever_down':
                    updateMessage('„É¨„Éê„Éº„ÅØ‰∏ã„Åå„Å£„Å¶„ÅÑ„Çã');
                    break;
                case 'examine_blue_lever':
                case 'examine_green_lever':
                    updateMessage('„É¨„Éê„Éº„ÅØÂ£ä„Çå„Å¶„Åó„Åæ„Å£„Å¶„ÅÑ„Çã‚Ä¶');
                    break;

                // corridor
                case 'examine_corridor_hole':
                    updateMessage('ÈÅø„Åë„Å¶ÈÄö„Çã„Åì„Å®„Åå„Åß„Åç„Åù„ÅÜ„Å†');
                    break;
                case 'examine_corridor_left_snake':
                    showModal(
                        `<img src="${IMAGES.modals.slateSnake}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        '',
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_corridor_left_bird':
                    showModal(
                        `<img src="${IMAGES.modals.slateBird}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        '',
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_corridor_left_box':
                    showModal(
                        'ÁÆ±„Åå„ÅÇ„Çã„ÄÇËìã„ÅØÈñã„Åã„Å™„ÅÑ„ÄÇÁ¥ô„ÅåË≤º„Å£„Å¶„ÅÇ„Çã„ÄÇ',
                        `<img src="${IMAGES.modals.map}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_corridor_left_box_opened':
                    if (!gameState.main.flags.foundStoneRed) {
                        gameState.main.flags.foundStoneRed = true;
                        renderCanvasRoom();
                        addItem('stoneRed');
                        showModal(
                            'Ëµ§Ëâ≤„ÅÆÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                            `<img src="${IMAGES.items.stoneRed}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('Ëµ§Ëâ≤„ÅÆÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                        _nextModal = checkStoneFusion;
                    } else {
                        updateMessage('„ÇÇ„ÅÜ‰Ωï„ÇÇ„Å™„ÅÑ');
                    }

                    break;
                case 'examine_corridor_right_human':
                    showModal(
                        `<img src="${IMAGES.modals.slateHuman}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        '',
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_corridor_right_dog':
                    showModal(
                        `<img src="${IMAGES.modals.slateDog}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        '',
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_corridor_right_hole':
                    changeRoom('corridorRightRoom');
                    break;
                case 'examine_corridor_door_far': {
                    if (f.corridorTrapIsActive === false) {
                        gameState.corridorEntrance.flags.backgroundState =
                            Math.min(1, (gameState.corridorEntrance.flags.backgroundState || 0) + 1);

                        showModal(
                            'Ë∂≥ÂÖÉ„ÅÆÂ∫ä„ÅåÊäú„Åë„ÅüÔºÅ',
                            ``,

                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        fallIntoPit('underground');
                        return;
                    }
                    updateMessage('Á©¥„ÇíÈÅø„Åë„Å¶ÁßªÂãï„Åó„Åü');
                    changeRoom('corridorDoor');
                    break;
                }

                case 'examine_corridor_entrance_right_hole': {
                    if (f.corridorTrapIsActive === false) {
                        gameState.corridorEntrance.flags.backgroundState =
                            Math.min(1, (gameState.corridorEntrance.flags.backgroundState || 0) + 1);

                        showModal(
                            'Ë∂≥ÂÖÉ„ÅÆÂ∫ä„ÅåÊäú„Åë„ÅüÔºÅ',
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        fallIntoPit('underground');
                        return;
                    } else {
                        changeRoom('corridorRightRoom');
                    }
                    break;
                }
                case 'examine_corridor_right_room_door':
                    changeRoom('corridorEntrance');
                    break;
                case 'examine_corridor_right_room_step':
                    travelWithSteps('underground');
                    // changeRoom('underground');
                    break;
                case 'examine_corridor_right_room_slate':
                    showModal(
                        '',
                        `<img src="${IMAGES.modals.slateMummy}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_corridor_right_room_picture':
                    showModal(
                        '',
                        `<img src="${IMAGES.modals.bearTorch}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    break;
                case 'examine_corridor_right_room_tsubo':
                    if (hasItem('hachimaki') && hasItem('stick')) {
                        removeItem('hachimaki');
                        removeItem('stick');
                        updateMessage('Â∏ÉÂàá„Çå„Å®Ê£í„Åß„Åü„ÅÑ„Åæ„Å§„Çí‰Ωú„Çä„ÄÅÊ≤π„Å´Êµ∏„Åó„Åü„ÄÇ');
                        addItem('torch');
                        showModal(
                            'Â∏ÉÂàá„Çå„Å®Ê£í„Åß„Åü„ÅÑ„Åæ„Å§„Çí‰Ωú„Çä„ÄÅÊ≤π„Å´Êµ∏„Åó„Åü„ÄÇ„Åü„ÅÑ„Åæ„Å§„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                            `<img src="${IMAGES.modals.torch}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                    } else {
                        updateMessage('Ê≤π„ÅåÂÖ•„Å£„ÅüÂ£∫„Åå„ÅÇ„Çã');
                    }

                    break;
                case 'examine_corridor_left_torch':
                case 'examine_corridor_right_room_torch':
                case 'examine_entrance_torch':
                case 'examine_entrance_torch2':
                case 'examine_entrance_left_torch':
                    if (gameState.selectedItem == 'torch') {
                        removeItem('torch');
                        addItem('torchOn');
                        updateMessage('„Åü„ÅÑ„Åæ„Å§„Å´ÁÅ´„Çí„Å§„Åë„Åü');
                    } else {
                        handleTorchExamined(action);
                        // updateMessage('„Åü„ÅÑ„Åæ„Å§„ÅåÁáÉ„Åà„Å¶„ÅÑ„Çã');
                    }

                    break;
                case 'examine_corridor_door':
                    if (gameState.main.flags.unlockCorridorDoor) {
                        changeRoom('entrance');
                    } else {
                        showCorridorDoorPuzzle();
                    }
                    break;

                //underground
                case 'examine_underground_statue_in_sand':
                    gameState.main.flags.foundStatue = true;
                    addItem('statue');
                    showModal(
                        'Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                        `<img src="${IMAGES.items.statue}" style="width:400px;max-width:100%;max-height:400px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                    break;
                case 'examine_underground_statue_base':
                    if (gameState.selectedItem == 'statue') {
                        gameState.main.flags.setStatue = true;
                        gameState.underground.flags.backgroundState++;
                        renderCanvasRoom();
                        removeItem('statue');
                        showModal(
                            'Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÂÖâ„ÅåÂΩì„Åü„Çã‰ΩçÁΩÆ„Å´Ë®≠ÁΩÆ„Åó„Åü',
                            ``,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÂÖâ„ÅåÂΩì„Åü„Çã‰ΩçÁΩÆ„Å´Ë®≠ÁΩÆ„Åô„Çã„Å®„ÄÅÂèçÂ∞Ñ„ÅßÂë®„Çä„ÅåÊòé„Çã„Åè„Å™„Å£„Åü„ÄÇ');
                    } else {
                        updateMessage('„Åì„ÅÆËæ∫„Çä„Åå‰∏ÄÁï™Êòé„Çã„ÅÑ„Çà„ÅÜ„Å†');
                    }

                    break;
                case 'examine_underground_statue_standing':
                    if (gameState.main.flags.setStatue) {

                        showModal(
                            'Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åç„Åæ„Åô„ÅãÔºü',
                            '',
                            [
                                {
                                    text: "„ÅØ„ÅÑ",
                                    action: () => {
                                        gameState.main.flags.setStatue = false;
                                        if (!gameState.main.flags.setTorch) {
                                            gameState.underground.flags.backgroundState--;
                                        }

                                        renderCanvasRoom();
                                        addItem('statue');
                                        showModal(
                                            'Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                                            `<img src="${IMAGES.items.statue}" style="width:400px;max-width:100%;max-height:400px;display:block;margin:0 auto 20px;">`,
                                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                        );
                                        let meg;
                                        if (gameState.main.flags.setTorch) {
                                            msg = 'Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇ';
                                        } else {
                                            msg = 'Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇ„ÅÇ„Åü„Çä„ÅØÊöó„Åè„Å™„Å£„Åü';
                                        }
                                        updateMessage(msg);
                                    }
                                },
                                { text: "„ÅÑ„ÅÑ„Åà", action: "close" }
                            ]
                        );
                    } else {
                        updateMessage('„Å™„Å´„ÇÇ„Å™„ÅÑ');
                    }
                    break;
                case 'examine_underground_column':
                    if (gameState.selectedItem == 'torchOn') {
                        gameState.main.flags.setTorch = true;
                        renderCanvasRoom();
                        removeItem('torchOn');
                        showModal(
                            '„Åü„ÅÑ„Åæ„Å§„ÇíË®≠ÁΩÆ„Åó„Åü',
                            ``,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('„Åü„ÅÑ„Åæ„Å§„ÇíË®≠ÁΩÆ„Åó„Åü');
                    } else if (gameState.selectedItem == 'torch') {

                        updateMessage('„Åü„ÅÑ„Åæ„Å§„Å´„ÅØ„Åæ„Å†ÁÅ´„Çí„Å§„Åë„Å¶„ÅÑ„Å™„ÅÑ‚Ä¶');
                    } else if (gameState.main.flags.setTorch) {
                        updateMessage('„Åü„ÅÑ„Åæ„Å§„Çí„Åã„Åë„Å¶„ÅÇ„Çã');
                    } else {
                        updateMessage('„Å™„Å´„Åã„Å≤„Å£„Åã„Åë„Çâ„Çå„Åù„ÅÜ„Å†');
                    }

                    break;
                case 'examine_underground_torch':
                    updateMessage('Ë®≠ÁΩÆ„Åó„Åü„Åü„ÅÑ„Åæ„Å§„ÅåËæ∫„Çä„ÇíÁÖß„Çâ„Åó„Å¶„ÅÑ„Çã');
                    break;
                case 'examine_underground_hachimaki_in_sand':
                    gameState.main.flags.foundHachimaki = true;
                    addItem('hachimaki');
                    renderCanvasRoom();
                    showModal(
                        'Â∏ÉÂàá„Çå„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                        `<img src="${IMAGES.items.hachimaki}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('Â∏ÉÂàá„Çå„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                    break;
                case 'examine_underground_step':
                    travelWithSteps();
                    // changeRoom('corridorRightRoom');
                    break;
                case 'examine_underground_stone':
                    gameState.main.flags.foundStoneGreen = true;
                    renderCanvasRoom();
                    addItem('stoneGreen');
                    showModal(
                        'Á∑ëËâ≤„ÅÆÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                        `<img src="${IMAGES.items.stoneGreen}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('Á∑ëËâ≤„ÅÆÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                    _nextModal = checkStoneFusion;
                    break;

                // entrance
                case 'examine_entrance_mummy':
                    if (gameState.selectedItem == 'statue') {
                        showModal(
                            'Èáë„Å¥„Åã„ÅÆÂÉè„Çí„Éü„Ç§„É©Âêõ„Å´„Åµ„Çä„Åã„Åñ„Åó„ÅüÔºÅ',
                            `<img src="${IMAGES.modals.mummyStatue}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('Èáë„Å¥„Åã„ÅÆÂÉè„Çí„Éü„Ç§„É©Âêõ„Å´„Åµ„Çä„Åã„Åñ„Åó„ÅüÔºÅ„Éü„Ç§„É©Âêõ„ÅØÈÄÉ„Åí„Å¶Ë°å„Å£„Åü');
                        playSE('se-mini-monstar');
                        gameState.main.flags.sleepMummy = true;
                        gameState.entrance.flags.backgroundState++;
                        renderCanvasRoom();
                    } else if (gameState.selectedItem == 'hachimaki') {
                        showModal(
                            '„Éü„Ç§„É©Âêõ„ÅØ„Åô„Åì„Åó„ÅÜ„Çã„ÅÜ„Çã„Åó„Å¶„ÅÑ„Çã',
                            `<img src="${IMAGES.modals.mummyCrying}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('„Éü„Ç§„É©Âêõ„ÅØ„Åô„Åì„Åó„ÅÜ„Çã„ÅÜ„Çã„Åó„Å¶„ÅÑ„Çã');
                    } else if (gameState.selectedItem == 'torchOn') {
                        showModal(
                            '„Éü„Ç§„É©Âêõ„ÅØÂ´å„Åå„Å£„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†',
                            `<img src="${IMAGES.modals.mummyTorch}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('„Éü„Ç§„É©Âêõ„ÅØÂ´å„Åå„Å£„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†');
                    } else {
                        showModal(
                            '„Éü„Ç§„É©Âêõ„ÅØ„Åº„Çì„ÇÑ„Çä„Åó„Å¶„ÅÑ„Çã',
                            `<img src="${IMAGES.items.mummy}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('„Éü„Ç§„É©Âêõ„ÅØ„Åº„Çì„ÇÑ„Çä„Åó„Å¶„ÅÑ„Çã');
                    }

                    break;
                case 'examine_entrance_bear_mummy':
                    if (gameState.selectedItem == 'statue') {
                        showModal(
                            'Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊåØ„Çä„Åã„Åñ„Åó„Åü',
                            `<img src="${IMAGES.modals.bearStatue}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        playSE('se-mini-monstar');
                        gameState.main.flags.bearMummyPosition--;
                        renderCanvasRoom();
                        updateMessage('„ÇØ„ÉûÂûã„ÅÆ„Éü„Ç§„É©„ÅØ„Å©„Åì„Åã„Å∏ÈÄÉ„Åí„Å¶Ë°å„Å£„Åü');
                        handleBadEnd();
                    } else {
                        talkToHintCharacter('tresureHouse', 'bearMummy');
                    }

                    break;
                case 'examine_entrance_memo':
                    showModal(
                        '„É°„É¢„ÇíÊãæ„Å£„Åü',
                        `<img src="${IMAGES.items.memo}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    addItem('memo');
                    gameState.main.flags.foundMemo = true;
                    updateMessage('„É°„É¢„ÇíÊãæ„Å£„Åü');
                    break;
                case 'examine_entrance_stick':
                    showModal(
                        'Ê£í„ÇíÊãæ„Å£„Åü',
                        `<img src="${IMAGES.items.stick}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    addItem('stick');
                    gameState.main.flags.foundStick = true;
                    updateMessage('Ê£í„ÇíÊãæ„Å£„Åü');
                    break;
                case 'examine_entrance_coffin':
                    if (gameState.main.flags.curseBroken) {
                        updateMessage('„Éü„Ç§„É©Âêõ„ÅÆÊ∞óÈÖç„ÅØ„Å™„ÅÑ‚Ä¶');
                    } else if (gameState.main.flags.sleepMummy) {
                        updateMessage('„Éü„Ç§„É©Âêõ„ÅØ‰∏≠„Å´ÂÖ•„Å£„Åü„Çà„ÅÜ„Å†');
                    } else {
                        updateMessage('Áü≥Ê£∫„Åå„ÅÇ„Çã„ÄÇ„Éü„Ç§„É©Âêõ„ÅÆÂØùÂ∫ä„Å†„Çç„ÅÜ„Åã');
                    }

                    break;
                case 'examine_entrance_stone':
                    gameState.main.flags.foundStoneBlue = true;
                    renderCanvasRoom();
                    addItem('stoneBlue');
                    showModal(
                        'ÈùíËâ≤„ÅÆÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                        `<img src="${IMAGES.items.stoneBlue}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('ÈùíËâ≤„ÅÆÁü≥„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                    _nextModal = checkStoneFusion;
                    break;
                case 'examine_entrance_door':
                    if (gameState.main.flags.sleepMummy || gameState.main.flags.curseBroken) {
                        if (gameState.selectedItem == 'whiteKey') {
                            removeItem('whiteKey');
                            gameState.main.flags.unlockEntranceDoor = true;
                            renderCanvasRoom();
                            playSE('se-gogogo');
                            showModal(
                                'ÁôΩ„ÅÑÈçµ„Åß„Éâ„Ç¢„ÇíÈñã„Åë„Åü',
                                `<img src="${IMAGES.modals.keyOpen}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                            );
                            updateMessage('ÁôΩ„ÅÑÈçµ„Åß„Éâ„Ç¢„ÇíÈñã„Åë„Åü„ÄÇÂ§ñÊ∞ó„ÅåÊµÅ„ÇåËæº„Çì„Å†„ÄÇ„Å©„ÅÜ„ÇÑ„Çâ„É©„ÇØ„ÉÄ„ÅåËøë„Åè„Å´„ÅÑ„Çã„Çà„ÅÜ„Å†');


                        } else if (gameState.main.flags.unlockEntranceDoor) {
                            handleDoor();
                        } else {
                            updateMessage('„Éâ„Ç¢„ÅØÈñã„Åã„Å™„ÅÑ„ÄÇÈçµÁ©¥„Åå„ÅÇ„Çã')
                        }

                    } else {
                        updateMessage('„Éü„Ç§„É©Âêõ„ÅåÈÇ™È≠î„ÅßË™ø„Åπ„Çâ„Çå„Å™„ÅÑ„Å™');
                    }

                    break;
                case 'examine_entrance_left_wall':
                    changeRoom('entranceWall');
                    break;
                case 'examine_entrance_left_wall_input':
                    showEntranceWallPuzzle();
                    break;
                case 'examine_entrance_left_to_tresure':
                    changeRoom('tresureHouse');
                    break;
                // tresureHouse
                case 'examine_tresure_house_wall':
                    if (gameState.tresureHouse.flags.backgroundState == 0) {
                        updateMessage('Á¶ç„ÄÖ„Åó„ÅÑ‰ªÆÈù¢„Åå„Åì„Å°„Çâ„ÇíË¶ã„Å§„ÇÅ„Å¶„ÅÑ„Çã');
                    } else {
                        updateMessage('Èáë„Å¥„Åã„ÅÆÁ¨ëÈ°î„Åå„Åì„Å°„Çâ„ÇíË¶ã„Å§„ÇÅ„Å¶„ÅÑ„Çã');
                    }
                    break;


                case 'examine_tresure_house_box_closed':
                    if (gameState.tresureHouse.flags.tresureBoxOpened) return;

                    if (gameState.selectedItem == 'statue') {

                        window._nextModal = {
                            title: '„Åó„Åã„Åó„ÄÅÈáë„Å¥„Åã„ÅÆÂÉè„Åå‰∏çÊ∞óÂë≥„Å™ÂÖâ„ÇíË∑≥„Å≠Ëøî„Åó„ÅüÔºÅ',
                            content: `<img src="${IMAGES.modals.battle2}" style="width:400px;display:block;margin:0 auto 20px;">`,
                            buttons: [{ text: 'Èñâ„Åò„Çã', action: 'close' }],
                        };
                        const onClosed = () => {
                            playSE('se-angel');
                            screenFlash('white', 420);
                            gameState.tresureHouse.flags.backgroundState++;
                            gameState.entrance.flags.backgroundState = 0;
                            gameState.main.flags.curseBroken = true;
                            renderCanvasRoom();
                            updateMessage('Â£Å„ÅÆ‰ªÆÈù¢„ÅåÈªÑÈáëÂåñ„Åó„ÄÅÂë™„ÅÑ„ÅåËß£„Åë„Åü„Çà„ÅÜ„Å†');
                        };
                        window.addEventListener('modal:closed', onClosed, { once: true });

                        showModal(
                            '‰ªÆÈù¢„Åã„Çâ‰∏çÊ∞óÂë≥„Å™ÂÖâ„ÅåÁô∫„Åõ„Çâ„Çå„ÅüÔºÅ',
                            `<img src="${IMAGES.modals.battle}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        screenFlash('red', 260);
                        playSE('se-noroi');
                    } else {
                        showModal(
                            'ÁÆ±„ÇíË™ø„Åπ„Åæ„Åô„ÅãÔºü',
                            '',
                            [
                                {
                                    text: "„ÅØ„ÅÑ",
                                    action: () => {
                                        showModal(
                                            '‰ªÆÈù¢„Åã„Çâ‰∏çÊ∞óÂë≥„Å™ÂÖâ„ÅåÁô∫„Åõ„Çâ„Çå„ÅüÔºÅ',
                                            `<img src="${IMAGES.modals.battle}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                        );
                                        screenFlash('red', 260);
                                        playSE('se-noroi');
                                        ANA.send('bad_end_20', {});
                                        window._nextModal = {
                                            title: 'BAD END:„ÅÇ„Å™„Åü„ÅØ„ÄÅ„Éü„Ç§„É©„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ',
                                            content: `<img src="${IMAGES.modals.badEnd}" style="width:400px;display:block;margin:0 auto 20px;">`,
                                            buttons: [{ text: 'Èñâ„Åò„Çã', action: 'restart' }],
                                        };
                                        const onClosed = () => {
                                            playSE('se-mini-monstar');
                                            updateMessage('BAD END:„ÅÇ„Å™„Åü„ÅØ„ÄÅ„Éü„Ç§„É©„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ');
                                        };
                                        window.addEventListener('modal:closed', onClosed, { once: true });
                                    }
                                },
                                { text: "„ÅÑ„ÅÑ„Åà", action: "close" }
                            ]
                        );

                    }
                    break;
                case 'examine_tresure_house_box_opened':
                    if (gameState.main.flags.foundCarpet) {
                        updateMessage('„ÇÇ„ÅÜÂÆù„ÅØÊâã„Å´ÂÖ•„Çå„Åü');
                    } else {
                        gameState.main.flags.foundCarpet = true;
                        gameState.flags.trueEndUnlocked = true;
                        renderCanvasRoom();
                        addItem('carpet');
                        showModal(
                            'È≠îÊ≥ï„ÅÆ„Åò„ÇÖ„ÅÜ„Åü„Çì„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                            `<img src="${IMAGES.items.carpet}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        updateMessage('È≠îÊ≥ï„ÅÆ„Åò„ÇÖ„ÅÜ„Åü„Çì„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                    }
                    break;

                case 'examine_tresure_house_bear_mummy':
                    if (gameState.selectedItem == 'statue') {
                        showModal(
                            'Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊåØ„Çä„Åã„Åñ„Åó„Åü',
                            `<img src="${IMAGES.modals.bearStatue}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        playSE('se-mini-monstar');
                        gameState.main.flags.bearMummyPosition++;
                        renderCanvasRoom();
                        updateMessage('„ÇØ„ÉûÂûã„ÅÆ„Éü„Ç§„É©„ÅØ„Å©„Åì„Åã„Å∏ÈÄÉ„Åí„Å¶Ë°å„Å£„Åü');
                        handleBadEnd();
                    } else {
                        talkToHintCharacter('tresureHouse', 'bearMummy');
                    }

                    break;
                case 'examine_tresure_house_left_tresure':
                    if (gameState.main.flags.foundMoney) {
                        updateMessage('„ÅÑ„Çç„ÅÑ„Çç„Å™ÂÆù„Åå„ÅÇ„Çã');

                    } else {
                        gameState.main.flags.foundMoney = true;
                        showModal(
                            '„ÅäÈáë„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                            `<img src="${IMAGES.items.money}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                        );
                        addItem('money');
                        updateMessage('„ÅäÈáë„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                    }

                    break;
                case 'examine_tresure_house_bear':
                    talkToHintCharacter('tresureHouse', 'bear');
                    break;

                // endings
                case 'examine_end':
                    showEndingReport('end');
                    break;
                case 'examine_true_end_next':
                    gameState.trueEnd.flags.backgroundState++;
                    setTimeout(() => { renderCanvasRoom(); updateMessage('„Ç™„Ç¢„Ç∑„Çπ„Åß‰∏Ä‰ºë„Åø„Åó„Å¶„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜ') }, 200);
                    break;
                case 'examine_true_end':
                    showEndingReport('trueEnd');
                    break;
                case 'examine_true_end_yatai':
                    if (gameState.main.flags.gotGyoza) {
                        updateMessage('„Å©„Åì„ÅãÊó•Êú¨„Å£„ÅΩ„ÅÑÈ§ÉÂ≠ê„Å†');
                    } else if (hasItem('money')) {
                        gameState.main.flags.gotGyoza = true;
                        removeItem('money');
                        addItem('gyoza');
                        showModal(
                            'È§ÉÂ≠ê„ÇíË≤∑„Å£„ÅüÔºÅ',
                            `<img src="${IMAGES.items.gyoza}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [
                                { text: 'OK', action: 'close' },
                            ]
                        );
                    } else {

                        updateMessage('„ÅäÈáë„Åå„ÅÇ„Çå„Å∞Ë≤∑„Åà„Åü„ÅÆ„Å´„Å™');
                    }
                    break;
                case 'examine_true_end_bear':
                    if (gameState.main.flags.gaveGyozaToBear) {
                        updateMessage('„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÂ¨â„Åó„Åù„ÅÜ„Å†');
                    } else if (gameState.selectedItem == 'gyoza') {
                        gameState.main.flags.gaveGyozaToBear = true;
                        removeItem('gyoza');
                        showModal(
                            '„Çè„ÉºÁæéÂë≥„Åó„Åù„ÅÜÔºÅ',
                            `<img src="${IMAGES.modals.bearGyoza}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                            [
                                { text: 'OK', action: 'close' },
                            ]
                        );
                        updateMessage('„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÂ¨â„Åó„Åù„ÅÜ„Å†');

                    } else {
                        updateMessage('„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØÈ§ÉÂ≠ê„ÇíË¶ã„Å¶„ÅÑ„Çã');
                    }
                    break;
                case 'examine_ex_end':
                    showEndingReport('exEnd');
                    break;

                default:
                    console.warn('Unknown action:', action);
                    updateMessage('‚Ä¶‚Ä¶Áâπ„Å´Â§âÂåñ„ÅØ„Å™„ÅÑ');
                    break;

            }
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;

            playSE('se-click');
            updateInventoryDisplay();
        }



        // ‚òÖ ‰ªä‰ΩúÁî®„Ç®„É≥„Éá„Ç£„É≥„Ç∞„É¨„Éù„Éº„ÉàÔºàbearNeedleCnt / bearSurikogiCntÔºâ
        function showEndingReport(endingId) {
            const ana = window.ANA || {};
            const sec = Math.max(
                1,
                (ana.endTimes && ana.endTimes[endingId]) ||
                Math.round((Date.now() - (ana.start || Date.now())) / 1000)
            );
            const mm = String(Math.floor(sec / 60)).padStart(2, "0");
            const ss = String(sec % 60).padStart(2, "0");

            const endingTxt = ({
                trueEnd: "üåü TRUE END",
                end: "üîî NORMAL END",
                exEnd: "üëë EXTRA END"
            }[endingId]) || "‚≠ê END";



            const html = `
        <div style="text-align:left;max-width:560px">
            <div style="font-size:1.4em;margin-bottom:12px">${endingTxt}</div>
            <div style="border:1px solid #d4af37;border-radius:10px;padding:12px;background:rgba(0,0,0,.35)">
                <div style="margin:4px 0">‚è± „ÇØ„É™„Ç¢ÊôÇÈñìÔºö<b>${mm}:${ss}</b></div>
                <div style="margin:4px 0">üè∑ „Ç®„É≥„Éá„Ç£„É≥„Ç∞Ôºö<b>${endingTxt.replace(/^(.+?)\\s/, "")}</b></div>

            </div>
        </div>
    `;

            showModal("", html, [
                { text: "ÊÑüÊÉ≥„Éï„Ç©„Éº„É†„ÇíÈñã„Åè", action: () => openFeedbackForm(endingId) },
                { text: "Èñâ„Åò„Çã", action: "close" },
            ]);
        }



        const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLScilBtbGuF7jXHQK6ObQhsAHnmGFkO4HmWknWaN1MeIPgI0fA/viewform?";
        const FORM_FIELDS = {
            ending: 'entry.666725843',
            gift: 'entry.719017686'
        };

        function openFeedbackForm(endingId) {
            // Ë°®Á§∫ÂêçÔºà‰ªä‰Ωú„ÅÆ„Ç®„É≥„ÉâID„Å´ÂØæÂøúÔºöÂøÖË¶ÅÂàÜ„Å†„ÅëÔºâ
            const endingLabel = ({
                trueEnd: "„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ",
                end: "„Éé„Éº„Éû„É´„Ç®„É≥„Éâ",
            })[endingId] || "„Ç®„É≥„Éâ";

            // „ÇØ„É™„Ç¢ÊôÇÈñì(Áßí)„ÅØ ANA.endTimes „Åã„Çâ„ÄÅÁÑ°„Åë„Çå„Å∞ÈñãÂßãÊôÇÂàª„Åã„ÇâÁÆóÂá∫
            const ana = window.ANA || {};
            const elapsedSec = Math.max(
                1,
                (ana.endTimes && ana.endTimes[endingId]) ||
                Math.round((Date.now() - (ana.start || Date.now())) / 1000)
            );

            // „Éë„É©„É°„Éº„ÇøÁµÑ„ÅøÁ´ã„Å¶ÔºàÂÆöÁæ©„Åï„Çå„Å¶„ÇãÈ†ÖÁõÆ„Å†„ÅëË©∞„ÇÅ„ÇãÔºâ
            const params = new URLSearchParams();
            params.set("usp", "pp_url");
            if (FORM_FIELDS.ending && endingLabel)
                params.set(FORM_FIELDS.ending, endingLabel);
            if (FORM_FIELDS.elapsed_sec)
                params.set(FORM_FIELDS.elapsed_sec, String(elapsedSec));
            if (FORM_FIELDS.ending_id)
                params.set(FORM_FIELDS.ending_id, endingId);

            // Êñ∞Ë¶è„Çø„Éñ„Åß„Éï„Ç©„Éº„É†„ÇíÈñã„Åè
            window.open(`${FEEDBACK_URL}${params.toString()}`, "_blank", "noopener,noreferrer");
        }


        function talkToHintCharacter(roomId, charId) {
            // flagsÂèñÂæó
            let flags = gameState[roomId].flags;
            // „Åæ„Å†„Ç´„Ç¶„É≥„ÉàÁÑ°„Åë„Çå„Å∞ÂàùÊúüÂåñ
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            flags.talkTo[charId]++;

            // „Çª„É™„Éï„É™„Çπ„ÉàÂèñÂæó
            const messages = hintMessages[roomId][charId];
            if (roomId == 'main' && charId == 'bear' && flags.talkTo[charId] == 3) {
                gameState.main.flags.canRemovePoster = true;
            }
            // ÁØÑÂõ≤Â§ñ„Å™„ÇâÊúÄÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const idx = (flags.talkTo[charId] - 1) % messages.length;
            console.log(flags.talkTo[charId]);

            // Ë°®Á§∫
            updateMessage(messages[idx]);
        }

        function showStartBoxPuzzle() {

            const itemKeys = [
                'sun', 'moon', 'snake', 'bird', 'eye', 'ank',
                'water', 'star', 'hand', 'human', 'handUnder', 'house'
            ];

            const modalContent = `
      <div id="sbpWrap" style="
        display:flex;
        width:100%;
        height:260px;
        border-radius:12px;
        overflow:hidden;
      ">
        <!-- Â∑¶ÔºöÂè§‰ª£„É¨„ÉÉ„Éâ -->
        <div class="sbp-area" data-idx="0"
          style="flex:1; 
                 background: linear-gradient(180deg, rgba(130,30,30,0.8), rgba(80,20,20,0.7)),
                             url('images/common/stone_texture.png');
                 background-size: cover;
                 display:flex; justify-content:center; align-items:center;">
          <img id="sbp-img-0" src="${IMAGES.items[itemKeys[gameState.startBoxState[0]]]}" style="width:120px;">
        </div>

        <!-- ‰∏≠ÔºöÂè§‰ª£„Ç∞„É™„Éº„É≥ -->
        <div class="sbp-area" data-idx="1"
          style="flex:1; 
                 background: linear-gradient(180deg, rgba(30,120,40,0.8), rgba(20,60,30,0.7)),
                             url('images/common/stone_texture.png');
                 background-size: cover;
                 display:flex; justify-content:center; align-items:center;">
          <img id="sbp-img-1" src="${IMAGES.items[itemKeys[gameState.startBoxState[1]]]}" style="width:120px;">
        </div>

        <!-- Âè≥ÔºöÂè§‰ª£„Éñ„É´„Éº -->
        <div class="sbp-area" data-idx="2"
          style="flex:1; 
                 background: linear-gradient(180deg, rgba(20,40,120,0.8), rgba(15,30,80,0.7)),
                             url('images/common/stone_texture.png');
                 background-size: cover;
                 display:flex; justify-content:center; align-items:center;">
          <img id="sbp-img-2" src="${IMAGES.items[itemKeys[gameState.startBoxState[2]]]}" style="width:120px;">
        </div>
      </div>

      <div style="text-align:center; margin:10px 0 5px 0; font-size:18px; color:#ddd;">
        ÁÆ±„ÅÆ„É≠„ÉÉ„ÇØÈÉ®„Å†„ÄÇ
      </div>

      <div style="text-align:center; margin-top:10px;">
        <button id="sbp-ok" class="text-btn">OK</button>
        <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
      </div>
    `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
            let state = gameState.startBoxState;

            // „ÇØ„É™„ÉÉ„ÇØÂÖ±ÈÄöÂá¶ÁêÜ
            function handleClick(e) {
                const idx = parseInt(e.currentTarget.dataset.idx, 10);
                state[idx] = (state[idx] + 1) % itemKeys.length;

                const key = itemKeys[state[idx]];
                document.getElementById(`sbp-img-${idx}`).src = IMAGES.items[key];

                playSE?.('se-click');
            }

            document.querySelectorAll(".sbp-area").forEach(el => {
                el.style.cursor = "pointer";
                el.addEventListener("click", handleClick);
            });

            function handleOk() {
                const correct = (
                    itemKeys[state[0]] === 'eye' &&
                    itemKeys[state[1]] === 'snake' &&
                    itemKeys[state[2]] === 'water'
                );

                if (correct) {
                    closeModal();
                    gameState.main.flags.unlockStartBox = true;

                    playSE?.('se-clear');
                    showModal("„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„Çà„ÅÜ„Å†", "", [
                        { text: "Èñâ„Åò„Çã", action: "close" }
                    ]);
                    ANA.send('startbox_success_20', {});

                    updateMessage?.("„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü„Çà„ÅÜ„Å†");
                    renderCanvasRoom?.();
                } else {
                    playSE?.('se-error');
                }
            }

            document.getElementById("sbp-ok").addEventListener("click", handleOk);
        }


        function showDoorPuzzle() {
            // „ÇØ„É™„ÉÉ„ÇØ„Åß„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥„Åô„Çã„Ç∑„É≥„Éú„É´‰∏ÄË¶ßÔºàIMAGE.items„Å´ÂÆöÁæ©Ê∏à„ÅøÔºâ
            const itemKeys = [
                'sun', 'moon', 'snake', 'bird', 'eye', 'ank',
                'water', 'star', 'hand', 'human', 'handUnder', 'house'
            ];



            const modalContent = `
    <div id="doorPuzzleWrap" style="
      display:flex; width:100%;
   height: clamp(160px, 38vh, 320px);     /* ÁîªÈù¢„Å´Âøú„Åò„Å¶‰º∏Á∏Æ */
   border-radius:12px; overflow:hidden;">
      <!-- Ëµ§ -->
      <div class="door-area" data-idx="0" style="
        flex:1; display:flex; justify-content:center; align-items:center;
        background: linear-gradient(180deg, rgba(150,25,25,.85), rgba(90,15,15,.8)),
                    url('images/common/stone_texture.png'); background-size:cover;">
        <img id="door-img-0" src="${IMAGES.items[itemKeys[gameState.startDoorState[0]]]}" style="width: clamp(72px, 22vw, 120px);">
      </div>
      <!-- Á∑ë -->
      <div class="door-area" data-idx="1" style="
        flex:1; display:flex; justify-content:center; align-items:center;
        background: linear-gradient(180deg, rgba(25,140,40,.85), rgba(15,70,25,.8)),
                    url('images/common/stone_texture.png'); background-size:cover;">
        <img id="door-img-1" src="${IMAGES.items[itemKeys[gameState.startDoorState[1]]]}" style="width: clamp(72px, 22vw, 120px);">
      </div>
      <!-- Èùí -->
      <div class="door-area" data-idx="2" style="
        flex:1; display:flex; justify-content:center; align-items:center;
        background: linear-gradient(180deg, rgba(25,45,150,.85), rgba(15,30,90,.8)),
                    url('images/common/stone_texture.png'); background-size:cover;">
        <img id="door-img-2" src="${IMAGES.items[itemKeys[gameState.startDoorState[2]]]}" style="width: clamp(72px, 22vw, 120px);">
      </div>
      <!-- ÁôΩ -->
      <div class="door-area" data-idx="3" style="
        flex:1; display:flex; justify-content:center; align-items:center;
        background: linear-gradient(180deg, rgba(235,235,235,.95), rgba(210,210,210,.9)),
                    url('images/common/stone_texture.png'); background-size:cover;">
        <img id="door-img-3" src="${IMAGES.items[itemKeys[gameState.startDoorState[3]]]}" style="width: clamp(72px, 22vw, 120px);">
      </div>
    </div>

    <div style="text-align:center; margin:10px 0 5px; font-size:18px; color:#ddd;">
      „Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØÈÉ®„Å†„ÄÇ
    </div>

    <div style="text-align:center; margin-top:10px;">
      <button id="door-ok" class="text-btn">OK</button>
      <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
    </div>
  `;

            // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´‰ªïÁµÑ„Åø„ÅßË°®Á§∫
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
            let state = gameState.startDoorState;

            // ÂÖ±ÈÄö„ÇØ„É™„ÉÉ„ÇØÔºöÊ¨°„ÅÆ„Ç∑„É≥„Éú„É´„Å∏Ôºà„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥Ôºâ
            function handleClick(e) {
                const idx = parseInt(e.currentTarget.dataset.idx, 10);
                state[idx] = (state[idx] + 1) % itemKeys.length;
                const key = itemKeys[state[idx]];
                document.getElementById(`door-img-${idx}`).src = IMAGES.items[key];
                playSE?.('se-click');
            }

            document.querySelectorAll('.door-area').forEach(el => {
                el.style.cursor = 'pointer';
                el.addEventListener('click', handleClick);
            });

            // Âà§ÂÆöÔºöÂ∑¶‚ÜíÂè≥„Åß bird, moon, star, ank
            function handleOk() {
                const ok =
                    itemKeys[state[0]] === 'bird' &&
                    itemKeys[state[1]] === 'moon' &&
                    itemKeys[state[2]] === 'star' &&
                    itemKeys[state[3]] === 'ank';

                if (ok) {
                    closeModal();
                    gameState.main.flags.unlockStartDoor = true;   // „Éâ„Ç¢Ëß£Èå†„Éï„É©„Ç∞
                    playSE?.('se-gogogo');
                    showModal('„Éâ„Ç¢„ÅåÈñã„ÅÑ„Åü', '', [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                    updateMessage?.('„Éâ„Ç¢„ÅåÈñã„ÅÑ„Åü');
                    ANA.send('startdoor_success_20', {});
                    renderCanvasRoom();
                } else {
                    playSE?.('se-error');
                }
            }

            document.getElementById('door-ok').addEventListener('click', handleOk);
        }

        function showCorridorDoorPuzzle() {
            // Order to press: tsubo, tallGrass, house, star
            const correct = ['tsubo', 'tallGrass', 'house', 'star'];
            const keys = ['leaf', 'star', 'fan', 'scarab', 'hand', 'tallGrass', 'handUnder', 'house', 'tsubo'].map(k => k);
            // Build grid of buttons (4 x 2)
            const btns = keys.map((k, i) => {
                return `<button class="stone-btn" data-key="${k}" style="
            width:calc(25% - 10px); height: clamp(80px, 18vh, 120px); margin:5px;
            border:2px solid #bbb; border-radius:10px;
            background:#f7f7f7 url('images/common/stone_texture.png'); background-size:cover;
            display:flex; align-items:center; justify-content:center;
            box-shadow: 0 2px 0 rgba(0,0,0,0.35), inset 0 2px 3px rgba(255,255,255,0.45);
        ">
            <img src="${IMAGES.items[k]}" alt="${k}" style="max-width: clamp(56px, 16vw, 96px); max-height: clamp(56px, 16vw, 96px);">
        </button>`
            }).join('');

            const modalContent = `
        <div style="background:#fff; padding:16px; border-radius:12px;">
            <div style="font-size:16px; color:#333; margin-bottom:8px; text-align:center;">‰∏çÊ∞óÂë≥„Å™Â£∞„ÅåÈüø„Åè‚Ä¶<br>„Äå‰∫∫„Åã„ÇâÁî≤Ëô´„Å∏„Å®Ëá≥„ÇãÊµÅ„Çå„ÇíËøΩ„Åà„Äç</div>
            <div id="corr-seq" style="min-height:28px; text-align:center; color:#444; margin-bottom:8px;"></div>
            <div id="corr-grid" style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:4px;">
                ${btns}
            </div>
            <div style="text-align:center; margin-top:12px;">
                <button id="corr-ok" class="text-btn">OK</button>
                <button id="corr-reset" class="text-btn">„ÇÑ„ÇäÁõ¥„Åô</button>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';

            const seq = [];
            const seqEl = document.getElementById('corr-seq');
            function renderSeq() {
                const labels = seq.map(s => (
                    {
                        'tsubo': 'Â£∫', 'tallGrass': 'Ëçâ', 'house': 'ÂÆ∂', 'star': 'Êòü',
                        'hand': 'Êâã', 'handUnder': 'Êâã(‰∏ã)', 'leaf': 'Ëëâ', 'scarab': '„Çπ„Ç´„É©„Éô'
                    }[s] || s
                ));
                seqEl.textContent = labels.join(' ‚Üí ');
            }

            document.querySelectorAll('#corr-grid .stone-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (seq.length >= 4) {
                        seq.shift();
                    }
                    const k = btn.getAttribute('data-key');
                    seq.push(k);
                    renderSeq();
                    playSE && playSE('se-mouse');
                });
            });

            document.getElementById('corr-reset').addEventListener('click', () => {
                seq.length = 0;
                renderSeq();
                playSE && playSE('se-click');
            });

            document.getElementById('corr-ok').addEventListener('click', () => {
                const ok = seq.length === 4 && seq.every((v, i) => v === correct[i]);
                if (ok) {
                    closeModal();
                    gameState.main.flags.unlockCorridorDoor = true;
                    renderCanvasRoom();
                    playSE && playSE('se-gogogo');
                    showModal('„Éâ„Ç¢„ÅåÈñã„ÅÑ„Åü', '', [{ text: 'Èñâ„Åò„Çã', action: 'close' }]);
                    ANA.send('corridor_door_success_20', {});
                    updateMessage('„Éâ„Ç¢„ÅåÈñã„ÅÑ„Åü');
                } else {
                    playSE && playSE('se-error');
                    updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
                }
            });
        }

        function checkStoneFusion() {
            const f = gameState.main.flags;

            if (f.foundStoneRed && f.foundStoneBlue && f.foundStoneGreen && !f.gotWhiteKey) {
                f.gotWhiteKey = true;
                addItem("whiteKey");
                removeItem('stoneRed');
                removeItem('stoneGreen');
                removeItem('stoneBlue');
                updateMessage("Ôºì„Å§„ÅÆÁü≥„ÅåÂÖâ„ÇíÊîæ„Å°„ÄÅ„Å≤„Å®„Å§„Å´ËûçÂêà„Åó„ÅüÔºÅ ÁôΩ„ÅÑÈçµ„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ");
                showModal(
                    'Ôºì„Å§„ÅÆÁü≥„ÅåÂÖâ„ÇíÊîæ„Å°„ÄÅ„Å≤„Å®„Å§„Å´ËûçÂêà„Åó„ÅüÔºÅ ÁôΩ„ÅÑÈçµ„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ',
                    `<video src="${IMAGES.modals.mvKey}" autoplay muted style="width:300px;display:block;margin:0 auto 20px;">`,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );


                // „Éï„É©„ÉÉ„Ç∑„É•„ÇÑ„Ç®„Éï„Çß„ÇØ„Éà„ÇíËøΩÂä†„Åó„Åü„ÅÑÂ†¥Âêà
                const flash = document.getElementById("fxFlash");
                if (flash) {
                    flash.style.animation = "flashWhite 1s ease-out";
                    setTimeout(() => flash.style.animation = "", 1000);
                }
            } else {
                return;
            }
        }

        function showEntranceWallPuzzle() {
            const bgUrl = IMAGES.modals.entranceWall;
            const triKeys = ['tri1', 'tri2', 'tri3', 'tri4', 'tri5', 'tri6', 'tri7', 'tri8'];
            const pressedSequence = [];

            const body = `
  <div id="entranceWallWrap"
       style="
        width:min(540px, 96vw);
        max-height:calc(100vh - 64px);   /* ÁîªÈù¢ÂÜÖ„Å´Âèé„ÇÅ„Çã */
        display:flex;                     /* Á∏¶„É¨„Ç§„Ç¢„Ç¶„Éà */
        flex-direction:column;
        border-radius:12px;
        overflow:hidden;
        background:#2e2b26;">

    <!-- ‰∏ãÔºö„Éú„Çø„É≥ÔºÜÊìç‰Ωú„Ç®„É™„Ç¢ÔºàÁ∏¶„Å´Á∏Æ„ÇÄÔºè‰∏≠„ÅØ„Çπ„ÇØ„É≠„Éº„É´Ôºâ -->
    <div style="
        background:#3d3b36;
        padding: clamp(12px, 2.5vh, 18px);
        display:flex;
        flex-direction:column;
        gap:10px;
        flex:1;                           /* ‰ΩôÁôΩ„ÅØ„Åì„Åì„ÅßÂèó„Åë„Çã */
        overflow:auto;">
      
      <div id="modalButtons"
           style="
             display:flex; flex-wrap:wrap;
             gap:10px;
             justify-content:center;">
      </div>

      <!-- Êìç‰Ωú„Éú„Çø„É≥Âàó„ÅØÂ∏∏„Å´Ë¶ã„Åà„Çã„Çà„ÅÜ„Å´‚Äústicky‚Äù -->
      <div style="position:sticky; bottom:0; background:#3d3b36; padding-top:4px; text-align:center;">
        <button id="wall-ok" class="text-btn" style="padding:clamp(6px,2vh,10px) 14px; font-size:clamp(14px,2.6vw,16px);">OK</button>
        <button class="text-btn" onclick="closeModal()" style="padding:clamp(6px,2vh,10px) 14px; font-size:clamp(14px,2.6vw,16px);">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>`;

            document.getElementById('modalContent').innerHTML = body;
            document.getElementById('modal').style.display = 'flex';

            const btnContainer = document.getElementById('modalButtons');
            triKeys.forEach((key) => {
                const btn = document.createElement('button');
                // „Åì„Åì„Çí‚ÄúÂõ∫ÂÆö120√ó110px‚Äù„Åã„ÇâÂèØÂ§âÔºÜÊ≠£ÊñπÂΩ¢„Å∏
                btn.innerHTML = `
      <img src="${IMAGES.items[key]}" alt="${key}" style="
        width: clamp(64px, 22vw, 104px);
        height: clamp(64px, 22vw, 104px);
        aspect-ratio:1/1;                 /* Ê≠£ÊñπÂΩ¢„Ç≠„Éº„Éó */
        margin:0;
        border:2px solid #bbb; border-radius:10px;
        background:#f7f7f7 url('images/common/stone_texture.png'); background-size:cover;
        display:block;
        box-shadow: 0 2px 0 rgba(0,0,0,0.35), inset 0 2px 3px rgba(255,255,255,0.45);
      ">`;
                btn.addEventListener('click', () => {
                    pressedSequence.push(key);
                    btn.classList.add('pressed');
                    setTimeout(() => btn.classList.remove('pressed'), 140);
                    playSE?.('se-click');
                });
                btnContainer.appendChild(btn);
            });

            document.getElementById('wall-ok').addEventListener('click', () => {
                const correct = ['tri5', 'tri1', 'tri3'];
                const ok = pressedSequence.length >= correct.length
                    && correct.every((v, i) => pressedSequence[i] === v);
                if (ok) {
                    closeModal();
                    gameState.main.flags.wallPuzzleSolved = true;
                    gameState.entranceLeft.flags.backgroundState++;
                    renderCanvasRoom();
                    playSE?.('se-gogogo');
                    ANA.send('entrancewall_success_20', {});
                    showModal(
                        '‰ªïÊéõ„Åë„Åå‰ΩúÂãï„Åó„Åü',
                        `<img src="${IMAGES.modals.entranceWallClear}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;filter: drop-shadow(0 0 6px rgba(255,64,64,.6));">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    updateMessage('‰ªïÊéõ„Åë„Åå‰ΩúÂãï„Åó„Åü');
                } else {
                    playSE?.('se-error');
                    pressedSequence.length = 0;
                }
            });
        }


        function handleTorchExamined(id) {
            let f = gameState.main.flags;
            if (f.unlockCorridorBox) {
                updateMessage('„Åü„ÅÑ„Åæ„Å§„ÅåÁáÉ„Åà„Å¶„ÅÑ„Çã');
                return;
            }
            if (!f.torchSequence.includes(id)) {
                f.torchSequence.push(id);
            }

            // ÊåáÂÆöÈ†Ü„Å´‰∏ÄËá¥„Åó„Åü„Çâ„Éï„É©„Ç∞ON
            const correctOrder = [
                'examine_corridor_right_room_torch',
                'examine_entrance_torch2',
                'examine_entrance_left_torch',
                'examine_entrance_torch'
            ];

            const idx = f.torchSequence.length - 1;
            if (f.torchSequence[idx] !== correctOrder[idx]) {
                f.torchSequence = [id]; // „Éü„Çπ„Åó„Åü„ÇâÊúÄÂàù„Åã„Çâ
                updateMessage('„Åü„ÅÑ„Åæ„Å§„ÅåÁáÉ„Åà„Å¶„ÅÑ„Çã');
                return;
            }

            // ÈÄî‰∏≠„Åæ„ÅßÊ≠£Ëß£„Å™„ÇâÊÆµÈöéÁöÑ„Å´„Éí„É≥„Éà
            if (f.torchSequence.length < correctOrder.length) {
                const remaining = correctOrder.length - f.torchSequence.length;
                updateMessage('ÁÇé„ÅÆÊè∫„Çâ„ÇÅ„Åç„ÇíÁú∫„ÇÅ„Å¶„ÅÑ„Çã„Å®„ÄÅ„Åã„Åô„Åã„Å™Áâ©Èü≥„Åå„Åó„ÅüÊ∞ó„Åå„Åó„Åü„ÄÇ');
                // updateMessage(`‰Ωï„Åã„ÅåÂèçÂøú„Åó„ÅüÊ∞ó„Åå„Åô„ÇãÔºà„ÅÇ„Å®${remaining}Êú¨Ôºâ`);
                playSE('se-click');
            } else if (f.torchSequence.length === correctOrder.length) {
                // ÂÖ®ÈÉ®Ê≠£Ëß£ÔºÅ
                showModal('„Å©„Åì„Åã„ÅßÁâ©Èü≥„Åå„Åó„Åü', '', [
                    { text: 'OK', action: 'close' }
                ]);
                gameState.main.flags.unlockCorridorBox = true;
                playSE('se-gacha');
                f.torchSequence = [];
                ANA.send('corridor_box_success_20', {});
            }
        }

        function handleBadEnd() {
            gameState.main.flags.bearMoveCnt++;
            if (gameState.main.flags.bearMoveCnt > 3) {
                ANA.send('bad_end_bear_20', {});
                window._nextModal = {
                    title: '‚Ä¶„Å®ÊÄù„Å£„Åü„Çâ‰ª≤Èñì„ÇíÈÄ£„Çå„Å¶Ë•≤„ÅÑÊéõ„Åã„Å£„Å¶„Åç„ÅüÔºÅ<br>„ÄêBAD END„Äë',
                    content: `<img src="${IMAGES.modals.badEndBear}" style="width:400px;display:block;margin:0 auto 20px;">`,
                    buttons: [{ text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart' }],
                };
                const onClosed = () => {
                    playSE('se-gao');
                    updateMessage('„ÇØ„Éû„Éü„Ç§„É©„ÅÆÈõÜÂõ£„Å´Ë•≤„Çè„Çå„Åü„ÄÇ„Éê„ÉÉ„Éâ„Ç®„É≥„Éâ');
                };
                window.addEventListener('modal:closed', onClosed, { once: true });
            }
        }

        // function handleDoor() {
        //     if (gameState.flags.trueEndUnlocked) {
        //         gameState.endings.true = true;
        //         travelWithStepsTrueEnd();
        //     } else {
        //         changeRoom('end');
        //     }
        // }

        // Êó¢Â≠ò„ÅÆ handleDoor „ÇíÁΩÆ„ÅçÊèõ„Åà
        function handleDoor() {
            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÈÅ∑ÁßªÂÖ±ÈÄö„Éè„É≥„Éâ„É©
            const goEnding = () => {
                if (gameState.flags.trueEndUnlocked) {
                    gameState.endings.true = true;
                    travelWithStepsTrueEnd();
                } else {
                    changeRoom('end');
                }
            };

            // Èáë„Å¥„Åã„ÅÆÂÉè„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åü„Çâ„ÉØ„É≥„ÇØ„ÉÉ„Ç∑„Éß„É≥
            if (hasItem('statue')) {
                // Èñâ„Åò„Åü„ÇâÈÅ∑Áßª„Åô„Çã„ÉØ„É≥„Ç∑„Éß„ÉÉ„Éà„É™„Çπ„Éä
                const onClosed = () => {
                    removeItem('statue');
                    goEnding();
                };
                window.addEventListener('modal:closed', onClosed, { once: true });

                // Ë¶ã„ÅüÁõÆ„Å§„Åç„ÅÆÊ≥®ÊÑè„É¢„Éº„ÉÄ„É´
                showModal(
                    '„Åì„Çå„ÅØÁΩÆ„ÅÑ„Å¶„ÅÑ„Åì„ÅÜ',
                    `<div style="max-width:420px;margin:0 auto;">
                <img src="${IMAGES.modals.statuePlaced}" style="width:220px;max-width:100%;display:block;margin:0 auto 16px;">
                <div>Â§ñ„Å∏„ÅØÊåÅ„Å°Âá∫„Åï„Å™„ÅÑ„Åª„ÅÜ„ÅåËâØ„Åï„Åù„ÅÜ„Å†‚Ä¶</div>
            </div>`,
                    [{ text: 'OK', action: 'close' }]
                );
                return; // „É¢„Éº„ÉÄ„É´ÁµåÁî±„ÅßÈÅ∑Áßª
            }

            goEnding();
        }


        // „Ç¢„Ç§„ÉÜ„É†ÁÆ°ÁêÜ
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 8) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }

        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ‰ΩøÁî®„Åó„Åü„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay();
            }
        }

        function getItemName(itemId) {
            const names = {
                coin: '„ÇØ„Éû„Ç≥„Ç§„É≥',
                bear: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                lever: '„É¨„Éê„Éº',
                hachimaki: 'Â∏ÉÂàá„Çå',
                stick: 'Ê£í',
                statue: 'Èáë„Å¥„Åã„ÅÆÂÉè',
                torch: '„Åü„ÅÑ„Åæ„Å§',
                torchOn: 'ÁáÉ„Åà„Çã„Åü„ÅÑ„Åæ„Å§',
                memo: '„É°„É¢',
                stoneBlue: 'Èùí„ÅÑÁü≥',
                stoneGreen: 'Á∑ë„ÅÆÁü≥',
                stoneRed: 'Ëµ§„ÅÑÁü≥',
                whiteKey: 'ÁôΩ„ÅÑÈçµ',
                carpet: 'È≠îÊ≥ï„ÅÆ„Åò„ÇÖ„ÅÜ„Åü„Çì',
                money: '„ÅäÈáë',
                gyoza: 'È§ÉÂ≠ê'



            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            if (gameState.currentRoom === 'underground') return;
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;
                btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        function addNaviItem(room) {
            if (!gameState.openRooms.includes(room)) {
                gameState.openRooms.push(room);
                return true;
            }
            return false;
        }

        // „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫Êõ¥Êñ∞
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function () {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                    const magBtn = document.createElement('div');
                    magBtn.className = 'magnifier-btn';
                    magBtn.title = 'Êã°Â§ßË°®Á§∫';
                    magBtn.innerHTML = '<img src="images/magnifier.png" alt="Êã°Â§ß">';
                    magBtn.onclick = (e) => {
                        e.stopPropagation();

                        const itemId = gameState.inventory[index];

                        // „Éá„Éï„Ç©„ÅÆ‰∏≠Ë∫´
                        let content = `<img src="${img.src}" style="max-width:300px;max-height:300px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`;
                        let buttons = [{ text: 'Èñâ„Åò„Çã', action: 'close' }];

                        // „Éû„É≥„Éà„Å™„Çâ„ÄåË™ø„Åπ„Çã„Äç„Éú„Çø„É≥„ÇíËøΩÂä†ÔºàÈçµÊú™ÂÖ•ÊâãÔºÜÊú™Áô∫Ë¶ã„Éï„É©„Ç∞ÊôÇ„ÅÆ„ÅøÔºâ
                        if (itemId === 'cloak' && !hasItem('key') && !gameState.main.flags.foundKey) {
                            buttons = [
                                { text: 'Ë™ø„Åπ„Çã', action: 'inspectCloak' },
                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                            ];
                        }

                        showModal(
                            getItemName(itemId),
                            content,
                            buttons
                        );
                    };
                    slot.appendChild(magBtn);
                }
                // ‚òÖÈÅ∏Êäû‰∏≠„Å™„Çâselected„ÇØ„É©„ÇπËøΩÂä†
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }


        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        function updateMessage(message) {
            //document.getElementById('messageArea').innerHTML = message;
            document.getElementById('msgText').textContent = message;
        }

        function updateMessageHTML(html) {
            const el = document.getElementById('msgText');
            el.innerHTML = html;
            el.querySelectorAll('a').forEach(a => {
                a.target = '_blank';
                a.rel = 'noopener';
                a.style.color = '#d4af37';
                a.style.textDecoration = 'underline';
            });
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content, buttons, onSequenceSuccess) {
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            if (buttons && buttons.length > 0) {
                modalHtml += `<div id="modalButtons" style="text-align:center;"></div>`;
                modalHtml += `<div id="modalClose" style="margin-top:25px;text-align:center;"></div>`;
            }
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';

            if (!buttons || buttons.length === 0) return;

            let pressed = [];
            let heartCnt = 0;
            let checkCnt = 0;
            let houseCnt = 0;

            // ÁîªÂÉè/ÈÄöÂ∏∏„Éú„Çø„É≥„Å®close„Éú„Çø„É≥„ÅßÂàÜ„Åë„Çã
            const modalButtons = document.getElementById('modalButtons');
            const modalClose = document.getElementById('modalClose');

            buttons.forEach((button, idx) => {
                // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅØ‰∏ã„Å∏
                if (button.action === 'close') {
                    const btn = document.createElement('button');
                    btn.textContent = button.text || 'Èñâ„Åò„Çã';
                    btn.className = 'modal-close-btn';
                    btn.onclick = function () {
                        closeModal();
                        if (typeof onSequenceSuccess === "function") {
                            onSequenceSuccess();
                        }
                    };
                    modalClose.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.style.margin = "0 10px 10px 0";
                    if (button.img) {
                        btn.innerHTML = `<img src="${button.img}" alt="${button.text || ''}" style="width:80px;height:80px;vertical-align:middle;">`;
                    } else {
                        btn.textContent = button.text;
                        btn.className = 'text-btn';
                    }
                    btn.onclick = function () {
                        if (button.action === 'restart') {
                            restartGame();
                        } else if (typeof button.action === "function") {
                            button.action();
                        } else if (typeof button.action === 'string') {
                            closeModal();
                            handleAreaClick(button.action);
                        }
                    };
                    modalButtons.appendChild(btn);
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
            if (window._nextModal) {
                // ÁôªÈå≤ÂÜÖÂÆπ„ÅØ {title, content, buttons, after} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                let modal = window._nextModal;
                window._nextModal = null; // „ÇØ„É™„Ç¢

                if (typeof modal === 'function') {
                    try { modal(); } catch (e) { }
                    window.dispatchEvent(new Event('modal:closed'));
                    return;
                }

                if (modal.before) modal.before();
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after();
            }
            window.dispatchEvent(new Event('modal:closed'));
        }

        // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„Éà
        function restartGame() {
            gameState = getDefaultGameState();
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;
        let isBGMInitialized = false; // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®

        // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Å†„ÅëBGM„ÇíÂÜçÁîü
        function initBGMOnce() {
            if (!isBGMInitialized) {
                const bgm = document.getElementById('bgm');
                bgm.volume = 0.3;
                bgm.play();
                isBGMPlaying = true;
                isBGMInitialized = true;
                document.getElementById('bgm-toggle').textContent = "üîä BGM";
            }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "üîä BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "üîá BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // „Éï„Ç°„Ç§„É´Âêç„ÅÆ„Åø„ÅßÊØîËºÉ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            if (current === next) return; // „Åô„Åß„Å´„Åù„ÅÆBGM„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function pauseBGM() {
            const bgm = document.getElementById('bgm');
            bgm.src = "";
            bgm.pause();
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // „Å©„Åì„Åã„ÅßÊúÄÂàù„Å´‰∏ÄÂ∫¶„Å†„ÅëÂëº„Å∂
        let loadedImages = {};
        function preloadImages() {
            // ÈÉ®Â±ãÁîªÂÉè
            Object.values(IMAGES.rooms).forEach(val => {
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        if (!loadedImages[src]) {
                            const img = new Image();
                            img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                            img.src = src;
                            loadedImages[src] = img;



                        }
                    });
                } else if (typeof val === "string") {
                    if (!loadedImages[val]) {
                        const img = new Image();
                        img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                        img.src = val;
                        loadedImages[val] = img;
                    }
                }
            });
            // „Ç¢„Ç§„ÉÜ„É†ÁîªÂÉè
            Object.values(IMAGES.items).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
            // „É¢„Éº„ÉÄ„É´ÁîªÂÉè
            Object.values(IMAGES.modals).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
        }

        function saveGame() {
            const toSave = { ...gameState, __version: SAVE_VERSION };
            localStorage.setItem(SAVE_KEY, JSON.stringify(toSave));
            updateMessage('„Çª„Éº„Éñ„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function loadGame() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) {
                updateMessage('„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            const saved = JSON.parse(raw);

            // „Éá„Éï„Ç©„É´„Éà„Å®„Éû„Éº„Ç∏„Åó„Å¶‰∏çË∂≥„Ç≠„Éº„ÇíË£úÂÆå
            const def = getDefaultGameState();
            const merged = deepMerge(def, saved);

            if (!Array.isArray(merged.openRooms)) merged.openRooms = def.openRooms.slice();
            if (!merged.currentRoom || !rooms[merged.currentRoom]) merged.currentRoom = def.currentRoom;

            gameState = merged;

            changeRoom(gameState.currentRoom);
            updateInventoryDisplay?.();
            renderNavigation?.();
            updateMessage('„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ');
        }


        function deepMerge(target, source) {
            if (source === undefined || source === null) return target;
            if (Array.isArray(source)) return source.slice();
            if (typeof source === 'object') {
                const out = (target && typeof target === 'object') ? { ...target } : {};
                for (const k of Object.keys(source)) {
                    out[k] = deepMerge(target ? target[k] : undefined, source[k]);
                }
                return out;
            }
            return source;
        }

        function showToast(text, ms = 2600) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = text;
            el.style.opacity = '1';
            el.style.transform = 'translateX(-50%) translateY(0)';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(-50%) translateY(-8px)';
            }, ms);
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        preloadImages();
        initGame();
    </script>
    <div id="toast"
        style="position:fixed;left:50%;top:14px;transform:translateX(-50%);
padding:10px 14px;border-radius:8px;background:#1f6feb;color:#fff;font-weight:700;
box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s; z-index:9999;">
    </div>

</body>

</html>