<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="å¤œç©ºãŒè¦‹ãˆã‚‹éƒ¨å±‹ã‚’èˆå°ã«ã—ãŸåˆ†å²ã‚¨ãƒ³ãƒ‰ä»˜ãã®ç„¡æ–™è„±å‡ºã‚²ãƒ¼ãƒ ã€‚å…¨4ã‚¨ãƒ³ãƒ‰ã®ãƒãƒ«ãƒã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€‚ã‚¹ãƒãƒ›ï¼†PCå¯¾å¿œã€‚">
    <title>å¤œç©ºãŒè¦‹ãˆã‚‹éƒ¨å±‹ã‹ã‚‰ã®è„±å‡º</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;
            /* â†ã“ã‚Œé‡è¦ */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
        }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            /* flex: 1; */
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 12px;
            /* width:100%; */
        }

        .inventory-slot {
            width: 14vw;
            height: 14vw;
            max-width: 80px;
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;
            /* é‡‘è‰²ãƒ»å¤ªã‚æ¨å¥¨ */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .magnifier-btn {
            position: absolute;
            right: 4px;
            bottom: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0002;
            cursor: pointer;
            z-index: 10;
            transition: box-shadow .15s;
        }

        .magnifier-btn:hover {
            box-shadow: 0 0 10px #ffd70099;
        }

        .magnifier-btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .info-panel {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            height: 65px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        #msgText {}

        #statusIconArea {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px #0005;
            font-size: 1.4em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        #modalButtons button {
            border: none;
            background: none;
            padding: 0;
            margin: 0 10px 10px 0;
            cursor: pointer;
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
            border-radius: 10px;
        }

        #modalButtons button img {
            width: 80px;
            height: 80px;
            vertical-align: middle;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
        }

        #modalButtons button:hover img {
            filter: brightness(1.08) drop-shadow(0 2px 6px #ffd70050);
            box-shadow: 0 0 10px #ffd70080;
            transform: scale(1.05);
        }

        #modalButtons button:active img,
        #modalButtons button.pressed img {
            filter: brightness(0.95) grayscale(20%);
            box-shadow: 0 0 8px #3332;
            transform: scale(0.97);
        }

        #modalButtons button:disabled img {
            filter: grayscale(90%) opacity(0.5);
            box-shadow: none;
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆå‹ãƒœã‚¿ãƒ³ã‚‚ç”»åƒãƒœã‚¿ãƒ³é¢¨ã« */
        #modalButtons button.text-btn {
            min-width: 120px;
            font-size: 1.15em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            margin: 0 10px 10px 0;
            box-shadow: 0 4px 14px #ffc90022;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s, transform 0.08s;
            vertical-align: middle;
            display: inline-block;
        }

        #modalButtons button.text-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
            transform: scale(1.05);
        }

        #modalButtons button.text-btn:active {
            filter: brightness(0.96);
            transform: scale(0.97);
        }

        #modalButtons button.text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */
        #modalClose .modal-close-btn {
            display: inline-block;
            min-width: 160px;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            box-shadow: 0 4px 14px #ffc90022;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s;
        }

        #modalClose .modal-close-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        .login-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            width: 280px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'Segoe UI', sans-serif;
        }

        .login-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .login-form label {
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .login-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .login-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ç”»åƒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }

        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            /* width: 40%; */
        }

        @media (max-width: 600px) {
            #msgText {
                font-size: .8rem;
            }

            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }

            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width: 100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }

        #roomEffectOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }

        .title-wrapper {
            display: flex;
            width: 100%;
        }

        @keyframes warpFlash {
            0% {
                opacity: 0
            }

            15% {
                opacity: .95
            }

            50% {
                opacity: .4
            }

            100% {
                opacity: 0
            }
        }

        @keyframes chroma {
            0% {
                filter: none
            }

            100% {
                filter: contrast(1.2) saturate(1.2) hue-rotate(20deg)
            }
        }

        .warp-active {
            background: radial-gradient(circle at 50% 50%, #fff, #000 70%);
            animation: warpFlash 900ms ease-out both, chroma 900ms ease-out both;
        }

        #hintModal {
            color: #000;
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F2G9BX4FBF"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-F2G9BX4FBF');
</script>

<body>
    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <div class="title">å¤œç©ºãŒè¦‹ãˆã‚‹éƒ¨å±‹ã‹ã‚‰ã®è„±å‡º</div>
            <div style="margin:0 0; text-align:center;">
                <!-- <a href="escape13_hint.html" target="_blank"
                    style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    ğŸ” ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
                </a> -->
                <button id="hintFab"
                    style="z-index:9999;padding:10px 14px;border-radius:999px;border:none;box-shadow:0 4px 16px rgba(0,0,0,.2);background:#222;color:#fff;cursor:pointer">
                    ğŸ’¡ ãƒ’ãƒ³ãƒˆ
                </button>
            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="640" style="width: 90vw; max-width: 640px;"></canvas>

        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="msgText">æ°—ãŒä»˜ãã¨ã‚ãªãŸã¯å¤œç©ºãŒè¦‹ãˆã‚‹éƒ¨å±‹ã«é–‰ã˜è¾¼ã‚ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚</span>
                    <div id="statusIconArea" style="position:absolute; bottom:6px; right:12px; display:flex; gap:8px;">
                    </div>
                </div>
                <div class="navigation">

                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
                <div class="inventory-slot" onclick="useItem(5)"></div>
                <div class="inventory-slot" onclick="useItem(6)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
                ğŸ”Š BGM
            </button>
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">ã‚»ãƒ¼ãƒ–</button>
                <button class="nav-btn" onclick="loadGame()">ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
        <div class="notice">å½“ã‚µã‚¤ãƒˆã®éŸ³æºã¯<a href="https://otologic.jp/" target="blank">OtoLogic</a>,<a
                href="https://dova-s.jp/" target="blank">DOVA-SYNDROME</a>ã®ç´ æã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ ä½œè€…:<a href="index.html">ã‚¹ãƒ©ã‚»ãƒ–ãƒ³</a>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã¯å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>
    <!-- hintãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="hintModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.5)">
        <div
            style="max-width:560px;margin:10vh auto;background:#fff;border-radius:12px;padding:16px 16px 8px;box-shadow:0 10px 30px rgba(0,0,0,.3)">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                <strong id="hintTitle">ãƒ’ãƒ³ãƒˆ</strong>
                <button id="hintClose"
                    style="border:none;background:transparent;font-size:20px;cursor:pointer">âœ•</button>
            </div>
            <div id="hintBody" style="margin:12px 0">
                <!-- æ®µéšãƒ’ãƒ³ãƒˆãŒå…¥ã‚‹ -->
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center">
                <small id="hintUsage" style="opacity:.7"></small>
                <button id="hintMore"
                    style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#f7f7f7;cursor:pointer">ã•ã‚‰ã«è¦‹ã‚‹</button>
            </div>
        </div>
    </div>
    <audio id="bgm" src="sounds/11/Is_The_Source_Exist.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-clear" src="sounds/common/Cyber03-1.mp3"></audio>
    <audio id="se-change" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-down" src="sounds/common/Motion-Grab07-1(Dry).mp3"></audio>
    <audio id="se-open" src="sounds/common/Short_Accent09-1(Dry).mp3"></audio>
    <audio id="se-fanta" src="sounds/common/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <audio id="se-coin" src="sounds/common/Onoma-Ding01-1(Dry).mp3"></audio>
    <audio id="se-scene-change" src="sounds/common/Scene_Change08-1(Delay-Fast).mp3"></audio>
    <audio id="se-gacha" src="sounds/common/Retro_Anime-Switch02-3(Low).mp3"></audio>
    <audio id="se-eat" src="sounds/common/Motion-Eating02-1.mp3"></audio>
    <audio id="se-bad-space" src="sounds/13/Single_Accent18-1(Mid).mp3"></audio>
    <audio id="se-warp" src="sounds/13/kidouontekina2.mp3"></audio>
    <script>
        // --- Analytics helper ---
        window.ANA = {
            start: Date.now(),
            hintCount: 0,
            send(ev, params = {}) { try { gtag('event', ev, params); } catch (e) { } }
        };

        window.ANA = Object.assign(window.ANA || {}, {
            sid: Math.random().toString(36).slice(2),
            sent: new Set(),
            baseParams() {
                return {
                    elapsed_sec: Math.round((Date.now() - this.start) / 1000),
                    hints: this.hintCount || 0,
                    save_version: (typeof SAVE_VERSION === 'number' ? SAVE_VERSION : null),
                    room: (window.gameState && gameState.currentRoom) || null,
                    sid: this.sid,
                };
            },
            once(ev, key = '', params = {}) {
                const k = `${ev}:${key}`;
                if (this.sent.has(k)) return;
                this.sent.add(k);
                this.send(ev, { ...this.baseParams(), ...params });
            }
        });

        // æ±ç”¨ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€ä¿¡ç”¨ãƒ˜ãƒ«ãƒ‘
        function markProgress(step, extra = {}) {
            ANA.once('progress', step, { step, ...extra });
        }

        (() => {
            const puzzleId = "escape13_short";

            // â€”â€” ãƒ–ãƒ©ãƒ³ãƒåˆ¤å®šï¼šä»Šã©ã®é€²æ—ã‹
            function getBranch() {
                const f = (gameState && gameState.main && gameState.main.flags) || {};
                if (!f.foundKey) return "need_key";
                if (!f.unlockDrawer3) return "need_drawer3";
                if (!f.unlockDoor) return "need_door";
                return "done";
            }

            // â€”â€” ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã®ãƒ’ãƒ³ãƒˆé…åˆ—
            function getHintsFor(branch) {
                switch (branch) {
                    case "need_key": return [
                        "ã€ãƒ’ãƒ³ãƒˆ1ã€‘ã¾ã é–‹ã‘ã¦ãªã„å°ã•ãªå¼•ãå‡ºã—ã€ã©ã“ã‹ã«ã‚ã‚Šã¾ã™ã€‚",
                        "ã€ãƒ’ãƒ³ãƒˆ2ã€‘æœºã®å°å¼•ãå‡ºã—ã€èª¿ã¹ã¦ã¿ã‚ˆã†ã€‚",
                        "ã€ãƒ’ãƒ³ãƒˆ3ã€‘ãã®å°å¼•ãå‡ºã—ã‚’èª¿ã¹ã‚Œã°ã‚«ã‚®GETã€‚"
                    ];
                    case "need_drawer3": return [
                        "ã€ãƒ’ãƒ³ãƒˆ1ã€‘å¼•ãå‡ºã—ã®ä¸‹æ®µã‚’é–‹ã‘ã‚ˆã†ã€‚æ°—ã«ãªã‚‹æ˜Ÿåº§ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿ",
                        "ã€ãƒ’ãƒ³ãƒˆ2ã€‘ğŸµğŸ°ğŸ¦Šã¯ä¸¦ã³é †ã€‚æœ¬ã¨ãƒ¡ãƒ¢ã‹ã‚‰æ•°å­—ã‚’æ¢ãã†ã€‚",
                        "ã€ãƒ’ãƒ³ãƒˆ3ã€‘å¼•ãå‡ºã—ä¸­æ®µã®ãƒ¡ãƒ¢ã¨ã€ã‚¦ã‚µã‚®ã®çµµæœ¬ã‹ã‚‰æ•°å­—ã‚’å°ã“ã†ã€‚"
                    ];
                    case "need_door": return [
                        "ã€ãƒ’ãƒ³ãƒˆ1ã€‘æœ€å¾Œã¯ãƒ‰ã‚¢ã®ãƒ­ãƒƒã‚¯ã€‚",
                        "ã€ãƒ’ãƒ³ãƒˆ2ã€‘å·¦å³ã«åˆ†ã‹ã‚ŒãŸãƒ¡ãƒ¢ã€‚",
                        "ã€ãƒ’ãƒ³ãƒˆ3ã€‘å…¥åŠ›ã¯â€œgoâ€ï¼‹â€œè¥¿æš¦â€ã€‚"
                    ];
                    case "done": return [
                        "ãƒ­ãƒƒã‚¯ã¯è§£é™¤æ¸ˆã¿ã€‚ã‚‚ã†ãƒ‰ã‚¢ã‚’èª¿ã¹ã‚Œã°é€²ã‚ã¾ã™"
                    ];
                    default: return ["ï¼ˆãƒ’ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã­ï¼‰"];
                }
            }

            // â€”â€” ãƒ–ãƒ©ãƒ³ãƒåˆ¥ã« tier ã‚’ä¿å­˜ï¼ˆï¼æ®µéšãŒå¤‰ã‚ã‚Œã°è‡ªå‹•ã§0ã‹ã‚‰ï¼‰
            function tierKey(branch) { return `hintTier_${puzzleId}_${branch}`; }
            function getTier(branch) {
                if (!gameState.main.hintTiers) gameState.main.hintTiers = {};
                return gameState.main.hintTiers[branch] || 0;
            }

            function setTier(branch, n) {
                if (!gameState.main.hintTiers) gameState.main.hintTiers = {};
                gameState.main.hintTiers[branch] = n;
            }

            // â€”â€” è¦ç´ 
            const elFab = document.getElementById("hintFab");
            const elModal = document.getElementById("hintModal");
            const elBody = document.getElementById("hintBody");
            const elClose = document.getElementById("hintClose");
            const elMore = document.getElementById("hintMore");
            const elUsage = document.getElementById("hintUsage");

            // æ–‡å­—ãŒè–„ã„å•é¡Œã«å¯¾å¿œï¼ˆè¦‹ã‚„ã™ãï¼‰
            if (elUsage) {
                elUsage.style.opacity = "1";
                elUsage.style.fontSize = "14px";
                elUsage.style.color = "#222";
            }

            let cooling = false;
            let blurArmed = true;
            let lastBranch = null;

            function render() {
                const branch = getBranch();
                const hints = getHintsFor(branch);

                // ãƒ–ãƒ©ãƒ³ãƒãŒå¤‰ã‚ã£ãŸã‚‰ tier æœªè¨­å®šï¼0ã‹ã‚‰å§‹ã¾ã‚‹ï¼ˆã‚­ãƒ¼ã‚‚åˆ¥ï¼‰
                const tier = Math.min(getTier(branch), hints.length);

                // ãƒ˜ãƒƒãƒ€ã«â€œç¾åœ¨åœ°â€ãƒŸãƒ‹è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
                const smallHead = document.createElement("div");
                smallHead.style.fontSize = "12px";
                smallHead.style.color = "#555";
                smallHead.style.marginBottom = "8px";
                const badge = {
                    need_key: "é€²æ—: ã‚«ã‚®âœ— / ä¸‹æ®µâœ— / ãƒ‰ã‚¢âœ—",
                    need_drawer3: "é€²æ—: ã‚«ã‚®âœ“ / ä¸‹æ®µâœ— / ãƒ‰ã‚¢âœ—",
                    need_door: "é€²æ—: ã‚«ã‚®âœ“ / ä¸‹æ®µâœ“ / ãƒ‰ã‚¢âœ—",
                    done: "é€²æ—: ã‚«ã‚®âœ“ / ä¸‹æ®µâœ“ / ãƒ‰ã‚¢âœ“"
                }[branch] || "";
                smallHead.textContent = badge;

                elBody.innerHTML = "";
                elBody.appendChild(smallHead);

                // æ—¢ã«è§£æ”¾æ¸ˆã¿ã®æ®µã¾ã§è¡¨ç¤º
                for (let i = 0; i < tier; i++) {
                    const p = document.createElement("p");
                    p.textContent = hints[i];
                    p.style.margin = "0 0 10px";
                    p.style.color = "#111";
                    elBody.appendChild(p);
                }

                // æ¬¡æ®µéšãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã¼ã‹ã—ï¼‰
                if (tier < hints.length) {
                    const nextWrap = document.createElement("div");
                    nextWrap.style.position = "relative";
                    nextWrap.style.margin = "0 0 10px";

                    const next = document.createElement("div");
                    next.textContent = hints[tier];
                    next.style.filter = blurArmed ? "blur(6px)" : "none";
                    next.style.userSelect = "none";
                    next.style.transition = "filter .2s";
                    next.style.color = "#111";
                    nextWrap.appendChild(next);

                    if (blurArmed) {
                        const tap = document.createElement("div");
                        tap.textContent = "ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦ã¼ã‹ã—è§£é™¤ï¼‰";
                        tap.style.position = "absolute";
                        tap.style.inset = "0";
                        tap.style.display = "grid";
                        tap.style.placeItems = "center";
                        tap.style.background = "rgba(255,255,255,.6)";
                        tap.style.cursor = "pointer";
                        nextWrap.appendChild(tap);
                        tap.addEventListener("click", () => {
                            blurArmed = false;
                            next.style.filter = "none";
                            tap.remove();
                        });
                    }
                    elBody.appendChild(nextWrap);
                }

                // ä½¿ç”¨å›æ•°è¡¨ç¤º
                if (elUsage) elUsage.textContent = `ãƒ’ãƒ³ãƒˆä½¿ç”¨ ${Math.min(tier + 1, hints.length)}/${hints.length}`;

                // ãƒœã‚¿ãƒ³çŠ¶æ…‹
                if (tier >= hints.length) {
                    elMore.disabled = true;
                    elMore.textContent = "ã“ã‚Œä»¥ä¸Šã¯ã‚ã‚Šã¾ã›ã‚“";
                } else {
                    elMore.disabled = false;
                    elMore.textContent = "ã•ã‚‰ã«è¦‹ã‚‹";
                }

                // åˆ†æï¼ˆä»»æ„ï¼‰
                if (branch !== lastBranch && window.gtag) {
                    gtag('event', 'hint_context', { puzzleId, branch });
                }
                lastBranch = branch;
            }

            function openModal() {
                blurArmed = true; // æ¯å›ã¼ã‹ã—ã‹ã‚‰
                elModal.style.display = "block";
                render();
                if (window.gtag) gtag('event', 'hint_open', { puzzleId });
            }
            function closeModal() { elModal.style.display = "none"; }

            elFab?.addEventListener("click", openModal);
            elClose?.addEventListener("click", closeModal);
            elModal?.addEventListener("click", (e) => { if (e.target === elModal) closeModal(); });

            elMore?.addEventListener("click", () => {
                if (cooling) return;
                const branch = getBranch();
                const hints = getHintsFor(branch);
                const next = Math.min(getTier(branch) + 1, hints.length);
                setTier(branch, next);
                render();

                ANA.hintCount = (ANA.hintCount || 0) + 1;
                ANA.send('open_hint', {
                    count: ANA.hintCount,
                    branch,
                    tier: next
                });

                if (window.gtag) gtag('event', 'hint_tier_unlock', { puzzleId, branch, tier: next });


            });

            // åˆå›ï¼šå„ãƒ–ãƒ©ãƒ³ãƒã¯æœªè¨­å®šï¼ˆï¼0ï¼‰ã§è‰¯ã„
        })();

        window._nextModal = null;
        const canvas = document.getElementById('gameCanvas');
        // ã‚²ãƒ¼ãƒ è¨­å®š - ç”»åƒãƒ‘ã‚¹ã‚’ã“ã“ã§ç®¡ç†
        let IMAGES = {
            rooms: {
                main: ['images/13/main.png', 'images/13/main2.png'],
                drawerInner1: ['images/13/drawer_inner.png'],
                drawerInner2: ['images/13/drawer_inner.png'],
                drawerInner3: ['images/13/drawer_inner.png'],
                book1: ['images/13/book1.png'],
                book2: ['images/13/book2.png'],
                book3: ['images/13/book3.png'],
                book4: ['images/13/book4.png'],
                book5: ['images/13/book5.png'],
                book6: ['images/13/book6.png'],
                bookNengou: ['images/13/book_nengou.png'],
                end: ['images/13/end.png'],
                trueEnd: ['images/13/true_end.jpg'],
                trueEnd2: ['images/13/true_end2.jpg'],
                end1969: ['images/13/end1969.png'],

            },
            items: {

                coin: 'images/bear_coin.png',
                bear: 'images/bear.png',
                back: 'images/common/back.png',
                arrowRight: 'images/common/arrow_right.png',
                arrowLeft: 'images/common/arrow_left.png',
                redBack: 'images/common/red_back.png',
                greenBack: 'images/common/green_back.png',
                key: 'images/13/key.png',
                memo: 'images/13/memo.png',
                // partDummy4: 'images/13/4dummy.png',
                part4_1: 'images/13/4-1.png',
                part2_2: 'images/13/2-2.png',
                bearDango: 'images/13/bear_dango.png',
                memoDoorRight: 'images/13/memodoor_right.png',
                memoDoorLeft: 'images/13/memodoor_left.png',
                dango: 'images/13/dango.png',

            },

            modals: {
                sky: 'images/13/sky.png',
                dango: 'images/13/dango.png',
                bearDango: 'images/13/bear_dango.png',
                bearGive: 'images/13/bear_give.png',
                memo: 'images/13/memo.png',
                badend: 'images/13/badend.jpg',
            },


        };


        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        const SAVE_KEY = 'escapeGameState13';
        const SAVE_VERSION = 1;

        function getDefaultGameState() {
            return {
                currentRoom: 'main',
                openRooms: ['main'],
                inventory: [],
                main: {
                    flags: {
                        hintTiers: {},
                        foundKey: false, unlockDrawer3: false, badEnd: false, found4Part: false,
                        talkTo: { books: 0 }, backgroundState: 0, dangoAppear: false, foundDango: false, wakeupBear: false
                    }

                },

                drawerInner1: {
                    flags: { foundDummyPart: false, },
                },
                drawerPuzzle: { digits: [0, 0, 0], solved: false },
                drawerInner2: {
                    flags: {},
                },
                drawerInner3: {
                    flags: { foundPart: false },
                },
                drawerDigits: { d1: null, d2: null, d3: null },

                endings: { normal: false, true: false },
                flags: { trueEndUnlocked: false, apolloEnd: false },
                selectedItem: null,

            };
        }

        let gameState = getDefaultGameState();




        // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿
        let rooms = {
            main: {
                name: 'å¤œç©ºãŒè¦‹ãˆã‚‹éƒ¨å±‹',
                description: '',
                clickableAreas: [
                    {
                        x: 3.2, y: 44.3, width: 10.3, height: 33.1,
                        action: 'examine_main_door',
                        description: 'ãƒ‰ã‚¢',
                    },
                    {
                        x: 3.3, y: 37.8, width: 9.6, height: 14.5,
                        action: 'examine_main_door_input',
                        description: 'ãƒ‰ã‚¢ã®ãƒ‘ãƒãƒ«',
                        zIndex: 2
                    },
                    {
                        x: 87.3, y: 16.2, width: 9.7, height: 26.0,
                        action: 'examine_main_books',
                        description: 'æœ¬æ£šã®æœ¬',
                    },
                    {
                        x: 87.9, y: 47.3, width: 8.8, height: 13.7,
                        action: 'examine_main_books2',
                        description: 'æœ¬æ£šã®æœ¬ä¸‹æ®µ',
                    },
                    {
                        x: 32.4, y: 9.7, width: 13.5, height: 13.5,
                        action: 'examine_main_window_above',
                        description: 'çª“ä¸Šéƒ¨',
                        zIndex: 1,
                    },
                    {
                        x: 32.4, y: 25.5, width: 26.7, height: 34.4,
                        action: 'examine_main_window_below',
                        description: 'çª“ä¸‹éƒ¨',
                        zIndex: 1,
                    },
                    {
                        x: 35.4, y: 62.3, width: 9.3, height: 6.0,
                        action: 'examine_main_dango',
                        description: 'ãŠå›£å­',
                        zIndex: 1,
                        usable: () => gameState.main.flags.dangoAppear && !gameState.main.flags.foundDango,
                        item: {
                            img: 'dango',
                            visible: () => gameState.main.flags.dangoAppear && !gameState.main.flags.foundDango,
                        },
                    },
                    {
                        x: 29.1, y: 70.1, width: 19.1, height: 5.0,
                        action: 'examine_main_drawer1',
                        description: 'å¼•ãå‡ºã—1',
                        zIndex: 1,
                    },
                    {
                        x: 29.1, y: 76.7, width: 19.1, height: 5.0,
                        action: 'examine_main_drawer2',
                        description: 'å¼•ãå‡ºã—2',
                        zIndex: 1,
                    },
                    {
                        x: 29.4, y: 83.0, width: 18.6, height: 5.4,
                        action: 'examine_main_drawer3',
                        description: 'å¼•ãå‡ºã—3',
                        zIndex: 1,
                    },
                    {
                        x: 71.9, y: 73.4, width: 19.1, height: 7.9,
                        action: 'examine_main_book_open',
                        description: 'é–‹ã„ãŸæœ¬',
                        zIndex: 1,
                    },
                    {
                        x: 89.6, y: 62.0, width: 7.1, height: 7.4,
                        action: 'examine_main_desk_drawer',
                        description: 'æœºã®å¼•ãå‡ºã—',
                        zIndex: 1,
                    },
                    {
                        x: 73.6, y: 27.1, width: 10.7, height: 11.8,
                        action: 'examine_main_pic',
                        description: 'çµµç”»',
                        zIndex: 1,
                        usable: () => true,
                        item: {
                            img: 'bearDango',
                            visible: () => true,
                        },
                    },

                    {
                        x: 11.3, y: 72.9, width: 17.8, height: 19.3,
                        action: 'examine_main_bear',
                        description: 'ã‚¯ãƒå¦–ç²¾',
                        zIndex: 6,
                        usable: () => gameState.main.flags.wakeupBear,
                        item: {
                            img: 'bear',
                            visible: () => gameState.main.flags.wakeupBear,
                        },
                    },

                ]
            },

            drawerInner1: {
                name: 'å¼•ãå‡ºã—ä¸Šæ®µ',
                description: '',
                clickableAreas: [
                    {
                        x: 22.9, y: 30.9, width: 10, height: 10,
                        action: 'rotate_drawer_digit_1',
                        description: 'æ•°å­—(ä¸Šæ®µ)'
                    },
                    // {
                    //     x: 54.6, y: 46.8, width: 16.7, height: 33.4,
                    //     action: 'examine_drawer1_part',
                    //     description: 'ãƒ‘ãƒ¼ãƒ„',
                    //     zIndex: 5,
                    //     usable: () => !gameState.drawerInner1.flags.foundDummyPart,
                    //     item: {
                    //         img: 'partDummy4',
                    //         visible: () => !gameState.drawerInner1.flags.foundDummyPart,
                    //     },
                    // },
                    {
                        x: 32.5, y: 60.9, width: 14.9, height: 20.4,
                        action: 'examine_drawer1_memo',
                        description: 'ãƒ¡ãƒ¢ã®ç ´ç‰‡',
                        zIndex: 5,
                        usable: () => true,
                        item: {
                            img: 'memoDoorLeft',
                            visible: () => true,
                        },
                    },
                    {
                        x: 90.6, y: 90.6, width: 9.4, height: 9.4,
                        action: 'examine_drawer_back',
                        description: 'æˆ»ã‚‹',
                        zIndex: 5,
                        item: {
                            img: 'back',
                            visible: () => true,
                        },
                    },
                ]
            },
            drawerInner2: {
                name: 'å¼•ãå‡ºã—ä¸­æ®µ',
                description: '',
                clickableAreas: [
                    {
                        x: 22.9, y: 30.9, width: 10, height: 10,
                        action: 'rotate_drawer_digit_2',
                        description: 'æ•°å­—(ä¸­æ®µ)'
                    },
                    {
                        x: 55.7, y: 64.1, width: 18.3, height: 18.1,
                        action: 'examine_drawer2_memo',
                        description: 'ãƒ¡ãƒ¢',
                        zIndex: 1,
                        usable: () => true,
                        item: {
                            img: 'memo',
                            visible: () => true,
                        },
                    },

                    {
                        x: 90.6, y: 90.6, width: 9.4, height: 9.4,
                        action: 'examine_drawer_back',
                        description: 'æˆ»ã‚‹',
                        zIndex: 5,
                        item: {
                            img: 'back',
                            visible: () => true,
                        },
                    },
                ]
            },
            drawerInner3: {
                name: 'å¼•ãå‡ºã—ä¸‹æ®µ',
                description: '',
                clickableAreas: [
                    {
                        x: 22.9, y: 30.9, width: 10, height: 10,
                        action: 'rotate_drawer_digit_3',
                        description: 'æ•°å­—(ä¸‹æ®µ)'
                    },
                    {
                        x: 53.7, y: 60.9, width: 14.9, height: 20.4,
                        action: 'examine_drawer3_memo',
                        description: 'ãƒ¡ãƒ¢',
                        zIndex: 1,
                        usable: () => true,
                        item: {
                            img: 'memoDoorRight',
                            visible: () => true,
                        },
                    },
                    {
                        x: 34.6, y: 46.8, width: 16.7, height: 16.7,
                        action: 'examine_drawer3_part',
                        description: 'ãƒ‘ãƒ¼ãƒ„',
                        zIndex: 5,
                        usable: () => !gameState.drawerInner3.flags.foundPart,
                        item: {
                            img: 'part2_2',
                            visible: () => !gameState.drawerInner3.flags.foundPart,
                        },
                    },
                    {
                        x: 90.6, y: 90.6, width: 9.4, height: 9.4,
                        action: 'examine_drawer_back',
                        description: 'æˆ»ã‚‹',
                        zIndex: 5,
                        item: {
                            img: 'back',
                            visible: () => true,
                        },
                    },
                ]
            },

            book1: {
                name: 'çµµæœ¬',
                description: '',
                clickableAreas: [

                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book1_right',
                        description: 'â†’', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_book_back',
                        description: 'æˆ»ã‚‹', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            book2: {
                name: 'çµµæœ¬',
                description: '',
                clickableAreas: [

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book2_left',
                        description: 'â†', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book2_right',
                        description: 'â†’', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_book_back',
                        description: 'æˆ»ã‚‹', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            book3: {
                name: 'çµµæœ¬',
                description: '',
                clickableAreas: [

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book3_left',
                        description: 'â†', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book3_right',
                        description: 'â†’', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_book_back',
                        description: 'æˆ»ã‚‹', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            book4: {
                name: 'çµµæœ¬',
                description: '',
                clickableAreas: [

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book4_left',
                        description: 'â†', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book4_right',
                        description: 'â†’', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_book_back',
                        description: 'æˆ»ã‚‹', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            book5: {
                name: 'çµµæœ¬',
                description: '',
                clickableAreas: [

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book5_left',
                        description: 'â†', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book5_right',
                        description: 'â†’', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_book_back',
                        description: 'æˆ»ã‚‹', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            book6: {
                name: 'çµµæœ¬',
                description: '',
                clickableAreas: [

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        action: 'examine_book6_left',
                        description: 'â†', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_book_back',
                        description: 'æˆ»ã‚‹', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            bookNengou: {
                name: 'æ­´å²ã®æœ¬',
                description: '',
                clickableAreas: [
                    {
                        x: 93.6, y: 93.6, width: 6.4, height: 6.4,
                        action: 'examine_book_back',
                        description: 'æˆ»ã‚‹', zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    },
                ]
            },
            end: {
                name: 'ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰',
                description: 'è„±å‡ºãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚ã£ã•ã‚Šè„±å‡ºã§ãã¾ã—ãŸã‹ï¼Ÿ',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        action: 'examine_end',
                        description: 'ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰'
                    },
                ]
            },

            trueEnd: {
                name: 'å¹³å®‰æ™‚ä»£ã«è„±å‡ºæˆåŠŸ',
                description:
                    'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ç¶ºéº—ãªæœˆã‚’çœºã‚ã¾ã—ã‚‡ã†' +
                    '',
                clickableAreas: [{ x: 0, y: 0, width: 100, height: 100, action: 'examine_true_end', description: 'ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰' }]
            },
            trueEnd2: {
                name: 'å¹³å®‰æ™‚ä»£ã«è„±å‡ºæˆåŠŸ',
                description:
                    'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ãŠå›£å­ã‚’é£Ÿã¹ã¤ã¤ç¶ºéº—ãªæœˆã‚’çœºã‚ã¾ã—ã‚‡ã†' +
                    '',
                clickableAreas: [{ x: 0, y: 0, width: 100, height: 100, action: 'examine_true_end2', description: 'ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰+' }]
            },
            end1969: {
                name: 'ã‚¢ãƒãƒ­æ™‚ä»£ã«è„±å‡ºæˆåŠŸ',
                description:
                    'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æœ¬å½“ã«ã“ã®æ™‚ä»£ã§è‰¯ã‹ã£ãŸï¼Ÿ' +
                    '',
                clickableAreas: [{ x: 0, y: 0, width: 100, height: 100, action: 'examine_end1969', description: 'ã‚¢ãƒãƒ­ã‚¨ãƒ³ãƒ‰' }]
            },
        };

        const hintMessages = {
            main: {
                bear: [
                    "å‘¼ã‚“ã ï¼Ÿ",
                    "ãƒœã‚¯ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã ã‚ˆ",
                    "ãŠå›£å­é£Ÿã¹ãŸã„ã­ã€‚odango",
                ],
                bear2: [
                    "ã‚ãƒ¼ã„",
                    "å¤–ã«å‡ºã¦ã¿ã‚ˆã†ã‚ˆ",
                ],
                bear3: [
                    "ãŠå›£å­ã ãƒ¼",
                    "å¤–ã§ä¸€ç·’ã«é£Ÿã¹ã‚ˆã†",
                ],
                books: [
                    "æœ¬ãŒä¸¦ã‚“ã§ã„ã‚‹",
                    "ã€Œé™ã‹ãªèˆ¹æ—…ã€",
                    "ã€Œæœˆèˆªæ—¥èªŒã€",
                    "ã€Œå®‡å®™ç©ºé–“ã§å›£å­ã¯ãŸã¹ã‚‰ã‚Œã‚‹ã®ã‹ï¼Ÿã€",
                    "ã€Œ2082å®‡å®™ã®æ—…ã€",
                    "ã€Œã‚¢ãƒãƒ­11å·ã®çœŸå®Ÿã€",
                ]
            },
            atticRight: {
                bear: [
                    "â€¦",
                ],

            },

        };

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            renderNavigation();
            changeRoom('main');
            updateMessage('æ°—ãŒä»˜ãã¨ã‚ãªãŸã¯å¤œç©ºãŒè¦‹ãˆã‚‹éƒ¨å±‹ã«é–‰ã˜è¾¼ã‚ã‚‰ã‚Œã¦ã„ã¾ã—ãŸ');
        }

        function findHitArea(x, y, clickableAreas, canvas) {
            // zIndexé™é †ã§
            const sorted = clickableAreas.slice().sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            for (const area of sorted) {
                // å¿…è¦ãªã‚‰usableåˆ¤å®šã‚‚ã“ã“ã§
                const usable = area.usable === undefined ? true :
                    (typeof area.usable === "function" ? area.usable() : area.usable);

                if (!usable) continue; // ä½¿ãˆãªã„ã‚¨ãƒªã‚¢ã¯åˆ¤å®šã—ãªã„
                const ax = area.x / 100 * canvas.width;
                const ay = area.y / 100 * canvas.height;
                const aw = area.width / 100 * canvas.width;
                const ah = area.height / 100 * canvas.height;
                if (x >= ax && x <= ax + aw && y >= ay && y <= ay + ah) {
                    return area; // æœ€åˆã«ãƒ’ãƒƒãƒˆã—ãŸã‚‚ã®ã ã‘è¿”ã™ï¼
                }
            }
            return null;
        }

        let hoveredAreaIndex = null;  // ä»Šhoverã—ã¦ã‚‹ã‚¨ãƒªã‚¢ï¼ˆãªã‘ã‚Œã°nullï¼‰
        canvas.addEventListener('mousemove', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);
            const idx = area ? room.clickableAreas.indexOf(area) : null;
            if (hoveredAreaIndex !== idx) {
                hoveredAreaIndex = idx;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('mouseout', function () {
            if (hoveredAreaIndex !== null) {
                hoveredAreaIndex = null;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('click', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // â˜…ä»Šã„ã‚‹éƒ¨å±‹ã®ã‚¨ãƒªã‚¢ã ã‘åˆ¤å®šï¼
            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);

            if (area) {
                handleAreaClick(area.action, e);
            }

        });

        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];

            // èƒŒæ™¯ï¼‹ã‚¢ã‚¤ãƒ†ãƒ ï¼‹ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒªã‚¢ã‚’canvasã§å…¨éƒ¨å†æç”»
            renderCanvasRoom();
            const msg = (room.name && room.name.trim() !== "")
                ? `${room.name}ã§ã™ã€‚${room.description}`
                : room.description;
            if (roomId === 'endPiyoSafe' || roomId === 'trueEnd') {
                updateMessageHTML(msg);
            } else {
                updateMessage(msg);
            }

            // BGMåˆ‡æ›¿ã¯ãã®ã¾ã¾
            if (roomId === "trueEnd" || roomId === "trueEnd2") {
                changeBGM("sounds/13/seihitsuniwa.mp3");
                gameState.openRooms = [];
                renderNavigation();
            } else if (roomId === "end") {
                changeBGM("sounds/13/tsukiwomitsumete.mp3");
                gameState.openRooms = [];
                renderNavigation();
            } else if (roomId === "end1969") {
                changeBGM("sounds/13/Past_and_Future.mp3");
                gameState.openRooms = [];
                renderNavigation();
            } else {
                changeBGM("sounds/13/Village_girl.mp3");
            }
            
        }

        const END_IDS = new Set(['end', 'trueEnd']);

        const _changeRoom_orig = changeRoom;
        changeRoom = function (roomId) {
            _changeRoom_orig.apply(this, arguments);

            if (END_IDS.has(roomId)) {
                const elapsed = Math.round((Date.now() - ANA.start) / 1000);
                ANA.endTimes = ANA.endTimes || {};
                if (!ANA.endTimes[roomId]) ANA.endTimes[roomId] = elapsed;

                const isTrue = (roomId === 'trueEnd');
                ANA.send('ending_reached', {
                    ending_id: roomId,
                    is_true: isTrue,
                    elapsed_sec: elapsed,
                    hints: ANA.hintCount,

                });
                // setTimeout(() => showFeedbackModal(roomId), 1500);
            }
        }


        function renderCanvasRoom() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const roomId = gameState.currentRoom;
            const room = rooms[roomId];
            const bgImgSrc = getRoomBackgroundImage(roomId, gameState);

            ctx.clearRect(0, 0, canvas.width, canvas.height);


            // èƒŒæ™¯æç”»
            const bgImg = loadedImages[bgImgSrc];
            if (bgImg && bgImg.complete) {
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            }

            // ã‚¢ã‚¤ãƒ†ãƒ æç”»ï¼ˆæœªå–å¾—ã®ã¿ï¼‰
            drawRoomItems(ctx, canvas, roomId);

            // â˜… ã“ã“ã‹ã‚‰é‡ãªã‚Šå„ªå…ˆã®hoveræ ç·šã‚’æç”»
            if (hoveredAreaIndex !== null && hoveredAreaIndex !== undefined) {
                // zIndexé™é †ã§ã‚½ãƒ¼ãƒˆ
                const sortedAreas = room.clickableAreas
                    .map((area, i) => ({ ...area, __idx: i }))
                    .filter(area => area.usable === undefined ? true :
                        (typeof area.usable === "function" ? area.usable() : area.usable)
                    )
                    .sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
                // hoveredAreaIndexã¨ä¸€è‡´ã™ã‚‹ã‚¨ãƒªã‚¢ã‚’zIndexé †ã§1ã¤ã ã‘æ æç”»
                const hoverArea = sortedAreas.find(area => area.__idx === hoveredAreaIndex);
                if (hoverArea) {
                    const ax = hoverArea.x / 100 * canvas.width;
                    const ay = hoverArea.y / 100 * canvas.height;
                    const aw = hoverArea.width / 100 * canvas.width;
                    const ah = hoverArea.height / 100 * canvas.height;
                    ctx.save();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(ax, ay, aw, ah);
                    ctx.restore();
                }
            }


            drawDrawerDigitsOverlay(ctx, roomId);
            drawSparkles(ctx);


        }

        function drawRoomItems(ctx, canvas, roomId) {
            const room = rooms[roomId];
            room.clickableAreas.forEach(area => {
                if (area.item && area.item.visible && area.item.visible()) {
                    const img = loadedImages[IMAGES.items[area.item.img]];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const alpha = area.alpha ? area.alpha : 1;
                        const px = area.x / 100 * canvas.width;
                        const py = area.y / 100 * canvas.height;
                        const w = area.width / 100 * canvas.width;
                        const h = area.height / 100 * canvas.height;
                        ctx.save();
                        ctx.globalAlpha = alpha;
                        ctx.drawImage(img, px, py, w, h);
                        ctx.restore();
                    }
                }
            });
        }


        function getRoomBackgroundImage(roomId, gameState) {
            let state = gameState[roomId]?.flags?.backgroundState || 0;
            let imgList = IMAGES.rooms[roomId];
            if (Array.isArray(imgList)) {
                return imgList[state] || imgList[0];
            } else {
                return imgList;
            }
        }

        function drawDrawerDigitsOverlay(ctx, roomId) {

            if (!['drawerInner1', 'drawerInner2', 'drawerInner3'].includes(roomId)) return;
            const map = { drawerInner1: 'd1', drawerInner2: 'd2', drawerInner3: 'd3' };
            const key = map[roomId];
            const val = gameState.drawerDigits[key];

            if (val === null) return;

            ctx.save();
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            // ctx.fillRect(150, 200, 70, 70);
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 54px Arial';
            ctx.fillText(String(val), 170, 230);
            ctx.restore();
        }




        // å°ç‰©ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function pointInRect(x, y, r) {
            return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;
        }

        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
            ctx.beginPath();
            ctx.moveTo(x + r.tl, y);
            ctx.lineTo(x + w - r.tr, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
            ctx.lineTo(x + w, y + h - r.br);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
            ctx.lineTo(x + r.bl, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
            ctx.lineTo(x, y + r.tl);
            ctx.quadraticCurveTo(x, y, x + r.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        // ç”»é¢ã«æ˜Ÿã‚¹ãƒ”ãƒ¼ãƒ‰ç·šã‚’æµã™ç°¡æ˜“ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function startTimeWarp(afterMs = 1400, onDone = () => { }) {
            const overlay = document.getElementById('roomEffectOverlay');
            const ctx = canvas.getContext('2d');
            let running = true;
            let t0 = performance.now();

            // æ—¢å­˜SEã‚’æ´»ç”¨
            playSE && playSE('se-scene-change');

            // è‰²ã‚ºãƒ¬ï¼†ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
            overlay.classList.add('warp-active');

            // å…¥åŠ›ãƒ­ãƒƒã‚¯
            const oldOnClick = canvas.onclick;
            canvas.style.pointerEvents = 'none';

            // ã‚¹ã‚¿ãƒ¼ã‚¹ãƒˆãƒªãƒ¼ã‚¯ï¼ˆ1ç§’ã»ã©ï¼‰
            function streaks(now) {
                if (!running) return;
                const dt = (now - t0) / 1000;
                // å…ƒã®éƒ¨å±‹ã‚’ä¸€åº¦æãç›´ã—
                renderCanvasRoom();

                // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ä¸Šæã
                const N = 90;
                ctx.save();
                ctx.globalAlpha = 0.45;
                for (let i = 0; i < N; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const len = 80 + Math.random() * 220;
                    const ang = -Math.PI / 2 + (Math.random() - .5) * 0.35; // ä¸Šæ–¹å‘ä¸­å¿ƒ
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + Math.cos(ang) * len, y + Math.sin(ang) * len);
                    ctx.lineWidth = 1 + Math.random() * 2;
                    ctx.strokeStyle = `rgba(255,255,255,${0.25 + Math.random() * 0.5})`;
                    ctx.stroke();
                }
                ctx.restore();

                if (dt < 1.0) {
                    requestAnimationFrame(streaks);
                }
            }
            requestAnimationFrame(streaks);

            // çµ‚äº†å‡¦ç†
            setTimeout(() => {
                running = false;
                overlay.classList.remove('warp-active');
                canvas.style.pointerEvents = '';
                if (typeof onDone === 'function') onDone();
            }, afterMs);
        }



        // ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleAreaClick(action, event) {
            const f = gameState.main.flags;
            switch (action) {
                // mainDoor
                case 'examine_main_door':
                    if (gameState.main.flags.unlockDoor) {
                        handleDoor();
                    } else {
                        updateMessage('é–‹ã‹ãªã„');
                    }
                    break;
                case 'examine_main_door_input':
                    if (gameState.main.flags.unlockDoor) {
                        updateMessage('ãƒ­ãƒƒã‚¯ã¯è§£é™¤ã•ã‚Œã¦ã„ã‚‹ã€‚è„±å‡ºã—ã‚ˆã†');
                    } else {
                        showDoorPuzzle();
                    }
                    break;
                case 'examine_main_window_above':
                    if (gameState.main.flags.backgroundState == 0) {
                        showModal(
                            '',
                            `<img src="${IMAGES.modals.sky}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                        );
                    } else {
                        updateMessage('ã•ã£ãã¨é¢¨æ™¯ãŒå¤‰ã‚ã£ãŸã‚ˆã†ãªæ°—ãŒã™ã‚‹â€¦');
                    }
                    break;
                case 'examine_main_window_below':
                    if (gameState.main.flags.backgroundState == 0) {
                        updateMessage('çµµã®ã‚ˆã†ã«ç¶ºéº—ãªå¤œæ™¯ã ');
                    } else {
                        updateMessage('æœˆãŒå‡ºã¦ã„ã‚‹');
                    }

                    break;
                case 'examine_main_dango':
                    showModal(
                        'ãŠæœˆè¦‹å›£å­ã‚’æ‰‹ã«å…¥ã‚ŒãŸ',
                        `<img src="${IMAGES.modals.dango}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                    );
                    gameState.main.flags.foundDango = true;
                    addItem('dango');
                    break;
                case 'examine_main_pic':
                    showModal(
                        '',
                        `<img src="${IMAGES.modals.bearDango}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                    );
                    break;
                case 'examine_main_bear':
                    if (gameState.main.flags.talkTo.bear > 2 && !gameState.main.flags.found4Part) {
                        showModal(
                            'ã“ã‚Œã‚ã’ã‚‹',
                            `<img src="${IMAGES.modals.bearGive}" style="width:300px;display:block;margin:0 auto 20px;">`,
                            [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                        );
                        gameState.main.flags.found4Part = true;
                        addItem('part4_1');
                    } else if (gameState.flags.trueEndUnlocked) {
                        talkToHintCharacter('main', 'bear2');
                    } else if (gameState.selectedItem == 'dango' || hasItem('dango')) {
                        talkToHintCharacter('main', 'bear3');
                    } else {
                        talkToHintCharacter('main', 'bear');
                    }

                    break;
                case 'examine_main_books':
                    talkToHintCharacter('main', 'books');
                    break;
                case 'examine_main_books2':
                    changeRoom('bookNengou');
                    break;
                case 'examine_main_drawer1':
                    if (!gameState.main.flags.unlockDrawer1 && gameState.selectedItem == 'key') {
                        gameState.main.flags.unlockDrawer1 = true;
                        removeItem('key');
                        updateMessage('ã‚«ã‚®ã‚’é–‹ã‘ãŸ');
                        playSE('se-gacha')
                    } else if (gameState.main.flags.unlockDrawer1) {
                        changeRoom('drawerInner1');
                    } else if (!gameState.main.flags.unlockDrawer1) {
                        updateMessage('ã‚«ã‚®ãŒã‹ã‹ã£ã¦ã„ã‚‹');
                    }
                    break;
                case 'examine_main_drawer2':
                    changeRoom('drawerInner2');
                    break;
                case 'examine_main_drawer3':
                    if (!gameState.main.flags.unlockDrawer3) {
                        showDrawer3Puzzle();
                    } else {
                        changeRoom('drawerInner3');
                    }
                    break;
                case 'examine_main_desk_drawer':
                    if (!gameState.main.flags.foundKey) {
                        showModal(
                            'ã‚«ã‚®ã‚’ã¿ã¤ã‘ãŸ',
                            '<img src="images/13/key.png" style="width:300px;display:block;margin:0 auto 20px;">',
                            [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                        );
                        updateMessage('ã‚«ã‚®ã‚’ã¿ã¤ã‘ãŸ');
                        gameState.main.flags.foundKey = true;
                        addItem('key');
                    } else {
                        updateMessage('ã‚‚ã†ãªã«ã‚‚ãªã„');
                    }
                    break;
                case 'examine_main_book_open':
                    changeRoom('book1');
                    break;


                // drawer
                case 'examine_drawer1_part':
                    if (!gameState.drawerInner1.flags.foundDummyPart) {
                        gameState.drawerInner1.flags.foundDummyPart = true;
                        addItem('partDummy4');
                        renderCanvasRoom();
                        updateMessage('?ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');
                    }
                    break;
                case 'examine_drawer1_memo':
                    showModal(
                        'ãƒ¡ãƒ¢ã ',
                        '<img src="images/13/memodoor_left.png" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                    );
                    break;

                case 'examine_drawer2_memo':
                    showModal(
                        'æ‰‹æ›¸ãã®ãƒ¡ãƒ¢ã ',
                        `<img src="${IMAGES.modals.memo}" style="width:300px;display:block;margin:0 auto 20px;">`,
                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                    );
                    break;
                case 'examine_drawer3_memo':
                    showModal(
                        'ãƒ¡ãƒ¢ã ',
                        '<img src="images/13/memodoor_right.png" style="width:300px;display:block;margin:0 auto 20px;">',
                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                    );
                    break;
                case 'examine_drawer3_part':
                    if (!gameState.drawerInner3.flags.foundPart) {
                        gameState.drawerInner3.flags.foundPart = true;
                        addItem('part2_2');
                        renderCanvasRoom();
                        updateMessage('?ã‚’æ‰‹ã«å…¥ã‚ŒãŸ');
                    }
                    break;
                case 'rotate_drawer_digit_1':
                    if (gameState.main.flags.wakeupBear) break;
                    if (gameState.drawerDigits.d1 === null) {
                        gameState.drawerDigits.d1 = 0;
                    } else {
                        gameState.drawerDigits.d1 = (gameState.drawerDigits.d1 + 1) % 10;
                    }
                    playSE('se-click');
                    renderCanvasRoom();
                    checkBearAppear();
                    break;

                case 'rotate_drawer_digit_2':
                    if (gameState.main.flags.wakeupBear) break;
                    if (gameState.drawerDigits.d2 === null) {
                        gameState.drawerDigits.d2 = 0;
                    } else {
                        gameState.drawerDigits.d2 = (gameState.drawerDigits.d2 + 1) % 10;
                    }
                    playSE('se-click');
                    renderCanvasRoom();
                    checkBearAppear();
                    break;

                case 'rotate_drawer_digit_3':
                    if (gameState.main.flags.wakeupBear) break;
                    if (gameState.drawerDigits.d3 === null) {
                        gameState.drawerDigits.d3 = 0;
                    } else {
                        gameState.drawerDigits.d3 = (gameState.drawerDigits.d3 + 1) % 10;
                    }
                    playSE('se-click');
                    renderCanvasRoom();
                    checkBearAppear();
                    break;
                case 'examine_drawer_back':
                    changeRoom('main');
                    break;

                // book
                case 'examine_book1_right':
                    changeRoom('book2');
                    break;
                case 'examine_book2_left':
                    changeRoom('book1');
                    break;
                case 'examine_book2_right':
                    changeRoom('book3');
                    break;
                case 'examine_book3_left':
                    changeRoom('book2');
                    break;
                case 'examine_book3_right':
                    changeRoom('book4');
                    break;
                case 'examine_book4_left':
                    changeRoom('book3');
                    break;
                case 'examine_book4_right':
                    changeRoom('book5');
                    break;
                case 'examine_book5_left':
                    changeRoom('book4');
                    break;
                case 'examine_book5_right':
                    changeRoom('book6');
                    break;
                case 'examine_book6_left':
                    changeRoom('book5');
                    break;
                case 'examine_book_back':
                    changeRoom('main');
                    break;
                case 'examine_end':
                    showEndingReport('end');
                    break;
                case 'examine_true_end':
                    showEndingReport('trueEnd');
                    break;
                case 'examine_true_end2':
                    showEndingReport('trueEnd2');
                    break;
                case 'examine_end1969':
                    showEndingReport('end1969');
                    break;
            }
            gameState.selectedItem = null;
            gameState.selectedItemSlot = null;

            playSE('se-click');
            updateInventoryDisplay();
        }

        function showEndingReport(endingId) {
            const f = gameState.main.flags;
            const dr = gameState.drawerDigits || {};
            const ana = window.ANA || {};
            const sec = Math.max(
                1,
                (ana.endTimes && ana.endTimes[endingId]) ||
                Math.round((Date.now() - (ana.start || Date.now())) / 1000)
            );
            const mm = String(Math.floor(sec / 60)).padStart(2, '0');
            const ss = String(sec % 60).padStart(2, '0');

            // --- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç¨®åˆ¥ãƒ†ã‚­ã‚¹ãƒˆ ---
            const endingTxt = ({
                trueEnd: 'ğŸŒ™ TRUE ENDï¼ˆå¹³å®‰ã®æœˆè¦‹ã¸â€¦ï¼‰',
                trueEnd2: 'ğŸŒ™ TRUE+ ENDï¼ˆå¹³å®‰ã®æœˆè¦‹ã¸â€¦withãŠå›£å­ï¼‰',
                end: 'â­ NORMAL ENDï¼ˆå¤œç©ºã®æœˆã‚’è¦‹ä¸Šã’ã¦è„±å‡ºï¼‰',
                end1969: 'â­ Apollo ENDï¼ˆæœˆé¢ã¸è„±å‡ºï¼‰',
                badEnd: 'ğŸ’€ BAD ENDï¼ˆæ™‚ç©ºã®å½¼æ–¹ã¸â€¦ï¼‰'
            })[endingId] || 'â­ END';

            // --- å®Ÿç¸¾ãƒ†ã‚­ã‚¹ãƒˆ ---
            const bearTxt = f.wakeupBear
                ? 'ğŸ» ã‚¯ãƒå¦–ç²¾ï¼šç¾ã‚ŒãŸ'
                : 'ğŸ» ã‚¯ãƒå¦–ç²¾ï¼šã„ãªã„';

            const dangoTxt = f.foundDango ? 'ğŸ¡ ãŠå›£å­ï¼šGET' : 'ğŸ¡ ãŠå›£å­ï¼šãªã—';

            const hintTxt = `ğŸ” ãƒ’ãƒ³ãƒˆä½¿ç”¨ï¼š${ana.hintCount || 0}å›`;
            const timeTxt = `âŒ› ãƒ—ãƒ¬ã‚¤æ™‚é–“ï¼š${mm}:${ss}`;

            // --- ãƒ¬ãƒãƒ¼ãƒˆHTML ---
            const html = `
      <div style="text-align:left;max-width:540px">
        <div style="font-size:1.4em;margin-bottom:10px">${endingTxt}</div>
        <ul style="line-height:1.8;margin:0;padding-left:1.1em">
          <li>${bearTxt}</li>
          <li>${dangoTxt}</li>
          <li>${hintTxt}</li>
          <li>${timeTxt}</li>
        </ul>
        <div style="margin-top:14px;font-size:.95em;opacity:.9">
          ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼<br>ã”æ„è¦‹åŠ±ã¿ã«ãªã£ã¦ã„ã¾ã™
        </div>
      </div>
    `;

            showModal('', html, [
                { text: 'æ„Ÿæƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã', action: () => openFeedbackForm(endingId, { mm, ss }) },
                { text: 'é–‰ã˜ã‚‹', action: 'close' }
            ]);
        }


        const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSd6k08zmIxKhxfie-81-jSvtzbj0X0WZc7fow441ejRTLXneQ/viewform";

        // äº‹å‰å…¥åŠ›ã®é …ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä»»æ„ï¼‰
        const FORM_FIELDS = {
            ending: 'entry.525974988',
            bear_appeared: 'entry.1343186601',
            dango: 'entry.1541264966'

        };

        function openFeedbackForm(endingId, meta = {}) {
            const f = (gameState?.main?.flags) || {};
            const mm = meta.mm || "00";
            const ss = meta.ss || "00";

            const endingLabel = (id => ({
                trueEnd: "ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰",
                trueEnd2: "ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰2",
                end: "ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰",
                end1969: 'ã‚¢ãƒãƒ­ã‚¨ãƒ³ãƒ‰',
                badEnd: "BAD END"
            }[id] || ""))(endingId);

            const bearLabel = f.wakeupBear ? "ç™»å ´ã—ãŸ" : "æœªç™»å ´";
            const dangoLabel = f.foundDango ? "GET" : "æœªå…¥æ‰‹";

            const params = new URLSearchParams();
            params.set("usp", "pp_url");

            // ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚‹é …ç›®ã ã‘è©°ã‚ã‚‹
            if (FORM_FIELDS.ending && endingLabel) params.set(FORM_FIELDS.ending, endingLabel);
            if (FORM_FIELDS.bear_appeared && bearLabel) params.set(FORM_FIELDS.bear_appeared, bearLabel);
            if (FORM_FIELDS.dango && dangoLabel) params.set(FORM_FIELDS.dango, dangoLabel);

            window.open(`${FEEDBACK_URL}?${params.toString()}`, "_blank", "noopener,noreferrer");
        }

        function talkToHintCharacter(roomId, charId) {
            // flagså–å¾—
            let flags = gameState[roomId].flags;
            // ã¾ã ã‚«ã‚¦ãƒ³ãƒˆç„¡ã‘ã‚Œã°åˆæœŸåŒ–
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
            flags.talkTo[charId]++;

            // ã‚»ãƒªãƒ•ãƒªã‚¹ãƒˆå–å¾—
            const messages = hintMessages[roomId][charId];
            if (roomId == 'main' && charId == 'bear' && flags.talkTo[charId] == 3) {
                gameState.main.flags.canRemovePoster = true;
            }
            // ç¯„å›²å¤–ãªã‚‰æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const idx = (flags.talkTo[charId] - 1) % messages.length;

            // è¡¨ç¤º
            updateMessage(messages[idx]);
        }

        // å¼•ãå‡ºã—ãƒ‘ã‚ºãƒ«ã‚’è¡¨ç¤º
        function showDrawer3Puzzle() {
            const modalContent = `
                <h3>ãƒ­ãƒƒã‚¯ãŒã‹ã‹ã£ã¦ã„ã‚‹</h3>
                <p>ğŸµğŸ°ğŸ¦Š</p>
                <input type="text" class="puzzle-input" id="drawer3Input" placeholder="æ•°å­—6æ¡">
                <br>
                <button onclick="checkDrawer3Puzzle()">ç¢ºèª</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // å¼•ãå‡ºã—ãƒ‘ã‚ºãƒ«ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkDrawer3Puzzle() {
            const v = document.getElementById('drawer3Input').value.trim();
            // å…¨è§’å¯¾ç­–
            const z2h = s => s.replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === '192918') {
                closeModal();
                gameState.main.flags.unlockDrawer3 = true;
                markProgress('drawer3_open');
                showModal(
                    'å¼•ãå‡ºã—ãŒé–‹ã„ãŸ',
                    '',
                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                );
                playSE('se-gacha');
                renderCanvasRoom();
                updateMessage('å¼•ãå‡ºã—ãŒé–‹ã„ãŸã€‚ä¸­ã‚’èª¿ã¹ã‚ˆã†');

            } else {
                playSE('se-error');
                updateMessage('ã¡ãŒã†ã‚ˆã†ã ');
            }
        }

        // ãƒ‰ã‚¢ãƒ‘ã‚ºãƒ«ã‚’è¡¨ç¤º
        function showDoorPuzzle() {
            const modalContent = `
                <h3>ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯</h3>
                <p>ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹ã¿ãŸã„</p>
                <p id="doormsg" style="color:red;"></p>
                <input type="text" class="puzzle-input" id="doorInput" placeholder="">
                <br>
                <button onclick="checkDoorPuzzle()">ç¢ºèª</button>
                <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ãƒ‰ã‚¢ãƒ‘ã‚ºãƒ«ã®ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkDoorPuzzle() {
            const input = document.getElementById('doorInput').value;
            const v = document.getElementById('doorInput').value.trim();
            // å…¨è§’å¯¾ç­–
            const z2h = s => s.replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            document.getElementById("doormsg").innerText = "";
            if (val === 'go2025') {
                closeModal();
                gameState.main.flags.unlockDoor = true;
                markProgress('door_open');
                showModal(
                    'ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸ',
                    '',
                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                );
                playSE('se-gacha');
                renderCanvasRoom();
                updateMessage('ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸã€‚ã•ã‚è„±å‡ºã—ã‚ˆã†');

            } else if (val === 'go2082' || val === '2082') {
                closeModal();
                gameState.main.flags.unlockDoor = true;
                gameState.main.flags.badEnd = true;
                markProgress('door_open');
                showModal(
                    'ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸ',
                    '',
                    [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                );
                playSE('se-gacha');
                renderCanvasRoom();
                updateMessage('ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸã€‚ã•ã‚è„±å‡ºã—ã‚ˆã†');

            } else if (val === 'go1071' || val === '1071') {
                if (gameState.main.flags.wakeupBear) {
                    closeModal();

                    gameState.flags.trueEndUnlocked = true;
                    gameState.main.flags.unlockDoor = true;
                    // æ¼”å‡ºâ†’ãƒˆã‚¥ãƒ«ãƒ¼ã¸
                    updateMessage('?');
                    startTimeWarp(1400, () => {
                        // changeRoom('trueEnd');
                        gameState.main.flags.backgroundState = 1;
                        updateMessage('ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸã®ã‹ãªï¼Ÿã•ã‚è„±å‡ºã—ã‚ˆã†');
                        renderCanvasRoom();
                    });

                    return;
                } else {
                    document.getElementById("doormsg").innerText = "ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ä¸åœ¨ã®ãŸã‚å®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸ";
                    playSE('se-error');
                    updateMessage('å®Ÿè¡Œã§ããªã„ã‚ˆã†ã ');
                }


            } else if (val === 'go1969' || val === '1969') {
                if (gameState.main.flags.wakeupBear) {
                    closeModal();

                    gameState.flags.apolloEnd = true;
                    gameState.main.flags.unlockDoor = true;
                    // æ¼”å‡ºâ†’ãƒˆã‚¥ãƒ«ãƒ¼ã¸
                    startTimeWarp(1400, () => {
                        // changeRoom('trueEnd');
                        gameState.main.flags.backgroundState = 1;
                        updateMessage('ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚ŒãŸã®ã‹ãªï¼Ÿã•ã‚è„±å‡ºã—ã‚ˆã†');
                        renderCanvasRoom();
                    });

                    return;
                } else {
                    document.getElementById("doormsg").innerText = "ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ä¸åœ¨ã®ãŸã‚å®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸ";
                    playSE('se-error');
                    updateMessage('å®Ÿè¡Œã§ããªã„ã‚ˆã†ã ');
                }


            } else if (val === 'odango' || val === 'ãŠã ã‚“ã”') {
                closeModal();
                playSE && playSE('se-fanta');
                updateMessage("ã‚¿ãƒ³ã‚¹ã®ä¸Šã«ãŠå›£å­ãŒå‡ºç¾ã—ãŸ");
                gameState.main.flags.dangoAppear = true;
                renderCanvasRoom();
                return;
            } else {
                playSE('se-error');
                updateMessage('ã¡ãŒã†ã‚ˆã†ã ');
            }
        }

        function checkBearAppear() {
            const g = gameState.drawerDigits;
            if (g.d1 === 2 && g.d2 === 4 && g.d3 === 9) {
                if (!gameState.main.flags.wakeupBear) {
                    gameState.main.flags.wakeupBear = true;
                    playSE && playSE('se-fanta');
                    showModal(
                        'ä½•ã‹ç‰©éŸ³ãŒã—ãŸ',
                        '',
                        [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                    );
                    renderCanvasRoom();
                }
            }
        }


        function handleDoor() {

            // åˆ†å²ï¼štrueEndUnlocked ãŒç«‹ã£ã¦ã„ã‚Œã°ãƒˆã‚¥ãƒ«ãƒ¼ENDã¸
            if (gameState.flags.trueEndUnlocked && hasItem('dango')) {
                gameState.endings.true = true;
                changeRoom('trueEnd2');
            } else if (gameState.flags.trueEndUnlocked) {
                gameState.endings.true = true;
                changeRoom('trueEnd');
            } else if (gameState.flags.apolloEnd) {
                changeRoom('end1969');
            } else if (gameState.main.flags.badEnd) {
                markProgress('badend_2082');
                showModal(
                    'BAD END\nã‚ãªãŸã¯çªç„¶å®‡å®™ç©ºé–“ã«æŠ•ã’å‡ºã•ã‚ŒãŸ',
                    `<img src="${IMAGES.modals.badend}" style="width:300px;display:block;margin:0 auto 20px;">`,
                    [{ text: 'æœ€åˆã‹ã‚‰', action: 'restart' }]
                );
                playSE?.('se-bad-space');
            } else {
                changeRoom('end');
            }
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 8) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }

        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}ã‚’é¸æŠã—ã¾ã—ãŸã€‚ä½¿ç”¨ã—ãŸã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay();
            }
        }

        function getItemName(itemId) {
            const names = {

                bear: 'ã‚¯ãƒå¦–ç²¾',
                key: 'ã‚«ã‚®',
                partDummy4: 'ï¼Ÿ',
                part4_1: 'ï¼Ÿ',
                part2_2: 'ï¼Ÿ',
                dango: 'ãŠå›£å­'


            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;
                btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªè¡¨ç¤ºæ›´æ–°
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function () {
                        // ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                    const magBtn = document.createElement('div');
                    magBtn.className = 'magnifier-btn';
                    magBtn.title = 'æ‹¡å¤§è¡¨ç¤º';
                    magBtn.innerHTML = '<img src="images/magnifier.png" alt="æ‹¡å¤§">';
                    magBtn.onclick = (e) => {
                        e.stopPropagation();

                        showModal(
                            getItemName(gameState.inventory[index]),
                            `<img src="${img.src}" style="max-width: 300px; max-height: 300px; width: auto; height: auto; object-fit: contain; display:block;margin:0 auto 16px;">`,
                            [{ text: 'é–‰ã˜ã‚‹', action: 'close' }]
                        );
                    };
                    slot.appendChild(magBtn);
                }
                // â˜…é¸æŠä¸­ãªã‚‰selectedã‚¯ãƒ©ã‚¹è¿½åŠ 
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
        function updateMessage(message) {
            //document.getElementById('messageArea').innerHTML = message;
            document.getElementById('msgText').textContent = message;
        }

        function updateMessageHTML(html) {
            const el = document.getElementById('msgText');
            el.innerHTML = html;
            el.querySelectorAll('a').forEach(a => {
                a.target = '_blank';
                a.rel = 'noopener';
                a.style.color = '#d4af37';
                a.style.textDecoration = 'underline';
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(title, content, buttons, onSequenceSuccess) {
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            if (buttons && buttons.length > 0) {
                modalHtml += `<div id="modalButtons" style="text-align:center;"></div>`;
                modalHtml += `<div id="modalClose" style="margin-top:25px;text-align:center;"></div>`;
            }
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';

            if (!buttons || buttons.length === 0) return;

            let pressed = [];
            let heartCnt = 0;
            let checkCnt = 0;
            let houseCnt = 0;

            // ç”»åƒ/é€šå¸¸ãƒœã‚¿ãƒ³ã¨closeãƒœã‚¿ãƒ³ã§åˆ†ã‘ã‚‹
            const modalButtons = document.getElementById('modalButtons');
            const modalClose = document.getElementById('modalClose');

            buttons.forEach((button, idx) => {
                // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã¯ä¸‹ã¸
                if (button.action === 'close') {
                    const btn = document.createElement('button');
                    btn.textContent = button.text || 'é–‰ã˜ã‚‹';
                    btn.className = 'modal-close-btn';
                    btn.onclick = function () {
                        closeModal();
                        if (typeof onSequenceSuccess === "function") {
                            onSequenceSuccess();
                        }
                    };
                    modalClose.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.style.margin = "0 10px 10px 0";
                    if (button.img) {
                        btn.innerHTML = `<img src="${button.img}" alt="${button.text || ''}" style="width:80px;height:80px;vertical-align:middle;">`;
                    } else {
                        btn.textContent = button.text;
                        btn.className = 'text-btn';
                    }
                    btn.onclick = function () {
                        if (button.action === 'restart') {
                            restartGame();
                        } else if (typeof button.action === "function") {
                            button.action();
                        } else if (typeof button.action === 'string') {
                            closeModal();
                            handleAreaClick(button.action);
                        }
                    };
                    modalButtons.appendChild(btn);
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // æ¬¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
            if (window._nextModal) {
                // ç™»éŒ²å†…å®¹ã¯ {title, content, buttons, after} ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                let modal = window._nextModal;
                window._nextModal = null; // ã‚¯ãƒªã‚¢
                if (modal.before) modal.before();
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after();
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
        function restartGame() {
            gameState = getDefaultGameState();
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;
        let isBGMInitialized = false; // åˆå›ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç”¨

        // åˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã ã‘BGMã‚’å†ç”Ÿ
        function initBGMOnce() {
            if (!isBGMInitialized) {
                const bgm = document.getElementById('bgm');
                bgm.volume = 0.2;
                bgm.play();
                isBGMPlaying = true;
                isBGMInitialized = true;
                document.getElementById('bgm-toggle').textContent = "ğŸ”Š BGM";
            }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "ğŸ”Š BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "ğŸ”‡ BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ã§æ¯”è¼ƒ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            if (current === next) return; // ã™ã§ã«ãã®BGMãªã‚‰ä½•ã‚‚ã—ãªã„

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // ã©ã“ã‹ã§æœ€åˆã«ä¸€åº¦ã ã‘å‘¼ã¶
        let loadedImages = {};
        function preloadImages() {
            // éƒ¨å±‹ç”»åƒ
            Object.values(IMAGES.rooms).forEach(val => {
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        if (!loadedImages[src]) {
                            const img = new Image();
                            img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                            img.src = src;
                            loadedImages[src] = img;



                        }
                    });
                } else if (typeof val === "string") {
                    if (!loadedImages[val]) {
                        const img = new Image();
                        img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                        img.src = val;
                        loadedImages[val] = img;
                    }
                }
            });
            // ã‚¢ã‚¤ãƒ†ãƒ ç”»åƒ
            Object.values(IMAGES.items).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒ
            Object.values(IMAGES.modals).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
        }

        /***** æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šç®¡ç†ç”¨ *****/
        let STAR_BURSTS = [];         // ç™ºç”Ÿä¸­ã®ãƒãƒ¼ã‚¹ãƒˆã®é…åˆ—
        let _starRaf = null;          // RAFãƒãƒ³ãƒ‰ãƒ«
        let _starLastT = 0;           // å‰ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚åˆ»

        // å‘¼ã³å‡ºã—ï¼šä»»æ„ã®åº§æ¨™ã«æ˜Ÿã‚’æ•£ã‚‰ã™
        // sparkleAt(x, y, { count, life, speed, spread, size, colors })
        function sparkleAt(x, y, opts = {}) {
            const now = performance.now();
            const burst = {
                x, y,
                start: now,
                particles: [],
                life: opts.life ?? 650,               // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¯¿å‘½(ms)
            };

            const count = opts.count ?? 14;       // ç²’ã®æ•°
            const speed = opts.speed ?? 140;      // åˆé€Ÿ(px/s)
            const spread = opts.spread ?? Math.PI;  // æ”¾å°„è§’ï¼ˆPI=180åº¦ï¼‰
            const size = opts.size ?? [2, 4];   // ç²’ã‚µã‚¤ã‚ºã®[min,max]
            const colors = opts.colors ?? ['#fff8b0', '#ffe26a', '#ffd04d', '#ffffff'];

            for (let i = 0; i < count; i++) {
                const ang0 = -Math.PI / 2;
                const ang = ang0 + (Math.random() - 0.5) * spread;
                const spd = speed * (0.7 + Math.random() * 0.6);
                const sz = size[0] + Math.random() * (size[1] - size[0]);
                const hue = colors[Math.floor(Math.random() * colors.length)];
                burst.particles.push({
                    x, y, vx: Math.cos(ang) * spd / 1000, vy: Math.sin(ang) * spd / 1000, // px/ms
                    size: sz,
                    rot: Math.random() * Math.PI * 2,
                    vr: (-1 + Math.random() * 2) * 0.02, // å›è»¢é€Ÿåº¦(rad/ms)
                    born: now,
                    life: burst.life * (0.6 + Math.random() * 0.6), // å„ç²’ã®å¯¿å‘½ã°ã‚‰ã¤ã
                    color: hue
                });
            }

            STAR_BURSTS.push(burst);
            _kickStarLoop();
        }

        // çŸ©å½¢ã®ä¸­å¿ƒã«æ•£ã‚‰ã™ï¼ˆå½“ãŸã‚Šåˆ¤å®šRectãªã©ã‹ã‚‰å‘¼ã¶ç”¨ï¼‰
        function sparkleAtRectCenter(rect, opts) {
            const cx = rect.x + rect.w / 2;
            const cy = rect.y + rect.h / 2;
            sparkleAt(cx, cy, opts);
        }

        /***** æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šãƒ«ãƒ¼ãƒ—ç®¡ç† *****/
        function _kickStarLoop() {
            if (_starRaf != null) return;
            _starLastT = performance.now();
            const step = (t) => {
                const dt = t - _starLastT;           // ms
                _starLastT = t;
                _maybeSpawnAmbient(t);
                _updateSparkles(dt);
                renderCanvasRoom();                  // æ—¢å­˜ã®æç”»ã‚’å†å‘¼ã³å‡ºã—
                if (STAR_BURSTS.length > 0 || AMBIENT_STARS.enabled) { // â˜… ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆæœ‰åŠ¹ãªã‚‰å›ã—ç¶šã‘ã‚‹
                    _starRaf = requestAnimationFrame(step);
                } else {
                    _starRaf = null;
                }
            };
            _starRaf = requestAnimationFrame(step);
        }

        // æ—¢å­˜ã® renderCanvasRoom ã®æœ«å°¾ã§å‘¼ã‚“ã§ã€Œä¸Šæãã€ã™ã‚‹
        function drawSparkles(ctx) {
            const now = performance.now();
            for (const b of STAR_BURSTS) {
                for (const p of b.particles) {
                    const age = now - p.born;
                    const a = 1 - Math.min(1, age / p.life);     // æ®‹ã‚Šå¯¿å‘½ã§ãƒ•ã‚§ãƒ¼ãƒ‰
                    if (a <= 0) continue;

                    ctx.save();
                    ctx.globalAlpha = a;
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rot);
                    _drawStarShape(ctx, 0, 0, p.size, p.color);
                    ctx.restore();
                }
            }
        }

        // ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°ï¼ˆä½ç½®ãƒ»å›è»¢ï¼‰
        function _updateSparkles(dt) {
            const now = performance.now();
            for (let i = STAR_BURSTS.length - 1; i >= 0; i--) {
                const b = STAR_BURSTS[i];
                let alive = false;
                for (const p of b.particles) {
                    const age = now - p.born;
                    if (age <= p.life) {
                        p.x += p.vx * dt;
                        p.y += p.vy * dt + 0.0006 * dt * dt; // ã»ã‚“ã®å°‘ã—é‡åŠ›é¢¨å‘³
                        p.vy += 0.0008 * dt;                 // ä¸‹å‘ãã«åŠ é€Ÿ
                        p.rot += p.vr * dt;
                        alive = true;
                    }
                }
                if (!alive) STAR_BURSTS.splice(i, 1);
            }
        }

        // æ˜Ÿå½¢ï¼ˆâœ¦ï¼‰ã‚’ãƒ‰ãƒ­ãƒ¼ï¼šå¤–åŠå¾„ r, å†…åŠå¾„ r*0.5
        function _drawStarShape(ctx, cx, cy, r, fill) {
            const spikes = 5;
            const step = Math.PI / spikes;
            const inner = r * 0.5;
            ctx.beginPath();
            ctx.moveTo(cx, cy - r);
            for (let i = 0; i < spikes; i++) {
                ctx.lineTo(cx + Math.cos((i * 2 + 1) * step) * inner, cy - Math.sin((i * 2 + 1) * step) * inner);
                ctx.lineTo(cx + Math.cos((i * 2 + 2) * step) * r, cy - Math.sin((i * 2 + 2) * step) * r);
            }
            ctx.closePath();
            ctx.fillStyle = fill;
            ctx.fill();
        }

        
        function saveGame() {
            const toSave = { ...gameState, __version: SAVE_VERSION };
            localStorage.setItem(SAVE_KEY, JSON.stringify(toSave));
            updateMessage('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼');
        }

        function loadGame() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) {
                updateMessage('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            const saved = JSON.parse(raw);

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ãƒãƒ¼ã‚¸ã—ã¦ä¸è¶³ã‚­ãƒ¼ã‚’è£œå®Œ
            const def = getDefaultGameState();
            const merged = deepMerge(def, saved);

            if (!Array.isArray(merged.openRooms)) merged.openRooms = def.openRooms.slice();
            if (!merged.currentRoom || !rooms[merged.currentRoom]) merged.currentRoom = def.currentRoom;

            gameState = merged;

            changeRoom(gameState.currentRoom);
            updateInventoryDisplay?.();
            renderNavigation?.();
            updateMessage('ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
        }


        function deepMerge(target, source) {
            if (source === undefined || source === null) return target;
            if (Array.isArray(source)) return source.slice();
            if (typeof source === 'object') {
                const out = (target && typeof target === 'object') ? { ...target } : {};
                for (const k of Object.keys(source)) {
                    out[k] = deepMerge(target ? target[k] : undefined, source[k]);
                }
                return out;
            }
            return source;
        }


        // ã‚²ãƒ¼ãƒ é–‹å§‹
        preloadImages();
        initGame();
    </script>
</body>

</html>