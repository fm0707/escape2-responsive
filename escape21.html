<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="„Éê„Éº„ÇíËàûÂè∞„Å´„Åó„ÅüÂàÜÂ≤ê„Ç®„É≥„Éâ‰ªò„Åç„ÅÆÁÑ°ÊñôËÑ±Âá∫„Ç≤„Éº„É†„ÄÇÂÖ®4„Ç®„É≥„Éâ„ÅÆ„Éû„É´„ÉÅ„Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÄÇ„Çπ„Éû„ÉõÔºÜPCÂØæÂøú„ÄÇ">
    <title>„Éê„Éº„Åã„Çâ„ÅÆËÑ±Âá∫</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            color: #f4f1e8;
            width: 100%;
            overflow-x: hidden;
            /* ‚Üê„Åì„ÇåÈáçË¶Å */
        }

        .game-container {
            width: 100%;
            max-width: 1408px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #gameCanvas {
            position: relative;
        }

        #endingShareArea {
            position: absolute;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 0 24px #fffc;
            padding: 18px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 99;
            font-size: 1.2em;
            gap: 10px;
            border: 2px solid gold;
        }

        #endingShareArea button {
            font-size: 1.1em;
            padding: 10px 24px;
            margin: 6px 0;
            background: gold;
            color: #333;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffdc;
            cursor: pointer;
        }

        .ui-panel {
            flex-wrap: wrap;
            width: 100%;
            max-width: 1048px;
            min-height: 120px;
            background: #2c1810;
            box-sizing: border-box;
            display: flex;
        }

        .inventory {
            /* flex: 1; */
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding: 0 12px;
            /* width:100%; */
        }

        .inventory-slot {
            width: 14vw;
            height: 14vw;
            max-width: 80px;
            max-height: 80px;
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border: 3px solid #9f2b02;
            /* ÈáëËâ≤„ÉªÂ§™„ÇÅÊé®Â•® */
            box-shadow: 0 0 12px #ff8c0099;
            background: rgba(255, 215, 0, 0.15);
        }

        .inventory-slot img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .magnifier-btn {
            position: absolute;
            right: 4px;
            bottom: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d4af37;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0002;
            cursor: pointer;
            z-index: 10;
            transition: box-shadow .15s;
        }

        .magnifier-btn:hover {
            box-shadow: 0 0 10px #ffd70099;
        }

        .magnifier-btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }

        .info-panel {
            width: 100%;
            padding: 2px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 2px;
            height: 65px;
            min-height: 40px;
            border: 1px solid #d4af37;
            position: relative;
        }

        #msgText {}

        #statusIconArea {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .status-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid gold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px #0005;
            font-size: 1.4em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f, #d4af37);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #1a0f08);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            max-width: calc(100vw - 60px);
            text-align: center;
        }

        .modal button {
            margin: 10px;
            padding: 10px 20px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            color: #1a0f08;
            cursor: pointer;
            font-weight: bold;
        }

        #modalButtons button {
            border: none;
            background: none;
            padding: 0;
            margin: 0 10px 10px 0;
            cursor: pointer;
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
            border-radius: 10px;
        }

        #modalButtons button img {
            width: 80px;
            height: 80px;
            vertical-align: middle;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: filter 0.1s, box-shadow 0.1s, transform 0.08s;
        }

        #modalButtons button:hover img {
            filter: brightness(1.08) drop-shadow(0 2px 6px #ffd70050);
            box-shadow: 0 0 10px #ffd70080;
            transform: scale(1.05);
        }

        #modalButtons button:active img,
        #modalButtons button.pressed img {
            filter: brightness(0.95) grayscale(20%);
            box-shadow: 0 0 8px #3332;
            transform: scale(0.97);
        }

        #modalButtons button:disabled img {
            filter: grayscale(90%) opacity(0.5);
            box-shadow: none;
        }

        /* „ÉÜ„Ç≠„Çπ„ÉàÂûã„Éú„Çø„É≥„ÇÇÁîªÂÉè„Éú„Çø„É≥È¢®„Å´ */
        #modalButtons button.text-btn {
            min-width: 120px;
            font-size: 1.15em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            margin: 0 10px 10px 0;
            box-shadow: 0 4px 14px #ffc90022;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s, transform 0.08s;
            vertical-align: middle;
            display: inline-block;
        }

        #modalButtons button.text-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
            transform: scale(1.05);
        }

        #modalButtons button.text-btn:active {
            filter: brightness(0.96);
            transform: scale(0.97);
        }

        #modalButtons button.text-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Èñâ„Åò„Çã„Éú„Çø„É≥ */
        #modalClose .modal-close-btn {
            display: inline-block;
            min-width: 160px;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
            color: #7b4a00;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            padding: 15px 32px;
            box-shadow: 0 4px 14px #ffc90022;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.12s, filter 0.1s, box-shadow 0.1s;
        }

        #modalClose .modal-close-btn:hover {
            background: linear-gradient(90deg, #ffea85 0%, #ffc371 100%);
            filter: brightness(1.08);
            box-shadow: 0 6px 20px #ffc90055;
        }

        .puzzle-input {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #d4af37;
            background: rgba(244, 241, 232, 0.9);
            color: #1a0f08;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .title {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 8px;
            border: 2px solid #d4af37;
            border-radius: 25px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }

        .login-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            color: #fff;
            width: 280px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            font-family: 'Segoe UI', sans-serif;
        }

        .login-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .login-form label {
            font-size: 14px;
            margin-top: 8px;
            display: block;
        }

        .login-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .login-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ÁîªÂÉè„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .image-placeholder {
            background: linear-gradient(135deg, #444, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 5px;
        }

        .notice {
            text-overflow: clip;
        }

        .save-area {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 18px 0 4px 0;
            /* width: 40%; */
        }

        @media (max-width: 600px) {
            #msgText {
                font-size: .8rem;
            }

            .save-area {
                width: 100%;
                max-width: 100%;
                margin-left: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                gap: 16px;
            }

            .inventory {
                gap: 16px;
                align-items: center;
                padding: 0 2px;
                width: 100%;
            }
        }

        .save-area .nav-btn {
            min-width: 80px;
            padding: 10px 18px;
            font-size: 15px;
            background: linear-gradient(135deg, #d4af37 85%, #b8941f 100%);
            border-radius: 8px;
            border: none;
            color: #1a0f08;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
            transition: background 0.3s, transform 0.2s;
        }

        .save-area .nav-btn:hover {
            background: linear-gradient(135deg, #b8941f 70%, #d4af37 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 12px #d4af3740;
        }

        #roomEffectOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s;
            z-index: 9999;
        }

        .title-wrapper {
            display: flex;
            width: 100%;
        }

        @keyframes warpFlash {
            0% {
                opacity: 0
            }

            15% {
                opacity: .95
            }

            50% {
                opacity: .4
            }

            100% {
                opacity: 0
            }
        }

        @keyframes chroma {
            0% {
                filter: none
            }

            100% {
                filter: contrast(1.2) saturate(1.2) hue-rotate(20deg)
            }
        }

        .warp-active {
            background: radial-gradient(circle at 50% 50%, #fff, #000 70%);
            animation: warpFlash 900ms ease-out both, chroma 900ms ease-out both;
        }

        #hintModal {
            color: #000;
        }

        @keyframes glowPulse {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            60% {
                opacity: 0.9;
            }

            100% {
                opacity: 0;
            }

            /* Ëá™Âãï„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà */
        }


        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, .45);
            }

            50% {
                box-shadow: 0 0 18px 6px rgba(255, 255, 255, .35);
            }
        }



        /* ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Áî®„ÅÆÂÖ®ÁîªÈù¢„É¨„Ç§„É§ */
        #fxFlash {
            position: fixed;
            inset: 0;
            background: transparent;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
        }

        /* ÁôΩ„Éï„É©„ÉÉ„Ç∑„É• */
        @keyframes flashWhite {
            0% {
                opacity: 0;
                background: #fff;
            }

            12% {
                opacity: .95;
                background: #fff;
            }

            100% {
                opacity: 0;
                background: #fff;
            }
        }

        /* Ëµ§„Éï„É©„ÉÉ„Ç∑„É•Ôºà„Éü„ÇπÔºâ */
        @keyframes flashRed {
            0% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }

            18% {
                opacity: .85;
                background: rgba(255, 0, 0, 0.85);
            }

            100% {
                opacity: 0;
                background: rgba(255, 0, 0, 0.0);
            }
        }

        /* „Åª„Çì„ÅÆÂ∞ë„Åó„Ç´„É°„É©„Ç∑„Çß„Ç§„ÇØÔºàÂ•Ω„Åø„ÅßÔºâ */
        @keyframes camShake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, -1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, 1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .fx-shake {
            animation: camShake 120ms ease;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .casefile-modal {
            background-color: #f6f2e8;
            color: #2c2c2c;
            width: 80%;
            max-width: 720px;
            max-height: 85vh;
            border: 2px solid #bba;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .casefile-scroll {
            padding: 24px;
            overflow-y: auto;
            max-height: 80vh;
            font-family: "Noto Serif JP", "Times New Roman", serif;
            line-height: 1.6;
        }

        .casefile-modal h1,
        .casefile-modal h2 {
            text-align: center;
            margin-bottom: 8px;
        }

        .casefile-modal h3 {
            margin-top: 20px;
            border-bottom: 1px solid #999;
        }

        .person {
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-left: 3px solid #b44;
        }

        .initial-f {
            font-weight: 900;
            color: #c9a43d;
            /* gold */
            font-size: 1.55em;
            /* margin-left: 6px; */
        }

        .initial-l {
            font-weight: 900;
            color: #8c8fa1;
            /* silver/steel */
            font-size: 1.55em;
            /* margin-left: 4px; */
        }


        .evidence {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .evidence th,
        .evidence td {
            border: 1px solid #bbb;
            padding: 6px 8px;
        }

        blockquote {
            font-style: italic;
            color: #444;
            border-left: 4px solid #888;
            padding-left: 10px;
            margin: 10px 0;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.4rem;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }

        .group {
            width: 90%;
            justify-content: center;
            display: flex;
            gap: 8px;
            align-items: center
        }


        @keyframes breathe {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(2px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .modal-content {
            max-width: min(96vw, 640px);
            max-height: calc(100vh - 64px);
            /* ÁîªÈù¢„Å´Âèé„ÇÅ„Çã */
            overflow: auto;
            /* „ÅØ„ÅøÂá∫„Åó„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´ */
            padding: 20px;
            /* „Å°„Çá„ÅÑÂúßÁ∏Æ */
        }

        /* „É¢„Éº„ÉÄ„É´„ÅÆÁîªÂÉè„Éú„Çø„É≥„ÅØÂõ∫ÂÆö80px‚ÜíÂèØÂ§â„Å´ */
        #modalButtons button img {
            width: clamp(56px, 18vw, 96px);
            height: clamp(56px, 18vw, 96px);
        }





        /* „ÇØ„É™„ÉÉ„ÇØ„ÅØ„É°„Ç§„É≥„Å∏ÈÄö„Åô */
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F2G9BX4FBF"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-F2G9BX4FBF');
</script>

<body>
    <!-- ‚ñº „É¢„Éº„ÉÄ„É´ÂÖ®‰Ωì -->
    <div class="modal-overlay" style="display:none;">
        <div class="casefile-modal">
            <button class="close-btn">√ó</button>

        </div>
    </div>

    <div id="roomEffectOverlay"></div>
    <div class="game-container">
        <div class="title-wrapper">
            <!-- <div class="title">„Éê„Éº„Åã„Çâ„ÅÆËÑ±Âá∫</div> -->
            <div style="margin:0 0; text-align:center;">
                <a href="escape21_hint.html" target="_blank"
                    style="color:#d4af37; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                    üîç „Éí„É≥„Éà„ÇíË¶ã„Çã
                </a>

            </div>
        </div>

        <canvas id="gameCanvas" width="640" height="640" style="width: 90vw; max-width: 640px;"></canvas>


        <div class="ui-panel">
            <div class="info-panel">
                <div class="message-area" id="messageArea">
                    <span id="msgText">Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØ„Éê„Éº„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ</span>
                    <div id="statusIconArea" style="position:absolute; bottom:6px; right:12px; display:flex; gap:8px;">
                    </div>
                </div>
                <div class="navigation">

                </div>
            </div>
            <div class="inventory" id="inventory">
                <div class="inventory-slot" onclick="useItem(0)"></div>
                <div class="inventory-slot" onclick="useItem(1)"></div>
                <div class="inventory-slot" onclick="useItem(2)"></div>
                <div class="inventory-slot" onclick="useItem(3)"></div>
                <div class="inventory-slot" onclick="useItem(4)"></div>
                <div class="inventory-slot" onclick="useItem(5)"></div>
                <div class="inventory-slot" onclick="useItem(6)"></div>
            </div>
            <button id="bgm-toggle" onclick="toggleBGM()" style="position:absolute;top:20px;right:20px;z-index:1000;">
                üîä BGM
            </button>
            <div class="save-area">
                <button class="nav-btn" onclick="saveGame()">„Çª„Éº„Éñ</button>
                <button class="nav-btn" onclick="loadGame()">„É≠„Éº„Éâ</button>
            </div>
        </div>
        <div class="notice">ÂΩì„Çµ„Ç§„Éà„ÅÆÈü≥Ê∫ê„ÅØ<a href="https://otologic.jp/" target="blank">OtoLogic</a>,<a
                href="https://dova-s.jp/" target="blank">DOVA-SYNDROME</a>„ÅÆÁ¥†Êùê„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô ‰ΩúËÄÖ:<a href="index.html">„Çπ„É©„Çª„Éñ„É≥</a>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„ÅØÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
    </div>

    <audio id="bgm" src="sounds/20/Three_Pyramids.mp3" loop></audio>
    <audio id="se-click" src="sounds/Short_Accent18-1(Dry).mp3"></audio>
    <audio id="se-item" src="sounds/Inspiration02-1(High).mp3"></audio>
    <audio id="se-error" src="sounds/Quiz-Buzzer05-1(Mid).mp3"></audio>
    <audio id="se-clear" src="sounds/common/Cyber03-1.mp3"></audio>
    <audio id="se-change" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-open" src="sounds/common/Short_Accent09-1(Dry).mp3"></audio>
    <audio id="se-fanta" src="sounds/common/Scene-Fantasize03-3(Fast-Short).mp3"></audio>
    <audio id="se-coin" src="sounds/common/Onoma-Ding01-1(Dry).mp3"></audio>
    <audio id="se-scene-change" src="sounds/common/Scene_Change08-1(Delay-Fast).mp3"></audio>
    <audio id="se-gacha" src="sounds/common/Retro_Anime-Switch02-3(Low).mp3"></audio>
    <audio id="se-gaan" src="sounds/common/gaan.mp3"></audio>
    <audio id="se-gao" src="sounds/common/gao.mp3"></audio>

    <audio id="se-god" src="sounds/common/Scene_Change01-1(Up).mp3"></audio>
    <audio id="se-grab" src="sounds/common/Motion-Grab07-1(Dry).mp3"></audio>
    <audio id="se-gun" src="sounds/common/gun.mp3"></audio>
    <audio id="se-badend" src="sounds/common/sekaino_owari.mp3"></audio>

    <audio id="se-angel" src="sounds/Angel01-1.mp3"></audio>
    <audio id="se-up" src="sounds/common/Inspiration10-1(High).mp3"></audio>
    <audio id="se-gogogo" src="sounds/common/gogogo.mp3"></audio>
    <audio id="se-ashioto" src="sounds/common/NES-RPG02-01(Enter).mp3"></audio>
    <audio id="se-kirakira" src="sounds/common/kirakira.mp3"></audio>
    <audio id="se-negative" src="sounds/common/Onoma-Negative06-1(Delay).mp3"></audio>
    <audio id="se-cat" src="sounds/common/cat.mp3"></audio>
    <audio id="se-piyo" src="sounds/21/piyo.wav"></audio>
    <audio id="se-pipipiyo" src="sounds/21/pipipiyo.wav"></audio>
    <audio id="se-record" src="sounds/21/keitodama.mp3"></audio>
    <audio id="se-fire" src="sounds/common/fire.mp3"></audio>

    <script>
        // --- Analytics helper ---
        window.ANA = {
            start: Date.now(),
            hintCount: 0,
            send(ev, params = {}) { try { gtag('event', ev, params); } catch (e) { } }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const a = document.querySelector('a[href*="_hint.html"]');
            if (a) {
                a.addEventListener('click', () => {
                    ANA.hintCount++;
                    ANA.send('open_hint', { count: ANA.hintCount });
                });
            }
        });

        window.ANA = Object.assign(window.ANA || {}, {
            sid: Math.random().toString(36).slice(2),
            sent: new Set(),
            baseParams() {
                return {
                    elapsed_sec: Math.round((Date.now() - this.start) / 1000),
                    hints: this.hintCount || 0,
                    save_version: (typeof SAVE_VERSION === 'number' ? SAVE_VERSION : null),
                    room: (window.gameState && gameState.currentRoom) || null,
                    sid: this.sid,
                };
            },
            once(ev, key = '', params = {}) {
                const k = `${ev}:${key}`;
                if (this.sent.has(k)) return;
                this.sent.add(k);
                this.send(ev, { ...this.baseParams(), ...params });
            }
        });

        // Ê±éÁî®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÄÅ‰ø°Áî®„Éò„É´„Éë
        function markProgress(step, extra = {}) {
            ANA.once('progress', step, { step, ...extra });
        }


        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.querySelector(".modal-overlay");
            const openBtn = document.querySelector("#open-casefile");
            const closeBtn = document.querySelector(".close-btn");

            // ÂàùÊúüÁä∂ÊÖã„ÅßÈùûË°®Á§∫
            modal.style.display = "none";

            // Èñã„Åè
            openBtn?.addEventListener("click", () => {
                modal.style.display = "flex";
            });

            // Èñâ„Åò„Çã
            closeBtn?.addEventListener("click", () => {
                modal.style.display = "none";
            });

            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇÈñâ„Åò„Çã
            modal.addEventListener("click", (e) => {
                if (e.target === modal) modal.style.display = "none";
            });
        });



        window._nextModal = null;
        const canvas = document.getElementById('gameCanvas');
        let DEV_MODE = false;
        // „Ç≤„Éº„É†Ë®≠ÂÆö - ÁîªÂÉè„Éë„Çπ„Çí„Åì„Åì„ÅßÁÆ°ÁêÜ
        let IMAGES = {
            rooms: {
                door: ['images/21/door.png'],
                record: [
                    'images/21/record.png',   // ÈÄöÂ∏∏
                    'images/21/record2.png',  // ÂõûËª¢ÈÄî‰∏≠1
                    'images/21/record3.png',   // ÂõûËª¢ÈÄî‰∏≠2
                    'images/21/record_a.png',   // ÈÄöÂ∏∏
                    'images/21/record2.png',  // ÂõûËª¢ÈÄî‰∏≠1
                    'images/21/record3.png',   // ÂõûËª¢ÈÄî‰∏≠2
                    'images/21/record_m.png',   // ÈÄöÂ∏∏
                    'images/21/record2.png',  // ÂõûËª¢ÈÄî‰∏≠1
                    'images/21/record3.png',   // ÂõûËª¢ÈÄî‰∏≠2
                    'images/21/record_b.png',   // ÈÄöÂ∏∏
                    'images/21/record2.png',  // ÂõûËª¢ÈÄî‰∏≠1
                    'images/21/record3.png',   // ÂõûËª¢ÈÄî‰∏≠2
                    'images/21/record_e.png',   // ÈÄöÂ∏∏
                    'images/21/record2.png',  // ÂõûËª¢ÈÄî‰∏≠1
                    'images/21/record3.png',   // ÂõûËª¢ÈÄî‰∏≠2
                    'images/21/record_r.png',   // ÈÄöÂ∏∏
                    'images/21/record2.png',  // ÂõûËª¢ÈÄî‰∏≠1
                    'images/21/record3.png'   // ÂõûËª¢ÈÄî‰∏≠2
                ],
                recordTime: [
                    'images/21/record_time.png',   // ÈÄöÂ∏∏
                    'images/21/record_time2.png',  // ÂõûËª¢ÈÄî‰∏≠1
                    'images/21/record_time3.png',   // ÂõûËª¢ÈÄî‰∏≠2
                    'images/21/record_time4.png',   // ÈÄöÂ∏∏
                    'images/21/record_time5.png',  // ÂõûËª¢ÈÄî‰∏≠1
                    'images/21/record_time6.png',   // ÂõûËª¢ÈÄî‰∏≠2

                ],
                drawer1: ['images/21/drawer_inner.png'],
                drawer2: ['images/21/drawer_inner.png'],
                counter: ['images/21/counter.png'],
                cabinet: ['images/21/cabinet.png'],
                cabinetInner: ['images/21/cabinet_inner.png'],
                brickWall: ['images/21/brick_wall.png', 'images/21/brick_wall2.png'],
                sideboardLeft: ['images/21/cabinet_inner.png'],
                sideboardRight: ['images/21/cabinet_inner_right.png'],
                corridor: ['images/21/corridor.jpeg'],

                vipRoom: ['images/21/vip_room.png', 'images/21/vip_room_wine.png', 'images/21/vip_room2.png'],
                secretRoom: ['images/21/secret_room.jpeg'],
                storage: ['images/21/storage_close.png', 'images/21/storage_open.png'],
                drinkCabinetInner: ['images/21/drink_cabinet_inner.png'],

                nowDoor: ['images/21/now_door.png', 'images/21/now_door2.png'],
                nowCounter: ['images/21/now_counter.png'],

                trueNowDoor: ['images/21/true_now_door.jpeg'],
                trueNowCounter: ['images/21/true_now_counter.jpeg'],

                end: ['images/21/end.png'],
                // end2: ['images/21/end2.png'],
                trueEnd: ['images/21/true_end.png'],
                trueEndPlus: ['images/21/true_end_plus.jpeg'],



            },
            items: {
                coin: 'images/bear_coin.png',
                bear: 'images/21/bear_white.png',
                back: 'images/common/back.png',
                arrowRight: 'images/common/arrow_right.png',
                arrowLeft: 'images/common/arrow_left.png',
                arrowAbove: 'images/common/arrow_above.png',
                redBack: 'images/common/red_back.png',
                greenBack: 'images/common/green_back.png',
                blueBack: 'images/common/blue_back.png',
                blackBack: 'images/common/black_back.png',
                lockCabinet: 'images/21/lock_red.png',
                nowLock: 'images/21/now_lock.png',
                recordDefault: 'images/21/item_record_default.png',
                recordTime: 'images/21/item_record_time.png',
                picXmas: 'images/21/pic_xmas.png',
                posterClose: 'images/21/poster_close.jpeg',
                piyoNormal: 'images/21/piyo_normal.png',
                piyoUpset: 'images/21/piyo_upset.png',
                keySideboard: 'images/21/key_sideboard.png',
                key: 'images/21/key.png',
                redwine: 'images/21/redwine.png',
                conversion: 'images/21/conversion.png',
                glass: 'images/21/glass.png',
                glassFill: 'images/21/glass_fill.png',
                glassFillFalse: 'images/21/glass_fill.png',
                croco: 'images/21/croco.png',
                decanter: 'images/21/decanter.png',
                can: 'images/21/can.png',
                sandwich: 'images/21/sandwich.png',
                finalSyrup: 'images/21/final_syrup.png',
                citrus: 'images/21/citrus.png',
                memo: 'images/21/modal_memo.png',
                stick: 'images/21/stick.png',
                pic1: 'images/21/pic1.png',
                pic2: 'images/21/pic2.png',
                pic3: 'images/21/pic3.png',
                posterBear: 'images/21/poster_bear.png',
                handover: 'images/21/handover.png',
                elixir: 'images/21/elixir.png',
                elixirModern: 'images/21/elixir_modern.png',
                elixirPut: 'images/21/elixir_put.png',
                bearBack: 'images/21/bear_back.png',
                statue: 'images/21/statue.png',
                newspaper: 'images/21/newspaper.png',
                posterWani: 'images/21/poster_wani.png'


            },

            modals: {
                piyoUpset: 'images/21/modal_piyo_upset.png',
                piyoWine: 'images/21/modal_piyo_wine.png',
                piyoQuestion: 'images/21/modal_piyo_question.png',
                piyoCabinet: 'images/21/modal_piyo_cabinet.png',
                piyoTuna: 'images/21/modal_piyo_tuna.png',
                piyoSandwich: 'images/21/modal_piyo_sandwich.png',
                piyoGone: 'images/21/modal_piyo_gone.png',
                catsWine: 'images/21/modal_cats_wine.png',
                catsQuestion: 'images/21/modal_cats_question.png',
                catsSandwich: 'images/21/modal_cats_sandwich.png',
                catsBye: 'images/21/modal_cats_bye.png',
                crocoHoney: 'images/21/modal_croco_moonhoney.png',
                menu: 'images/21/modal_menu.png',
                posterBird: 'images/21/modal_poster_bird.png',
                displayShelf: 'images/21/modal_display_shelf.png',
                dustbox: 'images/21/modal_dustbox.png',
                glassDoor: 'images/21/modal_glass_door.png',

                bearDrink: 'images/21/modal_bear_drink.png',
                crocoDrinkTrue: 'images/21/modal_croco_drink_true.png',
                crocoDrinkFalse: 'images/21/modal_croco_drink_false.png',
                goneCroco: 'images/21/modal_croco_gone.png',
                goneCrocoGood: 'images/21/modal_croco_gone_good.png',
                cabinetImg: 'images/21/modal_cabinet_color.png',
                memo: 'images/21/modal_memo.png',
                bearSurprized: 'images/21/modal_bear_surprize.png',
                bearElixir: 'images/21/modal_bear_elixir.png',
                userVoice: 'images/21/user_voice.png',
                randing: 'images/21/tablet_img.png',
                randingCoupon: 'images/21/tablet_coupon_img.png',

                badendBear: 'images/21/modal_bear_badend.png',
                badendBearGun: 'images/21/modal_bear_gun.png',
                // badEnd: 'images/21/badend.jpeg',
            },
        };


        // „Ç≤„Éº„É†Áä∂ÊÖã
        const SAVE_KEY = 'escapeGameState21';
        const SAVE_VERSION = 1;
        const SAVE_KEYS = [
            SAVE_KEY + '_1',
            SAVE_KEY + '_2'
        ];

        // Êóß1„Çπ„É≠„ÉÉ„Éà„Çª„Éº„Éñ„Åå„ÅÇ„Çå„Å∞„ÄÅËá™Âãï„Åß„Çπ„É≠„ÉÉ„Éà1„Å´ÁßªË°å
        (function migrateOldSave() {
            try {
                const old = localStorage.getItem(SAVE_KEY);
                const slot1 = localStorage.getItem(SAVE_KEYS[0]);
                if (old && !slot1) {
                    localStorage.setItem(SAVE_KEYS[0], old);
                    // ÂøÖË¶Å„Å™„ÇâÂè§„ÅÑ„Ç≠„Éº„ÅØÊ∂à„Åó„Å¶„ÇÇOK
                    // localStorage.removeItem(SAVE_KEY);
                    console.log('Êóß„Çª„Éº„Éñ„Éá„Éº„Çø„Çí„Çπ„É≠„ÉÉ„Éà1„Å´ÁßªË°å„Åó„Åæ„Åó„Åü');
                }
            } catch (e) {
                console.warn('„Çª„Éº„Éñ„Éá„Éº„ÇøÁßªË°å„Å´Â§±Êïó', e);
            }
        })();

        function getDefaultGameState() {
            return {
                currentRoom: 'door',
                openRooms: ['door'],
                openRoomsTmp: [],
                inventory: [],
                main: {
                    flags: {
                        unlockDrawer1: false, unlockDrawer2: false, unlockSideboardLeft: false, unlockSideboardRight: false,
                        unlockSideboardCenterBottom: false, unlockSideboardCenterTop: false, unlockDrinkCabinet: false,
                        unlockVipRoomDoor: false, unlockCabinet: false,
                        unlockSecretRoom: false,
                        foundRecordDefault: false, foundRecordTime: false, foundSideboardKey: false, foundKey: false,
                        foundPic1: false, foundPic2: false, foundPic3: false, setPic: false,
                        goneCats: false, goneCroco: false, gonePiyo: false,
                        foundGlass: false, foundDecanter: false, foundCan: false, foundGlassFill: false, foundGlassFillFalse: false,
                        talkToCroco: false,
                        picComplete: false,
                        recordStatus: 0, //0:Êú™„Çª„ÉÉ„Éà,1:default,2:time
                        piyoStatus: 0,
                        unlockNowDoor: false, unlockTablet: false, usableCoupon: false,

                        serveToVipRoomDrink: false, serveToVipRoomFood: false, gotSandwich: false, gotMoonHoney: false,
                        foundCitrus: false, foundSyrup: false, foundMemo: false, foundStick: false,
                        passMaterialToBear: false, gotElixir: false, putElixir: false,

                        talkTo: { bear: 0 }, backgroundState: 0,
                    }
                },
                record: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                recordTime: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                vipRoom: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                nowDoor: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                brickWall: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                storage: {
                    flags: {
                        backgroundState: 0,
                    }
                },
                trueEnd: {
                    flags: {
                        backgroundState: 0,
                    }
                },

                flags: { trueEndUnlocked: false },
                selectedItem: null,
                endings: { true: false, normal2: false, normal: false }

            };
        }

        let gameState = getDefaultGameState();




        // ÈÉ®Â±ã„Éá„Éº„Çø
        let rooms = {
            door: {
                name: '„Éê„Éº',
                description: '„Éâ„Ç¢„Åå„ÅÇ„Çã',
                clickableAreas: [
                    {
                        x: 37.6, y: 35.5, width: 26.0, height: 57.8,
                        onClick() {
                            updateMessage('ÂêàË®ÄËëâ„ÅåÂàÜ„Åã„Çâ„Å™„ÅÑ„Å®„Éâ„Ç¢„ÅåÈñã„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');
                        },
                        description: '„Éâ„Ç¢',

                    },
                    {
                        x: 32.8, y: 10.5, width: 35.0, height: 19.6,
                        onClick() {
                            updateMessage('Êâá„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢„ÅÆÈ£æ„Çä„Å†');
                        },
                        description: '„Éâ„Ç¢‰∏ä„ÅÆÈ£æ„Çä',
                    },
                    {
                        x: 68.9, y: 50.9, width: 21.3, height: 19.4,
                        onClick() {
                            updateMessage('„Åì„Åì„Åã„ÇâÈü≥„Åå„Åß„Çã„Çà„ÅÜ„Å†');

                        },
                        description: 'ËìÑÈü≥Ê©ü„ÅÆ„É©„ÉÉ„ÉëÈÉ®ÂàÜ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 73.4, y: 74.0, width: 17.1, height: 8.2,
                        onClick() {
                            if (gameState.selectedItem === 'recordTime') {
                                showModal(
                                    '„É¨„Ç≥„Éº„Éâ„ÇíÂÖ•„ÇåÊõø„Åà„Åü',
                                    '',
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                                removeItem('recordTime');
                                addItem('recordDefault');
                                gameState.main.flags.recordStatus = 2;
                                updateMessage('„É¨„Ç≥„Éº„Éâ„ÇíÂÖ•„ÇåÊõø„Åà„Åü„ÄÇ‰ªä„ÅØÊ®°ÊßòÂÖ•„Çä„ÅÆ„É¨„Ç≥„Éº„Éâ„Åå„Çª„ÉÉ„Éà„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ');

                            } else if (gameState.selectedItem === 'recordDefault') {
                                let msg;
                                if (gameState.main.flags.recordStatus == 0) {
                                    msg = '„É¨„Ç≥„Éº„Éâ„Çí„Çª„ÉÉ„Éà„Åó„Åü„ÄÇ';
                                } else {
                                    addItem('recordTime');
                                    msg = '„É¨„Ç≥„Éº„Éâ„ÇíÂÖ•„ÇåÊõø„Åà„Åü„ÄÇ'
                                }
                                showModal(
                                    msg,
                                    '',
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                                removeItem('recordDefault');

                                gameState.main.flags.recordStatus = 1;
                                updateMessage(`${msg}‰ªä„ÅØÁÑ°Âú∞„ÅÆ„É¨„Ç≥„Éº„Éâ„Åå„Çª„ÉÉ„Éà„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ`);


                            } else {
                                if (gameState.main.flags.recordStatus == 1) {
                                    changeRoom('record');
                                } else if (gameState.main.flags.recordStatus == 2) {
                                    changeRoom('recordTime');
                                } else {
                                    updateMessage('„É¨„Ç≥„Éº„Éâ„Åå„Çª„ÉÉ„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ');
                                }
                            }

                        },
                        description: 'ËìÑÈü≥Ê©üÊú¨‰Ωì',

                    },
                    {
                        x: 73.5, y: 84.6, width: 13.5, height: 4.2,
                        onClick() {
                            if (gameState.main.flags.unlockDrawer1) {
                                acquireItemOnce('foundSideboardKey', 'keySideboard', 'Èçµ„ÇíÊâã„Å´ÂÖ•„Çå„Åü', IMAGES.items.keySideboard, 'Èçµ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                            } else {
                                showDrawer1Puzzle();
                            }

                        },
                        description: 'Âºï„ÅçÂá∫„Åó‰∏ä',

                    },
                    {
                        x: 73.5, y: 89.6, width: 13.5, height: 4.8,
                        onClick() {
                            showDrawer2Puzzle();

                        },
                        description: 'Âºï„ÅçÂá∫„Åó‰∏ã',

                    },
                    {
                        x: 20.3, y: 68.7, width: 9.3, height: 27.0,
                        onClick() {
                            updateMessage('ÂÇòÁ´ã„Å¶„Å†');
                        },
                        description: 'ÂÇòÁ´ã„Å¶',

                    },
                    {
                        x: 74.4, y: 17.8, width: 10.5, height: 9.0,
                        onClick() {
                            updateMessage('Â§©‰∫ïÁÖßÊòé„Å†');
                        },
                        description: 'Â§©‰∫ïÁÖßÊòéÂè≥',

                    },
                    {
                        x: 17.6, y: 16.9, width: 9.5, height: 9.9,
                        onClick() {
                            updateMessage('Â§©‰∫ïÁÖßÊòé„Å†');
                        },
                        description: 'Â§©‰∫ïÁÖßÊòéÂ∑¶',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 77.1, y: 39.1, width: 6.5, height: 5.7,
                        onClick() {
                            updateMessage('ÁÖßÊòé„Å†');
                        },
                        description: 'Â£ÅÁÖßÊòéÂè≥',

                    },
                    {
                        x: 17.4, y: 39.1, width: 6.6, height: 5.6,
                        onClick() {
                            updateMessage('ÁÖßÊòé„Å†');
                        },
                        description: 'Â£ÅÁÖßÊòéÂ∑¶',

                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('counter');
                        },
                        description: '„Éâ„Ç¢Èù¢ÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('corridor');
                        },
                        description: '„Éâ„Ç¢Èù¢ÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            counter: {
                name: '„Éê„Éº',
                description: '',
                clickableAreas: [
                    {
                        x: 31.6, y: 61.6, width: 17.2, height: 15.9,
                        onClick() {
                            showPiyoPuzzle();
                            updateMessage('„Éê„Éº„ÉÜ„É≥„ÉÄ„Éº„Äå„Éî„É®„Äç„ÅØÂõ∞„Å£„Å¶„ÅÑ„Çã');
                        },
                        description: '„Å¥„ÇàÁÑ¶„Çä',
                        zIndex: 5,
                        usable: () => gameState.main.flags.piyoStatus == 0,
                        item: { img: 'piyoUpset', visible: () => gameState.main.flags.piyoStatus == 0 }
                    },
                    {
                        x: 31.6, y: 61.2, width: 17.2, height: 15.9,
                        onClick() {
                            if (!gameState.main.flags.serveToVipRoomDrink && hasItem('redwine')) {
                                updateMessage('„Äåvip„É´„Éº„É†„Å´ÈÅã„Çì„Åß„Åç„Å¶„Éî„É®„Äç');
                            } else if (!gameState.main.flags.serveToVipRoomFood && hasItem('sandwich')) {
                                updateMessage('„Äåvip„É´„Éº„É†„Å´ÈÅã„Çì„Åß„Åç„Å¶„Éî„É®„Äç');
                            } else if (gameState.selectedItem == 'can') {
                                window._nextModal = {
                                    title: '„ÉÑ„Éä„Çµ„É≥„Éâ„Çí‰Ωú„Çã„Éî„É®',
                                    content: `<img src="${IMAGES.modals.piyoSandwich}" style="width:400px;display:block;margin:0 auto 20px;">`,
                                    buttons: [{ text: 'Èñâ„Åò„Çã', action: 'close' }],
                                };
                                const onClosed = () => {
                                    playSE('se-clear');
                                    gameState.main.flags.gotSandwich = true;
                                    updateMessage('„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ„ÇíÂèó„ÅëÂèñ„Å£„Åü„ÄÇ„Äåvip„É´„Éº„É†„Å´ÈÅã„Çì„Åß„Åç„Å¶„Éî„É®„Äç');
                                };
                                window.addEventListener('modal:closed', onClosed, { once: true });
                                showModal(
                                    '„ÉÑ„ÉäÁº∂„Éî„É®ÔºÅ',
                                    `<img src="${IMAGES.modals.piyoTuna}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                                removeItem('can');
                                addItem('sandwich');

                            } else {
                                handlePiyoTalk();
                            }
                        },
                        description: '„Å¥„Çà„Éé„Éº„Éû„É´',
                        zIndex: 5,
                        usable: () => gameState.main.flags.piyoStatus == 1 && !gameState.main.flags.gonePiyo,
                        item: { img: 'piyoNormal', visible: () => gameState.main.flags.piyoStatus == 1 && !gameState.main.flags.gonePiyo }
                    },
                    {
                        x: 35.1, y: 77.4, width: 12.8, height: 17.6,
                        onClick() {
                            showObj(null, '„É°„Éã„É•„Éº„Å†„ÄÇ', IMAGES.modals.menu, '„É°„Éã„É•„Éº„Å†„ÄÇ„Ç¢„É´„Ç≥„Éº„É´„ÅØÂá∫„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åø„Åü„ÅÑ„Å†');
                        },
                        description: '„É°„Éã„É•„Éº„Éñ„ÉÉ„ÇØ',
                    },
                    {
                        x: 86.3, y: 63.8, width: 7.1, height: 7.8,
                        onClick() {
                            if (gameState.main.flags.gonePiyo) {
                                showObj(null, 'ÂºïÁ∂ô„Åé„É°„É¢', IMAGES.items.handover, 'ÂºïÁ∂ô„Åé„É°„É¢„Å†');
                            } else {
                                updateMessage('Ëøë„Å•„Åã„Å™„ÅÑ„Å®Ë¶ã„Åà„Å™„ÅÑ„ÄÇ„Éê„Éº„ÉÜ„É≥„ÉÄ„Éº„Åï„Çì„ÅåÂ±Ö„Çã„Åã„Çâ‰∏≠„Å´„ÅØÂÖ•„Çå„Å™„ÅÑ„Å™');
                            }

                        },
                        description: '„É°„É¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'handover', visible: () => true }
                    },
                    {
                        x: 30.6, y: 17.5, width: 56.0, height: 55.9,
                        onClick() {
                            updateMessage('„ÅäÈÖí„Åå‰∏¶„Çì„Åß„ÅÑ„Çã');

                        },
                        description: '„Éê„ÉºËÉåÂæå„ÅÆÊ£ö',

                    },
                    {
                        x: 51.6, y: 43.8, width: 9.5, height: 11.7,
                        onClick() {
                            if (gameState.selectedItem == 'elixir') {
                                removeItem('elixir');
                                updateMessage('„Ç¥„Éº„É´„Éá„É≥„É†„Éº„É≥„Ç®„É™„ÇØ„Çµ„Éº„ÇíÁΩÆ„ÅÑ„Åü');
                                gameState.main.flags.putElixir = true;
                                gameState.flags.trueEndUnlocked = true;
                                playSE('se-kirakira');
                                renderCanvasRoom();
                                showToast('„É¨„Ç≥„Éº„Éâ„ÇíÂõû„Åó„Å¶ËÑ±Âá∫„Åó„Çà„ÅÜ');
                            } else if (!gameState.main.flags.putElixir) {
                                updateMessage('‰Ωï„ÅãÁΩÆ„Åë„Åù„ÅÜ„Å†');
                            } else {
                                updateMessage('„Ç¥„Éº„É´„Éá„É≥„É†„Éº„É≥„Ç®„É™„ÇØ„Çµ„Éº„ÅØÈùô„Åã„Å™Â≠òÂú®ÊÑü„ÇíÊîæ„Å£„Å¶„ÅÑ„Çã');
                            }

                        },
                        description: '„Éê„ÉºËÉåÂæå„ÅÆÊ£ö„Çª„É≥„Çø„Éº',
                        zIndex: 5,
                        usable: () => gameState.main.flags.gotElixir,
                        item: { img: 'elixirPut', visible: () => gameState.main.flags.putElixir }
                    },
                    {
                        x: 53.5, y: 74.0, width: 27.6, height: 15.8,
                        onClick() {
                            updateMessage('„Ç∑„Çß„Ç§„Ç´„Éº„Å™„Å©„Åå„ÅÇ„Çã');

                        },
                        description: '„Ç∑„Çß„Ç§„Ç´„Éº„Å™„Å©ÊâãÂâç',

                    },
                    {
                        x: 8.5, y: 62.8, width: 17.3, height: 11.1,
                        onClick() {
                            updateMessage('„Ç∑„Çß„Ç§„Ç´„Éº„Å™„Å©„Åå„ÅÇ„Çã');

                        },
                        description: '„Ç∑„Çß„Ç§„Ç´„Éº„Å™„Å©Â••',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('cabinet');
                        },
                        description: '„Ç´„Ç¶„É≥„Çø„ÉºÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('door');
                        },
                        description: '„Ç´„Ç¶„É≥„Çø„ÉºÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            cabinet: {
                name: '„Éê„Éº',
                description: '„Éâ„Ç¢„Åå„ÅÇ„Çã',
                clickableAreas: [
                    {
                        x: 70.1, y: 26.5, width: 20.1, height: 63.4,
                        onClick() {
                            if (gameState.vipRoom.flags.backgroundState < 2 && gameState.selectedItem == 'glass') {
                                // Ê¨°„Å´Âá∫„Åô„Äå‰ºöË©±„É¢„Éº„ÉÄ„É´„Äç„Çí‰∫àÁ¥Ñ
                                window._nextModal = {
                                    title: '„Éâ„Ç¢„ÅÆÂêë„Åì„ÅÜ„Åã„ÇâÂ£∞„ÅåËÅû„Åì„Åà„Çã',
                                    content: `
Áå´AÔºà‰Ωé„ÅèÊäë„Åà„ÅüÂ£∞Ôºâ<br><br>
„Äå‚Ä¶‚Ä¶„Éü„É©„ÇØ„É´ÈáëÊüë„ÅÆÊñ∞„Åó„ÅÑ„É≠„ÉÉ„Éà„ÄÅ„Åæ„ÅüÂÖ•„Å£„Åü„Çâ„Åó„ÅÑ„ÄÇ„Äç<br><br>
Áå´BÔºàÊÖéÈáç„Å™Â£∞Ôºâ<br><br>
„ÄåÂØÜËº∏ÂÖÉ„ÅØ„Åæ„Å†Ââ≤„Çå„Å¶„ÅÑ„Å™„ÅÑ„Çì„Å†„ÇçÔºü<br>
„ÄÄÊ∏Ø„ÅÆÁõ£Ë¶ñ„ÇÇÂº∑Âåñ„Åó„Åü„ÅØ„Åö„Å†„ÄÇ„Äç`,
                                    buttons: [
                                        { text: 'Èõ¢„Çå„Çã', action: 'close' }
                                    ],
                                    before() {
                                        // ‰ºöË©±„É¢„Éº„ÉÄ„É´„ÅåÈñã„Åè„Å®„Åç„Å´‰∏ÄÂ∫¶„Å†„ÅëÈ≥¥„Çã
                                        if (typeof playSE === 'function') playSE('se-cat');
                                    },
                                    after() {
                                        // ‰ºöË©±„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Åü„ÅÇ„Å®„Å´„É≠„Ç∞„Å∏
                                        updateMessage('VIP„É´„Éº„É†„ÅÆ‰∏≠„Åß„ÄÅ„Éü„É©„ÇØ„É´ÈáëÊüë„ÅÆË©±„Çí„Åó„Å¶„ÅÑ„Åü„Çà„ÅÜ„Å†');
                                    }
                                };

                                // „Åæ„Åö„ÅØ„Äå„Éâ„Ç¢„Å´„Ç∞„É©„Çπ„ÇíÂΩì„Å¶„Åü„Äç„É¢„Éº„ÉÄ„É´
                                showModal(
                                    '„Éâ„Ç¢„Å´„Ç∞„É©„Çπ„ÇíÂΩì„Å¶„Å¶„Åø„Åü',
                                    `<img src="${IMAGES.modals.glassDoor}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [
                                        { text: 'ËÄ≥„ÇíÊæÑ„Åæ„Åô', action: 'close' }
                                    ]
                                );

                                updateMessage('„Éâ„Ç¢„Å´„Ç∞„É©„Çπ„ÇíÂΩì„Å¶„Å¶„Åø„Åü');

                                return;
                            }
                            if (gameState.main.flags.unlockVipRoomDoor) {
                                changeRoom('vipRoom');
                            } else if (gameState.main.flags.piyoStatus > 0) {
                                showVipRoomDoorPuzzle();
                            } else {
                                updateMessage('‰∏≠„Å´Ë™∞„Åã„ÅÑ„Çã„Çà„ÅÜ„Å†‚Ä¶');
                            }

                        },
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÂè≥viproom„Éâ„Ç¢',

                    },
                    {
                        x: 43.5, y: 33.0, width: 14.4, height: 18.3,
                        onClick() {
                            // „Åô„Åß„Å´ÂÆåÊàê„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà
                            if (gameState.main.flags.setPic || gameState.main.flags.setPics) {
                                showObj(null, 'Á¥†Êïµ„Å™„Éù„Çπ„Çø„Éº„Å†', IMAGES.items.posterBear, 'Á¥†Êïµ„Å™„Éù„Çπ„Çø„Éº„Å†');
                                return;
                            }

                            // pic1, pic2, pic3 „ÇíÂÖ®ÈÉ®ÊåÅ„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            const hasAllPics = ['pic1', 'pic2', 'pic3'].every(id => hasItem(id));

                            if (hasAllPics) {
                                // „Éë„Éº„ÉÑ„Çí„ÅØ„ÇÅ„ÇãÂá¶ÁêÜ
                                ['pic1', 'pic2', 'pic3'].forEach(id => removeItem(id));

                                // ÁµµÂÆåÊàê„Éï„É©„Ç∞
                                gameState.main.flags.setPic = true;
                                playSE('se-clear');
                                updateMessage('Ôºì„Å§„ÅÆ„Éë„Éº„ÉÑ„Çí„ÅØ„ÇÅ„Åü„ÄÇ‰∏ã„ÅÆ„Ç≠„É£„Éì„Éç„ÉÉ„Éà„Åß„Åã„Åô„Åã„Å™Áâ©Èü≥„Åå„Åó„Åü„ÄÇ');
                                renderCanvasRoom();
                            } else {
                                updateMessage('‰Ωï„Åã„ÅÆ„Éë„Éº„ÉÑ„ÅåË∂≥„Çä„Å™„ÅÑ„Çà„ÅÜ„Å†');
                            }
                        },
                        description: 'Áµµ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'posterBear', visible: () => gameState.main.flags.setPic }
                    },
                    {
                        x: 38.1, y: 71.5, width: 23.2, height: 13.8,
                        onClick() {
                            showCabinetPuzzle();

                        },
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„Éà',

                    },
                    {
                        x: 54.1, y: 65.2, width: 5.3, height: 5.1,
                        onClick() {
                            updateMessage('„Ç≠„É£„É≥„Éâ„É´„Åå„ÅÇ„Çã');

                        },
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„Éà‰∏ä„ÅÆ„Ç≠„É£„É≥„Éâ„É´',
                        zIndex: 5,

                    },
                    {
                        x: 40.0, y: 54.8, width: 11.4, height: 14.9,
                        onClick() {
                            updateMessage('„Çπ„Çø„É≥„Éâ„É©„Ç§„Éà„Åå„ÅÇ„Çã');

                        },
                        description: '„Çπ„Çø„É≥„Éâ„É©„Ç§„Éà',
                        zIndex: 5,

                    },
                    {
                        x: 59.6, y: 58.4, width: 4.3, height: 5.1,
                        onClick() {
                            if (gameState.vipRoom.flags.backgroundState < 2) {
                                updateMessage('‰ΩøÁî®‰∏≠„ÅÆ„Çà„ÅÜ„Å†');
                            } else {
                                updateMessage('Á©∫„ÅÑ„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å†');
                            }

                        },
                        description: 'Â£Å„ÅÆ„Çπ„Ç§„ÉÉ„ÉÅ',
                        zIndex: 5,

                    },
                    {
                        x: 60.9, y: 59.4, width: 1.6, height: 2.5,
                        onClick() {

                        },
                        description: 'viproom‰ΩøÁî®„É©„É≥„Éó(‰ΩøÁî®‰∏≠)',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'redBack', visible: () => gameState.vipRoom.flags.backgroundState < 2 }
                    },
                    {
                        x: 60.9, y: 59.4, width: 1.6, height: 2.5,
                        onClick() {

                        },
                        description: 'viproom‰ΩøÁî®„É©„É≥„Éó(Á©∫„Åç)',
                        zIndex: 5,
                        usable: () => false,
                        item: { img: 'greenBack', visible: () => gameState.vipRoom.flags.backgroundState == 2 }
                    },
                    {
                        x: 5.1, y: 13.8, width: 26.4, height: 77.6,
                        onClick() {
                            if (gameState.main.flags.unlockDrinkCabinet) {
                                changeRoom('drinkCabinetInner');
                            } else {
                                updateMessage('Èçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                            }

                        },
                        description: '„ÅäÈÖí„Ç≠„É£„Éì„Éç„ÉÉ„Éà',

                    },
                    {
                        x: 15.0, y: 58.0, width: 6.8, height: 6.7,
                        onClick() {
                            if (gameState.selectedItem == 'keySideboard') {
                                updateMessage('Èçµ„ÅåÂêà„Çè„Å™„ÅÑ');
                            } else if (gameState.selectedItem == 'key') {
                                gameState.main.flags.unlockDrinkCabinet = true;
                                playSE('se-gacha');
                                renderCanvasRoom();
                                updateMessage('Èçµ„Åß„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åü');
                            } else {
                                updateMessage('„É≠„ÉÉ„ÇØ„Å†');
                            }

                        },
                        description: '„ÅäÈÖí„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆÈçµ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.unlockDrinkCabinet,
                        item: { img: 'lockCabinet', visible: () => !gameState.main.flags.unlockDrinkCabinet }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('brickWall');
                        },
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÈù¢ÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('counter');
                        },
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÈù¢ÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            brickWall: {
                name: '„Éê„Éº',
                description: '„É¨„É≥„Ç¨„ÅÆÂ£Å„Åå„ÅÇ„Çã',
                clickableAreas: [
                    {
                        x: -3.6, y: 49.5, width: 38.3, height: 46.4,
                        onClick() {
                            if (gameState.selectedItem == 'glassFill') {
                                window._nextModal = {
                                    title: '„Åª„ÅÜ„ÄÅÊ∫ÄË∂≥„Å†„ÄÇÔºà„Åì„Çå„ÅØ„Åú„Å≤„Å®„ÇÇ‚Ä¶Ôºâ„Åù„Çç„Åù„ÇçÂ∏∞„Çã„Å®„Åó„Çà„ÅÜ',
                                    content: `<img src="${IMAGES.modals.goneCrocoGood}" style="width:400px;display:block;margin:0 auto 20px;">`,
                                    buttons: [{ text: 'OK', action: 'close' }],
                                };
                                // Ë≥™Âïè„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶„ÄÅÊ¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÁô∫ÁÅ´
                                const onClosed = () => {
                                    // playSE('se-negative');
                                    gameState.main.flags.goneCroco = true;
                                    gameState.main.flags.usableCoupon = true;
                                    renderCanvasRoom();
                                    quickBlackFade();
                                    updateMessage('„ÉØ„ÉãÁ¥≥Â£´„ÅØÂ∏∞„Å£„Å¶„ÅÑ„Å£„Åü');

                                };
                                window.addEventListener('modal:closed', onClosed, { once: true });
                                showModal(
                                    '„Åä„Åä„ÄÅ„Åì„Çå„Åå„É†„Éº„É≥„Éè„Éã„ÉºNo.7„Åã„Å≠Ôºü',
                                    `<img src="${IMAGES.modals.crocoDrinkTrue}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                                removeItem('glassFill');


                            } else if (gameState.selectedItem == 'glassFillFalse') {
                                window._nextModal = {
                                    title: '„Åµ„ÇÄ„ÄÇÔºà„Åì„ÅÆÁ®ãÂ∫¶„Å™„Çâ„Çè„ÅåÁ§æ„ÅÆ„Åª„ÅÜ„Åå‚Ä¶Ôºâ<br>„Åù„Çç„Åù„ÇçÂ∏∞„Çã„Å®„Åó„Çà„ÅÜ',
                                    content: `<img src="${IMAGES.modals.goneCroco}" style="width:400px;display:block;margin:0 auto 20px;">`,
                                    buttons: [{ text: 'OK', action: 'close' }],
                                };
                                // Ë≥™Âïè„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶„ÄÅÊ¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÁô∫ÁÅ´
                                const onClosed = () => {
                                    // playSE('se-negative');
                                    gameState.main.flags.goneCroco = true;
                                    renderCanvasRoom();
                                    quickBlackFade();
                                    updateMessage('„ÉØ„ÉãÁ¥≥Â£´„ÅØÂ∏∞„Å£„Å¶„ÅÑ„Å£„Åü');

                                };
                                window.addEventListener('modal:closed', onClosed, { once: true });
                                showModal(
                                    '„Åä„Åä„ÄÅ„Åì„Çå„Åå„É†„Éº„É≥„Éè„Éã„ÉºNo.7„Åã„Å≠Ôºü‚Ä¶„ÅÜ„Éº„ÇìÔºü‚Ä¶',
                                    `<img src="${IMAGES.modals.crocoDrinkFalse}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                                removeItem('glassFillFalse');

                            } else {
                                if (!gameState.main.flags.talkToCroco) gameState.main.flags.talkToCroco = true;
                                showModal(
                                    '„É†„Éº„É≥„Éè„Éã„ÉºNo.7„ÅåÈ£≤„Åø„Åü„ÅÑ„ÇÇ„ÅÆ„Å†„ÄÇÂ§ß„Åç„Å™Â£∞„Åß„ÅØË®Ä„Åà„Å™„ÅÑ„Åå„Å≠„ÄÇ',
                                    `<img src="${IMAGES.modals.crocoHoney}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                            }



                        },
                        description: '„ÉØ„ÉãÁ¥≥Â£´',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.goneCroco,
                        item: { img: 'croco', visible: () => !gameState.main.flags.goneCroco }
                    },
                    {
                        x: 7.2, y: 88.4, width: 9.3, height: 6.7,
                        onClick() {
                            acquireItemOnce('foundPic1', 'pic1', '‰Ωï„Åã„ÅÆ„Éë„Éº„ÉÑ„Å†', IMAGES.items.pic1, '‰Ωï„Åã„ÅÆ„Éë„Éº„ÉÑ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                        },
                        description: '„Éî„Éº„ÇπÔºë',
                        zIndex: 5,
                        usable: () => gameState.main.flags.goneCroco && !gameState.main.flags.foundPic1,
                        item: { img: 'pic1', visible: () => gameState.main.flags.goneCroco && !gameState.main.flags.foundPic1 }
                    },
                    {
                        x: 62.7, y: 73.9, width: 9.7, height: 10.2,
                        onClick() {
                            showSideboardLeftPuzzle();
                        },
                        description: '„Çµ„Ç§„Éâ„Éú„Éº„ÉâÂ∑¶',

                    },
                    {
                        x: 87.7, y: 73.6, width: 10.0, height: 10.1,
                        onClick() {
                            showSideboardRightPuzzle();
                        },
                        description: '„Çµ„Ç§„Éâ„Éú„Éº„ÉâÂè≥',
                    },
                    {
                        x: 73.6, y: 74.1, width: 13.2, height: 3.6,
                        onClick() {
                            showSideboardCenterTopPuzzle();
                        },
                        description: '„Çµ„Ç§„Éâ„Éú„Éº„Éâ‰∏≠‰∏ä',

                    },
                    {
                        x: 73.6, y: 79.2, width: 12.8, height: 4.6,
                        onClick() {
                            if (gameState.selectedItem == 'keySideboard') {
                                removeItem('keySideboard');
                                gameState.main.flags.unlockSideboardCenterBottom = true;
                                playSE('se-gacha');
                                showModal(
                                    'Èçµ„ÇíÈñã„Åë„Åü',
                                    '',
                                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                                );
                            } else if (gameState.main.flags.unlockSideboardCenterBottom) {
                                acquireItemOnce('foundConversion', 'conversion', 'ÊÄ™„Åó„ÅÑË°®„ÅåÂÖ•„Å£„Å¶„ÅÑ„Åü', IMAGES.items.conversion, 'ÊÄ™„Åó„ÅÑË°®„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                            } else if (!gameState.main.flags.unlockSideboardCenterBottom) {
                                updateMessage('Èçµ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã');
                            }

                        },
                        description: '„Çµ„Ç§„Éâ„Éú„Éº„Éâ‰∏≠‰∏ã',

                    },
                    {
                        x: 73.0, y: 58.1, width: 5.1, height: 12.8,
                        onClick() {
                            updateMessage('„ÉØ„Ç§„É≥„Éú„Éà„É´„Åå„ÅÇ„Çã')

                        },
                        description: '„ÉØ„Ç§„É≥„Éú„Éà„É´',

                    },
                    {
                        x: 78.3, y: 62.0, width: 10, height: 10,
                        onClick() {
                            if (gameState.main.flags.putDecanter) {
                                gameState.main.flags.putDecanter = false;
                                addItem('decanter');
                                updateMessage('„Éá„Ç´„É≥„Çø„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                                renderCanvasRoom();
                            } else if (gameState.selectedItem == 'decanter') {
                                gameState.main.flags.putDecanter = true;
                                removeItem('decanter');
                                updateMessage('„Éá„Ç´„É≥„Çø„ÇíÁΩÆ„ÅÑ„Åü');
                                renderCanvasRoom();
                            } else {
                                updateMessage('‰Ωï„ÅãÁΩÆ„Åë„Åù„ÅÜ„Å†');
                            }

                        },
                        description: '„Éá„Ç´„É≥„ÇøÁî®Â†¥ÊâÄ',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'decanter', visible: () => gameState.main.flags.putDecanter }
                    },
                    {
                        x: 88.0, y: 61.7, width: 9.5, height: 9.9,
                        onClick() {
                            showObj(null, '', IMAGES.items.picXmas);

                        },
                        description: 'ÂÜôÁúü„Åü„Å¶',

                    },
                    {
                        x: 62.5, y: 60.1, width: 7.9, height: 11.1,
                        onClick() {
                            updateMessage('„Ç™„Ç¶„É†„ÅÆÁΩÆÁâ©„Å†');

                        },
                        description: '„Ç™„Ç¶„É†',

                    },
                    {
                        x: 13.5, y: 62.3, width: 4.6, height: 4.2,
                        onClick() {
                            if (gameState.selectedItem == 'stick') {
                                gameState.brickWall.flags.backgroundState++;
                                renderCanvasRoom();
                                removeItem('stick');
                                playSE('se-gogogo');
                                updateMessage('Â£Å„ÅÆÁ©¥„Å´Ê£í„ÇíÂÖ•„Çå„Å¶„Å≤„Å≠„Çã„Å®„ÄÅÂ£Å„ÅåÂãï„ÅÑ„Åü');
                            } else {
                                updateMessage('Á©¥„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çã');
                            }

                        },
                        description: '„É¨„É≥„Ç¨Â£Å„ÅÆÁ©¥',
                        zIndex: 5,
                    },
                    {
                        x: 24.2, y: 21.8, width: 29.9, height: 66.5,
                        onClick() {
                            changeRoom('storage');

                        },
                        description: 'Ë™¨Êòé',
                        zIndex: 5,
                        usable: () => gameState.brickWall.flags.backgroundState == 1,
                    },

                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('cabinet');
                        },
                        description: '„É¨„É≥„Ç¨Èù¢ÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },

            corridor: {
                name: '„Éê„Éº',
                description: '',
                clickableAreas: [
                    {
                        x: 30.5, y: 87.3, width: 7.2, height: 5.5,
                        onClick() {
                            acquireItemOnce('foundPic3', 'pic3', '‰Ωï„Åã„ÅÆ„Éë„Éº„ÉÑ„ÇíÊãæ„Å£„Åü', IMAGES.items.pic3, '‰Ωï„Åã„ÅÆ„Éë„Éº„ÉÑ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                        },
                        description: '„Éî„Éº„ÇπÔºì',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundPic3,
                        item: { img: 'pic3', visible: () => !gameState.main.flags.foundPic3 }
                    },

                    {
                        x: 22.8, y: 21.8, width: 8.5, height: 30.7,
                        onClick() {
                            showObj(null, '„Éù„Çπ„Çø„Éº„Å†„ÄÇ', IMAGES.modals.posterBird, '„Éù„Çπ„Çø„Éº„Å†„ÄÇ');
                        },
                        description: 'Âªä‰∏ãÂ∑¶„ÅÆÁµµ',
                        zIndex: 5,
                        usable: () => true,
                    },
                    {
                        x: 61.6, y: 73.7, width: 8.4, height: 14.3,
                        onClick() {
                            showObj(null, '„Ç¥„ÉüÁÆ±„Å†', IMAGES.modals.dustbox, '„Ç¥„ÉüÁÆ±„Å†');

                        },
                        description: 'Âªä‰∏ã„Ç¥„ÉüÁÆ±',
                        zIndex: 5,

                    },
                    {
                        x: 72.7, y: 26.9, width: 6.4, height: 38.4,
                        onClick() {
                            if (gameState.main.flags.unlockSecretRoom) {
                                changeRoom('secretRoom');
                            } else {
                                showSecretRoomDoorPuzzle();
                            }

                        },
                        description: '„Éà„Ç§„É¨„Éâ„Ç¢Âè≥',

                    },
                    {
                        x: 44.1, y: 33.8, width: 12.7, height: 36.4,
                        onClick() {
                            updateMessage('„Éà„Ç§„É¨„Å†„ÄÇ');

                        },
                        description: '„Éà„Ç§„É¨„Éâ„Ç¢Ê≠£Èù¢',

                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('door');
                        },
                        description: 'corridorÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },

            vipRoom: {
                name: 'VIP„É´„Éº„É†',
                description: '',
                clickableAreas: [
                    {
                        x: 38.1, y: 11.4, width: 23.4, height: 29.5,
                        onClick() {
                            showObj(null, 'È£æ„ÇäÊ£ö„Å†„ÄÇÊôÇË®à„ÅØ10:10„ÇíÊåá„Åó„Å¶„ÅÑ„Çã', IMAGES.modals.displayShelf, 'È£æ„ÇäÊ£ö„Å†„ÄÇÊôÇË®à„ÅØ10:10„ÇíÊåá„Åó„Å¶„ÅÑ„Çã')
                        },
                        description: 'È£æ„ÇäÊ£ö',

                    },
                    {
                        x: 16.9, y: 41.7, width: 17.6, height: 26.6,
                        onClick() {
                            handleCatsResponse();

                        },
                        description: 'Áå´„É¨„Éá„Ç£Â∑¶Ëµ§',
                        usable: () => !gameState.main.flags.goneCats
                    },
                    {
                        x: 76.1, y: 39.8, width: 15.4, height: 30.0,
                        onClick() {
                            handleCatsResponse();

                        },
                        description: 'Áå´„É¨„Éá„Ç£Âè≥Èªí',
                        usable: () => !gameState.main.flags.goneCats

                    },
                    {
                        x: 71.8, y: 54.0, width: 13.4, height: 10.6,
                        onClick() {
                            acquireItemOnce('foundKey', 'key', 'Èçµ„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.key, 'Èçµ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                        },
                        description: '„ÇØ„ÉÉ„Ç∑„Éß„É≥Âè≥',
                        usable: () => gameState.main.flags.goneCats
                    },
                    {
                        x: 19.1, y: 54.7, width: 12.8, height: 11.4,
                        onClick() {
                            updateMessage('„Å™„Å´„ÇÇ„Å™„ÅÑ');
                        },
                        description: '„ÇØ„ÉÉ„Ç∑„Éß„É≥Â∑¶',
                        usable: () => gameState.main.flags.goneCats

                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('cabinet');
                        },
                        description: 'viproomÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            storage: {
                name: 'ÂÄâÂ∫´',
                description: '',
                clickableAreas: [
                    {
                        x: 54.7, y: 39.2, width: 23.0, height: 35.9,
                        onClick() {
                            if (gameState.storage.flags.backgroundState == 0) {
                                gameState.storage.flags.backgroundState++;
                                renderCanvasRoom();
                                updateMessage('ÂÜ∑ËîµÂ∫´„ÇíÈñã„Åë„Åü');
                            } else if (gameState.storage.flags.backgroundState == 1 && !gameState.main.flags.foundCitrus) {
                                acquireItemOnce('foundCitrus', 'citrus', '„Éü„É©„ÇØ„É´ÈáëÊüë„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.citrus, '„Éü„É©„ÇØ„É´ÈáëÊüë„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                            } else {
                                updateMessage('ÊûúÁâ©„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã');
                            }
                        },
                        description: 'ÂÜ∑ËîµÂ∫´',

                    },
                    {
                        x: 22.2, y: 19.8, width: 34.6, height: 13.1,
                        onClick() {
                            updateMessage('„Éú„Éà„É´„Åå‰∏¶„Çì„Åß„ÅÑ„Çã');
                        },
                        description: 'Ê£ö‰∏äÊÆµ„Éú„Éà„É´',

                    },
                    {
                        x: 22.6, y: 51.1, width: 28.0, height: 25.2,
                        onClick() {
                            updateMessage('‰Ωï„Åã„ÅÆÊùêÊñô„ÅÆ„Çà„ÅÜ„Å†');
                        },
                        description: 'Ê£ö‰∏ãÊÆµ',

                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('brickWall');
                        },
                        description: 'ÂÄâÂ∫´Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            record: {
                name: 'ËìÑÈü≥Ê©ü„ÅÆ„É¨„Ç≥„Éº„Éâ',
                description: '',
                clickableAreas: [
                    {
                        x: 85.7, y: 30.7, width: 13.8, height: 25.1,
                        onClick() {
                            spinRecord();

                        },
                        description: 'ËìÑÈü≥Ê©ü„Éè„É≥„Éâ„É´',

                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('door');
                        },
                        description: 'recordÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            recordTime: {
                name: 'ËìÑÈü≥Ê©ü„ÅÆ„É¨„Ç≥„Éº„Éâ',
                description: '',
                clickableAreas: [
                    {
                        x: 85.7, y: 30.7, width: 13.8, height: 25.1,
                        onClick() {
                            spinRecord();
                        },
                        description: 'ËìÑÈü≥Ê©ü„Éè„É≥„Éâ„É´',
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() { changeRoom('door'); },
                        description: 'recordTimeÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            // inner
            cabinetInner: {
                name: '„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÔºà‰ΩéÔºâÂÜÖÈÉ®',
                description: '',
                clickableAreas: [

                    {
                        x: 58.1, y: 78.4, width: 30.2, height: 8.3,
                        onClick() {
                            acquireItemOnce(
                                'foundRecordTime',
                                'recordTime',
                                '„É¨„Ç≥„Éº„Éâ„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                                IMAGES.items.recordTime,
                                '„É¨„Ç≥„Éº„Éâ„ÇíÊâã„Å´ÂÖ•„Çå„Åü'
                            )
                        },
                        description: '„É¨„Ç≥„Éº„Éâ(time)',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundRecordTime,
                        item: { img: 'recordTime', visible: () => !gameState.main.flags.foundRecordTime }
                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('cabinet');
                        },
                        description: '„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÔºà‰ΩéÔºâÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            drinkCabinetInner: {
                name: 'È£≤„ÅøÁâ©„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÂÜÖÈÉ®',
                description: '',
                clickableAreas: [
                    {
                        x: 30.5, y: 17.3, width: 8.3, height: 16.4,
                        onClick() {
                            if (gameState.main.flags.goneCroco) {
                                updateMessage('Á∑ëËâ≤„ÅÆÁì∂„Å´ÂÖ•„Å£„Åü„É†„Éº„É≥„Éè„Éã„ÉºNo.7„Å†„ÄÇ„Åì„ÅÆ„ÅäÂ∫ó„ÅÆÂêçÁâ©„Å™„ÅÆ„Åã„Å™Ôºü');
                            } else {
                                if (gameState.selectedItem == 'glass') {
                                    removeItem('glass');
                                    addItem('glassFill');
                                    gameState.main.flags.foundGlassFill = true;
                                    showObj(null, '„É†„Éº„É≥„Éè„Éã„ÉºNo.7„Çí„Ç∞„É©„Çπ„Å´Ê≥®„ÅÑ„Å†', IMAGES.items.glassFill, '„É†„Éº„É≥„Éè„Éã„ÉºNo.7„ÅÆ„Ç∞„É©„Çπ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                                } else {
                                    updateMessage('„Åì„ÅÆÁ∑ëËâ≤„ÅÆÁì∂„Åå„ÄÅ„É†„Éº„É≥„Éè„Éã„ÉºNo.7„ÅÆ„Çà„ÅÜ„Å†„ÄÇ„Ç∞„É©„Çπ„Å´ÂÖ•„Çå„Å¶„ÅäÂÆ¢„Åï„Çì„Å´Ê∏°„Åù„ÅÜ');
                                }
                            }

                        },
                        description: '„É†„Éº„É≥„Éè„Éã„ÉºNo.Ôºó',
                    },
                    {
                        x: 58.5, y: 36.5, width: 7.8, height: 15.8,
                        onClick() {
                            if (gameState.main.flags.goneCroco) {
                                updateMessage('„Çµ„É≥„Ç∑„É•„Ç¨„Éº„Å®„ÅÑ„ÅÜ„ÅäÈÖí„ÅÆ„Çà„ÅÜ„Å†');
                            } else {
                                if (gameState.selectedItem == 'glass') {
                                    removeItem('glass');
                                    addItem('glassFillFalse');
                                    gameState.main.flags.foundGlassFillFalse = true;
                                    showObj(null, '„Çµ„É≥„Ç∑„É•„Ç¨„Éº„Çí„Ç∞„É©„Çπ„Å´Ê≥®„ÅÑ„Å†', IMAGES.items.glassFillFalse, '„Çµ„É≥„Ç∑„É•„Ç¨„Éº„ÅÆ„Ç∞„É©„Çπ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                                } else {
                                    updateMessage('„Çµ„É≥„Ç∑„É•„Ç¨„Éº„Å®„ÅÑ„ÅÜ„ÅäÈÖí„ÅÆ„Çà„ÅÜ„Å†');
                                }
                            }
                        },
                        description: '„Çµ„É≥„Ç∑„É•„Ç¨„Éº',

                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('cabinet');
                        },
                        description: 'È£≤„ÅøÁâ©„Ç≠„É£„Éì„Éç„ÉÉ„ÉàÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            sideboardLeft: {
                name: '„Çµ„Ç§„Éâ„Éú„Éº„ÉâÂ∑¶ÂÜÖÈÉ®',
                description: '',
                clickableAreas: [
                    {
                        x: 58.1, y: 78.4, width: 30.2, height: 8.3,
                        onClick() {
                            acquireItemOnce(
                                'foundRecordDefault',
                                'recordDefault',
                                '„É¨„Ç≥„Éº„Éâ„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                                IMAGES.items.recordDefault,
                                '„É¨„Ç≥„Éº„Éâ„ÇíÊâã„Å´ÂÖ•„Çå„Åü'
                            )
                        },
                        description: '„É¨„Ç≥„Éº„Éâ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundRecordDefault,
                        item: { img: 'recordDefault', visible: () => !gameState.main.flags.foundRecordDefault }
                    },
                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('brickWall');
                        },
                        description: '„Çµ„Ç§„Éâ„Éú„Éº„ÉâÂ∑¶Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            sideboardRight: {
                name: '„Çµ„Ç§„Éâ„Éú„Éº„ÉâÂè≥ÂÜÖÈÉ®',
                description: '',
                clickableAreas: [
                    {
                        x: 9.8, y: 56.5, width: 42.9, height: 31.0,
                        onClick() {
                            acquireItemOnce('foundGlass', 'glass', 'Ê≤¢Â±±„ÅÆ„Ç∞„É©„Çπ„Åå„ÅÇ„Çã„ÄÇ‰∏Ä„Å§Êâã„Å´Âèñ„Å£„Åü„ÄÇ', IMAGES.items.glass, '„Ç∞„É©„Çπ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                        },
                        description: '„Çµ„Ç§„Éâ„Éú„Éº„ÉâÂÜÖ„Ç∞„É©„Çπ',

                    },
                    {
                        x: 60.6, y: 49.3, width: 28.4, height: 33.3,
                        onClick() {
                            acquireItemOnce('foundDecanter', 'decanter', '„Éá„Ç´„É≥„Çø„ÇíÊâã„Å´ÂÖ•„Çå„Åü„ÄÇ', IMAGES.items.decanter, '„Éá„Ç´„É≥„Çø„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                        },
                        description: '„Éá„Ç´„É≥„Çø',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundDecanter,
                        item: { img: 'decanter', visible: () => !gameState.main.flags.foundDecanter }
                    },
                    // {
                    //     x: 58.1, y: 78.4, width: 30.2, height: 8.3,
                    //     onClick() {
                    //         acquireItemOnce(
                    //             'foundRecordTime',
                    //             'recordTime',
                    //             '„É¨„Ç≥„Éº„Éâ„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                    //             IMAGES.items.recordTime,
                    //             '„É¨„Ç≥„Éº„Éâ„ÇíÊâã„Å´ÂÖ•„Çå„Åü'
                    //         )
                    //     },
                    //     description: '„É¨„Ç≥„Éº„Éâ(time)',
                    //     zIndex: 5,
                    //     usable: () => !gameState.main.flags.foundRecordTime,
                    //     item: { img: 'recordTime', visible: () => !gameState.main.flags.foundRecordTime }
                    // },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('brickWall');
                        },
                        description: '„Çµ„Ç§„Éâ„Éú„Éº„ÉâÂè≥Êàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            secretRoom: {
                name: 'ÁßòÂØÜ„ÅÆÈÉ®Â±ã',
                description: '',
                clickableAreas: [
                    {
                        x: 37.9, y: 62.7, width: 19.6, height: 20.4,
                        onClick() {
                            if (hasItem('citrus') && hasItem('finalSyrup')) {
                                window._nextModal = {
                                    title: '„Éü„É©„ÇØ„É´ÈáëÊüë„Å®ÊúÄÂæå„ÅÆ„Ç∑„É≠„ÉÉ„Éó„ÇíÂ•™„ÅÑÂèñ„Çâ„Çå„Åü',
                                    content: '',
                                    buttons: [{ text: 'OK', action: 'close' }],
                                };
                                const onClosed = () => {
                                    playSE('se-grab');
                                    updateMessage('„Éü„É©„ÇØ„É´ÈáëÊüë„Å®ÊúÄÂæå„ÅÆ„Ç∑„É≠„ÉÉ„Éó„ÇíÂ•™„ÅÑÂèñ„Çâ„Çå„Åü');
                                };
                                window.addEventListener('modal:closed', onClosed, { once: true });
                                showObj('passMaterialToBear', '„Åì„Çå„ÅØ‚Ä¶ÔºÅ‰∏Ä‰Ωì„Å©„Åì„Åß„Åø„Å§„Åë„Åü„ÅÆÔºü', IMAGES.modals.bearSurprized, '„ÇØ„ÉûÂ¶ñÁ≤æ„ÅØ„Åä„Å©„Çç„ÅÑ„Å¶„ÅÑ„Çã');
                                removeItem('citrus');
                                removeItem('finalSyrup');
                                playSE('se-up');
                                renderCanvasRoom();
                                return;

                            } else if (gameState.selectedItem == 'elixir') {
                                updateMessage('„Éú„ÇØÂ§©Êâç„Åã„ÇÇ„ÄÇ„Å°„ÇÉ„Çì„Å®ÁΩÆ„ÅÑ„Å¶„Åç„Å¶„Å≠');

                            } else if (gameState.main.flags.gotElixir) {
                                updateMessage('„Ç´„Ç¶„É≥„Çø„Éº„ÅÆÂæå„Çç„ÅÆÊ£ö„Å´ÁΩÆ„ÅÑ„Å¶„Åç„Å¶„Å≠');

                            } else {
                                showModal(
                                    '„Åì„Åì„Åß„ÅØ„ÅäÈÖí„ÇíÈÄ†„Å£„Å¶„Çã„ÇàÔºÅ',
                                    `<img src="${IMAGES.modals.bearDrink}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">
         <p style="margin-top:10px;">„Åï„Å£„Åç„Åß„Åç„Åü„ÅÆ„ÄÅÈ£≤„Çì„Åß„Åø„ÇãÔºü</p>`,
                                    [
                                        {
                                            text: '„ÅØ„ÅÑ',
                                            action: function () {
                                                // BAD END Êú¨‰Ωì„É¢„Éº„ÉÄ„É´„ÇíÊ¨°„Å´‰∫àÁ¥Ñ
                                                window._nextModal = {
                                                    title: '‚Ä¶Ë¶ñÁïå„Åå„ÇÜ„Åå„ÇÄ‚Ä¶ÊÑèË≠ò„ÅåÊ∫∂„Åë„Å¶„ÅÑ„Åè‚Ä¶<br>„ÄêBAD END„Äë',
                                                    content: `<img src="${IMAGES.modals.badendBear}" style="width:400px;display:block;margin:0 auto 20px;">`,
                                                    buttons: [{ text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart' }],
                                                };
                                                // Ë≥™Âïè„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶„ÄÅÊ¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÁô∫ÁÅ´
                                                const onClosed = () => {
                                                    playSE('se-negative');
                                                    updateMessage('ÊÑèË≠ò„ÇíÂ§±„Å£„Åü„ÄÇ„Éê„ÉÉ„Éâ„Ç®„É≥„Éâ');
                                                };
                                                window.addEventListener('modal:closed', onClosed, { once: true });
                                                closeModal();


                                            }
                                        },
                                        {
                                            text: '„ÅÑ„ÅÑ„Åà',
                                            action: function () {
                                                // ‰Ωï„ÇÇËµ∑„Åì„Åï„ÅöÈñâ„Åò„Çã„Å†„Åë
                                                closeModal();
                                            }
                                        }
                                    ],
                                    null,
                                    { columnButtons: true } // „Éú„Çø„É≥Á∏¶‰∏¶„Å≥
                                );
                            }


                        },
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.passMaterialToBear || gameState.main.flags.gotElixir,
                        item: { img: 'bear', visible: () => !gameState.main.flags.passMaterialToBear || gameState.main.flags.gotElixir, }
                    },
                    {
                        x: 34.4, y: 61.0, width: 19.5, height: 19.7,
                        onClick() {

                            acquireItemOnce('gotElixir', 'elixir', '„Åß„Åç„Åü„ÇàÔºÅ„Åô„Åî„Åù„ÅÜÔºÅ', IMAGES.modals.bearElixir, '„ÇØ„ÉûÂ¶ñÁ≤æ„ÅÆÂÇë‰Ωú„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                            playSE('se-fanta');
                            renderCanvasRoom();


                        },
                        description: '„ÇØ„ÉûÂ¶ñÁ≤æÂæå„ÇçÂêë„Åç',
                        zIndex: 5,
                        usable: () => gameState.main.flags.passMaterialToBear && !gameState.main.flags.gotElixir,
                        item: { img: 'bearBack', visible: () => gameState.main.flags.passMaterialToBear && !gameState.main.flags.gotElixir }
                    },
                    {
                        x: 12.7, y: 70.0, width: 10.9, height: 6.4,
                        onClick() {
                            updateMessage('Á†îÁ©∂Êó•Ë™å„ÅÆ„Çà„ÅÜ„Å†„ÄÇ„Äå„ÇÇ„ÅÜÂ∞ë„ÅóÁîò„Åø„ÅåÂøÖË¶Å„Å†‚Ä¶ÂçòÁ¥î„Åß„Å™„ÅèÊûúÂÆü„ÅÆ„Çà„ÅÜ„Å™„Äç‚Ä¶„Å®Êõ∏„ÅÑ„Å¶„ÅÇ„Çã');

                        },
                        description: '„Éé„Éº„Éà',

                    },
                    {
                        x: 37.7, y: 33.4, width: 36.7, height: 26.3,
                        onClick() {
                            if (gameState.selectedItem == 'stick') {
                                screenFlash('red');
                                showModal('„Éû„Éï„Ç£„Ç¢„ÅÆË®≠ÂÇô„Å´„Åù„Çì„Å™„Åì„Å®„Åó„Å¶Ë®±„Åï„Çå„Çã„Å®„Åß„ÇÇ‚Ä¶Ôºü<br>„ÅÇ„Å™„Åü„ÅØÊ≠ª„Çì„Åß„Åó„Åæ„Å£„Åü„ÄÇ',
                                    `<img src="${IMAGES.modals.badendBearGun}" style="width:400px;display:block;margin:0 auto 20px;">`,
                                    [{ text: 'ÊúÄÂàù„Åã„Çâ', action: 'restart' }]
                                );
                                playSE('se-gun');
                            } else {
                                updateMessage('„Åô„Åî„ÅèÊÄ™„Åó„ÅÑÊ©üÊ¢∞„Å†');
                            }

                        },
                        description: 'Ê©üÊ¢∞',

                    },
                    {
                        x: 82.5, y: 31.8, width: 13.2, height: 24.8,
                        onClick() {
                            updateMessage('ÊÄ™„Åó„Åí„Å™Ê∂≤‰Ωì„ÅåÂÖ•„Å£„ÅüÁì∂„Å†');
                        },
                        description: 'Â£Å„ÅÆÁì∂',

                    },
                    {
                        x: 72.7, y: 63.9, width: 20.0, height: 25.1,
                        onClick() {
                            updateMessage('Ê®Ω„ÅÆ‰∏≠Ë∫´„ÅØ„Éà„Ç¶„É¢„É≠„Ç≥„Ç∑„ÅÆ„Çà„ÅÜ„Å†');
                        },
                        description: 'Ê®Ω',

                    },

                    {
                        x: 90, y: 90, width: 10, height: 10,
                        onClick() {
                            changeRoom('corridor');
                        },
                        description: 'ÁßòÂØÜ„ÅÆÈÉ®Â±ãÊàª„Çã',
                        zIndex: 5,
                        item: { img: 'back', visible: () => true }
                    }
                ]
            },
            // now
            nowDoor: {
                name: 'Áèæ‰ª£„ÅÆ„Éê„Éº',
                description: '„Éâ„Ç¢„Åå„ÅÇ„Çã',
                clickableAreas: [
                    {
                        x: 44.1, y: 40.5, width: 12.7, height: 10.8,
                        onClick() {
                            showObj(null, 'Ë≤º„ÇäÁ¥ô„Å†', IMAGES.items.posterClose, 'Ë≤º„ÇäÁ¥ô„Å†')

                        },
                        description: '„Éâ„Ç¢„ÅÆÂºµ„ÇäÁ¥ô',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.unlockNowDoor,
                        item: { img: 'posterClose', visible: () => !gameState.main.flags.unlockNowDoor }
                    },
                    {
                        x: 37.6, y: 35.5, width: 26.0, height: 57.8,
                        onClick() {
                            if (gameState.main.flags.unlockNowDoor) {
                                handleDoor();
                            } else {
                                updateMessage('„Éâ„Ç¢„Å´„ÅØ„É≠„ÉÉ„ÇØ„ÅåÊéõ„Åã„Å£„Å¶„ÅÑ„Çã');
                            }
                        },
                        description: '„Éâ„Ç¢',

                    },
                    {
                        x: 30.3, y: 62.0, width: 9.5, height: 8.9,
                        onClick() {
                            if (gameState.selectedItem == 'key') {
                                playSE('se-gacha');
                                removeItem('key');
                                gameState.nowDoor.flags.backgroundState++;
                                gameState.main.flags.unlockNowDoor = true;
                                renderCanvasRoom();
                                updateMessage('„É≠„ÉÉ„ÇØ„ÇíÂ§ñ„Åó„Åü');


                            } else {
                                updateMessage('„É≠„ÉÉ„ÇØ„ÅåÊéõ„Åã„Å£„Å¶„ÅÑ„Çã„ÄÇ„Å©„Åì„Åã„ÅßË¶ã„Åü„Çà„ÅÜ„Å™‚Ä¶');
                            }

                        },
                        description: '„É≠„ÉÉ„ÇØ',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.unlockNowDoor,
                        item: { img: 'nowLock', visible: () => !gameState.main.flags.unlockNowDoor }
                    },
                    {
                        x: 32.8, y: 10.5, width: 35.0, height: 19.6,
                        onClick() {
                            updateMessage('‰ªä„Å´„ÇÇÂ¥©„ÇåËêΩ„Å°„Åù„ÅÜ„Å†');
                        },
                        description: '„Éâ„Ç¢‰∏ä„ÅÆÈ£æ„Çä',
                    },
                    {
                        x: 68.9, y: 50.9, width: 21.3, height: 19.4,
                        onClick() {
                            updateMessage('Âè§„Å≥„Å¶„ÅÑ„Çã');
                        },
                        description: 'ËìÑÈü≥Ê©ü„ÅÆ„É©„ÉÉ„ÉëÈÉ®ÂàÜ',

                    },
                    {
                        x: 74.9, y: 75.2, width: 13.0, height: 4.5,
                        onClick() {
                            showModal(
                                '„É¨„Ç≥„Éº„Éâ„ÇíÂõû„Åó„Å¶ÂÖÉ„ÅÆÈÉ®Â±ã„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü',
                                '',
                                [
                                    {
                                        text: "„ÅØ„ÅÑ",
                                        action: () => {
                                            closeModal();
                                            returnToPast();
                                        }
                                    },
                                    { text: "„ÅÑ„ÅÑ„Åà", action: "close" }
                                ]
                            );
                        },
                        description: 'ËìÑÈü≥Ê©üÊú¨‰Ωì',
                    },
                    {
                        x: 75.4, y: 83.1, width: 12.3, height: 3.9,
                        onClick() {
                            updateMessage('„Å™„Å´„ÇÇ„Å™„ÅÑ');

                        },
                        description: 'Âºï„ÅçÂá∫„Åó‰∏ä',

                    },
                    {
                        x: 75.6, y: 89.1, width: 12.4, height: 2.8,
                        onClick() {
                            updateMessage('„Å™„Å´„ÇÇ„Å™„ÅÑ');

                        },
                        description: 'Âºï„ÅçÂá∫„Åó‰∏ã',

                    },
                    {
                        x: 20.3, y: 68.7, width: 9.3, height: 27.0,
                        onClick() {
                            updateMessage('„Å™„Å´„ÇÇ„Å™„ÅÑ');
                        },
                        description: 'ÂÇòÁ´ã„Å¶',

                    },
                    {
                        x: 74.4, y: 17.8, width: 10.5, height: 9.0,
                        onClick() {
                            updateMessage('ÁÖßÊòé„ÅØ„Å§„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');
                        },
                        description: 'Â§©‰∫ïÁÖßÊòéÂè≥',

                    },
                    {
                        x: 17.6, y: 16.9, width: 9.5, height: 9.9,
                        onClick() {
                            updateMessage('ÁÖßÊòé„ÅØ„Å§„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');
                        },
                        description: 'Â§©‰∫ïÁÖßÊòéÂ∑¶',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 77.1, y: 39.1, width: 6.5, height: 5.7,
                        onClick() {
                            updateMessage('ÁÖßÊòé„ÅØ„Å§„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');

                        },
                        description: 'Â£ÅÁÖßÊòéÂè≥',

                    },
                    {
                        x: 17.4, y: 39.1, width: 6.6, height: 5.6,
                        onClick() {
                            updateMessage('ÁÖßÊòé„ÅØ„Å§„Åã„Å™„ÅÑ„Çà„ÅÜ„Å†');

                        },
                        description: 'Â£ÅÁÖßÊòéÂ∑¶',

                    },
                    {
                        x: 15.1, y: 74.5, width: 4.8, height: 18.5,
                        onClick() {
                            acquireItemOnce('foundStick', 'stick', 'Ê£í„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.stick, 'Ê£í„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                        },
                        description: 'Ê£í',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundStick,
                        item: { img: 'stick', visible: () => !gameState.main.flags.foundStick }
                    },
                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('nowCounter');
                        },
                        description: '„Éâ„Ç¢Èù¢ÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },

                ]
            },
            nowCounter: {
                name: '„Éê„Éº',
                description: '',
                clickableAreas: [
                    {
                        x: 31.5, y: 19.0, width: 51.1, height: 52.3,
                        onClick() {
                            updateMessage('„Åã„Å§„Å¶„ÅÆÂßø„Åå„Åó„ÅÆ„Å∞„Çå„Çã');

                        },
                        description: '„Éê„ÉºËÉåÂæå„ÅÆÊ£ö',

                    },
                    {
                        x: 54.5, y: 73.2, width: 22.5, height: 14.7,
                        onClick() {
                            updateMessage('Âè§„Å≥„ÅüÈÅìÂÖ∑È°û„Å†');

                        },
                        description: '„Ç∑„Çß„Ç§„Ç´„Éº„Å™„Å©ÊâãÂâç',

                    },
                    {
                        x: 9.8, y: 62.5, width: 17.2, height: 11.7,
                        onClick() {
                            updateMessage('„Åæ„Å†‰Ωø„Åà„Åù„ÅÜ„Åß„ÅØ„ÅÇ„Çã');

                        },
                        description: '„Ç∑„Çß„Ç§„Ç´„Éº„Å™„Å©Â••',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'IMAGE_KEY', visible: () => true }
                    },
                    {
                        x: 26.9, y: 67.1, width: 6.0, height: 9.6,
                        onClick() {
                            acquireItemOnce('foundSyrup', 'finalSyrup', 'ÂáÑ„Åù„ÅÜ„Å™„Ç∑„É≠„ÉÉ„Éó„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.finalSyrup, 'ÂáÑ„Åù„ÅÜ„Å™„Ç∑„É≠„ÉÉ„Éó„ÇíÊâã„Å´ÂÖ•„Çå„Åü');

                        },
                        description: 'ÊúÄÂæå„ÅÆ„Ç∑„É≠„ÉÉ„Éó',
                        zIndex: 5,
                        usable: () => !gameState.main.flags.foundSyrup,
                        item: { img: 'finalSyrup', visible: () => !gameState.main.flags.foundSyrup }
                    },
                    {
                        x: 35.7, y: 75.0, width: 11.1, height: 8.4,
                        onClick() {
                            showObj('foundMemo', '„É°„É¢„Å†', IMAGES.modals.memo, '„É°„É¢„Å†');
                        },
                        description: 'Â∫ó‰∏ª„ÅÆ„É°„É¢',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'memo', visible: () => true }
                    },
                    {
                        x: 83.8, y: 85.6, width: 14.6, height: 11.8,
                        onClick() {
                            showObj(null, 'Êñ∞ËÅûË®ò‰∫ã„Å†', IMAGES.items.newspaper, '„ÉØ„Éã„Ç∞„É´„Éº„Éó„ÅåÊã°Â§ß‰∏≠„Å®„ÅÑ„ÅÜÂÜÖÂÆπ„Å†');

                        },
                        description: 'Êñ∞ËÅû',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'newspaper', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('nowDoor');
                        },
                        description: '„Ç´„Ç¶„É≥„Çø„ÉºÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            // trueNow
            trueNowDoor: {
                name: 'Áèæ‰ª£„ÅÆ„Éê„Éº',
                description: '„Éâ„Ç¢„Åå„ÅÇ„Çã',
                clickableAreas: [
                    {
                        x: 36.3, y: 37.8, width: 26.0, height: 37.3,
                        onClick() {
                            showModal(
                                'Â§ñ„Å´Âá∫„Åæ„Åô„ÅãÔºü',
                                '',
                                [
                                    {
                                        text: '„ÅØ„ÅÑ',
                                        action: function () {

                                            closeModal();
                                            travelWithStepsTrueEnd();


                                        }
                                    },
                                    {
                                        text: '„ÅÑ„ÅÑ„Åà',
                                        action: function () {
                                            closeModal();
                                        }
                                    }
                                ],
                                null,
                                { columnButtons: true } // „Éú„Çø„É≥Á∏¶‰∏¶„Å≥
                            );

                        },
                        description: 'Ëá™Âãï„Éâ„Ç¢',

                    },
                    {
                        x: 82.1, y: 51.8, width: 11.7, height: 7.4,
                        onClick() {
                            showObj(null, '', IMAGES.modals.userVoice, '„É¶„Éº„Ç∂„Éº„ÅÆÂ£∞„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã');

                        },
                        description: '„Éâ„Ç¢Âè≥„Çø„Éñ„É¨„ÉÉ„Éà',

                    },
                    {
                        x: 79.6, y: 33.1, width: 13.4, height: 13.4,
                        onClick() {
                            showObj(null, '', IMAGES.items.posterWani, '„ÉØ„Éã„Ç∞„É´„Éº„Éó„ÅÆ„Éù„Çπ„Çø„Éº„Å†');

                        },
                        description: '„ÉØ„Éã„Éù„Çπ„Çø„Éº',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'posterWani', visible: () => true }
                    },
                    {
                        x: 8.8, y: 48.6, width: 9.8, height: 14.5,
                        onClick() {
                            updateMessage('„Ç¢„É´„Ç≥„Éº„É´Ê∂àÊØíË®≠ÂÇô„Å†');
                        },
                        description: '„Ç¢„É´„Ç≥„Éº„É´Ê∂àÊØí',

                    },

                    {
                        x: 0, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('trueNowCounter');
                        },
                        description: '„Éâ„Ç¢Èù¢ÔºöÂ∑¶', zIndex: 5,
                        item: { img: 'arrowLeft', visible: () => true }
                    },

                ]
            },
            trueNowCounter: {
                name: '„Éê„Éº',
                description: '',
                clickableAreas: [
                    {
                        x: 4.7, y: 26.1, width: 92.2, height: 47.6,
                        onClick() {
                            updateMessage('Ëñ¨„ÅÆ„Çà„ÅÜ„Å™„Éú„Éà„É´„Åå„Åü„Åè„Åï„Çì‰∏¶„Çì„Åß„ÅÑ„Çã');

                        },
                        description: '„Ç®„É™„ÇØ„Çµ„Éº„ÅÆÊ£ö',
                    },
                    {
                        x: 75.3, y: 75.0, width: 17.4, height: 14.7,
                        onClick() {
                            if (gameState.main.flags.usableCoupon && !gameState.main.flags.unlockTablet) {
                                showTabletPuzzle();
                            } else if (gameState.main.flags.usableCoupon && gameState.main.flags.unlockTablet) {
                                showObj(null, '', IMAGES.modals.randing, '„ÇÇ„ÅÜ„ÇØ„Éº„Éù„É≥„Ç≥„Éº„Éâ„ÅØ‰Ωø„Åà„Å™„ÅÑ„Çà„ÅÜ„Å†');
                            } else {
                                showObj(null, '', IMAGES.modals.randing, 'Ê≥®ÊñáÁ´ØÊú´„ÅÆ„Çà„ÅÜ„Å†');
                            }

                        },
                        description: '„Ç´„Ç¶„É≥„Çø„Éº„Çø„Éñ„É¨„ÉÉ„Éà',
                        zIndex: 5,
                    },
                    {
                        x: 16.5, y: 60.8, width: 20.0, height: 21.5,
                        onClick() {
                            updateMessage('Âàù‰ª£Áô∫ÊòéËÄÖ„ÅÆÂÉè„Çâ„Åó„ÅÑ');

                        },
                        description: 'ÂÉè',
                        zIndex: 5,
                        usable: () => true,
                        item: { img: 'statue', visible: () => true }
                    },
                    {
                        x: 93.6, y: 50.6, width: 6.4, height: 6.4,
                        onClick() {
                            changeRoom('trueNowDoor');
                        },
                        description: '„Ç´„Ç¶„É≥„Çø„ÉºÔºöÂè≥', zIndex: 5,
                        item: { img: 'arrowRight', visible: () => true }
                    },
                ]
            },
            end: {
                name: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ',
                description: 'ÁÑ°‰∫ã„Å´„Éê„Éº„Åã„ÇâËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick() {
                            showEndingReport('end');
                        },
                        description: '„Éé„Éº„Éû„É´„Ç®„É≥„Éâ'
                    },
                ]
            },
            trueEnd: {
                name: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                description: '„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÁÑ°‰∫ã„Å´ËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü„ÄÇ„ÄêÁß∞Âè∑ÔºöÊ≠¥Âè≤„ÅÆÊîπÂ§âËÄÖ„Äë',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick() {
                            showEndingReport('trueEnd');
                        },
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ',
                        usable: () => gameState.trueEnd.flags.backgroundState == 0,

                    },

                ]
            },
            trueEndPlus: {
                name: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ+',
                description: '„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÁÑ°‰∫ã„Å´ËÑ±Âá∫„ÄÅÁèæ‰ª£„ÅÆ„Ç®„É™„ÇØ„Çµ„Éº„ÇÇGETÔºÅ„ÄêÁß∞Âè∑Ôºö‰∏ñÁïåÁ∑ö„ÅÆÈÜ∏ÈÄ†ËÄÖ„Äë',
                clickableAreas: [
                    {
                        x: 0, y: 0, width: 100, height: 100,
                        onClick() {
                            showEndingReport('trueEndPlus');
                        },
                        description: '„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ+',

                    },

                ]
            },

        };

        const hintMessages = {
            counter: {
                piyoNormal: [
                    'ËâØ„Åã„Å£„Åü„Éî„É®„ÄÇ„ÅàÔºü„Åä„Å§„Åæ„ÅøÔºü',
                    '„Éë„É≥„Åó„Åã„Å™„ÅÑ„Éî„É®',
                    'Êåü„ÇÄ„ÇÇ„ÅÆ„Åå„ÅÇ„Çå„Å∞‚Ä¶',
                ]
            },

            tresureHouse: {
                bear: [
                    '„Åä„ÅØ„Çà„ÅÜ',
                    '„Åà„Å∏„Å∏',
                    '„ÅàÔºü„Éü„Ç§„É©Ôºü',
                ],
                bearMummy: [
                    '„ÇØ„Éû„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢„ÅÆ„Éü„Ç§„É©„Å†',
                    '„Åº„Çì„ÇÑ„Çä„Åó„Å¶„ÅÑ„Çã',
                ],
            },
        };

        function timeSlipToNowDoor() {

            const overlay = document.getElementById('roomEffectOverlay');
            const to = gameState.flags.trueEndUnlocked ? 'trueNowDoor' : 'nowDoor';

            // ÊôÇÈñìÁßªÂãï„Å£„ÅΩ„ÅÑSE
            try {
                playSE('se-fanta');
            } catch (e) { }

            if (!overlay) {
                // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÅåÁÑ°„ÅÑÂ†¥Âêà„ÅØÁ¥†Áõ¥„Å´ÈÅ∑Áßª
                changeRoom('nowDoor');
                return;
            }

            // „ÉØ„Éº„ÉóÊºîÂá∫ON
            overlay.classList.add('warp-active');
            overlay.style.opacity = 1;

            // Â∞ë„Åó„Å†„Åë„ÄåÊ∫ú„ÇÅ„Äç„Å¶„Åã„ÇâÈÉ®Â±ãÂ§âÊõ¥
            setTimeout(() => {
                changeRoom(to);

                // ÊºîÂá∫ÁµÇ‰∫ÜÂæå„Å´„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÊ∂à„Åô
                setTimeout(() => {
                    overlay.classList.remove('warp-active');
                    overlay.style.opacity = 0;
                }, 900); // warpFlash „Å®Âêå„ÅòÈï∑„Åï
            }, 500);
        }

        function returnToPast() {
            const prev = gameState.main.flags.returnRoom || 'door';

            const overlay = document.getElementById('roomEffectOverlay');

            // SE
            try { playSE('se-fanta'); } catch (e) { }

            // ÊºîÂá∫
            if (overlay) {
                overlay.classList.add('warp-active');
                overlay.style.opacity = 1;

                setTimeout(() => {
                    changeRoom(prev);

                    // ‰ΩôÈüª„ÇíÊÆã„Åó„Å¶Ê∂à„Åô
                    setTimeout(() => {
                        overlay.classList.remove('warp-active');
                        overlay.style.opacity = 0;
                    }, 900);
                }, 300);
            } else {
                changeRoom(prev);
            }
        }

        // Ë∂≥Èü≥„ÅßÊï∞Ê≠©‚Üí„ÉØ„Éº„ÉóÊºîÂá∫‚ÜíÁõÆÁöÑ„ÅÆÈÉ®Â±ã„Å∏
        function travelWithSteps(destRoom = 'corridorRightRoom') {
            const canvasEl = document.getElementById('gameCanvas');
            const overlay = document.getElementById('roomEffectOverlay');

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-ashioto');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#000';  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;

                if (step >= 3) {
                    clearInterval(stepTimer);

                    if (overlay) {
                        changeRoom(destRoom);
                    }

                    setTimeout(() => {

                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            // overlay.style.background = '';
                            overlay.style.opacity = 0;

                        }

                    }, 100);
                }
            }, 160);
        }

        function travelWithStepsTrueEnd() {
            const overlay = document.getElementById('roomEffectOverlay');
            let destRoom = hasItem('elixirModern') ? 'trueEndPlus' : 'trueEnd';

            // Ë∂≥Èü≥„ÇíÈ≥¥„Çâ„Åô
            try {
                const se = document.getElementById('se-scene-change');
                if (se) { se.currentTime = 0; se.play(); }
            } catch (e) { }

            // ÁîªÈù¢„ÇíÈªí„Éï„Çß„Éº„Éâ„Å´
            if (overlay) {
                overlay.style.background = '#000';  // Èªí„Çπ„ÇØ„É™„Éº„É≥
                overlay.style.opacity = 1;          // „Åó„Å£„Åã„ÇäÈªí
            }

            let step = 0;
            const stepTimer = setInterval(() => {
                step++;


                if (step >= 3) {
                    clearInterval(stepTimer);

                    // Èªí‚Üí„ÉØ„Éº„ÉóÂÖâ„Å∏ÂàáÊõø
                    if (overlay) {
                        overlay.classList.add('warp-active');
                        changeRoom(destRoom);
                        overlay.style.background = '';   // warp „ÅÆÁôΩÁô∫ÂÖâ„Å´Êàª„Åô
                    }

                    setTimeout(() => {


                        // ÊºîÂá∫Âæå„Å´Á∂∫È∫ó„Å´Ê∂à„Åô
                        if (overlay) {
                            overlay.classList.remove('warp-active');
                            overlay.style.opacity = 0;
                        }

                    }, 900);
                }
            }, 260);
        }

        function quickBlackFade(duration = 300) {
            const fade = document.getElementById('roomEffectOverlay');
            if (!fade) return;

            // „Åæ„Åö‰∏ÄÁû¨„ÅßÈªí„Åè„Åô„Çã
            fade.style.background = '#000';
            fade.style.opacity = '1';

            // duration ms Âæå„Å´ÈÄèÊòé„Å∏Êàª„Åô
            setTimeout(() => {
                fade.style.opacity = '0';
            }, duration);
        }



        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            renderNavigation();
            changeRoom('door');
            updateMessage('Ê∞ó„Åå‰ªò„Åè„Å®„ÅÇ„Å™„Åü„ÅØ„Éê„Éº„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åó„Åü');

        }

        function findHitArea(x, y, clickableAreas, canvas) {
            // zIndexÈôçÈ†Ü„Åß
            const sorted = clickableAreas.slice().sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
            for (const area of sorted) {
                // ÂøÖË¶Å„Å™„ÇâusableÂà§ÂÆö„ÇÇ„Åì„Åì„Åß
                const usable = area.usable === undefined ? true :
                    (typeof area.usable === "function" ? area.usable() : area.usable);

                if (!usable) continue; // ‰Ωø„Åà„Å™„ÅÑ„Ç®„É™„Ç¢„ÅØÂà§ÂÆö„Åó„Å™„ÅÑ
                const ax = area.x / 100 * canvas.width;
                const ay = area.y / 100 * canvas.height;
                const aw = area.width / 100 * canvas.width;
                const ah = area.height / 100 * canvas.height;
                if (x >= ax && x <= ax + aw && y >= ay && y <= ay + ah) {
                    return area; // ÊúÄÂàù„Å´„Éí„ÉÉ„Éà„Åó„Åü„ÇÇ„ÅÆ„Å†„ÅëËøî„ÅôÔºÅ
                }
            }
            return null;
        }

        let hoveredAreaIndex = null;  // ‰ªähover„Åó„Å¶„Çã„Ç®„É™„Ç¢Ôºà„Å™„Åë„Çå„Å∞nullÔºâ
        canvas.addEventListener('mousemove', function (e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);
            const idx = area ? room.clickableAreas.indexOf(area) : null;
            if (hoveredAreaIndex !== idx) {
                hoveredAreaIndex = idx;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('mouseout', function () {
            if (hoveredAreaIndex !== null) {
                hoveredAreaIndex = null;
                renderCanvasRoom();
            }
        });

        canvas.addEventListener('click', function (e) {

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // ‚òÖ‰ªä„ÅÑ„ÇãÈÉ®Â±ã„ÅÆ„Ç®„É™„Ç¢„Å†„ÅëÂà§ÂÆöÔºÅ
            const room = rooms[gameState.currentRoom];
            const area = findHitArea(x, y, room.clickableAreas, canvas);

            // if (area) {
            //     handleAreaClick(area.action, e);
            // }
            if (area) {
                if (typeof area.onClick === 'function') {
                    area.onClick(e);
                    playSE('se-click');
                } else if (area.action) {
                    handleAreaClick(area.action, e); // ‰∫íÊèõ„ÅÆ„Åü„ÇÅ„Å´ÊÆã„Åó„Å¶„ÇÇOK
                }
            }



        });

        function changeRoom(roomId) {
            gameState.currentRoom = roomId;
            const room = rooms[roomId];

            // ËÉåÊôØÔºã„Ç¢„Ç§„ÉÜ„É†Ôºã„ÇØ„É™„ÉÉ„ÇØ„Ç®„É™„Ç¢„Çícanvas„ÅßÂÖ®ÈÉ®ÂÜçÊèèÁîª
            renderCanvasRoom();
            const msg = (room.name && room.name.trim() !== "")
                ? `${room.name}„Åß„Åô„ÄÇ${room.description}`
                : room.description;
            if (roomId === 'trueEnd') {
                updateMessageHTML(msg);
            } else {
                updateMessage(msg);
            }

            // BGMÂàáÊõø„ÅØ„Åù„ÅÆ„Åæ„Åæ
            if (roomId === "trueEnd" || roomId === "trueEndPlus") {
                changeBGM("sounds/21/White_Philosophy.mp3");

            } else if (roomId === "end") {
                changeBGM("sounds/21/Nakazaki-cho.mp3");

            } else if (roomId === "nowDoor" || roomId === "nowCounter") {
                changeBGM("sounds/21/ruins.mp3");

            } else if (roomId === "trueNowDoor" || roomId === "trueNowCounter") {
                changeBGM("sounds/21/nineteen_ui.mp3");

            } else {
                changeBGM("sounds/21/atedonaku_samayou_yoru.mp3");
            }

            // nav
            if (roomId === "corridorEntrance") {
                addNaviItem('corridorEntrance');
                // renderNavigation();
            } else if (roomId === "entrance") {
                addNaviItem('entrance');
                // renderNavigation();
            } else if (roomId === "tresureHouse") {
                addNaviItem('tresureHouse');
                // renderNavigation();
            } else if (roomId === "trueEnd" || roomId === "end" || roomId === "end2") {
                gameState.openRooms = [];
                // renderNavigation();
            }

            renderNavigation();
            if (roomId !== 'record' && recordSpinTimer) {
                clearInterval(recordSpinTimer);
                recordSpinTimer = null;
                if (gameState.record && gameState.record.flags) {
                    gameState.record.flags.backgroundState = 0;
                }
            }

        }

        const END_IDS = new Set(['end', 'trueEnd', 'trueEndPlus']);

        // ===== changeRoom „Éï„ÉÉ„ÇØÔºö=====
        const _changeRoom_custom = changeRoom;
        changeRoom = function (roomId) {
            _changeRoom_custom.apply(this, arguments);


            if (END_IDS.has(roomId)) {
                const elapsed = Math.round((Date.now() - ANA.start) / 1000);
                ANA.endTimes = ANA.endTimes || {};
                if (!ANA.endTimes[roomId]) ANA.endTimes[roomId] = elapsed;

                const isTrue = (roomId === 'trueEnd');
                ANA.send('ending_reached', {
                    ending_id: roomId,
                    is_true: isTrue,
                    elapsed_sec: elapsed,
                    hints: ANA.hintCount,

                });
                // setTimeout(() => showFeedbackModal(roomId), 1500);
            }
        };

        function renderCanvasRoom() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const roomId = gameState.currentRoom;
            const room = rooms[roomId];
            const bgImgSrc = getRoomBackgroundImage(roomId, gameState);

            ctx.clearRect(0, 0, canvas.width, canvas.height);


            // ËÉåÊôØÊèèÁîª
            const bgImg = loadedImages[bgImgSrc];
            if (bgImg && bgImg.complete) {
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            }

            // „Ç¢„Ç§„ÉÜ„É†ÊèèÁîªÔºàÊú™ÂèñÂæó„ÅÆ„ÅøÔºâ
            drawRoomItems(ctx, canvas, roomId);

            // ‚òÖ „Åì„Åì„Åã„ÇâÈáç„Å™„ÇäÂÑ™ÂÖà„ÅÆhoverÊû†Á∑ö„ÇíÊèèÁîª
            if (hoveredAreaIndex !== null && hoveredAreaIndex !== undefined) {
                // zIndexÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
                const sortedAreas = room.clickableAreas
                    .map((area, i) => ({ ...area, __idx: i }))
                    .filter(area => area.usable === undefined ? true :
                        (typeof area.usable === "function" ? area.usable() : area.usable)
                    )
                    .sort((a, b) => (b.zIndex || 0) - (a.zIndex || 0));
                // hoveredAreaIndex„Å®‰∏ÄËá¥„Åô„Çã„Ç®„É™„Ç¢„ÇízIndexÈ†Ü„Åß1„Å§„Å†„ÅëÊû†ÊèèÁîª
                const hoverArea = sortedAreas.find(area => area.__idx === hoveredAreaIndex);
                if (hoverArea) {
                    const ax = hoverArea.x / 100 * canvas.width;
                    const ay = hoverArea.y / 100 * canvas.height;
                    const aw = hoverArea.width / 100 * canvas.width;
                    const ah = hoverArea.height / 100 * canvas.height;
                    ctx.save();
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(ax, ay, aw, ah);
                    ctx.restore();
                }
            }

            if (DEV_MODE) {
                ctx.save();
                ctx.lineWidth = 2;


                room.clickableAreas.forEach(a => {

                    ctx.strokeStyle = 'rgba(255,0,0,0.8)';
                    ctx.fillStyle = 'rgba(255,0,0,0.35)';
                    ctx.font = '14px sans-serif';
                    const px = a.x / 100 * canvas.width;
                    const py = a.y / 100 * canvas.height;
                    const pw = a.width / 100 * canvas.width;
                    const ph = a.height / 100 * canvas.height;

                    // ÂçäÈÄèÊòé„ÅÆÊû†
                    ctx.fillRect(px, py, pw, ph);
                    ctx.strokeRect(px, py, pw, ph);

                    // description Ë°®Á§∫
                    if (a.description) {
                        ctx.fillStyle = 'rgba(0,0,0,0.7)';
                        ctx.fillRect(px, py - 18, ctx.measureText(a.description).width + 8, 18);

                        ctx.fillStyle = 'white';
                        ctx.fillText(a.description, px + 4, py - 4);
                    }
                });

                ctx.restore();
            }





        }

        function drawRoomItems(ctx, canvas, roomId) {
            const room = rooms[roomId];
            room.clickableAreas.forEach(area => {
                if (area.item && area.item.visible && area.item.visible()) {
                    const key = (typeof area.item.img === 'function') ? area.item.img() : area.item.img;
                    const img = loadedImages[IMAGES.items[key]];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const alpha = area.alpha ? area.alpha : 1;
                        const px = area.x / 100 * canvas.width;
                        const py = area.y / 100 * canvas.height;
                        const w = area.width / 100 * canvas.width;
                        const h = area.height / 100 * canvas.height;
                        ctx.save();
                        ctx.globalAlpha = alpha;
                        ctx.drawImage(img, px, py, w, h);
                        ctx.restore();
                    }
                }
            });
        }


        function getRoomBackgroundImage(roomId, gameState) {
            let state = gameState[roomId]?.flags?.backgroundState || 0;
            let imgList = IMAGES.rooms[roomId];
            if (Array.isArray(imgList)) {
                return imgList[state] || imgList[0];
            } else {
                return imgList;
            }
        }

        // Â∞èÁâ©„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function pointInRect(x, y, r) {
            return x >= r.x && x <= r.x + r.w && y >= r.y && y <= r.y + r.h;
        }

        function roundRect(ctx, x, y, w, h, r, fill, stroke) {
            if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
            ctx.beginPath();
            ctx.moveTo(x + r.tl, y);
            ctx.lineTo(x + w - r.tr, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
            ctx.lineTo(x + w, y + h - r.br);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
            ctx.lineTo(x + r.bl, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
            ctx.lineTo(x, y + r.tl);
            ctx.quadraticCurveTo(x, y, x + r.tl, y);
            ctx.closePath();
            if (fill) ctx.fill();
            if (stroke) ctx.stroke();
        }

        // „Éï„É©„ÉÉ„Ç∑„É•„É¨„Ç§„É§„ÇíÁî®ÊÑè
        (function ensureFlashLayer() {
            if (!document.getElementById('fxFlash')) {
                const d = document.createElement('div');
                d.id = 'fxFlash';
                document.body.appendChild(d);
            }
        })();

        // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•Ôºàtype: 'white' | 'red'Ôºâ
        function screenFlash(type = 'white', durMs = 180) {
            const f = document.getElementById('fxFlash'); if (!f) return;
            f.style.animation = 'none'; // ÈÄ£ÊâìÂØæÁ≠ñ
            // Âº∑Âà∂reflow„Åß„Ç¢„Éã„É°ÂÜçÈÅ©Áî®
            // eslint-disable-next-line no-unused-expressions
            f.offsetHeight;
            const key = type === 'red' ? 'flashRed' : 'flashWhite';
            f.style.animation = `${key} ${durMs}ms ease`;
            // „Éö„Éº„Ç∏ÂÖ®‰Ωì„ÇíÊ•µÂ∞è„Ç∑„Çß„Ç§„ÇØ
            document.documentElement.classList.add('fx-shake');
            setTimeout(() => document.documentElement.classList.remove('fx-shake'), 120);
        }

        function _cycle1to9(v) { return v >= 9 ? 1 : (v + 1); }

        function acquireItemOnce(flagKey, itemId, title, imgSrc, msg) {
            const f = gameState.main.flags;
            if (f[flagKey]) {
                if (itemId == 'glass') {
                    updateMessage('„Ç∞„É©„Çπ„ÅåÊ≤¢Â±±„ÅÇ„Çã');
                } else {
                    updateMessage('„ÇÇ„ÅÜ‰Ωï„ÇÇ„Å™„ÅÑ');
                }

                return;
            }
            f[flagKey] = true;
            addItem(itemId);
            renderCanvasRoom();

            showModal(
                title,
                `<img src="${imgSrc}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );
            updateMessage(msg);
        }

        // „Ç¢„ÇØ„Ç∑„Éß„É≥Âêç ‚Üí ÂÆüË°åÈñ¢Êï∞
        const ACTION_HANDLERS = {
            // --- ÁßªÂãïÁ≥ª ---
            examine_start_door_left() {
                changeRoom('startRight');
            },

        };

        // „Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleAreaClick(action, event) {
            const handler = ACTION_HANDLERS[action];
            playSE('se-click');

            // area.onClick ÊñπÂºèÔºàÂ∞ÜÊù•„ÅÆ„Åü„ÇÅÔºâ
            if (typeof action === 'function') {
                action(event);
                return;
            }

            // actionÂêçÔºàÂæìÊù•„ÅÆÊñπÂºèÔºâ„Å´„ÇÇÂØæÂøú
            const fn = ACTION_HANDLERS[action];
            if (fn) {
                fn(event);
                return;
            }
            console.warn('Êú™ÂÆöÁæ©„ÅÆaction:', action);
        }



        function showEndingReport(endingId) {
            const ana = window.ANA || {};
            const sec = Math.max(
                1,
                (ana.endTimes && ana.endTimes[endingId]) ||
                Math.round((Date.now() - (ana.start || Date.now())) / 1000)
            );
            const mm = String(Math.floor(sec / 60)).padStart(2, "0");
            const ss = String(sec % 60).padStart(2, "0");

            // ‰ªä‰ΩúÁî®„Ç®„É≥„ÉâÊÉÖÂ†±
            const ENDING_INFO = {
                trueEnd: {
                    title: "üåü TRUE END",
                    label: "TRUE END",
                    desc: "ÈÅéÂéª„ÅÆ„Éê„Éº„Åã„ÇâÁâ©Ë™û„ÅØÁπã„Åå„Çä„ÄÅÁèæ‰ª£„ÅÆ„Ç®„É™„ÇØ„Çµ„Éº„Ç∑„Éß„ÉÉ„Éó„Å∏„Å®„Åü„Å©„ÇäÁùÄ„ÅÑ„Åü„ÄÇ"
                },
                end: {
                    title: "üîî NORMAL END",
                    label: "NORMAL END",
                    desc: "‰∏çÊÄùË≠∞„Å™ÊôÇ‰ª£„ÅÆ„Éê„Éº„Åã„ÇâÁÑ°‰∫ãËÑ±Âá∫„Åß„Åç„Åæ„Åó„Åü"
                },
                trueEndPlus: {
                    title: "üåü TRUE END+",
                    label: "TRUE END+",
                    desc: "Áèæ‰ª£„ÅÆ„Ç®„É™„ÇØ„Çµ„Éº„ÇÇÊâã„Å´„Åó„ÅüÂº∑ËÄÖ"
                }
            };

            const info = ENDING_INFO[endingId] || {
                title: "‚≠ê END",
                label: "END",
                desc: ""
            };

            // „ÄåË¶ã„Çã„Éï„É©„Ç∞„ÄçÔºù Ëá≥È´ò„ÅÆ‰∏ÄÊùØ„ÇíÂÆåÊàê„Åï„Åõ„Åü„Åã„Å©„ÅÜ„Åã
            const flags = (window.gameState && gameState.main && gameState.main.flags) || {};
            const usableCoupon = !!gameState.main.flags.usableCoupon;

            const secretText = usableCoupon
                ? "üëë „ÉØ„Éã„Å´Ê≠£„Åó„ÅèÊèê‰æõÔºöÊ¨≤„Åó„Åå„Å£„Å¶„Çã„Éâ„É™„É≥„ÇØ„Çí„ÅÇ„Åí„Åü"
                : "‚ùì „ÉØ„Éã„Å´ÈÅï„ÅÜ„Éâ„É™„É≥„ÇØ„ÇíÊèê‰æõÔºöÊ∫ÄË∂≥„Åó„Å¶„Åè„Çå„Åü„Åã„Å™Ôºü";

            const html = `
        <div style="text-align:left;max-width:560px">
            <div style="font-size:1.4em;margin-bottom:12px">${info.title}</div>
            <div style="border:1px solid #d4af37;border-radius:10px;padding:12px;background:rgba(0,0,0,0.35)">
                <div style="margin:4px 0">‚è± „ÇØ„É™„Ç¢ÊôÇÈñìÔºö<b>${mm}:${ss}</b></div>
                <div style="margin:4px 0">üè∑ „Ç®„É≥„Éá„Ç£„É≥„Ç∞Ôºö<b>${info.label}</b></div>
                <div style="margin:8px 0 0 0">üìñ Ê¶ÇË¶ÅÔºö<br>${info.desc}</div>
                <div style="margin:8px 0 0 0">${secretText}</div>
            </div>
        </div>
    `;

            showModal("", html, [
                { text: "ÊÑüÊÉ≥„Éï„Ç©„Éº„É†„ÇíÈñã„Åè", action: () => openFeedbackForm(endingId) },
                { text: "Èñâ„Åò„Çã", action: "close" },
            ]);
        }



        const FEEDBACK_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeimx9XGTB5cKAVybcgXbHUdJQ5vwOHTWMK64ZqR0hJ_Wnwlw/viewform?";
        const FORM_FIELDS = {
            ending: 'entry.666725843',

        };

        function openFeedbackForm(endingId) {
            // Ë°®Á§∫ÂêçÔºà‰ªä‰Ωú„ÅÆ„Ç®„É≥„ÉâID„Å´ÂØæÂøúÔºöÂøÖË¶ÅÂàÜ„Å†„ÅëÔºâ
            const endingLabel = ({
                trueEnd: "„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ",
                end: "„Éé„Éº„Éû„É´„Ç®„É≥„Éâ",
                trueEndPlus: "„Éà„Ç•„É´„Éº„Ç®„É≥„Éâ+",
            })[endingId] || "„Ç®„É≥„Éâ";

            // „ÇØ„É™„Ç¢ÊôÇÈñì(Áßí)„ÅØ ANA.endTimes „Åã„Çâ„ÄÅÁÑ°„Åë„Çå„Å∞ÈñãÂßãÊôÇÂàª„Åã„ÇâÁÆóÂá∫
            const ana = window.ANA || {};
            const elapsedSec = Math.max(
                1,
                (ana.endTimes && ana.endTimes[endingId]) ||
                Math.round((Date.now() - (ana.start || Date.now())) / 1000)
            );

            // „Éë„É©„É°„Éº„ÇøÁµÑ„ÅøÁ´ã„Å¶ÔºàÂÆöÁæ©„Åï„Çå„Å¶„ÇãÈ†ÖÁõÆ„Å†„ÅëË©∞„ÇÅ„ÇãÔºâ
            const params = new URLSearchParams();
            params.set("usp", "pp_url");
            if (FORM_FIELDS.ending && endingLabel)
                params.set(FORM_FIELDS.ending, endingLabel);
            if (FORM_FIELDS.elapsed_sec)
                params.set(FORM_FIELDS.elapsed_sec, String(elapsedSec));
            if (FORM_FIELDS.ending_id)
                params.set(FORM_FIELDS.ending_id, endingId);

            // Êñ∞Ë¶è„Çø„Éñ„Åß„Éï„Ç©„Éº„É†„ÇíÈñã„Åè
            window.open(`${FEEDBACK_URL}${params.toString()}`, "_blank", "noopener,noreferrer");
        }


        function talkToHintCharacter(roomId, charId) {
            // flagsÂèñÂæó
            let flags = gameState[roomId].flags;
            // „Åæ„Å†„Ç´„Ç¶„É≥„ÉàÁÑ°„Åë„Çå„Å∞ÂàùÊúüÂåñ
            if (!flags.talkTo) flags.talkTo = {};
            if (!flags.talkTo[charId]) flags.talkTo[charId] = 0;

            // „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            flags.talkTo[charId]++;

            // „Çª„É™„Éï„É™„Çπ„ÉàÂèñÂæó
            const messages = hintMessages[roomId][charId];
            if (roomId == 'main' && charId == 'bear' && flags.talkTo[charId] == 3) {
                gameState.main.flags.canRemovePoster = true;
            }
            // ÁØÑÂõ≤Â§ñ„Å™„ÇâÊúÄÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            const idx = (flags.talkTo[charId] - 1) % messages.length;
            console.log(flags.talkTo[charId]);

            // Ë°®Á§∫
            updateMessage(messages[idx]);
        }

        // „Çµ„Ç§„Éâ„Éú„Éº„ÉâÂ∑¶„ÉªËâ≤„Éë„Ç∫„É´ ===============================

        const SIDEBOARD_LEFT_COLORS = [
            '#ffffff',  // ÁôΩ
            '#833c10',  // Ëå∂
            '#808080',  // „Ç∞„É¨„Éº
            '#e0d8b1',  // „Éô„Éº„Ç∏„É•
            '#ff914d',  // „Ç™„É¨„É≥„Ç∏
            '#4f8467'   // „Ç∞„É™„Éº„É≥
        ];

        // Â∑¶‰∏ä„ÉªÂè≥‰∏ä„ÉªÂ∑¶‰∏ã„ÉªÂè≥‰∏ã „ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        let sideboardLeftState = [0, 0, 0, 0];

        function showSideboardLeftPuzzle() {
            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„É°„ÉÉ„Çª„Éº„Ç∏„Å†„Åë
            if (gameState.main.flags.unlockSideboardLeft) {
                changeRoom('sideboardLeft');
                return;
            }

            // ÂàùÊúüÁä∂ÊÖã„É™„Çª„ÉÉ„ÉàÔºàÂÖ®ÈÉ® #fffÔºâ
            sideboardLeftState = [0, 0, 0, 0];

            const modalContent = `
        <h3>„Çµ„Ç§„Éâ„Éú„Éº„Éâ„ÅÆ„É≠„ÉÉ„ÇØ„Å†</h3>
        <div id="sideboardLeftGrid" style="
            display:grid;
            grid-template-columns: repeat(2, minmax(60px,90px));
            gap:12px;
            justify-content:center;
            margin:16px auto 8px;
        ">
            ${[0, 1, 2, 3].map(i => `
                <div id="sbCell${i}" onclick="cycleSideboardLeftColor(${i})" style="
                    width:80px;height:80px;
                    border-radius:10px;
                    border:2px solid #d4af37;
                    background:${SIDEBOARD_LEFT_COLORS[0]};
                    box-shadow:0 3px 10px rgba(0,0,0,0.35),
                               inset 0 2px 4px rgba(255,255,255,0.35);
                    cursor:pointer;
                "></div>
            `).join('')}
        </div>
        <p id="sbMessage" style="text-align:center;min-height:1.2em;margin-top:4px;font-size:0.9rem;"></p>
        <div style="text-align:center;margin-top:8px;">
            <button onclick="checkSideboardLeftSolved()" class="text-btn">OK</button>
            <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
        </div>
    `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }


        function cycleSideboardLeftColor(index) {
            sideboardLeftState[index] =
                (sideboardLeftState[index] + 1) % SIDEBOARD_LEFT_COLORS.length;

            const cell = document.getElementById('sbCell' + index);
            if (cell) {
                cell.style.background = SIDEBOARD_LEFT_COLORS[sideboardLeftState[index]];
            }
            // „Åì„Åì„Åß„ÅØÂà§ÂÆö„Åó„Å™„ÅÑÔºàOK„Éú„Çø„É≥„ÅßÂà§ÂÆöÔºâ
        }


        // Ê≠£Ëß£Âà§ÂÆöÔºöTL, TR, BL, BR = #4f8467, #ff914d, #e0d8b1, #833c10
        function checkSideboardLeftSolved() {
            // SIDEBOARD_LEFT_COLORS „ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å´Â§âÊèõ„Åô„Çã„Å®Ôºö
            // #4f8467 ‚Üí 5, #ff914d ‚Üí 4, #e0d8b1 ‚Üí 3, #833c10 ‚Üí 1
            const correct = [5, 4, 3, 1];

            const ok = correct.every((v, i) => sideboardLeftState[i] === v);
            const msg = document.getElementById('sbMessage');

            if (!ok) {
                if (msg) {
                    msg.textContent = '‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                }
                if (typeof playSE === 'function') {
                    playSE('se-error');
                }
                return;
            }

            // Ê≠£Ëß£ÊôÇÂá¶ÁêÜ
            gameState.main.flags.unlockSideboardLeft = true;
            if (typeof markProgress === 'function') {
                markProgress('sideboard_left_unlock_21');
            }

            if (typeof playSE === 'function') {
                playSE('se-clear');
            }

            closeModal();

            showModal(
                '„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü',
                '„Ç´„ÉÅ„É™„Å®Èü≥„Åå„Åó„Åü„ÄÇ',
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );

            renderCanvasRoom();
        }

        // Âºï„ÅçÂá∫„Åó‰∏äÊÆµ„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showDrawer1Puzzle() {
            const modalContent = `
                <h3>Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØÈÉ®ÂàÜ„Å†</h3>
                <input type="text" class="puzzle-input" id="drawer1Input" placeholder="Ëã±Â≠ó">
                <br>
                <button onclick="checkDrawer1Puzzle()">OK</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // Âºï„ÅçÂá∫„Åó‰∏äÊÆµ„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkDrawer1Puzzle() {
            const v = document.getElementById('drawer1Input').value.trim();
            // ÂÖ®ËßíÂØæÁ≠ñ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === 'amber') {
                closeModal();
                gameState.main.flags.unlockDrawer1 = true;

                markProgress('drawer1_unlock_21');

                showModal(
                    'Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                playSE('se-clear');
                renderCanvasRoom();

            } else {
                playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }

        // Âºï„ÅçÂá∫„Åó‰∏ãÊÆµ„Éë„Ç∫„É´ÔºàË®òÂè∑Ôºâ ===============================

        const DRAWER2_SYMBOLS = ['‚óè', '‚ñ†', '‚ñº', '‚ô™', '‚ôØ', '‚ô≠', '‚òÖ'];
        let drawer2State = [-1, -1, -1]; // Â∑¶„Éª‰∏≠Â§Æ„ÉªÂè≥ÔºàÂàùÊúü„ÅØ„Äå‰Ωï„ÇÇË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÄçÔºâ

        // Âºï„ÅçÂá∫„Åó‰∏ãÊÆµ„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showDrawer2Puzzle() {
            // „Åô„Åß„Å´„É≠„ÉÉ„ÇØËß£Èô§Ê∏à„Åø„Å™„Çâ
            if (gameState.main.flags.unlockDrawer2) {
                acquireItemOnce('foundCan', 'can', '„ÉÑ„ÉäÁº∂„ÇíË¶ã„Å§„Åë„Åü', IMAGES.items.can, '„ÉÑ„ÉäÁº∂„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                return;
            }

            // ÂàùÊúüÁä∂ÊÖã„É™„Çª„ÉÉ„ÉàÔºàÂÖ®ÈÉ®„Äå‰Ωï„ÇÇË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÄçÔºâ
            drawer2State = [-1, -1, -1];

            const modalContent = `
                <h3>Âºï„ÅçÂá∫„Åó‰∏ãÊÆµ„ÅÆ„É≠„ÉÉ„ÇØÈÉ®ÂàÜ„Å†</h3>
                <div style="
                    display:flex;
                    justify-content:center;
                    gap:8px;
                    margin:16px auto 8px;
                    max-width:320px;
                ">
                    <div id="drawer2Cell0"
                         onclick="cycleDrawer2Symbol(0)"
                         style="
                            flex:1;
                            max-width:90px;
                            height:120px;
                            background:#2b4f8c;
                            border-radius:10px;
                            box-shadow:0 3px 10px rgba(0,0,0,0.35),
                                       inset 0 2px 4px rgba(255,255,255,0.35);
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            font-size:2.2rem;
                            color:#ffffff;
                            cursor:pointer;
                         "></div>
                    <div id="drawer2Cell1"
                         onclick="cycleDrawer2Symbol(1)"
                         style="
                            flex:1;
                            max-width:90px;
                            height:120px;
                            background:#8b2626;
                            border-radius:10px;
                            box-shadow:0 3px 10px rgba(0,0,0,0.35),
                                       inset 0 2px 4px rgba(255,255,255,0.35);
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            font-size:2.2rem;
                            color:#ffffff;
                            cursor:pointer;
                         "></div>
                    <div id="drawer2Cell2"
                         onclick="cycleDrawer2Symbol(2)"
                         style="
                            flex:1;
                            max-width:90px;
                            height:120px;
                            background:#2c6b3a;
                            border-radius:10px;
                            box-shadow:0 3px 10px rgba(0,0,0,0.35),
                                       inset 0 2px 4px rgba(255,255,255,0.35);
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            font-size:2.2rem;
                            color:#ffffff;
                            cursor:pointer;
                         "></div>
                </div>
                <p id="drawer2Msg" style="text-align:center;min-height:1.2em;margin-top:4px;font-size:0.9rem;"></p>
                <div style="text-align:center;margin-top:8px;">
                    
                    <button onclick="checkDrawer2Puzzle()" class="text-btn">OK</button>
                    <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // Ë®òÂè∑„Çí„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥
        function cycleDrawer2Symbol(index) {
            const len = DRAWER2_SYMBOLS.length;
            let v = drawer2State[index];

            if (v === -1) {
                v = 0;           // ‰Ωï„ÇÇ„Å™„ÅÑÁä∂ÊÖã ‚Üí ÊúÄÂàù„ÅÆË®òÂè∑Ôºà‚óèÔºâ
            } else {
                v = (v + 1) % len;
            }

            drawer2State[index] = v;

            const cell = document.getElementById('drawer2Cell' + index);
            if (cell) {
                cell.textContent = DRAWER2_SYMBOLS[v];
            }

            if (typeof playSE === 'function') {
                playSE('se-click');
            }
        }


        // Ê≠£Ëß£Âà§ÂÆöÔºöÂ∑¶„Åã„Çâ ‚òÖ„ÄÅ‚ô™„ÄÅ‚ô≠
        function checkDrawer2Puzzle() {
            const target = ['‚òÖ', '‚ô™', '‚ô≠'];
            const msg = document.getElementById('drawer2Msg');

            const ok =
                drawer2State.length === 3 &&
                drawer2State.every((idx, i) =>
                    idx >= 0 && DRAWER2_SYMBOLS[idx] === target[i]
                );

            if (!ok) {
                if (msg) {
                    msg.textContent = '‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                }
                if (typeof playSE === 'function') {
                    playSE('se-error');
                }
                return;
            }

            // Ê≠£Ëß£ÊôÇÂá¶ÁêÜ
            closeModal();
            gameState.main.flags.unlockDrawer2 = true;

            if (typeof markProgress === 'function') {
                markProgress('drawer1_unlock_21');
            }

            if (typeof playSE === 'function') {
                playSE('se-clear');
            }

            showModal(
                'Âºï„ÅçÂá∫„Åó„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                '',
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );

            if (typeof renderCanvasRoom === 'function') {
                renderCanvasRoom();
            }
        }


        // „Çµ„Ç§„Éâ„Éú„Éº„ÉâÂè≥„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showSideboardRightPuzzle() {
            if (gameState.main.flags.unlockSideboardRight) {
                changeRoom('sideboardRight');
                return;
            }
            const modalContent = `
                <h3>Áï™Âè∑Âºè„É≠„ÉÉ„ÇØ„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Çã</h3>
                <input type="text" class="puzzle-input" id="sideboardRightInput" placeholder="Êï∞Â≠ó">
                <br>
                <button onclick="checkSideboardRightPuzzle()">OK</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // „Çµ„Ç§„Éâ„Éú„Éº„ÉâÂè≥„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkSideboardRightPuzzle() {
            const v = document.getElementById('sideboardRightInput').value.trim();
            // ÂÖ®ËßíÂØæÁ≠ñ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === '1225') {
                closeModal();
                gameState.main.flags.unlockSideboardRight = true;

                markProgress('sideboard_right_unlock_21');

                showModal(
                    '„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                playSE('se-clear');
                renderCanvasRoom();

            } else {
                playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }

        // „Çµ„Ç§„Éâ„Éú„Éº„Éâ‰∏≠‰∏äÔºöÁõ¥Êé•ÂÖ•Âäõ„ÅÆÊôÇË®à„Éë„Ç∫„É´ =====================

        function showSideboardCenterTopPuzzle() {
            // Êó¢„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„Åù„ÅÆÊó®„Å†„Åë
            if (gameState.main.flags.unlockSideboardCenterTop) {
                acquireItemOnce('foundPic2', 'pic2', '‰Ωï„Åã„ÅÆ„Éë„Éº„ÉÑ„ÇíÊâã„Å´ÂÖ•„Çå„Åü', IMAGES.items.pic2, '‰Ωï„Åã„ÅÆ„Éë„Éº„ÉÑ„ÇíÊâã„Å´ÂÖ•„Çå„Åü');
                return;
            }

            const content = `
        <div style="
            display:flex;
            justify-content:center;
            align-items:center;
            gap:8px;
            margin:12px 0;
        ">
            <input id="sideboardHourInput"
                type="text"
                inputmode="numeric"
                maxlength="2"
                style="width:40px;padding:4px;text-align:center;font-size:1.2rem;">
            <span style="font-size:1.2rem;">:</span>
            <input id="sideboardMinuteInput"
                type="text"
                inputmode="numeric"
                maxlength="2"
                style="width:40px;padding:4px;text-align:center;font-size:1.2rem;">
        </div>
    `;

            showModal(
                'ÊôÇË®à„ÅÆ„É≠„ÉÉ„ÇØ',
                content,
                [
                    { text: 'OK', action: checkSideboardCenterTopInput },
                    { text: 'Èñâ„Åò„Çã', action: 'close' }
                ]
            );
        }

        function checkSideboardCenterTopInput() {
            const hourEl = document.getElementById('sideboardHourInput');
            const minEl = document.getElementById('sideboardMinuteInput');

            if (!hourEl || !minEl) {
                // ‰Ωï„Åã„Åä„Åã„Åó„Åã„Å£„Åü„Çâ„Å®„Çä„ÅÇ„Åà„ÅöÈñâ„Åò„Çã
                closeModal();
                return;
            }

            const hour = hourEl.value.trim();
            const minute = minEl.value.trim();

            // ‰∏°Êñπ„Äå10„Äç„ÅãÔºü
            const is1010 = (hour === '10' && minute === '10');

            if (!is1010) {
                closeModal();
                showModal(
                    'Èñã„Åã„Å™„ÅÑ',
                    '‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                if (typeof playSE === 'function') playSE('se-error');
                return;
            }

            // 10:10 „Å´„ÅØ„Å™„Å£„Å¶„ÅÑ„Çã ‚Üí putDecanter „Éï„É©„Ç∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (gameState.main.flags.putDecanter) {
                gameState.main.flags.unlockSideboardCenterTop = true;

                if (typeof playSE === 'function') playSE('se-clear');

                closeModal();
                showModal(
                    '„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü',
                    '„Ç´„ÉÅ„É™„Å®Èü≥„Åå„Åó„Åü„ÄÇ',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                updateMessage('„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü');

                if (typeof renderCanvasRoom === 'function') {
                    renderCanvasRoom();
                }
            } else {
                closeModal();
                showModal(
                    '?',
                    '„Å™„Å´„Åã„ÅåË∂≥„Çä„Å™„ÅÑ„Çà„ÅÜ„Å†‚Ä¶',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                updateMessage('„Å™„Å´„Åã„ÅåË∂≥„Çä„Å™„ÅÑ„Çà„ÅÜ„Å†‚Ä¶');
                if (typeof playSE === 'function') playSE('se-error');
            }
        }

        // „Ç≠„É£„Éì„Éç„ÉÉ„Éà„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showCabinetPuzzle() {
            if (!gameState.main.flags.setPic) {
                updateMessage('ÂèçÂøú„Åó„Å™„ÅÑ„Çà„ÅÜ„Å†');
                return;
            }
            // Êó¢„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„Åù„ÅÆÊó®„Å†„Åë
            if (gameState.main.flags.unlockCabinet) {
                changeRoom('cabinetInner');
                return;
            }
            const modalContent = `
                <h3>„Ç≠„É£„Éì„Éç„ÉÉ„Éà„ÅÆ„É≠„ÉÉ„ÇØÈÉ®ÂàÜ„Å†</h3>
                <img src="${IMAGES.modals.cabinetImg}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">
                <input type="text" class="puzzle-input" id="cabinetInput" placeholder="Ëã±Â≠ó">
                <br>
                <button onclick="checkCabinetPuzzle()">OK</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // „Ç≠„É£„Éì„Éç„ÉÉ„Éà„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkCabinetPuzzle() {
            const v = document.getElementById('cabinetInput').value.trim();
            // ÂÖ®ËßíÂØæÁ≠ñ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === 'time') {
                closeModal();
                gameState.main.flags.unlockCabinet = true;

                markProgress('cabinet_unlock_21');

                showModal(
                    'Êà∏Ê£ö„ÅÆ„É≠„ÉÉ„ÇØ„ÅåËß£Èô§„Åï„Çå„Åü',
                    '',
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                playSE('se-clear');
                renderCanvasRoom();

            } else {
                playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }

        // „Çø„Éñ„É¨„ÉÉ„Éà„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showTabletPuzzle() {

            // Êó¢„Å´Ëß£Èô§Ê∏à„Åø„Å™„Çâ„Åù„ÅÆÊó®„Å†„Åë
            if (gameState.main.flags.unlockTablet) {
                changeRoom('cabinetInner');
                return;
            }
            const modalContent = `
                <h3>„ÇØ„Éº„Éù„É≥„Ç≥„Éº„Éâ„ÅåÂÖ•Âäõ„Åß„Åç„Åù„ÅÜ„Å†</h3>
                <img src="${IMAGES.modals.randingCoupon}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">
                <input type="text" class="puzzle-input" id="tabletInput" placeholder="Ëã±Â≠ó">
                <br>
                <button onclick="checkTabletPuzzle()">OK</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // „Çø„Éñ„É¨„ÉÉ„Éà„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkTabletPuzzle() {
            const v = document.getElementById('tabletInput').value.trim();
            // ÂÖ®ËßíÂØæÁ≠ñ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === 'scale-1') {
                closeModal();
                gameState.main.flags.unlockTablet = true;

                markProgress('tablet_unlock_21');

                showModal(
                    '„É¢„ÉÄ„É≥„Ç®„É™„ÇØ„Çµ„Éº„ÇíÊâã„Å´ÂÖ•„Çå„Åü',
                    `<img src="${IMAGES.items.elixirModern}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                addItem('elixirModern')
                playSE('se-clear');
                renderCanvasRoom();

            } else {
                playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }

        // „Å¥„Çà„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showPiyoPuzzle() {
            const modalContent = `
                <h3>„Éê„Éº„ÉÜ„É≥„ÉÄ„Éº„Å¥„Çà„ÅØÂõ∞„Å£„Å¶„ÅÑ„Çã</h3>
                <p>‰Ωï„ÇíÊ≥®Êñá„Åï„Çå„Åü„ÅÆ„ÅãÊïô„Åà„Å¶„ÅÇ„Åí„Çà„ÅÜ</p>
                <img src="${IMAGES.modals.piyoUpset}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">
                <input type="text" class="puzzle-input" id="piyoInput" placeholder="Ëã±Â≠ó">
                <br>
                <button onclick="checkPiyoPuzzle()">OK</button>
                <button onclick="closeModal()">Èñâ„Åò„Çã</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // „Å¥„Çà„Éë„Ç∫„É´„ÅÆÁ≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkPiyoPuzzle() {
            const v = document.getElementById('piyoInput').value.trim().replace(/\s+/g, "");

            // ÂÖ®ËßíÂØæÁ≠ñ
            const z2h = s => s.replace(/[Ôºê-Ôºô]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            const val = z2h(v).toLowerCase();
            if (val === 'redwine' || val === 'wine' || val === 'wine(red)') {
                closeModal();
                gameState.main.flags.piyoStatus++;

                markProgress('piyo_clear_21');

                showModal(
                    '„Åù„ÅÜ„Å†„Å£„Åü„Éî„É®ÔºÅvip„É´„Éº„É†„Å´ÊåÅ„Å£„Å¶Ë°å„Å£„Å¶„Éî„É®',
                    `<img src="${IMAGES.modals.piyoWine}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                addItem('redwine');
                playSE('se-clear');
                updateMessage('vip„É´„Éº„É†„Å´ÊåÅ„Å£„Å¶Ë°å„Å£„Å¶„Éî„É®');
                renderCanvasRoom();

            } else {
                playSE('se-error');
                updateMessage('„Å°„Åå„ÅÜ„Çà„ÅÜ„Å†');
            }
        }

        // ================= VIP„É´„Éº„É†„Éâ„Ç¢„Éª„Çπ„É©„Ç§„Éâ„Éë„Ç∫„É´ =================

        // 0:Â∑¶, 1:‰∏≠Â§Æ, 2:Âè≥
        let vipDoorState = [0, 0, 0, 0];

        function showVipRoomDoorPuzzle() {
            // Ëß£Èô§Ê∏à„Åø„Å™„Çâ„ÇÇ„ÅÜÂÖ•„Å£„Å¶ËâØ„ÅÑ
            if (gameState.main.flags.unlockVipRoomDoor) {
                changeRoom('vipRoom');
                return;
            }

            vipDoorState = [0, 0, 0, 0];

            const modalContent = `
        <div style="
            background:#000;
            padding:16px;
            border-radius:12px;
            max-width:420px;
            min-width:300px; 
            margin:0 auto;
        ">
            <h3 style="text-align:center;margin-top:0;">VIP„É´„Éº„É†„ÅÆ„Éâ„Ç¢„Å†</h3>

            <div style="
                display:flex;
                flex-direction:column;
                gap:14px;
                margin:16px auto;
                width:100%;
                max-width:320px;
            ">
                ${[0, 1, 2, 3].map(i => `
                    <div style="
                        position:relative;
                        height:60px;
                        border-radius:30px;
                        background:linear-gradient(90deg,#ddd,#f5f5f5);
                        box-shadow:inset 0 2px 4px rgba(0,0,0,0.15);
                        padding:10px;
                    ">
                        <div id="vipCircle${i}" onclick="cycleVipDoorPos(${i})"
                            style="
                                width:40px;height:40px;
                                border-radius:50%;
                                cursor:pointer;
                                transition:margin-left 0.15s ease-out;
                                margin-left:0%;
                                box-shadow:0 3px 8px rgba(0,0,0,0.35),
                                           inset 0 2px 4px rgba(255,255,255,0.6);
                                ${i === 0 ? 'background:#c53030;' : ''}
                                ${i === 1 ? 'background:#f2c667;' : ''}
                                ${i === 2 ? 'background:#8b4513;' : ''}
                                ${i === 3 ? 'background:linear-gradient(135deg,#3182ce,#38b2ac);' : ''}
                            ">
                        </div>
                    </div>
                `).join('')}
            </div>

            <p id="vipDoorMsg" style="text-align:center;min-height:1.2em;margin-bottom:10px;"></p>

            <div style="text-align:center;margin-top:4px;">
                <button onclick="checkVipRoomDoorPuzzle()" class="text-btn">OK</button>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // ‰∏∏„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Å®„ÅçÔºöÂ∑¶‚Üí‰∏≠Â§Æ‚ÜíÂè≥‚ÜíÂ∑¶‚Ä¶ „Å®Ê®™‰ΩçÁΩÆ„Çí„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥
        function cycleVipDoorPos(index) {
            vipDoorState[index] = (vipDoorState[index] + 1) % 3;

            const el = document.getElementById('vipCircle' + index);
            if (!el) return;

            const pos = ['0%', '46%', '86%'][vipDoorState[index]];
            el.style.marginLeft = pos;

            // „Åì„Åì„Åß„ÅØÂà§ÂÆö„Åõ„Åö„ÄÅOK„Éú„Çø„É≥„ÅßÂà§ÂÆö
        }

        // Ê≠£Ëß£Âà§ÂÆöÔºö‰∏ä„Åã„Çâ [‰∏≠Â§Æ, Â∑¶, Âè≥, ‰∏≠Â§Æ] = [1,0,2,1]
        function checkVipRoomDoorPuzzle() {
            const correct = [1, 0, 2, 1];
            const ok = correct.every((v, i) => vipDoorState[i] === v);
            const msg = document.getElementById('vipDoorMsg');

            if (!ok) {
                if (msg) {
                    msg.textContent = '‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                }
                if (typeof playSE === 'function') {
                    playSE('se-error');
                }
                return;
            }

            // Ê≠£Ëß£ÊôÇÂá¶ÁêÜ
            gameState.main.flags.unlockVipRoomDoor = true;
            if (typeof markProgress === 'function') {
                markProgress('viproom_door_unlock_21');
            }

            if (typeof playSE === 'function') {
                playSE('se-gacha');
            }

            closeModal();

            showModal(
                '„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü',
                '',
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );

            renderCanvasRoom();
        }

        // ================= ÁßòÂØÜ„ÅÆÈÉ®Â±ã„Éâ„Ç¢„ÉªÂ∑¶Âè≥„Éú„Çø„É≥„Éë„Ç∫„É´ =================

        // ÂÖ•ÂäõÂ±•Ê≠¥„Çí‰øùÊåÅ
        let secretDoorInput = [];

        // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showSecretRoomDoorPuzzle() {
            // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„Å™„ÇâÊôÆÈÄö„Å´ÂÖ•„Çå„Çã
            if (gameState.main.flags.unlockSecretRoom) {
                changeRoom('secretRoom');
                return;
            }

            secretDoorInput = [];

            const modalContent = `
        <div style="
            background:#000;
            padding:16px;
            border-radius:12px;
            max-width:420px;
            min-width:260px;
            margin:0 auto;
        ">
            <h3 style="text-align:center;margin-top:0;">„Éà„Ç§„É¨„Çâ„Åó„Åç„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„Å†</h3>


            <div style="
                display:flex;
                justify-content:center;
                gap:24px;
                margin:20px auto;
            ">
                <button id="secretBtnL" onclick="pressSecretDoorButton('L')"
                    style="
                        width:80px;height:80px;
                        border-radius:8px;
                        border:none;
                        background:linear-gradient(135deg,#e5e5e5,#ffffff);
                        box-shadow:0 3px 6px rgba(0,0,0,0.35);
                        cursor:pointer;
                    ">
                </button>
                <button id="secretBtnR" onclick="pressSecretDoorButton('R')"
                    style="
                        width:80px;height:80px;
                        border-radius:8px;
                        border:none;
                        background:linear-gradient(135deg,#e5e5e5,#ffffff);
                        box-shadow:0 3px 6px rgba(0,0,0,0.35);
                        cursor:pointer;
                    ">
                </button>
            </div>

            <p id="secretDoorMsg"
               style="text-align:center;min-height:1.2em;margin-bottom:10px;font-size:0.9rem;"></p>

            <div style="text-align:center;margin-top:4px;">
                <button onclick="checkSecretRoomDoorPuzzle()" class="text-btn">OK</button>
                <button onclick="closeModal()" class="text-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('modal').style.display = 'flex';
        }

        // Â∑¶Âè≥„Éú„Çø„É≥„ÇíÊäº„Åó„Åü„Å®„ÅçÔºöÂ±•Ê≠¥„Å´ËøΩÂä†
        function pressSecretDoorButton(side) {
            secretDoorInput.push(side);

            // „Å°„Çá„Å£„Å®„Åó„Åü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            const msg = document.getElementById('secretDoorMsg');
            if (msg) {
                msg.textContent = `„Éú„Çø„É≥„ÇíÊäº„Åó„Åü„ÄÇÔºàÂÖ•ÂäõÂõûÊï∞Ôºö${secretDoorInput.length}Ôºâ`;
            }

            if (typeof playSE === 'function') {
                playSE('se-click');
            }
        }

        // OK„Éú„Çø„É≥„ÅßÊ≠£Ëß£Âà§ÂÆö
        function checkSecretRoomDoorPuzzle() {
            const correct = ['L', 'R', 'R', 'R', 'L'];
            const msg = document.getElementById('secretDoorMsg');

            if (secretDoorInput.length < correct.length) {
                if (msg) msg.textContent = '‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                if (typeof playSE === 'function') playSE('se-error');
                return;
            }

            // Áõ¥Ëøë„ÅÆ5Âõû„Å∂„Çì„Å†„Åë„ÇíË¶ã„Çã„Çà„ÅÜ„Å´„Åó„Å¶„Åä„ÅèÔºàÊäº„ÅóÈÅé„Åé„Å¶„ÇÇÊïëÊ∏àÔºâ
            const recent = secretDoorInput.slice(-correct.length);
            const ok = correct.every((v, i) => recent[i] === v);

            if (!ok) {
                if (msg) msg.textContent = '‚Ä¶ÈÅï„ÅÜ„Çà„ÅÜ„Å†„ÄÇ';
                if (typeof playSE === 'function') playSE('se-error');
                return;
            }

            // Ê≠£Ëß£ÊôÇÂá¶ÁêÜ
            gameState.main.flags.unlockSecretRoom = true;
            if (typeof markProgress === 'function') {
                markProgress('secretroom_unlock_21');
            }
            if (typeof playSE === 'function') {
                playSE('se-gacha');
            }

            closeModal();

            showModal(
                '„Éâ„Ç¢„ÅÆ„É≠„ÉÉ„ÇØ„ÅåÂ§ñ„Çå„Åü',
                '',
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );

            renderCanvasRoom();
        }



        function handleCatsResponse() {
            if (!gameState.main.flags.serveToVipRoomDrink) {
                if (gameState.selectedItem == 'redwine') {
                    window._nextModal = {
                        title: '„Å™„Å´„Åã„Åä„Å§„Åæ„Åø„ÅåÊ¨≤„Åó„ÅÑ„Çè',
                        content: `<img src="${IMAGES.modals.catsQuestion}" style="width:400px;display:block;margin:0 auto 20px;">`,
                        buttons: [{ text: 'Èñâ„Åò„Çã', action: 'close' }],
                    };
                    const onClosed = () => {
                        playSE('se-cat');
                        updateMessage('Ëµ§„ÉØ„Ç§„É≥„ÇíÊ∏°„Åó„Åü„ÄÇ„Åä„Å§„Åæ„Åø„ÅåÊ¨≤„Åó„ÅÑ„Çà„ÅÜ„Å†');
                    };
                    window.addEventListener('modal:closed', onClosed, { once: true });
                    showModal(
                        '„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÇ„Åî„Åè„Çç„ÅÜ„Åï„Åæ',
                        `<img src="${IMAGES.modals.catsWine}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    removeItem('redwine');
                    gameState.main.flags.serveToVipRoomDrink = true;
                    gameState.vipRoom.flags.backgroundState++;
                    renderCanvasRoom();
                    updateMessage('Ëµ§„ÉØ„Ç§„É≥„ÇíÊ∏°„Åó„Åü');
                } else {
                    updateMessage('È†º„Çì„Å†„ÇÇ„ÅÆ„ÅØ„Åæ„Å†Ôºü');
                }
            } else if (gameState.main.flags.serveToVipRoomDrink && !gameState.main.flags.serveToVipRoomFood) {
                if (gameState.selectedItem == 'sandwich') {
                    window._nextModal = {
                        title: '„Åù„Çç„Åù„ÇçÂ∏∞„Çä„Åæ„Åô',
                        content: `<img src="${IMAGES.modals.catsBye}" style="width:400px;display:block;margin:0 auto 20px;">`,
                        buttons: [{ text: 'Èñâ„Åò„Çã', action: 'close' }],
                    };
                    const onClosed = () => {
                        quickBlackFade();
                        playSE('se-cat');
                        updateMessage('Áå´„Åü„Å°„ÅØÂ∏∞„Å£„Å¶„ÅÑ„Å£„Åü');
                    };
                    window.addEventListener('modal:closed', onClosed, { once: true });
                    showModal(
                        '„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÇ„ÅÑ„Åü„Å†„Åç„Åæ„Åô',
                        `<img src="${IMAGES.modals.catsSandwich}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                        [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                    );
                    removeItem('sandwich');
                    gameState.main.flags.serveToVipRoomFood = true;
                    gameState.main.flags.goneCats = true;
                    gameState.vipRoom.flags.backgroundState++;
                    renderCanvasRoom();
                    updateMessage('„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ„ÇíÊ∏°„Åó„Åü');
                } else {
                    updateMessage('‚Ä¶');
                }


            } else if (gameState.main.flags.serveToVipRoomDrink && gameState.main.flags.serveToVipRoomFood) {

            }
        }

        function handlePiyoTalk() {
            const flags = gameState.main.flags || {};
            const hasCroco = !!flags.talkToCroco && !flags.gotMoonHoney;
            const hasDrink = !!flags.serveToVipRoomDrink && !flags.gotSandwich;
            const piyoGoneReady = !!flags.goneCroco && !!flags.goneCats

            // „Éú„Çø„É≥„Åã„ÇâÂëº„Å∂Áî®„Éò„É´„Éë
            const askMoonHoney = function () {
                closeModal();
                showModal(
                    '„É†„Éº„É≥„Éè„Éã„ÉºNo.7„ÅØ‚Ä¶',
                    `<img src="${IMAGES.modals.piyoCabinet}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                updateMessage('„Éî„É®„ÅÆÂæå„Çç„ÅÆÊ£ö„Å´„ÅØ„É†„Éº„É≥„Éè„Éã„ÉºNo.7„ÅØÁÑ°„ÅÑ„Çà„ÅÜ„Å†');
            };

            const askSnack = function () {
                closeModal();
                showModal(
                    '„Åà„ÄÅ„Åä„Å§„Åæ„ÅøÔºü„Éë„É≥„Åó„Åã„Å™„ÅÑ„Éî„É®‚Ä¶',
                    `<img src="${IMAGES.modals.piyoQuestion}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                    [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
                );
                playSE('se-piyo');
                updateMessage('„Åä„Å§„Åæ„Åø„ÅÆÊùêÊñô„ÅåË∂≥„Çä„Å™„ÅÑ„Çà„ÅÜ„Å†');
            };

            if (piyoGoneReady) {
                quickBlackFade();
                showModal(
                    '„ÇÇ„ÅÜÂ∏∞„Çã„Éî„É®„ÄÇ„ÅÇ„Å®„ÅØ„Çà„Çç„Åó„Åè„Éî„É®',
                    `<img src="${IMAGES.modals.piyoGone}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                    [
                        {
                            text: 'OK',
                            action: function () {
                                gameState.main.flags.gonePiyo = true;
                                renderCanvasRoom();
                                closeModal();
                            }
                        }
                    ]
                );
                playSE('se-pipipiyo');
                return;
            }

            // ‰∏°Êñπ true ‚Üí 2„Éú„Çø„É≥
            if (hasCroco && hasDrink) {
                showModal(
                    '„Å©„ÅÜ„Åó„Åü„Éî„É®Ôºü',
                    '',
                    [
                        { text: '„É†„Éº„É≥„Éè„Éã„ÉºNo.7„ÅØ„ÅÇ„ÇãÔºü', action: askMoonHoney },
                        { text: '„Åä„Å§„Åæ„Åø„ÅÇ„ÇãÔºü', action: askSnack },
                        { text: 'Èñâ„Åò„Çã', action: 'close' }
                    ],
                    null,
                    { columnButtons: true }
                );
                return;
            }

            // talkToCroco „ÅÆ„Åø true
            if (hasCroco && !hasDrink) {
                showModal(
                    '„Å©„ÅÜ„Åó„Åü„Éî„É®Ôºü',
                    '',
                    [
                        { text: '„É†„Éº„É≥„Éè„Éã„ÉºNo.7„ÅØ„ÅÇ„ÇãÔºü', action: askMoonHoney }
                    ],
                    null,
                    { columnButtons: true }
                );
                return;
            }

            // serveToVipRoomDrink „ÅÆ„Åø true
            if (!hasCroco && hasDrink) {
                showModal(
                    '„Å©„ÅÜ„Åó„Åü„Éî„É®Ôºü',
                    '',
                    [
                        { text: '„Åä„Å§„Åæ„Åø„ÅÇ„ÇãÔºü', action: askSnack }
                    ],
                    null,
                    { columnButtons: true }
                );
                return;
            }
        }


        let recordSpinTimer = null;

        function spinRecord() {
            // ÈÄ£ÊâìÈò≤Ê≠¢ÔºöÂõûËª¢‰∏≠„ÅØÁÑ°Ë¶ñ
            if (recordSpinTimer) return;

            const currentRoom = gameState.currentRoom;
            const isTimeRoom = (currentRoom === 'recordTime');
            const stateKey = isTimeRoom ? 'recordTime' : 'record';

            if (isTimeRoom) {
                if (hasItem('elixir')) {
                    showObj(null, '„Ç¥„Éº„É´„Éá„É≥„É†„Éº„É≥„Ç®„É™„ÇØ„Çµ„Éº„ÅØÂ∫ó„Å´ÁΩÆ„ÅÑ„Å¶„ÅÑ„Åì„ÅÜ', IMAGES.items.elixir, '„Ç¥„Éº„É´„Éá„É≥„É†„Éº„É≥„Ç®„É™„ÇØ„Çµ„Éº„ÅØÂ∫ó„Å´ÁΩÆ„ÅÑ„Å¶„ÅÑ„Åì„ÅÜ');
                    return;
                }
            }

            // state ÂàùÊúüÂåñ
            if (!gameState[stateKey]) gameState[stateKey] = {};
            if (!gameState[stateKey].flags) gameState[stateKey].flags = {};
            gameState[stateKey].flags.backgroundState = 0;

            // ÈÉ®Â±ã„Åî„Å®„Å´„Éï„É¨„Éº„É†Êï∞„ÇíÂàÜ„Åë„Çã
            const frames = isTimeRoom ? (IMAGES.rooms.recordTime || []) : (IMAGES.rooms.record || []);
            const maxFrame = frames.length || 1;   // record: 18Êûö, recordTime: 6Êûö ÊÉ≥ÂÆö

            let frame = 0;
            const totalLoops = 1;   // ‰ΩïÂë®„Åï„Åõ„Çã„Åã
            let count = 0;

            // SE
            if (!isTimeRoom) {
                try {
                    playSE('se-record');
                } catch (e) { }
            }

            recordSpinTimer = setInterval(() => {
                frame = (frame + 1) % maxFrame;
                gameState[stateKey].flags.backgroundState = frame;

                // „Åæ„Å†Âêå„ÅòÈÉ®Â±ã„ÇíË¶ã„Å¶„ÅÑ„Çã„Å®„Åç„Å†„ÅëÂÜçÊèèÁîª
                if (gameState.currentRoom === currentRoom) {
                    renderCanvasRoom();
                }

                count++;
                if (count >= totalLoops * maxFrame) {
                    clearInterval(recordSpinTimer);
                    recordSpinTimer = null;

                    // ÊúÄÂæå„ÅØÈùôÊ≠¢ÁîªÂÉè„Å´Êàª„Åô
                    gameState[stateKey].flags.backgroundState = 0;
                    if (gameState.currentRoom === currentRoom) {
                        renderCanvasRoom();
                    }

                    // ‚òÖrecordTime „Å´„ÅÑ„Çã„Åæ„Åæ„Å™„Çâ„ÄÅ„Çø„Ç§„É†„Çπ„É™„ÉÉ„ÉóÁô∫Âãï
                    if (isTimeRoom && gameState.currentRoom === 'recordTime') {
                        gameState.main.flags.returnRoom = 'door';
                        timeSlipToNowDoor();
                    }
                }
            }, 80); // ÂõûËª¢„Çπ„Éî„Éº„Éâ
        }


        function handleDoor() {
            // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÈÅ∑ÁßªÂÖ±ÈÄö„Éè„É≥„Éâ„É©
            const goEnding = () => {
                if (gameState.flags.trueEndUnlocked) {
                    gameState.endings.true = true;
                    travelWithStepsTrueEnd();
                } else if (gameState.main.flags.curseBroken && !gameState.main.flags.foundCarpet) {
                    changeRoom('end2');
                } else {
                    changeRoom('end');
                }
            };

            goEnding();
        }

        function showObj(flagKey, title, imgSrc, msg) {
            const f = gameState.main.flags;
            if (flagKey) {
                // Ë¶ã„Åü„Åì„Å®„Çí„Éï„É©„Ç∞ÁÆ°ÁêÜ„Åô„ÇãÂ†¥Âêà
                f[flagKey] = true;
            }

            showModal(
                title,
                `<img src="${imgSrc}" style="width:400px;max-width:100%;display:block;margin:0 auto 20px;">`,
                [{ text: 'Èñâ„Åò„Çã', action: 'close' }]
            );
            updateMessage(msg);
        }


        // „Ç¢„Ç§„ÉÜ„É†ÁÆ°ÁêÜ
        function addItem(itemId) {
            playSE('se-item');
            if (gameState.inventory.length < 8) {
                gameState.inventory.push(itemId);
                updateInventoryDisplay();
            }
        }

        function removeItem(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                gameState.selectedItem = null;
                gameState.selectedItemSlot = null;
                updateInventoryDisplay();
            }

        }

        function hasItem(itemId) {
            return gameState.inventory.includes(itemId);
        }

        function useItem(slotIndex) {
            if (gameState.inventory[slotIndex]) {
                const item = gameState.inventory[slotIndex];
                updateMessage(`${getItemName(item)}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü„ÄÇ‰ΩøÁî®„Åó„Åü„ÅÑÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                gameState.selectedItem = item;
                gameState.selectedItemSlot = slotIndex;
                updateInventoryDisplay();
            }
        }

        function getItemName(itemId) {
            const names = {
                coin: '„ÇØ„Éû„Ç≥„Ç§„É≥',
                bear: '„ÇØ„ÉûÂ¶ñÁ≤æ',
                redwine: 'Ëµ§„ÉØ„Ç§„É≥',
                recordDefault: '„É¨„Ç≥„Éº„Éâ',
                recordTime: '„É¨„Ç≥„Éº„ÉâÔºàÊ®°ÊßòÂÖ•„ÇäÔºâ',
                keySideboard: 'Èçµ',
                key: '„Éè„Éº„Éà„ÅÆÈçµ',
                conversion: 'ÊÄ™„Åó„ÅÑË°®',
                stick: 'ÈáëÂ±û„ÅÆÊ£í',
                glass: 'Á©∫„ÅÆ„Ç∞„É©„Çπ',
                glassFill: '„É†„Éº„É≥„Éè„Éã„ÉºNo.7„ÅÆ„Ç∞„É©„Çπ',
                glassFillFalse: '„Çµ„É≥„Ç∑„É•„Ç¨„Éº„ÅÆ„Ç∞„É©„Çπ',
                decanter: '„Éá„Ç´„É≥„Çø',
                can: '„ÉÑ„ÉäÁº∂',
                sandwich: '„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ',
                finalSyrup: 'ÊúÄÂæå„ÅÆ„Ç∑„É≠„ÉÉ„Éó',
                citrus: '„Éü„É©„ÇØ„É´ÈáëÊüë',
                elixir: '„Ç¥„Éº„É´„Éá„É≥„É†„Éº„É≥„Ç®„É™„ÇØ„Çµ„Éº',
                elixirModern: 'Áèæ‰ª£„ÅÆ„Ç¥„Éº„É´„Éá„É≥„É†„Éº„É≥„Ç®„É™„ÇØ„Çµ„Éº',
                pic1: '„Å™„Å´„Åã„ÅÆ„Éë„Éº„ÉÑ1/3',
                pic2: '„Å™„Å´„Åã„ÅÆ„Éë„Éº„ÉÑ2/3',
                pic3: '„Å™„Å´„Åã„ÅÆ„Éë„Éº„ÉÑ3/3',


            };
            return names[itemId] || itemId;
        }

        function renderNavigation() {
            const navDiv = document.querySelector('.navigation');
            navDiv.innerHTML = '';
            if (gameState.currentRoom === 'underground') return;
            gameState.openRooms.forEach(roomId => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = rooms[roomId].name;
                btn.onclick = () => changeRoom(roomId);
                navDiv.appendChild(btn);
            });
        }

        function addNaviItem(room) {
            if (!gameState.openRooms.includes(room)) {
                gameState.openRooms.push(room);
                return true;
            }
            return false;
        }

        // „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫Êõ¥Êñ∞
        function updateInventoryDisplay() {
            const slots = document.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                slot.innerHTML = '';
                if (gameState.inventory[index]) {
                    const img = document.createElement('img');
                    img.src = IMAGES.items[gameState.inventory[index]];
                    img.onerror = function () {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'image-placeholder';
                        placeholder.textContent = getItemName(gameState.inventory[index]);
                        placeholder.style.width = '60px';
                        placeholder.style.height = '60px';
                        slot.appendChild(placeholder);
                    };
                    slot.appendChild(img);
                    const magBtn = document.createElement('div');
                    magBtn.className = 'magnifier-btn';
                    magBtn.title = 'Êã°Â§ßË°®Á§∫';
                    magBtn.innerHTML = '<img src="images/magnifier.png" alt="Êã°Â§ß">';
                    magBtn.onclick = (e) => {
                        e.stopPropagation();

                        const itemId = gameState.inventory[index];

                        // „Éá„Éï„Ç©„ÅÆ‰∏≠Ë∫´
                        let content = `<img src="${img.src}" style="max-width:380px;max-height:380px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto 16px;">`;
                        let buttons = [{ text: 'Èñâ„Åò„Çã', action: 'close' }];

                        // „Éû„É≥„Éà„Å™„Çâ„ÄåË™ø„Åπ„Çã„Äç„Éú„Çø„É≥„ÇíËøΩÂä†ÔºàÈçµÊú™ÂÖ•ÊâãÔºÜÊú™Áô∫Ë¶ã„Éï„É©„Ç∞ÊôÇ„ÅÆ„ÅøÔºâ
                        if (itemId === 'cloak' && !hasItem('key') && !gameState.main.flags.foundKey) {
                            buttons = [
                                { text: 'Ë™ø„Åπ„Çã', action: 'inspectCloak' },
                                { text: 'Èñâ„Åò„Çã', action: 'close' }
                            ];
                        }

                        showModal(
                            getItemName(itemId),
                            content,
                            buttons
                        );
                    };
                    slot.appendChild(magBtn);
                }
                // ‚òÖÈÅ∏Êäû‰∏≠„Å™„Çâselected„ÇØ„É©„ÇπËøΩÂä†
                if (gameState.selectedItemSlot === index) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
        }


        // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
        function updateMessage(message) {
            //document.getElementById('messageArea').innerHTML = message;
            document.getElementById('msgText').textContent = message;
        }

        function updateMessageHTML(html) {
            const el = document.getElementById('msgText');
            el.innerHTML = html;
            el.querySelectorAll('a').forEach(a => {
                a.target = '_blank';
                a.rel = 'noopener';
                a.style.color = '#d4af37';
                a.style.textDecoration = 'underline';
            });
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content, buttons, onSequenceSuccess, options) {
            options = options || {};
            let modalHtml = `<h3>${title}</h3><p>${content}</p>`;
            if (buttons && buttons.length > 0) {
                const columnStyle = options.columnButtons
                    ? 'display:flex; flex-direction:column; gap:12px; align-items:stretch;'
                    : 'text-align:center; display:flex; gap:10px; justify-content:center;';

                modalHtml += `<div id="modalButtons" style="${columnStyle}"></div>`;
                modalHtml += `<div id="modalClose" style="margin-top:25px;text-align:center;"></div>`;
            }
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('modal').style.display = 'flex';

            if (!buttons || buttons.length === 0) return;

            let pressed = [];
            let heartCnt = 0;
            let checkCnt = 0;
            let houseCnt = 0;

            // ÁîªÂÉè/ÈÄöÂ∏∏„Éú„Çø„É≥„Å®close„Éú„Çø„É≥„ÅßÂàÜ„Åë„Çã
            const modalButtons = document.getElementById('modalButtons');
            const modalClose = document.getElementById('modalClose');

            buttons.forEach((button, idx) => {
                // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅØ‰∏ã„Å∏
                if (button.action === 'close') {
                    const btn = document.createElement('button');
                    btn.textContent = button.text || 'Èñâ„Åò„Çã';
                    btn.className = 'modal-close-btn';
                    btn.onclick = function () {
                        closeModal();
                        if (typeof onSequenceSuccess === "function") {
                            onSequenceSuccess();
                        }
                    };
                    modalClose.appendChild(btn);
                } else {
                    const btn = document.createElement('button');
                    btn.style.margin = "0 10px 10px 0";
                    if (button.img) {
                        btn.innerHTML = `<img src="${button.img}" alt="${button.text || ''}" style="width:80px;height:80px;vertical-align:middle;">`;
                    } else {
                        btn.textContent = button.text;
                        btn.className = 'text-btn';
                    }
                    btn.onclick = function () {
                        if (button.action === 'restart') {
                            restartGame();
                        } else if (typeof button.action === "function") {
                            button.action();
                        } else if (typeof button.action === 'string') {
                            closeModal();
                            handleAreaClick(button.action);
                        }
                    };
                    modalButtons.appendChild(btn);
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            // Ê¨°„ÅÆ„É¢„Éº„ÉÄ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ë°®Á§∫
            if (window._nextModal) {
                // ÁôªÈå≤ÂÜÖÂÆπ„ÅØ {title, content, buttons, after} „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                let modal = window._nextModal;
                window._nextModal = null; // „ÇØ„É™„Ç¢

                if (typeof modal === 'function') {
                    try { modal(); } catch (e) { }
                    window.dispatchEvent(new Event('modal:closed'));
                    return;
                }

                if (modal.before) modal.before();
                showModal(modal.title, modal.content, modal.buttons);
                if (modal.after) modal.after();
            }
            window.dispatchEvent(new Event('modal:closed'));
        }

        // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„Éà
        function restartGame() {
            gameState = getDefaultGameState();
            closeModal();
            initGame();
            updateInventoryDisplay();
        }

        let isBGMPlaying = false;
        let isBGMInitialized = false; // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®

        // ÂàùÂõû„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´„Å†„ÅëBGM„ÇíÂÜçÁîü
        function initBGMOnce() {
            if (!isBGMInitialized) {
                const bgm = document.getElementById('bgm');
                bgm.volume = 0.3;
                bgm.play();
                isBGMPlaying = true;
                isBGMInitialized = true;
                document.getElementById('bgm-toggle').textContent = "üîä BGM";
            }
        }
        window.addEventListener('click', initBGMOnce, { once: true });

        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-toggle');
            if (!isBGMPlaying) {
                bgm.play();
                isBGMPlaying = true;
                btn.textContent = "üîä BGM";
            } else {
                bgm.pause();
                isBGMPlaying = false;
                btn.textContent = "üîá BGM";
            }
        }

        function changeBGM(newSrc) {
            const bgm = document.getElementById('bgm');
            // „Éï„Ç°„Ç§„É´Âêç„ÅÆ„Åø„ÅßÊØîËºÉ
            const current = bgm.src.split('/').pop();
            const next = newSrc.split('/').pop();
            if (current === next) return; // „Åô„Åß„Å´„Åù„ÅÆBGM„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

            const isPlaying = isBGMPlaying;
            bgm.pause();
            bgm.src = newSrc;
            bgm.load();
            if (isPlaying) {
                bgm.play();
            }
        }

        function pauseBGM() {
            const bgm = document.getElementById('bgm');
            bgm.src = "";
            bgm.pause();
        }

        function playSE(id) {
            const se = document.getElementById(id);
            se.currentTime = 0;
            se.play();
        }

        // „Å©„Åì„Åã„ÅßÊúÄÂàù„Å´‰∏ÄÂ∫¶„Å†„ÅëÂëº„Å∂
        let loadedImages = {};
        function preloadImages() {
            // ÈÉ®Â±ãÁîªÂÉè
            Object.values(IMAGES.rooms).forEach(val => {
                if (Array.isArray(val)) {
                    val.forEach(src => {
                        if (!loadedImages[src]) {
                            const img = new Image();
                            img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                            img.src = src;
                            loadedImages[src] = img;



                        }
                    });
                } else if (typeof val === "string") {
                    if (!loadedImages[val]) {
                        const img = new Image();
                        img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                        img.src = val;
                        loadedImages[val] = img;
                    }
                }
            });
            // „Ç¢„Ç§„ÉÜ„É†ÁîªÂÉè
            Object.values(IMAGES.items).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
            // „É¢„Éº„ÉÄ„É´ÁîªÂÉè
            Object.values(IMAGES.modals).forEach(src => {
                if (!loadedImages[src]) {
                    const img = new Image();
                    img.onload = () => { try { renderCanvasRoom(); } catch (e) { } };
                    img.src = src;
                    loadedImages[src] = img;
                }
            });
        }

        // save&load
        function saveGameToSlot(slotIndex) {
            const toSave = { ...gameState, __version: SAVE_VERSION };

            const payload = {
                data: toSave,
                savedAt: Date.now()
            };

            localStorage.setItem(SAVE_KEYS[slotIndex], JSON.stringify(payload));
            updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function loadGameFromSlot(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`);
                return;
            }

            let saved;
            try {
                const parsed = JSON.parse(raw);
                // Êñ∞ÂΩ¢ÂºèÔºö{ data: {...}, savedAt: ... }
                if (parsed && parsed.data) {
                    saved = parsed.data;
                } else {
                    // ÊóßÂΩ¢ÂºèÔºö„Åù„ÅÆ„Åæ„Åæ gameState „ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã
                    saved = parsed;
                }
            } catch (e) {
                console.error(e);
                updateMessage('„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return;
            }

            const def = getDefaultGameState();
            const merged = deepMerge(def, saved);

            if (!Array.isArray(merged.openRooms)) merged.openRooms = def.openRooms.slice();
            if (!merged.currentRoom || !rooms[merged.currentRoom]) merged.currentRoom = def.currentRoom;

            gameState = merged;

            changeRoom(gameState.currentRoom);
            updateInventoryDisplay?.();
            renderNavigation?.();
            updateMessage(`„Çª„Éº„Éñ${slotIndex + 1}„Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function getSaveSlotLabel(slotIndex) {
            const raw = localStorage.getItem(SAVE_KEYS[slotIndex]);
            if (!raw) {
                return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàÁ©∫Ôºâ`;
            }
            try {
                const parsed = JSON.parse(raw);
                const savedAt = parsed.savedAt;
                if (!savedAt) {
                    return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàÊó•ÊôÇ‰∏çÊòéÔºâ`;
                }
                const d = new Date(savedAt);
                const jp = d.toLocaleString('ja-JP');
                return `„Çª„Éº„Éñ${slotIndex + 1}Ôºà${jp}Ôºâ`;
            } catch {
                return `„Çª„Éº„Éñ${slotIndex + 1}ÔºàË™≠„ÅøËæº„Åø„Ç®„É©„ÉºÔºâ`;
            }
        }

        function openLoadMenu() {
            const buttons = [
                {
                    text: getSaveSlotLabel(0),
                    action: () => {
                        loadGameFromSlot(0);
                        closeModal();
                    }
                },
                {
                    text: getSaveSlotLabel(1),
                    action: () => {
                        loadGameFromSlot(1);
                        closeModal();
                    }
                },
                { text: '„ÇÑ„ÇÅ„Çã', action: 'close' }
            ];

            showModal('„É≠„Éº„Éâ„Åô„Çã„Éá„Éº„Çø„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ', '', buttons, null, { columnButtons: true });
        }

        function saveGame() {
            const buttons = [
                {
                    text: '„Çª„Éº„Éñ1„Å´‰øùÂ≠ò',
                    action: () => {
                        saveGameToSlot(0);
                        closeModal();
                    }
                },
                {
                    text: '„Çª„Éº„Éñ2„Å´‰øùÂ≠ò',
                    action: () => {
                        saveGameToSlot(1);
                        closeModal();
                    }
                },
                { text: '„ÇÑ„ÇÅ„Çã', action: 'close' }
            ];

            showModal('„Çª„Éº„ÉñÂÖà„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ', '', buttons, null, { columnButtons: true });
        }

        function loadGame() {
            openLoadMenu();
        }

        function deepMerge(target, source) {
            if (source === undefined || source === null) return target;
            if (Array.isArray(source)) return source.slice();
            if (typeof source === 'object') {
                const out = (target && typeof target === 'object') ? { ...target } : {};
                for (const k of Object.keys(source)) {
                    out[k] = deepMerge(target ? target[k] : undefined, source[k]);
                }
                return out;
            }
            return source;
        }

        function showToast(text, ms = 2600) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = text;
            el.style.opacity = '1';
            el.style.transform = 'translateX(-50%) translateY(0)';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(-50%) translateY(-8px)';
            }, ms);
        }

        window.addEventListener('keydown', e => {
            if (e.key === 'F2') {
                DEV_MODE = !DEV_MODE;
                renderCanvasRoom();
            }
        });

        // „Ç≤„Éº„É†ÈñãÂßã
        preloadImages();
        initGame();
    </script>
    <div id="toast"
        style="position:fixed;left:50%;top:14px;transform:translateX(-50%);
padding:10px 14px;border-radius:8px;background:#1f6feb;color:#fff;font-weight:700;
box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s; z-index:9999;">
    </div>

</body>

</html>